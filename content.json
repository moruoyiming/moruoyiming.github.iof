{"pages":[{"title":"","text":"ä¸ªäººç®€ä»‹ åˆ†äº«å¾ˆå–œæ¬¢çš„è€ç½—çš„ä¸€æ®µè¯ï¼š â€œæ¯ä¸€ä¸ªç”Ÿå‘½æ¥åˆ°ä¸–é—´éƒ½æ³¨å®šæ”¹å˜ä¸–ç•Œï¼Œåˆ«æ— é€‰æ‹©ã€‚è¦ä¹ˆå˜å¾—å¥½ä¸€ç‚¹ï¼Œè¦ä¹ˆå˜å¾—åä¸€ç‚¹ã€‚ä½ å¦‚æœèµ°è¿›ç¤¾ä¼šä¸ºäº†ç”Ÿå­˜ä¸ºäº†ä»€ä¹ˆä¸è¦è„¸çš„ç†ç”±ï¼Œå˜æˆäº†ä¸€ä¸ªæ¶å¿ƒçš„æˆå¹´äººç¤¾ä¼šä¸­çš„ä¸€å‘˜ï¼Œé‚£ä½ å°±æŠŠè¿™ä¸ªä¸–ç•Œå˜å¾—æ¶å¿ƒäº†ä¸€ç‚¹ç‚¹ã€‚å¦‚æœä½ ä¸€ç”Ÿåˆšæ­£ä¸é˜¿ï¼Œå¦‚æœä½ ä¸€ç”Ÿè€¿ç›´ï¼Œæ²¡æœ‰åšä»»ä½•æ¶å¿ƒçš„äº‹æƒ…ï¼Œæ²¡åšå¯¹åˆ«äººæœ‰å®³çš„äº‹æƒ…ï¼Œä¸€è¾ˆå­æ‹¼äº†è€å‘½å‹‰å¼ºæŠŠè‡ªå·±èº«è¾¹çš„å‡ ä¸ªäººç…§é¡¾å¥½äº†ï¼Œæ²¡æœ‰æˆåæ²¡æœ‰å‘è´¢ï¼Œæ²¡æœ‰æˆå°±ä¼Ÿå¤§çš„äº‹ä¸šï¼Œç„¶åè€¿ç€è„–å­ä¸€ç”Ÿæ­£ç›´ï¼Œåˆ°äº†ä¸ƒå…«åå²è€¿ç€è„–å­å»ä¸–äº†ã€‚ä½ è¿™ä¸€ç”Ÿæ˜¯ä¸æ˜¯æ²¡æœ‰æ”¹å˜ä¸–ç•Œï¼Ÿä½ è¿˜æ˜¯æ”¹å˜ä¸–ç•Œäº†ï¼Œä½ æŠŠè¿™ä¸ªä¸–ç•Œå˜å¾—ç¾å¥½äº†ä¸€ç‚¹ç‚¹ã€‚å› ä¸ºä¸–ç•Œä¸Šåˆå¤šäº†ä¸€ä¸ªå¥½äººã€‚â€œ å–„æ¶ç»ˆæœ‰æŠ¥,å¤©é“å¥½è½®å›ã€‚ä¸ä¿¡æŠ¬å¤´çœ‹,è‹å¤©é¥¶è¿‡è°ã€‚æ— è®ºä½•æ—¶ä½•åœ°ï¼Œæˆ‘ä»¬éƒ½è¦ä¿æŒä¸€é¢—ç§¯æä¹è§‚ã€å–„è‰¯æ„Ÿæ©çš„å¿ƒã€‚ä½†è¡Œå¥½äº‹è«é—®å‰ç¨‹ï¼Œæ°¸è¿œå¹´è½»ï¼Œæ°¸è¿œçƒ­å†…ç›ˆçœ¶ï¼Œæ°¸è¿œä¿æŒæ­£èƒ½é‡ã€‚ğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªğŸ’ªå†²é¸­ï¼ï¼ï¼ï¼ -&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; ä¸ªäººä¿¡æ¯ï¼š90åè®¡ç®—æœºç½‘ç»œæŠ€æœ¯ä¸“ä¸šä»äº‹Androidå¼€å‘ï¼Œåšä¿¡ä»£ç æ”¹å˜ä¸–ç•Œæ‘„å½±çˆ±å¥½è€…QQ: 798774875Email: moruoyiming123@gmail.comJianShu: jianzeyicongGithub: moruoyimingYouTube: Jean RilenInstagram: jianzeyicong500px: moruoyiming åšå®¢ä¿¡æ¯ ç½‘ç«™é‡‡ç”¨çš„Icarusä¸»é¢˜ è¿½æ±‚å°½å¯èƒ½çš„ç®€æ´ï¼Œæ¸…æ™°ï¼Œæ˜“ç”¨ã€‚ åœ¨Icarusä¸»é¢˜ä¹‹ä¸Šè¿›è¡Œäº†éƒ¨åˆ†ä¿®æ”¹ã€‚ æ›´æ–°æ—¥å¿—ï¼š â€“2020.09.29ï¼šå¢åŠ ç›¸å†Œã€è§†é¢‘åŠŸèƒ½â€“2020.09.18ï¼šå¢åŠ AdSenseå¹¿å‘Šâ€“2020.08.22ï¼šæ”¹ç‰ˆéƒ¨åˆ†æ˜¾ç¤ºï¼Œä¼˜åŒ–é€Ÿåº¦â€“2020.06.18ï¼šicarus3.0ä¸»é¢˜é€‚é…â€“2019.12.16ï¼šå¢åŠ ä¸è’œå­ç»Ÿè®¡â€“2019.10.16ï¼šæ–‡ç« åˆ—è¡¨åŠ ä¸Šè¯„è®ºæ•°æ˜¾ç¤ºâ€“2019.03.13ï¼šæ”¹ç‰ˆè¯„è®ºâ€“2017.12.16ï¼šicarus1.0ä¸»é¢˜é€‚é…â€“2017.08.12ï¼šæ­å»ºä¸ªäººåšå®¢ æœ¬ç«™æ¨èç´¢å¼• æŠ€æœ¯çŸ¥è¯†ç‚¹ Javaæ•™ç¨‹ Python3æ•™ç¨‹ JavaScriptæ•™ç¨‹ å‰‘æŒ‡Offer å…è´¹å­¦ä¹ èµ„æ–™ å¸¸ç”¨å·¥å…· å›¾ç‰‡å‹ç¼© åœ¨çº¿è½¬æ¢å·¥å…· è´å¡å°”å¼§æ›²çº¿ ProcessOnæµç¨‹å›¾ Youtubeè§†é¢‘ä¸‹è½½ å…è´¹ç¿»å¢™ free-ss free-ss.site ss.pythonic.life å…è´¹èŠ‚ç‚¹ è½¯ä»¶ä¸‹è½½ èŒæ–°ç½‘ éº¦æ°ªæ´¾ ç¦åˆ© ç”µå½±å¤©å ‚ é«˜æ¸…ç”µå½± BDç”µå½± å‰§è¿· é«˜é€Ÿè½¦ æŒç»­æ›´æ–°~","link":"/about/index.html"},{"title":"categories","text":"(adsbygoogle = window.adsbygoogle || []).push({});","link":"/categories/index.html"},{"title":"","text":"é£å…‰ äººåƒ åŠ¨ç‰© å›¾ç‰‡å‡ä¸ºæœ¬äººæ‹æ‘„ï¼Œæœ‰å…±åŒçˆ±å¥½çš„å°ä¼™ä¼´å¯ä»¥çº¦èµ·æ¥å“¦~~~ ç•™è¨€ ğŸ˜Š ğŸ˜Š ğŸ˜Šã€‚","link":"/album/index.html"},{"title":"ç”µå½±","text":"&nbsp;&nbsp;å¬å¬éŸ³ä¹ éŸ³ä¹æ’­æ”¾å™¨ç”±mePlayeræä¾›ï¼Œå¸ƒå±€å‚ç…§ç½‘å‹åšå®¢æ‰€ä½œï¼Œæ„Ÿè°¢ä½œè€…çš„è¾›å‹¤ä»˜å‡ºã€‚æ›´å¤šéŸ³ä¹åˆ†äº«è¯·æŸ¥çœ‹æ­Œå•ã€‚ &nbsp;&nbsp;çœ‹çœ‹è§†é¢‘ -&gt;ç‚¹å‡»ä»¥ä¸‹æ¡ç›®å¼€å§‹æ’­æ”¾è§†é¢‘,å‘ä¸‹æ»‘åŠ¨æŸ¥çœ‹æ›´å¤š&lt;- (adsbygoogle = window.adsbygoogle || []).push({});","link":"/media/index.html"},{"title":"","text":"æ¥è€Œä¸å¾€éç¤¼ä¹Ÿç•…æ‰€æ¬²è¨€ï¼Œæœ‰ç•™å¿…åº”","link":"/message/index.html"},{"title":"éŸ³ä¹æ­Œå•æ”¶è—","text":"æ¸©é¦¨æç¤ºï¼šé€‰æ‹©å–œæ¬¢çš„éŸ³ä¹åŒå‡»æ’­æ”¾ï¼Œç”±äºç‰ˆæƒåŸå› éƒ¨åˆ†ä¸èƒ½æ’­æ”¾ã€‚å¦‚æœå–œæ¬¢æ­Œå•æ”¶è—ä¸€ä¸‹ï¼Œå»ç½‘æ˜“äº‘éƒ½èƒ½æ’­æ”¾å“Ÿï¼","link":"/music/index.html"}],"posts":[{"title":"Androidé¡¹ç›®è¿è¡Œæ—¶ä¸¢å¤±soæ–‡ä»¶","text":"é¡¹ç›®è¿è¡Œæ—¶æç¤ºç¼ºå°‘soæ–‡ä»¶ï¼Œéœ€è¦åœ¨Appé¡¹ç›®ä¸­build.gradleå¢åŠ æ”¯æŒçš„so æ–‡ä»¶ç±»å‹.åœ¨defaultConfigä¸‹å¢åŠ ä¸‹æ–¹ä»£ç  123ndk { abiFilters &quot;armeabi&quot;,'x86', 'armeabi-v7a', 'armeabi-v8a', 'arm64-v8a' } å®Œæ•´ä»£ç  123456789101112defaultConfig { applicationId &quot;â€¦&quot; minSdkVersion versions.minSdk targetSdkVersion versions.targetSdk versionCode versions.appVerCode versionName versions.appVerName multiDexEnabled true ndk { abiFilters &quot;armeabi&quot;,'x86', 'armeabi-v7a', 'armeabi-v8a', 'arm64-v8a' }} ä»æ–°ç¼–è¯‘åº”ç”¨ï¼Œå¹¶åœ¨build/outputs/apkä¸‹æŸ¥çœ‹ç¼–è¯‘æˆåŠŸçš„apk æ–‡ä»¶ä¸­çš„libs å·²ç»å°†soæ–‡ä»¶æˆåŠŸç¼–è¯‘è¿›å»ã€‚","link":"/2020/09/11/Android%E9%A1%B9%E7%9B%AE%E8%BF%90%E8%A1%8C%E6%97%B6%E4%B8%A2%E5%A4%B1so%E6%96%87%E4%BB%B6/"},{"title":"Mac ä¸‹ç§»åŠ¨ç¡¬ç›˜çš„è¯»å†™è½¯ä»¶Mounty","text":"title: Macä¸‹ç§»åŠ¨ç¡¬ç›˜çš„è¯»å†™è½¯ä»¶Mountythumbnail: /gallery/thumbnails/sculpture.jpgcategories: Macåº”ç”¨tags: å£çº¸è·¯å¾„ Mounty Macç³»ç»Ÿ ç»ˆç«¯è¿è¡Œ: brew cask install mounty å®˜ç½‘åœ°å€:https://mounty.app/","link":"/2020/09/11/Mac%20%E4%B8%8B%E7%A7%BB%E5%8A%A8%E7%A1%AC%E7%9B%98%E7%9A%84%E8%AF%BB%E5%86%99%E8%BD%AF%E4%BB%B6Mounty/"},{"title":"Macç³»ç»Ÿå£çº¸è·¯å¾„","text":"åœ¨ Finder ä¸­ï¼Œèœå•æ é€‰å–â€œå‰å¾€â€&gt;â€œå‰å¾€æ–‡ä»¶å¤¹â€ï¼Œå¼¹å‡ºçš„æ¡†é‡Œè¾“å…¥/Library/Desktop Pictures/æˆ–/System/Library/Desktop Pictures/ç„¶åå›è½¦å³å¯æ‰“å¼€è¯¥æ–‡ä»¶å¤¹ã€‚ ç³»ç»Ÿå£çº¸é»˜è®¤è·¯å¾„å­˜åœ¨ä¸¤ä¸ªåœ°æ–¹ï¼Œå½“æ—¶å»äº†ç¬¬ä¸€ä¸ªè·¯å¾„ä¸Šæ‰¾æœªæ‰¾åˆ°ï¼Œåæ¥é€šè¿‡å‘½ä»¤è¡Œè·å–åˆ°è·¯å¾„å‘ç°System ä¸‹ä¹Ÿæœ‰ä¸€ä¸ªDesktop Pictures æ–‡ä»¶å¤¹ã€‚ ç»ˆç«¯å‘½ä»¤ï¼šæ˜¾ç¤ºå£çº¸æ‰€åœ¨è·¯å¾„ï¼ˆè·¯å¾„æ˜¾ç¤ºåœ¨å±å¹•å¯¹åº”å£çº¸ä¸Šï¼‰ï¼š defaults write com.apple.dock desktop-picture-show-debug-text -bool TRUE;killall Dock ç»ˆç«¯å‘½ä»¤ï¼šéšè—è¯¥è·¯å¾„ï¼š defaults delete com.apple.dock desktop-picture-show-debug-text;killall Dock","link":"/2020/09/11/Mac%20%E7%B3%BB%E7%BB%9F%E5%A3%81%E7%BA%B8%E8%B7%AF%E5%BE%84/"},{"title":"Macä¸‹Googleå¤‡ä»½å’ŒåŒæ­¥é—®é¢˜","text":"1.ä¸‹è½½å¹¶å®‰è£…Googleå¤‡ä»½å’ŒåŒæ­¥ Googleå¤‡ä»½å’ŒåŒæ­¥ï¼ˆä¸‹è½½åœ°å€ï¼‰ 2.æ‰“å¼€xxçš„httpä»£ç† åœ¨åå¥½è®¾ç½®ä¸­æ‰“å¼€httpä»£ç†æœåŠ¡å™¨ï¼Œé…ç½®é»˜è®¤å³å¯ 3.æ‰“å¼€ç³»ç»Ÿè®¾ç½®ä¸­çš„httpä»£ç† ç³»ç»Ÿåå¥½è®¾ç½®â†’ç½‘ç»œâ†’é«˜çº§â†’ä»£ç†â†’ç½‘é¡µä»£ç†(HTTP)ï¼Œè®¾ç½®ä»£ç†127.0.0.1:1087 4. å…è®¸å¹¶ç™»å½•Googleè´¦æˆ· å®Œå…¨é…ç½®å®Œæˆåå³å¯é£Ÿç”¨ åŸæ–‡åœ°å€ https://www.fangpengjun.com/2017/09/08/%E8%A7%A3%E5%86%B3Mac%E4%B8%8BGoogle%E5%A4%87%E4%BB%BD%E5%92%8C%E5%90%8C%E6%AD%A5%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E9%97%AE%E9%A2%98/","link":"/2020/09/11/Mac%E4%B8%8BGoogle%E5%A4%87%E4%BB%BD%E5%92%8C%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98/"},{"title":"Macä½¿ç”¨ç»ˆç«¯ç™»å½•è°·æ­Œäº‘","text":"1.ç½‘é¡µSSHè¿›å…¥è°·æ­Œäº‘ï¼Œåˆ‡æ¢åˆ°rootè§’è‰² sudo -i 2.ä¿®æ”¹SSHé…ç½®æ–‡ä»¶/etc/ssh/sshd_config vi /etc/ssh/sshd_config ä¿®æ”¹PermitRootLoginå’ŒPasswordAuthenticationä¸ºyes # Authentication: PermitRootLogin yes //é»˜è®¤ä¸ºnoï¼Œéœ€è¦å¼€å¯rootç”¨æˆ·è®¿é—®æ”¹ä¸ºyes # Change to no to disable tunnelled clear text passwords PasswordAuthentication yes //é»˜è®¤ä¸ºnoï¼Œæ”¹ä¸ºyeså¼€å¯å¯†ç ç™»é™† 3.ç»™rootç”¨æˆ·è®¾ç½®å¯†ç  passwd root 4.é‡å¯SSHæœåŠ¡ä½¿ä¿®æ”¹ç”Ÿæ•ˆ /etc/init.d/ssh restart 5.å¯åŠ¨macç»ˆç«¯ ssh root@ip è¾“å…¥å¯†ç å³å¯è¿›å…¥SSHã€‚","link":"/2020/09/11/Mac%E4%BD%BF%E7%94%A8%E7%BB%88%E7%AB%AF%E7%99%BB%E5%BD%95%E8%B0%B7%E6%AD%8C%E4%BA%91/"},{"title":"Macä¸‹å®‰è£…è½¯ä»¶æç¤ºæ–‡ä»¶æŸåè§£å†³åŠæ³•","text":"1.æ‰“å¼€åº”ç”¨ç¨‹åº-å®ç”¨å·¥å…·-ç»ˆç«¯ï¼›b2åˆ¶ä»¥ä¸‹ä»£ç ï¼ˆmasteræ³¨æ„æ˜¯ä¸¤ä¸ª-ï¼‰åˆ°ç»ˆç«¯ä¸­ï¼Œå›è½¦ï¼ˆè¾“å…¥ç”µè„‘å¯†ç ï¼‰ï¼š 1sudo spctl --master-disable 3.æ‰“å¼€åº”ç”¨ç¨‹åº-ç³»ç»Ÿåå¥½è®¾ç½®-å®‰å…¨æ€§å’Œéšç§-é€šç”¨ï¼Œæ¶ˆå¤±çš„ä»»ä½•æ¥æºç»ˆäºå‡ºç°äº†ï¼ˆé»˜è®¤åº”è¯¥å‹¾é€‰äº†ï¼‰ï¼›4.æ­¤æ—¶å¯ä»¥å°½æƒ…ä½¿ç”¨ç¬¬ä¸‰æ–¹ç¨‹åºäº†å¦‚å·²ç»å¼€å¯äº†ä»»ä½•æ¥æºï¼Œè¿˜æ— æ³•å®‰è£…å½“å‡ºç°æç¤ºçš„æ—¶å€™ï¼Œå»ç³»ç»Ÿåå¥½è®¾ç½®-å®‰å…¨å’Œéšç§é‚£é‡Œå…è®¸ä¸‹ï¼ˆä¼šæç¤ºè¯¥è½¯ä»¶çš„å®‰è£…ä¿¡æ¯ï¼‰ è¿˜æç¤ºæŸåçš„ï¼Œè¯•è¯•æŒ‰ä½Controlåï¼Œå†æ¬¡ç‚¹å‡»è½¯ä»¶å›¾æ ‡","link":"/2020/09/11/Mac%E4%B8%8B%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6%E6%8F%90%E7%A4%BA%E6%96%87%E4%BB%B6%E6%8D%9F%E5%9D%8F%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95/"},{"title":"Macå®‰è£…oh-my-zshå‡ºç°TimeOut","text":"macç»ˆç«¯ å®‰è£… oh-my-zshsh -c â€œ$(curl -fsSL https://raw.githubusercontent.com/robbyrussell/oh-my-zsh/master/tools/install.sh)â€ æç¤ºé”™è¯¯ curl: (7) Failed to connect to raw.githubusercontent.com port 443: Operation timed out ç”¨è¿™ä¸ªè¿æ¥wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh","link":"/2020/09/11/Mac%E5%AE%89%E8%A3%85oh-my-zsh%20%E5%87%BA%E7%8E%B0TimeOut/"},{"title":"Macæ–‡ä»¶å®‰è£…åº”ç”¨ï¼Œæ‰“å¼€æç¤ºæ–‡ä»¶å·²æŸåï¼Œå¦‚ä½•è§£å†³","text":"ç»ˆç«¯è¿è¡Œè¯¥å‘½ä»¤:sudo xattr -d com.apple.quarantine /Applications/ColorFinale.app","link":"/2020/09/11/Mac%E6%96%87%E4%BB%B6%E5%AE%89%E8%A3%85%E5%BA%94%E7%94%A8%EF%BC%8C%E6%89%93%E5%BC%80%E6%8F%90%E7%A4%BA%E6%96%87%E4%BB%B6%E5%B7%B2%E6%8D%9F%E5%9D%8F%EF%BC%8C%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3/"},{"title":"Android é¡¹ç›®ä¸­soæ–‡ä»¶ä¸¢å¤±","text":"é¡¹ç›®è¿è¡Œæ—¶æç¤ºç¼ºå°‘soæ–‡ä»¶ï¼Œéœ€è¦åœ¨Appé¡¹ç›®ä¸­build.gradleå¢åŠ æ”¯æŒçš„so æ–‡ä»¶ç±»å‹.åœ¨defaultConfigä¸‹å¢åŠ ä¸‹æ–¹ä»£ç 123ndk { abiFilters &quot;armeabi&quot;,'x86', 'armeabi-v7a', 'armeabi-v8a', 'arm64-v8a' } å®Œæ•´ä»£ç  1234567891011121314151617defaultConfig { applicationId &quot;...&quot; minSdkVersion versions.minSdk targetSdkVersion versions.targetSdk versionCode versions.appVerCode versionName versions.appVerName multiDexEnabled true ndk { abiFilters &quot;armeabi&quot;,'x86', 'armeabi-v7a', 'armeabi-v8a', 'arm64-v8a' } javaCompileOptions { annotationProcessorOptions { arguments = [AROUTER_MODULE_NAME: project.getName()] } } } ä»æ–°ç¼–è¯‘åº”ç”¨ï¼Œå¹¶åœ¨build/outputs/apkä¸‹æŸ¥çœ‹ç¼–è¯‘æˆåŠŸçš„apk æ–‡ä»¶ä¸­çš„libs å·²ç»å°†soæ–‡ä»¶æˆåŠŸç¼–è¯‘è¿›å»ã€‚","link":"/2019/02/26/SO%E6%96%87%E4%BB%B6%E7%BC%BA%E5%A4%B1/"},{"title":"SSHé€šç”¨å‘½ä»¤","text":"Quick StartæŸ¥çœ‹å½“å‰ssæœåŠ¡å™¨æ‰€å¼€æ”¾çš„ç«¯å£1$ ss -lntp | grep ssserver æŸ¥çœ‹å½“å‰ssæœåŠ¡å™¨çš„å¯†ç ï¼Œé€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯è§ssçš„é…ç½®æ–‡ä»¶1$ ps aux | grep ssserver ç”¨catæŸ¥çœ‹ä¸‹é…ç½®æ–‡ä»¶1$ cat /etc/shadowsocks.json ä¿®æ”¹sså¯†ç 1$ vi /etc/shadowsocks.json æŒ‰ié”®è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼Œä¿®æ”¹å¯†ç ä¸º123456â€œpasswordâ€:â€123456â€, é‡å¯sså³å¯1$ service shadowsocks restart å¯åŠ¨ï¼šservice shadowsocks startåœæ­¢ï¼šservice shadowsocks stopé‡å¯ï¼šservice shadowsocks restartçŠ¶æ€ï¼šservice shadowsocks status","link":"/2019/02/20/SSH%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"},{"title":"ShadowRocket-å°ç«ç®­ğŸš€ğŸš€è´­ä¹°æ•™ç¨‹","text":"ç ”ç©¶äº†å‡ å¤©è¯•äº†å‡ ç§æ–¹æ³•æƒ³ç™½å«–å°ç«ç®­æ„Ÿè§‰éš¾å¾—ä¸€æ‰¹ï¼Œæœ€åå†³å®šè‡ªå·±å…¥æ‰‹ã€‚åˆ†äº«ä¸€ä¸‹æœ€ç®€å•çš„æ–¹å¼ï¼›1.ç™»å½•appstoreä¿®æ”¹åœ°åŒºä¸ºç¾å›½ï¼Œå…³äºè´¦æˆ·çš„ä¸€äº›è®¾ç½®ä¿¡æ¯å¯ä»¥å‚è€ƒåœ°å€ ç¾å›½ Old Harbor, AK é‚®ç¼– 99643ç”µè¯(430) 558-8829 2.æŸå®ä¸Šä¹°å……å€¼å¡ï¼ˆè®°å¾—ä¹°ç¾åŒºçš„ï¼‰ è´­ä¹°æˆåŠŸï¼Œä¼šå‘ä¸€ä¸ªå¡å›¾ 3.Appstoreä¸Šè¿›å…¥ä¸ªäººä¸­å¿ƒè¿›å…¥Redeem Gift Card or Codeè¿›å…¥é¡µé¢ç‚¹å‡»use camera æ‰«ä¸€ä¸‹ æˆåŠŸåï¼Œå›åˆ°é¦–é¡µè´­ä¹°ï¼›4.æ“ä½œå‰æœ€å¥½ä¹ŸæŒ‚ä¸‹vpæ©ï¼Œè‡ªå·±å®šä½çœ‹çœ‹æ˜¯ä¸æ˜¯ç¾å›½åœ°åŒºçš„ã€‚ç½‘ä¸Šè¯´æœ‰å¯èƒ½ä¼šå……å€¼å¤±è´¥ï¼Œè´¦å·è¢«é”å•¥çš„ã€‚æˆ‘ä¹Ÿä¸æ‡‚ã€‚å¦‚æœå¯¹ä½ æœ‰å¸®åŠ©è®°å¾—èµä¸‹å“¦ï¼æˆ‘çš„ä¸ªäººåšå®¢ï¼šhttps://www.errorcode.xyz/","link":"/2020/10/23/ShadowRocket-%E5%B0%8F%E7%81%AB%E7%AE%AD%F0%9F%9A%80%F0%9F%9A%80%E8%B4%AD%E4%B9%B0%E6%95%99%E7%A8%8B/"},{"title":"TensorFlow Macå®‰è£…æ•™ç¨‹","text":".å®‰è£…Python 3.7.5 ç‰ˆæœ¬ç™¾åº¦äº‘ç›˜:é“¾æ¥:https://pan.baidu.com/s/1lC7ZPFAIB8pYor1DbIOL8Q å¯†ç :v6tjå®˜ç½‘:https://www.python.org/ftp/python/3.7.5/python-3.7.5-macosx10.9.pkg æŸ¥çœ‹ç‰ˆæœ¬å·ã€‚ 123python3 --versionpip3 --versionvirtualenv --version è¾“å…¥which python3 æŸ¥çœ‹è·¯å¾„ 2.å¦‚æœå·²ç»å®‰è£…ï¼Œè·³è¿‡è¿™æ­¥ï¼šå¦‚æœæ²¡ç”¨è¿‡brewï¼Œéœ€è¦å…ˆä¸‹è½½ï¼Œå…³äºbrewæŸ¥çœ‹è¿™é‡Œ: https://brew.sh/ 123/usr/bin/ruby -e &quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot; export PATH=&quot;/usr/local/bin:/usr/local/sbin:$PATH&quot; 1234/usr/bin/ruby -e &quot;PATH&quot;brew updatebrew install python # Python 3sudo pip3 install -U virtualenv # system-wide install 3.å®‰è£…virtualenvè™šæ‹Ÿç¯å¢ƒåˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿç¯å¢ƒé€šè¿‡é€‰æ‹©ä¸€ä¸ªPythonè§£é‡Šå™¨,åˆ›å»º./venvç›®å½•æ¥ä¿å­˜å®ƒ:å¯ä¿®æ”¹ä¸ºå…¶ä»–ç›®å½•ã€‚ç›®å½•ä¼šå‡ºç°åœ¨ userçš„å­ç›®å½•ä¸‹ã€‚ 1virtualenv --system-site-packages -p python3 ./venv 4.æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ 1source ./venv/bin/activate # sh, bash, ksh, or zsh virtualenvæ´»è·ƒæ—¶,shellæç¤ºç¬¦å‰ç¼€(venv)ã€‚ å®‰è£…åŒ…åœ¨ä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒåœ¨ä¸å½±å“ä¸»æœºç³»ç»Ÿè®¾ç½®ã€‚å…ˆå‡çº§pip: 12pip install --upgrade pippip list # show packages installed within the virtual environment 5.é€€å‡ºè™šæ‹Ÿç¯å¢ƒ deactivate # donâ€™t exit until youâ€™re done using TensorFlow å¦‚æœæç¤ºæƒé™ä¸å¤Ÿæ—¶ï¼Œéœ€è¦åœ¨å‘½ä»¤åæ·»åŠ  â€“userã€‚ 6.å®‰è£…TensorFlow 1pip install --upgrade tensorflow éªŒè¯å®‰è£… 1python -c &quot;import tensorflow as tf;print(tf.reduce_sum(tf.random.normal([1000, 1000])))&quot; é—®é¢˜æ±‡æ€» 1pip install Keras-Applications ModuleNotFoundError: No module named â€˜matplotlibâ€™ 1pip install matplotlib ModuleNotFoundError: No module named â€˜tensorflow_datasetsâ€™ 1pip install tensorflow_datasets ModuleNotFoundError: No module named â€˜tensorflow_hubâ€™ 1pip install tensorflow_hub seaborn ç»˜åˆ¶çŸ©é˜µå›¾ (pairplot) 1pip install seaborn å¼•å…¥ç±»åº“ TensorFlow and tf.keras12import tensorflow as tffrom tensorflow import keras Helper librariesimport numpy as npimport matplotlib.pyplot as pltimport pandas as pdimport seaborn as sns","link":"/2020/09/11/TensorFlow%20Mac%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/"},{"title":"androidä¹‹HandlerThread","text":"HandlerThreadæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼ŸæŸ¥çœ‹ç±»çš„å®šä¹‰æ—¶æœ‰è¿™æ ·ä¸€æ®µè¯ï¼š 1Handy class for starting a new thread that has a looper. The looper can then be used to create handler classes. Note that start() must still be called. æ„æ€å°±æ˜¯è¯´ï¼šè¿™ä¸ªç±»çš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªåŒ…å«looperçš„çº¿ç¨‹ã€‚é‚£ä¹ˆæˆ‘ä»¬åœ¨ä»€ä¹ˆæ—¶å€™éœ€è¦ç”¨åˆ°å®ƒå‘¢?åŠ å…¥åœ¨åº”ç”¨ç¨‹åºå½“ä¸­ä¸ºäº†å®ç°åŒæ—¶å®Œæˆå¤šä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šåœ¨åº”ç”¨ç¨‹åºå½“ä¸­åˆ›å»ºå¤šä¸ªçº¿ç¨‹ã€‚ä¸ºäº†è®©å¤šä¸ªçº¿ç¨‹ä¹‹é—´èƒ½å¤Ÿæ–¹ä¾¿çš„é€šä¿¡ï¼Œæˆ‘ä»¬ä¼šä½¿ç”¨Handlerå®ç°çº¿ç¨‹é—´çš„é€šä¿¡ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ‰‹åŠ¨å®ç°çš„å¤šçº¿ç¨‹+Handlerçš„ç®€åŒ–ç‰ˆå°±æ˜¯æˆ‘ä»¬HandlerThreaæ‰€è¦åšçš„äº‹äº†ã€‚ ä¸‹é¢æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹HandlerThreadçš„åŸºæœ¬ç”¨æ³•ï¼š 12345678910111213141516171819202122232425HandlerThread mHandlerThread = new HandlerThread(&quot;myHandlerThreand&quot;); mHandlerThread.start(); // åˆ›å»ºçš„Handlerå°†ä¼šåœ¨mHandlerThreadçº¿ç¨‹ä¸­æ‰§è¡Œ final Handler mHandler = new Handler(mHandlerThread.getLooper()) { @Override public void handleMessage(Message msg) { Log.i(&quot;tag&quot;, &quot;æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot; + msg.obj.toString()); } }; title = (TextView) findViewById(R.id.title); title.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { Message msg = new Message(); msg.obj = &quot;11111&quot;; mHandler.sendMessage(msg); msg = new Message(); msg.obj = &quot;2222&quot;; mHandler.sendMessage(msg); } }); æˆ‘ä»¬é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªHandlerThreadå¯¹è±¡ï¼Œæ˜¯ç›´æ¥é€šè¿‡newçš„æ–¹å¼äº§ç”Ÿçš„ï¼ŒæŸ¥çœ‹å…¶æ„é€ æ–¹æ³•ï¼š 1234public HandlerThread(String name) { super(name); mPriority = Process.THREAD_PRIORITY_DEFAULT; }å¯ä»¥çŸ¥é“HandlerThreadç»§æ‰¿äºThreadï¼Œæ‰€ä»¥è¯´HandlerThreadæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå…¶æ„é€ æ–¹æ³•ä¸»è¦æ˜¯åšä¸€äº›åˆå§‹åŒ–çš„æ“ä½œã€‚ ç„¶åæˆ‘ä»¬è°ƒç”¨äº†mHandlerThread.start()æ–¹æ³•ï¼Œç”±ä¸Šæˆ‘ä»¬çŸ¥é“äº†HandlerThreadç±»å…¶å®å°±æ˜¯ä¸€ä¸ªThreadï¼Œä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥å…¶startæ–¹æ³•å†…éƒ¨è°ƒç”¨çš„è‚¯å®šæ˜¯Threadçš„runæ–¹æ³•ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹å…¶runæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678910111213@Override public void run() { mTid = Process.myTid(); Looper.prepare(); synchronized (this) { mLooper = Looper.myLooper(); notifyAll(); } Process.setThreadPriority(mPriority); onLooperPrepared(); Looper.loop(); mTid = -1; } æˆ‘ä»¬å‘ç°å…¶å†…éƒ¨è°ƒç”¨äº†Looper.prepate()æ–¹æ³•å’ŒLoop.loop()æ–¹æ³•ï¼Œç†Ÿæ‚‰androidå¼‚æ­¥æ¶ˆæ¯æœºåˆ¶çš„ç«¥é‹åº”å½“çŸ¥é“ï¼Œåœ¨androidä½“ç³»ä¸­ä¸€ä¸ªçº¿ç¨‹å…¶å®æ˜¯å¯¹åº”ç€ä¸€ä¸ªLooperå¯¹è±¡ã€ä¸€ä¸ªMessageQueueå¯¹è±¡ï¼Œä»¥åŠNä¸ªHandlerå¯¹è±¡ï¼Œå…·ä½“å¯å‚è€ƒï¼š androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ æ‰€ä»¥é€šè¿‡runæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨æˆ‘ä»¬åˆ›å»ºçš„HandlerThreadçº¿ç¨‹ä¸­æˆ‘ä»¬åˆ›å»ºäº†è¯¥çº¿ç¨‹çš„Looperä¸MessageQueueï¼› è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯å…¶åœ¨è°ƒç”¨Looper.loop()æ–¹æ³•ä¹‹å‰è°ƒç”¨äº†ä¸€ä¸ªç©ºçš„å®ç°æ–¹æ³•ï¼šonLooperPrepared(),æˆ‘ä»¬å¯ä»¥å®ç°è‡ªå·±çš„onLooperPreparedï¼ˆï¼‰æ–¹æ³•ï¼Œåšä¸€äº›Looperçš„åˆå§‹åŒ–æ“ä½œï¼› runæ–¹æ³•é‡Œé¢å½“mLooperåˆ›å»ºå®Œæˆåæœ‰ä¸ªnotifyAll()ï¼ŒgetLooper()ä¸­æœ‰ä¸ªwait()ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºçš„mLooperåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè€Œæˆ‘ä»¬çš„handleræ˜¯åœ¨UIçº¿ç¨‹åˆå§‹åŒ–çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¿…é¡»ç­‰åˆ°mLooperåˆ›å»ºå®Œæˆï¼Œæ‰èƒ½æ­£ç¡®çš„è¿”å›getLooper();wait(),notify()å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªçº¿ç¨‹çš„åŒæ­¥é—®é¢˜ ç„¶åæˆ‘ä»¬è°ƒç”¨äº†ï¼š 1234567// åˆ›å»ºçš„Handlerå°†ä¼šåœ¨mHandlerThreadçº¿ç¨‹ä¸­æ‰§è¡Œ final Handler mHandler = new Handler(mHandlerThread.getLooper()) { @Override public void handleMessage(Message msg) { Log.i(&quot;tag&quot;, &quot;æ¥æ”¶åˆ°æ¶ˆæ¯ï¼š&quot; + msg.obj.toString()); } }; è¯¥Handlerçš„æ„é€ æ–¹æ³•ä¸­ä¼ å…¥äº†HandlerThreadçš„Looperå¯¹è±¡ï¼Œæ‰€ä»¥Handlerå¯¹è±¡å°±ç›¸å½“äºå«æœ‰äº†HandlerThreadçº¿ç¨‹ä¸­Looperå¯¹è±¡çš„å¼•ç”¨ã€‚ ç„¶åæˆ‘ä»¬è°ƒç”¨handlerçš„sendMessageæ–¹æ³•å‘é€æ¶ˆæ¯ï¼Œåœ¨Handlerçš„handleMessgeæ–¹æ³•ä¸­å°±å¯ä»¥æ¥æ”¶åˆ°æ¶ˆæ¯äº†ã€‚ æœ€åéœ€è¦æ³¨æ„çš„æ˜¯åœ¨æˆ‘ä»¬ä¸éœ€è¦è¿™ä¸ªlooperçº¿ç¨‹çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨åœæ­¢æ‰ï¼› 1234protected void onDestroy() { super.onDestroy(); mHandlerThread.quit(); } ç›¸å¯¹æ¥è¯´HandlerThreadè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹ï¼š HandlerThreadæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªThreadå¯¹è±¡ï¼Œåªä¸è¿‡å…¶å†…éƒ¨å¸®æˆ‘ä»¬åˆ›å»ºäº†è¯¥çº¿ç¨‹çš„Looperå’ŒMessageQueueï¼› é€šè¿‡HandlerThreadæˆ‘ä»¬ä¸ä½†å¯ä»¥å®ç°UIçº¿ç¨‹ä¸å­çº¿ç¨‹çš„é€šä¿¡åŒæ ·ä¹Ÿå¯ä»¥å®ç°å­çº¿ç¨‹ä¸å­çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼› HandlerThreadåœ¨ä¸éœ€è¦ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ‰‹åŠ¨çš„å›æ”¶æ‰ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTask","link":"/2020/09/11/android%E4%B9%8BHandlerThread/"},{"title":"Android é¡¹ç›®æ„å»ºæµç¨‹","text":"å¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­æˆ‘ä»¬é€šè¿‡android studioç¼–å†™å®Œæˆandroidé¡¹ç›®ä¹‹åç›´æ¥ç‚¹å‡» Run â€˜appâ€™å°±å¯ä»¥åœ¨build/outputs/apkç”Ÿæˆå¯ä»¥åœ¨androidè®¾å¤‡ä¸­å®‰è£…çš„apkæ–‡ä»¶äº†ï¼Œé‚£ä¹ˆæ•´ä¸ªandroidæºç çš„æ„å»ºè¿‡ç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿ æˆ‘ä»¬å¯ä»¥æ ¹æ®Googleå®˜æ–¹æä¾›çš„æµç¨‹å›¾æ¥å…·ä½“äº†è§£æ„å»ºçš„è¿‡ç¨‹ï¼š é€šå¸¸çš„æ„å»ºè¿‡ç¨‹å°±æ˜¯å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œä¸‹é¢æ˜¯å…·ä½“æè¿°ï¼š 1.AAPT(Android Asset Packaging Tool)å·¥å…·ä¼šæ‰“åŒ…åº”ç”¨ä¸­çš„èµ„æºæ–‡ä»¶ï¼Œå¦‚AndroidManifest.xmlã€layoutå¸ƒå±€ä¸­çš„xmlç­‰ï¼Œå¹¶å°†xmlæ–‡ä»¶ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶å½¢å¼ï¼Œå½“ç„¶assetsæ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ä¸ä¼šè¢«ç¼–è¯‘ï¼Œå›¾ç‰‡åŠrawæ–‡ä»¶å¤¹ä¸­çš„èµ„æºä¹Ÿä¼šä¿æŒåŸæ¥çš„å½¢æ€ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯rawæ–‡ä»¶å¤¹ä¸­çš„èµ„æºä¹Ÿä¼šç”Ÿæˆèµ„æºidã€‚AAPTç¼–è¯‘å®Œæˆä¹‹åä¼šç”ŸæˆR.javaæ–‡ä»¶ã€‚ 2.AIDLå·¥å…·ä¼šå°†æ‰€æœ‰çš„aidlæ¥å£è½¬åŒ–ä¸ºjavaæ¥å£ã€‚ 3.æ‰€æœ‰çš„javaä»£ç ï¼ŒåŒ…æ‹¬R.javaä¸aidlæ–‡ä»¶éƒ½ä¼šè¢«Javaç¼–è¯‘å™¨ç¼–è¯‘æˆ.classæ–‡ä»¶ã€‚ 4.Dexå·¥å…·ä¼šå°†ä¸Šè¿°äº§ç”Ÿçš„.classæ–‡ä»¶åŠç¬¬ä¸‰åº“åŠå…¶ä»–.classæ–‡ä»¶ç¼–è¯‘æˆ.dexæ–‡ä»¶ï¼ˆdexæ–‡ä»¶æ˜¯Dalvikè™šæ‹Ÿæœºå¯ä»¥æ‰§è¡Œçš„æ ¼å¼ï¼‰ï¼Œdexæ–‡ä»¶æœ€ç»ˆä¼šè¢«æ‰“åŒ…è¿›APKæ–‡ä»¶ã€‚ 5.ApkBuilderå·¥å…·ä¼šå°†ç¼–è¯‘è¿‡çš„èµ„æºåŠæœªç¼–è¯‘è¿‡çš„èµ„æºï¼ˆå¦‚å›¾ç‰‡ç­‰ï¼‰ä»¥åŠ.dexæ–‡ä»¶æ‰“åŒ…æˆAPKæ–‡ä»¶ã€‚ 6.ç”ŸæˆAPKæ–‡ä»¶åï¼Œéœ€è¦å¯¹å…¶ç­¾åæ‰å¯å®‰è£…åˆ°è®¾å¤‡ï¼Œå¹³æ—¶æµ‹è¯•æ—¶ä¼šä½¿ç”¨debug keystoreï¼Œå½“æ­£å¼å‘å¸ƒåº”ç”¨æ—¶å¿…é¡»ä½¿ç”¨releaseç‰ˆçš„keystoreå¯¹åº”ç”¨è¿›è¡Œç­¾åã€‚ 7.å¦‚æœå¯¹APKæ­£å¼ç­¾åï¼Œè¿˜éœ€è¦ä½¿ç”¨zipalignå·¥å…·å¯¹APKè¿›è¡Œå¯¹é½æ“ä½œï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å½“åº”ç”¨è¿è¡Œæ—¶ä¼šå‡å°‘å†…å­˜çš„å¼€é”€ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹","link":"/2020/09/11/android%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E6%B5%81%E7%A8%8B/"},{"title":"ä¸€é”®è§£é™¤iOSç‰ˆTelegramå¯¹ç¾¤ç»„å’Œé¢‘é“çš„é™åˆ¶/è‹¹æœiPhoneæœ‰äº›é¢‘é“ä¸æ˜¾ç¤ºé—®é¢˜","text":"ä¸€é”®è§£é™¤iOSç‰ˆTelegramå¯¹ç¾¤ç»„å’Œé¢‘é“çš„é™åˆ¶/è‹¹æœiPhoneæœ‰äº›é¢‘é“ä¸æ˜¾ç¤ºé—®é¢˜Telegramï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç”µæŠ¥ï¼Œæ˜¯å½“å‰æœ€æµè¡Œçš„ç¤¾äº¤ APPï¼Œå¾ˆå¤šç½‘ç«™ã€å“ç‰Œå’Œå…¬ä¼—äººç‰©éƒ½æ‹¥æœ‰è‡ªå·±çš„â€œç”µæŠ¥ç¾¤â€ã€‚å¼€æ”¾çš„ç¾¤ç»„å’Œé¢‘é“æ˜¯ Telegram æœ€å…·ç‰¹è‰²çš„åŠŸèƒ½ï¼Œä¹Ÿæ˜¯å¾ˆå¤šç”¨æˆ·ï¼ˆåŒ…æ‹¬æˆ‘ï¼‰ä½¿ç”¨ Telegram çš„ä¸»è¦ç›®çš„ã€‚ Telegram æ±‡é›†äº†ä¸–ç•Œå„åœ°çš„ç”¨æˆ·ã€‚å®ƒå¼€æºä¸”å®‰å…¨ï¼Œè½»ä¾¿ä¸”æ²¡æœ‰å¹¿å‘Šï¼Œç«¯åˆ°ç«¯åŠ å¯†æ•°æ®ï¼Œä¿æŠ¤ç”¨æˆ·éšç§â€¦â€¦å› ä¸ºè¿™äº›ç‰¹æ€§ï¼Œç”¨æˆ·èƒ½å¤Ÿåœ¨ Telegram ä¸Šè·å¾—å‡ ä¹ä»»ä½•å†…å®¹ã€‚ ä¸è¿‡å—é™äºè‹¹æœçš„æ”¿ç­–ï¼ŒiOS å¹³å°ä¸Šçš„ Telegram å®˜æ–¹ APP é™åˆ¶è®¿é—®ç‰¹å®šçš„ç¾¤ç»„æˆ–é¢‘é“ï¼Œä¾‹å¦‚åŒ…å«è‰²#æƒ…æˆ–ç›—ç‰ˆä¿¡æ¯çš„é‚£éƒ¨åˆ†å°±è¢«é˜»æ­¢äº†ã€‚å¦‚ä½•çªç ´é™åˆ¶ï¼Œæˆä¸ºä¼—å¤šç”¨æˆ·å¤´ç–¼çš„äº‹æƒ…ã€‚å¾€å¸¸çš„åšæ³•æ˜¯ä½¿ç”¨ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯ï¼Œä¸è¿‡è¿™ä¸ªé€‰æ‹©æœ‰å¾ˆå¤§çš„é£é™©ï¼Œå› ä¸ºç”¨æˆ·ä¸çŸ¥é“èƒŒåæ˜¯å¦æ˜¯çªƒå–éšç§ä¿¡æ¯çš„â€œæœ‰å¿ƒäººâ€ã€‚ å…·ä½“å¯èƒ½ä¼šæç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š This group/channel is blocked because it was used to spread pornograhic content. è¯¥ç¾¤ç»„/é¢‘é“ç”±äºä¼ æ’­è‰²#æƒ…å†…å®¹,å·²è¢«å±è”½ã€‚ This channel canâ€™t be displayed because it was used to spread pornographic content? This channel is blocked because it was used to spread pornograhic content. å¦‚ä»Šè¿™ä¸ªé—®é¢˜å·²ç»æœ‰äº†â€œå®˜æ–¹â€çš„è§£å†³åŠæ³•ã€‚ä¸æ˜¯è¯´å®˜æ–¹å®£å¸ƒï¼Œè€Œæ˜¯ç”¨å®˜æ–¹å®¢æˆ·ç«¯æœ¬èº«çš„åŠŸèƒ½æ¥è§£å†³ï¼Œå†ä¹Ÿä¸ç”¨å€ŸåŠ©äºâ€œæ—é—¨å·¦é“â€äº†ã€‚ æ“ä½œæ–¹æ³•ç›®å‰æœ‰ä¸¤ä¸ªæ–¹æ³•æ¥å…³é—­æ•æ„Ÿå†…å®¹è¿‡æ»¤ï¼Œä¸€æ˜¯ä½¿ç”¨ç½‘é¡µç«¯ï¼ŒäºŒæ˜¯ä½¿ç”¨æ¡Œé¢å®¢æˆ·ç«¯ã€‚ä»ä¾¿æ·æ€§æ¥è€ƒè™‘è‡ªç„¶æ˜¯ç½‘é¡µç«¯æ›´å¥½ï¼Œä¸éœ€è¦å€ŸåŠ©ç”µè„‘ï¼Œç›´æ¥ç”¨æ‰‹æœºæµè§ˆå™¨å°±å¯ä»¥è§£å†³ã€‚ 1ã€ä½¿ç”¨Telegram Webé¦–å…ˆç™»å½• Telegram Web ç«¯ï¼šhttps://web.telegram.org/ ç‚¹å‡»å³ä¸Šè§’çš„èœå•ï¼Œæ‰“å¼€ Settingsï¼Œå°† Show Sensitive Content çš„å¼€å…³æ‰“å¼€å°±å®Œæˆäº†ã€‚ å…³æ‰ iOS APP å†é‡æ–°æ‰“å¼€å°±ä¼šå‘ç°ç¦åˆ©å·²ç»å°½æ˜¾çœ¼å‰äº†ã€‚ 2ã€ä½¿ç”¨æ¡Œé¢å®¢æˆ·ç«¯é¦–å…ˆåœ¨ä¸‹è½½å’Œå®‰è£… Win æˆ– Mac ç‰ˆ Telegramï¼š Winç‰ˆï¼šhttps://desktop.telegram.org/ Macç‰ˆï¼šhttps://macos.telegram.org/ ç™»å½• Telegram è´¦å·ä¹‹åæ‰“å¼€ Settings â€“ Privacy and Securityï¼ŒæŠŠ Sensitive Content ä¸‹çš„ Disable filtering æ‰“å¼€ï¼š å¥½äº†ï¼ŒæŠŠ iOS ä¸Šçš„ Telegram APP å…³æ‰é‡æ–°æ‰“å¼€ï¼Œå°±ä¼šå‘ç°ä¹‹å‰æ— æ³•æŸ¥çœ‹çš„ç¾¤ç»„å’Œé¢‘é“éƒ½å·²ç»å¯ä»¥è®¿é—®ã€‚ æ ¹æ®é€‰é¡¹ä¸‹æ–¹çš„ä»‹ç»ï¼Œè¿™ä¸ªå¼€å…³æ˜¯å…¨å±€æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™æ ·æ“ä½œè¿‡åï¼Œè¯¥è´¦å·åœ¨æ‰€æœ‰å¹³å°ä¸Šé¢çš„å®¢æˆ·ç«¯éƒ½é€‚ç”¨è¿™ä¸ªè§„åˆ™ã€‚å¦‚æœæƒ³è¦æµªå­å›å¤´ï¼ŒæŠŠå®ƒå†å…³æ‰å°±å¥½äº†ã€‚","link":"/2020/10/21/%E4%B8%80%E9%94%AE%E8%A7%A3%E9%99%A4iOS%E7%89%88Telegram%E5%AF%B9%E7%BE%A4%E7%BB%84%E5%92%8C%E9%A2%91%E9%81%93%E7%9A%84%E9%99%90%E5%88%B6%E8%8B%B9%E6%9E%9CiPhone%E6%9C%89%E4%BA%9B%E9%A2%91%E9%81%93%E4%B8%8D%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/"},{"title":"åºåˆ—åŒ–é¢è¯•é¢˜","text":"12345678910111213141516171819202122232425262728293031323334353637383940414243é¢è¯•ç›¸å…³1. ååºåˆ—åŒ–åçš„å¯¹è±¡ï¼Œéœ€è¦è°ƒç”¨æ„é€ å‡½æ•°é‡æ–°æ„é€ å— ååºåˆ—åŒ–è°ƒç”¨ä¸ä¼šè°ƒç”¨æ„é€ å‡½æ•°ã€‚ä»¥å­˜å‚¨çš„äºŒè¿›åˆ¶æ•°æ®è¿›è¡Œæ„é€ 2. åºåˆ—å‰çš„å¯¹è±¡ä¸åºåˆ—åŒ–åçš„å¯¹è±¡æ˜¯ä»€ä¹ˆå…³ç³»ï¼Ÿæ˜¯(&quot;==&quot;è¿˜æ˜¯equalï¼Ÿæ˜¯æµ…å¤åˆ¶è¿˜æ˜¯æ·±å¤åˆ¶ï¼Ÿ) åºåˆ—åŒ–å‰å’Œåºåˆ—åŒ–å æ˜¯ä¸¤ä¸ªä¸åŒçš„å¯¹è±¡ï¼Œå¯¹è±¡åœ°å€å‘ç”Ÿäº†æ”¹å˜ã€‚è°ƒç”¨equal å’Œ == è¿”å›trueã€‚æ˜¯ä¸€ä¸ªæ·±å¤åˆ¶ã€‚3. Androidé‡Œé¢ä¸ºä»€ä¹ˆè¦è®¾è®¡å‡ºBundleè€Œä¸æ˜¯ç›´æ¥ç”¨Mapç»“æ„ Bundleä¸­æ˜¯ä½¿ç”¨çš„Parcelæ‰“åŒ…æ•°æ®ã€‚Parcelå¯ä»¥å®ç°è·¨è¿›ç¨‹é€šè®¯ã€‚ &lt;!-- more --&gt; Bundleå†…éƒ¨æ˜¯ç”±ArrayMapå®ç°çš„ï¼ŒArrayMapçš„å†…éƒ¨å®ç°æ˜¯ä¸¤ä¸ªæ•°ç»„ï¼Œä¸€ä¸ªintæ•°ç»„æ˜¯å­˜å‚¨å¯¹è±¡æ•° æ®å¯¹åº”ä¸‹æ ‡ï¼Œä¸€ä¸ªå¯¹è±¡æ•°ç»„ ä¿å­˜keyå’Œvalueï¼Œå†…éƒ¨ä½¿ç”¨äºŒåˆ†æ³•å¯¹keyè¿›è¡Œæ’åºï¼Œæ‰€ä»¥åœ¨æ·»åŠ ã€åˆ  é™¤ã€æŸ¥æ‰¾æ•°æ®çš„æ—¶å€™ï¼Œéƒ½ä¼šä½¿ç”¨äºŒåˆ†æ³•æŸ¥æ‰¾ï¼Œåªé€‚åˆäºå°æ•° æ®é‡æ“ä½œï¼Œå¦‚æœåœ¨æ•°æ®é‡æ¯”è¾ƒå¤§çš„æƒ…å†µ ä¸‹ï¼Œé‚£ä¹ˆå®ƒçš„æ€§èƒ½å°†é€€åŒ–ã€‚è€ŒHashMapå†…éƒ¨åˆ™æ˜¯æ•°ç»„+é“¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥åœ¨æ•°æ®é‡è¾ƒå°‘çš„æ—¶å€™ï¼Œ HashMapçš„Entry Arrayæ¯”ArrayMapå ç”¨æ›´å¤šçš„å†…å­˜ã€‚å› ä¸ºä½¿ç”¨Bundleçš„åœºæ™¯å¤§å¤šæ•°ä¸ºå°æ•°æ® é‡ï¼Œæˆ‘æ²¡è§è¿‡åœ¨ä¸¤ä¸ªActivityä¹‹ é—´ä¼ é€’10ä¸ªä»¥ä¸Šæ•°æ®çš„åœºæ™¯ï¼Œæ‰€ä»¥ç›¸æ¯”ä¹‹ä¸‹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ ArrayMapä¿å­˜æ•°æ®ï¼Œåœ¨æ“ä½œé€Ÿåº¦å’Œå†…å­˜å ç”¨ä¸Šéƒ½å…·æœ‰ä¼˜åŠ¿ï¼Œ å› æ­¤ä½¿ç”¨Bundleæ¥ä¼ é€’æ•°æ®ï¼Œå¯ä»¥ä¿ è¯æ›´å¿«çš„é€Ÿåº¦å’Œæ›´å°‘çš„å†…å­˜å ç”¨ã€‚ å¦å¤–ä¸€ä¸ªåŸå› ï¼Œåˆ™æ˜¯åœ¨Androidä¸­å¦‚æœä½¿ç”¨Intentæ¥æºå¸¦æ•°æ®çš„è¯ï¼Œ éœ€è¦æ•°æ®æ˜¯åŸºæœ¬ç±»å‹æˆ–è€…æ˜¯å¯ åºåˆ—åŒ–ç±»å‹ï¼ŒHashMapä½¿ç”¨Serializableè¿›è¡Œåºåˆ—åŒ–ï¼Œè€ŒBundleåˆ™æ˜¯ä½¿ç”¨Parcelableè¿›è¡Œåºåˆ—åŒ–ã€‚ è€Œåœ¨Androidå¹³å°ä¸­ï¼Œæ›´æ¨èä½¿ç”¨Parcelableå®ç°åºåˆ—åŒ–ï¼Œè™½ç„¶å†™æ³•å¤æ‚ï¼Œä½†æ˜¯å¼€é”€æ›´å°ï¼Œæ‰€ä»¥ä¸º äº†æ›´åŠ å¿«é€Ÿçš„è¿›è¡Œæ•°æ®çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œ ç³»ç»Ÿå°è£…äº†Bundleç±»ï¼Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œæ•°æ®çš„ä¼ è¾“ã€‚4. SerialVersionIDçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ ç‰ˆæœ¬æ§åˆ¶5. Androidä¸­Intent/Bundleçš„é€šä¿¡åŸç†åŠå¤§å°é™åˆ¶ å¤§å°é™åˆ¶ bundle åœ¨zgoteåœ¨åˆ›å»ºè¿›ç¨‹çš„æ—¶å€™ï¼Œåˆ†é…äº†binderçš„å†…å­˜å¤§å°ã€‚binderç”³è¯·åŒ¿åå†…å­˜æœ‰é™åˆ¶ã€‚ binderåœ¨å†…æ ¸ç©ºé—´åˆ›å»ºå†…å­˜æ˜ å°„æ—¶ï¼Œå¤§å°é™åˆ¶åœ¨ &lt; 4M intent 1Mé™åˆ¶ Intent ä¸­çš„ Bundle æ˜¯ä½¿ç”¨ Binder æœºåˆ¶è¿›è¡Œæ•°æ®ä¼ é€çš„ã€‚èƒ½ä½¿ç”¨çš„ Binder çš„ç¼“å†²åŒºæ˜¯æœ‰å¤§å°é™ åˆ¶çš„(æœ‰äº›æ‰‹æœºæ˜¯ 2 M)ï¼Œ è€Œä¸€ä¸ªè¿›ç¨‹é»˜è®¤æœ‰ 16 ä¸ª Binder çº¿ç¨‹ï¼Œæ‰€ä»¥ä¸€ä¸ªçº¿ç¨‹èƒ½å ç”¨çš„ç¼“å†²åŒº å°±æ›´å°äº†( æœ‰äººä»¥å‰åšè¿‡æµ‹è¯•ï¼Œå¤§çº¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å ç”¨ 128 KB)ã€‚ æ‰€ä»¥å½“ä½ çœ‹åˆ° The Binder transaction failed because it was too large è¿™ç±» TransactionTooLargeException å¼‚å¸¸æ—¶ï¼Œ ä½ åº” è¯¥çŸ¥é“æ€ä¹ˆè§£å†³äº†6. ä¸ºä½•Intentä¸èƒ½ç›´æ¥åœ¨ç»„ä»¶é—´ä¼ é€’å¯¹è±¡è€Œè¦é€šè¿‡åºåˆ—åŒ–æœºåˆ¶ï¼Ÿ startActivityï¼ˆintentï¼‰ï¼Œactivityå¯åŠ¨æµç¨‹è¦å’ŒAMSäº¤äº’ï¼Œéœ€è¦è·¨è¿›ç¨‹é€šè®¯ã€‚åªæœ‰æŠŠæ•°æ®åºåˆ—åŒ–åï¼Œä¼ é€’ã€‚7. åºåˆ—åŒ–ä¸æŒä¹…åŒ–çš„å…³ç³»å’ŒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ åºåˆ—åŒ–:è·¨è¿›ç¨‹ä¼ è¾“æ•°æ®æ—¶ï¼Œéœ€è¦ä½¿ç”¨åºåˆ—åŒ–ã€‚ æŒä¹…åŒ–:æ•°æ®çš„å­˜å‚¨ã€‚ Intentåœ¨å¯åŠ¨å…¶ä»–ç»„ä»¶æ—¶ï¼Œä¼šç¦»å¼€å½“å‰åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œè¿›å…¥ActivityManagerServiceè¿›ç¨‹ (intent.prepareToLeaveProcess())ï¼Œ è¿™ä¹Ÿå°±æ„å‘³ç€ï¼ŒIntentæ‰€æºå¸¦çš„æ•°æ®è¦èƒ½å¤Ÿåœ¨ä¸åŒè¿›ç¨‹é—´ ä¼ è¾“ã€‚é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼ŒAndroidæ˜¯åŸºäºLinuxç³»ç»Ÿï¼Œä¸åŒè¿›ç¨‹ä¹‹é—´çš„javaå¯¹è±¡æ˜¯æ— æ³•ä¼ è¾“ï¼Œ æ‰€ä»¥æˆ‘ ä»¬æ­¤å¤„è¦å¯¹å¯¹è±¡è¿›è¡Œåºåˆ—åŒ–ï¼Œä»è€Œå®ç°å¯¹è±¡åœ¨ åº”ç”¨ç¨‹åºè¿›ç¨‹ å’Œ ActivityManagerServiceè¿›ç¨‹ ä¹‹é—´ ä¼ è¾“ã€‚ è€ŒParcelæˆ–è€…Serializableéƒ½å¯ä»¥å°†å¯¹è±¡åºåˆ—åŒ–ï¼Œå…¶ä¸­ï¼ŒSerializableä½¿ç”¨æ–¹ä¾¿ï¼Œä½†æ€§èƒ½ä¸å¦‚Parcel å®¹å™¨ ï¼Œåè€…ä¹Ÿæ˜¯Androidç³»ç»Ÿä¸“é—¨æ¨å‡ºçš„ç”¨äºè¿›ç¨‹é—´é€šä¿¡ç­‰çš„æ¥å£","link":"/2020/09/11/%E5%BA%8F%E5%88%97%E5%8C%96%E9%9D%A2%E8%AF%95%E9%A2%98/"},{"title":"ç§‘å­¦ä¸Šç½‘åˆ©å™¨å¤§å…¨","text":"Algo - åœ¨äº‘ä¸­è®¾ç½®ä¸ªäºº IPSEC VPNã€‚ æºç  ClashX - åŸºäº clash çš„ä¸€æ¬¾æ”¯æŒè§„åˆ™è¿‡æ»¤çš„ç§‘å­¦ä¸Šç½‘å·¥å…·ã€‚ æºç  FreeVPN Plus - æ°¸ä¸è¿‡æœŸ Mac å…è´¹VPNã€‚ Firefly è¤ç«è™« - å…è´¹ç§‘å­¦ä¸Šç½‘ã€‚ GoAgentX - ç§‘å­¦ä¸Šç½‘ã€‚(https://github.com/getlantern/lantern) GTXåŠ é€Ÿå™¨ - æ¯å¤©ç­¾åˆ°é¢†å– 500M æµé‡ã€‚ Lantern - ç§‘å­¦ä¸Šç½‘ã€‚(https://github.com/getlantern/lantern) LoCoVPN - æ¯å¤©ç­¾åˆ°å¯è·å¾— 2 å°æ—¶å…è´¹VPNåŠ é€Ÿã€‚ SpechtLite - æ”¯æŒ Shadowsocks åŠè§„åˆ™ç®¡ç†çš„é«˜æ•ˆç‡ä»£ç†ã€‚æºç  ShadowsocksX - ä¸€ä¸ªå¿«é€Ÿçš„éš§é“ä»£ç†ï¼Œå¯ä»¥å¸®åŠ©ä½ ç»•è¿‡é˜²ç«å¢™ã€‚æºç  ShadowsocksX-NG - ä¸€æ¬¾ ShadowsocksX å®¢æˆ·ç«¯è½¯ä»¶ã€‚æºç  Surge - ç§‘å­¦ä¸Šç½‘ã€‚ Shimo - è¿æ¥å¤§é‡ VPN çš„åº”ç”¨ Tunnelbear - ç®€å•çš„ç§äºº VPNã€‚ Tunnelblick - OpenVPN çš„å…è´¹è½¯ä»¶ã€‚ tinc - VPN è½¯ä»¶. æºç  V2Ray - åŸç”Ÿæ”¯æŒ Socksã€HTTPã€Shadowsocksã€VMess ç­‰åè®®ã€‚ V2rayU - ä¸€æ¬¾ v2ray å®¢æˆ·ç«¯è½¯ä»¶ã€‚æºç  äºŒå¸ˆå…„VPN - æä¾›æ— é™æµé‡ã€æ— é™ç»­æœŸå…è´¹ VPN è´¦å·ã€‚ é£é©°VPN - æ— é™æµé‡ã€æ— é™ç»­æœŸçš„å…è´¹ VPN åŠ é€ŸæœåŠ¡ã€‚","link":"/2020/10/22/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91%E5%88%A9%E5%99%A8%E5%A4%A7%E5%85%A8/"},{"title":"Android åŸºç¡€çŸ¥è¯†æ€»ç»“","text":"â€‹ Activityç”Ÿå‘½å‘¨æœŸ img Fragmentç”Ÿå‘½å‘¨æœŸ Activity**å››ç§å¯åŠ¨æ¨¡å¼** standard : æ ‡å‡†æ¨¡å¼,æ¯æ¬¡å¯åŠ¨Activityéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Activityå®ä¾‹,å¹¶ä¸”å°†å…¶å‹å…¥ä»»åŠ¡æ ˆæ ˆé¡¶,è€Œä¸ç®¡è¿™ä¸ªActivityæ˜¯å¦å·²ç»å­˜åœ¨ã€‚Activityçš„å¯åŠ¨ä¸‰å›è°ƒ(onCreate()-&gt;onStart()-&gt;onResume())éƒ½ä¼šæ‰§è¡Œã€‚ singleTop : æ ˆé¡¶å¤ç”¨æ¨¡å¼.è¿™ç§æ¨¡å¼ä¸‹,å¦‚æœæ–°Activityå·²ç»ä½äºä»»åŠ¡æ ˆçš„æ ˆé¡¶,é‚£ä¹ˆæ­¤Activityä¸ä¼šè¢«é‡æ–°åˆ›å»º,æ‰€ä»¥å®ƒçš„å¯åŠ¨ä¸‰å›è°ƒå°±ä¸ä¼šæ‰§è¡Œ,åŒæ—¶Activityçš„onNewIntent()æ–¹æ³•ä¼šè¢«å›è°ƒ.å¦‚æœActivityå·²ç»å­˜åœ¨ä½†æ˜¯ä¸åœ¨æ ˆé¡¶,é‚£ä¹ˆä½œç”¨ä¸standard**æ¨¡å¼ä¸€æ ·. singleTask: æ ˆå†…å¤ç”¨æ¨¡å¼.åˆ›å»ºè¿™æ ·çš„Activityçš„æ—¶å€™,ç³»ç»Ÿä¼šå…ˆç¡®è®¤å®ƒæ‰€éœ€ä»»åŠ¡æ ˆå·²ç»åˆ›å»º,å¦åˆ™å…ˆåˆ›å»ºä»»åŠ¡æ ˆ.ç„¶åæ”¾å…¥Activity,å¦‚æœæ ˆä¸­å·²ç»æœ‰ä¸€ä¸ªActivityå®ä¾‹,é‚£ä¹ˆè¿™ä¸ªActivityå°±ä¼šè¢«è°ƒåˆ°æ ˆé¡¶,onNewIntent(),å¹¶ä¸”singleTaskä¼šæ¸…ç†åœ¨å½“å‰Activityä¸Šé¢çš„æ‰€æœ‰Activity.(clear top) singleInstance : åŠ å¼ºç‰ˆçš„singleTaskæ¨¡å¼,è¿™ç§æ¨¡å¼çš„Activityåªèƒ½å•ç‹¬ä½äºä¸€ä¸ªä»»åŠ¡æ ˆå†…,ç”±äºæ ˆå†…å¤ç”¨çš„ç‰¹æ€§,åç»­è¯·æ±‚å‡ä¸ä¼šåˆ›å»ºæ–°çš„Activity,é™¤éè¿™ä¸ªç‹¬ç‰¹çš„ä»»åŠ¡æ ˆè¢«ç³»ç»Ÿé”€æ¯äº† Service**çš„ç”Ÿå‘½å‘¨æœŸä¸å¯åŠ¨æ–¹æ³•ç”±ä»€ä¹ˆåŒºåˆ«ï¼Ÿ** startService()ï¼šå¼€å¯Serviceï¼Œè°ƒç”¨è€…é€€å‡ºåServiceä»ç„¶å­˜åœ¨ã€‚ bindService()ï¼šå¼€å¯Serviceï¼Œè°ƒç”¨è€…é€€å‡ºåServiceä¹Ÿéšå³é€€å‡ºã€‚ Service**ç”Ÿå‘½å‘¨æœŸï¼š** åªæ˜¯ç”¨startService()å¯åŠ¨æœåŠ¡ï¼šonCreate() -&gt; onStartCommand() -&gt; onDestory åªæ˜¯ç”¨bindService()ç»‘å®šæœåŠ¡ï¼šonCreate() -&gt; onBind() -&gt; onUnBind() -&gt; onDestory åŒæ—¶ä½¿ç”¨startService()å¯åŠ¨æœåŠ¡ä¸bindService()ç»‘å®šæœåŠ¡ï¼šonCreate() -&gt; onStartCommnad() -&gt; onBind() -&gt; onUnBind() -&gt; onDestory å¹¿æ’­**å‘é€å’Œæ¥æ”¶çš„åŸç†äº†è§£å—**ï¼Ÿ ç»§æ‰¿BroadcastReceiverï¼Œé‡å†™onReceive()æ–¹æ³•ã€‚ é€šè¿‡Binderæœºåˆ¶å‘ActivityManagerServiceæ³¨å†Œå¹¿æ’­ã€‚ é€šè¿‡Binderæœºåˆ¶å‘ActivityMangerServiceå‘é€å¹¿æ’­ã€‚ ActivityManagerServiceæŸ¥æ‰¾ç¬¦åˆç›¸åº”æ¡ä»¶çš„å¹¿æ’­ï¼ˆIntentFilter/Permissionï¼‰çš„BroadcastReceiverï¼Œå°†å¹¿æ’­å‘é€åˆ°BroadcastReceiveræ‰€åœ¨çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚ BroadcastReceiveræ‰€åœ¨æ¶ˆæ¯é˜Ÿåˆ—æ‹¿åˆ°æ­¤å¹¿æ’­åï¼Œå›è°ƒå®ƒçš„onReceive()æ–¹æ³•ã€‚ã€ Android Handleræœºåˆ¶æ˜¯åšä»€ä¹ˆçš„ï¼ŒåŸç†äº†è§£å— ä¸»è¦æ¶‰åŠçš„è§’è‰²å¦‚ä¸‹æ‰€ç¤ºï¼š 1.Message:æ¶ˆæ¯,åˆ†ä¸ºç¡¬ä»¶äº§ç”Ÿçš„æ¶ˆæ¯ï¼ˆä¾‹å¦‚:æŒ‰é’®ã€è§¦æ‘¸ï¼‰å’Œè½¯ä»¶äº§ç”Ÿçš„æ¶ˆæ¯ã€‚ 2. MessageQueueï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸»è¦ç”¨æ¥å‘æ¶ˆæ¯æ± æ·»åŠ æ¶ˆæ¯å’Œå–èµ°æ¶ˆæ¯ã€‚ 3. Looperï¼šæ¶ˆæ¯å¾ªç¯å™¨ï¼Œä¸»è¦ç”¨æ¥æŠŠæ¶ˆæ¯åˆ†å‘ç»™ç›¸åº”çš„å¤„ç†è€…ã€‚ 4. Handlerï¼šæ¶ˆæ¯å¤„ç†å™¨ï¼Œä¸»è¦å‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€å„ç§æ¶ˆæ¯ä»¥åŠå¤„ç†å„ç§æ¶ˆæ¯ã€‚ æ•´ä¸ªæ¶ˆæ¯çš„å¾ªç¯æµç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œå…·ä½“è¯´æ¥ï¼š 1. Handleré€šè¿‡sendMessage()å‘é€æ¶ˆæ¯Messageåˆ°æ¶ˆæ¯é˜Ÿåˆ—MessageQueueã€‚ 2. Looperé€šè¿‡loop()å¾ªç¯æå–è§¦å‘Message,å¹¶å°†Messageäº¤ç»™å¯¹åº”çš„target handleræ¥å¤„ç†ã€‚ 3. target handlerè°ƒç”¨è‡ªèº«çš„handleMessage()æ–¹æ³•æ¥å¤„ç†Messageã€‚ å¦‚ä½•è‡ªå®šä¹‰androidæ§ä»¶ è‡ªå®šä¹‰å±æ€§çš„å£°æ˜å’Œè·å– åˆ†æéœ€è¦çš„è‡ªå®šä¹‰å±æ€§ åœ¨res/values/attrs.xmlå®šä¹‰å£°æ˜ åœ¨layoutæ–‡ä»¶ä¸­è¿›è¡Œä½¿ç”¨ åœ¨Viewçš„æ„é€ æ–¹æ³•ä¸­è¿›è¡Œè·å– æµ‹é‡onMeasure(int widthMeasureSpec, int heightMeasureSpec) å¸ƒå±€onLayout(boolean changed, int left, int top, int right, int bottom) ç»˜åˆ¶onDraw(Canvas canvas) onTouchEvent onInterceptTouchEvent(ViewGroup) çŠ¶æ€çš„æ¢å¤ä¸ä¿å­˜ æè¿°ä¸€ä¸‹**Viewçš„ç»˜**åˆ¶åŸç†ï¼Ÿ Viewçš„ç»˜åˆ¶æµç¨‹ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š onMeasureï¼šæµ‹é‡è§†å›¾çš„å¤§å°ï¼Œä»é¡¶å±‚çˆ¶Viewåˆ°å­Viewé€’å½’è°ƒç”¨measure()æ–¹æ³•ï¼Œmeasure()è°ƒç”¨onMeasure()æ–¹æ³•ï¼ŒonMeasure()æ–¹æ³•å®Œæˆæµ‹é‡å·¥ä½œã€‚ onLayoutï¼šç¡®å®šè§†å›¾çš„ä½ç½®ï¼Œä»é¡¶å±‚çˆ¶Viewåˆ°å­Viewé€’å½’è°ƒç”¨layout()æ–¹æ³•ï¼Œçˆ¶Viewå°†ä¸Šä¸€æ­¥measure()æ–¹æ³•å¾—åˆ°çš„å­Viewçš„å¸ƒå±€å¤§å°å’Œå¸ƒå±€å‚æ•°ï¼Œå°†å­Viewæ”¾åœ¨åˆé€‚çš„ä½ç½®ä¸Šã€‚ onDrawï¼šç»˜åˆ¶æœ€ç»ˆçš„è§†å›¾ï¼Œé¦–å…ˆViewRootåˆ›å»ºä¸€ä¸ªCanvaså¯¹è±¡ï¼Œç„¶åè°ƒç”¨onDraw()æ–¹æ³•è¿›è¡Œç»˜åˆ¶ã€‚onDraw()æ–¹æ³•çš„ç»˜åˆ¶æµç¨‹ä¸ºï¼šâ‘  ç»˜åˆ¶è§†å›¾èƒŒæ™¯ã€‚â‘¡ ç»˜åˆ¶ç”»å¸ƒçš„å›¾å±‚ã€‚ â‘¢ ç»˜åˆ¶Viewå†…å®¹ã€‚ â‘£ ç»˜åˆ¶å­è§†å›¾ï¼Œå¦‚æœæœ‰çš„è¯ã€‚â‘¤ è¿˜åŸå›¾å±‚ã€‚â‘¥ ç»˜åˆ¶æ»šåŠ¨æ¡ã€‚ requestLayout()**ã€invalidate()ä¸postInvalidate()æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ** requestLayout()ï¼šè¯¥æ–¹æ³•ä¼šé€’å½’è°ƒç”¨çˆ¶çª—å£çš„requestLayout()æ–¹æ³•ï¼Œç›´åˆ°è§¦å‘ViewRootImplçš„performTraversals()æ–¹æ³•ï¼Œæ­¤æ—¶mLayoutRequestedeä¸ºtrueï¼Œä¼šè§¦å‘onMesaure()ä¸onLayout()æ–¹æ³•ï¼Œä¸ä¸€å®š ä¼šè§¦å‘onDraw()æ–¹æ³•ã€‚ invalidate()ï¼šè¯¥æ–¹æ³•é€’å½’è°ƒç”¨çˆ¶Viewçš„invalidateChildInParent()æ–¹æ³•ï¼Œç›´åˆ°è°ƒç”¨ViewRootImplçš„invalidateChildInParent()æ–¹æ³•ï¼Œæœ€ç»ˆè§¦å‘ViewRootImplçš„performTraversals()æ–¹æ³•ï¼Œæ­¤æ—¶mLayoutRequestedeä¸ºfalseï¼Œä¸ä¼š è§¦å‘onMesaure()ä¸onLayout()æ–¹æ³•ï¼Œå½“æ—¶ä¼šè§¦å‘onDraw()æ–¹æ³•ã€‚ postInvalidate()ï¼šè¯¥æ–¹æ³•åŠŸèƒ½å’Œinvalidate()ä¸€æ ·ï¼Œåªæ˜¯å®ƒå¯ä»¥åœ¨éUIçº¿ç¨‹ä¸­è°ƒç”¨ã€‚ APKçš„æ‰“åŒ…æµç¨‹ 1. é€šè¿‡AAPTå·¥å…·è¿›è¡Œèµ„æºæ–‡ä»¶ï¼ˆåŒ…æ‹¬AndroidManifest.xmlã€å¸ƒå±€æ–‡ä»¶ã€å„ç§xmlèµ„æºç­‰ï¼‰çš„æ‰“åŒ…ï¼Œç”ŸæˆR.javaæ–‡ä»¶ã€‚ 2. é€šè¿‡AIDLå·¥å…·å¤„ç†AIDLæ–‡ä»¶ï¼Œç”Ÿæˆç›¸åº”çš„Javaæ–‡ä»¶ã€‚ 3. é€šè¿‡Javacå·¥å…·ç¼–è¯‘é¡¹ç›®æºç ï¼Œç”ŸæˆClassæ–‡ä»¶ã€‚ 4. é€šè¿‡DXå·¥å…·å°†æ‰€æœ‰çš„Classæ–‡ä»¶è½¬æ¢æˆDEXæ–‡ä»¶ï¼Œè¯¥è¿‡ç¨‹ä¸»è¦å®ŒæˆJavaå­—èŠ‚ç è½¬æ¢æˆDalvikå­—èŠ‚ç ï¼Œå‹ç¼©å¸¸é‡æ± ä»¥åŠæ¸…é™¤å†—ä½™ä¿¡æ¯ç­‰å·¥ä½œã€‚ 5. é€šè¿‡ApkBuilderå·¥å…·å°†èµ„æºæ–‡ä»¶ã€DEXæ–‡ä»¶æ‰“åŒ…ç”ŸæˆAPKæ–‡ä»¶ã€‚ 6. åˆ©ç”¨KeyStoreå¯¹ç”Ÿæˆçš„APKæ–‡ä»¶è¿›è¡Œç­¾åã€‚ 7. å¦‚æœæ˜¯æ­£å¼ç‰ˆçš„APKï¼Œè¿˜ä¼šåˆ©ç”¨ZipAlignå·¥å…·è¿›è¡Œå¯¹é½å¤„ç†ï¼Œå¯¹é½çš„è¿‡ç¨‹å°±æ˜¯å°†APKæ–‡ä»¶ä¸­æ‰€æœ‰çš„èµ„æºæ–‡ä»¶ä¸¾ä¾‹æ–‡ä»¶çš„èµ·å§‹è·ç¦»éƒ½åç§»4å­—èŠ‚çš„æ•´æ•°å€ï¼Œè¿™æ ·é€šè¿‡å†…å­˜æ˜ å°„è®¿é—®APKæ–‡ä»¶ çš„é€Ÿåº¦ä¼šæ›´å¿«ã€‚ (adsbygoogle = window.adsbygoogle || []).push({}); APKçš„å®‰è£…æµç¨‹ 1. å¤åˆ¶APKåˆ°/data/appç›®å½•ä¸‹ï¼Œè§£å‹å¹¶æ‰«æå®‰è£…åŒ…ã€‚ 2. èµ„æºç®¡ç†å™¨è§£æAPKé‡Œçš„èµ„æºæ–‡ä»¶ã€‚ 3. è§£æAndroidManifestæ–‡ä»¶ï¼Œå¹¶åœ¨/data/data/ç›®å½•ä¸‹åˆ›å»ºå¯¹åº”çš„åº”ç”¨æ•°æ®ç›®å½•ã€‚ 4. ç„¶åå¯¹dexæ–‡ä»¶è¿›è¡Œä¼˜åŒ–ï¼Œå¹¶ä¿å­˜åœ¨dalvik-cacheç›®å½•ä¸‹ã€‚ 5. å°†AndroidManifestæ–‡ä»¶è§£æå‡ºçš„å››å¤§ç»„ä»¶ä¿¡æ¯æ³¨å†Œåˆ°PackageManagerServiceä¸­ã€‚ 6. å®‰è£…å®Œæˆåï¼Œå‘é€å¹¿æ’­ã€‚ Android Binder**æœºåˆ¶æ˜¯åšä»€ä¹ˆçš„ï¼Œä¸ºä»€ä¹ˆé€‰ç”¨Binderï¼ŒåŸç†äº†è§£å—ï¼Ÿ** Android Binderæ˜¯ç”¨æ¥åšè¿›ç¨‹é€šä¿¡çš„ï¼ŒAndroidçš„å„ä¸ªåº”ç”¨ä»¥åŠç³»ç»ŸæœåŠ¡éƒ½è¿è¡Œåœ¨ç‹¬ç«‹çš„è¿›ç¨‹ä¸­ï¼Œå®ƒä»¬çš„é€šä¿¡éƒ½ä¾èµ–äºBinderã€‚ ä¸ºä»€ä¹ˆé€‰ç”¨Binderï¼Œåœ¨è®¨è®ºè¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬çŸ¥é“Androidä¹Ÿæ˜¯åŸºäºLinuxå†…æ ¸ï¼ŒLinuxç°æœ‰çš„è¿›ç¨‹é€šä¿¡æ‰‹æ®µæœ‰ä»¥ä¸‹å‡ ç§ï¼š ç®¡é“ï¼šåœ¨åˆ›å»ºæ—¶åˆ†é…ä¸€ä¸ªpageå¤§å°çš„å†…å­˜ï¼Œç¼“å­˜åŒºå¤§å°æ¯”è¾ƒæœ‰é™ï¼› æ¶ˆæ¯**é˜Ÿ**åˆ—ï¼šä¿¡æ¯å¤åˆ¶ä¸¤æ¬¡ï¼Œé¢å¤–çš„CPUæ¶ˆè€—ï¼›ä¸åˆé€‚é¢‘ç¹æˆ–ä¿¡æ¯é‡å¤§çš„é€šä¿¡ï¼› å…±äº«å†…å­˜ï¼šæ— é¡»å¤åˆ¶ï¼Œå…±äº«ç¼“å†²åŒºç›´æ¥ä»˜é™„åŠ åˆ°è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œé€Ÿåº¦å¿«ï¼›ä½†è¿›ç¨‹é—´çš„åŒæ­¥é—®é¢˜æ“ä½œç³»ç»Ÿæ— æ³•å®ç°ï¼Œå¿…é¡»å„è¿›ç¨‹åˆ©ç”¨åŒæ­¥å·¥å…·è§£å†³ï¼› å¥—æ¥å­—ï¼šä½œä¸ºæ›´é€šç”¨çš„æ¥å£ï¼Œä¼ è¾“æ•ˆç‡ä½ï¼Œä¸»è¦ç”¨äºä¸é€šæœºå™¨æˆ–è·¨ç½‘ç»œçš„é€šä¿¡ï¼› ä¿¡å·é‡ï¼šå¸¸ä½œä¸ºä¸€ç§é”æœºåˆ¶ï¼Œé˜²æ­¢æŸè¿›ç¨‹æ­£åœ¨è®¿é—®å…±äº«èµ„æºæ—¶ï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿè®¿é—®è¯¥èµ„æºã€‚å› æ­¤ï¼Œä¸»è¦ä½œä¸ºè¿›ç¨‹é—´ä»¥åŠåŒä¸€è¿›ç¨‹å†…ä¸åŒçº¿ç¨‹ä¹‹é—´çš„åŒæ­¥æ‰‹æ®µã€‚ \\6. ä¿¡å· : ä¸é€‚ç”¨äºä¿¡æ¯äº¤æ¢ï¼Œæ›´é€‚ç”¨äºè¿›ç¨‹ä¸­æ–­æ§åˆ¶ï¼Œæ¯”å¦‚éæ³•å†…å­˜è®¿é—®ï¼Œæ€æ­»æŸä¸ªè¿› ç¨‹ç­‰ï¼› æ—¢ç„¶æœ‰ç°æœ‰çš„IPCæ–¹å¼ï¼Œä¸ºä»€ä¹ˆé‡æ–°è®¾è®¡ä¸€å¥—Binderæœºåˆ¶å‘¢ã€‚ä¸»è¦æ˜¯å‡ºäºä»¥ä¸Šä¸‰ä¸ªæ–¹é¢çš„è€ƒé‡ï¼š é«˜æ€§èƒ½ï¼šä»æ•°æ®æ‹·è´æ¬¡æ•°æ¥çœ‹Binderåªéœ€è¦è¿›è¡Œä¸€æ¬¡å†…å­˜æ‹·è´ï¼Œè€Œç®¡é“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€Socketéƒ½éœ€è¦ä¸¤æ¬¡ï¼Œå…±äº«å†…å­˜ä¸éœ€è¦æ‹·è´ï¼ŒBinderçš„æ€§èƒ½ä»…æ¬¡äºå…±äº«å†…å­˜ã€‚ ç¨³å®šæ€§ï¼šä¸Šé¢è¯´åˆ°å…±äº«å†…å­˜çš„æ€§èƒ½ä¼˜äºBinderï¼Œé‚£ä¸ºä»€ä¹ˆä¸é€‚ç”¨å…±äº«å†…å­˜å‘¢ï¼Œå› ä¸ºå…±äº«å†…å­˜éœ€è¦å¤„ç†å¹¶å‘åŒæ­¥é—®é¢˜ï¼Œæ§åˆ¶è´Ÿè´£ï¼Œå®¹æ˜“å‡ºç°æ­»é”å’Œèµ„æºç«äº‰ï¼Œç¨³å®šæ€§è¾ƒå·®ã€‚è€ŒBinderåŸºäºC/Sæ¶æ„ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å½¼æ­¤ç‹¬ç«‹ï¼Œç¨³å®šæ€§è¾ƒå¥½ã€‚ å®‰å…¨æ€§ï¼šæˆ‘ä»¬çŸ¥é“Androidä¸ºæ¯ä¸ªåº”ç”¨åˆ†é…äº†UIDï¼Œç”¨æ¥ä½œä¸ºé‰´åˆ«è¿›ç¨‹çš„é‡è¦æ ‡å¿—ï¼ŒAndroidå†…éƒ¨ä¹Ÿä¾èµ–è¿™ä¸ªUIDè¿›è¡Œæƒé™ç®¡ç†ï¼ŒåŒ…æ‹¬6.0ä»¥å‰çš„å›ºå®šæƒé™å’Œ6.0ä»¥åçš„åŠ¨æ€æƒé™ï¼Œä¼ è£IPCåªèƒ½ç”±ç”¨æˆ·åœ¨æ•°æ®åŒ…é‡Œå¡«å…¥UID/PIDï¼Œè¿™ä¸ªæ ‡è®°å®Œå…¨ æ˜¯åœ¨ç”¨æˆ·ç©ºé—´æ§åˆ¶çš„ï¼Œæ²¡æœ‰æ”¾åœ¨å†…æ ¸ç©ºé—´ï¼Œå› æ­¤æœ‰è¢«æ¶æ„ç¯¡æ”¹çš„å¯èƒ½ï¼Œå› æ­¤Binderçš„å®‰å…¨æ€§æ›´é«˜ã€‚","link":"/2020/09/11/Android%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93%20(%E9%9D%A2%E8%AF%95)/"},{"title":"Android ç»å…¸è“ç‰™é€šè®¯ä¼ è¾“Demo","text":"BlueUtilsç»å…¸è“ç‰™æœç´¢ï¼Œè¿æ¥ï¼Œæ•°æ®ä¼ è¾“å°DEMO é€šè¿‡ç»å…¸æ¨¡å¼ æœç´¢ è“ç‰™åº”ç”¨ã€‚è“ç‰™æœ‰è“ç‰™1.0ã€è“ç‰™2.0ã€è“ç‰™3.0ã€è“ç‰™4.0ä¹‹ç±»çš„ä»¥æ•°å­—ç»“å°¾çš„è“ç‰™ç‰ˆæœ¬å·ï¼Œè€Œå®é™…ä¸Šï¼Œåœ¨æœ€æ–°çš„æ ‡å‡†ä¸­ï¼Œå·²ç»ä¸å†ä½¿ç”¨æ•°å­—ç‰ˆæœ¬å·ä½œä¸ºè“ç‰™ç‰ˆæœ¬çš„åŒºåˆ†äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ç»å…¸è“ç‰™ä¸ä½åŠŸè€—è“ç‰™ï¼ˆBLEï¼‰è¿™ä¸¤ç§åŒºåˆ«ã€‚BLE è“ç‰™ä¸åšè¿‡å¤šè®²è§£ã€‚å…·ä½“çš„ä¿¡æ¯å¤§å®¶å¯ä»¥å‚è€ƒã€‚ https://www.jianshu.com/p/fc46c154eb77 (ç»å…¸è“ç‰™) https://www.jianshu.com/p/3a372af38103 (BLEè“ç‰™) æµç¨‹ å‘ç°è®¾å¤‡-&gt;é…å¯¹/ç»‘å®šè®¾å¤‡-&gt;å»ºç«‹è¿æ¥-&gt;æ•°æ®é€šä¿¡ ç»å…¸è“ç‰™å’Œä½åŠŸè€—è“ç‰™é™¤äº†é…å¯¹/ç»‘å®šè¿™ä¸ªç¯èŠ‚æ˜¯ä¸€æ ·çš„ä¹‹å¤–ï¼Œå…¶å®ƒä¸‰ä¸ªç¯èŠ‚éƒ½æ˜¯ä¸åŒçš„ã€‚ æˆªå›¾ è¯¦è§£ å…¬å¸æœ€è¿‘åœ¨è¦åšä¸€ä¸ªè“ç‰™ä¸ä¸²å£é€šè®¯çš„é¡¹ç›®ï¼Œç„¶åå°±æ¶‰åŠåˆ°æ‰‹æœºç«¯ä¸è“ç‰™çš„è¿æ¥åŠæ•°æ®äº¤äº’ã€‚å¤§è‡´éœ€æ±‚å°±æ˜¯é€šè¿‡æ‰‹æœºæœç´¢ç¡¬ä»¶è“ç‰™ è®¾å¤‡ï¼Œç„¶åè¿æ¥ä¸Šè“ç‰™ï¼Œé€šè¿‡æ‰‹æœºç«¯çš„æŒ‡ä»¤æ¶ˆæ¯æ¥è·å–ä¸²å£ä¿¡æ¯ï¼Œåœ¨é€šè¿‡è“ç‰™è¿”å›æ•°æ®åˆ°æ‰‹æœºç«¯ã€‚åœ¨è¿™ä¹‹å‰çœ‹äº†ä¸€äº›å¼€æºçš„é¡¹ç›®ï¼Œ åŒ…æ‹¬BluetoothKitï¼ŒFastBleï¼ŒBluetoothHelperç­‰å…¶ä¸­BluetoothKitå’ŒFastBleåªæ”¯æŒBLE æ¨¡å¼è“ç‰™ï¼Œå› ä¸ºç¡¬ä»¶çš„æ¨¡å¼æ˜¯ ç»å…¸æ¨¡å¼ï¼Œåæ¥è‡ªå·±åœ¨ä¸¤ä¸ªé¡¹ç›®çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¿®æ”¹ï¼Œç„¶åå¯ä»¥æœç´¢åˆ°ç»å…¸è“ç‰™ã€‚ä½†æ˜¯æ€ä¹ˆä¹Ÿæ˜¯è¿æ¥ä¸ä¸Šæˆ‘ä»¬çš„ç¡¬ä»¶è®¾å¤‡ã€‚ï¼ˆåº” è¯¥æ˜¯åº•å±‚ä¸æ˜¯ç»å…¸è“ç‰™è¿æ¥å¯¼è‡´ã€‚ï¼‰åæ¥å‘ç°äº†BluetoothHelperé¡¹ç›®ã€‚åœ¨è¿™ä¸ªé¡¹ç›®çš„åŸºç¡€ä¸Šåšäº†ä¸€äº›ä¿®æ”¹åŠä¼˜åŒ– ï¼Œèƒ½å¤Ÿæ»¡è¶³ é¡¹ç›®éœ€æ±‚ï¼Œç°åœ¨å°†è¿™ä¸ªé¡¹ç›®åšäº†åˆ†åŒ…åŠä¼˜åŒ–ã€‚ç„¶ååœ¨è¿™åˆ†äº«è‡ªå·±çš„ä¸€äº›è¸©å‘å¿ƒå¾—ã€‚ ç¬¬ä¸€æ­¥ï¼šå£°æ˜æ‰€éœ€è¦çš„æƒé™&lt;uses-permission android:name=&quot;android.permission.BLUETOOTH&quot;/&gt; ä½¿ç”¨è“ç‰™æ‰€éœ€è¦çš„æƒé™ &lt;uses-permission android:name=&quot;android.permission.BLUETOOTH_ADMIN&quot;/&gt; ä½¿ç”¨æ‰«æå’Œè®¾ç½®è“ç‰™çš„æƒé™ï¼ˆç”³æ˜è¿™ä¸€ä¸ªæƒé™å¿…é¡»ç”³æ˜ä¸Šé¢ä¸€ä¸ªæƒé™ï¼‰ åœ¨Android5.0ä¹‹å‰ï¼Œæ˜¯é»˜è®¤ç”³è¯·GPSç¡¬ä»¶åŠŸèƒ½çš„ã€‚è€Œåœ¨Android 5.0 ä¹‹åï¼Œéœ€è¦åœ¨manifest ä¸­ç”³æ˜GPSç¡¬ä»¶æ¨¡å—åŠŸèƒ½çš„ä½¿ç”¨ã€‚ &lt;!-- Needed only if your app targets Android 5.0 (API level 21) or higher. --&gt; &lt;uses-feature android:name=&quot;android.hardware.location.gps&quot; /&gt; åœ¨ Android 6.0 åŠä»¥ä¸Šï¼Œè¿˜éœ€è¦æ‰“å¼€ä½ç½®æƒé™ã€‚å¦‚æœåº”ç”¨æ²¡æœ‰ä½ç½®æƒé™ï¼Œè“ç‰™æ‰«æåŠŸèƒ½ä¸èƒ½ä½¿ç”¨ï¼ˆå…¶å®ƒè“ç‰™æ“ä½œä¾‹å¦‚è¿æ¥è“ç‰™è®¾å¤‡å’Œå†™å…¥æ•°æ®ä¸å—å½±å“ï¼‰ã€‚ &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;/&gt; ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–å®ä¾‹åœ¨é¡µé¢é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªBlueManagerã€‚ private BlueManager bluemanage; bluemanage = BlueManager.getInstance(getApplicationContext()); ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®å®ä¾‹ç›‘å¬ ç„¶åä¸ºè¿™ä¸ªè“ç‰™ç®¡ç†å™¨è®¾ç½®ç›‘å¬(OnSearchDeviceListenerï¼ŒOnConnectListenerï¼ŒOnSendMessageListenerï¼ŒOnReceiveMessageListener) /** * åˆå§‹åŒ–è“ç‰™ç®¡ç†ï¼Œè®¾ç½®ç›‘å¬ */ public void initBlueManager() { bluemanage = BlueManager.getInstance(getApplicationContext()); bluemanage.setOnSearchDeviceListener(onSearchDeviceListener); bluemanage.setOnConnectListener(onConnectListener); bluemanage.setOnSendMessageListener(onSendMessageListener); bluemanage.setOnReceiveMessageListener(onReceiveMessageListener); bluemanage.requestEnableBt(); } ç¬¬å››æ­¥ï¼šå¼€å¯è“ç‰™æœç´¢è“ç‰™è®¾å¤‡é€šè¿‡è°ƒç”¨ bluemanage.requestEnableBt()å¼€å¯è“ç‰™ï¼Œ è°ƒç”¨searchDevices è·å–è“ç‰™è®¾å¤‡ã€‚åœ¨åšè“ç‰™æ“ä½œå‰ï¼Œè¦ç¡®ä¿å„ä¸ªç›‘å¬å™¨å·²ç»è®¾ç½®å¥½ã€‚ æœç´¢ç›‘å¬å¦‚ä¸‹ï¼š onSearchDeviceListener =new OnSearchDeviceListener() { @Override public void onStartDiscovery() { Log.d(TAG, &quot;onStartDiscovery()&quot;); } @Override public void onNewDeviceFound(BluetoothDevice device) { Log.d(TAG, &quot;new device: &quot; + device.getName() + &quot; &quot; + device.getAddress()); } @Override public void onSearchCompleted(List&lt;BluetoothDevice&gt; bondedList, List&lt;BluetoothDevice&gt; newList) { Log.d(TAG, &quot;SearchCompleted: bondedList&quot; + bondedList.toString()); Log.d(TAG, &quot;SearchCompleted: newList&quot; + newList.toString()); } @Override public void onError(Exception e) { e.printStackTrace(); } } é€šè¿‡ BlueManageré‡Œçš„searchDevicesæ–¹æ³•ï¼Œé‡Œè¾¹å…¶å®å°±æ˜¯è·å–äº†ä¸€ä¸ªBluetoothAdapterç„¶åï¼Œé€šè¿‡è°ƒç”¨mBluetoothAda pter.startDiscovery()æ–¹æ³•æ¥æœç´¢ç»å…¸è“ç‰™è®¾å¤‡ã€‚è¿™é‡Œå¦‚æœè°ƒç”¨ mBluetoothAdapter.startLeScan(mLeScanCallback); æœç´¢çš„å°±æ˜¯BLEè“ç‰™ã€‚ç„¶ååœ¨è¿™ä¹‹å‰éœ€è¦åŠ¨æ€æ³¨å†Œä¸€ä¸ªBroadcastReceiveræ¥ç›‘å¬ è“ç‰™çš„æœç´¢æƒ…å†µï¼Œåœ¨é€šè¿‡onReceiveä¸­å»åˆ¤ æ–­è®¾å¤‡çš„ç±»å‹ï¼Œæ˜¯ä¸æ˜¯æ–°è®¾å¤‡ï¼Œæ˜¯ä¸æ˜¯å·²ç»è¿æ¥è¿‡ã€‚å°†è®¾å¤‡åŠ å…¥é›†åˆå½“ä¸­ã€‚ æœç´¢ä»£ç å¦‚ä¸‹ /** * discovery the devices. */ public void searchDevices() { try { if (mCurrStatus == STATUS.FREE) { mCurrStatus = STATUS.DISCOVERING; checkNotNull(mOnSearchDeviceListener); if (mBondedList == null) mBondedList = new ArrayList&lt;&gt;(); if (mNewList == null) mNewList = new ArrayList&lt;&gt;(); if (mBluetoothAdapter == null) { mOnSearchDeviceListener.onError(new NullPointerException(DEVICE_HAS_NOT_BLUETOOTH_MODULE)); return; } if (mReceiver == null) mReceiver = new Receiver(); // ACTION_FOUND IntentFilter filter = new IntentFilter(BluetoothDevice.ACTION_FOUND); mContext.registerReceiver(mReceiver, filter); // ACTION_DISCOVERY_FINISHED filter = new IntentFilter(BluetoothAdapter.ACTION_DISCOVERY_FINISHED); mContext.registerReceiver(mReceiver, filter); mNeed2unRegister = true; mBondedList.clear(); mNewList.clear(); if (mBluetoothAdapter.isDiscovering()) //å…ˆåˆ¤æ–­æ˜¯å¦åœ¨æ‰«æ mBluetoothAdapter.cancelDiscovery();//å–æ¶ˆæ‰«æ mBluetoothAdapter.startDiscovery(); //å¼€å§‹æ‰«æè“ç‰™ mOnSearchDeviceListener.onStartDiscovery(); } } catch (Exception e) { e.printStackTrace(); } } ç¬¬äº”æ­¥ï¼šè¿æ¥è“ç‰™è®¾å¤‡ å½“è°ƒç”¨connectDevice(mac)æ–¹æ³•æ—¶ï¼Œå› ä¸ºè¿æ¥è“ç‰™æ˜¯ä¸€å¾ˆè€—æ—¶çš„æ“ä½œï¼Œæ‰€ä»¥éœ€è¦å¼€å¯ä¸€ä¸ªçº¿ç¨‹å»è¿æ¥è“ç‰™ã€‚ /** * è¿æ¥bluetooth * * @param mac */ public void connectDevice(String mac) { try { if (mCurrStatus != STATUS.CONNECTED) { if (mac == null || TextUtils.isEmpty(mac)) throw new IllegalArgumentException(&quot;mac address is null or empty!&quot;); if (!BluetoothAdapter.checkBluetoothAddress(mac)) throw new IllegalArgumentException(&quot;mac address is not correct! make sure it&apos;s upper case!&quot;); if (mReadable = false) { mReadable = true; } if (mWritable = false) { mWritable = true; } if (onConnectListener != null) { onConnectListener.onConnectStart(); ConnectDeviceRunnable connectDeviceRunnable = new ConnectDeviceRunnable(mac); checkNotNull(mExecutorService); mExecutorService.submit(connectDeviceRunnable); } } else { Log.i(&quot;blue&quot;, &quot;the blue is connected !&quot;); } } catch (IllegalArgumentException e) { e.printStackTrace(); } } åœ¨è¿æ¥çš„çº¿ç¨‹runæ–¹æ³•ä¸­ï¼Œé€šè¿‡è°ƒç”¨mBluetoothAdapter.getRemoteDevice è·å–è¿œç¨‹è“ç‰™ä¿¡æ¯ï¼Œé€šè¿‡ createInsecureRfcommSocketToServiceRecordè·å¾—ä¸€ä¸ªä¸è¿œç¨‹è“ç‰™çš„socketè¿æ¥ã€‚é€šè¿‡è¿™ä¸ªsocketè¿æ¥è·å–è¾“å…¥ æµå’Œè¾“å‡ºæµè¿›è¡Œæ•°æ®çš„è¯»å†™ã€‚ if (onConnectListener == null) { Log.i(&quot;blue&quot;, &quot;the connectListener is null !&quot;); return; } BluetoothDevice remoteDevice = mBluetoothAdapter.getRemoteDevice(mac); mBluetoothAdapter.cancelDiscovery(); mCurrStatus = STATUS.FREE; Log.d(TAG, &quot;prepare to connect: &quot; + remoteDevice.getAddress() + &quot; &quot; + remoteDevice.getName()); mSocket = remoteDevice.createInsecureRfcommSocketToServiceRecord(UUID.fromString(Constants.STR_UUID)); onConnectListener.onConnectting(); mSocket.connect(); mInputStream = mSocket.getInputStream(); mOutputStream = mSocket.getOutputStream(); mCurrStatus = STATUS.CONNECTED; onConnectListener.onConectSuccess(); ç¬¬å…­æ­¥ï¼šå‘è“ç‰™è®¾å¤‡å‘é€æ¶ˆæ¯å½“è®¾å¤‡è¿æ¥æˆåŠŸä¹‹åï¼Œå°±å¯ä»¥ç»™è“ç‰™è®¾å¤‡å‘é€æ¶ˆæ¯äº†ã€‚ é€šè¿‡è°ƒç”¨bluemanage.sendMessage(MessageBean mesaageï¼Œ needResponse)æ–¹æ³•ï¼Œåœ¨bluemangeé‡Œä¼šå¼€èµ·ä¸€ä¸ªWriteRunnableå†™çº¿ç¨‹å’Œä¸€ä¸ªReadRunnableå»è·å–è¾“å…¥æµå’Œè¾“å‡ºæµ çš„å®æ—¶æ•°æ®ï¼Œè¯»çº¿ç¨‹åªä¼šåœ¨ç¬¬ä¸€æ¬¡å‘æ¶ˆæ¯æ—¶åˆå§‹åŒ–ä¸€æ¬¡ã€‚ä»¥åéƒ½æ˜¯ç”¨è¿™ä¸ªçº¿ç¨‹å»è¯»ä»è“ç‰™è¿”å›çš„æ•°æ®ã€‚å†™æ•°æ®çš„çº¿ç¨‹ åœ¨æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šä»æ–°åˆå§‹åŒ–ã€‚(å¾…ä¼˜åŒ–) åœ¨WriteRunnableä¸­çš„æ¶¦å†™æ•°æ® writer.write(item.text); writer.newLine(); writer.flush(); åœ¨WriteRunnable çš„runæ–¹æ³•ä¸­é€šè¿‡mOutputStreamæµå°†æ•°æ®ä¼ é€ç»™è“ç‰™è®¾å¤‡,å½“è“ç‰™æ¥å—åˆ°æ¶ˆæ¯ä¹‹åä¼šå’Œä¸²å£è¿›è¡Œ é€šä¿¡ï¼Œå…·ä½“çš„é€šä¿¡åè®®æ˜¯æ ¹æ®å„ä¸ªå‚å•†è‡ªå·±åå•†çš„ã€‚å½“ä¸²å£æ¥å—æ•°æ®æ‰§è¡Œæ“ä½œï¼Œè·å–æ•°æ®ç„¶ååœ¨è¿”å›æ•°æ®ç»™è“ç‰™ï¼Œè“ ç‰™ä¹Ÿå°±æœ‰è¿”å›æ•°æ®ã€‚ ç¬¬ä¸ƒæ­¥ï¼šä»è“ç‰™è®¾å¤‡è¯»å–æ¶ˆæ¯åœ¨ReadRunnableä¸­ä»mInputStreamé‡Œä¸æ–­çš„è¯»å–æ•°æ®ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æœ‰çš„æ—¶å€™ä»è“ç‰™ å£è¯»å–çš„æ•°æ®å¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªå‘ã€‚é¦–å…ˆä½ éœ€è¦çŸ¥é“ä½ éœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œä»€ä¹ˆæ ¼å¼ï¼Œæ•°æ®çš„é•¿åº¦ã€‚è¿™ é‡Œæˆ‘ä»¬çš„æ•°æ®çš„æ ¼å¼ç±»ä¼¼æ˜¯ä¸€å¸§ä¸€å¸§ï¼Œè€Œä¸”æˆ‘ä»¬çš„å¸§é•¿åº¦å›ºå®šå¤§å°æ˜¯10ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›ä½ æƒ³åšçš„äº‹äº†ã€‚ å‘ æœ‰æ—¶å€™ä»è“ç‰™socket ä¸­è¯»å–çš„æ•°æ®ä¸å®Œæ•´è¯»æ•°æ®ä¸å®Œæ•´ï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬å¼€å¯çº¿ç¨‹ä¹‹åä¼šä¸€ç›´è¯»ï¼Œæœ‰æ—¶å€™è“ç‰™å¹¶æ²¡æœ‰è¿”å›æ•°æ®ï¼Œæˆ–è€…æ²¡æœ‰è¿”å›å®Œæ•´æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ æˆ‘ä»¬éœ€è¦åœ¨è¿™åšä¸€äº›ç‰¹æ®Šå¤„ç†ã€‚ int count = 0; while (count == 0) { count = stream.available();//è¾“å…¥æµä¸­çš„æ•°æ®ä¸ªæ•°ã€‚ } é€šè¿‡ä»¥ä¸Šä»£ç å¯ä»¥ç¡®ä¿è¯»çš„æ•°æ®ä¸ä¼šæ˜¯0ã€‚é€šè¿‡ä¸‹è¾¹çš„ä»£ç å¯ä»¥ç¡®ä¿è¯»åˆ°å®Œæ•´æ•°æ®ä¹‹åæ‰ä¼šèµ°æˆ‘çš„å›è°ƒï¼Œä¿è¯äº†æ•°æ® çš„å®Œæ•´æ€§ã€‚è¿™é‡Œçš„whatåªæ˜¯æˆ‘ç”¨æ¥åŒºåˆ†å½“å‰è¯»åˆ°çš„æ•°æ®æ˜¯è¿›åº¦ä¿¡æ¯ï¼Œè¿˜æ˜¯çœŸæ­£æƒ³è¦çš„ä¿¡æ¯ã€‚ if (onReceiveMessageListener == null) { Log.i(&quot;blue&quot;, &quot;the receiverMessageListener is null !&quot;); return; } mReadable = true; InputStream stream = mInputStream; while (mCurrStatus != STATUS.CONNECTED &amp;&amp; mReadable) ; checkNotNull(stream); byte[] buffer = new byte[DEFAULT_BUFFER_SIZE]; StringBuilder builder = new StringBuilder(); while (mReadable) { int count = 0; while (count == 0) { count = stream.available();//è¾“å…¥æµä¸­çš„æ•°æ®ä¸ªæ•°ã€‚ } if (count == 10 &amp;&amp; what) { int num = stream.read(buffer); String progress = TypeConversion.bytesToHexStrings(buffer); Log.i(&quot;progress&quot;, progress); onReceiveMessageListener.onProgressUpdate(progress, 0); } else if (count &gt;= 10) { what = false; int num = stream.read(buffer); String detect = TypeConversion.bytesToHexStrings(buffer); builder.append(detect); Log.i(&quot;detect&quot;, detect); if (detect.endsWith(&quot;04 &quot;)) { number++; } if (number == 5) { onReceiveMessageListener.onDetectDataFinish(); onReceiveMessageListener.onNewLine(builder.toString().trim()); builder.delete(0, builder.length()); } else { onReceiveMessageListener.onDetectDataUpdate(detect); } } } å½“è¯»åˆ°æ»¡è¶³æ¡ä»¶çš„å®Œæ•´æ•°æ®ï¼Œå°±ä¼šè°ƒç”¨ReceiveMessageListener ä¸­çš„å„ä¸ªæ–¹æ³•ã€‚åˆ°è¿™é‡Œä»è“ç‰™è¯»å–æ•°æ®çš„æµç¨‹ï¼Œ å¤§è‡´ä»‹ç»å®Œã€‚ ä¸‹è¾¹æ˜¯BlueManageræä¾›çš„ä¸€äº›æ–¹æ³•ï¼šrequestEnableBt() å¼€å¯è“ç‰™ searchDevices() æœç´¢è“ç‰™è®¾å¤‡ connectDevice() è¿æ¥è“ç‰™è®¾å¤‡ closeDevice() æ–­å¼€è“ç‰™è¿æ¥ sendMessage() å‘é€æ¶ˆæ¯ close() å…³é—­é”€æ¯è“ç‰™ ç»“å°¾BlueManagerå¤§æ¦‚çš„ä½¿ç”¨æµç¨‹åŠå¤§è‡´åŸç†å°±è¯´åˆ°è¿™é‡Œï¼Œå£æ‰ä¸æ˜¯å¾ˆå¥½ï¼Œå¹³å¸¸ä¹Ÿä¸æ€ä¹ˆå†™åšå®¢ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¤§å®¶å¯ä»¥ æ¢è®¨ä¸€ä¸‹ã€‚é¡¹ç›®ä»£ç éƒ¨åˆ†å‚è€ƒBluetoothHelper é¡¹ç›®ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåšäº†ä¸€äº›åˆ†åŒ…ä¼˜åŒ–ã€‚å¦‚æœ‰é›·åŒï¼Œä¸å±å·§åˆï¼Œ æˆ‘å°±æ˜¯æŠ„çš„ä½ çš„ã€‚å“ˆå“ˆå“ˆå“ˆ~~ å¸Œæœ›å¯¹é‚£äº›åœ¨è¸©è“ç‰™å‘çš„å°ä¼™ä¼´æœ‰å¸®åŠ©~~~ Contact MeQQ: 798774875 Email: moruoyiming123@gmail.com GitHub: https://github.com/moruoyiming","link":"/2019/10/11/Android%E7%BB%8F%E5%85%B8%E8%93%9D%E7%89%99%E9%80%9A%E8%AE%AF%E4%BC%A0%E8%BE%93DEMO/"},{"title":"8 Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹","text":"å¤§å®¶éƒ½çŸ¥é“androidç³»ç»Ÿçš„Zygoteè¿›ç¨‹æ˜¯æ‰€æœ‰çš„androidè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ï¼ŒåŒ…æ‹¬SystemServerå’Œå„ç§åº”ç”¨è¿›ç¨‹éƒ½æ˜¯é€šè¿‡Zygoteè¿›ç¨‹forkå‡ºæ¥çš„ã€‚Zygoteï¼ˆå­µåŒ–ï¼‰è¿›ç¨‹ç›¸å½“äºæ˜¯androidç³»ç»Ÿçš„æ ¹è¿›ç¨‹ï¼Œåé¢æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯é€šè¿‡è¿™ä¸ªè¿›ç¨‹forkå‡ºæ¥çš„ï¼Œè€ŒZygoteè¿›ç¨‹åˆ™æ˜¯é€šè¿‡linuxç³»ç»Ÿçš„initè¿›ç¨‹å¯åŠ¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œandroidç³»ç»Ÿä¸­å„ç§è¿›ç¨‹çš„å¯åŠ¨æ–¹å¼ initè¿›ç¨‹ â€“&gt; Zygoteè¿›ç¨‹ â€“&gt; SystemServerè¿›ç¨‹ â€“&gt;å„ç§åº”ç”¨è¿›ç¨‹ initè¿›ç¨‹ï¼šlinuxçš„æ ¹è¿›ç¨‹ï¼Œandroidç³»ç»Ÿæ˜¯åŸºäºlinuxç³»ç»Ÿçš„ï¼Œå› æ­¤å¯ä»¥ç®—ä½œæ˜¯æ•´ä¸ªandroidæ“ä½œç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼› Zygoteè¿›ç¨‹ï¼šandroidç³»ç»Ÿçš„æ ¹è¿›ç¨‹ï¼Œä¸»è¦ä½œç”¨ï¼šå¯ä»¥ä½œç”¨Zygoteè¿›ç¨‹forkå‡ºSystemServerè¿›ç¨‹å’Œå„ç§åº”ç”¨è¿›ç¨‹ï¼› SystemServiceè¿›ç¨‹ï¼šä¸»è¦æ˜¯åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­å¯åŠ¨ç³»ç»Ÿçš„å„é¡¹æœåŠ¡ï¼Œæ¯”å¦‚ActivityManagerServiceï¼ŒPackageManagerServiceï¼ŒWindowManagerServiceæœåŠ¡ç­‰ç­‰ï¼› å„ç§åº”ç”¨è¿›ç¨‹ï¼šå¯åŠ¨è‡ªå·±ç¼–å†™çš„å®¢æˆ·ç«¯åº”ç”¨æ—¶ï¼Œä¸€èˆ¬éƒ½æ˜¯é‡æ–°å¯åŠ¨ä¸€ä¸ªåº”ç”¨è¿›ç¨‹ï¼Œæœ‰è‡ªå·±çš„è™šæ‹Ÿæœºä¸è¿è¡Œç¯å¢ƒï¼› æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸€ä¸‹Zygoteè¿›ç¨‹çš„å¯åŠ¨æµç¨‹ï¼Œå…³äºSystenServerè¿›ç¨‹å’Œå„ç§åº”ç”¨è¿›ç¨‹çš„å¯åŠ¨æ–¹å¼ä¼šåœ¨ä»¥åçš„æ–‡ç« ä¸­ä»‹ç»ã€‚ initè¿›ç¨‹åœ¨å¯åŠ¨Zygoteè¿›ç¨‹æ—¶ä¸€èˆ¬éƒ½ä¼šè°ƒç”¨ZygoteInitç±»çš„mainæ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬è¿™é‡Œçœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å…·ä½“å®ç°(åŸºäºandroid23æºç )ï¼› 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758public static void main(String argv[]) { try { RuntimeInit.enableDdms(); // Start profiling the zygote initialization. SamplingProfilerIntegration.start(); boolean startSystemServer = false; String socketName = &quot;zygote&quot;; String abiList = null; for (int i = 1; i &lt; argv.length; i++) { if (&quot;start-system-server&quot;.equals(argv[i])) { startSystemServer = true; } else if (argv[i].startsWith(ABI_LIST_ARG)) { abiList = argv[i].substring(ABI_LIST_ARG.length()); } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { socketName = argv[i].substring(SOCKET_NAME_ARG.length()); } else { throw new RuntimeException(&quot;Unknown command line argument: &quot; + argv[i]); } } if (abiList == null) { throw new RuntimeException(&quot;No ABI list supplied.&quot;); } registerZygoteSocket(socketName); EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START, SystemClock.uptimeMillis()); preload(); EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END, SystemClock.uptimeMillis()); // Finish profiling the zygote initialization. SamplingProfilerIntegration.writeZygoteSnapshot(); // Do an initial gc to clean up after startup gcAndFinalize(); // Disable tracing so that forked processes do not inherit stale tracing tags from // Zygote. Trace.setTracingEnabled(false); if (startSystemServer) { startSystemServer(abiList, socketName); } Log.i(TAG, &quot;Accepting command socket connections&quot;); runSelectLoop(abiList); closeServerSocket(); } catch (MethodAndArgsCaller caller) { caller.run(); } catch (RuntimeException ex) { Log.e(TAG, &quot;Zygote died with exception&quot;, ex); closeServerSocket(); throw ex; } } ç¬¬ä¸€è¡Œä¸»è¦æ˜¯è°ƒç”¨enableDdms()ï¼Œè®¾ç½®DDMSå¯ç”¨ï¼Œå¯ä»¥å‘ç°DDMSå¯åŠ¨çš„æ—¶æœºè¿˜æ˜¯æ¯”è¾ƒæ—©çš„ï¼Œåœ¨æ•´ä¸ªZygoteè¿›ç¨‹åˆšåˆšå¼€å§‹è¦å¯åŠ¨é¢æ—¶å€™å°±è®¾ç½®å¯ç”¨äº†ã€‚ ä¸‹é¢çš„å¾ªç¯ä¸»è¦æ˜¯è§£æmainæ–¹æ³•çš„å‚æ•°è·å–æ˜¯å¦éœ€è¦å¯åŠ¨SystemServiceè¿›ç¨‹ï¼Œè·å–abiåˆ—è¡¨ï¼Œè·å–scoketè¿æ¥åç§°ï¼ˆè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šandroidç³»ç»Ÿä¸­è¿›ç¨‹ä¹‹é—´é€šè®¯çš„æ–¹å¼æ˜¯Binderï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªä¾‹å¤–æ˜¯SystemServiceè¿›ç¨‹ä¸Zygoteè¿›ç¨‹ä¹‹é—´æ˜¯é€šè¿‡Socketçš„æ–¹å¼è¿›è¡Œé€šè®¯çš„ï¼‰ ç„¶åè°ƒç”¨registerZygoteSocketï¼ˆString socketNameï¼‰ä¸ºZygoteè¿›ç¨‹æ³¨å†Œsocketï¼š 123456789101112131415161718192021private static void registerZygoteSocket(String socketName) { if (sServerSocket == null) { int fileDesc; final String fullSocketName = ANDROID_SOCKET_PREFIX + socketName; try { String env = System.getenv(fullSocketName); fileDesc = Integer.parseInt(env); } catch (RuntimeException ex) { throw new RuntimeException(fullSocketName + &quot; unset or invalid&quot;, ex); } try { FileDescriptor fd = new FileDescriptor(); fd.setInt$(fileDesc); sServerSocket = new LocalServerSocket(fd); } catch (IOException ex) { throw new RuntimeException( &quot;Error binding to local socket '&quot; + fileDesc + &quot;'&quot;, ex); } } } æ¥ç€è°ƒç”¨ç³»ç»Ÿæ–¹æ³•preLoad() 123456789101112static void preload() { Log.d(TAG, &quot;begin preload&quot;); preloadClasses(); preloadResources(); preloadOpenGL(); preloadSharedLibraries(); preloadTextResources(); // Ask the WebViewFactory to do any initialization that must run in the zygote process, // for memory sharing purposes. WebViewFactory.prepareWebViewInZygote(); Log.d(TAG, &quot;end preload&quot;); } è¿™å…¶ä¸­ï¼špreloadClasses()ç”¨äºåˆå§‹åŒ–Zygoteä¸­éœ€è¦çš„classç±»ï¼›preloadResources()ç”¨äºåˆå§‹åŒ–ç³»ç»Ÿèµ„æºï¼›preloadOpenGL()ç”¨äºåˆå§‹åŒ–OpenGLï¼›preloadSharedLibraries()ç”¨äºåˆå§‹åŒ–ç³»ç»Ÿlibrariesï¼›preloadTextResources()ç”¨äºåˆå§‹åŒ–æ–‡å­—èµ„æºï¼›prepareWebViewInZygote()ç”¨äºåˆå§‹åŒ–webview; ç„¶åè°ƒç”¨startSystemServer(abiList, socket); 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657private static boolean startSystemServer(String abiList, String socketName) throws MethodAndArgsCaller, RuntimeException { long capabilities = posixCapabilitiesAsBits( OsConstants.CAP_BLOCK_SUSPEND, OsConstants.CAP_KILL, OsConstants.CAP_NET_ADMIN, OsConstants.CAP_NET_BIND_SERVICE, OsConstants.CAP_NET_BROADCAST, OsConstants.CAP_NET_RAW, OsConstants.CAP_SYS_MODULE, OsConstants.CAP_SYS_NICE, OsConstants.CAP_SYS_RESOURCE, OsConstants.CAP_SYS_TIME, OsConstants.CAP_SYS_TTY_CONFIG ); /* Hardcoded command line to start the system server */ String args[] = { &quot;--setuid=1000&quot;, &quot;--setgid=1000&quot;, &quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007&quot;, &quot;--capabilities=&quot; + capabilities + &quot;,&quot; + capabilities, &quot;--nice-name=system_server&quot;, &quot;--runtime-args&quot;, &quot;com.android.server.SystemServer&quot;, }; ZygoteConnection.Arguments parsedArgs = null; int pid; try { parsedArgs = new ZygoteConnection.Arguments(args); ZygoteConnection.applyDebuggerSystemProperty(parsedArgs); ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs); /* Request to fork the system server process */ pid = Zygote.forkSystemServer( parsedArgs.uid, parsedArgs.gid, parsedArgs.gids, parsedArgs.debugFlags, null, parsedArgs.permittedCapabilities, parsedArgs.effectiveCapabilities); } catch (IllegalArgumentException ex) { throw new RuntimeException(ex); } /* For child process */ if (pid == 0) { if (hasSecondZygote(abiList)) { waitForSecondaryZygote(socketName); } handleSystemServerProcess(parsedArgs); } return true; } å¯ä»¥çœ‹åˆ°è¿™æ®µé€»è¾‘çš„æ‰§è¡Œé€»è¾‘å°±æ˜¯é€šè¿‡Zygote forkå‡ºSystemServerè¿›ç¨‹ã€‚ æ€»ç»“ï¼šZygoteè¿›ç¨‹mianæ–¹æ³•ä¸»è¦æ‰§è¡Œé€»è¾‘ï¼š åˆå§‹åŒ–DDMSï¼› æ³¨å†ŒZygoteè¿›ç¨‹çš„socketé€šè®¯ï¼› åˆå§‹åŒ–Zygoteä¸­çš„å„ç§ç±»ï¼Œèµ„æºæ–‡ä»¶ï¼ŒOpenGLï¼Œç±»åº“ï¼ŒTextèµ„æºç­‰ç­‰ï¼› åˆå§‹åŒ–å®Œæˆä¹‹åforkå‡ºSystemServerè¿›ç¨‹ï¼› forkå‡ºSystemServerè¿›ç¨‹ä¹‹åï¼Œå…³é—­socketè¿æ¥ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCache","link":"/2020/09/11/Zygote%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"title":"androidä¹‹IntentService","text":"ä»€ä¹ˆæ˜¯IntentServiceï¼Ÿç®€å•æ¥è¯´IntentServiceå°±æ˜¯ä¸€ä¸ªå«æœ‰è‡ªèº«æ¶ˆæ¯å¾ªç¯çš„Serviceï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªserviceï¼Œæ‰€ä»¥serviceç›¸å…³å…·æœ‰çš„ç‰¹æ€§ä»–éƒ½æœ‰ï¼ŒåŒæ—¶ä»–è¿˜æœ‰ä¸€äº›è‡ªèº«çš„å±æ€§ï¼Œå…¶å†…éƒ¨å°è£…äº†ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å’Œä¸€ä¸ªHandlerThreadï¼Œåœ¨å…¶å…·ä½“çš„æŠ½è±¡æ–¹æ³•ï¼šonHandleIntentæ–¹æ³•æ˜¯è¿è¡Œåœ¨å…¶æ¶ˆæ¯é˜Ÿåˆ—çº¿ç¨‹ä¸­ï¼ŒåºŸè¯ä¸å¤šè¯´ï¼Œæˆ‘ä»¬æ¥çœ‹å…¶ç®€å•çš„ä½¿ç”¨æ–¹æ³•ï¼š å®šä¹‰ä¸€ä¸ªIntentService 123456789101112public class MIntentService extends IntentService{ public MIntentService() { super(&quot;&quot;); } @Override protected void onHandleIntent(Intent intent) { Log.i(&quot;tag&quot;, intent.getStringExtra(&quot;params&quot;) + &quot; &quot; + Thread.currentThread().getId()); }} åœ¨androidManifest.xmlä¸­å®šä¹‰service 123&lt;service android:name=&quot;.MIntentService&quot; /&gt; å¯åŠ¨è¿™ä¸ªservice 12345678title.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { Intent intent = new Intent(MainActivity.this, MIntentService.class); intent.putExtra(&quot;params&quot;, &quot;ceshi&quot;); startService(intent); } }); å¯ä»¥å‘ç°å½“ç‚¹å‡»titleç»„ä»¶çš„æ—¶å€™ï¼Œserviceæ¥æ”¶åˆ°äº†æ¶ˆæ¯å¹¶æ‰“å°å‡ºäº†ä¼ é€’è¿‡å»çš„intentå‚æ•°ï¼ŒåŒæ—¶æ˜¾ç¤ºonHandlerIntentæ–¹æ³•æ‰§è¡Œçš„çº¿ç¨‹IDå¹¶éä¸»çº¿ç¨‹ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹serviceçš„æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112public abstract class IntentService extends Service { private volatile Looper mServiceLooper; private volatile ServiceHandler mServiceHandler; private String mName; private boolean mRedelivery; private final class ServiceHandler extends Handler { public ServiceHandler(Looper looper) { super(looper); } @Override public void handleMessage(Message msg) { onHandleIntent((Intent)msg.obj); stopSelf(msg.arg1); } } /** * Creates an IntentService. Invoked by your subclass's constructor. * * @param name Used to name the worker thread, important only for debugging. */ public IntentService(String name) { super(); mName = name; } /** * Sets intent redelivery preferences. Usually called from the constructor * with your preferred semantics. * * &lt;p&gt;If enabled is true, * {@link #onStartCommand(Intent, int, int)} will return * {@link Service#START_REDELIVER_INTENT}, so if this process dies before * {@link #onHandleIntent(Intent)} returns, the process will be restarted * and the intent redelivered. If multiple Intents have been sent, only * the most recent one is guaranteed to be redelivered. * * &lt;p&gt;If enabled is false (the default), * {@link #onStartCommand(Intent, int, int)} will return * {@link Service#START_NOT_STICKY}, and if the process dies, the Intent * dies along with it. */ public void setIntentRedelivery(boolean enabled) { mRedelivery = enabled; } @Override public void onCreate() { // TODO: It would be nice to have an option to hold a partial wakelock // during processing, and to have a static startService(Context, Intent) // method that would launch the service &amp; hand off a wakelock. super.onCreate(); HandlerThread thread = new HandlerThread(&quot;IntentService[&quot; + mName + &quot;]&quot;); thread.start(); mServiceLooper = thread.getLooper(); mServiceHandler = new ServiceHandler(mServiceLooper); } @Override public void onStart(Intent intent, int startId) { Message msg = mServiceHandler.obtainMessage(); msg.arg1 = startId; msg.obj = intent; mServiceHandler.sendMessage(msg); } /** * You should not override this method for your IntentService. Instead, * override {@link #onHandleIntent}, which the system calls when the IntentService * receives a start request. * @see android.app.Service#onStartCommand */ @Override public int onStartCommand(Intent intent, int flags, int startId) { onStart(intent, startId); return mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY; } @Override public void onDestroy() { mServiceLooper.quit(); } /** * Unless you provide binding for your service, you don't need to implement this * method, because the default implementation returns null. * @see android.app.Service#onBind */ @Override public IBinder onBind(Intent intent) { return null; } /** * This method is invoked on the worker thread with a request to process. * Only one Intent is processed at a time, but the processing happens on a * worker thread that runs independently from other application logic. * So, if this code takes a long time, it will hold up other requests to * the same IntentService, but it will not hold up anything else. * When all requests have been handled, the IntentService stops itself, * so you should not call {@link #stopSelf}. * * @param intent The value passed to {@link * android.content.Context#startService(Intent)}. */ @WorkerThread protected abstract void onHandleIntent(Intent intent);} æ€ä¹ˆæ ·ï¼Œä»£ç è¿˜æ˜¯ç›¸å½“çš„ç®€æ´çš„ï¼Œé¦–å…ˆé€šè¿‡å®šä¹‰æˆ‘ä»¬å¯ä»¥çŸ¥é“IntentServiceæ˜¯ä¸€ä¸ªServiceï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç»§æ‰¿IntentServiceçš„æ—¶å€™éœ€è¦å®ç°å…¶æŠ½è±¡æ–¹æ³•ï¼šonHandlerIntentã€‚ ä¸‹é¢çœ‹ä¸€ä¸‹å…¶onCreateæ–¹æ³•ï¼š 12345678910111213@Override public void onCreate() { // TODO: It would be nice to have an option to hold a partial wakelock // during processing, and to have a static startService(Context, Intent) // method that would launch the service &amp; hand off a wakelock. super.onCreate(); HandlerThread thread = new HandlerThread(&quot;IntentService[&quot; + mName + &quot;]&quot;); thread.start(); mServiceLooper = thread.getLooper(); mServiceHandler = new ServiceHandler(mServiceLooper); } æˆ‘ä»¬å¯ä»¥å‘ç°å…¶å†…éƒ¨å®šä¹‰ä¸€ä¸ªHandlerIThreadï¼ˆæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå«æœ‰æ¶ˆæ¯é˜Ÿåˆ—çš„çº¿ç¨‹ï¼‰å…·ä½“å¯å‚è€ƒï¼šandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadç„¶åç”¨æˆå‘˜å˜é‡ç»´æŠ¤å…¶Looperå’ŒHandlerï¼Œç”±äºå…¶Handlerå…³è”ç€è¿™ä¸ªHandlerThreadçš„Looperå¯¹è±¡ï¼Œæ‰€ä»¥Handlerçš„handMessageæ–¹æ³•åœ¨HandlerThreadçº¿ç¨‹ä¸­æ‰§è¡Œã€‚ ç„¶åæˆ‘ä»¬å‘ç°å…¶onStartCommandæ–¹æ³•å°±æ˜¯è°ƒç”¨çš„å…¶onStartæ–¹æ³•ï¼Œå…·ä½“çœ‹ä¸€ä¸‹å…¶onStartæ–¹æ³•ï¼š 1234567@Override public void onStart(Intent intent, int startId) { Message msg = mServiceHandler.obtainMessage(); msg.arg1 = startId; msg.obj = intent; mServiceHandler.sendMessage(msg); } å¾ˆç®€å•å°±æ˜¯å°±æ˜¯è®²startIdå’Œå¯åŠ¨æ—¶æ¥å—åˆ°çš„intentå¯¹è±¡ä¼ é€’åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­å¤„ç†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹å…¶æ¶ˆæ¯é˜Ÿåˆ—çš„å¤„ç†é€»è¾‘ï¼š 1234567891011private final class ServiceHandler extends Handler { public ServiceHandler(Looper looper) { super(looper); } @Override public void handleMessage(Message msg) { onHandleIntent((Intent)msg.obj); stopSelf(msg.arg1); } } å¯ä»¥çœ‹åˆ°èµ·handleMessageæ–¹æ³•å†…éƒ¨æ‰§è¡Œäº†ä¸¤ä¸ªé€»è¾‘ä¸€ä¸ªæ˜¯è°ƒç”¨äº†å…¶onHandlerIntentæŠ½è±¡æ–¹æ³•ï¼Œé€šè¿‡åˆ†æå…¶onCreateæ–¹æ³•handlerå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹æˆ‘ä»¬çŸ¥é“å…¶handlerå¯¹è±¡æ˜¯ä¾é™„äºHandlerThreadçº¿ç¨‹çš„ï¼Œæ‰€ä»¥å…¶handeMessageæ–¹æ³•ä¹Ÿæ˜¯åœ¨HandlerThreadçº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œä»è€Œè¯å®äº†æˆ‘ä»¬åˆšåˆšä¾‹å­ä¸­çš„ä¸€ä¸ªç»“è®ºï¼ŒonHandlerIntentåœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œã€‚ç„¶åè°ƒç”¨äº†stopSelfæ–¹æ³•ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯stopSelfæ–¹æ³•ä¼ é€’äº†msg.arg1å‚æ•°ï¼Œä»åˆšåˆšçš„onStartæ–¹æ³•æˆ‘ä»¬å¯ä»¥çŸ¥é“æˆ‘ä»¬ä¼ é€’äº†startIdï¼Œå‚è€ƒå…¶ä»–æ–‡ç« æˆ‘ä»¬çŸ¥é“ï¼Œç”±äºserviceå¯ä»¥å¯åŠ¨Næ¬¡ï¼Œå¯ä»¥ä¼ é€’Næ¬¡æ¶ˆæ¯ï¼Œå½“IntentServiceçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­å«æœ‰æ¶ˆæ¯æ—¶è°ƒç”¨stopSelf(startId)å¹¶ä¸ä¼šç«‹å³stopè‡ªå·±ï¼Œåªæœ‰å½“æ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯è¢«æ‰§è¡Œå®Œæˆæ—¶æ‰ä¼šçœŸæ­£çš„stopè‡ªèº«ã€‚ é€šè¿‡ä¸Šé¢çš„ä¾‹å­ä¸ç›¸å…³è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼š IntentServiceæ˜¯ä¸€ä¸ªserviceï¼Œä¹Ÿæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼› ç»§æ‰¿IntentServiceéœ€è¦å®ç°å…¶onHandlerIntentæŠ½è±¡æ–¹æ³•ï¼› onHandlerIntentåœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼› IntentServiceå†…éƒ¨ä¿å­˜ç€ä¸€ä¸ªHandlerThreadã€Looperä¸Handlerç­‰æˆå‘˜å˜é‡ï¼Œç»´æŠ¤è¿™è‡ªèº«çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼› æ¯æ¬¡IntentServiceåå°ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åéƒ½ä¼šå°è¯•å…³é—­è‡ªèº«ï¼Œä½†æ˜¯å½“ä¸”ä»…å½“IntentServiceæ¶ˆæ¯é˜Ÿåˆ—ä¸­æœ€åä¸€ä¸ªæ¶ˆæ¯è¢«æ‰§è¡Œå®Œæˆä¹‹åæ‰ä¼šçœŸæ­£çš„stopè‡ªèº«ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThread","link":"/2020/09/11/android%E4%B9%8BIntentService/"},{"title":"6 androidä¹‹Logæ—¥å¿—","text":"é¦–å…ˆè¯´ç‚¹é¢˜å¤–è¯ï¼Œå¯¹äºæƒ³å­¦android frameworkæºç çš„åŒå­¦ï¼Œå…¶å®å¯ä»¥åœ¨githubä¸­forkä¸€ä»½ï¼Œå…·ä½“åœ°å€ï¼šplatform_frameworks_baseè¿™é‡Œé¢åŸºæœ¬éƒ½æ˜¯android frameworkå±‚çš„æºç äº†ã€‚è€Œä¸”æœ€è¿‘å‘ç°äº†ä¸€ä¸ªæ¯”è¾ƒä¸é”™çš„githubæ’ä»¶ï¼šOctoTreeï¼Œå®ƒ æ˜¯ä¸€ä¸ªæµè§ˆå™¨æ’ä»¶ï¼Œå®ƒå¯ä»¥è®©ä½ åœ¨Github çœ‹ä»£ç æ—¶ï¼Œå·¦è¾¹æ ä¼šå‡ºç°ä¸€ä¸ªæ ‘çŠ¶ç»“æ„ï¼Œå°±åƒæˆ‘ä»¬åœ¨IDE ä¸€æ ·ã€‚å½“æˆ‘ä»¬çœ‹ä¸€ä¸ªé¡¹ç›®çš„ç»“æ„ï¼Œæˆ–è€…æƒ³çœ‹å…·ä½“çš„æŸä¸ªæ–‡ä»¶ï¼Œè¿™æ ·å°±ä¼šå¾ˆæ–¹ä¾¿ã€‚ æ€ä¹ˆæ ·è¿™æ ·æŸ¥çœ‹æºä»£ç çš„è¯æ˜¯ä¸æ˜¯å¾ˆæ–¹é¢ï¼Ÿ å¥½äº†è¯´ä¸€ä¸‹æˆ‘ä»¬ä»Šå¤©éœ€è¦ä»‹ç»çš„Logå¯¹è±¡ï¼Œå®ƒä½äºandroid frameworkå±‚utilsåŒ…ä¸‹ï¼Œæ˜¯ä¸€ä¸ªfinal classç±»ï¼šæŸ¥çœ‹å…¶å…·ä½“å®šä¹‰ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200public final class Log { /** * Priority constant for the println method; use Log.v. */ public static final int VERBOSE = 2; /** * Priority constant for the println method; use Log.d. */ public static final int DEBUG = 3; /** * Priority constant for the println method; use Log.i. */ public static final int INFO = 4; /** * Priority constant for the println method; use Log.w. */ public static final int WARN = 5; /** * Priority constant for the println method; use Log.e. */ public static final int ERROR = 6; /** * Priority constant for the println method. */ public static final int ASSERT = 7; private Log() { } /** * Send a {@link #VERBOSE} log message. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. */ public static int v(String tag, String msg) { return println(LOG_ID_MAIN, VERBOSE, tag, msg); } /** * Send a {@link #VERBOSE} log message and log the exception. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. * @param tr An exception to log */ public static int v(String tag, String msg, Throwable tr) { return println(LOG_ID_MAIN, VERBOSE, tag, msg + '\\n' + getStackTraceString(tr)); } /** * Send a {@link #DEBUG} log message. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. */ public static int d(String tag, String msg) { return println(LOG_ID_MAIN, DEBUG, tag, msg); } /** * Send a {@link #DEBUG} log message and log the exception. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. * @param tr An exception to log */ public static int d(String tag, String msg, Throwable tr) { return println(LOG_ID_MAIN, DEBUG, tag, msg + '\\n' + getStackTraceString(tr)); } /** * Send an {@link #INFO} log message. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. */ public static int i(String tag, String msg) { return println(LOG_ID_MAIN, INFO, tag, msg); } /** * Send a {@link #INFO} log message and log the exception. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. * @param tr An exception to log */ public static int i(String tag, String msg, Throwable tr) { return println(LOG_ID_MAIN, INFO, tag, msg + '\\n' + getStackTraceString(tr)); } /** * Send a {@link #WARN} log message. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. */ public static int w(String tag, String msg) { return println(LOG_ID_MAIN, WARN, tag, msg); } /** * Send a {@link #WARN} log message and log the exception. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. * @param tr An exception to log */ public static int w(String tag, String msg, Throwable tr) { return println(LOG_ID_MAIN, WARN, tag, msg + '\\n' + getStackTraceString(tr)); } /* * Send a {@link #WARN} log message and log the exception. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param tr An exception to log */ public static int w(String tag, Throwable tr) { return println(LOG_ID_MAIN, WARN, tag, getStackTraceString(tr)); } /** * Send an {@link #ERROR} log message. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. */ public static int e(String tag, String msg) { return println(LOG_ID_MAIN, ERROR, tag, msg); } /** * Send a {@link #ERROR} log message and log the exception. * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. * @param tr An exception to log */ public static int e(String tag, String msg, Throwable tr) { return println(LOG_ID_MAIN, ERROR, tag, msg + '\\n' + getStackTraceString(tr)); } /** * Handy function to get a loggable stack trace from a Throwable * @param tr An exception to log */ public static String getStackTraceString(Throwable tr) { if (tr == null) { return &quot;&quot;; } // This is to reduce the amount of log spew that apps do in the non-error // condition of the network being unavailable. Throwable t = tr; while (t != null) { if (t instanceof UnknownHostException) { return &quot;&quot;; } t = t.getCause(); } StringWriter sw = new StringWriter(); PrintWriter pw = new PrintWriter(sw); tr.printStackTrace(pw); pw.flush(); return sw.toString(); } /** * Low-level logging call. * @param priority The priority/type of this log message * @param tag Used to identify the source of a log message. It usually identifies * the class or activity where the log call occurs. * @param msg The message you would like logged. * @return The number of bytes written. */ public static int println(int priority, String tag, String msg) { return println(LOG_ID_MAIN, priority, tag, msg); } /** @hide */ public static final int LOG_ID_MAIN = 0; /** @hide */ public static final int LOG_ID_RADIO = 1; /** @hide */ public static final int LOG_ID_EVENTS = 2; /** @hide */ public static final int LOG_ID_SYSTEM = 3; /** @hide */ public static final int LOG_ID_CRASH = 4; /** @hide */ @SuppressWarnings(&quot;unused&quot;) public static int println(int bufID, int priority, String tag, String msg) { return 0; }}å¯ä»¥çœ‹åˆ°å…¶å®final ç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸èƒ½é€šè¿‡ç»§æ‰¿Logç±»çš„æ–¹å¼å®ç°è‡ªèº«çš„æ—¥å¿—å·¥å…·ç±»ï¼Œä¸€èˆ¬çš„æˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¹‰Logæˆå‘˜å˜é‡çš„æ–¹å¼ï¼Œå°è£…Logå·¥å…·æ–¹æ³•ï¼› åœ¨Logç±»ä¸­æˆ‘ä»¬å®šä¹‰äº†å…­ç§æ—¥å¿—çº§åˆ«ï¼Œåˆ†åˆ«æ˜¯ï¼šVERBOSEã€DEBUGã€INFOã€WARNã€ERRORã€ASSERTç­‰å…­ç§çº§åˆ«ï¼Œä½†æ˜¯æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„åªæœ‰å‰äº”ç§ï¼Œå³VERBOSE,DEBUG,INFO,WARN,ERRORã€‚ é€šè¿‡æŸ¥çœ‹æºä»£ç æˆ‘ä»¬å‘ç°Logç±»ä¸­æ‰€æœ‰çš„é™æ€æ—¥å¿—æ–¹æ³•Log.v()ï¼ŒLog.d()ï¼ŒLog.i()ï¼ŒLog.w()ï¼ŒLog.e()ç­‰æ–¹æ³•éƒ½æ˜¯åº•å±‚éƒ½æ˜¯è°ƒç”¨äº†printlnæ–¹æ³•ï¼Œç„¶ååœ¨githubçš„æºç ä¸­æŸ¥çœ‹ï¼Œå…¶å®å…¶å†…éƒ¨è°ƒç”¨çš„æ˜¯println_nativeæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡JNIè°ƒç”¨åº•å±‚çš„c++è¾“å‡ºæ—¥å¿—ï¼› æˆ‘ä»¬æš‚æ—¶åªæ˜¯åˆ†æåˆ°è¿™é‡Œï¼Œè‡³äºåº•å±‚çš„c++æ—¥å¿—è¾“å‡ºçš„å…·ä½“å®ç°ä¸ä½œåˆ†æï¼Œæ€»ç»“ä¸€ä¸‹ï¼š Log.javaæ˜¯ä¸€ä¸ªfinalç±»ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¯ä»¥ç»§æ‰¿Logç±»æ¥å®ç°è‡ªå·±çš„æ—¥å¿—æ¡†æ¶ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡å…³è”ï¼ˆä¿å­˜Logæˆå‘˜å˜é‡ï¼‰çš„æ–¹å¼å®ç°è‡ªå·±çš„Logå·¥å…·ç±»ï¼› Log.javaä¸­å®šä¹‰äº†å…­ç§æ—¥å¿—çº§åˆ«ï¼Œä½†æ˜¯æˆ‘ä»¬é€šå¸¸åªæ˜¯ä½¿ç”¨å…¶ä¸­çš„äº”ç§æ—¥å¿—çº§åˆ«ï¼Œåˆ†åˆ«å¯¹åº”ç€VERBOSEã€DEBUGã€INFOã€WARNã€ERRORï¼Œåœ¨å…·ä½“çš„ä½¿ç”¨åœºæ™¯ä¸‹å…·ä½“åˆ†æï¼› æœ‰äº›åŒå­¦å¯¹androidè‡ªå¸¦çš„æ—¥å¿—æ¡†æ¶ä¸å¤ªæ»¡æ„ï¼Œä¸»è¦æ˜¯æ— æ³•å®šä½æ—¥å¿—ä½ç½®ï¼Œè¿™é‡Œå¯ä»¥æŸ¥çœ‹æˆ‘å†™çš„ä¸€ç¯‡å®ç°è‡ªå®šä¹‰æ—¥å¿—æ¡†æ¶çš„æ–‡ç« ï¼šgithubé¡¹ç›®è§£æï¼ˆäº”ï¼‰â€“&gt;androidæ—¥å¿—æ¡†æ¶ æ—¥å¿—å¯ä»¥ä¸ªæ€§åŒ–çš„å±•ç¤ºç›¸å…³ä¿¡æ¯ï¼š å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentService","link":"/2020/09/11/android%E4%B9%8BLog%E6%97%A5%E5%BF%97/"},{"title":"24 onSaveInstanceStateæ‰§è¡Œæ—¶æœº","text":"æˆ‘ä»¬å·²ç»åˆ†æè¿‡Activityçš„å¯åŠ¨æµç¨‹ï¼Œä»ä¸­ä¹Ÿåˆ†æäº†Activityçš„ç”Ÿå‘½å‘¨æœŸã€‚è€Œå…¶ä¸­æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•:onSaveInstanceStateæ–¹æ³•ï¼Œä»Šå¤©æˆ‘ä»¬ä¸»è¦è®²è§£ä¸€ä¸‹onSaveInstanceStateæ–¹æ³•çš„æ‰§è¡Œæ—¶æœºã€‚å¯èƒ½éƒ¨åˆ†åŒå­¦å¯¹Activityçš„onSaveInstanceStateæ–¹æ³•ä¸æ˜¯ç‰¹åˆ«ç†Ÿæ‚‰ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ã€‚onSaveInstanceStateæ–¹æ³•æ˜¯Activityçš„æˆå‘˜æ–¹æ³•ï¼Œä¸»è¦ç”¨äºåœ¨Activityé”€æ¯æ—¶ä¿å­˜Activityç›¸å…³çš„å¯¹è±¡ä¿¡æ¯ï¼Œè€Œå…¶æ‰§è¡Œçš„æ—¶æœºä¸æ˜¯æˆ‘ä»¬ä¸»åŠ¨è°ƒç”¨çš„ï¼Œè€Œæ˜¯Androidç³»ç»Ÿçš„frameworkå¸®å¿™è°ƒç”¨çš„ï¼Œè€Œå…¶è°ƒç”¨çš„æ—¶æœºï¼Œå¯ä»¥å‚è€ƒandroidç³»ç»Ÿçš„ä»‹ç»ï¼š This method is called before an activity may be killed so that when it comes back some time in the future it can restore its state. For example, if activity B is launched in front of activity A, and at some point activity A is killed to reclaim resources, activity A will have a chance to save the current state of its user interface via this method so that when the user returns to activity A, the state of the user interface can be restored via {@link #onCreate} or {@link #onRestoreInstanceState}. å¯ä»¥å‘ç°onSaveInstanceStateæ–¹æ³•ä¼šåœ¨Activityå°†è¦è¢«killçš„æ—¶å€™æ‰§è¡Œã€‚O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œå¯èƒ½è·Ÿä»¥å‰è®²è§£çš„å†…å®¹ä¸æ˜¯å¤ªå¯¹ï¼Œæˆ‘ä»¬çœ‹è¿‡ä¸å°‘æ–‡ç« éƒ½æ˜¯è¯´onSaveInstanceStatexæ–¹æ³•ä¼šåœ¨Activityå®¹æ˜“è¢«é”€æ¯çš„æ—¶å€™æ‰§è¡Œã€‚é‚£ä¹ˆè¿™é‡Œæ˜æ˜è¯´çš„æ˜¯å½“Activityè¢«é”€æ¯çš„æ—¶å€™å°±ä¼šæ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ï¼Œé‚£ä¹ˆå…·ä½“çš„æƒ…å†µæ˜¯å¦‚ä½•çš„å‘¢?æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹æºç å§ï¼Œå“ˆå“ˆã€‚ é€šè¿‡åˆ†æActivityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“onSaveInstanceStateæ–¹æ³•åœ¨onPauseæ–¹æ³•ä¹‹åæ‰§è¡Œåœ¨onStopæ–¹æ³•ä¹‹å‰æ‰§è¡Œã€‚è¿™é‡Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹onPauseæ–¹æ³•çš„æºç é€»è¾‘ã€‚ Activityåœ¨æ‰§è¡ŒonPauseæ–¹æ³•çš„æ—¶å€™å›å›è°ƒActivityThreadçš„handlePauseActivityæ–¹æ³•ï¼Œä¸å¤ªç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥å‚è€ƒ: androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹ï¼Œæ–‡ç« ä¸­æœ‰å¯¹Activityç”Ÿå‘½å‘¨æœŸçš„è¯¦ç»†è®²è§£ã€‚ å¥½å§ï¼Œå…ˆå…·ä½“çœ‹ä¸€ä¸‹ActivityThread.handlePauseActivityçš„æºç ï¼š 123456789101112131415161718192021222324252627private void handlePauseActivity(IBinder token, boolean finished, boolean userLeaving, int configChanges, boolean dontReport) { ActivityClientRecord r = mActivities.get(token); if (r != null) { //Slog.v(TAG, &quot;userLeaving=&quot; + userLeaving + &quot; handling pause of &quot; + r); if (userLeaving) { performUserLeavingActivity(r); } r.activity.mConfigChangeFlags |= configChanges; performPauseActivity(token, finished, r.isPreHoneycomb()); // Make sure any pending writes are now committed. if (r.isPreHoneycomb()) { QueuedWork.waitToFinish(); } // Tell the activity manager we have paused. if (!dontReport) { try { ActivityManagerNative.getDefault().activityPaused(token); } catch (RemoteException ex) { } } mSomeActivitiesChanged = true; } } åœ¨æ–¹æ³•ä½“ä¸­æˆ‘ä»¬é™¤äº†æ‰§è¡Œä¸€äº›å…¶ä»–çš„æ“ä½œï¼Œç„¶ååœ¨handlePauseActivityæ–¹æ³•ä½“ä¸­è°ƒç”¨äº†performPauseActivityæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å…·ä½“æ‰§è¡Œå›è°ƒpauseActivityæ“ä½œçš„æ–¹æ³•ï¼Œæ—¢ç„¶è¿™æ ·æˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹performPauseActivityæ–¹æ³•çš„å®ç°ï¼š 12345final Bundle performPauseActivity(IBinder token, boolean finished, boolean saveState) { ActivityClientRecord r = mActivities.get(token); return r != null ? performPauseActivity(r, finished, saveState) : null; }å¯ä»¥å‘ç°åœ¨performPauseActivityæ–¹æ³•ä¸­é¦–å…ˆåˆ¤æ–­ActivityClientRecordæ˜¯å¦ä¸ºç©ºï¼Œç„¶ååˆè°ƒç”¨äº†performPauseActivityæ–¹æ³•çš„é‡è½½æ–¹æ³•ï¼š 12345678final Bundle performPauseActivity(ActivityClientRecord r, boolean finished, boolean saveState) { ... if (!r.activity.mFinished &amp;&amp; saveState) { callCallActivityOnSaveInstanceState(r); } ... } å¯ä»¥å‘ç°ï¼Œè¿™é‡Œè°ƒç”¨äº†callCallActivityOnSaveInstanceStateæ–¹æ³•ï¼Œçœ‹åç§°å¯ä»¥å‘ç°è¿™é‡Œåº”è¯¥å›è°ƒçš„æ˜¯Activityçš„onSaveInstanceStateæ–¹æ³•ï¼Œä½†æ˜¯è¿™é‡Œæ‰§è¡Œä¹‹å‰æœ‰ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­è¿™é‡Œçš„Activityæ˜¯å¦è¢«finishï¼Ÿåº”ä¸ºè¿™æ—¶å€™åˆšåˆšæ‰§è¡ŒonPauseæ–¹æ³•æ‰€ä»¥è¿™é‡Œçš„mFinishedå˜é‡ä¸ºfalseï¼Œæ‰€ä»¥åˆ¤æ–­æ‰§è¡ŒcallCallActivityOnSaveInstanceStateæ–¹æ³•åªè¦éœ€è¦é€šè¿‡saveStateå˜é‡æ¥åˆ¤æ–­äº†ï¼Œè€Œè¿™é‡Œçš„saveStateæ–¹æ³•æ˜¯performPauseActivityæ–¹æ³•ä¼ é€’è¿‡æ¥çš„ã€‚ã€‚ã€‚ã€‚å¥½å§ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è°ƒç”¨performPauseActivityæ–¹æ³•æ—¶saveStateå˜é‡æ˜¯å¦‚ä½•èµ‹å€¼çš„ã€‚å›åˆ°æˆ‘ä»¬çš„handlePauseActivityæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹performPauseActivityæ–¹æ³•æ˜¯å¦‚ä½•è°ƒç”¨çš„ï¼š 1performPauseActivity(token, finished, r.isPreHoneycomb()); å¯ä»¥å‘ç°saveState booleanå˜é‡æ˜¯é€šè¿‡r.isPreHoneycombæ–¹æ³•èµ‹å€¼çš„ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹IsPreHoneycombæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼š 1234567public boolean isPreHoneycomb() { if (activity != null) { return activity.getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB; } return false; } å¯ä»¥å‘ç°å½“æˆ‘ä»¬çš„Appè®¾ç½®çš„targetSdkç‰ˆæœ¬å·å°äºandroid versionCode 11ä¹Ÿå°±æ˜¯android3.0çš„æ—¶å€™è¿”å›ä¸ºtrueï¼Œå…¶ä»–çš„æ—¶å€™è¿”å›ä¸ºfalseï¼Œä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬Appè®¾ç½®çš„targetVersionå¤§äºandroid3.0çš„æ—¶å€™æ‰ä¼šæ‰§è¡ŒcallCallActivityOnSaveInstanceStateæ–¹æ³•ï¼Œå¥½å§ï¼Œç»§ç»­çœ‹ä¸€ä¸‹callCallActivityOnSaveInstanceStateæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼š 1234567891011private void callCallActivityOnSaveInstanceState(ActivityClientRecord r) { r.state = new Bundle(); r.state.setAllowFds(false); if (r.isPersistable()) { r.persistentState = new PersistableBundle(); mInstrumentation.callActivityOnSaveInstanceState(r.activity, r.state, r.persistentState); } else { mInstrumentation.callActivityOnSaveInstanceState(r.activity, r.state); } } å¯ä»¥å‘ç°æ–¹æ³•ä½“ä¸»è¦è°ƒç”¨äº†mInstrumentationçš„callActivityOnSaveInstanceStateæ–¹æ³•ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹callActivityOnSaveInstanceStateæ–¹æ³•ï¼š 1234public void callActivityOnSaveInstanceState(Activity activity, Bundle outState, PersistableBundle outPersistentState) { activity.performSaveInstanceState(outState, outPersistentState); } è¿™é‡Œæ–¹æ³•ä½“ä¸­åˆå›è°ƒäº†Activityçš„performSaveInstanceStateæ–¹æ³•ã€‚ã€‚ã€‚ 123456final void performSaveInstanceState(Bundle outState) { onSaveInstanceState(outState); saveManagedDialogs(outState); mActivityTransitionState.saveState(outState); if (DEBUG_LIFECYCLE) Slog.v(TAG, &quot;onSaveInstanceState &quot; + this + &quot;: &quot; + outState); } å¯ä»¥çœ‹åˆ°è¿™é‡Œå›è°ƒäº†Activityçš„onSaveInstanceStateæ–¹æ³•ï¼Œè¿™æ ·ç»è¿‡ä¸€ç³»åˆ—çš„æ–¹æ³•å›è°ƒä¹‹åæˆ‘ä»¬å°±æ‰§è¡Œäº†onSaveInstanceStateæ–¹æ³•ã€‚ è¿™æ ·æˆ‘ä»¬å½“åªæ‰§è¡ŒonPauseæ–¹æ³•çš„æ—¶å€™ä¸€èˆ¬é€šè¿‡è®¾ç½®targetVersionæ§åˆ¶æ˜¯å¦æ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ï¼Œå½“è®¾ç½®çš„targetVersionCodeå¤§äºandroid3.0çš„æ—¶å€™é»˜è®¤ä¸ä¼šæ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ã€‚ ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹å½“Activityæ‰§è¡ŒonStopæ–¹æ³•çš„æ—¶å€™æ˜¯å¦ä¼šæ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ï¼Œé€šè¿‡ä¹‹å‰åˆ†æçš„Activityçš„å¯åŠ¨æµç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“Actvitiyæ‰§è¡ŒonStopæ–¹æ³•ä¼šå›è°ƒActivityThreadçš„handleStopActivityï¼Œè¿™æ ·æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹handleStopActivityæ–¹æ³•çš„å®ç°ï¼š 12345678910111213141516171819private void handleStopActivity(IBinder token, boolean show, int configChanges) { ActivityClientRecord r = mActivities.get(token); r.activity.mConfigChangeFlags |= configChanges; StopInfo info = new StopInfo(); performStopActivityInner(r, info, show, true); if (localLOGV) Slog.v( TAG, &quot;Finishing stop of &quot; + r + &quot;: show=&quot; + show + &quot; win=&quot; + r.window); updateVisibility(r, show); info.activity = r; info.state = r.state; info.persistentState = r.persistentState; mH.post(info); mSomeActivitiesChanged = true; } ç„¶åæˆ‘ä»¬å‘ç°åœ¨æ–¹æ³•performStopActivityæ–¹æ³•ä¸­è°ƒç”¨äº†performStopActivityInneræ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹performStopActivityInneræ–¹æ³•çš„å®ç°ï¼š 12345678910private void performStopActivityInner(ActivityClientRecord r, StopInfo info, boolean keepShown, boolean saveState) { ... if (!r.activity.mFinished &amp;&amp; saveState) { if (r.state == null) { callCallActivityOnSaveInstanceState(r); } } ... } å¯ä»¥å‘ç°è¿˜æ˜¯é€šè¿‡saveStateå˜é‡æ¥æ§åˆ¶æ˜¯å¦è°ƒç”¨onSaveInstanceStateï¼Œè€Œè¿™é‡Œçš„saveStateå˜é‡æ˜¯åœ¨performStopActivityInneræ–¹æ³•è°ƒç”¨çš„æ—¶å€™ä¼ é€’çš„ï¼Œå›åˆ°æˆ‘ä»¬çš„handleStopActivityæ–¹æ³•ä¸­å…³äºperformStopActivityInnerè°ƒç”¨çš„ä»£ç ï¼š 1performStopActivityInner(r, info, show, true); å¥½å§ï¼Œè¿™é‡Œç›´æ¥ä¼ å€¼ä¸ºtrueï¼Œè¿™æ ·æˆ‘ä»¬æ‰§è¡ŒActivityçš„stopæ–¹æ³•ä¸€å®šæ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ã€‚ æ€»ç»“ onSaveInstanceStateæ–¹æ³•æ˜¯Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œä¸»è¦ç”¨äºåœ¨Activityé”€æ¯æ—¶ä¿å­˜ä¸€äº›ä¿¡æ¯ã€‚ å½“Activityåªæ‰§è¡ŒonPauseæ–¹æ³•æ—¶ï¼ˆActivity aæ‰“å¼€ä¸€ä¸ªé€æ˜Activity bï¼‰è¿™æ—¶å€™å¦‚æœAppè®¾ç½®çš„targetVersionå¤§äºandroid3.0åˆ™ä¸ä¼šæ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ã€‚ å½“Activityæ‰§è¡ŒonStopæ–¹æ³•æ—¶ï¼Œé€šè¿‡åˆ†ææºç æˆ‘ä»¬çŸ¥é“è°ƒç”¨onSaveInstanceStateçš„æ–¹æ³•ç›´æ¥ä¼ å€¼ä¸ºtrueï¼Œæ‰€ä»¥éƒ½ä¼šæ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåäºŒï¼‰â€“&gt;ToaståŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸‰ï¼‰â€“&gt;Androidå¼‚å¸¸å¤„ç†æµç¨‹","link":"/2020/09/11/onSaveInstanceState%E6%89%A7%E8%A1%8C%E6%97%B6%E6%9C%BA/"},{"title":"å¿«é€Ÿæ‰‹åŠ¨æ­å»ºSSæœåŠ¡å™¨ç®€æ˜è¯¦ç»†æ•™ç¨‹","text":"ä¼˜æƒ è´­ä¹°æ¬ç“¦å·¥æ¬ç“¦å·¥VPSç›¸å¯¹å…¶å®ƒçš„äº‘æœåŠ¡äº§å•†æ¥è¯´ï¼Œæ€§ä»·æ¯”é«˜ï¼Œä½¿ç”¨èµ·æ¥é€Ÿåº¦å¿«ã€‚é€šè¿‡ä¼˜æƒ ç è´­ä¹°è¿˜èƒ½å†é™ä½æœ€å¤š %6 çš„ä¸€äº›è´¹ç”¨ã€‚åœ¨è¿™åŸºç¡€ä¸Šä½¿ç”¨ä¼˜æƒ ç å¯ä»¥å°‘ä¸€äº›è´¹ç”¨ï¼Œæ ¹æ®ä½ å¯¹é…ç½®çš„éœ€è¦è¿›è¡Œé€‰æ‹©æœåŠ¡å™¨ï¼Œä»¥ä¸‹æ˜¯å¯ä»¥è·å–ä¼˜æƒ ç çš„é“¾æ¥ï¼š | æ¬ç“¦å·¥é…ç½® | æ¬ç“¦å·¥è´¹ç”¨ | ä¼˜æƒ é“¾æ¥ || â€” | â€” | â€” || 20G KVM â€“ PROMOSSDç¡¬ç›˜: 20 GB RAID-10RAMå†…å­˜: 1024 MBCPUå¤„ç†å™¨: 2x Intel XeonTransferæµé‡: 1 TB/moè¿æ¥é€Ÿåº¦: 1 GigabitMultiple locations | $25.99/åŠå¹´ | ç‚¹å‡»è¿›å…¥ || SPECIAL 40G KVM PROMO V3 - LOS ANGELES - CN2 SSDç¡¬ç›˜: 40 GB RAID-10RAMå†…å­˜: 2048 MBCPUå¤„ç†å™¨: 1x Intel XeonTransferæµé‡: 2000 GB/æœˆè¿æ¥é€Ÿåº¦: 1 Gigabitæ´›æ‰çŸ¶æœºæˆ¿ï¼ŒCN2è·¯çº¿ï¼Œä½¿ç”¨ä¸­å›½çš„ç›´çº¿è·¯çº¿ï¼Œé€Ÿåº¦åŠ å¿« | $27.99/å­£ | ç‚¹å‡»è¿›å…¥ || SPECIAL 20G KVM PROMO V3 - LOS ANGELES - CN2 SSDç¡¬ç›˜: 20 GB RAID-10RAMå†…å­˜: 1024 MBCPUå¤„ç†å™¨: 1x Intel XeonTransferæµé‡: 1000 GB/æœˆè¿æ¥é€Ÿåº¦: 1 Gigabitæ´›æ‰çŸ¶æœºæˆ¿ï¼ŒCN2è·¯çº¿ï¼Œä½¿ç”¨ä¸­å›½çš„ç›´çº¿è·¯çº¿ï¼Œé€Ÿåº¦åŠ å¿« | $29.99 /åŠå¹´ | ç‚¹å‡»è¿›å…¥ || 80G KVM â€“ PROMOSSDç¡¬ç›˜: 80 GB RAID-10RAMå†…å­˜: 4 GBCPUå¤„ç†å™¨: 4x Intel XeonTransferæµé‡: 3 TB/moè¿æ¥é€Ÿåº¦: 1 GigabitMultiple locations | $19.99/æœˆ | ç‚¹å‡»è¿›å…¥ || 20G KVM â€“ PROMOSSDç¡¬ç›˜: 20 GB RAID-10RAMå†…å­˜: 1024 MBCPUå¤„ç†å™¨: 2x Intel XeonTransferæµé‡: 1 TB/moè¿æ¥é€Ÿåº¦: 1 GigabitMultiple locations | $49.99/å¹´ | ç‚¹å‡»è¿›å…¥ || 40G KVM â€“ PROMOSSDç¡¬ç›˜: 40 GB RAID-10RAMå†…å­˜: 2 GBCPUå¤„ç†å™¨: 3x Intel XeonTransferæµé‡: 2 TB/moè¿æ¥é€Ÿåº¦: 1 GigabitMultiple locations | $99.99/å¹´ | ç‚¹å‡»è¿›å…¥ || 160G KVM â€“ PROMOSSDç¡¬ç›˜: 160 GB RAID-10RAMå†…å­˜: 8 GBCPUå¤„ç†å™¨: 5x Intel XeonTransferæµé‡: 4 TB/moè¿æ¥é€Ÿåº¦: 1 GigabitMultiple locations | $39.99/æœˆ | ç‚¹å‡»è¿›å…¥ || 3200G KVM â€“ PROMOSSDç¡¬ç›˜: 320 GB RAID-10RAMå†…å­˜: 16 GBCPUå¤„ç†å™¨: 6x Intel XeonTransferæµé‡: 5 TB/moè¿æ¥é€Ÿåº¦: 1 GigabitMultiple locations | $79.99/æœˆ | ç‚¹å‡»è¿›å…¥ | è¿›å…¥ä¹‹åå°±å¯ä»¥è·å–ä¼˜æƒ ç äº†ï¼Œé€‰æ‹©å®Œä¹‹åä¸è¦æ€¥ç€ç‚¹å‡» ã€ŒAdd to Cartã€ã€‚ è¿™æ—¶å€™å°±å¯ä»¥è·å–éšè—çš„ä¼˜æƒ ç äº†ï¼Œæˆ‘ä»¬å¯¹ç€è¿™ä¸ªç½‘é¡µï¼šé¼ æ ‡å³å‡»--&gt;æŸ¥çœ‹ç½‘é¡µæºä»£ç ã€‚ æ¥ç€ Ctrl + F æœç´¢ code ï¼Œè¿™æ—¶å€™ä½ å°±ä¼šçœ‹åˆ° Try this promo code: xxxxï¼Œè¿™é‡Œçš„xxxxå°±æ˜¯ä¼˜æƒ å—ï¼ŒæŠŠå®ƒå¤åˆ¶ä¸‹æ¥ã€‚ é¡µé¢çš„ Location å°±æ˜¯é€‰æ‹©æœåŠ¡å™¨çš„åœ°å€ï¼Œåˆ°æ—¶è®¿é—®è°·æ­Œçš„æ—¶å€™ä¼šæ˜¾ç¤ºä½ å½“å‰è®¿é—®çš„åœ°å€ã€‚å¥½äº†ï¼Œæˆ‘ä»¬ç‚¹å‡»ã€ŒAdd to Cartã€ã€‚ æ¥ä¸‹æ¥ï¼Œè¿›å…¥ç»“ç®—é¡µé¢ï¼Œæˆ‘ä»¬åˆšæ‰å¤åˆ¶çš„ä¼˜æƒ ç å°±æ´¾ä¸Šç”¨åœºäº†ï¼Œå°†ä½ åˆšåˆšå¤åˆ¶çš„ä¼˜æƒ ç å¤åˆ¶è¿›å»ç„¶åç‚¹å‡» ã€ŒValidate Codeã€ï¼Œçœ‹ï¼æ˜¯ä¸æ˜¯ä¼˜æƒ äº†ï¼ä¸€èˆ¬äººä¸çŸ¥é“è¿™ç§æ“ä½œ: æ¥ç€ç‚¹å‡»ã€ŒCheckOutã€å®Œæˆä»˜æ¬¾å³å¯ã€‚ä»˜æ¬¾çš„æ—¶å€™é€‰æ‹© Alipay å°±å¯ä»¥ä½¿ç”¨æ”¯ä»˜å®ä»˜æ¬¾ã€‚ è·å–æ¬ç“¦å·¥æœåŠ¡å™¨çš„ipï¼Œç«¯å£ï¼Œè´¦å·å¯†ç è´­ä¹°å®Œæ¯•åä½ å°±æ‹¥æœ‰ä¸€å°ä½ è‡ªå·±çš„æœåŠ¡å™¨äº†ï¼Œæ¥ç€ç‚¹å‡»Servicesä¸‹çš„MyServicesï¼Œå¯ä»¥çœ‹åˆ°ä½ çš„æœåŠ¡å™¨ï¼š æˆ‘ä»¬ç‚¹å‡»ã€ŒKiwiVM Control Panelã€è¿›å…¥ç®¡ç†ç•Œé¢ï¼š å¯ä»¥çœ‹åˆ°ä½ æœåŠ¡å™¨çš„ä¿¡æ¯: æœ‰äº†æ¬ç“¦å·¥æœåŠ¡å™¨çš„IPåœ°å€å’Œç«¯å£,æˆ‘ä»¬å°±å¯ä»¥è¿æ¥äº†ï¼š è´¦å·æ˜¯rootï¼Œå¯†ç å¯ä»¥åœ¨è¿™é‡Œè·å–ï¼š ä½¿ç”¨ SSH å·¥å…·è¿æ¥åˆ°æ¬ç“¦å·¥æœåŠ¡å™¨ è¿œç¨‹è¿æ¥å·¥å…·æˆ‘ä¸€ç›´ç”¨çš„æ˜¯ SecureCRT , å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶å®ƒçš„ SSH å·¥å…·ã€‚ç ´è§£ç‰ˆçš„SecureCRTå¯ä»¥åœ¨ç™¾åº¦ç½‘ç›˜è¿™é‡Œè·å–ï¼š é“¾æ¥: https://pan.baidu.com/s/11W4WHjCjmiNw6einQNrcPg æå–ç : tyux å¼€å§‹å¿«è¯»æ­å»ºssæœåŠ¡å™¨å®‰è£… wget ï¼š1yum install wget æ‰§è¡Œå®‰è£…ssï¼š1wget â€“no-check-certificate -O shadowsocks.sh https://raw.githubusercontent.com/teddysun/shadowsocks_install/master/shadowsocks.sh è·å–shadowsocks.shè¯»å–æƒé™1chmod +x shadowsocks.sh è®¾ç½®sså¯†ç ç«¯å£å’ŒåŠ å¯†æ–¹å¼å½“ä½ è¾“å…¥./shadowsocks.sh 2&gt;&amp;1 | tee shadowsocks.logåå°±å¯ä»¥è®¾ç½®å¯†ç å’Œç«¯å£å·äº†ï¼š è®¾ç½®å®Œå¯†ç å’Œç«¯å£å·ä¹‹åï¼Œæˆ‘ä»¬é€‰æ‹©åŠ å¯†æ–¹å¼ï¼Œè¿™é‡Œé€‰æ‹© 7ï¼š æ¥ç€æŒ‰ä»»æ„é”®è¿›è¡Œå®‰è£…ã€‚ å®‰è£…sså®Œæˆç­‰ä¸€ä¼šä¹‹åï¼Œå°±å®‰è£…å®Œæˆäº†ï¼Œå®ƒä¼šç»™ä½ æ˜¾ç¤ºä½ éœ€è¦è¿æ¥vpnçš„ä¿¡æ¯ï¼š å¯ä»¥çœ‹åˆ°éœ€è¦è¿æ¥ssçš„ipåœ°å€ï¼Œå¯†ç ï¼Œç«¯å£ï¼Œå’ŒåŠ å¯†æ–¹å¼ã€‚ å°†è¿™äº›ä¿¡æ¯ä¿å­˜èµ·æ¥ï¼Œé‚£ä¹ˆè¿™æ—¶å€™ä½ å°±å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥ç§‘å­¦ä¸Šç½‘å•¦ã€‚ ä½¿ç”¨Shadowsocksæ‰“å¼€ Shadowsocks å®¢æˆ·ç«¯ï¼Œè¾“å…¥ipåœ°å€ï¼Œå¯†ç ï¼Œç«¯å£ï¼Œå’ŒåŠ å¯†æ–¹å¼ã€‚æ¥ç€ç‚¹å‡»ç¡®å®šï¼Œå³ä¸‹è§’ä¼šæœ‰ä¸ªå°é£æœºæŒ‰é’®ï¼Œå³é”®â€“&gt;å¯åŠ¨ä»£ç†ã€‚ è¿™æ—¶å€™å°±å¯ä»¥ç§‘å­¦ä¸Šç½‘äº†ã€‚ è®¿é—®ä»¥ä¸‹ Youtube å’Œ Google è¯•è¯•çœ‹ï¼Œé€Ÿåº¦è¿˜å¯ä»¥çš„ï¼š ä½¿ç”¨BBRåŠ é€Ÿå™¨è®©è®¿é—®é€Ÿåº¦åŠ é€Ÿï¼Œé£èµ·æ¥ï¼ä½¿ç”¨ BBR åŠ é€Ÿå·¥å…·ã€‚ å®‰è£… BBR1wget --no-check-certificate https://github.com/teddysun/across/raw/master/bbr.sh è·å–è¯»å†™æƒé™1chmod +x bbr.sh å¯åŠ¨BBRå®‰è£…1./bbr.sh æ¥ç€æŒ‰ä»»æ„é”®ï¼Œå¼€å§‹å®‰è£…ï¼Œåç­‰ä¸€ä¼šã€‚å®‰è£…å®Œæˆä¸€ä¼šä¹‹åå®ƒä¼šæç¤ºæˆ‘ä»¬æ˜¯å¦é‡æ–°å¯åŠ¨vpsï¼Œæˆ‘ä»¬è¾“å…¥ y ç¡®å®šé‡å¯æœåŠ¡å™¨ã€‚ é‡æ–°å¯åŠ¨ä¹‹åï¼Œè¾“å…¥ lsmod | grep bbr å¦‚æœçœ‹åˆ° tcp_bbr å°±è¯´æ˜ BBR å·²ç»å¯åŠ¨äº†ã€‚ å†è®¿é—®ä¸€ä¸‹ Youtubeï¼Œ1080p è¶…é«˜æ¸…ï¼Œå¾ˆé¡ºç•…ä¸å¡é¡¿ï¼ æœ¬æ–‡ä¸ºè½¬è½½ï¼Œå‡ºå¤„ https://www.cnbanwagong.com/6.html","link":"/2019/10/11/%E6%90%AC%E7%93%A6%E5%B7%A5%E5%BF%AB%E9%80%9F%E6%89%8B%E5%8A%A8%E6%90%AD%E5%BB%BASS(Shadowsocks)%E6%9C%8D%E5%8A%A1%E5%99%A8/"},{"title":"æ³¨è§£ç›¸å…³çŸ¥è¯†","text":"æ³¨è§£@Retentionå¯ä»¥ç”¨æ¥ä¿®é¥°æ³¨è§£ï¼Œæ˜¯æ³¨è§£çš„æ³¨è§£ï¼Œç§°ä¸ºå…ƒæ³¨è§£ã€‚Retentionæ³¨è§£æœ‰ä¸€ä¸ªå±æ€§valueï¼Œæ˜¯RetentionPolicyç±»å‹çš„ï¼ŒEnum RetentionPolicyæ˜¯ä¸€ä¸ªæšä¸¾ç±»å‹ï¼Œ@Retention æ³¨è§£æŒ‡å®šæ ‡è®°æ³¨è§£çš„å­˜å‚¨æ–¹å¼ï¼šRetentionPolicy.SOURCE - æ³¨è§£åªä¿ç•™åœ¨æºæ–‡ä»¶ï¼Œå½“Javaæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶çš„æ—¶å€™ï¼Œæ³¨è§£è¢«é—å¼ƒï¼›RetentionPolicy.CLASS - æ ‡è®°çš„æ³¨è§£åœ¨ç¼–è¯‘æ—¶ç”±ç¼–è¯‘å™¨ä¿ç•™ï¼Œä½†Javaè™šæ‹Ÿæœº(JVM)ä¼šå¿½ç•¥ã€‚ è¿™æ˜¯é»˜è®¤çš„ç”Ÿå‘½å‘¨æœŸï¼›RetentionPolicy.RUNTIME - æ³¨è§£ä¸ä»…è¢«ä¿å­˜åˆ°classæ–‡ä»¶ä¸­ï¼ŒjvmåŠ è½½classæ–‡ä»¶ä¹‹åï¼Œä»ç„¶å­˜åœ¨ï¼Œå› æ­¤è¿è¡Œæ—¶ç¯å¢ƒå¯ä»¥ä½¿ç”¨å®ƒã€‚ @Target æ³¨è§£æ ‡è®°å¦ä¸€ä¸ªæ³¨è§£ï¼Œä»¥é™åˆ¶å¯ä»¥åº”ç”¨æ³¨è§£çš„ Java å…ƒç´ ç±»å‹ã€‚ç›®æ ‡æ³¨è§£æŒ‡å®šä»¥ä¸‹å…ƒç´ ç±»å‹ä¹‹ä¸€ä½œä¸ºå…¶å€¼ï¼šElementType.ANNOTATION_TYPå¯ä»¥åº”ç”¨äºæ³¨è§£ç±»å‹ã€‚ElementType.CONSTRUCTOR å¯ä»¥åº”ç”¨äºæ„é€ å‡½æ•°ã€‚ElementType.FIELD å¯ä»¥åº”ç”¨äºå­—æ®µæˆ–å±æ€§ã€‚ElementType.LOCAL_VARIABLE å¯ä»¥åº”ç”¨äºå±€éƒ¨å˜é‡ã€‚ElementType.METHOD å¯ä»¥åº”ç”¨äºæ–¹æ³•çº§æ³¨è§£ã€‚ElementType.PACKAGE å¯ä»¥åº”ç”¨äºåŒ…å£°æ˜ã€‚ElementType.PARAMETER å¯ä»¥åº”ç”¨äºæ–¹æ³•çš„å‚æ•°ã€‚ElementType.TYPE å¯ä»¥åº”ç”¨äºç±»çš„ä»»ä½•å…ƒç´ ã€‚ package com.example.inject; import java.lang.annotation.ElementType;import java.lang.annotation.Retention;import java.lang.annotation.RetentionPolicy;import java.lang.annotation.Target; åœ¨Activity ä¸­å¢åŠ æ³¨è§£æ ‡æ³¨ï¼Œé€šè¿‡æ³¨è§£+åå°„+åŠ¨æ€ä»£ç†ç­‰ï¼Œæ¥ä¼˜åŒ–Activityä¸­ä»£ç ã€‚çœå» setContentViewã€findViewByIdã€setOnClickListenerç­‰æ“ä½œã€‚Layoutæ³¨è§£12345@Target(ElementType.TYPE)@Retention(RetentionPolicy.RUNTIME)public @interface InjectLayout { @LayoutRes int value();} Viewæ³¨è§£12345@Target(ElementType.FIELD)@Retention(RetentionPolicy.RUNTIME)public @interface InjectView { @IdRes int value();} OnClickæ³¨è§£123456@Target(ElementType.METHOD)@Retention(RetentionPolicy.RUNTIME)@InjectEvent(listenerSetter = &quot;setOnClickListener&quot;, listenerType = View.OnClickListener.class, methodName = &quot;onClick&quot;)public @interface OnClick { int[] value();} OnLongClickæ³¨è§£123456@Target(ElementType.METHOD)@Retention(RetentionPolicy.RUNTIME)@InjectEvent( listenerSetter= &quot;setOnLongClickListener&quot;, listenerType= View.OnLongClickListener.class,methodName = &quot;onLongClick&quot;)public @interface OnLongClick { int[] value();} å…ƒæ³¨è§£ æ ‡æ³¨ OnClick OnLongClick çš„æ³¨è§£1234567@Target(ElementType.ANNOTATION_TYPE)@Retention(RetentionPolicy.RUNTIME)public @interface InjectEvent { String listenerSetter(); Class&lt;?&gt; listenerType(); String methodName();} æ³¨è§£ç®¡ç†123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138package com.example.inject;import android.app.Activity;import android.view.View;import java.lang.reflect.Field;import java.lang.reflect.InvocationTargetException;import java.lang.reflect.Method;import java.lang.reflect.Proxy;public class InjectManage { public static void inJect(Activity activity) { injectLayout(activity); injectView(activity); injectEvent(activity); } /** * ä¾èµ–æ³¨å…¥ layoutIdå¸ƒå±€ * è·å– Activity ä¸Šçš„æ³¨è§£ * * @param activity */ private static void injectLayout(Activity activity) { if (activity == null) { throw new NullPointerException(); }// 1.è·å–Activityçš„classå¯¹è±¡ Class&lt;? extends Activity&gt; clazz = activity.getClass();// 2.åˆ¤æ–­å½“å‰Activityæ˜¯å¦ä¸ºInjectLayoutä¿®é¥° if (clazz.isAnnotationPresent(InjectLayout.class)) {// 3.è·å–InjectLayoutæ³¨è§£ InjectLayout annotation = clazz.getAnnotation(InjectLayout.class); if (annotation != null) { try {// 4.é€šè¿‡åå°„è·å– å½“å‰Activity çš„ setContentView æ–¹æ³• Method method = clazz.getMethod(&quot;setContentView&quot;, int.class);// 5.è·å–æ³¨è§£ä¸Šçš„value layoutId int resourceId = annotation.value();// 6.è°ƒç”¨setContentView method.invoke(activity, resourceId); } catch (Exception e) { e.printStackTrace(); } } } } /** * ä¾èµ–æ³¨å…¥ è·å–View * * @param activity */ private static void injectView(Activity activity) { if (activity == null) { throw new NullPointerException(); }// 1.è·å–Activityçš„classå¯¹è±¡ Class&lt;? extends Activity&gt; clazz = activity.getClass();// 2.åˆ¤æ–­å½“å‰Activityä¸­æ‰€æœ‰çš„å±æ€§å­—æ®µ Field[] fields = clazz.getDeclaredFields(); for (Field field : fields) {// 3. åˆ¤æ–­å­—æ®µæ˜¯å¦ä¸ºInjectViewä¿®é¥° if (field.isAnnotationPresent(InjectView.class)) { InjectView injectView = field.getAnnotation(InjectView.class); if (injectView != null) { try {// 4.åå°„è·å–findViewByIdæ–¹æ³• Method method = clazz.getMethod(&quot;findViewById&quot;, int.class);// 5.è·å–èµ„æºid int resourceId = injectView.value();// 6.è·å–Viewå¯¹è±¡ View view = (View) method.invoke(activity, resourceId);// 7.è®¾ç½®è®¿é—®æƒé™ field.setAccessible(true);// 8.å°†åå°„è·å–åˆ°çš„viewèµ‹å€¼åˆ°Activityä¸Š field.set(activity, view); } catch (Exception e) { e.printStackTrace(); } } } } } /** * ä¾èµ–æ³¨å…¥ è·å– OnClick OnLongClickæ³¨è§£äº‹ä»¶ * æ³¨è§£ + åå°„ + åŠ¨æ€ä»£ç† * * @param activity */ private static void injectEvent(Activity activity) { if (activity == null) { throw new NullPointerException(); } try {// 1.è·å–Activityçš„classå¯¹è±¡ Class&lt;? extends Activity&gt; clazz = activity.getClass();// 2.è·å–Activityçš„æ‰€æœ‰æˆå‘˜æ–¹æ³• æ’é™¤ç»§æ‰¿æ–¹æ³• Method[] methods = clazz.getDeclaredMethods(); for (Method method : methods) {// 3.æ˜¯å¦æ˜¯è‡ªå®šä¹‰æ³¨è§£ä¿®é¥° if (method.isAnnotationPresent(OnClick.class)) {//TODO OnLongClickäº‹ä»¶å¤„ç† OnClick onClick = method.getAnnotation(OnClick.class); int[] value = onClick.value();// 4.è·å–æ³¨è§£ä¸Šçš„æ³¨è§£ å…ƒæ³¨è§£ InjectEvent injectEvent = onClick.annotationType().getAnnotation(InjectEvent.class); String listenerSetter = injectEvent.listenerSetter(); Class&lt;?&gt; listenerType = injectEvent.listenerType(); String methodName = injectEvent.methodName();// 5.åŠ¨æ€ä»£ç† ç”Ÿæˆä»£ç†çš„listener ProxyHandler handler=new ProxyHandler(activity); Object listener = Proxy.newProxyInstance(listenerType.getClassLoader(), new Class[]{listenerType}, handler); handler.mapMethod(methodName,method);// 6.åå°„è·å– findViewByIdæ–¹æ³•çš„Methodå¯¹è±¡ Method findViewByIdMethod = clazz.getMethod(&quot;findViewById&quot;, int.class); findViewByIdMethod.setAccessible(true); for (int id : value) {// 7.é€šè¿‡findViewByIdè·å–view View btn = (View) findViewByIdMethod.invoke(activity, id);// 8.æ ¹æ®listenerSetteræ–¹æ³•åå’ŒlistenerTypeæ–¹æ³•å‚æ•°æ‰¾åˆ°method Method listenerSetMethod = btn.getClass().getMethod(listenerSetter, listenerType); listenerSetMethod.setAccessible(true); listenerSetMethod.invoke(btn, listener); } } } } catch (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) { e.printStackTrace(); } }} ProxyHandler12345678910111213141516171819202122232425262728293031323334353637383940414243package com.example.inject;import android.app.Activity;import android.util.Log;import java.lang.ref.WeakReference;import java.lang.reflect.InvocationHandler;import java.lang.reflect.Method;import java.util.HashMap;public class ProxyHandler implements InvocationHandler { private WeakReference&lt;Activity&gt; mHandlerRef; private HashMap&lt;String, Method&gt; mMethodHashMap; public ProxyHandler(Activity activity) { mHandlerRef = new WeakReference&lt;&gt;(activity); mMethodHashMap = new HashMap&lt;&gt;(); } public void mapMethod(String name, Method method) { mMethodHashMap.put(name, method); } @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable { try { Object handler = mHandlerRef.get(); if (null == handler) return null; String name = method.getName(); //å°†onClickæ–¹æ³•çš„è°ƒç”¨æ˜ å°„åˆ°activity ä¸­çš„æ³¨è§£æ ‡æ³¨çš„æ–¹æ³• Method realMethod = mMethodHashMap.get(name);// Log.i(&quot;injectEvent&quot;, &quot;proxy=&quot; + proxy + &quot;,method=&quot; + method.getName() + &quot;,realMethod=&quot; + realMethod); if (null != realMethod) { return realMethod.invoke(handler, args); } } catch (Exception e) { e.printStackTrace(); } return null; }} 12345678910111213141516171819202122232425262728293031323334@InjectLayout(value = R.layout.activity_network)public class NetworkActivity extends AppCompatActivity { @InjectView(R.id.get_data) Button button; @InjectView(R.id.get_data2) Button button2; @Override protected void onCreate(@Nullable Bundle savedInstanceState) { super.onCreate(savedInstanceState); InjectManage.inJect(this);// setContentView();// button=findViewById(R.id.button)// button.setOnClickListener(new View.OnClickListener() {// @Override// public void onClick(View v) {// testNetWorkApi();// }// });// button.setOnLongClickListener(new View.OnLongClickListener() {// @Override// public boolean onLongClick(View v) {// return false;// }// }); } @OnClick({R.id.get_data,R.id.get_data2}) public void onClick(View view){ Log.e(&quot;Inject&quot;,&quot;ä¾èµ–æ³¨å…¥å®ç° onClick&quot;); } @OnLongClick(R.id.get_data) public void onLongClick(View view){ Log.e(&quot;Inject&quot;,&quot;ä¾èµ–æ³¨å…¥å®ç° onLongClick&quot;); } æœŸé—´é‡åˆ°ç‚¹å°é—®é¢˜ï¼Œå°±æ˜¯åŠ¨æ€ä»£ç†è¿™å—ï¼Œå¯¹è¿™å—ç†è§£ä¸å¤Ÿæ·±ã€‚é¦–å…ˆ Activityä¸­ ä½¿ç”¨OnClickæ³¨è§£ä¿®é¥°çš„æ–¹æ³•onClick()æ˜¯éœ€è¦ä¼ å…¥å‚æ•°çš„ï¼Œå¦åˆ™åœ¨åŠ¨æ€ä»£ç†é‡Œï¼ŒåŠ¨æ€ä»£ç†å›è°ƒè¿™ä¸ªæ–¹æ³•å°±ä¼šå‡ºé”™ã€‚","link":"/2020/09/11/%E6%B3%A8%E8%A7%A3%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86/"},{"title":"æ­å»º WordPress åšå®¢æ•™ç¨‹ï¼ˆè¶…è¯¦ç»†ï¼‰","text":"æœ¬æ–‡è½¬è‡ªï¼šNonecy çš„å°é»‘å±‹*é“¾æ¥ï¼šhttp://blog.studymany.com/2018/07/29/create-wordpress-blog/* éœ€è¦ ä¸€å°æœåŠ¡å™¨ ä¸€ä¸ªåŸŸåï¼Œç›´æ¥é€šè¿‡ipè®¿é—®å¥½å‚»å¥½å‚»çš„æ ·å­ï¼Œå“ˆå“ˆã€‚ linuxçŸ¥è¯† è‚¯æŠ˜è…¾ å…·ä½“æ­¥éª¤ç¬¬ä¸€æ­¥è´­ä¹°æœåŠ¡å™¨ï¼Œå›½å†…é˜¿é‡Œäº‘çš„äº‘æœåŠ¡å™¨æŒºä¸é”™çš„ï¼Œå›½å¤–çš„å°±æ›´å¤šäº†ï¼Œè¿™ä¸€æ­¥å°±ä¸ä»‹ç»äº†ï¼Œä¸æ‡‚å¾—çš„è‡ªå·±ä¸Šç½‘æœã€‚æ¥ä¸‹æ¥æ“ä½œéœ€è¦ï¼š è¿œç¨‹è¿æ¥æœåŠ¡å™¨Windows ç”¨æˆ· ä»¥Xshellä¸ºä¾‹ã€‚ ä¸‹è½½å®‰è£…Xshellï¼Œå®˜ç½‘é“¾æ¥ã€‚ å®‰è£…å®Œæˆåæ–°å»ºä¼šè¯ï¼ˆAlt+Nï¼‰ã€‚ä¾æ¬¡å¡«å†™å›¾ä¸­ä¿¡æ¯ã€‚åç§°å¯ä»¥æ˜¯Vultræˆ–è€…å…¶ä»–ï¼Œåè®®é€‰æ‹©SSHï¼Œä¸»æœºå¡«å†™ä¹‹å‰çš„IP Addressï¼Œç«¯å£å·é€‰æ‹©22ã€‚ è¿æ¥ ç‚¹å‡»å·¦ä¾§çš„ç”¨æˆ·èº«ä»½éªŒè¯ï¼Œå¡«å†™ä¿¡æ¯ã€‚æ–¹æ³•é€‰æ‹©Passwordï¼Œç”¨æˆ·åä¸ºä¹‹å‰çš„Usernameï¼ˆä¸€èˆ¬éƒ½æ˜¯rootï¼‰ï¼Œå¯†ç ä¸ºä¹‹å‰çš„Passwordï¼ˆè¿™ä¸ªå»ºè®®ç›´æ¥å¤åˆ¶ç²˜è´´è¿‡æ¥ï¼Œç³»ç»Ÿç»™çš„æœ‰ç‚¹å¤æ‚ï¼‰ ç”¨æˆ·èº«ä»½éªŒè¯ å¡«å†™å®Œä¹‹åç‚¹å‡»ç¡®å®šã€‚ç„¶åç‚¹å‡»è¿æ¥ã€‚å‡ºç°å…¶ä»–æç¤ºçš„è¯é€‰æ‹©æ¥å—å°±å¯ä»¥äº†ã€‚è¿™æ—¶ä½ å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå‘½ä»¤æ§åˆ¶å°äº†ã€‚è¿™æ—¶å°±ç®—è¿æ¥æˆåŠŸäº†ã€‚ Mac OS ç”¨æˆ· æ‰“å¼€ç»ˆç«¯æˆ–è€…iTerm2ç­‰ã€‚ 1ssh root@45.32.195.77 ç„¶åè¾“å…¥å¯†ç å³å¯ã€‚ å®‰è£…nginxï¼Œmysqlï¼Œphpå»ºè®®ä½¿ç”¨lnmpä¸€é”®å®‰è£…åŒ…å®‰è£…ï¼Œæ–¹ä¾¿å¿«æ·ã€‚å¦‚æœä¸ç”¨ä¸€é”®å®‰è£…åŒ…ï¼Œæˆ‘ä¼°è®¡å¾—ç ”ç©¶è¿™ä¸€å—çš„ä¸œè¥¿å¤§æ¦‚ä¸€å‘¨å§ã€‚ä¸‹é¢ä»¥ä¸€é”®å®‰è£…åŒ…ä¸ºä¾‹ã€‚ è·å–lnmpä¸€é”®å®‰è£…åŒ…é“¾æ¥ lnpmå®˜ç½‘é“¾æ¥ æ‰¾åˆ°ä¸‹è½½é¡µé¢é€‰æ‹©æœ€æ–°çš„å¤åˆ¶å…¶é“¾æ¥ã€‚ å†™æ­¤æ–‡æ—¶æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯å¦‚ä¸‹ï¼š 1234LNMP 1.4 æµ‹è¯•ç‰ˆhttp://soft.vpser.net/lnmp/lnmp1.4beta.tar.gz (131KB)MD5ï¼šbd851e151b2ba13c3a32c435efb1a76cæœ€åæ›´æ–°: 2017å¹´2æœˆ14æ—¥14:18 GMT+8 å…¶ä¸­çš„http://soft.vpser.net/lnmp/lnmp1.4beta.tar.gzå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„é“¾æ¥ï¼Œå¤åˆ¶åˆ°å‰ªè´´æ¿ã€‚ å®‰è£… 12345678# ä¸‹è½½ï¼Œåè¾¹çš„è·¯å¾„ç›´æ¥ç²˜è´´å°±å¥½ã€‚XShellä¸Šé¢å¤åˆ¶å¿«æ·é”®æ˜¯ctrl+insertï¼Œç²˜è´´å¿«æ·é”®æ˜¯Shift+insertï¼Œmacä¸Šé¢æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„ command+cï¼Œcommand+vwget http://soft.vpser.net/lnmp/lnmp1.4beta.tar.gz# è§£å‹tar -zxvf lnmp1.4beta.tar.gz# è¿›å…¥lnmpç›®å½•cd lnmp1.4# æ‰§è¡Œinstall.shè¿›è¡Œå®‰è£…./install.sh lnmp ä¾æ¬¡è¾“å…¥ä½ è¦å®‰è£…çš„é€‰é¡¹å‰çš„æ•°å­—å¹¶å›è½¦å³å¯ä¸‹ä¸€æ­¥ã€‚ MYSQL é€‰é¡¹ 123456789You have 5 options for your DataBase install.1: Install MySQL 5.1.732: Install MySQL 5.5.53 (Default)3: Install MySQL 5.6.344: Install MySQL 5.7.165: Install MariaDB 5.5.536: Install MariaDB 10.0.287: Install MariaDB 10.1.190: DO NOT Install MySQL/MariaDBEnter your choice (1, 2, 3, 4, 5, 6, 7 or 0): æ­¤å¤„æ ¹æ®æ‰€éœ€é€‰æ‹©ï¼Œå¦‚æœä½¿ç”¨çš„ä¸Šè¿°æœåŠ¡å™¨ï¼Œè¯·é€‰æ‹©2æˆ–è€…ç›´æ¥å›è½¦ã€‚æˆ‘é€‰æ‹©é»˜è®¤ã€‚ æ³¨æ„ï¼šå®‰è£…MySqlæ—¶ï¼Œå¦‚æœé€‰æ‹©å¤ªé«˜çš„ç‰ˆæœ¬å®‰è£…ä¼šè¢«æ‹’ç»ï¼Œæç¤ºä¿¡æ¯å¦‚ä¸‹ Memory less than 1GB, can't install MySQL 5.6, 5.7 or MairaDB 10!ã€‚æ ¹æ®ä¸ªäººæ‰‹åŠ¨å®‰è£…MySql5.7çš„ç»éªŒæ¥çœ‹ï¼Œæ­¤768MBå†…å­˜çš„æœåŠ¡å™¨åœ¨è¿è¡Œä¸€ä¸ªnginxï¼Œmysqlï¼Œphpæ—¶è¿˜å¥½ï¼Œå€˜è‹¥å†è¿è¡Œä¸€ä¸ªtomcatï¼Œmysqlå°†ä¼šä¸å®šæœŸdownæ‰ã€‚æ‰€ä»¥æ­¤å¤„é€‰æ‹©ä¸€ä¸ªä½ç‰ˆæœ¬çš„5.5MySqlå³å¯ã€‚ 1234You will install MySQL 5.5.53===========================Please setup root password of MySQL.(Default password: root)Please enter: è¾“å…¥å¯†ç å›è½¦æˆ–ç›´æ¥å›è½¦ï¼Œç›´æ¥å›è½¦é»˜è®¤å¯†ç ä¸ºrootã€‚æ­¤å¤„åšå®éªŒæˆ‘é€‰æ‹©é»˜è®¤ï¼Œä¸ªäººå®é™…ä½¿ç”¨è¯·ä¿®æ”¹ã€‚ 1234MySQL root password: root===========================Do you want to enable or disable the InnoDB Storage Engine?Default enable,Enter your choice [Y/n]: è¾“å…¥Yæˆ–è€…nç„¶åå›è½¦æˆ–ç›´æ¥å›è½¦ï¼Œç›´æ¥å›è½¦é»˜è®¤å¯ç”¨InnoDBå­˜å‚¨å¼•æ“ã€‚æˆ‘é€‰æ‹©é»˜è®¤ã€‚ 1234567891011No input,The InnoDB Storage Engine will enable.===========================You have 6 options for your PHP install.1: Install PHP 5.2.172: Install PHP 5.3.293: Install PHP 5.4.454: Install PHP 5.5.38 (Default)5: Install PHP 5.6.306: Install PHP 7.0.157: Install PHP 7.1.1Enter your choice (1, 2, 3, 4, 5, 6 or 7): è¾“å…¥é€‰é¡¹ç„¶åå›è½¦æˆ–è€…ç›´æ¥å›è½¦ï¼Œç›´æ¥å›è½¦é»˜è®¤å®‰è£…PHP5.5.38ç‰ˆæœ¬ã€‚æˆ‘é€‰æ‹©é»˜è®¤ã€‚ 12345You will install PHP 7.1.1===========================You have 3 options for your Memory Allocator install.1: Don't install Memory Allocator. (Default)2: Install Jemalloc3: Install TCMalloc è¾“å…¥é€‰é¡¹ç„¶åå›è½¦æˆ–è€…ç›´æ¥å›è½¦ï¼Œç›´æ¥å›è½¦é»˜è®¤ä¸å®‰è£…å†…å­˜åˆ†é…å™¨ã€‚æˆ‘é€‰æ‹©é»˜è®¤ã€‚ æ­¤æ—¶å‡ºç° 1Press any key to install...or Press Ctrl+c to cancel å½“ç„¶æ˜¯æ‘ä»»æ„é”®å•¦ï¼Œä¸€èˆ¬éƒ½æ˜¯å›è½¦å’¯ã€‚ ç„¶åå‡ºç°ä¸€å¤§å †ä¿¡æ¯ã€‚å‰å‡ è¡Œå¦‚ä¸‹ï¼š 12345678910111213You will install lnmp stack.nginx-1.10.3mysql-5.5.53php-5.5.38Enable InnoDB: yPrint lnmp.conf infomation...Download Mirror: http://soft.vpser.netNginx Additional Modules: PHP Additional Modules: Database Directory: /usr/local/mysql/varDefault Website Directory: /home/wwwroot/defaultCentOS release 6.8 (Final)Kernel \\r on an \\m è¿™ä¸€å †ä¸œè¥¿ä½ å°±ä¸ç”¨ç®¡å•¦ã€‚æœ¬æ¬¡å®éªŒçš„å¼€å§‹æ—¶é—´23:04â€¦â€¦ç»è¿‡äº†æ¼«é•¿æ¼«é•¿æ¼«é•¿çš„ç­‰å¾…ä¹‹åâ€¦â€¦å¤§æ¦‚23:35ç»“æŸã€‚æ‰€ä»¥æœŸé—´ä½ å»æ´—ä¸ªæ¾¡çœ‹ä¸ªç”µè§†å‰§éƒ½ä¸æ˜¯é—®é¢˜ã€‚ç„¶åæˆ‘ä»¬çœ‹åˆ°å±å¹•ä¸Šæœ€åè¾“å‡ºçš„ä¿¡æ¯å¦‚ä¸‹ã€‚ 1234The service command supports only basic LSB actions (start, stop, restart, try-restart, reload, force-reload, status). For other actions, please try to use systemctl.Removed symlink /etc/systemd/system/basic.target.wants/firewalld.service.Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.Add Startup and Starting LNMP...Add nginx service at system startup...Starting nginx... doneAdd mysql service at system startup...Starting MySQL... SUCCESS! Add php-fpm service at system startup...Starting php-fpm done============================== Check install ==============================Checking ...Nginx: OKMySQL: OKPHP: OKPHP-FPM: OKClean src directory...+------------------------------------------------------------------------+| LNMP V1.4 for CentOS Linux Server, Written by Licess |+------------------------------------------------------------------------+| For more information please visit https://lnmp.org |+------------------------------------------------------------------------+| lnmp status manage: lnmp {start|stop|reload|restart|kill|status} |+------------------------------------------------------------------------+| phpMyAdmin: http://IP/phpmyadmin/ || phpinfo: http://IP/phpinfo.php || Prober: http://IP/p.php |+------------------------------------------------------------------------+| Add VirtualHost: lnmp vhost add |+------------------------------------------------------------------------+| Default directory: /home/wwwroot/default |+------------------------------------------------------------------------+| MySQL/MariaDB root password: root |+------------------------------------------------------------------------++-------------------------------------------+| Manager for LNMP, Written by Licess |+-------------------------------------------+| https://lnmp.org |+-------------------------------------------+nginx (pid 715 713) is running...php-fpm is runing! SUCCESS! MySQL running (1247)Active Internet connections (only servers)Proto Recv-Q Send-Q Local Address Foreign Address State tcp 0 0 0.0.0.0:3306 0.0.0.0:* LISTEN tcp 0 0 0.0.0.0:80 0.0.0.0:* LISTEN tcp 0 0 0.0.0.0:22 0.0.0.0:* LISTEN tcp6 0 0 :::22 :::* LISTEN Install lnmp V1.4 completed! enjoy it. ç®€å•è¯´æ˜ä¸€ä¸‹ï¼Œæ­¤å®‰è£…è¿‡ç¨‹å®‰è£…å®Œæˆä¾¿ä¹Ÿå¯åŠ¨äº†nginxï¼Œmysqlï¼Œphp-fpmå¹¶åŠ å…¥äº†å¼€æœºå¯åŠ¨é¡¹ã€‚å¦‚æœé‡å¯æœåŠ¡å™¨ï¼Œä¸éœ€è¦å†å•ç‹¬æ‰‹åŠ¨å¼€å¯ç›¸å…³çš„æœåŠ¡äº†ã€‚æ€»çš„æ¥è¯´ç›¸å½“æ–¹ä¾¿çš„ã€‚ å…³äºLinuxæœåŠ¡ï¼Œè‡ªå·±ä¹‹å‰åšçš„ç¬”è®°åˆ†äº«ç»™å¤§å®¶ã€‚Linux æœåŠ¡ç®¡ç† è¿™æ—¶å€™ä½ åœ¨æµè§ˆå™¨è¾“å…¥http://IP ä¾‹å¦‚ http://45.32.195.77ä¾¿å¯ä»¥è®¿é—®äº†ã€‚çœ‹åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼š è®¿é—®é¡µé¢ ç½‘ç«™æ ¹ç›®å½•è·¯å¾„/home/wwwroot/default,å¦‚æœåªç”¨æ¥æ”¾ä¸€äº›é™æ€é¡µé¢ï¼Œé‚£ä¹ˆï¼Œç°åœ¨å°±è¶³å¤Ÿäº†ï¼Œç›´æ¥å°†ä½ çš„htmlï¼Œjsï¼Œcssç­‰æ–‡ä»¶ä¸¢è¿›å»å³å¯ã€‚è¿™ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œåœ¨æ­¤ä¸èµ˜è¿°äº†ã€‚ é€€å‡ºä½¿ç”¨ctrl+c å®‰è£…WordPressä¸‹è½½WordPressåŒ… ä¸­æ–‡å®˜æ–¹ç«™ç‚¹è‹±æ–‡å®˜æ–¹ç«™ç‚¹å…·ä½“çš„æ ¹æ®è‡ªå·±çš„éœ€æ±‚é€‰æ‹©ã€‚ä¸‹é¢ä»¥ä¸­æ–‡ç‰ˆä¸ºä¾‹ã€‚å½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯4.7.2 ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬è¿˜æ˜¯åœ¨ç”¨ç«™ç‚¹é»˜è®¤çš„è·¯å¾„ï¼Œä½†æ˜¯æˆ‘ä»¬æŠ•æœºå–å·§ä¸€ä¸‹ã€‚ 1234567891011121314# è¿›å…¥æ ¹ç›®å½•ä¸Šä¸€çº§ç›®å½•cd /home/wwwroot/# å°†defaulté‡å‘½åä¸ºoldmv default old# ä¸‹è½½WordPressåŒ…ä¸­æ–‡ç‰ˆwget https://cn.wordpress.org/wordpress-4.7.2-zh_CN.tar.gz# è§£å‹WordPressåŒ…tar -zxvf wordpress-4.7.2-zh_CN.tar.gz # æŸ¥çœ‹è§£å‹åçš„æ–‡ä»¶å¤¹åï¼Œæ­¤å¤„æ˜¯wordpressï¼Œä¼°è®¡åº”è¯¥éƒ½æ˜¯å§ï¼Œçœ‹çœ‹ä¿é™©å•Š[root@vultr wwwroot]# lsold wordpress wordpress-4.7.2-zh_CN.tar.gz# å°†wordpressé‡å‘½åä¸ºdefaultmv wordpress default# å†æ¬¡æŸ¥çœ‹æ£€éªŒ[root@vultr wwwroot]# lsdefault old wordpress-4.7.2-zh_CN.tar.gz ç»™ç›¸åº”ç›®å½•æˆæƒ 12345# ç›®å½•ä»¥åŠç›®å½•ä¸‹çš„æ–‡ä»¶æˆæƒ[root@vultr wwwroot]# chown -R 755 /home/wwwrootchown: changing ownership of â€˜/home/wwwroot/old/.user.iniâ€™: Operation not permitted# å°†ç›®å½•çš„æ‰€æœ‰è€…åˆ†ç»™wwwç»„ä¸‹çš„wwwç”¨æˆ·ã€‚[root@vultr wwwroot]# chown -R www:www /home/wwwroot/chown: changing ownership of â€˜/home/wwwroot/old/.user.iniâ€™: Operation not permitted å‡ºç°çš„æç¤ºå¤§æ¦‚æ˜¯è¯´æœ‰ä¸€ä¸ªæ–‡ä»¶æ— æ³•æ›´æ”¹ç”¨æˆ·åˆ†ç»„å’Œæƒé™ã€‚ä¸ä¼šå½±å“ä½ çš„wordpressï¼Œå¿½ç•¥å°±å¥½ã€‚ åˆ›å»ºä¸€ä¸ªæ•°æ®åº“wordpress 1234567891011121314151617181920212223242526# ç™»å½•æ•°æ®åº“mysql -u root -p# è¾“å…¥å¯†ç é»˜è®¤çš„è¯å°±æ˜¯rootï¼Œå¦åˆ™å°±æ˜¯ä½ è‡ªå·±ä¹‹å‰è®¾ç½®çš„é‚£ä¸ª# ç™»å½•è¿›æ¥ä¹‹åï¼Œçœ‹åˆ°è¿™æ ·ä¸€äº›ä¸œè¥¿Welcome to the MySQL monitor. Commands end with ; or \\g.Your MySQL connection id is 3Server version: 5.5.53-log Source distributionCopyright (c) 2000, 2016, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respective owners.Type 'help;' or '\\h' for help. Type '\\c' to clear the current input statement.mysql&gt; # ä¸ç”¨ç†ä¼šä¸Šé¢çš„ï¼Œåˆ›å»ºæˆ‘ä»¬çš„æ•°æ®åº“ï¼Œæ¯”å¦‚åå­—ä¸ºwordpressã€‚è®°å¾—åŠ åˆ†å·ã€‚mysql&gt; create database wordpress;# çœ‹ä¸€ä¸‹ï¼Œæœ‰æ²¡æœ‰æˆ‘ä»¬åˆ›å»ºçš„æ•°æ®åº“mysql&gt; show databases;# å¤§æ¦‚çœ‹åˆ°å¦‚ä¸‹å†…å®¹ã€‚æ„å‘³ç€è¿™ä¸€æ­¥ä¹Ÿæ²¡é—®é¢˜ã€‚+--------------------+| Database |+--------------------+| information_schema || mysql || performance_schema || wordpress |+--------------------+4 rows in set (0.01 sec)# é€€å‡ºmysqlexit é…ç½®WordPress è¿™æ—¶å€™åœ¨æ­¤é€šè¿‡æµè§ˆå™¨è®¿é—® http://IP ä¾‹å¦‚ http://45.32.195.77ï¼Œæµè§ˆå™¨å°†è‡ªåŠ¨è·³è½¬åˆ°http://45.32.195.77/wp-admin/setup-config.phpï¼Œè¿™å°±æ˜¯wordpressçš„é…ç½®é¡µé¢äº†ï¼Œçœ‹åˆ°çš„å†…å®¹å¦‚ä¸‹ï¼š è®¿é—®é¡µé¢ ç‚¹å‡»ç°åœ¨å°±å¼€å§‹ã€‚è¿™æ—¶å€™æˆ‘ä»¬çœ‹åˆ°å¦‚ä¸‹é¡µé¢: æ•°æ®åº“é…ç½® æŒ‰ç…§ä¹‹å‰è®¾ç½®çš„ï¼Œè¾“å…¥å¦‚ä¸‹ä¿¡æ¯ã€‚ 12345æ•°æ®åº“åï¼šwordpressç”¨æˆ·åï¼šrootå¯†ç ï¼šrootæ•°æ®åº“ä¸»æœºï¼šlocalhostè¡¨å‰ç¼€ï¼šwp_ ç‚¹å‡»æäº¤ã€‚ æ•°æ®åº“è¿æ¥å®Œæˆ åˆ°è¿™ä¸€æ­¥ï¼ŒåŸºæœ¬ä¸Šå°±æ„å‘³ç€å¤§åŠŸå‘Šæˆäº†ï¼Œå› ä¸ºåè¾¹åŸºæœ¬ä¸ä¼šå‡ºé”™å•¦ã€‚ ç‚¹å‡»è¿›è¡Œå®‰è£…æŒ‰é’®ã€‚å‡ºç°ä¸‹å›¾ï¼š wordpress è®¾ç½® æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚å¡«å†™ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œå¡«å†™å¦‚ä¸‹ï¼š wordpress æˆ‘çš„è®¾ç½® ç‚¹å‡»å®‰è£…WordPressæŒ‰é’®ï¼Œç„¶åç™»å½•è®¾ç½®å•¥çš„çº¯é¡µé¢æ“ä½œå°±ä¸åœ¨è¿™é‡Œè¿‡å¤šä»‹ç»å’¯ã€‚ ä¸»é¡µå¤§æ¦‚æ˜¯è¿™æ ·çš„ åæœŸé—®é¢˜è§£å†³æœ‰é—®é¢˜çš„åé¦ˆåœ¨æ­¤ï¼Œæˆ‘ä¼šè¿›è¡Œè¡¥å……ã€‚ ä¸»é¢˜åªæ˜¾ç¤ºä¸€ä¸ªåŸå› ï¼šphpæ²¡æœ‰æƒé™è¯»å–æ–‡ä»¶ç›®å½•ã€‚ è§£å†³æ–¹æ¡ˆï¼šç¼–è¾‘php.iniæ–‡ä»¶ä¸­çš„disable_functionså­—æ®µï¼Œå°†å…¶ä¸­çš„scandirå»æ‰ã€‚ 123456# ä½¿ç”¨ä¸€é”®å®‰è£…åŒ…å®‰è£…çš„phpçš„é…ç½®æ–‡ä»¶è·¯å¾„å¦‚ä¸‹vi /usr/local/php/etc/php.ini# æŸ¥æ‰¾disable_functionsåœ¨å½“å‰çš„åº•è¡Œæ¨¡å¼ä¸‹è¾“å…¥ /disable_functions,ä¾¿å¯ä»¥æ‰¾åˆ°è¿™æ ·ä¸€è¡Œdisable_functions = passthru,exec,system,chroot,scandir,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru,stream_socket_server# åˆ æ‰å…¶ä¸­çš„scandirï¼Œæ­¤å¤„å¾ˆå®¹æ˜“æä¹±ï¼Œæ‰€ä»¥æœ‰å¿…è¦ä¼šä½¿ç”¨ç¼–è¾‘æ¨¡å¼ï¼Œæ‘iè¿›å…¥ç¼–è¾‘æ¨¡å¼ã€‚å°±å¯ä»¥è¾“å…¥åˆ é™¤äº†ã€‚# é€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œå¹¶ä¿å­˜é€€å‡ºã€‚escé€€å‡ºç¼–è¾‘æ¨¡å¼ï¼Œ:wqä¿å­˜é€€å‡ºã€‚ æ›´å¤šçš„æŒ‡ä»¤çœ‹æˆ‘ä¹‹å‰çš„ä¸€ä¸ªç®€å•çš„å…¥é—¨ç¬”è®°å§ã€‚Linux VIM æ–‡æœ¬ç¼–è¾‘å™¨ ç„¶åè®°å¾—é‡å¯php-fpmæœåŠ¡ 1/etc/init.d/php-fpm restart è¿™æ ·å†åˆ·æ–°ï¼Œå°±ä¼šå‘ç°ä¸»é¢˜ä¸åªæœ‰ä¸€ä¸ªå•¦ã€‚ æ›´å¤šå¦‚æœä½ ä½¿ç”¨MarkDownï¼Œé‚£ä¹ˆè¯·å®‰è£…JetPackæ’ä»¶ï¼Œå¦‚æœä½ éœ€è¦è¯­æ³•é«˜äº®ï¼Œè¯·å®‰è£…Crayon Syntax Highlighterã€‚ ä»¥åå¯èƒ½ä¼šæ·±å…¥ç ”ç©¶ä¸€ä¸‹ï¼Œæœ‰æœºä¼šçš„è¯ä¼šä¸“é—¨å†™ä¸€ç¯‡æ–‡ç« ä»‹ç»WordPressä¸»é¢˜ä¸æ’ä»¶çš„å“ˆã€‚","link":"/2020/09/11/%E6%90%AD%E5%BB%BA%20WordPress%20%E5%8D%9A%E5%AE%A2%E6%95%99%E7%A8%8B%EF%BC%88%E8%B6%85%E8%AF%A6%E7%BB%86%EF%BC%89/"},{"title":"27 HOMEäº‹ä»¶æµç¨‹","text":"ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä»‹ç»äº†androidç³»ç»Ÿçš„æˆªå±äº‹ä»¶ï¼Œç”±äºæˆªå±äº‹ä»¶æ˜¯ä¸€ç§ç³»ç»Ÿå…¨å±€å¤„ç†äº‹ä»¶ï¼Œæ‰€ä»¥äº‹ä»¶çš„å¤„ç†é€»è¾‘ä¸æ˜¯åœ¨Appä¸­æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨PhoneWindowManagerä¸­æ‰§è¡Œã€‚è€Œæœ¬æ–‡æˆ‘ä»¬ç°åœ¨ä¸»è¦è®²è§£androidç³»ç»Ÿä¸­HOMEæŒ‰é”®çš„äº‹ä»¶å¤„ç†ï¼Œå’Œæˆªå±äº‹ä»¶ç±»ä¼¼ï¼Œè¿™é‡Œçš„HOMEæŒ‰é”®ä¹Ÿæ˜¯ç³»ç»Ÿçº§åˆ«çš„æŒ‰é”®äº‹ä»¶ç›‘å¬ï¼Œæ‰€ä»¥å…¶å¤„ç†äº‹ä»¶çš„é€»è¾‘ä¹Ÿåº”è¯¥å’Œæˆªå±äº‹ä»¶å¤„ç†æµç¨‹ç±»ä¼¼ï¼Œä»ä¸Šä¸€ç¯‡æ–‡ç« çš„åˆ†æè¿‡å†²ä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œç³»ç»Ÿçº§åˆ«çš„æŒ‰é”®å¤„ç†é€»è¾‘å…¶å®éƒ½æ˜¯åœ¨PhoneWindowManagerä¸­ï¼Œæ‰€ä»¥HOMEæŒ‰é”®çš„å¤„ç†é€»è¾‘ä¹Ÿæ˜¯åœ¨PhoneWindowManagerçš„dispatchUnhandledKeyæ–¹æ³•ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä»dispatchUnhandleKeyæ–¹æ³•å¼€å§‹åˆ†æHOMEæŒ‰é”®çš„å¤„ç†æµç¨‹ã€‚ å¥½å§æˆ‘ä»¬çœ‹ä¸€ä¸‹PhoneWindowManagerçš„dispatchUnhandleKeyæ–¹æ³•çš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556@Override public KeyEvent dispatchUnhandledKey(WindowState win, KeyEvent event, int policyFlags) { ... KeyEvent fallbackEvent = null; if ((event.getFlags() &amp; KeyEvent.FLAG_FALLBACK) == 0) { final KeyCharacterMap kcm = event.getKeyCharacterMap(); final int keyCode = event.getKeyCode(); final int metaState = event.getMetaState(); final boolean initialDown = event.getAction() == KeyEvent.ACTION_DOWN &amp;&amp; event.getRepeatCount() == 0; // Check for fallback actions specified by the key character map. final FallbackAction fallbackAction; if (initialDown) { fallbackAction = kcm.getFallbackAction(keyCode, metaState); } else { fallbackAction = mFallbackActions.get(keyCode); } if (fallbackAction != null) { if (DEBUG_INPUT) { Slog.d(TAG, &quot;Fallback: keyCode=&quot; + fallbackAction.keyCode + &quot; metaState=&quot; + Integer.toHexString(fallbackAction.metaState)); } final int flags = event.getFlags() | KeyEvent.FLAG_FALLBACK; fallbackEvent = KeyEvent.obtain( event.getDownTime(), event.getEventTime(), event.getAction(), fallbackAction.keyCode, event.getRepeatCount(), fallbackAction.metaState, event.getDeviceId(), event.getScanCode(), flags, event.getSource(), null); if (!interceptFallback(win, fallbackEvent, policyFlags)) { fallbackEvent.recycle(); fallbackEvent = null; } if (initialDown) { mFallbackActions.put(keyCode, fallbackAction); } else if (event.getAction() == KeyEvent.ACTION_UP) { mFallbackActions.remove(keyCode); fallbackAction.recycle(); } } } if (DEBUG_INPUT) { if (fallbackEvent == null) { Slog.d(TAG, &quot;No fallback.&quot;); } else { Slog.d(TAG, &quot;Performing fallback: &quot; + fallbackEvent); } } return fallbackEvent; } é€šè¿‡æŸ¥çœ‹æºç ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹dispatchUnhandledKeyæ–¹æ³•ä¸­è°ƒç”¨çš„interceptFallbackæ–¹æ³•ï¼Œå…³äºHOMEæŒ‰é”®çš„å¤„ç†é€»è¾‘ä¹Ÿæ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä½“ä¸­çš„ï¼Œæ‰€ä»¥ç»§ç»­çœ‹ä¸€ä¸‹interceptFallbackæ–¹æ³•çš„å®ç°ï¼š 1234567891011private boolean interceptFallback(WindowState win, KeyEvent fallbackEvent, int policyFlags) { int actions = interceptKeyBeforeQueueing(fallbackEvent, policyFlags); if ((actions &amp; ACTION_PASS_TO_USER) != 0) { long delayMillis = interceptKeyBeforeDispatching( win, fallbackEvent, policyFlags); if (delayMillis == 0) { return true; } } return false; }é€šè¿‡åˆ†ææºç æˆ‘ä»¬çŸ¥é“å…³äºHOMEæŒ‰é”®çš„å¤„ç†é€»è¾‘ä¸»è¦æ˜¯åœ¨interceptKeyBeforeDispatchingæ–¹æ³•çš„å®ç°çš„ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹interceptKeyBeforeDispatchingæ–¹æ³•çš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889@Override public long interceptKeyBeforeDispatching(WindowState win, KeyEvent event, int policyFlags) { ... // First we always handle the home key here, so applications // can never break it, although if keyguard is on, we do let // it handle it, because that gives us the correct 5 second // timeout. if (keyCode == KeyEvent.KEYCODE_HOME) { // If we have released the home key, and didn't do anything else // while it was pressed, then it is time to go home! if (!down) { cancelPreloadRecentApps(); mHomePressed = false; if (mHomeConsumed) { mHomeConsumed = false; return -1; } if (canceled) { Log.i(TAG, &quot;Ignoring HOME; event canceled.&quot;); return -1; } // If an incoming call is ringing, HOME is totally disabled. // (The user is already on the InCallUI at this point, // and his ONLY options are to answer or reject the call.) TelecomManager telecomManager = getTelecommService(); if (telecomManager != null &amp;&amp; telecomManager.isRinging()) { Log.i(TAG, &quot;Ignoring HOME; there's a ringing incoming call.&quot;); return -1; } // Delay handling home if a double-tap is possible. if (mDoubleTapOnHomeBehavior != DOUBLE_TAP_HOME_NOTHING) { mHandler.removeCallbacks(mHomeDoubleTapTimeoutRunnable); // just in case mHomeDoubleTapPending = true; mHandler.postDelayed(mHomeDoubleTapTimeoutRunnable, ViewConfiguration.getDoubleTapTimeout()); return -1; } handleShortPressOnHome(); return -1; } // If a system window has focus, then it doesn't make sense // right now to interact with applications. WindowManager.LayoutParams attrs = win != null ? win.getAttrs() : null; if (attrs != null) { final int type = attrs.type; if (type == WindowManager.LayoutParams.TYPE_KEYGUARD_SCRIM || type == WindowManager.LayoutParams.TYPE_KEYGUARD_DIALOG || (attrs.privateFlags &amp; PRIVATE_FLAG_KEYGUARD) != 0) { // the &quot;app&quot; is keyguard, so give it the key return 0; } final int typeCount = WINDOW_TYPES_WHERE_HOME_DOESNT_WORK.length; for (int i=0; i&lt;typeCount; i++) { if (type == WINDOW_TYPES_WHERE_HOME_DOESNT_WORK[i]) { // don't do anything, but also don't pass it to the app return -1; } } } // Remember that home is pressed and handle special actions. if (repeatCount == 0) { mHomePressed = true; if (mHomeDoubleTapPending) { mHomeDoubleTapPending = false; mHandler.removeCallbacks(mHomeDoubleTapTimeoutRunnable); handleDoubleTapOnHome(); } else if (mLongPressOnHomeBehavior == LONG_PRESS_HOME_RECENT_SYSTEM_UI || mDoubleTapOnHomeBehavior == DOUBLE_TAP_HOME_RECENT_SYSTEM_UI) { preloadRecentApps(); } } else if ((event.getFlags() &amp; KeyEvent.FLAG_LONG_PRESS) != 0) { if (!keyguardOn) { handleLongPressOnHome(event.getDeviceId()); } } return -1; } // Let the application handle the key. return 0; } è¿™é‡Œæˆ‘ä»¬ä¸»è¦çœ‹ä¸€ä¸‹å¯¹androidç³»ç»ŸHOMEæŒ‰é”®çš„å¤„ç†é€»è¾‘ï¼Œé€šè¿‡åˆ†ææºç æˆ‘ä»¬çŸ¥é“HOMEæŒ‰é”®è¿›å…¥launcherç•Œé¢çš„ä¸»è¦é€»è¾‘æ˜¯åœ¨handleShortPressOnHome();æ–¹æ³•ä¸­æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹handleShortPressOnHomeæ–¹æ³•çš„å®ç°ã€‚ 1234567891011121314private void handleShortPressOnHome() { // Turn on the connected TV and switch HDMI input if we're a HDMI playback device. getHdmiControl().turnOnTv(); // If there's a dream running then use home to escape the dream // but don't actually go home. if (mDreamManagerInternal != null &amp;&amp; mDreamManagerInternal.isDreaming()) { mDreamManagerInternal.stopDream(false /*immediate*/); return; } // Go home! launchHomeFromHotKey(); } å¯ä»¥çœ‹åˆ°åœ¨handleShortPressOnHomeæ–¹æ³•ä¸­è°ƒç”¨äº†launchHomeFromHotKeyæ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„æ³¨é‡Šç”¨äºgo homeï¼Œæ‰€ä»¥ç»§ç»­çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°ï¼š 123void launchHomeFromHotKey() { launchHomeFromHotKey(true /* awakenFromDreams */, true /*respectKeyguard*/); } å¯ä»¥çœ‹åˆ°åœ¨launchHomeFromHotKeyæ–¹æ³•ä¸­æˆ‘ä»¬åˆè°ƒç”¨äº†launchHomeFromHotkeyçš„é‡æ„æ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªé‡æ„æ–¹æ³•çš„å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445void launchHomeFromHotKey(final boolean awakenFromDreams, final boolean respectKeyguard) { if (respectKeyguard) { if (isKeyguardShowingAndNotOccluded()) { // don't launch home if keyguard showing return; } if (!mHideLockScreen &amp;&amp; mKeyguardDelegate.isInputRestricted()) { // when in keyguard restricted mode, must first verify unlock // before launching home mKeyguardDelegate.verifyUnlock(new OnKeyguardExitResult() { @Override public void onKeyguardExitResult(boolean success) { if (success) { try { ActivityManagerNative.getDefault().stopAppSwitches(); } catch (RemoteException e) { } sendCloseSystemWindows(SYSTEM_DIALOG_REASON_HOME_KEY); startDockOrHome(true /*fromHomeKey*/, awakenFromDreams); } } }); return; } } // no keyguard stuff to worry about, just launch home! try { ActivityManagerNative.getDefault().stopAppSwitches(); } catch (RemoteException e) { } if (mRecentsVisible) { // Hide Recents and notify it to launch Home if (awakenFromDreams) { awakenDreams(); } sendCloseSystemWindows(SYSTEM_DIALOG_REASON_HOME_KEY); hideRecentApps(false, true); } else { // Otherwise, just launch Home sendCloseSystemWindows(SYSTEM_DIALOG_REASON_HOME_KEY); startDockOrHome(true /*fromHomeKey*/, awakenFromDreams); } } å¯ä»¥å‘ç°åœ¨æ–¹æ³•ä¸­æˆ‘ä»¬é¦–å…ˆè°ƒç”¨äº†ActivityManagerNative.getDefault().stopAppSwitches();è¯¥æ–¹æ³•ä¸»è¦ç”¨äºæš‚åœåå°çš„æ‰“å¼€Activityçš„æ“ä½œï¼Œé¿å…æ‰“æ‰°ç”¨æˆ·çš„æ“ä½œã€‚æ¯”å¦‚è¿™æ—¶å€™æˆ‘ä»¬åœ¨åå°æ‰“å¼€ä¸€ä¸ªæ–°çš„Appï¼Œé‚£ä¹ˆè¿™æ—¶å€™ç”±äºè¦å›åˆ°homeé¡µé¢ï¼Œæ‰€ä»¥éœ€è¦å…ˆå»¶æ—¶æ‰“å¼€ã€‚æ–¹æ³•æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ä¹‹åç„¶åæ‰§è¡Œäº†sendCloseSystemWindowsæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦å®ç°äº†å¯¹å½“å‰ç³»ç»ŸAppé¡µé¢çš„å…³é—­æ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ActivityManagerNative.getDefault().stopAppSwitches();æ–¹æ³•çš„å®ç°ï¼Œè¿™é‡Œçš„ActivityManagerNative.getDefaultæˆ‘ä»¬åœ¨å‰é¢å·²ç»å¤šæ¬¡è¯´è¿‡äº†å…¶æ˜¯ä¸€ä¸ªBinderå¯¹è±¡ï¼Œæ˜¯åº”ç”¨è¿›ç¨‹Binderå®¢æˆ·ç«¯ç”¨äºä¸ActivityManagerServiceä¹‹é—´é€šè®¯ï¼Œæ‰€ä»¥è¿™é‡Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ActivityManagerServiceçš„stopAppsSwitchesæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±ç»§ç»­çœ‹ä¸€ä¸‹ActivityManagerServiceçš„stopAppsSwitchesæ–¹æ³•çš„å®ç°ã€‚ 1234567891011121314151617@Override public void stopAppSwitches() { if (checkCallingPermission(android.Manifest.permission.STOP_APP_SWITCHES) != PackageManager.PERMISSION_GRANTED) { throw new SecurityException(&quot;Requires permission &quot; + android.Manifest.permission.STOP_APP_SWITCHES); } synchronized(this) { mAppSwitchesAllowedTime = SystemClock.uptimeMillis() + APP_SWITCH_DELAY_TIME; mDidAppSwitch = false; mHandler.removeMessages(DO_PENDING_ACTIVITY_LAUNCHES_MSG); Message msg = mHandler.obtainMessage(DO_PENDING_ACTIVITY_LAUNCHES_MSG); mHandler.sendMessageDelayed(msg, APP_SWITCH_DELAY_TIME); } } å¯ä»¥å‘ç°è¿™é‡Œä¸»è¦æ˜¯å‘é€äº†ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œå¹¶ä¸”msg.whatä¸ºDO_PENDING_ACTIVITY_LAUNCHES_MSGï¼Œå³è·³è½¬Activityï¼Œç„¶åæˆ‘ä»¬ç»§ç»­æˆ‘ä»¬çœ‹ä¸€ä¸‹mHandlerçš„handleMessageæ–¹æ³•å½“msg.whatä¸ºDO_PENDING_ACTIVITY_LAUNCHES_MSGæ—¶çš„æ“ä½œã€‚è€Œä¸”æˆ‘ä»¬å¯ä»¥å‘ç°è¿™é‡Œçš„å¼‚æ­¥æ¶ˆæ¯æ˜¯ä¸€ä¸ªå»¶æ—¶çš„å¼‚æ­¥æ¶ˆæ¯ï¼Œå»¶æ—¶çš„æ—¶é—´ä¸ºAPP_SWITCH_DELAY_TIMEï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¯¥å˜é‡çš„å®šä¹‰ï¼š 123// Amount of time after a call to stopAppSwitches() during which we will // prevent further untrusted switches from happening. static final long APP_SWITCH_DELAY_TIME = 5*1000; ç„¶åæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹mHanderçš„handleMessageæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345case DO_PENDING_ACTIVITY_LAUNCHES_MSG: { synchronized (ActivityManagerService.this) { mStackSupervisor.doPendingActivityLaunchesLocked(true); } } break; å¯ä»¥å‘ç°è¿™é‡Œç›´æ¥è°ƒç”¨äº†mStackSupervisor.doPendingActivityLaunchesLockedæ–¹æ³•ï¼Œå¥½å§ï¼Œç»§ç»­çœ‹ä¸€ä¸‹doPendingActivityLaunchesLockedæ–¹æ³•çš„å®ç°ã€‚ 1234567final void doPendingActivityLaunchesLocked(boolean doResume) { while (!mPendingActivityLaunches.isEmpty()) { PendingActivityLaunch pal = mPendingActivityLaunches.remove(0); startActivityUncheckedLocked(pal.r, pal.sourceRecord, null, null, pal.startFlags, doResume &amp;&amp; mPendingActivityLaunches.isEmpty(), null, null); } } å¯ä»¥å‘ç°è¿™é‡Œå°±æ˜¯è°ƒç”¨äº†startActivityçš„æ“ä½œäº†ï¼Œçœ‹è¿‡Activityå¯åŠ¨æµç¨‹çš„åŒå­¦åº”è¯¥çŸ¥é“ï¼šandroidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹ è¿™é‡Œå°±æ˜¯å¼€å§‹å¯åŠ¨Activityäº†ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬æŒ‰ä¸‹HOMEæŒ‰é”®çš„æ—¶å€™ï¼Œåå°çš„startActivityéƒ½ä¼šå»¶æ—¶5ç§’é’Ÿæ‰§è¡Œâ€¦ ç„¶åå›åˆ°æˆ‘ä»¬çš„launchHomeFromHotKeyæ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹launchHomeFromHotKeyæ–¹æ³•çš„å®ç°ã€‚ 123void sendCloseSystemWindows(String reason) { PhoneWindow.sendCloseSystemWindows(mContext, reason); } å¯ä»¥å‘ç°è¿™é‡Œè°ƒç”¨äº†PhoneWindowçš„é™æ€æ–¹æ³•sendCloseSystemWindow,ç»§ç»­çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 12345678public static void sendCloseSystemWindows(Context context, String reason) { if (ActivityManagerNative.isSystemReady()) { try { ActivityManagerNative.getDefault().closeSystemDialogs(reason); } catch (RemoteException e) { } } } çœ‹åˆ°è¿™é‡Œï¼Œå¾ˆæ˜æ˜¾äº†åˆæ˜¯è°ƒç”¨äº†Binderçš„è¿›ç¨‹é—´é€šè®¯ï¼Œæœ€ç»ˆActivityManagerServiceçš„closeSystemDialogsæ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ActivityManagerServiceçš„closeSystemDialogsæ–¹æ³•çš„å®ç°ã€‚ 12345678910111213141516171819202122232425262728@Override public void closeSystemDialogs(String reason) { enforceNotIsolatedCaller(&quot;closeSystemDialogs&quot;); final int pid = Binder.getCallingPid(); final int uid = Binder.getCallingUid(); final long origId = Binder.clearCallingIdentity(); try { synchronized (this) { // Only allow this from foreground processes, so that background // applications can't abuse it to prevent system UI from being shown. if (uid &gt;= Process.FIRST_APPLICATION_UID) { ProcessRecord proc; synchronized (mPidsSelfLocked) { proc = mPidsSelfLocked.get(pid); } if (proc.curRawAdj &gt; ProcessList.PERCEPTIBLE_APP_ADJ) { Slog.w(TAG, &quot;Ignoring closeSystemDialogs &quot; + reason + &quot; from background process &quot; + proc); return; } } closeSystemDialogsLocked(reason); } } finally { Binder.restoreCallingIdentity(origId); } } å¯ä»¥å‘ç°å…¶å®åœ¨æ–¹æ³•ä½“ä¸­å°†å…³é—­çª—å£çš„é€»è¾‘ä¸‹å‘åˆ°äº†closeSystemDialogsLockedä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹closeSystemDialogsLockedæ–¹æ³•çš„å®ç°ã€‚ 123456789101112131415void closeSystemDialogsLocked(String reason) { Intent intent = new Intent(Intent.ACTION_CLOSE_SYSTEM_DIALOGS); intent.addFlags(Intent.FLAG_RECEIVER_REGISTERED_ONLY | Intent.FLAG_RECEIVER_FOREGROUND); if (reason != null) { intent.putExtra(&quot;reason&quot;, reason); } mWindowManager.closeSystemDialogs(reason); mStackSupervisor.closeSystemDialogsLocked(); broadcastIntentLocked(null, null, intent, null, null, 0, null, null, null, AppOpsManager.OP_NONE, null, false, false, -1, Process.SYSTEM_UID, UserHandle.USER_ALL); } å¯ä»¥å‘ç°åœ¨æ–¹æ³•ä½“ä¸­é¦–å…ˆè°ƒç”¨äº†mWindowManager.closeSystemDialogsæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°±æ˜¯å…³é—­å½“å‰é¡µé¢ä¸­å­˜åœ¨çš„ç³»ç»Ÿçª—å£ï¼Œæ¯”å¦‚è¾“å…¥æ³•ï¼Œå£çº¸ç­‰ï¼š 12345678910111213141516171819@Override public void closeSystemDialogs(String reason) { synchronized(mWindowMap) { final int numDisplays = mDisplayContents.size(); for (int displayNdx = 0; displayNdx &lt; numDisplays; ++displayNdx) { final WindowList windows = mDisplayContents.valueAt(displayNdx).getWindowList(); final int numWindows = windows.size(); for (int winNdx = 0; winNdx &lt; numWindows; ++winNdx) { final WindowState w = windows.get(winNdx); if (w.mHasSurface) { try { w.mClient.closeSystemDialogs(reason); } catch (RemoteException e) { } } } } } } è®²è¿‡è¿™æ ·ä¸€å±‚æ“ä½œä¹‹åï¼Œæˆ‘ä»¬å°±å…³é—­äº†å½“å‰ä¸­å­˜åœ¨çš„ç³»ç»Ÿçª—å£ã€‚ç„¶åè¿˜æ˜¯å›åˆ°æˆ‘ä»¬çš„launchHomeFromHotKeyæ–¹æ³•ï¼Œæˆ‘ä»¬å‘ç°åœ¨æ–¹æ³•ä½“çš„æœ€åæˆ‘ä»¬è°ƒç”¨äº†startDockOrHomeæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å®é™…çš„è·³è½¬HOMEé¡µé¢çš„æ–¹æ³•äº†ï¼Œæˆ‘ä»¬å¯ä»¥å…·ä½“çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°ã€‚ 12345678910111213141516171819202122232425262728void startDockOrHome(boolean fromHomeKey, boolean awakenFromDreams) { if (awakenFromDreams) { awakenDreams(); } Intent dock = createHomeDockIntent(); if (dock != null) { try { if (fromHomeKey) { dock.putExtra(WindowManagerPolicy.EXTRA_FROM_HOME_KEY, fromHomeKey); } startActivityAsUser(dock, UserHandle.CURRENT); return; } catch (ActivityNotFoundException e) { } } Intent intent; if (fromHomeKey) { intent = new Intent(mHomeIntent); intent.putExtra(WindowManagerPolicy.EXTRA_FROM_HOME_KEY, fromHomeKey); } else { intent = mHomeIntent; } startActivityAsUser(intent, UserHandle.CURRENT); } å¯ä»¥å‘ç°æˆ‘ä»¬åœ¨æ–¹æ³•ä½“ä¸­è°ƒç”¨äº†createHomeDockIntentï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯åˆ›å»ºåˆ°è¾¾HOMEé¡µé¢çš„Intentå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨äº†startActivityAsUseræ–¹æ³•ï¼Œè¿™æ ·ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ä¹‹åå°±è°ƒèµ·äº†homeé¡µé¢çš„Activityï¼Œæ‰€ä»¥è¿™æ—¶å€™ç³»ç»Ÿå°±è¿”å›åˆ°äº†HOMEé¡µé¢ã€‚ æ€»ç»“ï¼š ç³»ç»Ÿä¹Ÿæ˜¯åœ¨PhoneWindowManagerä¸­ç›‘å¬HOMEæŒ‰é”®çš„ç‚¹å‡»å¹¶è¿›è¡Œå¤„ç†ï¼› ç³»ç»Ÿç›‘å¬åˆ°HOMEæŒ‰é”®ä¹‹åä¼šé¦–å…ˆå…³é—­ç›¸åº”çš„ç³»ç»Ÿå¼¹çª—ï¼› é€šè¿‡åˆ›å»ºIntentå¯¹è±¡ï¼Œå¹¶è°ƒç”¨startActivityæ–¹æ³•ä½¿ç³»ç»Ÿè·³è½¬åˆ°HOMEé¡µé¢ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåäºŒï¼‰â€“&gt;ToaståŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸‰ï¼‰â€“&gt;Androidå¼‚å¸¸å¤„ç†æµç¨‹androidæºç è§£æï¼ˆäºŒåå››ï¼‰â€“&gt;onSaveInstanceStateæ‰§è¡Œæ—¶æœºandroidæºç è§£æï¼ˆäºŒåäº”ï¼‰â€“&gt;onLowMemoryæ‰§è¡Œæµç¨‹androidæºç è§£æï¼ˆäºŒåå…­ï¼‰â€“&gt;æˆªå±äº‹ä»¶æµç¨‹","link":"/2020/09/11/HOME%E4%BA%8B%E4%BB%B6%E6%B5%81%E7%A8%8B/"},{"title":"20 Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹","text":"ä¸Šå‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åˆ†æäº†Dialogçš„åŠ è½½ç»˜åˆ¶æµç¨‹ï¼Œä¹Ÿåˆ†æäº†Acvityiçš„åŠ è½½ç»˜åˆ¶æµç¨‹ï¼Œè¯´ç™½äº†Androidç³»ç»Ÿä¸­çª—å£çš„å±•ç¤ºéƒ½æ˜¯é€šè¿‡Windowå¯¹è±¡æ§åˆ¶ï¼Œé€šè¿‡ViewRootImplå¯¹è±¡æ‰§è¡Œç»˜åˆ¶æ“ä½œæ¥å®Œæˆçš„ï¼Œé‚£ä¹ˆçª—å£çš„å–æ¶ˆç»˜åˆ¶æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„å‘¢ï¼Ÿè¿™ç¯‡æ–‡ç« å°±ä»¥Dialogä¸ºä¾‹è¯´æ˜Windowçª—å£æ˜¯å¦‚ä½•å–æ¶ˆç»˜åˆ¶çš„ã€‚ æœ‰çš„åŒå­¦å¯èƒ½ä¼šé—®å‰å‡ ç¯‡æ–‡ç« ä»‹ç»Activityçš„åŠ è½½ç»˜åˆ¶æµç¨‹çš„æ—¶å€™ä¸ºä½•æ²¡æœ‰è®²Activityçš„çª—å£å–æ¶ˆæµç¨‹ï¼Œè¿™é‡Œè¯´æ˜ä¸€ä¸‹ã€‚é‚£æ˜¯å› ä¸ºå½“æ—¶è¯´æ˜çš„é‡ç‚¹æ˜¯Activityçš„åŠ è½½ä¸ç»˜åˆ¶æµç¨‹ï¼Œè€Œå–æ¶ˆç»˜åˆ¶æµç¨‹ç”±äºæ··æ‚åœ¨Activityçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¯èƒ½ä¸å¤ªæ˜æ˜¾ï¼Œæ‰€ä»¥è¿™é‡Œå°†Windowçª—å£çš„å–æ¶ˆç»˜åˆ¶æµç¨‹æ”¾åœ¨Dialogä¸­ï¼Œå…¶å®ä»–ä»¬çš„å–æ¶ˆç»˜åˆ¶æµç¨‹éƒ½æ˜¯ç›¸ä¼¼çš„ï¼Œçœ‹å®ŒDialogçš„å–æ¶ˆç»˜åˆ¶æµç¨‹ä¹‹åï¼Œå†çœ‹ä¸€ä¸‹Activityçš„å–æ¶ˆç»˜åˆ¶æµç¨‹å°±å¾ˆç®€å•äº†ã€‚ è¿˜è®°å¾—æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« å…³äºDialogçš„ä¾‹å­ä¹ˆï¼Ÿæˆ‘ä»¬é€šè¿‡AlertDialog.Builderåˆ›å»ºäº†ä¸€ä¸ªAlertDialogï¼Œå¹¶é€šè¿‡Activityä¸­çš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶æ¥æ˜¾ç¤ºè¿™ä¸ªAlertDialogï¼Œè€Œåœ¨AlertDialogä¸­å®šä¹‰äº†ä¸€ä¸ªâ€œçŸ¥é“äº†â€æŒ‰é’®ï¼Œç‚¹å‡»è¿™ä¸ªæŒ‰é’®å°±ä¼šè§¦å‘alertDialog.cancelæ–¹æ³•ï¼Œé€šè¿‡æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬çš„alertDialogå°±ä¸åœ¨æ˜¾ç¤ºäº†ï¼Œå¾ˆæ˜æ˜¾çš„ï¼Œcancelæ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­å°±æ‰§è¡Œäº†å–æ¶ˆç»˜åˆ¶çš„é€»è¾‘ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹æˆ‘ä»¬çš„ä¾‹å­æ ¸å¿ƒä»£ç ï¼š 123456789101112131415161718title.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { AlertDialog.Builder builder = new AlertDialog.Builder(MainActivity.this.getApplication()); builder.setIcon(R.mipmap.ic_launcher); builder.setMessage(&quot;this is the content view!!!&quot;); builder.setTitle(&quot;this is the title view!!!&quot;); builder.setView(R.layout.activity_second); builder.setPositiveButton(&quot;çŸ¥é“äº†&quot;, new DialogInterface.OnClickListener() { @Override public void onClick(DialogInterface dialog, int which) { alertDialog.cannel(); } }); alertDialog = builder.create(); alertDialog.show(); } }); è¿™é‡Œçš„titleå°±æ˜¯æˆ‘ä»¬è‡ªå·±çš„Activityä¸­çš„ä¸€ä¸ªTextViewï¼Œé€šè¿‡æ³¨å†Œè¿™ä¸ªTextViewçš„ç‚¹å‡»äº‹ä»¶ï¼Œæ¥æ˜¾ç¤ºä¸€ä¸ªAlertDialogï¼Œé€šè¿‡æ³¨å†ŒAlertDialogä¸­æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œæ‰§è¡ŒalertDialogçš„cancelæ–¹æ³•ã€‚ å¥½å§ï¼Œçœ‹ä¸€ä¸‹Dialogçš„cannelæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678public void cancel() { if (!mCanceled &amp;&amp; mCancelMessage != null) { mCanceled = true; // Obtain a new message so this dialog can be re-used Message.obtain(mCancelMessage).sendToTarget(); } dismiss(); } å¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“ä¸­ï¼Œè‹¥å½“å‰Dialogæ²¡æœ‰å–æ¶ˆï¼Œå¹¶ä¸”è®¾ç½®äº†å–æ¶ˆmessageï¼Œåˆ™è°ƒç”¨Message.obtain(mCancel).sendToTarget()ï¼Œå‰é¢å·²ç»åˆ†æè¿‡è¿™é‡Œçš„sendToTargetæ–¹æ³•ä¼šå›è°ƒæˆ‘ä»¬æ³¨å†Œçš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†é€»è¾‘ï¼š 123456789101112public void setOnCancelListener(final OnCancelListener listener) { if (mCancelAndDismissTaken != null) { throw new IllegalStateException( &quot;OnCancelListener is already taken by &quot; + mCancelAndDismissTaken + &quot; and can not be replaced.&quot;); } if (listener != null) { mCancelMessage = mListenersHandler.obtainMessage(CANCEL, listener); } else { mCancelMessage = null; } }å¯ä»¥çœ‹åˆ°å¦‚æœæˆ‘ä»¬åœ¨åˆå§‹åŒ–AlertDialog.Builderæ—¶ï¼Œè®¾ç½®äº†setOnCancelListenerï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±ä¼šæ‰§è¡ŒmListenersHandlerçš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†ï¼Œå¥½å§ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹mListenersHandlerçš„å®šä¹‰ï¼š 12345678910111213141516171819202122private static final class ListenersHandler extends Handler { private WeakReference&lt;DialogInterface&gt; mDialog; public ListenersHandler(Dialog dialog) { mDialog = new WeakReference&lt;DialogInterface&gt;(dialog); } @Override public void handleMessage(Message msg) { switch (msg.what) { case DISMISS: ((OnDismissListener) msg.obj).onDismiss(mDialog.get()); break; case CANCEL: ((OnCancelListener) msg.obj).onCancel(mDialog.get()); break; case SHOW: ((OnShowListener) msg.obj).onShow(mDialog.get()); break; } } } å¥½å§ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯è®¾ç½®çš„OnCancelListenerçš„onCancelæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è°ƒç”¨dialog.cancelæ–¹æ³•æ—¶é¦–å…ˆä¼šåˆ¤æ–­dialogæ˜¯å¦è°ƒç”¨äº†setOnCancelListenerè‹¥è®¾ç½®äº†ï¼Œåˆ™å…ˆè°ƒç”¨OnCancelListenerçš„onCancelæ–¹æ³•ï¼Œç„¶åå†æ¬¡æ‰§è¡Œdismissæ–¹æ³•ï¼Œè‹¥æˆ‘ä»¬æ²¡æœ‰ä¸ºDialog.Builderè®¾ç½®OnCancelListeneré‚£ä¹ˆcancelæ–¹æ³•å’Œdismissæ–¹æ³•æ˜¯ç­‰æ•ˆçš„ã€‚ è¿™æ ·ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹dismissæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 1234567public void dismiss() { if (Looper.myLooper() == mHandler.getLooper()) { dismissDialog(); } else { mHandler.post(mDismissAction); } } å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œé¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹çš„Looperæ˜¯å¦æ˜¯ä¸»çº¿ç¨‹çš„Looperï¼ˆç”±äºmHandleræ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„ï¼Œæ‰€ä»¥mHandler.getLooperè¿”å›çš„æ˜¯ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„Looperå¯¹è±¡ï¼‰ï¼Œè‹¥æ˜¯çš„è¯ï¼Œåˆ™ç›´æ¥æ‰§è¡ŒdismissDialog()æ–¹æ³•ï¼Œå¦åˆ™çš„è¯ï¼Œé€šè¿‡mHandlerå‘é€å¼‚æ­¥æ¶ˆæ¯è‡³ä¸»çº¿ç¨‹ä¸­ï¼Œç®€å•æ¥è¯´å°±æ˜¯åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸»çº¿ç¨‹ï¼Œè‹¥æ˜¯ä¸»çº¿ç¨‹åˆ™æ‰§è¡ŒdismissDialogæ–¹æ³•å¦åˆ™å‘é€å¼‚æ­¥æ¶ˆæ¯ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹mHandlerå¯¹å¼‚æ­¥æ¶ˆæ¯çš„å¤„ç†æœºåˆ¶ï¼Œç”±äºè¿™é‡Œçš„mDismissActionæ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥çœ‹ä¸€ä¸‹mDismissActionçš„å®šä¹‰ï¼š12345private final Runnable mDismissAction = new Runnable() { public void run() { dismissDialog(); } };å¥½å§ï¼Œè¿™é‡Œçš„å¼‚æ­¥æ¶ˆæ¯æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨çš„dismissDialogæ–¹æ³•ã€‚ã€‚ã€‚ã€‚ æ‰€ä»¥æ— è®ºæˆ‘ä»¬æ‰§è¡Œçš„cancelæ–¹æ³•è¿˜æ˜¯dismissæ–¹æ³•ï¼Œæ— è®ºæˆ‘ä»¬æ–¹æ³•æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œè¿˜æ˜¯å­çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œæœ€ç»ˆè°ƒç”¨çš„éƒ½æ˜¯dismissDialogæ–¹æ³•ï¼Œé‚£ä¹ˆå°±çœ‹ä¸€ä¸‹dismissDialogæ˜¯æ€ä¹ˆä¸ªæ‰§è¡Œé€»è¾‘ã€‚123456789101112131415161718192021222324void dismissDialog() { if (mDecor == null || !mShowing) { return; } if (mWindow.isDestroyed()) { Log.e(TAG, &quot;Tried to dismissDialog() but the Dialog's window was already destroyed!&quot;); return; } try { mWindowManager.removeViewImmediate(mDecor); } finally { if (mActionMode != null) { mActionMode.finish(); } mDecor = null; mWindow.closeAllPanels(); onStop(); mShowing = false; sendDismissMessage(); } }å¥½å§ï¼Œçœ‹æ ·å­ä»£ç è¿˜ä¸æ˜¯ç‰¹åˆ«å¤šï¼Œæ–¹æ³•ä½“ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰çš„mDectoræ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…å½“å‰Dialogæ˜¯å¦åœ¨æ˜¾ç¤ºï¼Œè‹¥ä¸ºç©ºæˆ–è€…æ²¡æœ‰åœ¨æ˜¾ç¤ºï¼Œåˆ™ç›´æ¥returnæ‰ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰æˆ‘ä»¬çš„dialogå·²ç»ä¸å†æ˜¾ç¤ºäº†ï¼Œåˆ™æˆ‘ä»¬ä¸éœ€è¦å¾€ä¸‹åœ¨æ‰§è¡Œã€‚ ç„¶åæˆ‘ä»¬è°ƒç”¨äº†mWindow.isDestroyed()æ–¹æ³•ï¼Œåˆ¤æ–­Windowå¯¹è±¡æ˜¯å¦å·²ç»è¢«é”€æ¯ï¼Œè‹¥å·²ç»è¢«é”€æ¯ï¼Œåˆ™ç›´æ¥returnï¼Œå¹¶æ‰“å°é”™è¯¯æ—¥å¿—ã€‚ ç„¶åæˆ‘ä»¬è°ƒç”¨äº†mWindowManager.removeViewImmediate(mDector)ï¼Œè¿™é‡Œçš„mDectoræ˜¯æˆ‘ä»¬Dialogçª—å£çš„æ ¹å¸ƒå±€ï¼Œçœ‹è¿™ä¸ªæ–¹æ³•çš„åå­—åº”è¯¥å°±æ˜¯Dialogå»é™¤æ ¹å¸ƒå±€çš„æ“ä½œäº†ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ã€‚å‰å‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»åˆ†æè¿‡äº†è¿™é‡Œçš„mWindowManagerå…¶å®æ˜¯WindowManagerImplçš„å®ä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œçš„removeViewImmediateæ–¹æ³•åº”è¯¥æ˜¯WindowManagerImplä¸­çš„æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å…·ä½“å®ç°ï¼š 1234@Override public void removeViewImmediate(View view) { mGlobal.removeView(view, true); } å¯ä»¥å‘ç°ï¼Œè¿™é‡Œå®ƒè°ƒç”¨äº†mGlobal.removeViewæ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„mGlobalæ˜¯WindowManagerGlobalçš„å®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ä»¬å†çœ‹ä¸€ä¸‹WIndowManagerGlobalä¸­removeViewçš„å®ç°é€»è¾‘: 1234567891011121314151617public void removeView(View view, boolean immediate) { if (view == null) { throw new IllegalArgumentException(&quot;view must not be null&quot;); } synchronized (mLock) { int index = findViewLocked(view, true); View curView = mRoots.get(index).getView(); removeViewLocked(index, immediate); if (curView == view) { return; } throw new IllegalStateException(&quot;Calling with view &quot; + view + &quot; but the ViewAncestor is attached to &quot; + curView); } } å¯ä»¥å‘ç°ï¼Œè¿™é‡Œåœ¨è·å–äº†ä¿å­˜çš„mDectorç»„ä»¶ä¹‹åï¼Œåˆè°ƒç”¨äº†removeViewLockedæ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°é€»è¾‘ï¼š 123456789101112131415161718private void removeViewLocked(int index, boolean immediate) { ViewRootImpl root = mRoots.get(index); View view = root.getView(); if (view != null) { InputMethodManager imm = InputMethodManager.getInstance(); if (imm != null) { imm.windowDismissed(mViews.get(index).getWindowToken()); } } boolean deferred = root.die(immediate); if (view != null) { view.assignParent(null); if (deferred) { mDyingViews.add(view); } } } çœ‹åˆ°äº†ä¹ˆï¼Œæˆ‘ä»¬è·å–äº†mDectorç»„ä»¶çš„ViewRootImplï¼Œç„¶åè°ƒç”¨äº†å…¶çš„dieæ–¹æ³•ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•å®ç°Windowç»„ä»¶çš„é”€æ¯æµç¨‹ã€‚ 1234567891011121314151617boolean die(boolean immediate) { // Make sure we do execute immediately if we are in the middle of a traversal or the damage // done by dispatchDetachedFromWindow will cause havoc on return. if (immediate &amp;&amp; !mIsInTraversal) { doDie(); return false; } if (!mIsDrawing) { destroyHardwareRenderer(); } else { Log.e(TAG, &quot;Attempting to destroy the window while drawing!\\n&quot; + &quot; window=&quot; + this + &quot;, title=&quot; + mWindowAttributes.getTitle()); } mHandler.sendEmptyMessage(MSG_DIE); return true; } å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•ä½“ä¸­æœ‰è°ƒç”¨äº†doDieæ–¹æ³•ï¼Œçœ‹åå­—åº”è¯¥å°±æ˜¯çœŸæ­£æ‰§è¡Œwindowé”€æ¯å·¥ä½œçš„æ–¹æ³•äº†ï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹doDieæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839void doDie() { checkThread(); if (LOCAL_LOGV) Log.v(TAG, &quot;DIE in &quot; + this + &quot; of &quot; + mSurface); synchronized (this) { if (mRemoved) { return; } mRemoved = true; if (mAdded) { dispatchDetachedFromWindow(); } if (mAdded &amp;&amp; !mFirst) { destroyHardwareRenderer(); if (mView != null) { int viewVisibility = mView.getVisibility(); boolean viewVisibilityChanged = mViewVisibility != viewVisibility; if (mWindowAttributesChanged || viewVisibilityChanged) { // If layout params have been changed, first give them // to the window manager to make sure it has the correct // animation info. try { if ((relayoutWindow(mWindowAttributes, viewVisibility, false) &amp; WindowManagerGlobal.RELAYOUT_RES_FIRST_TIME) != 0) { mWindowSession.finishDrawing(mWindow); } } catch (RemoteException e) { } } mSurface.release(); } } mAdded = false; } WindowManagerGlobal.getInstance().doRemoveView(this); } å¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“ä¸­ï¼Œé¦–å…ˆè°ƒç”¨äº†checkThreadæ–¹æ³•ï¼Œä»‹ç»Activityçš„ç»˜åˆ¶æµç¨‹çš„æ—¶å€™æœ‰è¿‡ä»‹ç»ï¼Œåˆ¤æ–­å½“å‰æ‰§è¡Œä»£ç çš„çº¿ç¨‹ï¼Œè‹¥ä¸æ˜¯ä¸»çº¿ç¨‹ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼š 123456void checkThread() { if (mThread != Thread.currentThread()) { throw new CalledFromWrongThreadException( &quot;Only the original thread that created a view hierarchy can touch its views.&quot;); } } æˆ‘ä»¬é¡ºç€doDieçš„æ–¹æ³•å¾€ä¸‹çœ‹ï¼Œåˆè°ƒç”¨äº†dispatchDetachedFromWindow()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯é”€æ¯Windowä¸­çš„å„ä¸­æˆå‘˜å˜é‡ï¼Œä¸´æ—¶å˜é‡ç­‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849void dispatchDetachedFromWindow() { if (mView != null &amp;&amp; mView.mAttachInfo != null) { mAttachInfo.mTreeObserver.dispatchOnWindowAttachedChange(false); mView.dispatchDetachedFromWindow(); } mAccessibilityInteractionConnectionManager.ensureNoConnection(); mAccessibilityManager.removeAccessibilityStateChangeListener( mAccessibilityInteractionConnectionManager); mAccessibilityManager.removeHighTextContrastStateChangeListener( mHighContrastTextManager); removeSendWindowContentChangedCallback(); destroyHardwareRenderer(); setAccessibilityFocus(null, null); mView.assignParent(null); mView = null; mAttachInfo.mRootView = null; mSurface.release(); if (mInputQueueCallback != null &amp;&amp; mInputQueue != null) { mInputQueueCallback.onInputQueueDestroyed(mInputQueue); mInputQueue.dispose(); mInputQueueCallback = null; mInputQueue = null; } if (mInputEventReceiver != null) { mInputEventReceiver.dispose(); mInputEventReceiver = null; } try { mWindowSession.remove(mWindow); } catch (RemoteException e) { } // Dispose the input channel after removing the window so the Window Manager // doesn't interpret the input channel being closed as an abnormal termination. if (mInputChannel != null) { mInputChannel.dispose(); mInputChannel = null; } mDisplayManager.unregisterDisplayListener(mDisplayListener); unscheduleTraversals(); } å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åœ¨æ–¹æ³•ä¸­è°ƒç”¨äº†mView.dispatchDetachedFromWindowæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†mViewä»Windowä¸­detachå‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940void dispatchDetachedFromWindow() { AttachInfo info = mAttachInfo; if (info != null) { int vis = info.mWindowVisibility; if (vis != GONE) { onWindowVisibilityChanged(GONE); } } onDetachedFromWindow(); onDetachedFromWindowInternal(); InputMethodManager imm = InputMethodManager.peekInstance(); if (imm != null) { imm.onViewDetachedFromWindow(this); } ListenerInfo li = mListenerInfo; final CopyOnWriteArrayList&lt;OnAttachStateChangeListener&gt; listeners = li != null ? li.mOnAttachStateChangeListeners : null; if (listeners != null &amp;&amp; listeners.size() &gt; 0) { // NOTE: because of the use of CopyOnWriteArrayList, we *must* use an iterator to // perform the dispatching. The iterator is a safe guard against listeners that // could mutate the list by calling the various add/remove methods. This prevents // the array from being modified while we iterate it. for (OnAttachStateChangeListener listener : listeners) { listener.onViewDetachedFromWindow(this); } } if ((mPrivateFlags &amp; PFLAG_SCROLL_CONTAINER_ADDED) != 0) { mAttachInfo.mScrollContainers.remove(this); mPrivateFlags &amp;= ~PFLAG_SCROLL_CONTAINER_ADDED; } mAttachInfo = null; if (mOverlay != null) { mOverlay.getOverlayView().dispatchDetachedFromWindow(); } } å…¶ä¸­onDetachedFromWindowæ–¹æ³•æ˜¯ä¸€ä¸ªç©ºçš„å›è°ƒæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹onDetachedFromWindowInternalæ–¹æ³•ï¼š 12345678910111213141516171819protected void onDetachedFromWindowInternal() { mPrivateFlags &amp;= ~PFLAG_CANCEL_NEXT_UP_EVENT; mPrivateFlags3 &amp;= ~PFLAG3_IS_LAID_OUT; removeUnsetPressCallback(); removeLongPressCallback(); removePerformClickCallback(); removeSendViewScrolledAccessibilityEventCallback(); stopNestedScroll(); // Anything that started animating right before detach should already // be in its final state when re-attached. jumpDrawablesToCurrentState(); destroyDrawingCache(); cleanupDraw(); mCurrentAnimation = null; } onDetachedFromWindowInternalæ–¹æ³•çš„æ–¹æ³•ä½“ä¹Ÿä¸æ˜¯ç‰¹åˆ«é•¿ï¼Œéƒ½æ˜¯ä¸€äº›è°ƒç”¨å‡½æ•°ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹destropDrawingCacheæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯é”€æ¯Viewçš„ç¼“å­˜Drawingï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…·ä½“å®ç°ï¼š 12345678910public void destroyDrawingCache() { if (mDrawingCache != null) { mDrawingCache.recycle(); mDrawingCache = null; } if (mUnscaledDrawingCache != null) { mUnscaledDrawingCache.recycle(); mUnscaledDrawingCache = null; } } è¿™é‡Œçš„mDrawingCacheå…¶å®å°±æ˜¯ä¸€ä¸ªBitmapç±»å‹çš„æˆå‘˜å˜é‡ï¼Œè€Œè¿™é‡Œè°ƒç”¨çš„recyclerå’Œç½®ç©ºæ“ä½œå…¶å®å°±æ˜¯æŠŠViewä¸­æ‰§è¡Œdrawæ–¹æ³•ä¹‹åç¼“å­˜çš„bitmapæ¸…ç©ºã€‚ è¿™é‡Œéœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæˆ‘ä»¬Viewç»„ä»¶çš„æœ€ç»ˆæ˜¾ç¤ºè½å®æ˜¯é€šè¿‡drawæ–¹æ³•å®ç°ç»˜åˆ¶çš„ï¼Œè€Œæˆ‘ä»¬çš„drawæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªCanvasï¼Œè¿™æ˜¯ä¸€ä¸ªç”»å¸ƒçš„å¯¹è±¡ï¼Œé€šè¿‡drawæ–¹æ³•å°±æ˜¯æ“ä½œè¿™ä¸ªå¯¹è±¡å¹¶æ˜¾ç¤ºå‡ºæ¥ï¼Œè€ŒCanvaså¯¹è±¡ä¹‹æ‰€ä»¥èƒ½å¤Ÿå®ç°æ˜¾ç¤ºçš„æ•ˆæœæ˜¯å› ä¸ºå…¶å†…éƒ¨ä¿å­˜ç€ä¸€ä¸ªBitmapå¯¹è±¡ï¼Œé€šè¿‡æ“ä½œCanvaså¯¹è±¡å®è´¨ä¸Šæ˜¯æ“ä½œCanvaså¯¹è±¡å†…éƒ¨çš„Bitmapå¯¹è±¡ï¼Œè€ŒViewç»„ä»¶çš„æ˜¾ç¤ºä¹Ÿå°±æ˜¯é€šè¿‡è¿™é‡Œçš„Bitmapæ¥å®ç°çš„ã€‚ è€Œæˆ‘ä»¬ä¸Šæ–‡ä¸­ç½®ç©ºäº†bitmapå¯¹è±¡å°±ç›¸å½“äºæŠŠViewç»„ä»¶çš„æ˜¾ç¤ºæ•ˆæœç½®ç©ºäº†ï¼Œå°±æ˜¯ç›¸å½“äºæˆ‘ä»¬å–æ¶ˆäº†Viewçš„drawæ–¹æ³•çš„æ‰§è¡Œæ•ˆæœï¼Œç»§ç»­å›åˆ°æˆ‘ä»¬çš„dispatchDetachedFromWindowæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œäº†mView.dispatchDetachedFromWindow()æ–¹æ³•ä¹‹åï¼Œåˆè°ƒç”¨äº†mView = null;æ–¹æ³•ï¼Œè¿™é‡Œè®¾ç½®mViewä¸ºç©ºï¼Œè¿™æ ·æˆ‘ä»¬æœ‰å–æ¶ˆäº†Viewçš„meatureå’Œlayouotçš„æ‰§è¡Œæ•ˆæœã€‚ è¿™æ ·ç»è¿‡ä¸€ç³»åˆ—çš„æ“ä½œä¹‹åæˆ‘ä»¬çš„Dialogçš„å–æ¶ˆç»˜åˆ¶æµç¨‹å°±ç»“æŸäº†ï¼Œç°åœ¨æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Activityçš„å–æ¶ˆç»˜åˆ¶æµç¨‹ã€‚è¿˜è®°å¾—æˆ‘ä»¬â€œActivityçš„é”€æ¯æµç¨‹â€ä¹ˆï¼Ÿå¯å‚è€ƒï¼šandroidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹å½“æˆ‘ä»¬è°ƒç”¨activityçš„finishæ–¹æ³•çš„æ—¶å€™å›è°ƒç”¨ActivityThreadçš„handleDestroyActivityæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š 123456private void handleDestroyActivity(IBinder token, boolean finishing, int configChanges, boolean getNonConfigInstance) { ... wm.removeViewImmediate(v); ... } å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†è¿™é‡Œè°ƒç”¨äº†wm.removeViewImmediateæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸å°±æ˜¯æˆ‘ä»¬åˆšåˆšåˆ†æDialogé”€æ¯ç»˜åˆ¶æµç¨‹çš„èµ·å§‹æ–¹æ³•ä¹ˆï¼Ÿä»¥åçš„é€»è¾‘éƒ½æ˜¯è¯¦ç»†çš„ï¼Œè¿™æ ·æˆ‘ä»¬å°±å®ç°äº†Activityçš„å–æ¶ˆç»˜åˆ¶æµç¨‹ã€‚ æ€»ç»“ï¼š çª—å£çš„å–æ¶ˆç»˜åˆ¶æµç¨‹æ˜¯ç›¸ä¼¼çš„ï¼ŒåŒ…æ‹¬Activityå’ŒDialogç­‰ï¼› é€šè¿‡è°ƒç”¨WindowManager.removeViewImmediateæ–¹æ³•ï¼Œå¼€å§‹æ‰§è¡ŒWindowçª—å£çš„å–æ¶ˆç»˜åˆ¶æµç¨‹ï¼› Windowçª—å£çš„å–æ¶ˆç»˜åˆ¶æµç¨‹ï¼Œé€šè¿‡æ¸…ç©ºbitmaæ’¤é”€drawçš„æ‰§è¡Œæ•ˆæœï¼Œé€šè¿‡ç½®ç©ºViewæ’¤é”€meatureå’Œlayoutçš„æ‰§è¡Œæ•ˆæœï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹","link":"/2020/09/11/Dialog%E5%8F%96%E6%B6%88%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/"},{"title":"10 Launcherå¯åŠ¨æµç¨‹","text":"Launcherç¨‹åºå°±æ˜¯æˆ‘ä»¬å¹³æ—¶çœ‹åˆ°çš„æ¡Œé¢ç¨‹åºï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯ä¸€ä¸ªandroidåº”ç”¨ç¨‹åºï¼Œåªä¸è¿‡è¿™ä¸ªåº”ç”¨ç¨‹åºæ˜¯ç³»ç»Ÿé»˜è®¤ç¬¬ä¸€ä¸ªå¯åŠ¨çš„åº”ç”¨ç¨‹åºï¼Œè¿™é‡Œæˆ‘ä»¬å°±ç®€å•çš„åˆ†æä¸€ä¸‹Launcheråº”ç”¨çš„å¯åŠ¨æµç¨‹ã€‚ ä¸åŒçš„æ‰‹æœºå‚å•†å®šåˆ¶androidæ“ä½œç³»ç»Ÿçš„æ—¶å€™éƒ½ä¼šæ›´æ”¹Launcherçš„æºä»£ç ï¼Œæˆ‘ä»¬è¿™é‡Œä»¥android23çš„æºç ä¸ºä¾‹å¤§è‡´çš„åˆ†æä¸€ä¸‹Launcherçš„å¯åŠ¨æµç¨‹ã€‚ é€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬çŸ¥é“SystemServerè¿›ç¨‹ä¸»è¦ç”¨äºå¯åŠ¨ç³»ç»Ÿçš„å„ç§æœåŠ¡ï¼ŒäºŒè€…å…¶ä¸­å°±åŒ…å«äº†è´Ÿè´£å¯åŠ¨Launcherçš„æœåŠ¡ï¼ŒLauncherAppServiceã€‚å…·ä½“å…³äºSystenServerçš„å¯åŠ¨æµç¨‹å¯ä»¥å‚è§ï¼š androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹ åœ¨SystemServerè¿›ç¨‹çš„å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨å…¶mainé™æ€æ–¹æ³•ï¼Œå¼€å§‹æ‰§è¡Œæ•´ä¸ªSystemServerçš„å¯åŠ¨æµç¨‹ï¼Œåœ¨å…¶ä¸­é€šè¿‡è°ƒç”¨ä¸‰ä¸ªå†…éƒ¨æ–¹æ³•åˆ†åˆ«å¯åŠ¨boot serviceã€core serviceå’Œother serviceã€‚åœ¨è°ƒç”¨startOtherServiceæ–¹æ³•ä¸­å°±ä¼šé€šè¿‡è°ƒç”¨mActivityManagerService.systemReady()æ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130// We now tell the activity manager it is okay to run third party // code. It will call back into us once it has gotten to the state // where third party code can really run (but before it has actually // started launching the initial applications), for us to complete our // initialization. mActivityManagerService.systemReady(new Runnable() { @Override public void run() { Slog.i(TAG, &quot;Making services ready&quot;); mSystemServiceManager.startBootPhase( SystemService.PHASE_ACTIVITY_MANAGER_READY); try { mActivityManagerService.startObservingNativeCrashes(); } catch (Throwable e) { reportWtf(&quot;observing native crashes&quot;, e); } Slog.i(TAG, &quot;WebViewFactory preparation&quot;); WebViewFactory.prepareWebViewInSystemServer(); try { startSystemUi(context); } catch (Throwable e) { reportWtf(&quot;starting System UI&quot;, e); } try { if (networkScoreF != null) networkScoreF.systemReady(); } catch (Throwable e) { reportWtf(&quot;making Network Score Service ready&quot;, e); } try { if (networkManagementF != null) networkManagementF.systemReady(); } catch (Throwable e) { reportWtf(&quot;making Network Managment Service ready&quot;, e); } try { if (networkStatsF != null) networkStatsF.systemReady(); } catch (Throwable e) { reportWtf(&quot;making Network Stats Service ready&quot;, e); } try { if (networkPolicyF != null) networkPolicyF.systemReady(); } catch (Throwable e) { reportWtf(&quot;making Network Policy Service ready&quot;, e); } try { if (connectivityF != null) connectivityF.systemReady(); } catch (Throwable e) { reportWtf(&quot;making Connectivity Service ready&quot;, e); } try { if (audioServiceF != null) audioServiceF.systemReady(); } catch (Throwable e) { reportWtf(&quot;Notifying AudioService running&quot;, e); } Watchdog.getInstance().start(); // It is now okay to let the various system services start their // third party code... mSystemServiceManager.startBootPhase( SystemService.PHASE_THIRD_PARTY_APPS_CAN_START); try { if (wallpaperF != null) wallpaperF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying WallpaperService running&quot;, e); } try { if (immF != null) immF.systemRunning(statusBarF); } catch (Throwable e) { reportWtf(&quot;Notifying InputMethodService running&quot;, e); } try { if (locationF != null) locationF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying Location Service running&quot;, e); } try { if (countryDetectorF != null) countryDetectorF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying CountryDetectorService running&quot;, e); } try { if (networkTimeUpdaterF != null) networkTimeUpdaterF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying NetworkTimeService running&quot;, e); } try { if (commonTimeMgmtServiceF != null) { commonTimeMgmtServiceF.systemRunning(); } } catch (Throwable e) { reportWtf(&quot;Notifying CommonTimeManagementService running&quot;, e); } try { if (textServiceManagerServiceF != null) textServiceManagerServiceF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying TextServicesManagerService running&quot;, e); } try { if (atlasF != null) atlasF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying AssetAtlasService running&quot;, e); } try { // TODO(BT) Pass parameter to input manager if (inputManagerF != null) inputManagerF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying InputManagerService running&quot;, e); } try { if (telephonyRegistryF != null) telephonyRegistryF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying TelephonyRegistry running&quot;, e); } try { if (mediaRouterF != null) mediaRouterF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying MediaRouterService running&quot;, e); } try { if (mmsServiceF != null) mmsServiceF.systemRunning(); } catch (Throwable e) { reportWtf(&quot;Notifying MmsService running&quot;, e); } } });å¯ä»¥å‘ç°è¿™ä¸ªæ–¹æ³•ä¼ é€’äº†ä¸€ä¸ªRunnableå‚æ•°ï¼Œé‡Œé¢æ‰§è¡Œäº†å„ç§å…¶ä»–æœåŠ¡çš„systemReadyæ–¹æ³•ï¼Œè¿™é‡Œä¸æ˜¯æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨ActivityManagerServiceä¸­systemReadyæ–¹æ³•çš„å…·ä½“å®ç°ï¼Œæ–¹æ³•ä½“æ¯”è¾ƒé•¿ï¼Œæˆ‘å°±ä¸åœ¨è¿™é‡Œè´´å‡ºä»£ç äº†ï¼Œä¸»è¦çš„é€»è¾‘å°±æ˜¯åšä¸€äº›ActivityManagerServiceçš„readyæ“ä½œ 1234567public void systemReady(final Runnable goingCallback) { ... // Start up initial activity. mBooting = true; startHomeActivityLocked(mCurrentUserId, &quot;systemReady&quot;); ... } é‡ç‚¹æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä½“ä¸­è°ƒç”¨äº†startHomeActivityLockedæ–¹æ³•ï¼Œçœ‹å…¶åå­—å°±æ˜¯è¯´å¼€å§‹æ‰§è¡Œå¯åŠ¨homeActivityçš„æ“ä½œï¼Œå¥½äº†ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹startHomeActivityLockedçš„å…·ä½“å®ç°ï¼š 12345678910111213141516171819202122232425262728boolean startHomeActivityLocked(int userId, String reason) { if (mFactoryTest == FactoryTest.FACTORY_TEST_LOW_LEVEL &amp;&amp; mTopAction == null) { // We are running in factory test mode, but unable to find // the factory test app, so just sit around displaying the // error message and don't try to start anything. return false; } Intent intent = getHomeIntent(); ActivityInfo aInfo = resolveActivityInfo(intent, STOCK_PM_FLAGS, userId); if (aInfo != null) { intent.setComponent(new ComponentName( aInfo.applicationInfo.packageName, aInfo.name)); // Don't do this if the home app is currently being // instrumented. aInfo = new ActivityInfo(aInfo); aInfo.applicationInfo = getAppInfoForUser(aInfo.applicationInfo, userId); ProcessRecord app = getProcessRecordLocked(aInfo.processName, aInfo.applicationInfo.uid, true); if (app == null || app.instrumentationClass == null) { intent.setFlags(intent.getFlags() | Intent.FLAG_ACTIVITY_NEW_TASK); mStackSupervisor.startHomeActivity(intent, aInfo, reason); } } return true; } é¦–å…ˆæ˜¯è°ƒç”¨getHomeIntent()æ–¹æ³•ï¼Œçœ‹ä¸€ä¸‹getHomeIntentæ˜¯å¦‚ä½•å®ç°æ„é€ Intentå¯¹è±¡çš„ï¼š 12345678Intent getHomeIntent() { Intent intent = new Intent(mTopAction, mTopData != null ? Uri.parse(mTopData) : null); intent.setComponent(mTopComponent); if (mFactoryTest != FactoryTest.FACTORY_TEST_LOW_LEVEL) { intent.addCategory(Intent.CATEGORY_HOME); } return intent; } å¯ä»¥å‘ç°ï¼Œå¯åŠ¨Launcherçš„Intentå¯¹è±¡ä¸­æ·»åŠ äº†Intent.CATEGORY_HOMEå¸¸é‡ï¼Œè¿™ä¸ªå…¶å®æ˜¯ä¸€ä¸ªlauncherçš„æ ‡å¿—ï¼Œä¸€èˆ¬ç³»ç»Ÿçš„å¯åŠ¨é¡µé¢Activityéƒ½ä¼šåœ¨androidmanifest.xmlä¸­é…ç½®è¿™ä¸ªæ ‡å¿—ã€‚æ¯”å¦‚æˆ‘ä»¬åœ¨githubä¸­çš„android launcheræºç ä¸­æŸ¥çœ‹å…¶androidmanifest.xmlæ–‡ä»¶ï¼šå¯ä»¥å‘ç°å…¶Activityçš„å®šä¹‰intentfilterä¸­å°±æ˜¯å®šä¹‰äº†è¿™æ ·çš„categoryã€‚ä¸åŒçš„æ‰‹æœºå‚å•†å¯èƒ½ä¼šä¿®æ”¹Launcherçš„æºç ï¼Œä½†æ˜¯è¿™ä¸ªcategoryä¸€èˆ¬æ˜¯ä¸ä¼šæ›´æ”¹çš„ã€‚ ç»§ç»­å›åˆ°æˆ‘ä»¬çš„startHomeActivityLockedæ–¹æ³•ï¼Œæˆ‘ä»¬å‘ç°ç»è¿‡ä¸€ç³»åˆ—çš„åˆ¤æ–­é€»è¾‘ä¹‹åæœ€åè°ƒç”¨äº†mStackSupervisor.startHomeActivityæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å…·ä½“å®ç°é€»è¾‘ï¼š 12345678910111213141516void startHomeActivity(Intent intent, ActivityInfo aInfo, String reason) { moveHomeStackTaskToTop(HOME_ACTIVITY_TYPE, reason); startActivityLocked(null /* caller */, intent, null /* resolvedType */, aInfo, null /* voiceSession */, null /* voiceInteractor */, null /* resultTo */, null /* resultWho */, 0 /* requestCode */, 0 /* callingPid */, 0 /* callingUid */, null /* callingPackage */, 0 /* realCallingPid */, 0 /* realCallingUid */, 0 /* startFlags */, null /* options */, false /* ignoreTargetSecurity */, false /* componentSpecified */, null /* outActivity */, null /* container */, null /* inTask */); if (inResumeTopActivity) { // If we are in resume section already, home activity will be initialized, but not // resumed (to avoid recursive resume) and will stay that way until something pokes it // again. We need to schedule another resume. scheduleResumeTopActivities(); } } å‘ç°å…¶è°ƒç”¨çš„æ˜¯scheduleResumeTopActivities()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®æ˜¯å…³äºActivityçš„å¯åŠ¨æµç¨‹çš„é€»è¾‘äº†ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸åœ¨è¯¦ç»†çš„è¯´æ˜ï¼Œå…³äºActivityçš„å¯åŠ¨æµç¨‹æˆ‘ä»¬åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­ä¼šä»‹ç»ã€‚ å› ä¸ºæˆ‘ä»¬çš„Launcherå¯åŠ¨çš„Intentæ˜¯ä¸€ä¸ªéšå£«çš„Intentï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå¯åŠ¨åœ¨androidmanifest.xmlä¸­é…ç½®äº†ç›¸åŒcatogoryçš„activityï¼Œandroid Mä¸­é…ç½®çš„è¿™ä¸ªcatogoryå°±æ˜¯LauncherActivityã€‚ LauncherActivityç»§æ‰¿ä¸ListActivityï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶Layoutå¸ƒå±€æ–‡ä»¶ï¼š 12345678910111213141516171819202122&lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; &gt; &lt;ListView android:id=&quot;@android:id/list&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; /&gt; &lt;TextView android:id=&quot;@android:id/empty&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:gravity=&quot;center&quot; android:text=&quot;@string/activity_list_empty&quot; android:visibility=&quot;gone&quot; android:textAppearance=&quot;?android:attr/textAppearanceMedium&quot; /&gt;&lt;/FrameLayout&gt; å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç°å®çš„æ¡Œé¢å…¶å®å°±æ˜¯ä¸€ä¸ªListViewæ§ä»¶ï¼Œç„¶åçœ‹ä¸€ä¸‹å…¶onCreateæ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728@Override protected void onCreate(Bundle icicle) { super.onCreate(icicle); mPackageManager = getPackageManager(); if (!mPackageManager.hasSystemFeature(PackageManager.FEATURE_WATCH)) { requestWindowFeature(Window.FEATURE_INDETERMINATE_PROGRESS); setProgressBarIndeterminateVisibility(true); } onSetContentView(); mIconResizer = new IconResizer(); mIntent = new Intent(getTargetIntent()); mIntent.setComponent(null); mAdapter = new ActivityAdapter(mIconResizer); setListAdapter(mAdapter); getListView().setTextFilterEnabled(true); updateAlertTitle(); updateButtonText(); if (!mPackageManager.hasSystemFeature(PackageManager.FEATURE_WATCH)) { setProgressBarIndeterminateVisibility(false); } } å¯ä»¥çœ‹åˆ°åœ¨LauncherActivityçš„onCreateæ–¹æ³•ä¸­åˆå§‹åŒ–äº†ä¸€ä¸ªPackageManagerï¼Œå…¶ä¸»è¦ä½œç”¨å°±æ˜¯ä»ä¸­æŸ¥è¯¢å‡ºç³»ç»Ÿæ‰€æœ‰å·²ç»å®‰è£…çš„åº”ç”¨åˆ—è¡¨ï¼Œåº”ç”¨åŒ…åï¼Œåº”ç”¨å›¾æ ‡ç­‰ä¿¡æ¯ã€‚ç„¶åå°†è¿™äº›ä¿¡æ¯æ³¨å…¥åˆ°Adapterä¸­ï¼Œè¿™æ ·å°±å¯ä»¥å°†ç³»ç»Ÿåº”ç”¨å›¾æ ‡å’Œåç§°æ˜¾ç¤ºå‡ºæ¥äº†ã€‚åœ¨ç³»ç»Ÿçš„å›è°ƒæ–¹æ³•onListItemClickä¸­ 12345@Override protected void onListItemClick(ListView l, View v, int position, long id) { Intent intent = intentForPosition(position); startActivity(intent); } è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ç‚¹å‡»äº†æŸä¸€ä¸ªåº”ç”¨å›¾æ ‡ä¹‹åå¯ä»¥å¯åŠ¨æŸä¸€é¡¹åº”ç”¨çš„åŸå› äº†ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™é‡Œçš„intentForPositionæ˜¯å¦‚ä½•å®ç°çš„ã€‚ 1234protected Intent intentForPosition(int position) { ActivityAdapter adapter = (ActivityAdapter) mAdapter; return adapter.intentForPosition(position); } è¿™é‡Œåˆè°ƒç”¨äº†adapterçš„intentForPositionæ–¹æ³•ï¼š 12345678910111213public Intent intentForPosition(int position) { if (mActivitiesList == null) { return null; } Intent intent = new Intent(mIntent); ListItem item = mActivitiesList.get(position); intent.setClassName(item.packageName, item.className); if (item.extras != null) { intent.putExtras(item.extras); } return intent; } å¯ä»¥çœ‹åˆ°ç”±äºadapterçš„æ¯ä¸€é¡¹ä¸­éƒ½ä¿å­˜äº†åº”ç”¨çš„åŒ…åå¯å¯åŠ¨Activityåç§°ï¼Œæ‰€ä»¥è¿™é‡Œåœ¨åˆå§‹åŒ–Intentçš„æ—¶å€™ï¼Œç›´æ¥å°†è¿™äº›ä¿¡æ¯æ³¨å…¥åˆ°Intentä¸­ï¼Œç„¶åè°ƒç”¨startActivityï¼Œå°±å°†è¿™äº›åº”ç”¨å¯åŠ¨äº†ï¼ˆå…³äºstartActivityæ˜¯å¦‚ä½•å¯åŠ¨çš„ä¸‹é¢çš„æ–‡ç« ä¸­æˆ‘å°†ä»‹ç»ï¼‰ã€‚ æ€»ç»“ï¼š Launcherçš„å¯åŠ¨æµç¨‹ Zygoteè¿›ç¨‹ â€“&gt; SystemServerè¿›ç¨‹ â€“&gt; startOtherServiceæ–¹æ³• â€“&gt; ActivityManagerServiceçš„systemReadyæ–¹æ³• â€“&gt; startHomeActivityLockedæ–¹æ³• â€“&gt; ActivityStackSupervisorçš„startHomeActivityæ–¹æ³• â€“&gt; æ‰§è¡ŒActivityçš„å¯åŠ¨é€»è¾‘ï¼Œæ‰§è¡ŒscheduleResumeTopActivities()æ–¹æ³•ã€‚ã€‚ã€‚ã€‚ å› ä¸ºæ˜¯éšå£«çš„å¯åŠ¨Activityï¼Œæ‰€ä»¥å¯åŠ¨çš„Activityå°±æ˜¯åœ¨AndroidManifest.xmlä¸­é…ç½®catogeryçš„å€¼ä¸ºï¼š 1public static final String CATEGORY_HOME = &quot;android.intent.category.HOME&quot;; å¯ä»¥å‘ç°android Mä¸­åœ¨androidManifest.xmlä¸­é…ç½®äº†è¿™ä¸ªcatogoryçš„activityæ˜¯LauncherActivityï¼Œæ‰€ä»¥æˆ‘ä»¬å°±å¯ä»¥å°†è¿™ä¸ªLauncherå¯åŠ¨èµ·æ¥äº† LauncherActivityä¸­æ˜¯ä»¥ListViewæ¥æ˜¾ç¤ºæˆ‘ä»¬çš„åº”ç”¨å›¾æ ‡åˆ—è¡¨çš„ï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ªItemä¿å­˜äº†åº”ç”¨çš„åŒ…åå’Œå¯åŠ¨Activityç±»åï¼Œè¿™æ ·ç‚¹å‡»æŸä¸€é¡¹åº”ç”¨å›¾æ ‡çš„æ—¶å€™å°±å¯ä»¥æ ¹æ®åº”ç”¨åŒ…åå’Œå¯åŠ¨Activityåç§°å¯åŠ¨æˆ‘ä»¬çš„Appäº†ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹","link":"/2020/09/11/Launcher%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"title":"MacOSå¿«æ·é”®è¯´æ˜","text":"æ‚¨å¯ä»¥æŒ‰ä¸‹æŸäº›ç»„åˆé”®æ¥å®ç°é€šå¸¸éœ€è¦é¼ æ ‡ã€è§¦æ§æ¿æˆ–å…¶ä»–è¾“å…¥è®¾å¤‡æ‰èƒ½å®Œæˆçš„æ“ä½œã€‚ è¦ä½¿ç”¨é”®ç›˜å¿«æ·é”®ï¼Œè¯·æŒ‰ä½ä¸€ä¸ªæˆ–å¤šä¸ªä¿®é¥°é”®ï¼Œç„¶åæŒ‰å¿«æ·é”®çš„æœ€åä¸€ä¸ªé”®ã€‚ä¾‹å¦‚ï¼Œè¦ä½¿ç”¨ Command-Cï¼ˆæ‹·è´ï¼‰ï¼Œè¯·æŒ‰ä½ Command é”®å¹¶æŒ‰ C é”®ï¼Œç„¶ååŒæ—¶æ¾å¼€è¿™ä¸¤ä¸ªé”®ã€‚Mac èœå•å’Œé”®ç›˜é€šå¸¸å¯¹æŸäº›æŒ‰é”®ä½¿ç”¨ç¬¦å·ï¼Œå…¶ä¸­åŒ…æ‹¬ä»¥ä¸‹ä¿®é¥°é”®ï¼š Commandï¼ˆæˆ– Cmdï¼‰âŒ˜ Shift â‡§ Optionï¼ˆæˆ– Altï¼‰âŒ¥ Controlï¼ˆæˆ– Ctrlï¼‰âŒƒ Caps Lock â‡ª Fn åœ¨ Windows PC ä¸“ç”¨é”®ç›˜ä¸Šï¼Œè¯·ç”¨ Alt é”®ä»£æ›¿ Option é”®ï¼Œç”¨ Windows æ ‡å¿—é”®ä»£æ›¿ Command é”®ã€‚Apple é”®ç›˜ä¸Šçš„æŸäº›æŒ‰é”®å…·æœ‰ç‰¹æ®Šç¬¦å·å’ŒåŠŸèƒ½ï¼Œä¾‹å¦‚æ˜¾ç¤ºå±äº®åº¦ ã€é”®ç›˜äº®åº¦ ã€è°ƒåº¦ä¸­å¿ƒç­‰ã€‚å¦‚æœæ‚¨çš„é”®ç›˜ä¸Šæ²¡æœ‰è¿™äº›åŠŸèƒ½ï¼Œæ‚¨ä¹Ÿè®¸å¯ä»¥é€šè¿‡åˆ›å»ºè‡ªå·±çš„é”®ç›˜å¿«æ·é”®æ¥å®ç°å…¶ä¸­çš„ä¸€äº›åŠŸèƒ½ã€‚è¦å°†è¿™äº›é”®ç”¨ä½œ F1ã€F2ã€F3 æˆ–å…¶ä»–æ ‡å‡†åŠŸèƒ½é”®ï¼Œè¯·å°†å®ƒä»¬ä¸ Fn é”®ç»„åˆä½¿ç”¨ã€‚ å‰ªåˆ‡ã€æ‹·è´ã€ç²˜è´´å’Œå…¶ä»–å¸¸ç”¨å¿«æ·é”® Command-Xï¼šå‰ªåˆ‡æ‰€é€‰é¡¹å¹¶æ‹·è´åˆ°å‰ªè´´æ¿ã€‚ Command-Cï¼šå°†æ‰€é€‰é¡¹æ‹·è´åˆ°å‰ªè´´æ¿ã€‚è¿™åŒæ ·é€‚ç”¨äºâ€œè®¿è¾¾â€ä¸­çš„æ–‡ä»¶ã€‚ Command-Vï¼šå°†å‰ªè´´æ¿çš„å†…å®¹ç²˜è´´åˆ°å½“å‰æ–‡ç¨¿æˆ–åº”ç”¨ä¸­ã€‚è¿™åŒæ ·é€‚ç”¨äºâ€œè®¿è¾¾â€ä¸­çš„æ–‡ä»¶ã€‚ Command-Zï¼šæ’¤é”€ä¸Šä¸€ä¸ªå‘½ä»¤ã€‚éšåæ‚¨å¯ä»¥æŒ‰ Shift-Command-Z æ¥é‡åšï¼Œä»è€Œåå‘æ‰§è¡Œæ’¤é”€å‘½ä»¤ã€‚åœ¨æŸäº›åº”ç”¨ä¸­ï¼Œæ‚¨å¯ä»¥æ’¤é”€å’Œé‡åšå¤šä¸ªå‘½ä»¤ã€‚ Command-Aï¼šå…¨é€‰å„é¡¹ã€‚ Command-Fï¼šæŸ¥æ‰¾æ–‡ç¨¿ä¸­çš„é¡¹ç›®æˆ–æ‰“å¼€â€œæŸ¥æ‰¾â€çª—å£ã€‚ Command-Gï¼šå†æ¬¡æŸ¥æ‰¾ï¼šæŸ¥æ‰¾ä¹‹å‰æ‰€æ‰¾åˆ°é¡¹ç›®å‡ºç°çš„ä¸‹ä¸€ä¸ªä½ç½®ã€‚è¦æŸ¥æ‰¾å‡ºç°çš„ä¸Šä¸€ä¸ªä½ç½®ï¼Œè¯·æŒ‰ Shift-Command-Gã€‚ Command-Hï¼šéšè—æœ€å‰é¢çš„åº”ç”¨çš„çª—å£ã€‚è¦æŸ¥çœ‹æœ€å‰é¢çš„åº”ç”¨ä½†éšè—æ‰€æœ‰å…¶ä»–åº”ç”¨ï¼Œè¯·æŒ‰ Option-Command-Hã€‚ Command-Mï¼šå°†æœ€å‰é¢çš„çª—å£æœ€å°åŒ–è‡³â€œç¨‹åºåâ€ã€‚è¦æœ€å°åŒ–æœ€å‰é¢çš„åº”ç”¨çš„æ‰€æœ‰çª—å£ï¼Œè¯·æŒ‰ Option-Command-Mã€‚ Command-Oï¼šæ‰“å¼€æ‰€é€‰é¡¹ï¼Œæˆ–æ‰“å¼€ä¸€ä¸ªå¯¹è¯æ¡†ä»¥é€‰æ‹©è¦æ‰“å¼€çš„æ–‡ä»¶ã€‚ Command-Pï¼šæ‰“å°å½“å‰æ–‡ç¨¿ã€‚ Command-Sï¼šå­˜å‚¨å½“å‰æ–‡ç¨¿ã€‚ Command-Tï¼šæ‰“å¼€æ–°æ ‡ç­¾é¡µã€‚ Command-Wï¼šå…³é—­æœ€å‰é¢çš„çª—å£ã€‚è¦å…³é—­åº”ç”¨çš„æ‰€æœ‰çª—å£ï¼Œè¯·æŒ‰ä¸‹ Option-Command-Wã€‚ Option-Command-Escï¼šå¼ºåˆ¶é€€å‡ºåº”ç”¨ã€‚ Commandâ€“ç©ºæ ¼é”®ï¼šæ˜¾ç¤ºæˆ–éšè—â€œèšç„¦â€æœç´¢æ ã€‚è¦ä»â€œè®¿è¾¾â€çª—å£æ‰§è¡Œâ€œèšç„¦â€æœç´¢ï¼Œè¯·æŒ‰ Commandâ€“Optionâ€“ç©ºæ ¼é”®ã€‚ï¼ˆå¦‚æœæ‚¨ä½¿ç”¨å¤šä¸ªè¾“å…¥æºä»¥ä¾¿ç”¨ä¸åŒçš„è¯­è¨€é”®å…¥å†…å®¹ï¼Œè¿™äº›å¿«æ·é”®ä¼šæ›´æ”¹è¾“å…¥æºè€Œéæ˜¾ç¤ºâ€œèšç„¦â€ã€‚äº†è§£å¦‚ä½•æ›´æ”¹å†²çªçš„é”®ç›˜å¿«æ·é”®ã€‚ï¼‰ Control-Commandâ€“ç©ºæ ¼é”®ï¼šæ˜¾ç¤ºå­—ç¬¦æ£€è§†å™¨ï¼Œæ‚¨å¯ä»¥ä»ä¸­é€‰æ‹©è¡¨æƒ…ç¬¦å·å’Œå…¶ä»–ç¬¦å·ã€‚ Control-Command-Fï¼šå…¨å±ä½¿ç”¨åº”ç”¨ï¼ˆå¦‚æœåº”ç”¨æ”¯æŒï¼‰ã€‚ ç©ºæ ¼é”®ï¼šä½¿ç”¨å¿«é€ŸæŸ¥çœ‹æ¥é¢„è§ˆæ‰€é€‰é¡¹ã€‚ Command-Tabï¼šåœ¨æ‰“å¼€çš„åº”ç”¨ä¸­åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæœ€è¿‘ä½¿ç”¨çš„åº”ç”¨ã€‚ Shift-Command-5ï¼šåœ¨ macOS Mojave ä¸­ï¼Œæ‹æ‘„å±å¹•å¿«ç…§æˆ–å½•åˆ¶å±å¹•ã€‚åœ¨æ›´æ—©çš„ macOS ç‰ˆæœ¬ä¸­ï¼Œè¯·ä½¿ç”¨ Shift-Command-3 æˆ– Shift-Command-4 æ¥æ‹æ‘„å±å¹•å¿«ç…§ã€‚è¿›ä¸€æ­¥äº†è§£å±å¹•å¿«ç…§ã€‚ Shift-Command-Nï¼šåœ¨â€œè®¿è¾¾â€ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ã€‚ Command-é€—å· (,)ï¼šæ‰“å¼€æœ€å‰é¢çš„åº”ç”¨çš„åå¥½è®¾ç½®ã€‚ ç¡çœ ã€é€€å‡ºç™»å½•å’Œå…³æœºå¿«æ·é”®åœ¨è¿™äº›å¿«æ·é”®ä¸­ï¼Œæ‚¨å¯èƒ½éœ€è¦æŒ‰ä½å…¶ä¸­ä¸€äº›å¿«æ·é”®ç¨é•¿æ—¶é—´ã€‚è¿™æ ·å¯ä»¥é¿å…æ‚¨æ— æ„ä¸­å¯ç”¨å¿«æ·é”®ã€‚ ç”µæºæŒ‰é’®ï¼šæŒ‰ä¸‹å¯å°† Mac å¼€æœºæˆ–å°† Mac ä»ç¡çœ çŠ¶æ€å”¤é†’ã€‚æŒ‰ä½è¿™ä¸ªæŒ‰é’® 1.5 ç§’å¯ä½¿ Mac è¿›å…¥ç¡çœ çŠ¶æ€ã€‚*ç»§ç»­æŒ‰ä½åˆ™ä¼šå¼ºåˆ¶æ‚¨çš„ Mac å…³æœºã€‚ Optionâ€“Commandâ€“ç”µæºæŒ‰é’®*æˆ– Optionâ€“Commandâ€“Media Ejectï¼ˆOptionâ€“Commandâ€“ä»‹è´¨æ¨å‡ºé”®ï¼‰ï¼šå°†æ‚¨çš„ Mac ç½®äºç¡çœ çŠ¶æ€ã€‚ Controlâ€“Shiftâ€“ç”µæºæŒ‰é’®*æˆ– Controlâ€“Shiftâ€“Media Ejectï¼ˆControlâ€“Shiftâ€“ä»‹è´¨æ¨å‡ºé”®ï¼‰ï¼šå°†æ˜¾ç¤ºå™¨ç½®äºç¡çœ çŠ¶æ€ã€‚ Controlâ€“ç”µæºæŒ‰é’®*æˆ– Controlâ€“Media Ejectï¼ˆControlâ€“ä»‹è´¨æ¨å‡ºé”®ï¼‰ï¼šæ˜¾ç¤ºä¸€ä¸ªå¯¹è¯æ¡†ï¼Œè¯¢é—®æ‚¨æ˜¯è¦é‡æ–°å¯åŠ¨ã€ç¡çœ è¿˜æ˜¯å…³æœºã€‚ Controlâ€“Commandâ€“Power ç”µæºæŒ‰é’®ï¼š*å¼ºåˆ¶ Mac é‡æ–°å¯åŠ¨ï¼Œç³»ç»Ÿä¸ä¼šæç¤ºæ˜¯å¦è¦å­˜å‚¨ä»»ä½•æ‰“å¼€ä¸”æœªå­˜å‚¨çš„æ–‡ç¨¿ã€‚ Controlâ€“Commandâ€“Media Ejectï¼ˆControlâ€“Commandâ€“ä»‹è´¨æ¨å‡ºé”®ï¼‰ï¼šé€€å‡ºæ‰€æœ‰åº”ç”¨ï¼Œç„¶åé‡æ–°å¯åŠ¨æ‚¨çš„ Macã€‚å¦‚æœä»»ä½•æ‰“å¼€çš„æ–‡ç¨¿æœ‰æœªå­˜å‚¨çš„æ›´æ”¹ï¼Œç³»ç»Ÿä¼šè¯¢é—®æ‚¨æ˜¯å¦è¦å­˜å‚¨è¿™äº›æ›´æ”¹ã€‚ Controlâ€“Option-Commandâ€“ç”µæºæŒ‰é’®*æˆ– Controlâ€“Optionâ€“Commandâ€“Media Ejectï¼ˆControlâ€“Optionâ€“Commandâ€“ä»‹è´¨æ¨å‡ºé”®ï¼‰ï¼šé€€å‡ºæ‰€æœ‰åº”ç”¨ï¼Œç„¶åå°†æ‚¨çš„ Mac å…³æœºã€‚å¦‚æœä»»ä½•æ‰“å¼€çš„æ–‡ç¨¿æœ‰æœªå­˜å‚¨çš„æ›´æ”¹ï¼Œç³»ç»Ÿä¼šè¯¢é—®æ‚¨æ˜¯å¦è¦å­˜å‚¨è¿™äº›æ›´æ”¹ã€‚ Shiftâ€“Commandâ€“Qï¼šé€€å‡ºç™»å½•æ‚¨çš„ macOS ç”¨æˆ·å¸æˆ·ã€‚ç³»ç»Ÿå°†æç¤ºæ‚¨ç¡®è®¤ã€‚è¦åœ¨ä¸ç¡®è®¤çš„æƒ…å†µä¸‹ç«‹å³é€€å‡ºç™»å½•ï¼Œè¯·æŒ‰ä¸‹ Option-Shift-Command-Qã€‚ * ä¸é€‚ç”¨äºè§¦æ§ ID ä¼ æ„Ÿå™¨ã€‚ è®¿è¾¾å’Œç³»ç»Ÿå¿«æ·é”® Command-Dï¼šå¤åˆ¶æ‰€é€‰æ–‡ä»¶ã€‚ Command-Eï¼šæ¨å‡ºæ‰€é€‰ç£ç›˜æˆ–å®—å·ã€‚ Command-Fï¼šåœ¨â€œè®¿è¾¾â€çª—å£ä¸­å¼€å§‹â€œèšç„¦â€æœç´¢ã€‚ Command-Iï¼šæ˜¾ç¤ºæ‰€é€‰æ–‡ä»¶çš„â€œæ˜¾ç¤ºç®€ä»‹â€çª—å£ã€‚ Command-Rï¼š(1) å¦‚æœåœ¨â€œè®¿è¾¾â€ä¸­é€‰æ‹©äº†æŸä¸ªåˆ«åï¼šæ˜¾ç¤ºæ‰€é€‰åˆ«åå¯¹åº”çš„åŸå§‹æ–‡ä»¶ã€‚(2) åœ¨æŸäº›åº”ç”¨ï¼ˆå¦‚â€œæ—¥å†â€æˆ– Safari æµè§ˆå™¨ï¼‰ä¸­ï¼Œåˆ·æ–°æˆ–é‡æ–°è½½å…¥é¡µé¢ã€‚(3) åœ¨â€œè½¯ä»¶æ›´æ–°â€åå¥½è®¾ç½®ä¸­ï¼Œå†æ¬¡æ£€æŸ¥æœ‰æ²¡æœ‰è½¯ä»¶æ›´æ–°ã€‚ Shift-Command-Cï¼šæ‰“å¼€â€œç”µè„‘â€çª—å£ã€‚ Shift-Command-Dï¼šæ‰“å¼€â€œæ¡Œé¢â€æ–‡ä»¶å¤¹ã€‚ Shift-Command-Fï¼šæ‰“å¼€â€œæœ€è¿‘ä½¿ç”¨â€çª—å£ï¼Œå…¶ä¸­æ˜¾ç¤ºäº†æ‚¨æœ€è¿‘æŸ¥çœ‹æˆ–æ›´æ”¹è¿‡çš„æ‰€æœ‰æ–‡ä»¶ã€‚ Shift-Command-Gï¼šæ‰“å¼€â€œå‰å¾€æ–‡ä»¶å¤¹â€çª—å£ã€‚ Shift-Command-Hï¼šæ‰“å¼€å½“å‰ macOS ç”¨æˆ·å¸æˆ·çš„ä¸ªäººæ–‡ä»¶å¤¹ã€‚ Shift-Command-Iï¼šæ‰“å¼€ iCloud äº‘ç›˜ã€‚ Shift-Command-Kï¼šæ‰“å¼€â€œç½‘ç»œâ€çª—å£ã€‚ Option-Command-Lï¼šæ‰“å¼€â€œä¸‹è½½â€æ–‡ä»¶å¤¹ã€‚ Shift-Command-Nï¼šæ–°å»ºæ–‡ä»¶å¤¹ã€‚ Shift-Command-Oï¼šæ‰“å¼€â€œæ–‡ç¨¿â€æ–‡ä»¶å¤¹ã€‚ Shift-Command-Pï¼šåœ¨â€œè®¿è¾¾â€çª—å£ä¸­æ˜¾ç¤ºæˆ–éšè—é¢„è§ˆé¢æ¿ã€‚ Shift-Command-Rï¼šæ‰“å¼€â€œéš”ç©ºæŠ•é€â€çª—å£ã€‚ Shift-Command-Tï¼šæ˜¾ç¤ºæˆ–éšè—â€œè®¿è¾¾â€çª—å£ä¸­çš„æ ‡ç­¾é¡µæ ã€‚ Ctrl-Shift-Command-Tï¼šå°†æ‰€é€‰çš„â€œè®¿è¾¾â€é¡¹ç›®æ·»åŠ åˆ°â€œç¨‹åºåâ€ï¼ˆOS X Mavericks æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰ Shift-Command-Uï¼šæ‰“å¼€â€œå®ç”¨å·¥å…·â€æ–‡ä»¶å¤¹ã€‚ Option-Command-Dï¼šæ˜¾ç¤ºæˆ–éšè—â€œç¨‹åºåâ€ã€‚ Control-Command-Tï¼šå°†æ‰€é€‰é¡¹æ·»åŠ åˆ°è¾¹æ ï¼ˆOS X Mavericks æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰ã€‚ Option-Command-Pï¼šéšè—æˆ–æ˜¾ç¤ºâ€œè®¿è¾¾â€çª—å£ä¸­çš„è·¯å¾„æ ã€‚ Option-Command-Sï¼šéšè—æˆ–æ˜¾ç¤ºâ€œè®¿è¾¾â€çª—å£ä¸­çš„è¾¹æ ã€‚ Commandâ€“æ–œçº¿ (/)ï¼šéšè—æˆ–æ˜¾ç¤ºâ€œè®¿è¾¾â€çª—å£ä¸­çš„çŠ¶æ€æ ã€‚ Command-Jï¼šæ˜¾ç¤ºâ€œæ˜¾ç¤ºâ€é€‰é¡¹ã€‚ Command-Kï¼šæ‰“å¼€â€œè¿æ¥æœåŠ¡å™¨â€çª—å£ã€‚ Command-Lï¼šä¸ºæ‰€é€‰é¡¹åˆ¶ä½œæ›¿èº«ã€‚ Command-Nï¼šæ‰“å¼€ä¸€ä¸ªæ–°çš„â€œè®¿è¾¾â€çª—å£ã€‚ Option-Command-Nï¼šæ–°å»ºæ™ºèƒ½æ–‡ä»¶å¤¹ã€‚ Command-Tï¼šåœ¨å½“å‰â€œè®¿è¾¾â€çª—å£ä¸­æœ‰å•ä¸ªæ ‡ç­¾é¡µå¼€ç€çš„çŠ¶æ€ä¸‹æ˜¾ç¤ºæˆ–éšè—æ ‡ç­¾é¡µæ ã€‚ Option-Command-Tï¼šåœ¨å½“å‰â€œè®¿è¾¾â€çª—å£ä¸­æœ‰å•ä¸ªæ ‡ç­¾é¡µå¼€ç€çš„çŠ¶æ€ä¸‹æ˜¾ç¤ºæˆ–éšè—å·¥å…·æ ã€‚ Option-Command-Vï¼šç§»åŠ¨ï¼šå°†å‰ªè´´æ¿ä¸­çš„æ–‡ä»¶ä»åŸå§‹ä½ç½®ç§»åŠ¨åˆ°å½“å‰ä½ç½®ã€‚ Command-Yï¼šä½¿ç”¨â€œå¿«é€ŸæŸ¥çœ‹â€é¢„è§ˆæ‰€é€‰æ–‡ä»¶ã€‚ Option-Command-Yï¼šæ˜¾ç¤ºæ‰€é€‰æ–‡ä»¶çš„å¿«é€ŸæŸ¥çœ‹å¹»ç¯ç‰‡æ˜¾ç¤ºã€‚ Command-1ï¼šä»¥å›¾æ ‡æ–¹å¼æ˜¾ç¤ºâ€œè®¿è¾¾â€çª—å£ä¸­çš„é¡¹ç›®ã€‚ Command-2ï¼šä»¥åˆ—è¡¨æ–¹å¼æ˜¾ç¤ºâ€œè®¿è¾¾â€çª—å£ä¸­çš„é¡¹ç›®ã€‚ Command-3ï¼šä»¥åˆ†æ æ–¹å¼æ˜¾ç¤ºâ€œè®¿è¾¾â€çª—å£ä¸­çš„é¡¹ç›®ã€‚ Command-4ï¼šä»¥å°é¢æµæ–¹å¼æ˜¾ç¤ºâ€œè®¿è¾¾â€çª—å£ä¸­çš„é¡¹ç›®ã€‚ Commandâ€“å·¦ä¸­æ‹¬å· ([)ï¼šå‰å¾€ä¸Šä¸€æ–‡ä»¶å¤¹ã€‚ Commandâ€“å³ä¸­æ‹¬å· (])ï¼šå‰å¾€ä¸‹ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚ Commandâ€“ä¸Šç®­å¤´ï¼šæ‰“å¼€åŒ…å«å½“å‰æ–‡ä»¶å¤¹çš„æ–‡ä»¶å¤¹ã€‚ Commandâ€“Controlâ€“ä¸Šç®­å¤´ï¼šåœ¨æ–°çª—å£ä¸­æ‰“å¼€åŒ…å«å½“å‰æ–‡ä»¶å¤¹çš„æ–‡ä»¶å¤¹ã€‚ Commandâ€“ä¸‹ç®­å¤´ï¼šæ‰“å¼€æ‰€é€‰é¡¹ã€‚ å³ç®­å¤´ï¼šæ‰“å¼€æ‰€é€‰æ–‡ä»¶å¤¹ã€‚è¿™ä¸ªå¿«æ·é”®ä»…åœ¨åˆ—è¡¨è§†å›¾ä¸­æœ‰æ•ˆã€‚ å·¦ç®­å¤´ï¼šå…³é—­æ‰€é€‰æ–‡ä»¶å¤¹ã€‚è¿™ä¸ªå¿«æ·é”®ä»…åœ¨åˆ—è¡¨è§†å›¾ä¸­æœ‰æ•ˆã€‚ Command-Deleteï¼šå°†æ‰€é€‰é¡¹ç§»åˆ°åºŸçº¸ç¯“ã€‚ Shift-Command-Deleteï¼šæ¸…å€’åºŸçº¸ç¯“ã€‚ Option-Shift-Command-Deleteï¼šæ¸…å€’åºŸçº¸ç¯“è€Œä¸æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†ã€‚ Commandâ€“è°ƒé«˜äº®åº¦ï¼šæ‰“å¼€æˆ–å…³é—­ç›®æ ‡æ˜¾ç¤ºå™¨æ¨¡å¼ã€‚ Commandâ€“è°ƒä½äº®åº¦ï¼šå½“æ‚¨çš„ Mac è¿æ¥åˆ°å¤šå°æ˜¾ç¤ºå™¨æ—¶ï¼Œæ‰“å¼€æˆ–å…³é—­è§†é¢‘é•œåƒã€‚ Optionâ€“è°ƒé«˜äº®åº¦ï¼šæ‰“å¼€â€œæ˜¾ç¤ºå™¨â€åå¥½è®¾ç½®ã€‚è¿™ä¸ªå¿«æ·é”®å¯ä¸ä»»ä¸€äº®åº¦é”®æ­é…ä½¿ç”¨ã€‚ Controlâ€“è°ƒé«˜äº®åº¦æˆ– Controlâ€“è°ƒä½äº®åº¦ï¼šæ›´æ”¹å¤–éƒ¨æ˜¾ç¤ºå™¨çš„äº®åº¦ï¼ˆå¦‚æœæ˜¾ç¤ºå™¨æ”¯æŒï¼‰ã€‚ Option-Shiftâ€“è°ƒé«˜äº®åº¦æˆ– Option-Shiftâ€“è°ƒä½äº®åº¦ï¼šä»¥è¾ƒå°çš„æ­¥å¹…è°ƒèŠ‚æ˜¾ç¤ºå™¨äº®åº¦ã€‚å¦‚æœæ‚¨çš„æ˜¾ç¤ºå™¨æ”¯æŒï¼Œå¯ä»¥å°† Control é”®æ·»åŠ åˆ°æ­¤å¿«æ·é”®ï¼Œä»¥ä¾¿åœ¨å¤–ç½®æ˜¾ç¤ºå™¨ä¸Šè¿›è¡Œè°ƒèŠ‚ã€‚ Optionâ€“â€œè°ƒåº¦ä¸­å¿ƒâ€ï¼šæ‰“å¼€â€œè°ƒåº¦ä¸­å¿ƒâ€åå¥½è®¾ç½®ã€‚ Commandâ€“â€œè°ƒåº¦ä¸­å¿ƒâ€ï¼šæ˜¾ç¤ºæ¡Œé¢ã€‚ Controlâ€“ä¸‹ç®­å¤´ï¼šæ˜¾ç¤ºæœ€å‰é¢çš„åº”ç”¨çš„æ‰€æœ‰çª—å£ã€‚ Optionâ€“è°ƒé«˜éŸ³é‡ï¼šæ‰“å¼€â€œå£°éŸ³â€åå¥½è®¾ç½®ã€‚è¿™ä¸ªå¿«æ·é”®å¯ä¸ä»»ä¸€éŸ³é‡é”®æ­é…ä½¿ç”¨ã€‚ Option-Shiftâ€“è°ƒé«˜éŸ³é‡æˆ– Option-Shiftâ€“è°ƒä½éŸ³é‡ï¼šä»¥è¾ƒå°çš„æ­¥å¹…è°ƒèŠ‚éŸ³é‡ã€‚ Optionâ€“é”®ç›˜è°ƒé«˜äº®åº¦ï¼šæ‰“å¼€â€œé”®ç›˜â€åå¥½è®¾ç½®ã€‚è¿™ä¸ªå¿«æ·é”®å¯ä¸ä»»ä¸€é”®ç›˜äº®åº¦é”®æ­é…ä½¿ç”¨ã€‚ Option-Shiftâ€“é”®ç›˜è°ƒé«˜äº®åº¦æˆ– Option-Shiftâ€“é”®ç›˜è°ƒä½äº®åº¦ï¼šä»¥è¾ƒå°çš„æ­¥å¹…è°ƒèŠ‚é”®ç›˜äº®åº¦ã€‚ è¿æŒ‰ Option é”®ï¼šåœ¨å•ç‹¬çš„çª—å£ä¸­æ‰“å¼€é¡¹ç›®ï¼Œç„¶åå…³é—­åŸå§‹çª—å£ã€‚ è¿æŒ‰ Command é”®ï¼šåœ¨å•ç‹¬çš„æ ‡ç­¾é¡µæˆ–çª—å£ä¸­æ‰“å¼€æ–‡ä»¶å¤¹ã€‚ æŒ‰ä½ Command é”®æ‹–ç§»åˆ°å¦ä¸€ä¸ªå®—å·ï¼šå°†æ‹–ç§»çš„é¡¹ç›®ç§»åˆ°å¦ä¸€ä¸ªå®—å·ï¼Œè€Œä¸æ˜¯æ‹·è´å®ƒã€‚ æŒ‰ä½ Option é”®æ‹–ç§»ï¼šæ‹·è´æ‰˜ç§»çš„é¡¹ç›®ã€‚æ‹–ç§»é¡¹ç›®æ—¶æŒ‡é’ˆä¼šéšä¹‹å˜åŒ–ã€‚ æŒ‰ä½ Option-Command é”®æ‹–ç§»ï¼šä¸ºæ‹–ç§»çš„é¡¹ç›®åˆ¶ä½œæ›¿èº«ã€‚æ‹–ç§»é¡¹ç›®æ—¶æŒ‡é’ˆä¼šéšä¹‹å˜åŒ–ã€‚ æŒ‰ä½ Option é”®ç‚¹æŒ‰å¼€åˆä¸‰è§’ï¼šæ‰“å¼€æ‰€é€‰æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰æ–‡ä»¶å¤¹ã€‚æ­¤å¿«æ·é”®ä»…åœ¨åˆ—è¡¨è§†å›¾ä¸­æœ‰æ•ˆã€‚ æŒ‰ä½ Command é”®ç‚¹æŒ‰çª—å£æ ‡é¢˜ï¼šæŸ¥çœ‹åŒ…å«å½“å‰æ–‡ä»¶å¤¹çš„æ–‡ä»¶å¤¹ã€‚ äº†è§£å¦‚ä½•ä½¿ç”¨ Command æˆ– Shift åœ¨â€œè®¿è¾¾â€ä¸­é€‰æ‹©å¤šä¸ªé¡¹ç›®ã€‚ ç‚¹æŒ‰â€œè®¿è¾¾â€èœå•æ ä¸­çš„â€œå‰å¾€â€èœå•æŸ¥çœ‹ç”¨äºæ‰“å¼€è®¸å¤šå¸¸ç”¨æ–‡ä»¶å¤¹ï¼ˆå¦‚â€œåº”ç”¨ç¨‹åºâ€ã€â€œæ–‡ç¨¿â€ã€â€œä¸‹è½½â€ã€â€œå®ç”¨å·¥å…·â€å’Œâ€œiCloud äº‘ç›˜â€ï¼‰çš„å¿«æ·é”®ã€‚ æ–‡ç¨¿å¿«æ·é”®è¿™äº›å¿«æ·é”®çš„è¡Œä¸ºå¯èƒ½å› æ‚¨ä½¿ç”¨çš„åº”ç”¨è€Œå¼‚ã€‚ Command-Bï¼šä»¥ç²—ä½“æ˜¾ç¤ºæ‰€é€‰æ–‡æœ¬ï¼Œæˆ–è€…æ‰“å¼€æˆ–å…³é—­ç²—ä½“æ˜¾ç¤ºåŠŸèƒ½ã€‚ Command-Iï¼šä»¥æ–œä½“æ˜¾ç¤ºæ‰€é€‰æ–‡æœ¬ï¼Œæˆ–è€…æ‰“å¼€æˆ–å…³é—­æ–œä½“æ˜¾ç¤ºåŠŸèƒ½ã€‚ Command-Kï¼šæ·»åŠ ç½‘é¡µé“¾æ¥ã€‚ Command-Uï¼šå¯¹æ‰€é€‰æ–‡æœ¬åŠ ä¸‹åˆ’çº¿ï¼Œæˆ–è€…æ‰“å¼€æˆ–å…³é—­åŠ ä¸‹åˆ’çº¿åŠŸèƒ½ã€‚ Command-Tï¼šæ˜¾ç¤ºæˆ–éšè—â€œå­—ä½“â€çª—å£ã€‚ Command-Dï¼šä»â€œæ‰“å¼€â€å¯¹è¯æ¡†æˆ–â€œå­˜å‚¨â€å¯¹è¯æ¡†å†…é€‰æ‹©â€œæ¡Œé¢â€æ–‡ä»¶å¤¹ã€‚ Control-Command-Dï¼šæ˜¾ç¤ºæˆ–éšè—æ‰€é€‰å­—è¯çš„å®šä¹‰ã€‚ Shift-Commandâ€“å†’å· (ï¼šæ˜¾ç¤ºâ€œæ‹¼å†™å’Œè¯­æ³•â€çª—å£ã€‚ Commandâ€“åˆ†å· (;)ï¼šæŸ¥æ‰¾æ–‡ç¨¿ä¸­æ‹¼å†™é”™è¯¯çš„å­—è¯ã€‚ Option-Deleteï¼šåˆ é™¤æ’å…¥ç‚¹å·¦è¾¹çš„å­—è¯ã€‚ Control-Hï¼šåˆ é™¤æ’å…¥ç‚¹å·¦è¾¹çš„å­—ç¬¦ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ Delete é”®ã€‚ Control-Dï¼šåˆ é™¤æ’å…¥ç‚¹å³è¾¹çš„å­—ç¬¦ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ Fn-Deleteã€‚ Fn-Deleteï¼šåœ¨æ²¡æœ‰å‘å‰åˆ é™¤ é”®çš„é”®ç›˜ä¸Šå‘å‰åˆ é™¤ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ Control-Dã€‚ Control-Kï¼šåˆ é™¤æ’å…¥ç‚¹ä¸è¡Œæˆ–æ®µè½æœ«å°¾å¤„ä¹‹é—´çš„æ–‡æœ¬ã€‚ Fnâ€“ä¸Šç®­å¤´ï¼šPage Upï¼šå‘ä¸Šæ»šåŠ¨ä¸€é¡µã€‚ Fnâ€“ä¸‹ç®­å¤´ï¼šPage Downï¼šå‘ä¸‹æ»šåŠ¨ä¸€é¡µã€‚ Fnâ€“å·¦ç®­å¤´ï¼šHomeï¼šæ»šåŠ¨åˆ°æ–‡ç¨¿å¼€å¤´ã€‚ Fnâ€“å³ç®­å¤´ï¼šEndï¼šæ»šåŠ¨åˆ°æ–‡ç¨¿æœ«å°¾ã€‚ Commandâ€“ä¸Šç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³æ–‡ç¨¿å¼€å¤´ã€‚ Commandâ€“ä¸‹ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³æ–‡ç¨¿æœ«å°¾ã€‚ Commandâ€“å·¦ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³å½“å‰è¡Œçš„è¡Œé¦–ã€‚ Commandâ€“å³ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³å½“å‰è¡Œçš„è¡Œå°¾ã€‚ Optionâ€“å·¦ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³ä¸Šä¸€å­—è¯çš„è¯é¦–ã€‚ Optionâ€“å³ç®­å¤´ï¼šå°†æ’å…¥ç‚¹ç§»è‡³ä¸‹ä¸€å­—è¯çš„è¯å°¾ã€‚ Shift-Commandâ€“ä¸Šç®­å¤´ï¼šé€‰ä¸­æ’å…¥ç‚¹ä¸æ–‡ç¨¿å¼€å¤´ä¹‹é—´çš„æ–‡æœ¬ã€‚ Shift-Commandâ€“ä¸‹ç®­å¤´ï¼šé€‰ä¸­æ’å…¥ç‚¹ä¸æ–‡ç¨¿æœ«å°¾ä¹‹é—´çš„æ–‡æœ¬ã€‚ Shift-Commandâ€“å·¦ç®­å¤´ï¼šé€‰ä¸­æ’å…¥ç‚¹ä¸å½“å‰è¡Œè¡Œé¦–ä¹‹é—´çš„æ–‡æœ¬ã€‚ Shift-Commandâ€“å³ç®­å¤´ï¼šé€‰ä¸­æ’å…¥ç‚¹ä¸å½“å‰è¡Œè¡Œå°¾ä¹‹é—´çš„æ–‡æœ¬ã€‚ Shiftâ€“ä¸Šç®­å¤´ï¼šå°†æ–‡æœ¬é€‰æ‹©èŒƒå›´æ‰©å±•åˆ°ä¸Šä¸€è¡Œç›¸åŒæ°´å¹³ä½ç½®çš„æœ€è¿‘å­—ç¬¦å¤„ã€‚ Shiftâ€“ä¸‹ç®­å¤´ï¼šå°†æ–‡æœ¬é€‰æ‹©èŒƒå›´æ‰©å±•åˆ°ä¸‹ä¸€è¡Œç›¸åŒæ°´å¹³ä½ç½®çš„æœ€è¿‘å­—ç¬¦å¤„ã€‚ Shiftâ€“å·¦ç®­å¤´ï¼šå°†æ–‡æœ¬é€‰æ‹©èŒƒå›´å‘å·¦æ‰©å±•ä¸€ä¸ªå­—ç¬¦ã€‚ Shiftâ€“å³ç®­å¤´ï¼šå°†æ–‡æœ¬é€‰æ‹©èŒƒå›´å‘å³æ‰©å±•ä¸€ä¸ªå­—ç¬¦ã€‚ Optionâ€“Shiftâ€“ä¸Šç®­å¤´ï¼šå°†æ–‡æœ¬é€‰æ‹©èŒƒå›´æ‰©å±•åˆ°å½“å‰æ®µè½çš„æ®µé¦–ï¼Œå†æŒ‰ä¸€æ¬¡åˆ™æ‰©å±•åˆ°ä¸‹ä¸€æ®µè½çš„æ®µé¦–ã€‚ Optionâ€“Shiftâ€“ä¸‹ç®­å¤´ï¼šå°†æ–‡æœ¬é€‰æ‹©èŒƒå›´æ‰©å±•åˆ°å½“å‰æ®µè½çš„æ®µå°¾ï¼Œå†æŒ‰ä¸€æ¬¡åˆ™æ‰©å±•åˆ°ä¸‹ä¸€æ®µè½çš„æ®µå°¾ã€‚ Optionâ€“Shiftâ€“å·¦ç®­å¤´ï¼šå°†æ–‡æœ¬é€‰æ‹©èŒƒå›´æ‰©å±•åˆ°å½“å‰å­—è¯çš„è¯é¦–ï¼Œå†æŒ‰ä¸€æ¬¡åˆ™æ‰©å±•åˆ°åä¸€å­—è¯çš„è¯é¦–ã€‚ Optionâ€“Shiftâ€“å·¦ç®­å¤´ï¼šå°†æ–‡æœ¬é€‰æ‹©èŒƒå›´æ‰©å±•åˆ°å½“å‰å­—è¯çš„è¯å°¾ï¼Œå†æŒ‰ä¸€æ¬¡åˆ™æ‰©å±•åˆ°åä¸€å­—è¯çš„è¯å°¾ã€‚ Controlâ€“Aï¼šç§»è‡³è¡Œæˆ–æ®µè½çš„å¼€å¤´ã€‚ Controlâ€“Eï¼šç§»è‡³è¡Œæˆ–æ®µè½çš„æœ«å°¾ã€‚ Controlâ€“Fï¼šå‘å‰ç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ã€‚ Controlâ€“Bï¼šå‘åç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ã€‚ Controlâ€“Lï¼šå°†å…‰æ ‡æˆ–æ‰€é€‰å†…å®¹ç½®äºå¯è§åŒºåŸŸä¸­å¤®ã€‚ Controlâ€“Pï¼šä¸Šç§»ä¸€è¡Œã€‚ Controlâ€“Nï¼šä¸‹ç§»ä¸€è¡Œã€‚ Controlâ€“Oï¼šåœ¨æ’å…¥ç‚¹åæ–°æ’å…¥ä¸€è¡Œã€‚ Controlâ€“Tï¼šå°†æ’å…¥ç‚¹åé¢çš„å­—ç¬¦ä¸æ’å…¥ç‚¹å‰é¢çš„å­—ç¬¦äº¤æ¢ã€‚ Commandâ€“å·¦èŠ±æ‹¬å· ({)ï¼šå·¦å¯¹é½ã€‚ Commandâ€“å³èŠ±æ‹¬å· (})ï¼šå³å¯¹é½ã€‚ Shift-Commandâ€“ç«–çº¿ (|)ï¼šå±…ä¸­å¯¹é½ã€‚ Option-Command-Fï¼šå‰å¾€æœç´¢æ ã€‚ Option-Command-Tï¼šæ˜¾ç¤ºæˆ–éšè—åº”ç”¨ä¸­çš„å·¥å…·æ ã€‚ Option-Command-Cï¼šæ‹·è´æ ·å¼ï¼šå°†æ‰€é€‰é¡¹çš„æ ¼å¼è®¾ç½®æ‹·è´åˆ°å‰ªè´´æ¿ã€‚ Option-Command-Vï¼šç²˜è´´æ ·å¼ï¼šå°†æ‹·è´çš„æ ·å¼åº”ç”¨åˆ°æ‰€é€‰é¡¹ã€‚ Option-Shift-Command-Vï¼šç²˜è´´å¹¶åŒ¹é…æ ·å¼ï¼šå°†å‘¨å›´å†…å®¹çš„æ ·å¼åº”ç”¨åˆ°ç²˜è´´åœ¨è¯¥å†…å®¹ä¸­çš„é¡¹ç›®ã€‚ Option-Command-Iï¼šæ˜¾ç¤ºæˆ–éšè—æ£€æŸ¥å™¨çª—å£ã€‚ Shift-Command-Pï¼šé¡µé¢è®¾ç½®ï¼šæ˜¾ç¤ºç”¨äºé€‰æ‹©æ–‡ç¨¿è®¾ç½®çš„çª—å£ã€‚ Shift-Command-Sï¼šæ˜¾ç¤ºâ€œå­˜å‚¨ä¸ºâ€å¯¹è¯æ¡†æˆ–å¤åˆ¶å½“å‰æ–‡ç¨¿ã€‚ Shift-Command-å‡å· (-)ï¼šç¼©å°æ‰€é€‰é¡¹ã€‚ Shift-Command-åŠ å· (+)ï¼šæ”¾å¤§æ‰€é€‰é¡¹ã€‚Commandâ€“ç­‰å· (=) å¯å®ç°ç›¸åŒçš„åŠŸèƒ½ã€‚ Shift-Commandâ€“é—®å· (?)ï¼šæ‰“å¼€â€œå¸®åŠ©â€èœå•ã€‚ å…¶ä»–å¿«æ·é”®å¦‚éœ€äº†è§£æ›´å¤šå¿«æ·é”®ï¼Œè¯·æŸ¥çœ‹åº”ç”¨èœå•ä¸­æ˜¾ç¤ºçš„å¿«æ·é”®ç¼©å†™ã€‚æ¯ä¸ªåº”ç”¨éƒ½æœ‰è‡ªå·±çš„å¿«æ·é”®ï¼Œåœ¨ä¸€ä¸ªåº”ç”¨ä¸­å¯ç”¨çš„å¿«æ·é”®å¯èƒ½åœ¨å¦ä¸€ä¸ªåº”ç”¨ä¸­ä¸å¯ç”¨ã€‚ è¾…åŠ©åŠŸèƒ½å¿«æ·é”® Safari æµè§ˆå™¨å¿«æ·é”® èšç„¦å¿«æ·é”® å¯åŠ¨å¿«æ·é”® iTunes å¿«æ·é”®ï¼šä» iTunes èœå•æ ä¸­é€‰å–â€œå¸®åŠ©â€&gt;â€œé”®ç›˜å¿«æ·é”®â€ã€‚ å…¶ä»–å¿«æ·é”®ï¼šé€‰å–è‹¹æœèœå• &gt;â€œç³»ç»Ÿåå¥½è®¾ç½®â€ï¼Œç‚¹æŒ‰â€œé”®ç›˜â€ï¼Œç„¶åç‚¹æŒ‰â€œå¿«æ·é”®â€ã€‚","link":"/2020/09/11/MacOS%E5%BF%AB%E6%8D%B7%E9%94%AE%E8%AF%B4%E6%98%8E/"},{"title":"JNI ä¸²å£é€šè®¯åº“ SerialPortå¼€å‘å°è£…","text":"SerialportManagerJNI ä¸²å£é€šè®¯åº“ SerialPortå¼€å‘å°è£…å‰è¨€ æœ€è¿‘å·¥ä½œæ¯”è¾ƒæ¸…é—²ï¼Œé—²æ¥æ— äº‹ï¼ŒæŠŠåŸå…ˆé¡¹ç›®ç”¨åˆ°çš„ä¸²å£é€šè®¯é¡¹ç›®æ‰€æ¶‰åŠåˆ°çš„çŸ¥è¯†åŠé¡¹ç›®ç®€åŒ–å‡ºæ¥ä¸€ä¸ªåº“ï¼Œæ–¹ä¾¿ä»¥åå¼€å‘æ–°é¡¹ç›®ã€‚åŒæ—¶å¸Œæœ› å¯¹å…¶ä»–å°ä¼™ä¼´æœ‰æ‰€å¸®åŠ©ã€‚é¡¹ç›®æ¶‰åŠåˆ° ndkå·¥ç¨‹æ„å»ºåŠç¡¬ä»¶ä¸²å£é€šè®¯ã€‚æœŸé—´æ¶‰åŠåˆ°ç¡¬ä»¶å±å¹•åŠŸèƒ½å¼€å‘è¿™é‡Œä¸åšå¤šä»‹ç»ã€‚ ä¸‹é¢ä»NDKé¡¹ç›®æ„å»ºå¼€å§‹è¯´èµ·ã€‚ NDKæ˜¯Googleä¸ºä¾¿äºAndroidå¼€å‘æä¾›çš„ä¸€ç§åŸç”Ÿå¼€å‘é›†ï¼šNative Development Kitï¼Œè€Œä¸”ä¹Ÿæ˜¯ä¸€ä¸ªåŒ…å«APIã€æ„å»ºå·¥å…·ã€äº¤å‰ç¼–è¯‘ã€è°ƒ è¯•å™¨ã€æ–‡æ¡£ç¤ºä¾‹ç­‰ä¸€ç³»åˆ—çš„å·¥å…·é›†ï¼Œå¯ä»¥å¸®åŠ©å¼€å‘è€…å¿«é€Ÿå¼€å‘Cï¼ˆæˆ–C++ï¼‰çš„åŠ¨æ€åº“ï¼Œå¹¶èƒ½è‡ªåŠ¨å°†soå’Œjavaåº”ç”¨ä¸€èµ·æ‰“åŒ…æˆAPKã€‚ ä¸NDKå¯†åˆ‡ç›¸å…³çš„å¦ä¸€ä¸ªè¯æ±‡åˆ™æ˜¯JNIï¼Œå®ƒæ˜¯NDKå¼€å‘ä¸­çš„æ¢çº½ï¼ŒJavaä¸åº•å±‚äº¤äº’ç»å¤§å¤šæ•°éƒ½æ˜¯é€šè¿‡å®ƒæ¥å®Œæˆçš„ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥çœ‹çœ‹ä»€ä¹ˆæ˜¯ JNI? JNIï¼šJava Native Interface ä¹Ÿå°±æ˜¯javaæœ¬åœ°æ¥å£ï¼Œå®ƒæ˜¯ä¸€ä¸ªåè®®ï¼Œè¿™ä¸ªåè®®ç”¨æ¥æ²Ÿé€šjavaä»£ç å’Œæœ¬åœ°ä»£ç (c/c++)ã€‚é€šè¿‡è¿™ä¸ª åè®®ï¼ŒJavaç±»çš„æŸäº›æ–¹æ³•å¯ä»¥ä½¿ç”¨åŸç”Ÿå®ç°ï¼ŒåŒæ—¶è®©å®ƒä»¬å¯ä»¥åƒæ™®é€šçš„Javaæ–¹æ³•ä¸€æ ·è¢«è°ƒç”¨å’Œä½¿ç”¨ï¼Œè€ŒåŸç”Ÿæ–¹æ³•ä¹Ÿå¯ä»¥ä½¿ç”¨Javaå¯¹è±¡ï¼Œ è°ƒç”¨å’Œä½¿ç”¨Javaæ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨JNIè¿™ç§åè®®å¯ä»¥å®ç°ï¼šjavaä»£ç è°ƒç”¨c/c++ä»£ç ï¼Œè€Œc/c++ä»£ç ä¹Ÿå¯ä»¥è°ƒç”¨javaä»£ç ã€‚ é‚£ä¸ºä»€ä¹ˆè¦ä½¿ç”¨NDKå¼€å‘å‘¢ï¼Ÿ æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œjavaæ˜¯åŠè§£é‡Šå‹è¯­è¨€ï¼Œå¾ˆå®¹æ˜“è¢«åæ±‡ç¼–åæ‹¿åˆ°æºä»£ç æ–‡ä»¶ï¼Œåœ¨å¼€å‘ä¸€äº›é‡è¦åè®®æ—¶ï¼Œæˆ‘ä»¬ä¸ºäº†å®‰å…¨èµ·è§ï¼Œä½¿ç”¨Cè¯­è¨€æ¥ç¼–å†™ è¿™äº›é‡è¦çš„éƒ¨åˆ†ï¼Œæ¥å¢å¤§ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚ åœ¨ä¸€äº›å¤æ‚æ€§çš„è®¡ç®—ä¸­ï¼Œè¦æ±‚é«˜æ€§èƒ½çš„åœºæ™¯ä¸­ï¼ŒC/C++æ›´åŠ çš„æœ‰æ•ˆç‡ï¼Œä»£ç ä¹Ÿæ›´ä¾¿äºå¤ç”¨ã€‚ å½“ç„¶è¿˜æœ‰å…¶ä»–çš„ä¼˜ç‚¹ï¼Œè¿™äº›éƒ½é©±ä½¿æˆ‘ä»¬é€‰æ‹©ç›¸å¯¹æ¥è¯´é«˜æ•ˆå’Œå®‰å…¨çš„DNKæ¥å¼€å‘æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚ NDKç¯å¢ƒæ­å»º1.ä¸‹è½½NDK é¦–å…ˆä¸‹è½½NDKï¼Œå¯ä»¥ä»AndroidStudioä¸­çš„SDK Managerä¸­ä¸‹è½½ï¼Œä¹Ÿå¯è‡ªå·±å•ç‹¬ä¸‹è½½ ç‚¹å‡»æŒ‰é’®è¿›å…¥ æˆ–è€…è¿›å…¥http://www.androiddevtools.cn/ ä¸‹è½½ Windows 64-bit Mac OS X å¦‚å•ç‹¬ä¸‹è½½ 1). è§£å‹NDKçš„zipåŒ…ï¼Œæ³¨æ„è·¯å¾„ç›®å½•ä¸è¦å‡ºç°ç©ºæ ¼å’Œä¸­æ–‡ï¼Œè¿™é‡Œå»ºè®®å¤§å®¶æŠŠåŒ…è§£å‹åˆ°SDKç›®å½•é‡Œé¢ï¼Œå¹¶å‘½åä¸ºndk-bundleï¼Œå¥½å¤„æ˜¯ï¼Œå¯åŠ¨ASçš„æ—¶å€™ä¼šæ£€æŸ¥å®ƒå¹¶ç›´æ¥æ·»åŠ åˆ°ndk.dirä¸­ï¼Œå‡å°‘æˆ‘ä»¬çš„é…ç½®å·¥ä½œï¼› 2). é…ç½®path : æŠŠè§£å‹å¥½çš„è·¯å¾„æ·»åŠ åˆ°ç¯å¢ƒå˜é‡pathä¸­ï¼› 3). ndk-buildï¼šcdåˆ°è§£å‹åNDKçš„æ ¹ç›®å½•ï¼Œæ‰§è¡Œndk-buildå‘½ä»¤ã€‚ 2.å®‰è£…é…ç½®NDK AndroidStudio ç‚¹å‡»File -&gt; Other Settings -&gt; Default Project Strjucture å¦‚å›¾ åˆ°è¿™é‡ŒNDKé…ç½®å®Œæˆï¼Œæ¥ä¸‹æ¥ å¼€å§‹ NDK å¼€å‘ã€‚ NDKé¡¹ç›®å¼€å‘ åœ¨library ä¸­çš„ build.gradle æ–‡ä»¶ä¸­çš„ defaultConfig ä¸­ é…ç½® ndk { moduleName &quot;serial_port&quot; // è®¾ç½®æ”¯æŒçš„SOåº“æ¶æ„ abiFilters &apos;armeabi&apos;, &apos;x86&apos;, &apos;armeabi-v7a&apos;, &apos;x86_64&apos;, &apos;arm64-v8a&apos; } åœ¨android ä¸­é…ç½® sourceSets { main { jni.srcDirs = [&apos;src/main/jni&apos;, &apos;src/main/jni/&apos;] } } externalNativeBuild { ndkBuild { path &apos;src/main/jni/Android.mk&apos; } } å¦‚å›¾ Android.mk æ–‡ä»¶ä¸­é…ç½®å¦‚ä¸‹å†…å®¹ Android.mkç”¨æ³•è¯¦è§£ # # Copyright 2009 Cedric Priscal # # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); # you may not use this file except in compliance with the License. # You may obtain a copy of the License at # # http://www.apache.org/licenses/LICENSE-2.0 # # Unless required by applicable law or agreed to in writing, software # distributed under the License is distributed on an &quot;AS IS&quot; BASIS, # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. # See the License for the specific language governing permissions and # limitations under the License. # LOCAL_PATH := $(call my-dir) include $(CLEAR_VARS) TARGET_PLATFORM := android-3 LOCAL_MODULE := serial_port //é¡¹ç›®åç§° LOCAL_SRC_FILES := SerialPort.c //åº•å±‚c LOCAL_LDLIBS := -llog include $(BUILD_SHARED_LIBRARY) åœ¨mainç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªjniæ–‡ä»¶ç›®å½•ï¼Œå¹¶å°† Android.mk æ–‡ä»¶æ”¾åˆ°jniæ–‡ä»¶ä¸‹ ç›´æ¥ä½¿ç”¨ç½‘ä¸Š SerialPort.java ç±»ï¼Œé‡Œè¾¹å°è£…åº•å±‚æ–¹æ³• package com.serialport.library.core; import java.io.File; import java.io.FileDescriptor; import java.io.FileInputStream; import java.io.FileOutputStream; import java.io.IOException; import java.io.InputStream; import java.io.OutputStream; /** * Created by Jian on 2017/8/7. * ç”¨æ¥åŠ è½½SOæ–‡ä»¶ï¼Œé€šè¿‡JNIçš„æ–¹å¼æ‰“å¼€å…³é—­ä¸²å£ */ public class SerialPort { private static final String TAG = &quot;SerialPort&quot;; /* * Do not remove or rename the field mFd: it is used by native method close(); */ private FileDescriptor mFd; private FileInputStream mFileInputStream; private FileOutputStream mFileOutputStream; public SerialPort(File device, int baudrate, int flags) throws SecurityException, IOException { /* Check access permission */ if (!device.canRead() || !device.canWrite()) { try { /* Missing read/write permission, trying to chmod the file */ Process su; su = Runtime.getRuntime().exec(&quot;/system/bin/su&quot;); String cmd = &quot;chmod 666 &quot; + device.getAbsolutePath() + &quot;\\n&quot; + &quot;exit\\n&quot;; su.getOutputStream().write(cmd.getBytes()); if ((su.waitFor() != 0) || !device.canRead() || !device.canWrite()) { throw new SecurityException(); } } catch (Exception e) { e.printStackTrace(); throw new SecurityException(); } } mFd = open(device.getAbsolutePath(), baudrate, flags); if (mFd == null) { throw new IOException(); } mFileInputStream = new FileInputStream(mFd); mFileOutputStream = new FileOutputStream(mFd); } // Getters and setters public InputStream getInputStream() { return mFileInputStream; } public OutputStream getOutputStream() { return new FileOutputStream(mFd); } // JNI private native static FileDescriptor open(String path, int baudrate, int flags); public native void close(); static { System.loadLibrary(&quot;serial_port&quot;); } } ç‚¹å‡»â€View-&gt;Tool Windows-&gt;Terminalâ€ï¼Œå³åœ¨Studioä¸­è¿›è¡Œç»ˆç«¯å‘½ä»¤è¡Œå·¥å…·.æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ç”Ÿæˆcè¯­è¨€å¤´æ–‡ä»¶: cd åˆ°ç›®å½•java/ ä¸‹æ‰§è¡Œ javah -o SerialPort.h -jni com.serialport.library.core.SerialPort javah -o SerialPort.h -jni com.serialport.library.core.SerialPort com.serialport.library.core ä¸ºåŒ…åã€‚ SerialPort.h æ–‡ä»¶å¦‚ä¸‹ /* DO NOT EDIT THIS FILE - it is machine generated */ #include &lt;jni.h&gt; /* Header for class com_serialport_library_core_SerialPort */ #ifndef _Included_com_serialport_library_core_SerialPort #define _Included_com_serialport_library_core_SerialPort #ifdef __cplusplus extern &quot;C&quot; { #endif /* * Class: com_serialport_library_core_SerialPort * Method: open * Signature: (Ljava/lang/String;II)Ljava/io/FileDescriptor; */ JNIEXPORT jobject JNICALL Java_com_serialport_library_core_SerialPort_open (JNIEnv *, jclass, jstring, jint, jint); /* * Class: com_serialport_library_core_SerialPort * Method: close * Signature: ()V */ JNIEXPORT void JNICALL Java_com_serialport_library_core_SerialPort_close (JNIEnv *, jobject); #ifdef __cplusplus } #endif #endif å¹¶æŠŠ SerialPort.h å¤´æ–‡ä»¶è½¬ç§»åˆ°jniæ–‡ä»¶å¤¹ä¸‹ åˆ›å»ºå®ç°å¤´æ–‡ä»¶çš„.Cæºæ–‡ä»¶ï¼Œå°† com_serialport_library_core ä¸ºSerialPort.java æ–‡ä»¶ä½ç½®ï¼Œå°†è¯¥ path æ›¿æ¢æˆå…¶ä»– é¡¹ç›®åŒ…å ç¬¦å·.æ¢æˆ_ /* * Copyright 2009-2011 Cedric Priscal * * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ #include &lt;termios.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #include &lt;string.h&gt; #include &lt;jni.h&gt; #include &quot;SerialPort.h&quot; #include &quot;android/log.h&quot; static const char *TAG = &quot;serial_port&quot;; #define LOGI(fmt, args...) __android_log_print(ANDROID_LOG_INFO, TAG, fmt, ##args) #define LOGD(fmt, args...) __android_log_print(ANDROID_LOG_DEBUG, TAG, fmt, ##args) #define LOGE(fmt, args...) __android_log_print(ANDROID_LOG_ERROR, TAG, fmt, ##args) static speed_t getBaudrate(jint baudrate) { switch (baudrate) { case 0: return B0; ... default: return -1; } } /* * Class: com_serialport_library_core_SerialPort * Method: open * Signature: (Ljava/lang/String;II)Ljava/io/FileDescriptor; */ JNIEXPORT jobject JNICALL Java_com_serialport_library_core_SerialPort_open (JNIEnv *env, jclass thiz, jstring path, jint baudrate, jint flags) { int fd; speed_t speed; jobject mFileDescriptor; /* Check arguments */ { speed = getBaudrate(baudrate); if (speed == -1) { /* TODO: throw an exception */ LOGE(&quot;Invalid baudrate&quot;); return NULL; } } /* Opening device */ { jboolean iscopy; const char *path_utf = (*env)-&gt;GetStringUTFChars(env, path, &amp;iscopy); LOGD(&quot;Opening serial port %s with flags 0x%x&quot;, path_utf, O_RDWR | flags); fd = open(path_utf, O_RDWR | flags); LOGD(&quot;open() fd = %d&quot;, fd); (*env)-&gt;ReleaseStringUTFChars(env, path, path_utf); if (fd == -1) { /* Throw an exception */ LOGE(&quot;Cannot open port&quot;); /* TODO: throw an exception */ return NULL; } } /* Configure device */ { struct termios cfg; LOGD(&quot;Configuring serial port&quot;); if (tcgetattr(fd, &amp;cfg)) { LOGE(&quot;tcgetattr() failed&quot;); close(fd); /* TODO: throw an exception */ return NULL; } cfmakeraw(&amp;cfg); cfsetispeed(&amp;cfg, speed); cfsetospeed(&amp;cfg, speed); if (tcsetattr(fd, TCSANOW, &amp;cfg)) { LOGE(&quot;tcsetattr() failed&quot;); close(fd); /* TODO: throw an exception */ return NULL; } } /* Create a corresponding file descriptor */ { jclass cFileDescriptor = (*env)-&gt;FindClass(env, &quot;java/io/FileDescriptor&quot;); jmethodID iFileDescriptor = (*env)-&gt;GetMethodID(env, cFileDescriptor, &quot;&lt;init&gt;&quot;, &quot;()V&quot;); jfieldID descriptorID = (*env)-&gt;GetFieldID(env, cFileDescriptor, &quot;descriptor&quot;, &quot;I&quot;); mFileDescriptor = (*env)-&gt;NewObject(env, cFileDescriptor, iFileDescriptor); (*env)-&gt;SetIntField(env, mFileDescriptor, descriptorID, (jint) fd); } return mFileDescriptor; } /* * Class: com_serialport_library_core_SerialPort * Method: close * Signature: ()V */ JNIEXPORT void JNICALL Java_com_serialport_library_core_SerialPort_close (JNIEnv *env, jobject thiz) { jclass SerialPortClass = (*env)-&gt;GetObjectClass(env, thiz); jclass FileDescriptorClass = (*env)-&gt;FindClass(env, &quot;java/io/FileDescriptor&quot;); jfieldID mFdID = (*env)-&gt;GetFieldID(env, SerialPortClass, &quot;mFd&quot;, &quot;Ljava/io/FileDescriptor;&quot;); jfieldID descriptorID = (*env)-&gt;GetFieldID(env, FileDescriptorClass, &quot;descriptor&quot;, &quot;I&quot;); jobject mFd = (*env)-&gt;GetObjectField(env, thiz, mFdID); jint descriptor = (*env)-&gt;GetIntField(env, mFd, descriptorID); LOGD(&quot;close(fd = %d)&quot;, descriptor); close(descriptor); } åˆ°æ­¤ NDK é¡¹ç›®æ­å»ºå®Œæˆã€‚æ¥ä¸‹æ¥ ä»‹ç»ä¸€ä¸‹ SerialPortManager ç±»åº“ ä¸‹å›¾ä¸ºç±»åº“çš„ä»‹ç» SerialPort.java å°è£…åº•å±‚å¼€å…³ä¸²å£æ–¹æ³• SerialPortFinder.java è·å–æ‰€æœ‰ä¸²å£æ–¹æ³• OnS3DataReceiverListener.java å’Œ OnS6DataReceiverListener.java æ˜¯ä¸²å£å“åº”æ•°æ®ç›‘å¬ã€‚å½“æ¥æ”¶åˆ°ä¸²å£æ•°æ®ä¼šè°ƒ æ¥å£æ–¹æ³•ï¼Œæˆ‘ä»¬çš„ç¡¬ä»¶è®¾å¤‡S3å£ç›‘å¬ä¸»æ¿æ•°æ®ï¼ŒS6å£ç›‘å¬ç¡¬ä»¶å±å¹•æ•°æ®ã€‚ BaseProtocol.java æä¾›æŒ‡ä»¤å°è£…æ–¹æ³•ã€‚æ ¹æ®å„ä¸ªè®¾å¤‡ç¡¬ä»¶ä¸²å£åè®®ï¼Œç»§æ‰¿ã€å°è£…ã€‚ SerialportManager.java ä¸²å£ç®¡ç†å¯¹è±¡ SerialportManager.java ä¸²å£ç®¡ç†å¯¹è±¡ï¼Œè¯¥å¯¹è±¡ä¸ºå•ä¾‹ã€‚åº•å±‚å¯¹ SerialPort è¿›è¡Œå°è£…ã€ç®¡ç†ã€‚ private SerialPort mSerialPort; mSerialPort = new SerialPort(new File(path), baudrate, 0);//æ ¹æ®ä¸²å£åï¼Œæ³¢ç‰¹ç‡ ç”Ÿæˆä¸²å£ç®¡ç†å¯¹è±¡ mOutputStream = mSerialPort.getOutputStream(); //è·å–ä¸²å£çš„è¾“å‡ºæµ mInputStream = mSerialPort.getInputStream(); //è·å–ä¸²å£çš„è¾“å…¥æµ å¼€å¯ä¸€ä¸ªæ–°çº¿ç¨‹å¾ªç¯è¯»å–ä¸²å£ä¿¡æ¯ if (mReadThread == null) { mReadThread = new ReadThread(); mReadThread.start(); } çº¿ç¨‹æ–¹æ³•ä¸­é€šè¿‡è¾“å…¥æµè·å–ä¸²å£æ•°æ® è¿”å›æ•°æ®ä¸ºbyteæ•°ç»„ï¼Œå½“è·å–åˆ°æ•°æ®å›è°ƒ onS3DataReceiverListener æ¥å£æ–¹æ³• private class ReadThread extends Thread { @Override public void run() { super.run(); while (!isStop &amp;&amp; !isInterrupted()) { int size; try { if (mInputStream == null) { return; } byte[] buffer = new byte[64]; size = mInputStream.read(buffer); if (size &gt; 0) { if (null != onS3DataReceiverListener) { onS3DataReceiverListener.onS3DataReceive(buffer, size); } } Thread.sleep(10); } catch (Exception e) { Log.i(&quot;readthread&quot;, &quot;throw exception !&quot; + e.toString()); e.printStackTrace(); return; } } } } ä¸‹é¢ä»‹ç»ä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ç±»åº“ï¼Œæˆ‘ä»¬é¡¹ç›®ä¸²å£ç”¨çš„æ˜¯S3ã€S6å£ï¼Œå¦‚æœæƒ³ç”¨å…¶ä»–ä¸²å£ è¯·ä¿®æ”¹SerialportManagerä¸­çš„path/screenpath å¦‚æœbaudrateä¹Ÿæƒ³æ”¹ä¹Ÿä¿®æ”¹å¯¹åº”çš„æ•°å€¼å³å¯ã€‚ SerialportManager.getInstance().setOnS3DataReceiverListener(this);//è®¾ç½®ä¸»æ¿ä¸²å£å›è°ƒ SerialportManager.getInstance().setOnS6DataReceiverListener(this);//è®¾ç½®å±å¹•ä¸²å£å›è°ƒ SerialportManager.getInstance().InitThread();//åˆå§‹åŒ–å¯¹åº” è¯»å†™çº¿ç¨‹ //å› æœ‰ä¸åŒä¸»æ¿ç±»å‹ï¼Œå±å¹•ç±»å‹ã€‚è¿™é‡Œå¯¹å…¶åšäº†ä¸€æ¬¡å°è£… SenderManager.getInstance().getSender().sendStartDetect(); è®¾å¤‡å¼€æœºä¼šè½®è®­é…ç½®ä¸²å£ï¼Œæ ¹æ®ä¸»æ¿ç±»å‹å±å¹•ç±»å‹ï¼Œç”Ÿæˆå¯¹åº”ç®¡ç†å¯¹è±¡ã€‚ç„¶åè¿›è¡Œä¸²å£æ•°æ®é€šè®¯ã€‚å½“æˆ‘ä»¬ä¸²å£è¯»åˆ°æˆ‘ä»¬çš„è¾“å…¥æ•°æ®ï¼Œä¼š æƒ³onS3DataReceiverListener.onS3DataReceive å›è°ƒè¿”å›æ•°æ®ã€‚å†ç•Œé¢æˆ‘ä»¬æ‹¿åˆ°æ•°æ®åç›¸åº”æ“ä½œ @Override public void onS3DataReceive(byte[] buffer, int size) { byte[] mBufferTemp = new byte[size]; System.arraycopy(buffer, 0, mBufferTemp, 0, size); int length = mBufferTemp.length - 1; String tempdata = TypeConversion.bytes2HexString(mBufferTemp); Log.i(&quot;serialport&quot;,tempdata); } å½“ç•Œé¢è·³è½¬æ—¶è¦åŠæ—¶å°†OnS3DataReceiverListenerã€OnS6DataReceiverListenerç›‘å¬removeæ‰ï¼Œé¿å…é€ æˆå†…å­˜æ³„æ¼ã€‚ @Override protected void onPause() { super.onPause(); SerialportManager.getInstance().removeOnS3DataReceiverListener(); SerialportManager.getInstance().removeOnS6DataReceiverListener(); }","link":"/2019/10/11/SerialportManager/"},{"title":"21 PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹","text":"åœ¨å‰é¢çš„å‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åˆ†æäº†Activityä¸Dialogçš„åŠ è½½ç»˜åˆ¶æµç¨‹ï¼Œå–æ¶ˆç»˜åˆ¶æµç¨‹ï¼Œç›¸ä¿¡å¤§å®¶å¯¹Androidç³»ç»Ÿçš„çª—å£ç»˜åˆ¶æœºåˆ¶æœ‰äº†ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†äº†ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†ç»§ç»­åˆ†æä¸€ä¸‹PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹ã€‚ åœ¨åˆ†æPopupWindowä¹‹å‰ï¼Œæˆ‘ä»¬å°†é¦–å…ˆè¯´ä¸€ä¸‹ä»€ä¹ˆæ˜¯PopupWindowï¼Ÿç†è§£ä¸€ä¸ªç±»æœ€å¥½çš„æ–¹å¼å°±æ˜¯çœ‹ä¸€ä¸‹è¿™ä¸ªç±»çš„å®šä¹‰ï¼Œè¿™é‡Œæˆ‘ä»¬æ‘˜è¦äº†ä¸€ä¸‹Androidç³»ç»Ÿä¸­PopupWindowçš„ç±»çš„è¯´æ˜ï¼š A popup window that can be used to display an arbitrary view. The popup window is a floating container that appears on top of the current activity. ä¸€ä¸ªPopupWindowèƒ½å¤Ÿè¢«ç”¨äºå±•ç¤ºä»»æ„çš„Viewï¼ŒPopupWindowæ˜¯ä¸€ä¸ªæ‚¬æµ®çš„å®¹æ˜“å±•ç¤ºåœ¨å½“å‰Activityçš„ä¸Šé¢ã€‚ç®€å•æ¥è¯´PopupWindowå°±æ˜¯ä¸€ä¸ªæ‚¬æµ®åœ¨Activityä¹‹ä¸Šçš„çª—å£ï¼Œå¯ä»¥ç”¨å±•ç¤ºä»»æ„å¸ƒå±€æ–‡ä»¶ã€‚ åœ¨è¯´æ˜PopupWindowçš„åŠ è½½ç»˜åˆ¶æœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆå†™ä¸€ä¸ªç®€å•çš„ä¾‹å­ç”¨äºè¯´æ˜ä¸€ä¸‹PopupWindowçš„ç®€å•ç”¨æ³•ã€‚ 1234567891011121314151617181920212223public static View showPopupWindowMenu(Activity mContext, View anchorView, int layoutId) { LayoutInflater inflater = (LayoutInflater) mContext.getSystemService(Context.LAYOUT_INFLATER_SERVICE); View view = inflater.inflate(layoutId, null); popupWindow = new PopupWindow(view, DisplayUtil.dip2px(mContext, 148), WindowManager.LayoutParams.WRAP_CONTENT); popupWindow.setBackgroundDrawable(mContext.getResources().getDrawable(R.drawable.menu_bg)); popupWindow.setFocusable(true); popupWindow.setOutsideTouchable(true); int[] location = new int[2]; anchorView.getLocationOnScreen(location); popupWindow.setAnimationStyle(R.style.popwin_anim_style); popupWindow.showAtLocation(anchorView, Gravity.NO_GRAVITY, location[0] - popupWindow.getWidth() + anchorView.getWidth() - DisplayUtil.dip2px(mContext, 12), location[1] + anchorView.getHeight() - DisplayUtil.dip2px(mContext, 10)); popupWindow.setOnDismissListener(new PopupWindow.OnDismissListener() { @Override public void onDismiss() { popupWindow = null; } }); return view; } å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é¦–å…ˆé€šè¿‡LayoutInflaterå¯¹è±¡å°†å¸ƒå±€æ–‡ä»¶è§£æåˆ°å†…å­˜ä¸­Viewå¯¹è±¡ï¼Œç„¶ååˆ›å»ºäº†ä¸€ä¸ªPopupWindowå¯¹è±¡ï¼Œå¯ä»¥çœ‹åˆ°ä¼ é€’äº†ä¸‰ä¸ªå‚æ•°ï¼Œä¸€ä¸ªæ˜¯Viewå¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯PopupWindowçš„å®½åº¦å’Œé«˜åº¦ã€‚ è¿™é‡Œå°±æ˜¯PopupWindowçš„åˆå§‹åŒ–æµç¨‹çš„å¼€å§‹äº†ï¼Œå¥½å§ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹PopupWindowçš„æ„é€ æ–¹æ³•çš„å®ç°ï¼š 123public PopupWindow(View contentView, int width, int height) { this(contentView, width, height, false); }å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†PopupWindowçš„é‡è½½æ„é€ æ–¹æ³•ï¼Œå¥½å§ï¼Œç»§ç»­çœ‹ä¸€ä¸‹è¿™ä¸ªé‡è½½æ„é€ æ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 1234567891011public PopupWindow(View contentView, int width, int height, boolean focusable) { if (contentView != null) { mContext = contentView.getContext(); mWindowManager = (WindowManager) mContext.getSystemService(Context.WINDOW_SERVICE); } setContentView(contentView); setWidth(width); setHeight(height); setFocusable(focusable); } è¿™é‡Œé¦–å…ˆæ ¹æ®ä¼ å…¥çš„Viewæ˜¯å¦ä¸ºç©ºåšäº†ä¸€ä¸‹åˆ¤æ–­ï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–æˆå‘˜å˜é‡,Contextå’ŒmWindowManagerï¼Œå¯ä»¥å‘ç°è¿™é‡Œçš„mContextå¯¹è±¡å°±æ˜¯ä¼ å…¥çš„Viewç»„ä»¶ä¸­ä¿ç•™çš„Contextå¯¹è±¡ï¼Œè¿™é‡Œçš„mWindowManageræ˜¯åº”ç”¨è¿›ç¨‹åˆ›å»ºçš„æ—¶å€™æ³¨å†Œçš„æœåŠ¡æœ¬åœ°æ¥å£ã€‚ç„¶åè°ƒç”¨äº†setContentViewæ–¹æ³•ï¼Œè¿™é‡Œå°±æ˜¯ä¸ºPopupWindowçš„contentViewèµ‹å€¼ã€‚ç„¶ååé¢è°ƒç”¨çš„setWidthã€setHeightã€setFocusableæ–¹æ³•éƒ½æ˜¯ä¸ºPopupWindowçš„æˆå‘˜å˜é‡ï¼Œwidthï¼Œheightï¼Œfocusableç­‰èµ‹å€¼ï¼Œè¿™æ ·PopupWindowçš„æ„é€ æ–¹æ³•å°±æ‰§è¡Œå®Œæˆäº†ã€‚ æˆ‘ä»¬ç»§ç»­å›åˆ°æˆ‘ä»¬çš„ä¾‹å­ä»£ç ä¸­ï¼Œåœ¨åç»­çš„ä»£ç ä¸­æˆ‘ä»¬è°ƒç”¨äº†ï¼špopupWindow.setBackgroundDrawableã€popupWindow.setFocusableã€PopupWindow.setOutsideTouchableã€PopupWindow.setAnimationStyleç­‰æ–¹æ³•ï¼Œåˆå§‹åŒ–äº†PopupWindowä¸­çš„ç›¸å…³æˆå‘˜å˜é‡ï¼Œæœ€åæˆ‘ä»¬è°ƒç”¨äº†popupWindow.showAtLocationæ–¹æ³•ç”¨äºå±•ç¤ºPopupWindowï¼Œè¿™é‡Œæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹showAtLocationçš„å®ç°é€»è¾‘ï¼š 123public void showAtLocation(View parent, int gravity, int x, int y) { showAtLocation(parent.getWindowToken(), gravity, x, y); } å¯ä»¥å‘ç°ï¼Œè¿™é‡Œè°ƒç”¨äº†showAtLocationçš„é‡è½½å‡½æ•°ï¼Œè¿™æ ·æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹è¿™ä¸ªé‡è½½å‡½æ•°çš„å®ç°æ–¹å¼ï¼š 12345678910111213141516171819202122232425public void showAtLocation(IBinder token, int gravity, int x, int y) { if (isShowing() || mContentView == null) { return; } TransitionManager.endTransitions(mDecorView); unregisterForScrollChanged(); mIsShowing = true; mIsDropdown = false; final WindowManager.LayoutParams p = createPopupLayoutParams(token); preparePopup(p); // Only override the default if some gravity was specified. if (gravity != Gravity.NO_GRAVITY) { p.gravity = gravity; } p.x = x; p.y = y; invokePopup(p); } å¯ä»¥çœ‹åˆ°é€šè¿‡è°ƒç”¨createPopupLayoutParamsæ–¹æ³•åˆ›é€ äº†WindowManager.LayoutParamså¯¹è±¡ï¼Œç„¶ååˆè°ƒç”¨äº†preparePopupæ–¹æ³•ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹preparePopupæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637private void preparePopup(WindowManager.LayoutParams p) { if (mContentView == null || mContext == null || mWindowManager == null) { throw new IllegalStateException(&quot;You must specify a valid content view by &quot; + &quot;calling setContentView() before attempting to show the popup.&quot;); } // The old decor view may be transitioning out. Make sure it finishes // and cleans up before we try to create another one. if (mDecorView != null) { mDecorView.cancelTransitions(); } // When a background is available, we embed the content view within // another view that owns the background drawable. if (mBackground != null) { mBackgroundView = createBackgroundView(mContentView); mBackgroundView.setBackground(mBackground); } else { mBackgroundView = mContentView; } mDecorView = createDecorView(mBackgroundView); // The background owner should be elevated so that it casts a shadow. mBackgroundView.setElevation(mElevation); // We may wrap that in another view, so we'll need to manually specify // the surface insets. final int surfaceInset = (int) Math.ceil(mBackgroundView.getZ() * 2); p.surfaceInsets.set(surfaceInset, surfaceInset, surfaceInset, surfaceInset); p.hasManualSurfaceInsets = true; mPopupViewInitialLayoutDirectionInherited = (mContentView.getRawLayoutDirection() == View.LAYOUT_DIRECTION_INHERIT); mPopupWidth = p.width; mPopupHeight = p.height; } preparePopupæ–¹æ³•çš„å‚æ•°æ˜¯WindowManager.LayoutParamsï¼Œç„¶åè®¾ç½®äº†PopupWindowä¸­çš„å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æˆå‘˜å˜é‡ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹mBackgroundViewçš„åˆå§‹åŒ–è¿‡ç¨‹ï¼š 123456if (mBackground != null) { mBackgroundView = createBackgroundView(mContentView); mBackgroundView.setBackground(mBackground); } else { mBackgroundView = mContentView; } å¯ä»¥å‘ç°å¦‚æœæˆ‘ä»¬è®¾ç½®äº†mBackgroundå˜é‡ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨åˆå§‹åŒ–çš„æ—¶å€™æ‰§è¡Œäº†popupWindowçš„setBackgoundæ–¹æ³•ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œæ‰§è¡Œçš„å°±æ˜¯ifåˆ†ä¹‹ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹createBackgourndViewçš„å…·ä½“æ‰§è¡Œé€»è¾‘ï¼š 12345678910111213141516private PopupBackgroundView createBackgroundView(View contentView) { final ViewGroup.LayoutParams layoutParams = mContentView.getLayoutParams(); final int height; if (layoutParams != null &amp;&amp; layoutParams.height == ViewGroup.LayoutParams.WRAP_CONTENT) { height = ViewGroup.LayoutParams.WRAP_CONTENT; } else { height = ViewGroup.LayoutParams.MATCH_PARENT; } final PopupBackgroundView backgroundView = new PopupBackgroundView(mContext); final PopupBackgroundView.LayoutParams listParams = new PopupBackgroundView.LayoutParams( ViewGroup.LayoutParams.MATCH_PARENT, height); backgroundView.addView(contentView, listParams); return backgroundView; } å¯ä»¥çœ‹åˆ°ï¼ŒcreateBackgroundViewçš„æ‰§è¡Œé€»è¾‘å°±æ˜¯åœ¨å‚æ•°contentViewçš„å¤–é¢ä¸€å±‚åŒ…è£¹ä¸€å±‚PopupBackgroundViewï¼Œè€Œè¿™é‡Œçš„PopupBackgroundViewå€¼æˆ‘ä»¬è‡ªå®šä¹‰çš„FrameLayoutçš„å­ç±»ï¼Œé‡å†™äº†å…¶onCreateDrawableStateæ–¹æ³•ã€‚ ç»§ç»­å›åˆ°æˆ‘ä»¬çš„preparePopupæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬åˆè°ƒç”¨äº†createDecorViewæ–¹æ³•åˆå§‹åŒ–mDectorViewå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹createDecorViewçš„å…·ä½“å®ç°ï¼š 12345678910111213141516private PopupDecorView createDecorView(View contentView) { final ViewGroup.LayoutParams layoutParams = mContentView.getLayoutParams(); final int height; if (layoutParams != null &amp;&amp; layoutParams.height == ViewGroup.LayoutParams.WRAP_CONTENT) { height = ViewGroup.LayoutParams.WRAP_CONTENT; } else { height = ViewGroup.LayoutParams.MATCH_PARENT; } final PopupDecorView decorView = new PopupDecorView(mContext); decorView.addView(contentView, ViewGroup.LayoutParams.MATCH_PARENT, height); decorView.setClipChildren(false); decorView.setClipToPadding(false); return decorView; } å¯ä»¥å‘ç°è¿™é‡Œä¹Ÿæ˜¯ç»™å‚æ•°contentViewå¤–é¢åŒ…è£¹äº†ä¸€å±‚PopupDecorViewï¼Œè¿™é‡Œçš„PopupDecorViewä¹Ÿæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„FrameLayoutçš„å­ç±»ï¼ŒPopupDecorViewçš„æºç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œå°±ä¸éƒ½è´´å‡ºæ¥äº†ï¼Œè¿™é‡Œå…·ä½“çœ‹ä¸€ä¸‹å…¶onTouchEventæ–¹æ³•çš„å®ç°ï¼š 12345678910111213141516@Override public boolean onTouchEvent(MotionEvent event) { final int x = (int) event.getX(); final int y = (int) event.getY(); if ((event.getAction() == MotionEvent.ACTION_DOWN) &amp;&amp; ((x &lt; 0) || (x &gt;= getWidth()) || (y &lt; 0) || (y &gt;= getHeight()))) { dismiss(); return true; } else if (event.getAction() == MotionEvent.ACTION_OUTSIDE) { dismiss(); return true; } else { return super.onTouchEvent(event); } } å¯ä»¥å‘ç°å…¶é‡å†™äº†onTouchEventæ—¶é—´ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ç‚¹å‡»popupWindowå¤–é¢çš„æ—¶å€™å°±ä¼šæ‰§è¡ŒpupopWindowçš„dismissæ–¹æ³•ï¼Œå–æ¶ˆPopupWindowã€‚ å¥½å§ï¼Œç»§ç»­å›åˆ°æˆ‘ä»¬çš„showAsDropDownæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œå®ŒæˆpreparePopupæ–¹æ³•ä¹‹ååˆè°ƒç”¨äº†invokePopupæ–¹æ³•ï¼Œè¿™é‡Œçš„æ–¹æ³•åº”è¯¥å°±æ˜¯å…·ä½“æ‰§è¡ŒPopupWindowçš„åŠ è½½ä¸æ˜¾ç¤ºé€»è¾‘äº†ã€‚è¿™é‡Œæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹å…¶å®ç°é€»è¾‘ï¼š 12345678910111213141516private void invokePopup(WindowManager.LayoutParams p) { if (mContext != null) { p.packageName = mContext.getPackageName(); } final PopupDecorView decorView = mDecorView; decorView.setFitsSystemWindows(mLayoutInsetDecor); setLayoutDirectionFromAnchor(); mWindowManager.addView(decorView, p); if (mEnterTransition != null) { decorView.requestEnterTransition(mEnterTransition); } } æˆ‘ä»¬çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬è°ƒç”¨äº†mWindowManager.addViewæ–¹æ³•ï¼Œçœ‹è¿‡æˆ‘ä»¬å‰é¢å‡ ç¯‡å…³äºDialogå’ŒActivityçš„åŠ è½½ä¸ç°å®æµç¨‹çš„åŒå­¦åº”è¯¥çŸ¥é“è¿™é‡Œçš„addViewå…¶å®æ˜¯æˆ‘ä»¬å¸ƒå±€ç»˜åˆ¶çš„æµç¨‹ï¼Œè¿™é‡Œçš„mWindowManageræ˜¯æˆ‘ä»¬åœ¨è°ƒç”¨PopupWIndowçš„æ„é€ å‡½æ•°çš„æ—¶å€™åˆå§‹åŒ–çš„ï¼Œå…¶è°ƒç”¨çš„æ˜¯ï¼š 123if (mWindowManager == null &amp;&amp; mContentView != null) { mWindowManager = (WindowManager) mContext.getSystemService(Context.WINDOW_SERVICE); } è€Œè¿™é‡Œçš„mContext.getSystemServiceæ˜¯ä¸€ä¸ªæ¥å£å…¶å…·ä½“çš„å®ç°æ˜¯åœ¨ContextImplä¸­å®ç°çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ContextImplçš„getSystemServiceçš„å®ç°ï¼š 1234@Override public Object getSystemService(String name) { return SystemServiceRegistry.getSystemService(this, name); } å¥½å§ï¼Œåœ¨ContextImplä¸­çš„getSystemServiceæ–¹æ³•åˆè°ƒç”¨äº†SystemServiceRegisterä¸­çš„é™æ€æ–¹æ³•getSystemServiceï¼Œè¿™æ ·æˆ‘ä»¬å†çœ‹çœ‹ä¸€ä¸‹åœ¨SystemServiceRegisteræ˜¯å¦‚ä½•å®ç°çš„ã€‚ 1234public static Object getSystemService(ContextImpl ctx, String name) { ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name); return fetcher != null ? fetcher.getService(ctx) : null; } è¿™é‡Œå‘ç°æœåŠ¡å¯¹è±¡çš„è·å–å°±æ˜¯é€šè¿‡ä¸€ä¸ªSYSTEM_SERVICE_FETCHERSçš„mapæ•°æ®ç»“æ„è·å–çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªmapå¯¹è±¡çš„æ•°æ®æ˜¯ä½•æ—¶å¡«å……çš„å‘¢ï¼Ÿé€šè¿‡æŸ¥çœ‹æºç æˆ‘ä»¬å‘ä¸‹åœ¨SystemServiceRegisterä¸­æœ‰ä¸€æ®µé™æ€ä»£ç ä¸»è¦ç”¨äºæ³¨å†Œæœ¬åœ°æœåŠ¡æ¥å£ï¼Œå…¶ä¸­å…³äºwindowManagerServiceæœ¬åœ°æœåŠ¡çš„ä»£ç å¦‚ä¸‹ï¼š 123456registerService(Context.WINDOW_SERVICE, WindowManager.class, new CachedServiceFetcher&lt;WindowManager&gt;() { @Override public WindowManager createService(ContextImpl ctx) { return new WindowManagerImpl(ctx.getDisplay()); }}); å¥½å§ï¼ŒåŸæ¥æˆ‘ä»¬é€šè¿‡mContext.getSystemServiceè·å–çš„WindowManagerå…¶å®é™…ä¸Šæ˜¯ä¸€ä¸ªWindowManagerImplå¯¹è±¡ï¼Œè€Œæˆ‘ä»¬è°ƒç”¨çš„addViewå°±æ˜¯WindowManagerImplçš„addViewæ–¹æ³•ã€‚ è¿™æ ·å°±å›åˆ°äº†æˆ‘ä»¬å‰å‡ ç¯‡è®²è§£çš„å†…å®¹ä¸Šäº†ï¼Œé€šè¿‡è°ƒç”¨WindowManagerImplå®ç°äº†å¸ƒå±€æ–‡ä»¶çš„ç»˜åˆ¶æµç¨‹ã€‚ã€‚ã€‚ã€‚ å¥½äº†ï¼Œç»è¿‡ä¸Šé¢çš„ä¸€ç³»åˆ—çš„æ“ä½œæˆ‘ä»¬åˆ†æå®Œäº†PopupWindowçš„åŠ è½½ç»˜åˆ¶æµç¨‹ï¼Œå…¶å’ŒDialogï¼ŒActivityçš„åŠ è½½ç»˜åˆ¶æµç¨‹ç±»ä¼¼ï¼Œéƒ½æ˜¯é€šè¿‡Windowå¯¹è±¡æ§åˆ¶å¸ƒå±€æ–‡ä»¶çš„åŠ è½½ä¸ç»˜åˆ¶æµç¨‹ã€‚ æ€»ç»“ï¼š PopupWindowçš„ç•Œé¢åŠ è½½ç»˜åˆ¶æµç¨‹ä¹Ÿæ˜¯é€šè¿‡Windowå¯¹è±¡å®ç°çš„ï¼› PopupWindowå†…éƒ¨ä¿å­˜çš„mWindowManagerå¯¹è±¡é€šè¿‡ContextImplä¸­è·å–ï¼Œå¹¶ä¸”å–å¾—çš„æ˜¯WindowManagerImplå¯¹è±¡ï¼› PopupWindowé€šè¿‡ä¸ºä¼ å…¥çš„Viewæ·»åŠ ä¸€å±‚åŒ…è£¹çš„å¸ƒå±€ï¼Œå¹¶é‡å†™è¯¥å¸ƒå±€çš„ç‚¹å‡»äº‹ä»¶ï¼Œå®ç°ç‚¹å‡»PopupWindowä¹‹å¤–çš„åŒºåŸŸPopupWindowæ¶ˆå¤±çš„æ•ˆæœï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹","link":"/2020/09/11/PopupWindow%E5%8A%A0%E8%BD%BD%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/"},{"title":"22 ToaståŠ è½½ç»˜åˆ¶æµç¨‹","text":"å‰é¢æˆ‘ä»¬åˆ†æäº†Activityã€Dialogã€PopupWindowçš„åŠ è½½ç»˜åˆ¶æµç¨‹ï¼Œç›¸ä¿¡å¤§å®¶å¯¹æ•´ä¸ªAndroidç³»ç»Ÿä¸­çš„çª—å£ç»˜åˆ¶æµç¨‹å·²ç»æœ‰äº†ä¸€ä¸ªæ¯”è¾ƒæ¸…æ™°çš„è®¤è¯†äº†ï¼Œè¿™é‡Œæœ€åå†ç»™å¤§å®¶ä»‹ç»ä¸€ä¸‹Toastçš„åŠ è½½ç»˜åˆ¶æµç¨‹ã€‚ å…¶å®Toastçª—å£å’ŒActivityã€Dialogã€PopupWindowæœ‰ä¸€ä¸ªä¸å¤ªä¸€æ ·çš„åœ°æ–¹ï¼Œå°±æ˜¯Toastçª—å£æ˜¯å±äºç³»ç»Ÿçº§åˆ«çš„çª—å£ï¼Œä»–å’Œè¾“å…¥æ¡†ç­‰ç±»ä¼¼çš„ï¼Œä¸å±äºæŸä¸€ä¸ªåº”ç”¨ï¼Œå³ä¸å±äºæŸä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€ä»¥è‡ªç„¶è€Œç„¶çš„ï¼Œä¸€æ—¦æ¶‰åŠåˆ°Toastçš„åŠ è½½ç»˜åˆ¶æµç¨‹å°±ä¼šæ¶‰åŠåˆ°è¿›ç¨‹é—´é€šè®¯ï¼Œçœ‹è¿‡å‰é¢ç³»åˆ—æ–‡ç« çš„åŒå­¦åº”è¯¥çŸ¥é“ï¼ŒAndroidé—´çš„è¿›ç¨‹é—´é€šè®¯é‡‡ç”¨çš„æ˜¯Androidç‰¹æœ‰çš„Binderæœºåˆ¶ï¼Œæ‰€ä»¥Toastçš„åŠ è½½ç»˜åˆ¶æµç¨‹ä¹Ÿä¼šæ¶‰åŠåˆ°Binderè¿›ç¨‹é—´é€šè®¯ã€‚ Toastçš„æ˜¾ç¤ºæµç¨‹å…¶å®å†…éƒ¨è¿˜æ˜¯é€šè¿‡Windowçš„çª—å£æœºåˆ¶å®ç°åŠ è½½ç»˜åˆ¶çš„ï¼Œåªä¸è¿‡ç”±äºæ˜¯ç³»ç»Ÿçº§åˆ«çš„çª—å£ï¼Œåœ¨æ˜¾ç¤ºè¿‡ç¨‹ä¸­æ¶‰åŠåˆ°äº†è¿›ç¨‹é—´é€šè®¯ç­‰æœºåˆ¶ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹Toastçª—å£çš„ç®€å•ä½¿ç”¨ã€‚ 1Toast.makeText(context, msg, Toast.LENGTH_SHORT).show(); ä¸Šé¢çš„ä»£ç æ˜¯Toastçš„å…¸å‹ä½¿ç”¨æ–¹å¼ï¼Œé€šè¿‡makeTextæ–¹æ³•åˆ›å»ºå‡ºä¸€ä¸ªToastå¯¹è±¡ï¼Œç„¶åè°ƒç”¨showæ–¹æ³•å°†Toastçª—å£æ˜¾ç¤ºå‡ºæ¥ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹makeTextæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567891011121314public static Toast makeText(Context context, CharSequence text, @Duration int duration) { Toast result = new Toast(context); LayoutInflater inflate = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE); View v = inflate.inflate(com.android.internal.R.layout.transient_notification, null); TextView tv = (TextView)v.findViewById(com.android.internal.R.id.message); tv.setText(text); result.mNextView = v; result.mDuration = duration; return result; } æ–¹æ³•ä½“ä¸æ˜¯å¾ˆé•¿ï¼Œåœ¨makeTextæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆé€šè¿‡Toastå¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼Œåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Toastå¯¹è±¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±å…ˆæ¥çœ‹ä¸€ä¸‹Toastçš„æ„é€ æ–¹æ³•åšäº†å“ªäº›äº‹ã€‚ 12345678public Toast(Context context) { mContext = context; mTN = new TN(); mTN.mY = context.getResources().getDimensionPixelSize( com.android.internal.R.dimen.toast_y_offset); mTN.mGravity = context.getResources().getInteger( com.android.internal.R.integer.config_toastDefaultGravity); }å¯ä»¥çœ‹åˆ°è¿™é‡Œåˆå§‹åŒ–äº†Toastå¯¹è±¡çš„æˆå‘˜å˜é‡mContextå’ŒmTNï¼Œè¿™é‡Œçš„mContextæ˜¯ä¸€ä¸ªContextç±»å‹çš„æˆå‘˜å˜é‡ï¼Œé‚£mTNæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ 1private static class TN extends ITransientNotification.Stub ä»ç±»çš„æºç å®šä¹‰æ¥çœ‹ï¼Œæˆ‘ä»¬çŸ¥é“TNæ˜¯ä¸€ä¸ªç»§æ‰¿è‡ªITransientNotification.Stubçš„ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶åªç”¨çŸ¥é“ä»–çš„ç»§æ‰¿å…³ç³»å°±å¥½äº†ï¼ŒçŸ¥é“å…¶æ˜¯ä¸€ä¸ªBinderå¯¹è±¡ï¼Œå¯ä»¥ç”¨äºè¿›ç¨‹é—´é€šè®¯ï¼Œç„¶åå›åˆ°æˆ‘ä»¬çš„makeTextæ–¹æ³•ï¼Œåœ¨è°ƒç”¨äº†Toastçš„æ„é€ æ–¹æ³•åˆ›å»ºäº†Toastå¯¹è±¡ä¹‹åï¼Œæˆ‘ä»¬åˆé€šè¿‡context.getSystemServiceæ–¹æ³•è·å–åˆ°LayoutInflaterï¼Œç„¶åé€šè¿‡è°ƒç”¨LayoutInflaterçš„inflateæ–¹æ³•åŠ è½½åˆ°äº†Toastçš„å¸ƒå±€æ–‡ä»¶ï¼š 123LayoutInflater inflate = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE); View v = inflate.inflate(com.android.internal.R.layout.transient_notification, null); è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å¸ƒå±€æ–‡ä»¶çš„å…·ä½“ä»£ç ï¼š 12345678910111213141516171819&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:orientation=&quot;vertical&quot; android:background=&quot;?android:attr/toastFrameBackground&quot;&gt; &lt;TextView android:id=&quot;@android:id/message&quot; android:layout_width=&quot;wrap_content&quot; android:layout_height=&quot;wrap_content&quot; android:layout_weight=&quot;1&quot; android:layout_gravity=&quot;center_horizontal&quot; android:textAppearance=&quot;@style/TextAppearance.Toast&quot; android:textColor=&quot;@color/bright_foreground_dark&quot; android:shadowColor=&quot;#BB000000&quot; android:shadowRadius=&quot;2.75&quot; /&gt;&lt;/LinearLayout&gt; å¯ä»¥å‘ç°ToaståŠ è½½çš„å¸ƒå±€æ–‡ä»¶åªæœ‰ä¸€ä¸ªLinearLayoutå¸ƒå±€ï¼Œå¹¶ä¸”åªåŒ…å«ä¸€ä¸ªTextViewç»„ä»¶ã€‚ã€‚ã€‚ã€‚ ç„¶åæˆ‘ä»¬é€šè¿‡è°ƒç”¨ï¼š 1234567TextView tv = (TextView)v.findViewById(com.android.internal.R.id.message); tv.setText(text); result.mNextView = v; result.mDuration = duration; return result; åˆå§‹åŒ–äº†å¸ƒå±€æ–‡ä»¶ï¼ŒToastçš„mNextViewå’ŒmDurationæˆå‘˜å˜é‡å¹¶è¿”å›Toastç±»å‹çš„resultå¯¹è±¡ã€‚è¿™æ ·æˆ‘ä»¬çš„Toastå¯¹è±¡å°±æ„é€ å®Œæˆäº†ã€‚ ç„¶åæˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„Toast.showæ–¹æ³•ï¼Œè°ƒç”¨å®Œè¿™ä¸ªæ–¹æ³•ä¹‹åå°±å‡†å¤‡å¼€å§‹æ˜¾ç¤ºToastçª—å£äº†ï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹showæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678910111213141516public void show() { if (mNextView == null) { throw new RuntimeException(&quot;setView must have been called&quot;); } INotificationManager service = getService(); String pkg = mContext.getOpPackageName(); TN tn = mTN; tn.mNextView = mNextView; try { service.enqueueToast(pkg, tn, mDuration); } catch (RemoteException e) { // Empty } } é¦–å…ˆåˆ¤æ–­æˆ‘ä»¬çš„mNextViewæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºçš„è¯ï¼Œæ˜¾ç¤ºé€»è¾‘å°±æ— æ³•è¿›è¡Œäº†ï¼Œæ‰€ä»¥è¿™é‡Œåˆ¤æ–­å¦‚æœmNextViewä¸ºç©ºçš„è¯ï¼Œå°±ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸åœ¨å¾€ä¸‹æ‰§è¡Œã€‚ã€‚ã€‚ã€‚ ç„¶åæˆ‘ä»¬æ‰§è¡Œäº†ï¼š 1INotificationManager service = getService(); è¿™é‡Œçš„INotificationManageræ˜¯æœåŠ¡å™¨ç«¯NotificationManagerServiceçš„Binderå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹getServiceæ–¹æ³•çš„å®ç°æ–¹å¼ï¼š 1234567static private INotificationManager getService() { if (sService != null) { return sService; } sService = INotificationManager.Stub.asInterface(ServiceManager.getService(&quot;notification&quot;)); return sService; } è¿™é‡Œè·å–äº†INotificationManagerå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨äº†service.enqueueToastæ–¹æ³•ï¼Œå¹¶ä¼ é€’äº†packageï¼ŒTNå¯¹è±¡ï¼Œdurationç­‰å‚æ•°ï¼Œè¿™é‡Œå®é™…æ‰§è¡Œçš„æ˜¯NotificationManagerServiceçš„å†…éƒ¨ç±»çš„INotificationManager.Stubçš„enqueueToastæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çš„NoticationManagerServiceæ˜¯åœ¨SystemServerè¿›ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œè¿™é‡Œçš„åº•å±‚å…¶å®æ˜¯é€šè¿‡Binderæœºåˆ¶ä¼ è¾“æ•°æ®çš„ï¼Œå…·ä½“çš„Binderæœºåˆ¶ç›¸å…³çŸ¥è¯†å¯è‡ªè¡Œå­¦ä¹ ã€‚ã€‚ å¥½å§ï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹INotificationManager.Stubçš„enqueueToastæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051@Override public void enqueueToast(String pkg, ITransientNotification callback, int duration) { ... synchronized (mToastQueue) { int callingPid = Binder.getCallingPid(); long callingId = Binder.clearCallingIdentity(); try { ToastRecord record; int index = indexOfToastLocked(pkg, callback); // If it's already in the queue, we update it in place, we don't // move it to the end of the queue. if (index &gt;= 0) { record = mToastQueue.get(index); record.update(duration); } else { // Limit the number of toasts that any given package except the android // package can enqueue. Prevents DOS attacks and deals with leaks. if (!isSystemToast) { int count = 0; final int N = mToastQueue.size(); for (int i=0; i&lt;N; i++) { final ToastRecord r = mToastQueue.get(i); if (r.pkg.equals(pkg)) { count++; if (count &gt;= MAX_PACKAGE_NOTIFICATIONS) { Slog.e(TAG, &quot;Package has already posted &quot; + count + &quot; toasts. Not showing more. Package=&quot; + pkg); return; } } } } record = new ToastRecord(callingPid, pkg, callback, duration); mToastQueue.add(record); index = mToastQueue.size() - 1; keepProcessAliveLocked(callingPid); } // If it's at index 0, it's the current toast. It doesn't matter if it's // new or just been updated. Call back and tell it to show itself. // If the callback fails, this will remove it from the list, so don't // assume that it's valid after this. if (index == 0) { showNextToastLocked(); } } finally { Binder.restoreCallingIdentity(callingId); } } } å¯ä»¥å‘ç°æˆ‘ä»¬é¦–å…ˆå°†æˆ‘ä»¬çš„ToastRecordï¼ˆToastå¯¹è±¡åœ¨serverç«¯çš„å¯¹è±¡ï¼‰ä¿å­˜åˆ°ä¸€ä¸ªListåˆ—è¡¨mToastQueueä¸­ï¼Œç„¶åè°ƒç”¨äº†showNextToastLockedæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹showNextToastLockedæ–¹æ³•çš„å…·ä½“å®ç°ã€‚ 12345678910111213141516171819202122232425void showNextToastLocked() { ToastRecord record = mToastQueue.get(0); while (record != null) { if (DBG) Slog.d(TAG, &quot;Show pkg=&quot; + record.pkg + &quot; callback=&quot; + record.callback); try { record.callback.show(); scheduleTimeoutLocked(record); return; } catch (RemoteException e) { Slog.w(TAG, &quot;Object died trying to show notification &quot; + record.callback + &quot; in package &quot; + record.pkg); // remove it from the list and let the process die int index = mToastQueue.indexOf(record); if (index &gt;= 0) { mToastQueue.remove(index); } keepProcessAliveLocked(record.pid); if (mToastQueue.size() &gt; 0) { record = mToastQueue.get(0); } else { record = null; } } } } è¿™é‡Œä¸»è¦æ‰§è¡Œäº†record.callback.showæ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„callbackå¯¹è±¡å°±æ˜¯æˆ‘ä»¬åˆ›å»ºToastå¯¹è±¡çš„æ—¶å€™ä¼ é€’çš„TNå¯¹è±¡ï¼Œæ˜¾ç„¶çš„ï¼Œè¿™äº†çš„showæ–¹æ³•å°±æ˜¯æˆ‘ä»¬çš„Toastå†…éƒ¨ç±»TNçš„showæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨äº†scheduleTimeoutLockedæ–¹æ³•ï¼Œè¿™é‡Œå…ˆçœ‹ä¸€ä¸‹scheduleTimeoutLockedæ–¹æ³•çš„å®ç°ã€‚ 1234567private void scheduleTimeoutLocked(ToastRecord r) { mHandler.removeCallbacksAndMessages(r); Message m = Message.obtain(mHandler, MESSAGE_TIMEOUT, r); long delay = r.duration == Toast.LENGTH_LONG ? LONG_DELAY : SHORT_DELAY; mHandler.sendMessageDelayed(m, delay); } å¯ä»¥å‘ç°è¿™é‡Œå‘é€äº†ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œå¹¶ä¸”è¿™é‡Œçš„å¼‚æ­¥æ¶ˆæ¯æ˜¯åœ¨durationæ—¶é—´ä¹‹åå‘é€çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨Toastç«¯ä¼ é€’çš„durationå‚æ•°å°±æ˜¯è¿™é‡Œçš„messageæ¶ˆæ¯delayå‘é€çš„æ—¶é—´ï¼Œè€Œæˆ‘ä»¬å‘é€MESSAGE_TIMEOUTå¼‚æ­¥æ¶ˆæ¯ä¹‹åæœ€ç»ˆä¼šè¢«æ–¹æ³•handleTimeoutæ‰§è¡Œã€‚ 12345678910private void handleTimeout(ToastRecord record) { if (DBG) Slog.d(TAG, &quot;Timeout pkg=&quot; + record.pkg + &quot; callback=&quot; + record.callback); synchronized (mToastQueue) { int index = indexOfToastLocked(record.pkg, record.callback); if (index &gt;= 0) { cancelToastLocked(index); } } } å¥½å§ï¼Œæ–¹æ³•ä½“é‡Œé¢åˆè°ƒç”¨äº†cancelToastLockedæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹cancelToastLockedæ–¹æ³•çš„å®ç°ï¼š 12345678910111213141516171819void cancelToastLocked(int index) { ToastRecord record = mToastQueue.get(index); try { record.callback.hide(); } catch (RemoteException e) { Slog.w(TAG, &quot;Object died trying to hide notification &quot; + record.callback + &quot; in package &quot; + record.pkg); // don't worry about this, we're about to remove it from // the list anyway } mToastQueue.remove(index); keepProcessAliveLocked(record.pid); if (mToastQueue.size() &gt; 0) { // Show the next one. If the callback fails, this will remove // it from the list, so don't assume that the list hasn't changed // after this point. showNextToastLocked(); } } å¥½å§ï¼Œè¿™é‡Œåˆæ˜¯è°ƒç”¨äº†record.callback.hideæ–¹æ³•ï¼Œæ˜¾ç„¶çš„è¿™é‡Œçš„hideæ–¹æ³•å’Œåˆšåˆšçš„showæ–¹æ³•æ˜¯ç›¸ä¼¼çš„ï¼Œéƒ½æ˜¯è°ƒç”¨çš„Toastå†…éƒ¨ç±»TNçš„hideæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥çœ‹å‡ºToastçš„æ˜¾ç¤ºä¸éšè—æ“ä½œéƒ½æ˜¯åœ¨Toastå†…éƒ¨ç±»TNçš„showå’Œhideæ–¹æ³•å®ç°çš„ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨äº†: 1mToastQueue.remove(index); æ¸…é™¤è¿™ä¸ªToastå¯¹è±¡ï¼Œå¹¶ç»§ç»­æ‰§è¡ŒshowNextToastLockedæ–¹æ³•ï¼Œç›´åˆ°mToastQueueçš„å¤§å°ä¸º0ã€‚ã€‚ã€‚ è¿™æ ·å…³äºToastçª—å£çš„æ˜¾ç¤ºä¸éšè—æ“ä½œéƒ½æ˜¯åœ¨Toastå†…éƒ¨ç±»TNçš„showæ–¹æ³•å’Œhideæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹TNå†…éƒ¨ç±»çš„showæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345@Override public void show() { if (localLOGV) Log.v(TAG, &quot;SHOW: &quot; + this); mHandler.post(mShow); } å¥½å§ï¼Œè¿™é‡Œä¹Ÿæ˜¯å‘é€ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Runnableç±»å‹çš„mShowçš„å®šä¹‰ã€‚ 123456final Runnable mShow = new Runnable() { @Override public void run() { handleShow(); } }; å¯ä»¥çœ‹åˆ°å†å…¶runæ–¹æ³•ä¸­è°ƒç”¨äº†handleShowæ–¹æ³•ï¼Œç»§ç»­çœ‹handleShowæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738public void handleShow() { if (localLOGV) Log.v(TAG, &quot;HANDLE SHOW: &quot; + this + &quot; mView=&quot; + mView + &quot; mNextView=&quot; + mNextView); if (mView != mNextView) { // remove the old view if necessary handleHide(); mView = mNextView; Context context = mView.getContext().getApplicationContext(); String packageName = mView.getContext().getOpPackageName(); if (context == null) { context = mView.getContext(); } mWM = (WindowManager)context.getSystemService(Context.WINDOW_SERVICE); // We can resolve the Gravity here by using the Locale for getting // the layout direction final Configuration config = mView.getContext().getResources().getConfiguration(); final int gravity = Gravity.getAbsoluteGravity(mGravity, config.getLayoutDirection()); mParams.gravity = gravity; if ((gravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) == Gravity.FILL_HORIZONTAL) { mParams.horizontalWeight = 1.0f; } if ((gravity &amp; Gravity.VERTICAL_GRAVITY_MASK) == Gravity.FILL_VERTICAL) { mParams.verticalWeight = 1.0f; } mParams.x = mX; mParams.y = mY; mParams.verticalMargin = mVerticalMargin; mParams.horizontalMargin = mHorizontalMargin; mParams.packageName = packageName; if (mView.getParent() != null) { if (localLOGV) Log.v(TAG, &quot;REMOVE! &quot; + mView + &quot; in &quot; + this); mWM.removeView(mView); } if (localLOGV) Log.v(TAG, &quot;ADD! &quot; + mView + &quot; in &quot; + this); mWM.addView(mView, mParams); trySendAccessibilityEvent(); } } å¥½å§ï¼Œåœ¨handleShowæ–¹æ³•ä¸­ç»è¿‡ä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œï¼Œåˆå§‹åŒ–mWNå¯¹è±¡ï¼Œåˆå§‹åŒ–mViewå¯¹è±¡ï¼Œåˆå§‹åŒ–äº†mParamså¯¹è±¡ï¼Œç„¶åè°ƒç”¨äº†mWMçš„addViewæ–¹æ³•ï¼Œåˆ°äº†è¿™é‡Œå¤§å®¶åº”è¯¥å°±å¾ˆç†Ÿæ‚‰äº†ï¼ˆä¸ç†Ÿæ‚‰çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹Activityçš„åŠ è½½ç»˜åˆ¶æµç¨‹ç­‰æ–‡ç«  androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹&nbsp;&nbsp; androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹ï¼‰é€šè¿‡è¿™ä¸ªæ–¹æ³•å°±å®ç°äº†Toastçª—å£çš„æ˜¾ç¤ºé€»è¾‘ã€‚ ç»§ç»­çœ‹ä¸€ä¸‹TNçš„hideæ–¹æ³•ï¼š 12345@Override public void hide() { if (localLOGV) Log.v(TAG, &quot;HIDE: &quot; + this); mHandler.post(mHide); } å¥½å§ï¼Œå’Œshowæ–¹æ³•ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å‘é€äº†ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹Runnableç±»å‹çš„mHideå¯¹è±¡çš„å®šä¹‰ï¼š 12345678final Runnable mHide = new Runnable() { @Override public void run() { handleHide(); // Don't do this in handleHide() because it is also invoked by handleShow() mNextView = null; } }; å¯ä»¥å‘ç°åœ¨å…¶runæ–¹æ³•ä¸­è°ƒç”¨äº†handleHideæ–¹æ³•ï¼Œæ˜¾ç„¶çš„ï¼Œä¸showæ–¹æ³•ç±»ä¼¼ï¼Œè¿™é‡Œçš„handleHideæ–¹æ³•ä¹Ÿæ˜¯æ‰§è¡ŒToastçª—å£é”€æ¯çš„é€»è¾‘ï¼š 1234567891011121314public void handleHide() { if (localLOGV) Log.v(TAG, &quot;HANDLE HIDE: &quot; + this + &quot; mView=&quot; + mView); if (mView != null) { // note: checking parent() just to make sure the view has // been added... i have seen cases where we get here when // the view isn't yet added, so let's try not to crash. if (mView.getParent() != null) { if (localLOGV) Log.v(TAG, &quot;REMOVE! &quot; + mView + &quot; in &quot; + this); mWM.removeView(mView); } mView = null; } } å¯ä»¥å‘ç°ï¼Œåœ¨æ–¹æ³•ä½“é‡è°ƒç”¨äº†mWM.removeView(mView),åˆæ˜¯ç†Ÿæ‚‰çš„ä»£ç ï¼Œé€šè¿‡æ‰§è¡Œè¿™é‡Œçš„removeViewæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°Toastçª—å£çš„é”€æ¯æµç¨‹ï¼Œè‡³æ­¤æˆ‘ä»¬å°±åˆ†æå®Œäº†Toastçª—å£çš„æ˜¾ç¤ºä¸é”€æ¯æµç¨‹ã€‚ æ€»ç»“ï¼š Toastæ˜¯ä¸€ä¸ªç³»ç»Ÿçª—å£ï¼ŒToaståœ¨æ˜¾ç¤ºä¸é”€æ¯æµç¨‹è®¾è®¡åˆ°è¿›ç¨‹é—´é€šè®¯ï¼ˆBinderæœºåˆ¶å®ç°ï¼‰ Toastçš„showæ–¹æ³•é¦–å…ˆä¼šåˆå§‹åŒ–ä¸€ä¸ªToastå¯¹è±¡ï¼Œç„¶åå°†å†…éƒ¨å¯¹è±¡TNä¸durationä¼ é€’ç»™NotificationManagerServiceï¼Œå¹¶åœ¨NotificationManagerServiceç«¯ç»´æŠ¤ä¸€ä¸ªToastå¯¹è±¡åˆ—è¡¨ã€‚ NotificationManagerServiceæ¥æ”¶åˆ°Toastçš„showè¯·æ±‚ä¹‹åï¼Œä¿å­˜Toastå¯¹è±¡å¹¶å›è°ƒToast.TNçš„showæ–¹æ³•å…·ä½“å®ç°Toastçª—å£çš„æ˜¾ç¤ºé€»è¾‘ã€‚ Toastçª—å£çš„æ˜¾ç¤ºä¸é”€æ¯æœºåˆ¶ä¸Activityã€Dialogã€PopupWIndowéƒ½æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯é€šè¿‡WIndowå¯¹è±¡å®ç°çš„ã€‚ NotificationManagerServiceç«¯åœ¨æ‰§è¡Œshowæ–¹æ³•æ‰§è¡Œä¼šå‘é€ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ç”¨äºé”€æ¯Toastçª—å£ï¼Œè¿™ä¸ªå¼‚æ­¥æ¶ˆæ¯ä¼šåœ¨durationæ—¶é—´æ®µä¹‹åå‘å‡ºï¼Œè¿™æ ·ï¼Œåœ¨è®¾ç½®Toastæ˜¾ç¤ºçš„æ—¶é—´å°±ä¼šè¢«ä¼ é€’åˆ°NotificationManagerServiceç«¯ï¼Œå¹¶åœ¨è¿™æ®µæ—¶é—´ä¹‹åå‘é€å¼‚æ­¥æ¶ˆæ¯é”€æ¯Toastçª—å£ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹","link":"/2020/09/11/Toast%E5%8A%A0%E8%BD%BD%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/"},{"title":"15 activityé”€æ¯æµç¨‹","text":"ç»§ç»­æˆ‘ä»¬çš„æºç è§£æï¼Œä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬ä»‹ç»äº†Activityçš„å¯åŠ¨æµç¨‹ï¼Œä¸€ä¸ªå…¸å‹çš„åœºæ™¯å°±æ˜¯Activity a å¯åŠ¨äº†ä¸€ä¸ªActivity bï¼Œä»–ä»¬çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒæ–¹æ³•æ˜¯ï¼šonPause(a) â€“&gt; onCreate(b) â€“&gt; onStart(b) â€“&gt; onResume(b) â€“&gt; onStop(a)è€Œæˆ‘ä»¬æ ¹æ®æºç ä¹ŸéªŒè¯äº†è¿™æ ·çš„ç”Ÿå‘½å‘¨æœŸè°ƒç”¨åºåˆ—ï¼Œé‚£ä¹ˆActivityçš„é”€æ¯æµç¨‹å‘¢ï¼Ÿå®ƒçš„ç”Ÿå‘½å‘¨æœŸçš„è°ƒç”¨é¡ºåºåˆæ˜¯è¿™æ ·çš„å‘¢ï¼Ÿ è¿™é‡Œæˆ‘ä»¬æˆ‘åšä¸€ä¸ªç®€å•çš„demoï¼Œè®©ä¸€ä¸ªActivity aå¯åŠ¨Activity bï¼Œç„¶ååœ¨bä¸­è°ƒç”¨finish()æ–¹æ³•ï¼Œå®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸæ‰§è¡Œé¡ºåºæ˜¯ï¼š onPause(b)onRestart(a)onStart(a)onResume(a)onStop(b)onDestory(b) å¥½å§ï¼Œæ ¹æ®æˆ‘ä»¬æµ‹è¯•çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„å›è°ƒè¿‡ç¨‹å¼€å§‹å¯¹Activityé”€æ¯æµç¨‹çš„åˆ†æï¼Œä¸€èˆ¬è€Œè¨€å½“æˆ‘ä»¬éœ€è¦é”€æ¯Activityçš„æ—¶å€™éƒ½ä¼šè°ƒç”¨å…¶è‡ªèº«çš„finishæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æµç¨‹å¼€å§‹æ˜¯ä»¥finishæ–¹æ³•å¼€å§‹çš„ã€‚ ä¸€ï¼šè¯·æ±‚é”€æ¯å½“å‰Activity MyActivity.finish()Activity.finish()ActivityManagerNative.getDefault().finishActivity()ActivityManagerService.finishActivity()ActivityStack.requestFinishActivityLocked()ActivityStack.finishActivityLocked()ActivityStack.startPausingLocked() é¦–å…ˆæˆ‘ä»¬åœ¨è‡ªå·±çš„Activityè°ƒç”¨äº†finishæ–¹æ³•ï¼Œå®ƒå®é™…ä¸Šè°ƒç”¨çš„æ˜¯Activityçš„finishæ–¹æ³•ï¼š 123public void finish() { finish(false);}ç„¶åæˆ‘ä»¬å¯ä»¥å‘ç°å…¶è°ƒç”¨äº†finishæ–¹æ³•çš„é‡è½½æ–¹æ³•ï¼Œå¹¶ä¸”ä¼ é€’äº†ä¸€ä¸ªå‚æ•°å€¼ï¼š 123456789101112131415161718192021222324private void finish(boolean finishTask) { if (mParent == null) { int resultCode; Intent resultData; synchronized (this) { resultCode = mResultCode; resultData = mResultData; } if (false) Log.v(TAG, &quot;Finishing self: token=&quot; + mToken); try { if (resultData != null) { resultData.prepareToLeaveProcess(); } if (ActivityManagerNative.getDefault() .finishActivity(mToken, resultCode, resultData, finishTask)) { mFinished = true; } } catch (RemoteException e) { // Empty } } else { mParent.finishFromChild(this); } } å¥½å§ï¼Œè¿™ä¸ªå‚æ•°å€¼ä¼¼ä¹å¹¶æ²¡ä»€ä¹ˆç”¨ã€‚ã€‚ã€‚è¿™é‡Œå°±ä¸åœ¨è®¨è®ºäº†ï¼Œç„¶åè°ƒç”¨äº†ActivityManagerNative.getDefault().finishActivityæ–¹æ³•ï¼Œå¥½å§ï¼Œæ ¹æ®ä¸Šä¸€ç¯‡æ–‡ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“äº†ActivityManagerNativeæ˜¯ä¸€ä¸ªBinderå¯¹è±¡ï¼Œè¿™é‡Œè°ƒç”¨çš„æ–¹æ³•æœ€ç»ˆä¼šè¢«ActivityManagerServiceæ‰§è¡Œï¼Œæ‰€ä»¥è¿™äº†çš„finishActivityæœ€ç»ˆè¢«æ‰§è¡Œçš„æ˜¯ActivityManagerService.finishActivityæ–¹æ³•ï¼Œå¥½å§ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ActivityManagerServiceçš„finishActivityæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ã€‚ã€‚ã€‚ 123456@Overridepublic final boolean finishActivity(IBinder token, int resultCode, Intent resultData, boolean finishTask) { ... res = tr.stack.requestFinishActivityLocked(token, resultCode,resultData, &quot;app-request&quot;, true); ...} è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œç»è¿‡ä¸€ç³»åˆ—é€»è¾‘åˆ¤æ–­ä¹‹åï¼Œæœ€ç»ˆè°ƒç”¨äº†ActivityStackçš„requestFinishActivityLockedæ–¹æ³•ï¼Œè¿™é‡Œåº”è¯¥å°±æ˜¯æ‰§è¡Œfinish Activityçš„é€»è¾‘äº†ã€‚ 1234567891011121314final boolean requestFinishActivityLocked(IBinder token, int resultCode, Intent resultData, String reason, boolean oomAdj) { ActivityRecord r = isInStackLocked(token); if (DEBUG_RESULTS || DEBUG_STATES) Slog.v(TAG_STATES, &quot;Finishing activity token=&quot; + token + &quot; r=&quot; + &quot;, result=&quot; + resultCode + &quot;, data=&quot; + resultData + &quot;, reason=&quot; + reason); if (r == null) { return false; } finishActivityLocked(r, resultCode, resultData, reason, oomAdj); return true; } è¿™ä¸ªæ–¹æ³•ä½“é‡Œé¢åˆè°ƒç”¨äº†finishActivityLockedæ–¹æ³•ï¼Œé‚£æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹finishActivityLockedæ–¹æ³•çš„å®ç°ï¼š 1234567final boolean finishActivityLocked(ActivityRecord r, int resultCode, Intent resultData, String reason, boolean oomAdj) { ... startPausingLocked(false, false, false, false); ... return false; } å¥½å§ï¼Œåœ¨è¿™é‡Œè°ƒç”¨äº†startPausingLockedæ–¹æ³•ï¼Œçœ‹åå­—åº”è¯¥æ˜¯å¼€å§‹è¦æ‰§è¡ŒActivityçš„onPauseæ–¹æ³•è¯·æ±‚äº†ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹startPausingLockedæ–¹æ³•çš„å®ç°ï¼š 123456789101112131415161718final boolean startPausingLocked(boolean userLeaving, boolean uiSleeping, boolean resuming, boolean dontWait) { ... try { EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY, prev.userId, System.identityHashCode(prev), prev.shortComponentName); mService.updateUsageStats(prev, false); prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing, userLeaving, prev.configChangeFlags, dontWait); } catch (Exception e) { // Ignore exception, if process died other code will cleanup. Slog.w(TAG, &quot;Exception thrown during pause&quot;, e); mPausingActivity = null; mLastPausedActivity = null; mLastNoHistoryActivity = null; } ... } è¿™æ ·ä»åº”ç”¨ç¨‹åºè°ƒç”¨finishæ–¹æ³•ï¼ŒActivityManagerServiceæ¥æ”¶è¯·æ±‚å¹¶æ‰§è¡ŒstartPausingLockedæ–¹æ³•ã€‚ äºŒï¼šæ‰§è¡Œå½“å‰Activityçš„onPauseæ–¹æ³• IApplicationThread.schedulePauseActivity()ActivityThread.schedulePauseActivity()ActivityThread.sendMessage()ActivityThread.H.sendMessage()ActivityThread.H.handleMessage()ActivityThread.handlePauseActivity()ActivityThread.performPauseActivity()Instrumentation.callActivityOnPause()Activity.performPause()Activity.onPause()ActivityManagerNative.getDefault().activityPaused()ActivityManagerService.activityPaused()ActivityStack.activityPausedLocked()ActivityStack.completePauseLocked() åœ¨æ–¹æ³•startPausingLockedä¸­æˆ‘ä»¬è°ƒç”¨äº†ï¼šprev.app.thread.schedulePauseActivityè¿™é‡Œå®é™…ä¸Šè°ƒç”¨çš„æ˜¯IApplicationThreadçš„schedulePauseActivityæ–¹æ³•ï¼ŒIApplicationThreadä¹Ÿæ˜¯ä¸€ä¸ªBinderå¯¹è±¡ï¼Œå®ƒæ˜¯ActivityThreadä¸­ApplicationThreadçš„Binder clientç«¯ï¼Œæ‰€ä»¥æœ€ç»ˆä¼šè°ƒç”¨çš„æ˜¯ApplicationThreadçš„schedulePauseActivityæ–¹æ³•ï¼Œå¥½å§æˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityThreadçš„schedulePauseActivityæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456public final void schedulePauseActivity(IBinder token, boolean finished, boolean userLeaving, int configChanges, boolean dontReport) { sendMessage( finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY, token, (userLeaving ? 1 : 0) | (dontReport ? 2 : 0), configChanges);} ç„¶åè°ƒç”¨äº†ActivityThreadçš„sendMessageæ–¹æ³•ï¼š 123private void sendMessage(int what, Object obj, int arg1, int arg2) { sendMessage(what, obj, arg1, arg2, false); } ç„¶ååˆå›è°ƒäº†sendMessageçš„é‡è½½æ–¹æ³•ã€‚ã€‚ 1234567891011121314private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) { if (DEBUG_MESSAGES) Slog.v( TAG, &quot;SCHEDULE &quot; + what + &quot; &quot; + mH.codeToString(what) + &quot;: &quot; + arg1 + &quot; / &quot; + obj); Message msg = Message.obtain(); msg.what = what; msg.obj = obj; msg.arg1 = arg1; msg.arg2 = arg2; if (async) { msg.setAsynchronous(true); } mH.sendMessage(msg); } æœ€ç»ˆè°ƒç”¨mHå‘é€å¼‚æ­¥æ¶ˆæ¯ï¼Œç„¶ååœ¨mHçš„handleMessgeæ–¹æ³•ä¸­å¤„ç†å¼‚æ­¥æ¶ˆæ¯å¹¶è°ƒç”¨handlePauseActivityæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627private void handlePauseActivity(IBinder token, boolean finished, boolean userLeaving, int configChanges, boolean dontReport) { ActivityClientRecord r = mActivities.get(token); if (r != null) { //Slog.v(TAG, &quot;userLeaving=&quot; + userLeaving + &quot; handling pause of &quot; + r); if (userLeaving) { performUserLeavingActivity(r); } r.activity.mConfigChangeFlags |= configChanges; performPauseActivity(token, finished, r.isPreHoneycomb()); // Make sure any pending writes are now committed. if (r.isPreHoneycomb()) { QueuedWork.waitToFinish(); } // Tell the activity manager we have paused. if (!dontReport) { try { ActivityManagerNative.getDefault().activityPaused(token); } catch (RemoteException ex) { } } mSomeActivitiesChanged = true; } } å¥½å§ï¼Œè¿™é‡Œå›è°ƒäº†performPauseActivityæ–¹æ³•ï¼Œä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»åˆ†æè¿‡äº†è¿™æ®µä»£ç ï¼š performPauseActivity()Instrumentation.callActivityOnPause()Activity.performPause()Activity.onPause() è¿™æ ·æˆ‘ä»¬å°±å›è°ƒäº†ç¬¬ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼šonPauseã€‚ã€‚ã€‚ åœ¨handlePauseActivityæ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨äº†ActivityManagerNative.getDefault().activityPaused(token)æ–¹æ³•ï¼Œå¥½å§åˆæ˜¯å›è°ƒActivityManagerServiceçš„æ–¹æ³•ï¼Œè¿™æ ·æœ€ç»ˆä¼šè°ƒç”¨ActivityManagerServiceçš„activityPausedæ–¹æ³•ï¼š 1234567891011@Override public final void activityPaused(IBinder token) { final long origId = Binder.clearCallingIdentity(); synchronized(this) { ActivityStack stack = ActivityRecord.getStackLocked(token); if (stack != null) { stack.activityPausedLocked(token, false); } } Binder.restoreCallingIdentity(origId); } è¿™æ ·ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹activityPausedLockedæ–¹æ³•çš„å®ç°ï¼š 12345final void activityPausedLocked(IBinder token, boolean timeout) { ... completePauseLocked(true); ...} é‡Œé¢åˆç»è¿‡ä¸€ç³»åˆ—çš„é€»è¾‘åˆ¤æ–­ä¹‹åï¼Œå¼€å§‹æ‰§è¡ŒcompletePauseLockedæ–¹æ³•ï¼š 1234private void completePauseLocked(boolean resumeNext) { ... mStackSupervisor.resumeTopActivitiesLocked(topStack, null, null); ... } è¿™æ ·æ ˆé¡¶Activityçš„onPauseæ“ä½œå°±æ‰§è¡Œå®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±å°±æ˜¯å¼€å§‹æ‰§è¡Œä¸Šä¸€ä¸ªActivityçš„onResumeæ“ä½œäº†ã€‚ã€‚ã€‚ ä¸‰ï¼šæ‰§è¡Œä¸Šä¸€ä¸ªActivityçš„onResumeæ“ä½œè¿™æ ·è°ƒç”¨äº†ActivityStackSupervisor.resumeTopActivitiesLockedæ–¹æ³•ã€‚ã€‚ï¼Œåˆå¼€å§‹è°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªæ–¹æ³•å®é™…ä¸Šæ˜¯æ‰§è¡ŒActivityçš„åˆå§‹åŒ–ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶å…·ä½“çš„è°ƒç”¨è¿‡ç¨‹ï¼š ActivityStack.resumeTopActivityLocked()ActivityStack.resumeTopInnerLocked()IApplicationThread.scheduleResumeActivity()ActivityThread.scheduleResumeActivity()ActivityThread.sendMessage()ActivityTherad.H.sendMessage()ActivityThread.H.handleMessage()ActivityThread.H.handleResumeMessage()Activity.performResume()Activity.performRestart()Instrumentation.callActivityOnRestart()Activity.onRestart()Activity.performStart()Instrumentation.callActivityOnStart()Activity.onStart()Instrumentation.callActivityOnResume()Activity.onResume() å¥½å§ï¼Œè¿™ä¸ªè¿‡ç¨‹å…¶å®ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å·²ç»åšäº†ä»‹ç»ï¼Œè¿™é‡Œä¸åšè¿‡å¤šçš„åˆ†æäº†ï¼Œé€šè¿‡è¿™æ ·è°ƒç”¨è¿‡ç¨‹æˆ‘ä»¬æœ€ç»ˆæ‰§è¡Œäº†å½“å‰æ ˆé¡¶Activityä¸Šä¸€ä¸ªActivityçš„onRestartæ–¹æ³•ï¼ŒonStartæ–¹æ³•ï¼ŒonResumeæ–¹æ³•ç­‰ï¼Œä¸‹é¢æˆ‘ä»¬å°†è°ƒç”¨æ ˆé¡¶Activityçš„onStopæ–¹æ³•ï¼ŒonDestoryæ–¹æ³•ã€‚ å››ï¼šæ‰§è¡Œæ ˆé¡¶Activityçš„é”€æ¯æ“ä½œ Looper.myQueue().addIdleHandler(new Idler())ActivityManagerNative.getDefault().activityIdle()ActivityManagerService.activityIdle()ActivityStackSupervisor.activityIdleInternalLocked()ActivityStack.destroyActivityLocked()IApplicationThread.scheduleDestoryActivity()ActivityThread.scheduleDestoryActivity()ActivityThread.sendMessage()ActivityThread.H.sendMessage()ActivityThread.H.handleMessage()ActivityThread.handleDestoryActivity()ActivityThread.performDestoryActivity()Activity.performStop()Instrumentation.callActivityOnStop()Activity.onStop()Instrumentation.callActivityOnDestory()Activity.performDestory()Acitivity.onDestory()ActivityManagerNative.getDefault().activityDestoryed()ActivityManagerService.activityDestoryed()ActivityStack.activityDestoryedLocked() æˆ‘ä»¬åœ¨ActivityThread.handleResumeActivityæ–¹æ³•ä¸­è°ƒç”¨äº†Looper.myQueue().addIdleHandler(new Idler())ï¼Œä¸‹é¢çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738private class Idler implements MessageQueue.IdleHandler { @Override public final boolean queueIdle() { ActivityClientRecord a = mNewActivities; boolean stopProfiling = false; if (mBoundApplication != null &amp;&amp; mProfiler.profileFd != null &amp;&amp; mProfiler.autoStopProfiler) { stopProfiling = true; } if (a != null) { mNewActivities = null; IActivityManager am = ActivityManagerNative.getDefault(); ActivityClientRecord prev; do { if (localLOGV) Slog.v( TAG, &quot;Reporting idle of &quot; + a + &quot; finished=&quot; + (a.activity != null &amp;&amp; a.activity.mFinished)); if (a.activity != null &amp;&amp; !a.activity.mFinished) { try { am.activityIdle(a.token, a.createdConfig, stopProfiling); a.createdConfig = null; } catch (RemoteException ex) { // Ignore } } prev = a; a = a.nextIdle; prev.nextIdle = null; } while (a != null); } if (stopProfiling) { mProfiler.stopProfiling(); } ensureJitEnabled(); return false; } } å†…éƒ¨æœ‰ä¸€ä¸ªqueueIdleçš„å›è°ƒæ–¹æ³•ï¼Œå½“å®ƒè¢«æ·»åŠ åˆ°MessageQueueä¹‹åå°±ä¼šå›è°ƒè¯¥æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åœ¨è¿™ä¸ªæ–¹æ³•ä½“ä¸­è°ƒç”¨äº†ActivityManagerNative.getDefault.activityIdleæ–¹æ³•ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« ä»¥åŠä¸Šé¢çš„è®²è§£ï¼Œæˆ‘ä»¬åº”è¯¥çŸ¥é“è¿™äº†æœ€ç»ˆè°ƒç”¨çš„æ˜¯ActivityManagerService.activityIdleæ–¹æ³•ï¼Œå¥½å§ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹activityIdleæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021@Override public final void activityIdle(IBinder token, Configuration config, boolean stopProfiling) { final long origId = Binder.clearCallingIdentity(); synchronized (this) { ActivityStack stack = ActivityRecord.getStackLocked(token); if (stack != null) { ActivityRecord r = mStackSupervisor.activityIdleInternalLocked(token, false, config); if (stopProfiling) { if ((mProfileProc == r.app) &amp;&amp; (mProfileFd != null)) { try { mProfileFd.close(); } catch (IOException e) { } clearProfilerLocked(); } } } } Binder.restoreCallingIdentity(origId); } å¯ä»¥å‘ç°è¿™é‡Œåˆè°ƒç”¨äº†ActivityStackSupervisor.activityIdleInternalLockedæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹activityIdleInternalLockedæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345final ActivityRecord activityIdleInternalLocked(final IBinder token, boolean fromTimeout, Configuration config) { .... stack.destroyActivityLocked(r, true, &quot;finish-idle&quot;); .... } å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨ActivityStack.destroyActivityLockedæ–¹æ³•ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å…¶å…·ä½“å®ç°ï¼š 12345final boolean destroyActivityLocked(ActivityRecord r, boolean removeFromApp, String reason) { ... r.app.thread.scheduleDestroyActivity(r.appToken, r.finishing, r.configChangeFlags); ... } å¥½å§ï¼Œè¿™é‡Œåˆå¼€å§‹æ‰§è¡ŒIApplicationThread.scheduleDestoryActivityæ–¹æ³•ï¼Œä¸Šæ–‡å·²ç»åšäº†è¯´æ˜è¿™é‡Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ActivityThread.scheduleDestroyActivityæ–¹æ³•ï¼Œå¥½å§ï¼Œçœ‹ä¸€ä¸‹ActivityThread.scheduleDestryActivityæ–¹æ³•çš„å®ç°ï¼š 1234public final void scheduleDestroyActivity(IBinder token, boolean finishing, int configChanges) { sendMessage(H.DESTROY_ACTIVITY, token, finishing ? 1 : 0, configChanges);} è¿™é‡Œæœ‰å¼€å§‹æ‰§è¡ŒsendMessageæ–¹æ³•ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨sendMessageæ–¹æ³•æœ€ç»ˆè°ƒç”¨äº†handleDestroyActivityæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859private void handleDestroyActivity(IBinder token, boolean finishing, int configChanges, boolean getNonConfigInstance) { ActivityClientRecord r = performDestroyActivity(token, finishing, configChanges, getNonConfigInstance); if (r != null) { cleanUpPendingRemoveWindows(r); WindowManager wm = r.activity.getWindowManager(); View v = r.activity.mDecor; if (v != null) { if (r.activity.mVisibleFromServer) { mNumVisibleActivities--; } IBinder wtoken = v.getWindowToken(); if (r.activity.mWindowAdded) { if (r.onlyLocalRequest) { // Hold off on removing this until the new activity's // window is being added. r.mPendingRemoveWindow = v; r.mPendingRemoveWindowManager = wm; } else { wm.removeViewImmediate(v); } } if (wtoken != null &amp;&amp; r.mPendingRemoveWindow == null) { WindowManagerGlobal.getInstance().closeAll(wtoken, r.activity.getClass().getName(), &quot;Activity&quot;); } r.activity.mDecor = null; } if (r.mPendingRemoveWindow == null) { // If we are delaying the removal of the activity window, then // we can't clean up all windows here. Note that we can't do // so later either, which means any windows that aren't closed // by the app will leak. Well we try to warning them a lot // about leaking windows, because that is a bug, so if they are // using this recreate facility then they get to live with leaks. WindowManagerGlobal.getInstance().closeAll(token, r.activity.getClass().getName(), &quot;Activity&quot;); } // Mocked out contexts won't be participating in the normal // process lifecycle, but if we're running with a proper // ApplicationContext we need to have it tear down things // cleanly. Context c = r.activity.getBaseContext(); if (c instanceof ContextImpl) { ((ContextImpl) c).scheduleFinalCleanup( r.activity.getClass().getName(), &quot;Activity&quot;); } } if (finishing) { try { ActivityManagerNative.getDefault().activityDestroyed(token); } catch (RemoteException ex) { // If the system process has died, it's game over for everyone. } } mSomeActivitiesChanged = true; } å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†performDestroyActivityæ–¹æ³•ï¼Œç”¨æ¥æ‰§è¡ŒAvtivityçš„onDestroyæ–¹æ³•ï¼š 12345678private ActivityClientRecord performDestroyActivity(IBinder token, boolean finishing, int configChanges, boolean getNonConfigInstance) { ... r.activity.performStop(); ... mInstrumentation.callActivityOnDestroy(r.activity); ... } ç„¶åè°ƒç”¨äº†Activity.performStop()æ–¹æ³•ï¼ŒæŸ¥çœ‹performStopæ–¹æ³•ï¼š 12345final void performStop() { ... mInstrumentation.callActivityOnStop(this); ...} ç„¶åè°ƒç”¨äº†Instrumentation.callActivityOnStop()æ–¹æ³•ï¼š 123public void callActivityOnStop(Activity activity) { activity.onStop(); } å¥½å§ï¼Œç»ˆäºè°ƒç”¨äº†Activityçš„onStopæ–¹æ³•ã€‚ã€‚ã€‚ æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹Instrumentation.callActivityOnDestroy()ã€‚ã€‚ã€‚ã€‚åˆæ˜¯é€šè¿‡Instrumentationæ¥è°ƒç”¨Activityçš„onDestroyæ–¹æ³•ï¼š 12345public void callActivityOnDestroy(Activity activity) { ... activity.performDestroy(); ...} ç„¶åçœ‹ä¸€ä¸‹Activityçš„performDestroy()æ–¹æ³•çš„å®ç°ï¼š 12345678910final void performDestroy() { mDestroyed = true; mWindow.destroy(); mFragments.dispatchDestroy(); onDestroy(); mFragments.doLoaderDestroy(); if (mVoiceInteractor != null) { mVoiceInteractor.detachActivity(); } } O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œç»ˆäºå›è°ƒäº†Activityçš„onDestroyæ–¹æ³•ã€‚ã€‚ã€‚ã€‚ æ€»ç»“ï¼š Activityçš„é”€æ¯æµç¨‹æ˜¯ä»finishæ–¹æ³•å¼€å§‹çš„ Activityé”€æ¯è¿‡ç¨‹æ˜¯ï¼šonPause â€“&gt; onRestart â€“&gt; onStart â€“&gt; onResume â€“&gt; onStop â€“&gt; onDestroy Activityçš„é”€æ¯æµç¨‹æ˜¯ActivityThreadä¸ActivityManagerServiceç›¸äº’é…åˆé”€æ¯çš„ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹","link":"/2020/09/11/activity%E9%94%80%E6%AF%81%E6%B5%81%E7%A8%8B/"},{"title":"Androidå¼‚æ­¥ä»»åŠ¡AsyncTask","text":"androidçš„å¼‚æ­¥ä»»åŠ¡ä½“ç³»ä¸­è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ“ä½œç±»ï¼šAsyncTaskï¼Œå…¶å†…éƒ¨ä¸»è¦ä½¿ç”¨çš„æ˜¯javaçš„çº¿ç¨‹æ± å’ŒHandleræ¥å®ç°å¼‚æ­¥ä»»åŠ¡ä»¥åŠä¸UIçº¿ç¨‹çš„äº¤äº’ã€‚æœ¬æ–‡ä¸»è¦è§£æAsyncTaskçš„çš„ä½¿ç”¨ä¸æºç ã€‚ é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹AsyncTaskçš„åŸºæœ¬ä½¿ç”¨ï¼š 12345678910111213141516171819class MAsyncTask extends AsyncTask&lt;Integer, Integer, Integer&gt; { @Override protected void onPreExecute() { super.onPreExecute(); Log.i(TAG, &quot;onPreExecute...(å¼€å§‹æ‰§è¡Œåå°ä»»åŠ¡ä¹‹å‰)&quot;); } @Override protected void onPostExecute(Integer i) { super.onPostExecute(i); Log.i(&quot;TAG&quot;, &quot;onPostExecute...(å¼€å§‹æ‰§è¡Œåå°ä»»åŠ¡ä¹‹å)&quot;); } @Override protected Integer doInBackground(Integer... params) { Log.i(TAG, &quot;doInBackground...(å¼€å§‹æ‰§è¡Œåå°ä»»åŠ¡)&quot;); return 0; } } æˆ‘ä»¬å®šä¹‰äº†è‡ªå·±çš„MAsyncTaskå¹¶ç»§æ‰¿è‡ªAsyncTaskï¼›å¹¶é‡å†™äº†å…¶ä¸­çš„æ˜¯å“ªä¸ªå›è°ƒæ–¹æ³•ï¼šonPreExecute()ï¼ŒonPostExecuteï¼ˆï¼‰ï¼ŒdoInBackground();ç„¶åå¼€å§‹è°ƒç”¨å¼‚æ­¥ä»»åŠ¡ï¼š 1new MAsyncTask().execute(); å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹åˆ†æå¼‚æ­¥ä»»åŠ¡çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œé¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹å¼‚æ­¥ä»»åŠ¡çš„æ„é€ æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132/** * Creates a new asynchronous task. This constructor must be invoked on the UI thread. */ public AsyncTask() { mWorker = new WorkerRunnable&lt;Params, Result&gt;() { public Result call() throws Exception { mTaskInvoked.set(true); Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND); //noinspection unchecked Result result = doInBackground(mParams); Binder.flushPendingCommands(); return postResult(result); } }; mFuture = new FutureTask&lt;Result&gt;(mWorker) { @Override protected void done() { try { postResultIfNotInvoked(get()); } catch (InterruptedException e) { android.util.Log.w(LOG_TAG, e); } catch (ExecutionException e) { throw new RuntimeException(&quot;An error occurred while executing doInBackground()&quot;, e.getCause()); } catch (CancellationException e) { postResultIfNotInvoked(null); } } }; } å’‹ä¸€çœ‹AsyncTaskçš„æ„é€ æ–¹æ³•ä»£ç é‡è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ï¼Œä½†æ˜¯ä»”ç»†ä¸€çœ‹å…¶å®è¿™é‡Œé¢åªæ˜¯åˆå§‹åŒ–äº†ä¸¤ä¸ªæˆå‘˜å˜é‡ï¼šmWorkerå’ŒmFutureä»–ä»¬åˆ†åˆ«æ˜¯ï¼šWorkerRunnableå’ŒFutureTaskï¼Œç†Ÿæ‚‰javaçš„ç«¥é‹åº”è¯¥çŸ¥é“è¿™ä¸¤ä¸ªç±»å…¶å®æ˜¯javaé‡Œé¢çº¿ç¨‹æ± å…ˆå…³çš„æ¦‚å¿µã€‚å…¶å…·ä½“ç”¨æ³•å¤§å®¶å¯ä»¥åœ¨ç½‘ä¸ŠæŸ¥è¯¢ï¼Œè¿™é‡Œå…·ä½“çš„ç»†èŠ‚ä¸åœ¨è¡¨è¿°ï¼Œé‡ç‚¹æ˜¯å¯¹å¼‚æ­¥ä»»åŠ¡æ•´ä½“æµç¨‹çš„æŠŠæ¡ã€‚ æ€»ç»“ï¼šå¼‚æ­¥ä»»åŠ¡çš„æ„é€ æ–¹æ³•ä¸»è¦ç”¨äºåˆå§‹åŒ–çº¿ç¨‹æ± å…ˆå…³çš„æˆå‘˜å˜é‡ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹executeæ–¹æ³•ï¼š 1234@MainThread public final AsyncTask&lt;Params, Progress, Result&gt; execute(Params... params) { return executeOnExecutor(sDefaultExecutor, params); } è¿™é‡Œå‘ç°è¯¥æ–¹æ³•ä¸­æ·»åŠ ä¸€ä¸ª@MainThreadçš„æ³¨è§£ï¼Œé€šè¿‡è¯¥æ³¨è§£ï¼Œå¯ä»¥çŸ¥é“æˆ‘ä»¬åœ¨æ‰§è¡ŒAsyncTaskçš„executeæ–¹æ³•æ—¶ï¼Œåªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè¿™é‡Œå¯ä»¥å®éªŒä¸€ä¸‹ï¼š 12345678new Thread(new Runnable() { @Override public void run() { Log.i(&quot;tag&quot;, Thread.currentThread().getId() + &quot;&quot;); new MAsyncTask().execute(); } }).start(); Log.i(&quot;tag&quot;, &quot;mainThread:&quot; + Thread.currentThread().getId() + &quot;&quot;); ç„¶åæ‰§è¡Œï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œç¨‹åºè¿˜æ˜¯å¯ä»¥æ­£å¸¸æ‰§è¡Œï¼Œæˆ‘çš„æ‰‹æœºçš„Androidç³»ç»Ÿæ˜¯Android5.0ï¼Œå…·ä½“åŸå› å°šæœªæ‰¾åˆ°ï¼Œæ¬¢è¿æœ‰çŸ¥é“ç­”æ¡ˆçš„ç«¥é‹å¯ä»¥ç›¸äº’æ²Ÿé€šå“ˆã€‚ä½†æ˜¯è¿™é‡Œéœ€è¦ä¸»è¦çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼šonPreExecuteæ–¹æ³•æ˜¯ä¸å¼€å§‹æ‰§è¡Œçš„executeæ–¹æ³•æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­çš„ï¼Œæ‰€ä»¥å¦‚æœåœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œexecuteæ–¹æ³•ï¼Œä¸€å®šè¦ç¡®ä¿onPreExecuteæ–¹æ³•ä¸æ‰§è¡Œåˆ·æ–°UIçš„æ–¹æ³•ï¼Œå¦åˆ™ï¼š 123456@Override protected void onPreExecute() { super.onPreExecute(); title.setText(&quot;########&quot;); Log.i(TAG, &quot;onPreExecute...(å¼€å§‹æ‰§è¡Œåå°ä»»åŠ¡ä¹‹å‰)&quot;); } 12345678910111213141516171819Process: com.example.aaron.helloworld, PID: 659 android.view.ViewRootImpl$CalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views. at android.view.ViewRootImpl.checkThread(ViewRootImpl.java:6981) at android.view.ViewRootImpl.requestLayout(ViewRootImpl.java:1034) at android.view.View.requestLayout(View.java:17704) at android.view.View.requestLayout(View.java:17704) at android.view.View.requestLayout(View.java:17704) at android.view.View.requestLayout(View.java:17704) at android.widget.RelativeLayout.requestLayout(RelativeLayout.java:380) at android.view.View.requestLayout(View.java:17704) at android.widget.TextView.checkForRelayout(TextView.java:7109) at android.widget.TextView.setText(TextView.java:4082) at android.widget.TextView.setText(TextView.java:3940) at android.widget.TextView.setText(TextView.java:3915) at com.example.aaron.helloworld.MainActivity$MAsyncTask.onPreExecute(MainActivity.java:53) at android.os.AsyncTask.executeOnExecutor(AsyncTask.java:587) at android.os.AsyncTask.execute(AsyncTask.java:535) at com.example.aaron.helloworld.MainActivity$1$1.run(MainActivity.java:40) at java.lang.Thread.run(Thread.java:818) è‹¥åœ¨å­çº¿ç¨‹ä¸­æ‰§è¡Œexecuteæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™æ—¶å€™å¦‚æœåœ¨onPreExecuteæ–¹æ³•ä¸­åˆ·æ–°UIï¼Œä¼šæŠ¥é”™ï¼Œå³å­çº¿ç¨‹ä¸­ä¸èƒ½æ›´æ–°UIã€‚ ç»§ç»­çœ‹åˆšæ‰çš„executeæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å…¶å†…éƒ¨è°ƒç”¨äº†executeOnExecutoræ–¹æ³•ï¼š 123456789101112131415161718192021222324@MainThread public final AsyncTask&lt;Params, Progress, Result&gt; executeOnExecutor(Executor exec, Params... params) { if (mStatus != Status.PENDING) { switch (mStatus) { case RUNNING: throw new IllegalStateException(&quot;Cannot execute task:&quot; + &quot; the task is already running.&quot;); case FINISHED: throw new IllegalStateException(&quot;Cannot execute task:&quot; + &quot; the task has already been executed &quot; + &quot;(a task can be executed only once)&quot;); } } mStatus = Status.RUNNING; onPreExecute(); mWorker.mParams = params; exec.execute(mFuture); return this; } å¯ä»¥çœ‹åˆ°å…¶å…·ä½“çš„å†…éƒ¨å®ç°æ–¹æ³•é‡Œï¼šé¦–å…ˆåˆ¤æ–­å½“å‰å¼‚æ­¥ä»»åŠ¡çš„çŠ¶æ€ï¼Œå…¶å†…éƒ¨ä¿å­˜å¼‚æ­¥ä»»åŠ¡çŠ¶æ€çš„æˆå‘˜å˜é‡mStatusçš„é»˜è®¤å€¼ä¸ºStatus.PENDING,æ‰€ä»¥ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™å¹¶ä¸æŠ›å‡ºè¿™ä¸¤ä¸ªå¼‚å¸¸ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™å›è¿›å…¥è¿™ä¸ªifåˆ¤æ–­å¹¶æŠ›å‡ºå¼‚å¸¸å‘¢ï¼Œé€šè¿‡æŸ¥çœ‹æºä»£ç å¯ä»¥çŸ¥é“ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œäº†executeæ–¹æ³•ä¹‹åï¼Œå¦‚æœå†æ¬¡æ‰§è¡Œå°±ä¼šè¿›å…¥è¿™é‡Œçš„ifæ¡ä»¶åˆ¤æ–­å¹¶æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™é‡Œå¯ä»¥å°è¯•ä¸€ä¸‹ï¼š 123456789101112131415161718192021final MAsyncTask mAsyncTask = new MAsyncTask(); title.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { /*MLog.e(&quot;you have clicked the title textview!!!&quot;); Intent intent = new Intent(MainActivity.this, SecondActivity.class); startActivityForResult(intent, 101);*/ new Thread(new Runnable() { @Override public void run() { Log.i(&quot;tag&quot;, Thread.currentThread().getId() + &quot;&quot;); mAsyncTask .execute(); } }).start(); Log.i(&quot;tag&quot;, &quot;mainThread:&quot; + Thread.currentThread().getId() + &quot;&quot;); } }); è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªAsyncTaskçš„å¯¹è±¡ï¼Œå¹¶ä¸”æ¯æ¬¡æ‰§è¡Œç‚¹å‡»äº‹ä»¶çš„å›è°ƒæ–¹æ³•éƒ½ä¼šæ‰§è¡Œexecuteæ–¹æ³•ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»ç¬¬ä¸€æ¬¡çš„æ—¶å€™ç¨‹åºæ­£å¸¸æ‰§è¡Œï¼Œä½†æ˜¯å½“æˆ‘ä»¬æ‰§è¡Œç¬¬äºŒæ¬¡çš„æ—¶å€™ï¼Œç¨‹åºå°±å´©æºƒäº†ã€‚è‹¥è¿™æ—¶å€™ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡å°šæœªæ‰§è¡Œå®Œæˆåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š 1Cannot execute task:the task is already running. è‹¥ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„å¼‚æ­¥ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæˆï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š 1Cannot execute task:the task has already been executed (a task can be executed only once) ç»§ç»­å¾€ä¸‹çœ‹ï¼Œåœ¨executeOnExecutorä¸­è‹¥æ²¡æœ‰è¿›å…¥å¼‚å¸¸åˆ†ä¹‹ï¼Œåˆ™å°†å½“å‰å¼‚æ­¥ä»»åŠ¡çš„çŠ¶æ€æ›´æ”¹ä¸ºRunningï¼Œç„¶åå›è°ƒonPreExecute()æ–¹æ³•ï¼Œè¿™é‡Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹onPreExecuteæ–¹æ³•å…¶å®æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯ä¸ºäº†ç”¨äºæˆ‘ä»¬çš„å›è°ƒå®ç°ï¼ŒåŒæ—¶è¿™é‡Œä¹Ÿè¯´æ˜äº†onPreExecuteï¼ˆï¼‰æ–¹æ³•æ˜¯ä¸executeæ–¹æ³•çš„æ‰§è¡Œåœ¨åŒä¸€çº¿ç¨‹ä¸­ã€‚ ç„¶åå°†executeæ–¹æ³•çš„å‚æ•°èµ‹å€¼ç»™mWorkerå¯¹è±¡é‚£ä¸ªï¼Œæœ€åæ‰§è¡Œexec.execute(mFuture)æ–¹æ³•ï¼Œå¹¶è¿”å›è‡ªèº«ã€‚ è¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹exec.execute(mFuture)çš„å…·ä½“å®ç°ï¼Œè¿™é‡Œçš„execå…¶å®æ˜¯AsyncTaskå®šä¹‰çš„ä¸€ä¸ªé»˜è®¤çš„Executorå¯¹è±¡ï¼š 1private static volatile Executor sDefaultExecutor = SERIAL_EXECUTOR; é‚£ä¹ˆï¼ŒSERIAL_EXECUTORåˆæ˜¯ä»€ä¹ˆä¸œè¥¿å‘¢ï¼Ÿ 1public static final Executor SERIAL_EXECUTOR = new SerialExecutor(); ç»§ç»­æŸ¥çœ‹SerialExecutorçš„å…·ä½“å®ç°ï¼š 12345678910111213141516171819202122232425private static class SerialExecutor implements Executor { final ArrayDeque&lt;Runnable&gt; mTasks = new ArrayDeque&lt;Runnable&gt;(); Runnable mActive; public synchronized void execute(final Runnable r) { mTasks.offer(new Runnable() { public void run() { try { r.run(); } finally { scheduleNext(); } } }); if (mActive == null) { scheduleNext(); } } protected synchronized void scheduleNext() { if ((mActive = mTasks.poll()) != null) { THREAD_POOL_EXECUTOR.execute(mActive); } } } å¯ä»¥å‘ç°å…¶ç»§æ‰¿Executorç±»å…¶å†…éƒ¨ä¿å­˜ç€ä¸€ä¸ªRunnableåˆ—è¡¨ï¼Œå³ä»»åŠ¡åˆ—è¡¨ï¼Œåœ¨åˆšåˆšçš„executeæ–¹æ³•ä¸­æ‰§è¡Œçš„exec.execute(mFuture)æ–¹æ³•å°±æ˜¯æ‰§è¡Œçš„è¿™é‡Œçš„executeæ–¹æ³•ã€‚è¿™é‡Œå…·ä½“çœ‹ä¸€ä¸‹executeæ–¹æ³•çš„å®ç°ï¼š1ï¼‰é¦–å…ˆè°ƒç”¨çš„æ˜¯mTasksçš„offeræ–¹æ³•ï¼Œå³å°†å¼‚æ­¥ä»»åŠ¡ä¿å­˜è‡³ä»»åŠ¡åˆ—è¡¨çš„é˜Ÿå°¾2ï¼‰åˆ¤æ–­mActiveå¯¹è±¡æ˜¯ä¸æ˜¯ç­‰äºnullï¼Œç¬¬ä¸€æ¬¡è¿è¡Œæ˜¯nullï¼Œç„¶åè°ƒç”¨scheduleNext()æ–¹æ³•3ï¼‰åœ¨scheduleNext()è¿™ä¸ªæ–¹æ³•ä¸­ä¼šä»é˜Ÿåˆ—çš„å¤´éƒ¨å–å€¼ï¼Œå¹¶èµ‹å€¼ç»™mActiveå¯¹è±¡ï¼Œç„¶åè°ƒç”¨THREAD_POOL_EXECUTORå»æ‰§è¡Œå–å‡ºçš„å–å‡ºçš„Runnableå¯¹è±¡ã€‚4ï¼‰åœ¨è¿™ä¹‹åå¦‚æœå†æœ‰æ–°çš„ä»»åŠ¡è¢«æ‰§è¡Œæ—¶å°±ç­‰å¾…ä¸Šä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åæ‰ä¼šå¾—åˆ°æ‰§è¡Œï¼Œæ‰€ä»¥è¯´åŒä¸€æ—¶åˆ»åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œã€‚5ï¼‰è¿™é‡Œçš„THREAD_POOL_EXECUTORå…¶å®æ˜¯ä¸€ä¸ªçº¿ç¨‹æ± å¯¹è±¡ã€‚ ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰§è¡Œè¿‡ç¨‹ä¸­mWorkerçš„æ‰§è¡Œé€»è¾‘ï¼š 1234567891011mWorker = new WorkerRunnable&lt;Params, Result&gt;() { public Result call() throws Exception { mTaskInvoked.set(true); Process.setThreadPriority(Process.THREAD_PRIORITY_BACKGROUND); //noinspection unchecked Result result = doInBackground(mParams); Binder.flushPendingCommands(); return postResult(result); } }; å¯ä»¥çœ‹åˆ°åœ¨æ‰§è¡Œçº¿ç¨‹æ± çš„ä»»åŠ¡æ—¶ï¼Œæˆ‘ä»¬å›è°ƒäº†doInBackgroundæ–¹æ³•ï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬é‡å†™AsyncTaskæ—¶é‡å†™doInBackgroundæ–¹æ³•æ˜¯åå°çº¿ç¨‹çš„åŸå› ã€‚ ç„¶ååœ¨ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åä¼šå›è°ƒæˆ‘ä»¬çš„doneæ–¹æ³•ï¼š 123456789101112131415mFuture = new FutureTask&lt;Result&gt;(mWorker) { @Override protected void done() { try { postResultIfNotInvoked(get()); } catch (InterruptedException e) { android.util.Log.w(LOG_TAG, e); } catch (ExecutionException e) { throw new RuntimeException(&quot;An error occurred while executing doInBackground()&quot;, e.getCause()); } catch (CancellationException e) { postResultIfNotInvoked(null); } } }; è¿™é‡Œæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹postResultIfNotInvokedæ–¹æ³•ï¼š 123456private void postResultIfNotInvoked(Result result) { final boolean wasTaskInvoked = mTaskInvoked.get(); if (!wasTaskInvoked) { postResult(result); } } å…¶å†…éƒ¨è¿˜æ˜¯è°ƒç”¨äº†postResultæ–¹æ³•ï¼š 1234567private Result postResult(Result result) { @SuppressWarnings(&quot;unchecked&quot;) Message message = getHandler().obtainMessage(MESSAGE_POST_RESULT, new AsyncTaskResult&lt;Result&gt;(this, result)); message.sendToTarget(); return result; } è¿™é‡Œå¯ä»¥çœ‹åˆ°èµ·è°ƒç”¨äº†å†…éƒ¨çš„Handlerå¯¹è±¡çš„sendToTargetæ–¹æ³•ï¼Œå‘é€å¼‚æ­¥æ¶ˆæ¯ï¼Œå…·ä½“handlerç›¸å…³çš„å†…å®¹å¯ä»¥å‚è€ƒï¼š androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ è¿½è¸ªä»£ç ï¼Œå¯ä»¥æŸ¥çœ‹AsyncTaskå†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªHandlerå¯¹è±¡ï¼š 1234567891011121314151617181920private static class InternalHandler extends Handler { public InternalHandler() { super(Looper.getMainLooper()); } @SuppressWarnings({&quot;unchecked&quot;, &quot;RawUseOfParameterizedType&quot;}) @Override public void handleMessage(Message msg) { AsyncTaskResult&lt;?&gt; result = (AsyncTaskResult&lt;?&gt;) msg.obj; switch (msg.what) { case MESSAGE_POST_RESULT: // There is only one result result.mTask.finish(result.mData[0]); break; case MESSAGE_POST_PROGRESS: result.mTask.onProgressUpdate(result.mData); break; } } } å¯ä»¥çœ‹åˆ°èµ·å†…éƒ¨çš„handleMessageæ–¹æ³•ï¼Œæœ‰ä¸¤ä¸ªå¤„ç†é€»è¾‘ï¼Œåˆ†åˆ«æ˜¯ï¼šæ›´æ–°è¿›å…¥æ¡å’Œæ‰§è¡Œå®Œæˆï¼Œè¿™é‡Œçš„æ›´æ–°è¿›åº¦çš„æ–¹æ³•å°±æ˜¯æˆ‘ä»¬é‡å†™AsyncTaskæ–¹æ³•æ—¶é‡å†™çš„æ›´æ–°è¿›åº¦çš„æ–¹æ³•ï¼Œè¿™é‡Œçš„å¼‚æ­¥ä»»åŠ¡å®Œæˆçš„æ¶ˆæ¯ä¼šè°ƒç”¨finishæ–¹æ³•ï¼š 12345678private void finish(Result result) { if (isCancelled()) { onCancelled(result); } else { onPostExecute(result); } mStatus = Status.FINISHED; } è¿™é‡ŒAsyncTaské¦–å…ˆä¼šåˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦è¢«å–æ¶ˆï¼Œè‹¥è¢«å–æ¶ˆçš„è¯åˆ™ç›´æ¥æ‰§è¡Œå–æ¶ˆçš„æ–¹æ³•ï¼Œå¦åˆ™æ‰§è¡ŒonPostExecuteæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬é‡å†™AsyncTaskæ—¶éœ€è¦é‡å†™çš„å¼‚æ­¥ä»»åŠ¡å®Œæˆæ—¶å›è°ƒçš„æ–¹æ³•ã€‚ å…¶å®æ•´ä¸ªå¼‚æ­¥ä»»åŠ¡çš„å¤§æ¦‚æµç¨‹å°±æ˜¯è¿™æ ·å­çš„ï¼Œå…¶ä¸­æ¶‰åŠçš„çŸ¥è¯†ç‚¹æ¯”è¾ƒå¤šï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹ï¼š å¼‚æ­¥ä»»åŠ¡å†…éƒ¨ä½¿ç”¨çº¿ç¨‹æ± æ‰§è¡Œåå°ä»»åŠ¡ï¼Œä½¿ç”¨Handlerä¼ é€’æ¶ˆæ¯ï¼› onPreExecuteæ–¹æ³•ä¸»è¦ç”¨äºåœ¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œä¹‹å‰åšä¸€äº›æ“ä½œï¼Œå®ƒæ‰€åœ¨çº¿ç¨‹ä¸å¼‚æ­¥ä»»åŠ¡çš„executeæ–¹æ³•æ‰€åœ¨çš„çº¿ç¨‹ä¸€è‡´ï¼Œè¿™é‡Œè‹¥éœ€è¦æ›´æ–°UIç­‰æ“ä½œï¼Œåˆ™executeæ–¹æ³•ä¸èƒ½å†å­çº¿ç¨‹ä¸­æ‰§è¡Œã€‚ é€šè¿‡åˆšåˆšçš„æºç åˆ†æå¯ä»¥çŸ¥é“å¼‚æ­¥ä»»åŠ¡ä¸€èˆ¬æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œå³ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åæ‰ä¼šæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚ doInBackgroundè¿™ä¸ªæ–¹æ³•æ‰€åœ¨çš„è¿›ç¨‹ä¸ºä»»åŠ¡æ‰€æ‰§è¡Œçš„è¿›ç¨‹ï¼Œåœ¨è¿™é‡Œå¯ä»¥è¿›è¡Œä¸€äº›åå°æ“ä½œã€‚ å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆä¹‹åä¼šé€šè¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨æ“ä½œï¼Œæœ€ç»ˆå›è°ƒæˆ‘ä»¬çš„onPostExecuteæ–¹æ³• å¼‚æ­¥ä»»åŠ¡å¯¹è±¡ä¸èƒ½æ‰§è¡Œå¤šæ¬¡ï¼Œå³ä¸èƒ½åˆ›å»ºä¸€ä¸ªå¯¹è±¡æ‰§è¡Œå¤šæ¬¡executeæ–¹æ³•ã€‚ï¼ˆé€šè¿‡executeæ–¹æ³•çš„æºç å¯ä»¥å¾—çŸ¥ï¼‰ æ‰€æœ‰æºç åŸºäºandroid23ï¼Œä¸­é—´æœ‰ä»€ä¹ˆç–æ¼æ¬¢è¿æŒ‡æ­£ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTask","link":"/2020/09/11/android%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1AsyncTask/"},{"title":"7 androidä¹‹LruCache","text":"androidå¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸ä¼šç”¨åˆ°ç¼“å­˜ï¼Œç°åœ¨ä¸»æµçš„appä¸­å›¾ç‰‡ç­‰èµ„æºçš„ç¼“å­˜ç­–ç•¥ä¸€èˆ¬æ˜¯åˆ†ä¸¤çº§ï¼Œä¸€ä¸ªæ˜¯å†…å­˜çº§åˆ«çš„ç¼“å­˜ï¼Œä¸€ä¸ªæ˜¯ç£ç›˜çº§åˆ«çš„ç¼“å­˜ã€‚ ä½œä¸ºandroidç³»ç»Ÿçš„ç»´æŠ¤è€…googleä¹Ÿå¼€æºäº†å…¶ç¼“å­˜æ–¹æ¡ˆï¼ŒLruCacheå’ŒDiskLruCacheã€‚ä»android3.1å¼€å§‹LruCacheå·²ç»ä½œä¸ºandroidæºç çš„ä¸€éƒ¨åˆ†ç»´æŠ¤åœ¨androidç³»ç»Ÿä¸­ï¼Œä¸ºäº†å…¼å®¹ä»¥å‰çš„ç‰ˆæœ¬androidçš„support-v4åŒ…ä¹Ÿæä¾›äº†LruCacheçš„ç»´æŠ¤ï¼Œå¦‚æœAppéœ€è¦å…¼å®¹åˆ°android3.1ä¹‹å‰çš„ç‰ˆæœ¬å°±éœ€è¦ä½¿ç”¨support-v4åŒ…ä¸­çš„LruCacheï¼Œå¦‚æœä¸éœ€è¦å…¼å®¹åˆ°android3.1åˆ™ç›´æ¥ä½¿ç”¨androidæºç ä¸­çš„LruCacheå³å¯ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯DiskLruCacheå¹¶ä¸æ˜¯androidæºç çš„ä¸€éƒ¨åˆ†ã€‚ åœ¨LruCacheçš„æºç ä¸­ï¼Œå…³äºLruCacheæœ‰è¿™æ ·çš„ä¸€æ®µä»‹ç»ï¼š 1A cache that holds strong references to a limited number of values. Each time a value is accessed, it is moved to the head of a queue. When a value is added to a full cache, the value at the end of that queue is evicted and may become eligible for garbage collection. cacheå¯¹è±¡é€šè¿‡ä¸€ä¸ªå¼ºå¼•ç”¨æ¥è®¿é—®å†…å®¹ã€‚æ¯æ¬¡å½“ä¸€ä¸ªitemè¢«è®¿é—®åˆ°çš„æ—¶å€™ï¼Œè¿™ä¸ªitemå°±ä¼šè¢«ç§»åŠ¨åˆ°ä¸€ä¸ªé˜Ÿåˆ—çš„é˜Ÿé¦–ã€‚å½“ä¸€ä¸ªitemè¢«æ·»åŠ åˆ°å·²ç»æ»¡äº†çš„é˜Ÿåˆ—æ—¶ï¼Œè¿™ä¸ªé˜Ÿåˆ—çš„é˜Ÿå°¾çš„itemå°±ä¼šè¢«ç§»é™¤ã€‚ å…¶å®è¿™ä¸ªå®ç°çš„è¿‡ç¨‹å°±æ˜¯LruCacheçš„ç¼“å­˜ç­–ç•¥ï¼Œå³Lruâ€“&gt;(Least recent used)æœ€å°‘æœ€è¿‘ä½¿ç”¨ç®—æ³•ã€‚ ä¸‹é¢æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹LruCacheçš„å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319public class LruCache&lt;K, V&gt; { private final LinkedHashMap&lt;K, V&gt; map; /** Size of this cache in units. Not necessarily the number of elements. */ private int size; private int maxSize; private int putCount; private int createCount; private int evictionCount; private int hitCount; private int missCount; /** * @param maxSize for caches that do not override {@link #sizeOf}, this is * the maximum number of entries in the cache. For all other caches, * this is the maximum sum of the sizes of the entries in this cache. */ public LruCache(int maxSize) { if (maxSize &lt;= 0) { throw new IllegalArgumentException(&quot;maxSize &lt;= 0&quot;); } this.maxSize = maxSize; this.map = new LinkedHashMap&lt;K, V&gt;(0, 0.75f, true); } /** * Sets the size of the cache. * * @param maxSize The new maximum size. */ public void resize(int maxSize) { if (maxSize &lt;= 0) { throw new IllegalArgumentException(&quot;maxSize &lt;= 0&quot;); } synchronized (this) { this.maxSize = maxSize; } trimToSize(maxSize); } /** * Returns the value for {@code key} if it exists in the cache or can be * created by {@code #create}. If a value was returned, it is moved to the * head of the queue. This returns null if a value is not cached and cannot * be created. */ public final V get(K key) { if (key == null) { throw new NullPointerException(&quot;key == null&quot;); } V mapValue; synchronized (this) { mapValue = map.get(key); if (mapValue != null) { hitCount++; return mapValue; } missCount++; } /* * Attempt to create a value. This may take a long time, and the map * may be different when create() returns. If a conflicting value was * added to the map while create() was working, we leave that value in * the map and release the created value. */ V createdValue = create(key); if (createdValue == null) { return null; } synchronized (this) { createCount++; mapValue = map.put(key, createdValue); if (mapValue != null) { // There was a conflict so undo that last put map.put(key, mapValue); } else { size += safeSizeOf(key, createdValue); } } if (mapValue != null) { entryRemoved(false, key, createdValue, mapValue); return mapValue; } else { trimToSize(maxSize); return createdValue; } } /** * Caches {@code value} for {@code key}. The value is moved to the head of * the queue. * * @return the previous value mapped by {@code key}. */ public final V put(K key, V value) { if (key == null || value == null) { throw new NullPointerException(&quot;key == null || value == null&quot;); } V previous; synchronized (this) { putCount++; size += safeSizeOf(key, value); previous = map.put(key, value); if (previous != null) { size -= safeSizeOf(key, previous); } } if (previous != null) { entryRemoved(false, key, previous, value); } trimToSize(maxSize); return previous; } /** * Remove the eldest entries until the total of remaining entries is at or * below the requested size. * * @param maxSize the maximum size of the cache before returning. May be -1 * to evict even 0-sized elements. */ public void trimToSize(int maxSize) { while (true) { K key; V value; synchronized (this) { if (size &lt; 0 || (map.isEmpty() &amp;&amp; size != 0)) { throw new IllegalStateException(getClass().getName() + &quot;.sizeOf() is reporting inconsistent results!&quot;); } if (size &lt;= maxSize) { break; } Map.Entry&lt;K, V&gt; toEvict = map.eldest(); if (toEvict == null) { break; } key = toEvict.getKey(); value = toEvict.getValue(); map.remove(key); size -= safeSizeOf(key, value); evictionCount++; } entryRemoved(true, key, value, null); } } /** * Removes the entry for {@code key} if it exists. * * @return the previous value mapped by {@code key}. */ public final V remove(K key) { if (key == null) { throw new NullPointerException(&quot;key == null&quot;); } V previous; synchronized (this) { previous = map.remove(key); if (previous != null) { size -= safeSizeOf(key, previous); } } if (previous != null) { entryRemoved(false, key, previous, null); } return previous; } /** * Called for entries that have been evicted or removed. This method is * invoked when a value is evicted to make space, removed by a call to * {@link #remove}, or replaced by a call to {@link #put}. The default * implementation does nothing. * * &lt;p&gt;The method is called without synchronization: other threads may * access the cache while this method is executing. * * @param evicted true if the entry is being removed to make space, false * if the removal was caused by a {@link #put} or {@link #remove}. * @param newValue the new value for {@code key}, if it exists. If non-null, * this removal was caused by a {@link #put}. Otherwise it was caused by * an eviction or a {@link #remove}. */ protected void entryRemoved(boolean evicted, K key, V oldValue, V newValue) {} /** * Called after a cache miss to compute a value for the corresponding key. * Returns the computed value or null if no value can be computed. The * default implementation returns null. * * &lt;p&gt;The method is called without synchronization: other threads may * access the cache while this method is executing. * * &lt;p&gt;If a value for {@code key} exists in the cache when this method * returns, the created value will be released with {@link #entryRemoved} * and discarded. This can occur when multiple threads request the same key * at the same time (causing multiple values to be created), or when one * thread calls {@link #put} while another is creating a value for the same * key. */ protected V create(K key) { return null; } private int safeSizeOf(K key, V value) { int result = sizeOf(key, value); if (result &lt; 0) { throw new IllegalStateException(&quot;Negative size: &quot; + key + &quot;=&quot; + value); } return result; } /** * Returns the size of the entry for {@code key} and {@code value} in * user-defined units. The default implementation returns 1 so that size * is the number of entries and max size is the maximum number of entries. * * &lt;p&gt;An entry's size must not change while it is in the cache. */ protected int sizeOf(K key, V value) { return 1; } /** * Clear the cache, calling {@link #entryRemoved} on each removed entry. */ public final void evictAll() { trimToSize(-1); // -1 will evict 0-sized elements } /** * For caches that do not override {@link #sizeOf}, this returns the number * of entries in the cache. For all other caches, this returns the sum of * the sizes of the entries in this cache. */ public synchronized final int size() { return size; } /** * For caches that do not override {@link #sizeOf}, this returns the maximum * number of entries in the cache. For all other caches, this returns the * maximum sum of the sizes of the entries in this cache. */ public synchronized final int maxSize() { return maxSize; } /** * Returns the number of times {@link #get} returned a value that was * already present in the cache. */ public synchronized final int hitCount() { return hitCount; } /** * Returns the number of times {@link #get} returned null or required a new * value to be created. */ public synchronized final int missCount() { return missCount; } /** * Returns the number of times {@link #create(Object)} returned a value. */ public synchronized final int createCount() { return createCount; } /** * Returns the number of times {@link #put} was called. */ public synchronized final int putCount() { return putCount; } /** * Returns the number of values that have been evicted. */ public synchronized final int evictionCount() { return evictionCount; } /** * Returns a copy of the current contents of the cache, ordered from least * recently accessed to most recently accessed. */ public synchronized final Map&lt;K, V&gt; snapshot() { return new LinkedHashMap&lt;K, V&gt;(map); } @Override public synchronized final String toString() { int accesses = hitCount + missCount; int hitPercent = accesses != 0 ? (100 * hitCount / accesses) : 0; return String.format(&quot;LruCache[maxSize=%d,hits=%d,misses=%d,hitRate=%d%%]&quot;, maxSize, hitCount, missCount, hitPercent); }}å¯ä»¥çœ‹åˆ°LruCacheåˆå§‹åŒ–çš„æ—¶å€™éœ€è¦ä½¿ç”¨æ³›å‹ï¼Œä¸€èˆ¬çš„æˆ‘ä»¬è¿™æ ·åˆå§‹åŒ–LruCacheå¯¹è±¡ï¼š 12345678910// è·å–åº”ç”¨ç¨‹åºæœ€å¤§å¯ç”¨å†…å­˜ int maxMemory = (int) Runtime.getRuntime().maxMemory(); int cacheSize = maxMemory / 8; // è®¾ç½®å›¾ç‰‡ç¼“å­˜å¤§å°ä¸ºç¨‹åºæœ€å¤§å¯ç”¨å†…å­˜çš„1/8 mMemoryCache = new LruCache&lt;String, Bitmap&gt;(cacheSize) { @Override protected int sizeOf(String key, Bitmap bitmap) { return bitmap.getByteCount(); } }; è¿™é‡Œæˆ‘ä»¬å‡è®¾é€šè¿‡Stringä½œä¸ºkeyä¿å­˜bitmapå¯¹è±¡ï¼ŒåŒæ—¶éœ€è¦ä¼ é€’ä¸€ä¸ªintå‹çš„maxSizeæ•°å€¼ï¼Œä¸»è¦ç”¨äºè®¾ç½®LruCacheé“¾è¡¨çš„æœ€å¤§å€¼ã€‚ æŸ¥çœ‹å…¶æ„é€ æ–¹æ³•ï¼š 12345678910// è·å–åº”ç”¨ç¨‹åºæœ€å¤§å¯ç”¨å†…å­˜ int maxMemory = (int) Runtime.getRuntime().maxMemory(); int cacheSize = maxMemory / 8; // è®¾ç½®å›¾ç‰‡ç¼“å­˜å¤§å°ä¸ºç¨‹åºæœ€å¤§å¯ç”¨å†…å­˜çš„1/8 mMemoryCache = new LruCache&lt;String, Bitmap&gt;(cacheSize) { @Override protected int sizeOf(String key, Bitmap bitmap) { return bitmap.getByteCount(); } }; å¯ä»¥çœ‹åˆ°å…¶ä¸»è¦çš„æ˜¯åˆå§‹åŒ–äº†maxSizeå’Œmapé“¾è¡¨å¯¹è±¡ã€‚ ç„¶åæŸ¥çœ‹putæ–¹æ³•ï¼š 12345678910111213141516171819202122public final V put(K key, V value) { if (key == null || value == null) { throw new NullPointerException(&quot;key == null || value == null&quot;); } V previous; synchronized (this) { putCount++; size += safeSizeOf(key, value); previous = map.put(key, value); if (previous != null) { size -= safeSizeOf(key, previous); } } if (previous != null) { entryRemoved(false, key, previous, value); } trimToSize(maxSize); return previous; } éœ€è¦ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼šKå’ŒVï¼Œé¦–å…ˆåšäº†ä¸€ä¸‹å‚æ•°çš„åˆ¤æ–­ï¼Œç„¶åå®šä¹‰ä¸€ä¸ªä¿å­˜å‰ä¸€ä¸ªValueå€¼å¾—ä¸´æ—¶å˜é‡ï¼Œè®©putCountï¼ˆputæ‰§è¡Œçš„æ¬¡æ•°ï¼‰è‡ªå¢ï¼Œè®©mapçš„sizeå¤§å°è‡ªå¢ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ 1previous = map.put(key, value); æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™é‡Œçš„map.putï¼ˆï¼‰çš„å…·ä½“å®ç°ï¼š 1234567891011121314151617181920212223242526@Override public V put(K key, V value) { if (key == null) { return putValueForNullKey(value); } int hash = Collections.secondaryHash(key); HashMapEntry&lt;K, V&gt;[] tab = table; int index = hash &amp; (tab.length - 1); for (HashMapEntry&lt;K, V&gt; e = tab[index]; e != null; e = e.next) { if (e.hash == hash &amp;&amp; key.equals(e.key)) { preModify(e); V oldValue = e.value; e.value = value; return oldValue; } } // No entry for (non-null) key is present; create one modCount++; if (size++ &gt; threshold) { tab = doubleCapacity(); index = hash &amp; (tab.length - 1); } addNewEntry(key, value, hash, index); return null; } å°†Keyä¸Valueçš„å€¼å‹å…¥Mapä¸­ï¼Œè¿™é‡Œåˆ¤æ–­äº†ä¸€ä¸‹å¦‚æœmapä¸­å·²ç»å­˜åœ¨è¯¥keyï¼Œvalueé”®å€¼å¯¹ï¼Œåˆ™ä¸å†å‹å…¥mapï¼Œå¹¶å°†Valueå€¼è¿”å›ï¼Œå¦åˆ™å°†è¯¥é”®å€¼å¯¹å‹å…¥Mapä¸­ï¼Œå¹¶è¿”å›nullï¼› è¿”å›ç»§ç»­putæ–¹æ³•ï¼š 1234previous = map.put(key, value); if (previous != null) { size -= safeSizeOf(key, previous); } å¯ä»¥çœ‹åˆ°è¿™é‡Œæˆ‘ä»¬åˆ¤æ–­map.putæ–¹æ³•çš„è¿”å›å€¼æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯ï¼Œåˆ™è¯´æ˜æˆ‘ä»¬åˆšåˆšå¹¶æ²¡æœ‰å°†æˆ‘ä¹ˆä½ çš„é”®å€¼å¯¹å‹å…¥Mapä¸­ï¼Œæ‰€ä»¥è¿™é‡Œçš„sizeéœ€è¦è‡ªå‡ï¼› ç„¶åä¸‹é¢ï¼š 123if (previous != null) { entryRemoved(false, key, previous, value); } è¿™é‡Œåˆ¤æ–­previousæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºçš„è¯ï¼Œè°ƒç”¨äº†ä¸€ä¸ªç©ºçš„å®ç°æ–¹æ³•entryRemoved()ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥å®ç°è‡ªå·±çš„LruCacheå¹¶åœ¨æ·»åŠ ç¼“å­˜çš„æ—¶å€™è‹¥å­˜åœ¨è¯¥ç¼“å­˜å¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼› ä¸‹é¢è°ƒç”¨äº†trimToSize(maxSize)æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829public void trimToSize(int maxSize) { while (true) { K key; V value; synchronized (this) { if (size &lt; 0 || (map.isEmpty() &amp;&amp; size != 0)) { throw new IllegalStateException(getClass().getName() + &quot;.sizeOf() is reporting inconsistent results!&quot;); } if (size &lt;= maxSize) { break; } Map.Entry&lt;K, V&gt; toEvict = map.eldest(); if (toEvict == null) { break; } key = toEvict.getKey(); value = toEvict.getValue(); map.remove(key); size -= safeSizeOf(key, value); evictionCount++; } entryRemoved(true, key, value, null); } } è¯¥æ–¹æ³•ä¸»è¦æ˜¯åˆ¤æ–­è¯¥Mapçš„å¤§å°æ˜¯å¦å·²ç»è¾¾åˆ°é˜™å€¼ï¼Œè‹¥è¾¾åˆ°ï¼Œåˆ™å°†Mapé˜Ÿå°¾çš„å…ƒç´ ï¼ˆæœ€ä¸å¸¸ä½¿ç”¨çš„å…ƒç´ ï¼‰removeæ‰ã€‚ æ€»ç»“ï¼šLruCache putæ–¹æ³•ï¼Œå°†é”®å€¼å¯¹å‹å…¥Mapæ•°æ®ç»“æ„ä¸­ï¼Œè‹¥è¿™æ˜¯Mapçš„å¤§å°å·²ç»å¤§äºLruCacheä¸­å®šä¹‰çš„æœ€å¤§å€¼ï¼Œåˆ™å°†Mapä¸­æœ€æ—©å‹å…¥çš„å…ƒç´ removeæ‰ï¼› æŸ¥çœ‹getæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public final V get(K key) { if (key == null) { throw new NullPointerException(&quot;key == null&quot;); } V mapValue; synchronized (this) { mapValue = map.get(key); if (mapValue != null) { hitCount++; return mapValue; } missCount++; } /* * Attempt to create a value. This may take a long time, and the map * may be different when create() returns. If a conflicting value was * added to the map while create() was working, we leave that value in * the map and release the created value. */ V createdValue = create(key); if (createdValue == null) { return null; } synchronized (this) { createCount++; mapValue = map.put(key, createdValue); if (mapValue != null) { // There was a conflict so undo that last put map.put(key, mapValue); } else { size += safeSizeOf(key, createdValue); } } if (mapValue != null) { entryRemoved(false, key, createdValue, mapValue); return mapValue; } else { trimToSize(maxSize); return createdValue; } } å¯ä»¥çœ‹åˆ°å‚æ•°å€¼ä¸ºKeyï¼Œç®€å•çš„ç†è§£å°±æ˜¯é€šè¿‡keyå€¼ä»mapä¸­å–å‡ºValueå€¼ã€‚å…·ä½“æ¥è¯´ï¼Œåˆ¤æ–­mapä¸­æ˜¯å¦å«æœ‰keyå€¼valueå€¼ï¼Œè‹¥å­˜åœ¨ï¼Œåˆ™hitCountï¼ˆå‡»ä¸­å…ƒç´ æ•°é‡ï¼‰è‡ªå¢ï¼Œå¹¶è¿”å›Valueå€¼ï¼Œè‹¥æ²¡æœ‰å‡»ä¸­ï¼Œåˆ™æ‰§è¡Œcreate(key)æ–¹æ³•ï¼Œè¿™é‡Œçœ‹åˆ°createæ–¹æ³•æ˜¯ä¸€ä¸ªç©ºçš„å®ç°æ–¹æ³•ï¼Œè¿”å›å€¼ä¸ºnullï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é‡å†™è¯¥æ–¹æ³•ï¼Œåœ¨è°ƒç”¨getï¼ˆkeyï¼‰çš„æ—¶å€™è‹¥æ²¡æœ‰æ‰¾åˆ°valueå€¼ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªvalueå€¼å¹¶å‹å…¥mapä¸­ã€‚ æ€»ç»“ï¼š LruCacheï¼Œå†…éƒ¨ä½¿ç”¨Mapä¿å­˜å†…å­˜çº§åˆ«çš„ç¼“å­˜ LruCacheä½¿ç”¨æ³›å‹å¯ä»¥è®¾é…å„ç§ç±»å‹ LruCacheä½¿ç”¨äº†Lruç®—æ³•ä¿å­˜æ•°æ®ï¼ˆæœ€çŸ­æœ€å°‘ä½¿ç”¨least recent useï¼‰ LruCacheåªç”¨ä½¿ç”¨putå’Œgetæ–¹æ³•å‹å…¥æ•°æ®å’Œå–å‡ºæ•°æ® å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Log","link":"/2020/09/11/android%E4%B9%8BLruCache/"},{"title":"25 onLowMemoryæ‰§è¡Œæµç¨‹","text":"ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åˆ†æäº†Activityçš„onSaveInstanceStateæ–¹æ³•æ‰§è¡Œæ—¶æœºï¼ŒçŸ¥é“äº†Activityåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè‹¥åªæ˜¯æ‰§è¡ŒonPauseæ–¹æ³•åˆ™ä¸ä¼šæ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ï¼Œè€Œä¸€æ—¦æ‰§è¡Œäº†onStopæ–¹æ³•å°±ä¼šæ‰§è¡ŒonSaveInstanceStateæ–¹æ³•ï¼Œå…·ä½“çš„ä¿¡æ¯ï¼Œå¯ä»¥å‚è§onSaveInstanceStateæ–¹æ³•æ‰§è¡Œæ—¶æœºï¼šandroidæºç è§£æï¼ˆäºŒåå››ï¼‰â€“&gt;onSaveInstanceStateæ‰§è¡Œæ—¶æœº è¿™ç¯‡æ–‡ç« ä¸­åŒæ ·çš„æˆ‘ä»¬åˆ†æä¸€ä¸‹Actvityï¼ˆå½“ç„¶ä¸åªæ˜¯Activityï¼ŒåŒæ ·åŒ…å«Servierï¼ŒContentProviderï¼ŒApplicationç­‰ï¼‰çš„å¦ä¸€ä¸ªå†…éƒ¨æ–¹æ³•ï¼šonLowMemoryã€‚è¯¥æ–¹æ³•ä¸»è¦ç”¨äºå½“å‰ç³»ç»Ÿå¯ç”¨å†…å­˜æ¯”è¾ƒä½çš„æ—¶å€™å›è°ƒä½¿ç”¨ã€‚ è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹Androidç³»ç»Ÿçš„å†…å­˜åˆ†é…æœºåˆ¶ã€‚Androidç³»ç»Ÿä¸­ä¸€ä¸ªä¸ªçš„Appéƒ½æ˜¯ä¸€ä¸ªä¸ªä¸åŒçš„åº”ç”¨è¿›ç¨‹ï¼Œæ‹¥æœ‰å„è‡ªçš„JVMä¸è¿è¡Œæ—¶ï¼Œæ¯ä¸ªAppçš„è¿›ç¨‹å¯ä½¿ç”¨çš„å†…å­˜å¤§å°éƒ½æ˜¯å›ºå®šçš„ï¼Œå½“ç³»ç»Ÿä¸­Appæ‰“å¼€æ•°é‡è¿‡å¤šæ—¶ï¼Œå°±ä¼šä½¿Androidç³»ç»Ÿçš„å¯ç”¨å†…å­˜é™ä½ï¼Œå¯¹äºå½“å‰æ­£åœ¨ä½¿ç”¨çš„Appè€Œè¨€ï¼Œå¯èƒ½è¿˜éœ€è¦ç»§ç»­ç”³è¯·ç³»ç»Ÿå†…å­˜ï¼Œè€Œæˆ‘ä»¬çš„å‰©ä½™ç³»ç»Ÿå†…å­˜å·²ç»ä¸è¶³ä»¥è¢«å½“å‰Appæ‰€ç”³è¯·äº†ï¼Œè¿™æ—¶å€™ç³»ç»Ÿä¼šè‡ªåŠ¨çš„æ¸…ç†é‚£äº›åå°è¿›ç¨‹ï¼Œè¿›è€Œé‡Šæ”¾å‡ºå¯ç”¨å†…å­˜ç”¨äºå‰å°è¿›ç¨‹çš„ä½¿ç”¨ï¼Œå½“ç„¶è¿™é‡Œç³»ç»Ÿæ¸…ç†åå°è¿›ç¨‹çš„ç®—æ³•ä¸æ˜¯æˆ‘ä»¬è®¨è®ºçš„é‡ç‚¹ã€‚è¿™é‡Œæˆ‘ä»¬åªæ˜¯å¤§æ¦‚çš„åˆ†æAndroidç³»ç»Ÿå›è°ƒActivityçš„onLowMemoryæ–¹æ³•çš„æµç¨‹ã€‚ é€šè¿‡å‰é¢å…³äºActivityçš„å¯åŠ¨æµç¨‹åˆ†ææˆ‘ä»¬çŸ¥é“ActivityManagerServiceæ˜¯æ•´ä¸ªAndroidç³»ç»Ÿçš„ç®¡ç†ä¸­æ¢ï¼Œè´Ÿè´£Activityï¼ŒServierç­‰å››å¤§ç»„ä»¶çš„å¯åŠ¨ä¸é”€æ¯ç­‰å·¥ä½œï¼ŒåŒæ ·çš„å¯¹äºåº”ç”¨è¿›ç¨‹çš„ç®¡ç†å·¥ä½œä¹Ÿæ˜¯åœ¨ActivityMaangerServierä¸­å®Œæˆçš„ï¼Œæˆ‘ä»¬çŸ¥é“androidç³»ç»Ÿä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„è¿›ç¨‹Zygoteè¿›ç¨‹å’ŒSystemServerè¿›ç¨‹ï¼Œå…¶ä¸­Zygoteè¿›ç¨‹æ˜¯æ•´ä¸ªAndroidç³»ç»Ÿçš„æ ¹è¿›ç¨‹ï¼Œå…¶ä»–æ‰€æœ‰çš„è¿›ç¨‹éƒ½æ˜¯é€šè¿‡Zygoteè¿›ç¨‹forkå‡ºæ¥çš„ã€‚è€ŒSystemServerè¿›ç¨‹åˆ™ç”¨äºè¿è¡Œå„ç§æœåŠ¡ï¼Œä¸ºå…¶ä»–çš„åº”ç”¨è¿›ç¨‹æä¾›å„ç§åŠŸèƒ½æ¥å£ç­‰ï¼Œåœ¨å‰é¢æˆ‘ä»¬åˆ†æè¿‡SystemServerè¿›ç¨‹çš„å¯åŠ¨æµç¨‹ï¼ˆå‚è€ƒï¼š androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹ï¼‰å…¶ä¸­åœ¨SystemServerçš„startBootServiceæ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨äº†ï¼š 12// Set up the Application instance for the system process and get started. mActivityManagerService.setSystemProcess(); æ–¹æ³•ï¼Œçœ‹å…¶æ³¨é‡Šè¯´æ˜ï¼Œè¯´çš„æ˜¯ä¸ºSystemè¿›ç¨‹åˆå§‹åŒ–Applicationå®ä¾‹ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334public void setSystemProcess() { try { ServiceManager.addService(Context.ACTIVITY_SERVICE, this, true); ServiceManager.addService(ProcessStats.SERVICE_NAME, mProcessStats); ServiceManager.addService(&quot;meminfo&quot;, new MemBinder(this)); ServiceManager.addService(&quot;gfxinfo&quot;, new GraphicsBinder(this)); ServiceManager.addService(&quot;dbinfo&quot;, new DbBinder(this)); if (MONITOR_CPU_USAGE) { ServiceManager.addService(&quot;cpuinfo&quot;, new CpuBinder(this)); } ServiceManager.addService(&quot;permission&quot;, new PermissionController(this)); ServiceManager.addService(&quot;processinfo&quot;, new ProcessInfoService(this)); ApplicationInfo info = mContext.getPackageManager().getApplicationInfo( &quot;android&quot;, STOCK_PM_FLAGS); mSystemThread.installSystemApplicationInfo(info, getClass().getClassLoader()); synchronized (this) { ProcessRecord app = newProcessRecordLocked(info, info.processName, false, 0); app.persistent = true; app.pid = MY_PID; app.maxAdj = ProcessList.SYSTEM_ADJ; app.makeActive(mSystemThread.getApplicationThread(), mProcessStats); synchronized (mPidsSelfLocked) { mPidsSelfLocked.put(app.pid, app); } updateLruProcessLocked(app, false, null); updateOomAdjLocked(); } } catch (PackageManager.NameNotFoundException e) { throw new RuntimeException( &quot;Unable to find android system package&quot;, e); } } è¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ServierManageræ˜¯ä¸€ä¸ªç®¡ç†æœåŠ¡çš„æœåŠ¡ï¼Œè€Œå…¶addServieræ–¹æ³•å°±æ˜¯æ³¨å†Œå„ç§æœåŠ¡ï¼ˆæœåŠ¡æ³¨å†Œåˆ°JNIå±‚ï¼Œå…·ä½“çš„å…³äºæ˜¯å¦‚ä½•æ³¨å†Œåˆ°JNIå±‚çš„è¿™é‡Œæš‚ä¸åšè¿‡å¤šçš„è§£é‡Šï¼‰ã€‚å¯ä»¥å‘ç°åœ¨æ–¹æ³•ä½“ä¸­æˆ‘ä»¬æ³¨å†Œäº†åç§°ä¸ºï¼šmemInfoçš„æœåŠ¡MemBinderï¼ŒMemBinderæ˜¯ä¸€ä¸ªBinderç±»å‹çš„æœåŠ¡ï¼Œä¸»è¦ç”¨äºæ£€æµ‹ç³»ç»Ÿå†…å­˜æƒ…å†µï¼Œè¿™é‡Œå¯ä»¥çœ‹ä¸€ä¸‹å…¶å…·ä½“çš„å®ç°é€»è¾‘ï¼š 12345678910111213141516171819static class MemBinder extends Binder { ActivityManagerService mActivityManagerService; MemBinder(ActivityManagerService activityManagerService) { mActivityManagerService = activityManagerService; } @Override protected void dump(FileDescriptor fd, PrintWriter pw, String[] args) { if (mActivityManagerService.checkCallingPermission(android.Manifest.permission.DUMP) != PackageManager.PERMISSION_GRANTED) { pw.println(&quot;Permission Denial: can't dump meminfo from from pid=&quot; + Binder.getCallingPid() + &quot;, uid=&quot; + Binder.getCallingUid() + &quot; without permission &quot; + android.Manifest.permission.DUMP); return; } mActivityManagerService.dumpApplicationMemoryUsage(fd, pw, &quot; &quot;, args, false, null); } }æŸ¥çœ‹æºç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°MemBinderç±»ç»§æ‰¿äºBinderç±»ä¹Ÿå°±æ˜¯è¯´å…¶å®ä¸€ä¸ªBinderç±»å‹çš„æœåŠ¡ï¼Œå¹¶ä¸”æœ‰ä¸€ä¸ªæˆå‘˜æ–¹æ³•dumpï¼Œè¯¥æ–¹æ³•ä¸»è¦ç”¨äºæ‰§è¡Œshellå‘½ä»¤ï¼Œå½“ç³»ç»Ÿå¯ç”¨å†…å­˜æ¯”è¾ƒä½çš„æ—¶å€™å°±ä¼šæ‰§è¡Œäº†è¯¥æ–¹æ³•ï¼Œç„¶åå›è°ƒåˆ°ActivityManagerServiceä¸­çš„killAllBackgroundæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹killAllBackgroundæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789@Override public void killAllBackgroundProcesses() { ... doLowMemReportIfNeededLocked(null); ... } finally { Binder.restoreCallingIdentity(callingId); } } å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä½“ä¸­ä¼šæ‰§è¡ŒdoLowMemReportIfNeededLockedæ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ˜¯åšä»€ä¹ˆçš„å‘¢?æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹doLowMemReportIfNeededLocedæ–¹æ³•çš„å®ç°ï¼š 12345final void doLowMemReportIfNeededLocked(ProcessRecord dyingProc) { ... scheduleAppGcsLocked(); ... } å¥½å§ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬åˆè°ƒç”¨äº†scheduleAppGcsLockedæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±ç»§ç»­çœ‹ä¸€ä¸‹scheduleAppGcsLockedæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 12345678910111213141516171819/** * Schedule the execution of all pending app GCs. */ final void scheduleAppGcsLocked() { mHandler.removeMessages(GC_BACKGROUND_PROCESSES_MSG); if (mProcessesToGc.size() &gt; 0) { // Schedule a GC for the time to the next process. ProcessRecord proc = mProcessesToGc.get(0); Message msg = mHandler.obtainMessage(GC_BACKGROUND_PROCESSES_MSG); long when = proc.lastRequestedGc + GC_MIN_INTERVAL; long now = SystemClock.uptimeMillis(); if (when &lt; (now+GC_TIMEOUT)) { when = now + GC_TIMEOUT; } mHandler.sendMessageAtTime(msg, when); } } å¯ä»¥å‘ç°è¿™é‡Œæ‰§è¡Œçš„é€»è¾‘å°±æ˜¯é€šè¿‡mHandlerå‘é€ä¸€ä¸ªmsg.whatä¸ºGC_BACKGROUND_PROCESSES_MSGçš„å¼‚æ­¥æ¶ˆæ¯ï¼Œè¿™æ ·æ¶ˆæ¯ä½“æœ€ç»ˆä¼šè¢«mHandlerçš„handleMessageæ–¹æ³•æ‰€æ‰§è¡Œï¼Œç»§ç»­çœ‹ä¸€ä¸‹mHandlerçš„handleMessageæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ï¼š 12345case GC_BACKGROUND_PROCESSES_MSG: { synchronized (ActivityManagerService.this) { performAppGcsIfAppropriateLocked(); } } break; åœ¨mHandlerçš„handleMessageæ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­msgçš„whatæ˜¯å¦ä¸ºGC_BACKGROUND_PROCESSES_MSGï¼Œç„¶åä¼šæ‰§è¡ŒperformAppGcsIfAppropriateLockedæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹performAppGcsIfAppropriateLockedæ–¹æ³•çš„å®ç°ï¼š 1234567891011/** * If all looks good, perform GCs on all processes waiting for them. */ final void performAppGcsIfAppropriateLocked() { if (canGcNowLocked()) { performAppGcsLocked(); return; } // Still not idle, wait some more. scheduleAppGcsLocked(); } å¯ä»¥å‘ç°è¿™é‡Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œgcæ“ä½œï¼Œè‹¥ä¸èƒ½ç»§ç»­æ‰§è¡Œä¸Šé¢çš„scheduleAppGcsLockedæ–¹æ³•ï¼Œç„¶åç»§ç»­æ‰§è¡Œå‘é€å¼‚æ­¥æ¶ˆæ¯çš„é€»è¾‘ï¼Œç›´åˆ°å˜é‡canGcNowLockedä¸ºtrueï¼Œå¹¶æ‰§è¡ŒperformAppGcsLockedæ–¹æ³•ï¼Œç„¶åreturnæ‰ï¼Œè¿™æ ·æˆ‘ä»¬ç»§ç»­è·Ÿè¸ªä»£ç ï¼Œçœ‹ä¸€ä¸‹performAppGcsLockedæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ï¼š 1234567891011121314151617181920212223242526272829303132/** * Perform GCs on all processes that are waiting for it, but only * if things are idle. */ final void performAppGcsLocked() { final int N = mProcessesToGc.size(); if (N &lt;= 0) { return; } if (canGcNowLocked()) { while (mProcessesToGc.size() &gt; 0) { ProcessRecord proc = mProcessesToGc.remove(0); if (proc.curRawAdj &gt; ProcessList.PERCEPTIBLE_APP_ADJ || proc.reportLowMemory) { if ((proc.lastRequestedGc+GC_MIN_INTERVAL) &lt;= SystemClock.uptimeMillis()) { // To avoid spamming the system, we will GC processes one // at a time, waiting a few seconds between each. performAppGcLocked(proc); scheduleAppGcsLocked(); return; } else { // It hasn't been long enough since we last GCed this // process... put it in the list to wait for its time. addProcessToGcListLocked(proc); break; } } } scheduleAppGcsLocked(); } } å¯ä»¥å‘ç°è¯¥æ–¹æ³•ç»è¿‡ä¸€ç³»åˆ—çš„é€»è¾‘åˆ¤æ–­ä¹‹åä¼šæ‰§è¡ŒperformAppGcLockedæ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°ï¼š 123456789101112131415161718/** * Ask a given process to GC right now. */ final void performAppGcLocked(ProcessRecord app) { try { app.lastRequestedGc = SystemClock.uptimeMillis(); if (app.thread != null) { if (app.reportLowMemory) { app.reportLowMemory = false; app.thread.scheduleLowMemory(); } else { app.thread.processInBackground(); } } } catch (Exception e) { // whatever. } } å¯ä»¥å‘ç°æœ€ç»ˆæ‰§è¡Œçš„æ˜¯app.thread.scheduleLowMemoryæ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„app.threadæ˜¯ActivityThread.ApplicationThreadå¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œæœ€ç»ˆæ˜¯é€šè¿‡Binderè¿›ç¨‹é—´é€šè®¯ï¼Œæ‰§è¡Œçš„æ˜¯ActivityThread.ApplicationThreadçš„scheduleLowMemoryæ–¹æ³•ï¼Œå¥½å§è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityThread.ApplicationThreadçš„scheduleLowMemoryæ–¹æ³•çš„å®ç°é€»è¾‘â€¦ 1234@Override public void scheduleLowMemory() { sendMessage(H.LOW_MEMORY, null); } åœ¨ActivityThreadä¸­çš„scheduleLowMemoryæ–¹æ³•ä¸­å¹¶æ²¡æœ‰æ‰§è¡Œé¢å¤–é€»è¾‘ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨äº†sendMessageæ–¹æ³•ï¼Œç»§ç»­è·Ÿè¸ªæ–¹æ³•çš„æ‰§è¡Œï¼š 1234567891011121314private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) { if (DEBUG_MESSAGES) Slog.v( TAG, &quot;SCHEDULE &quot; + what + &quot; &quot; + mH.codeToString(what) + &quot;: &quot; + arg1 + &quot; / &quot; + obj); Message msg = Message.obtain(); msg.what = what; msg.obj = obj; msg.arg1 = arg1; msg.arg2 = arg2; if (async) { msg.setAsynchronous(true); } mH.sendMessage(msg); } å¯ä»¥å‘ç°åœ¨sendMessageæ–¹æ³•ä¸­æœ€ç»ˆé€šè¿‡ä¸€ä¸ªHandlerç±»å‹çš„mHæˆå‘˜å˜é‡å‘é€ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œè¿™æ ·å¼‚æ­¥æ¶ˆæ¯æœ€ç»ˆä¼šè¢«mHçš„handleMessageæ–¹æ³•æ‰§è¡Œã€‚ã€‚ã€‚ã€‚ï¼Œç»è¿‡æŸ¥çœ‹æºä»£ç æˆ‘ä»¬çŸ¥é“åœ¨mHçš„handleMessageæ–¹æ³•ä¸­æœ€ç»ˆè°ƒç”¨çš„æ˜¯handleLowMemoryæ–¹æ³•ï¼š 12345678910111213141516171819202122final void handleLowMemory() { ArrayList&lt;ComponentCallbacks2&gt; callbacks = collectComponentCallbacks(true, null); final int N = callbacks.size(); for (int i=0; i&lt;N; i++) { callbacks.get(i).onLowMemory(); } // Ask SQLite to free up as much memory as it can, mostly from its page caches. if (Process.myUid() != Process.SYSTEM_UID) { int sqliteReleased = SQLiteDatabase.releaseMemory(); EventLog.writeEvent(SQLITE_MEM_RELEASED_EVENT_LOG_TAG, sqliteReleased); } // Ask graphics to free up as much as possible (font/image caches) Canvas.freeCaches(); // Ask text layout engine to free also as much as possible Canvas.freeTextLayoutCaches(); BinderInternal.forceGc(&quot;mem&quot;); } å¯ä»¥å‘ç°è¿™é‡Œé€šè¿‡éå†ComponentCallbacks2å¹¶æ‰§è¡Œäº†å…¶onLowMemoryæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ComponentCallBacks2æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹collectComponentCallbacksæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950ArrayList&lt;ComponentCallbacks2&gt; collectComponentCallbacks( boolean allActivities, Configuration newConfig) { ArrayList&lt;ComponentCallbacks2&gt; callbacks = new ArrayList&lt;ComponentCallbacks2&gt;(); synchronized (mResourcesManager) { final int NAPP = mAllApplications.size(); for (int i=0; i&lt;NAPP; i++) { callbacks.add(mAllApplications.get(i)); } final int NACT = mActivities.size(); for (int i=0; i&lt;NACT; i++) { ActivityClientRecord ar = mActivities.valueAt(i); Activity a = ar.activity; if (a != null) { Configuration thisConfig = applyConfigCompatMainThread( mCurDefaultDisplayDpi, newConfig, ar.packageInfo.getCompatibilityInfo()); if (!ar.activity.mFinished &amp;&amp; (allActivities || !ar.paused)) { // If the activity is currently resumed, its configuration // needs to change right now. callbacks.add(a); } else if (thisConfig != null) { // Otherwise, we will tell it about the change // the next time it is resumed or shown. Note that // the activity manager may, before then, decide the // activity needs to be destroyed to handle its new // configuration. if (DEBUG_CONFIGURATION) { Slog.v(TAG, &quot;Setting activity &quot; + ar.activityInfo.name + &quot; newConfig=&quot; + thisConfig); } ar.newConfig = thisConfig; } } } final int NSVC = mServices.size(); for (int i=0; i&lt;NSVC; i++) { callbacks.add(mServices.valueAt(i)); } } synchronized (mProviderMap) { final int NPRV = mLocalProviders.size(); for (int i=0; i&lt;NPRV; i++) { callbacks.add(mLocalProviders.valueAt(i).mLocalProvider); } } return callbacks; } å¯ä»¥å‘ç°è¯¥æ–¹æ³•æœ€ç»ˆè¿”å›ç±»å‹ä¸ºArrayListç±»å‹çš„callBacksè€Œæˆ‘ä»¬çš„callBacksä¸­ä¿å­˜çš„æ˜¯æˆ‘ä»¬åº”ç”¨è¿›ç¨‹ä¸­çš„Activityï¼ŒServiceï¼ŒProviderå·²ç»Applicationç­‰ã€‚å’¦ï¼ŸActivityï¼ŒServiceï¼ŒProviderï¼ŒApplicationéƒ½æ˜¯ComponentCallBacks2ç±»å‹çš„ä¹ˆï¼Ÿæˆ‘ä»¬çœ‹ä¸€çœ‹ä¸€ä¸‹å…·ä½“çš„å®šä¹‰ï¼š Actvityçš„ç±»å®šä¹‰ï¼š 12345public class Activity extends ContextThemeWrapper implements LayoutInflater.Factory2, Window.Callback, KeyEvent.Callback, OnCreateContextMenuListener, ComponentCallbacks2, Window.OnWindowDismissedCallback Serviceçš„ç±»å®šä¹‰ï¼š 1public abstract class Service extends ContextWrapper implements ComponentCallbacks2 ContentProviderçš„ç±»å®šä¹‰ï¼š 1public abstract class ContentProvider implements ComponentCallbacks2 Applicationçš„ç±»å®šä¹‰ï¼š 1public class Application extends ContextWrapper implements ComponentCallbacks2 å¯ä»¥å‘ç°å…¶éƒ½æ˜¯ç»§æ‰¿ä¸ComponentCalbacks2ï¼Œæ‰€ä»¥å…¶éƒ½å¯ä»¥è¢«å½“åšæ˜¯ComponentCallbacks2ç±»å‹çš„å˜é‡ã€‚è€ŒåŒæ ·æ˜¯å››å¤§ç»„ä»¶çš„BroadcastReceiverï¼Œæˆ‘ä»¬å¯ä»¥ä¸‹å…¶ç±»å®šä¹‰ï¼š 1public abstract class BroadcastReceiver å¯ä»¥çœ‹åˆ°å…¶å¹¶æœªç»§æ‰¿ä¸ComponentCallbacks2ï¼Œæ‰€ä»¥å¹¶æœªæ‰§è¡Œï¼Œæ‰€ä»¥é€šè¿‡è¿™æ ·çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“äº†ï¼Œæœ€ç»ˆåº”ç”¨ç¨‹åºä¸­çš„Activityï¼ŒServierï¼ŒContentProviderï¼ŒApplicationçš„onLowMemoryæ–¹æ³•ä¼šè¢«æ‰§è¡Œã€‚è€Œç”±äºæˆ‘ä»¬æ˜¯åœ¨ç³»ç»Ÿå†…å­˜ç´§å¼ çš„æ—¶å€™ä¼šæ‰§è¡ŒkillAllBackgroundæ–¹æ³•è¿›è€Œé€šè¿‡å±‚å±‚æ¡ç”¨æ‰§è¡ŒActivityã€Serviceã€ContentProviderã€Applicationçš„onLowMemoryæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™äº›ç»„ä»¶çš„onLowMemoryæ–¹æ³•ä¸­æ‰§è¡Œäº†ä¸€äº›æ¸…ç†èµ„æºçš„æ“ä½œï¼Œé‡Šæ”¾ä¸€äº›å†…å­˜ï¼Œå°½é‡ä¿è¯è‡ªèº«çš„åº”ç”¨è¿›ç¨‹ä¸è¢«æ€æ­»ã€‚ æ€»ç»“ï¼š ç³»ç»Ÿåœ¨JNIå±‚ä¼šæ—¶æ—¶æ£€æµ‹å†…å­˜å˜é‡ï¼Œå½“å†…å­˜è¿‡ä½æ—¶ä¼šé€šè¿‡kiilbackgroundçš„æ–¹æ³•æ¸…ç†åå°è¿›ç¨‹ã€‚ ç»è¿‡å±‚å±‚çš„è°ƒç”¨è¿‡ç¨‹æœ€ç»ˆä¼šæ‰§è¡ŒActivityã€Serviceã€ContentProviderã€Applicationçš„onLowMemoryæ–¹æ³•ã€‚ å¯ä»¥åœ¨ç»„ä»¶çš„onLowMemoryæ–¹æ³•ä¸­æ‰§è¡Œä¸€äº›æ¸…ç†èµ„æºçš„æ“ä½œï¼Œé‡Šæ”¾å†…å­˜é˜²æ­¢è¿›ç¨‹è¢«æ€æ­»ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåäºŒï¼‰â€“&gt;ToaståŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸‰ï¼‰â€“&gt;Androidå¼‚å¸¸å¤„ç†æµç¨‹androidæºç è§£æï¼ˆäºŒåå››ï¼‰â€“&gt;onSaveInstanceStateæ‰§è¡Œæ—¶æœº","link":"/2020/09/11/onLowMemory%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/"},{"title":"å„ç§å­¦ä¹ èµ„æ–™ï¼ŒåŒ…æ‹¬ä¸€äº›ç™¾åº¦äº‘è§†é¢‘é“¾æ¥è¿˜æœ‰pdfèµ„æ–™ --æ¬è¿å·¥","text":"äººç”Ÿä¸å¦‚æ„äº‹å¸¸å…«ä¹ å…±å‹‰ ã€0ã€‘Springbootå¾®æœåŠ¡å¼€å‘å¤©æ°”é¢„æŠ¥ç³»ç»Ÿè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1joz7flyztCq8oklBlsz8dQ æå–å¯†ç ï¼šcpz7 ã€1ã€‘JAVA300é›†å¤§å‹è§†é¢‘æ•™ç¨‹2018ç‰ˆå‘å¸ƒ https://pan.baidu.com/s/1Bqy4mWSD1idd6JmIzS9ZLg æå–å¯†ç ï¼šllg2 ã€2ã€‘Vue2.5å¼€å‘å»æ—…æ¸¸ç½‘ç«™Appä»é›¶åŸºç¡€å…¥é—¨åˆ°å®æˆ˜é¡¹ç›® https://pan.baidu.com/s/1DYCoIw_b893KXGkkYt_92Q æå–å¯†ç ï¼šbgoy ã€3ã€‘opencv+tensorflowå…¥é—¨äººå·¥æ™ºèƒ½å›¾åƒå¤„ç†è§†é¢‘æ•™ç¨‹+æºç ä¸‹è½½ https://pan.baidu.com/s/10WefZkTQST094L5UQA7myg æå–å¯†ç ï¼š7b9w ã€4ã€‘æœ€æ–°BATé¢è¯•çœŸé¢˜è®²è§£ï¼Œæƒ³å»å¤§å‚çš„åˆ«é”™è¿‡ https://pan.baidu.com/s/1ejf2Eh8ZA-T1bWbuT6gw0A æå–å¯†ç ï¼šmist ã€5ã€‘Python3å¼‚æ­¥IOå¹¶å‘ç¼–ç¨‹é«˜çº§è¿›é˜¶è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1jiRwD5MNPmAKF98nXYzmKg æå–å¯†ç ï¼šhct4 ã€6ã€‘æœ€æ–°å¤§æ•°æ®æ•°æ®åˆ†æä¸æŒ–æ˜é«˜çº§å·¥ç¨‹å¸ˆç¬¬ä¸‰æœŸè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1g8xGPag9GiMA4_MEKbxePw æå–å¯†ç ï¼šz2v3 ã€7ã€‘å§œæ‰¿å°§MYSQL,DBAè§†é¢‘è¯¾ç¨‹(44å¤©å…¨)è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/19NUjkkvdDZXhw1QG4yX21Q æå–å¯†ç ï¼šfunf ã€8ã€‘Python+AnsiblePlaybook+Djangoè‡ªåŠ¨åŒ–è¿ç»´é¡¹ç›®å®è·µè¯¾ç¨‹ https://pan.baidu.com/s/1CfOHuaYi_TdPoAUzP9AW1w æå–å¯†ç ï¼šo3rc ã€9ã€‘springcloudå¾®æœåŠ¡å®è·µ-åˆ†å¸ƒå¼ä¸åŸç†å‰–æé“¾è·¯è¿½è¸ªå®¹å™¨ https://pan.baidu.com/s/1g8QoqOnQwjI7N3zDSccr-w æå–å¯†ç ï¼šygf5 ã€10ã€‘2018å¹´æœ€æ–°Javaé«˜å¹¶å‘çŸ¥è¯†ä½“ç³»ä¸é«˜å¹¶å‘ç¼–ç¨‹æ¶æ„è¯¾ç¨‹è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1E1NhSevRqwdnguiKSsOp5A æå–å¯†ç ï¼šmkh2 ã€11ã€‘2018å¹´æœ€æ–°ä»·å€¼300Pythonäººå·¥æ™ºèƒ½TensorFlowæ¡†æ¶åº”ç”¨å®è·µè§†é¢‘è¯¾ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1qYJjFz9aG6M5grMg311uRQ æå–å¯†ç ï¼š5hzp ã€12ã€‘è°­å·å­¦é™¢ä»·å€¼1680å…ƒpythonè§†é¢‘æ•™ç¨‹12306ç½‘ç«™æ¡ˆä¾‹vipç‰¹è®­ç­æ•™ç¨‹ https://pan.baidu.com/s/1yEQq5W1eSc3NA4XmyNmuJw æå–å¯†ç ï¼šcipi ã€13ã€‘ä¸‹è½½ https://pan.baidu.com/s/1D6hYdyi4ti2zpnKHVWWbEg æå–å¯†ç ï¼šglov ã€14ã€‘Nettyå®æˆ˜é«˜æ€§èƒ½åˆ†å¸ƒå¼RPCè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1sDHh_g624MO08MTFIrwEDw æå–å¯†ç ï¼šmwa6 ã€15ã€‘2018å¹´æœ€æ–°å°šå­¦å ‚Vue2å…¨å¥—å­¦ä¹ è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/147NvAV-Qse90xvTYDvHBcg æå–å¯†ç ï¼šwpfg ã€16ã€‘æœ€æ–°2018ç–¯ç‹‚SpringCloudå¾®æœåŠ¡æ¶æ„å®æˆ˜è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1jgC0lagtMG7tArATrAAHXg æå–å¯†ç ï¼š10kf ã€17ã€‘kotliné«˜çº§æ•™ç¨‹ä»é›¶å¼€å§‹å¼€å‘å®Œæ•´å®‰å“å•†åŸapp https://pan.baidu.com/s/13F_C1aKuJ0ek5Kv-HWdygw æå–å¯†ç ï¼škrq2 ã€18ã€‘2018å¹´æœ€æ–°ç–¯ç‹‚Activiti6è§†é¢‘æ•™ç¨‹ç–¯ç‹‚å·¥ä½œæµè®²ä¹‰Activiti6.xè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1SriGV7tZAeSvYcYb6l_hdQ æå–å¯†ç ï¼šbzcu ã€19ã€‘åŸºäºMyCatçš„MySQLé«˜å¯ç”¨è¯»å†™åˆ†ç¦»é›†ç¾¤å®æˆ˜è¯¾ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1DVCf57_O1iMDJkbOGxdnpw æå–å¯†ç ï¼š6a08 ã€20ã€‘2018å¹´æœ€æ–°Webpack3ç”±æµ…å…¥æ·±åŠæ­è½½vue,react,angularæ¡†æ¶å¤šç»´åº¦è®²è§£ https://pan.baidu.com/s/1BYq5qb9fFMSyODlORBQCcw æå–å¯†ç ï¼š6wf3 ã€21ã€‘2018å¹´æœ€æ–°Sparkæœºå™¨å­¦ä¹ è¯¾ç¨‹ï¼šæ™ºèƒ½å®¢æˆ·ç³»ç»Ÿé¡¹ç›®å®æˆ˜è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/12SrMtvLBlVJGOlOt5NQFjw æå–å¯†ç ï¼šuu9v ã€22ã€‘æœ€æ–°ç¦»çº¿æ•°æ®åˆ†æå¹³å°å®æˆ˜é©´å¦ˆå¦ˆé¡¹ç›®å®æˆ˜åŸ¹è®­è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/129jhYGDLFzsM7BW5HYdg7Q æå–å¯†ç ï¼švhjs ã€23ã€‘2018å¹´æœ€æ–°å°šç¡…è°·java9æ–°ç‰¹æ€§è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1xC-xPm54rFMLAHYwis1Thg æå–å¯†ç ï¼šf0v6 ã€24ã€‘æœ€æ–°åŒ—é£ç½‘äººå·¥æ™ºèƒ½+æœºå™¨å­¦ä¹ +æ·±åº¦å­¦ä¹ +æ¨èç³»ç»Ÿå®æˆ˜ç¬¬3æœŸè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1E98ZYCtJ7Mom_tWZT6AM_g æå–å¯†ç ï¼š3abb ã€25ã€‘[å…¨æ ˆå¼€å‘]Vue+DjangoRESTframeworkæ‰“é€ ç”Ÿé²œç”µå•†é¡¹ç›®è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1vFAkTEdydgL-GjdcpeEHGg æå–å¯†ç ï¼šk00f ã€26ã€‘2018å¹´æœ€æ–°node.js+ES+Koa2æ‰‹æŠŠæ‰‹æ•™ä½ å¼€å‘ä¸€ä¸ªçŸ­è§†é¢‘ç½‘ç«™è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1jmxxQ88J_qWsovXkMNeDpQ æå–å¯†ç ï¼š46yh ã€27ã€‘åŸºäºJavaçš„å¾®ä¿¡å¹³å°å¼€å‘æ•™ç¨‹è§†é¢‘ä¸‹è½½ https://pan.baidu.com/s/1hMq-J7KFMuDezGSdzX35OA æå–å¯†ç ï¼šoycw ã€28ã€‘æœ€æ–°ç²¾é€‰èš‚èš-MySQLè¯­å¥æ€§èƒ½ä¼˜åŒ–è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1miVf8Ze æå–å¯†ç ï¼šw5yt ã€29ã€‘æ·±åº¦å­¦ä¹ å®æˆ˜é¡¹ç›®-åˆ©ç”¨RNNä¸LSTMç½‘ç»œåŸç†è¿›è¡Œå”è¯—ç”Ÿæˆè§†é¢‘è¯¾ç¨‹ https://pan.baidu.com/s/1i6jyFtz æå–å¯†ç ï¼švrzx ã€30ã€‘2018å¹´æœ€æ–°å¾®ä¿¡å°æ¸¸æˆå¼€å‘ES6+å°æ¸¸æˆapiå¼€å‘è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1i7mwJCp æå–å¯†ç ï¼šndl7 ã€31ã€‘æœ€æ–°ç”²éª¨è®º-Linuxå¤§æ•°æ®åŠæ•°æ®åº“å­˜å‚¨è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1smi2oNj æå–å¯†ç ï¼šypgn ã€32ã€‘æ³°ç‰›2017phpåŸºç¡€ç­å¤§ç‰›ç­å®Œæ•´è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1ggKGo9d æå–å¯†ç ï¼š2tqk ã€33ã€‘2018å¹´æœ€æ–°Javaå¾®æœåŠ¡åŸç†è¯¾ç¨‹ä¸æ”¹é€ æˆ¿äº§é”€å”®å¹³å°è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1jKf8MMi æå–å¯†ç ï¼ši8ej ã€34ã€‘ä½¿ç”¨dubboã€spring-bootç­‰æŠ€æœ¯å®ç°äº’è”ç½‘åå°æœåŠ¡é¡¹ç›®æ¶æ„è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1gg1JiBD æå–å¯†ç ï¼š1jtk ã€35ã€‘æœ€æ–°åŒºå—é“¾å¼€å‘å…¥é—¨åˆ°ç²¾é€šè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1kW7FTwr æå–å¯†ç ï¼šhvep ã€36ã€‘2018å¹´æœ€æ–°ä»·å€¼1699å…ƒçš„æ·±å…¥å¤§æ•°æ®æ¶æ„å¸ˆä¹‹è·¯ï¼Œé—®é¼40ä¸‡å¹´è–ªè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1c3d1RbU æå–å¯†ç ï¼š22kw ã€37ã€‘2018å¹´æœ€æ–°javaå¤§æ•°æ®åŸºäºstormå¼€å‘å®æ—¶æµå¤„ç†å™¨è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1cOCHPk æå–å¯†ç ï¼šigw9 ã€38ã€‘2017å¹´æœ€æ–°JAVA-ACE-æ¶æ„å¸ˆç³»åˆ—è§†é¢‘è¯¾ç¨‹-RocketMQhttps://pan.baidu.com/s/1ghb9UAf æå–å¯†ç ï¼šsstz ã€39ã€‘2017å¹´æ·±åº¦å­¦ä¹ é¡¹ç›®å®æˆ˜è§†é¢‘è¯¾ç¨‹-Seq2Seqåºåˆ—ç”Ÿæ¨¡å‹è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1dGEDwSp æå–å¯†ç ï¼š96eh ã€40ã€‘2017å¹´æœ€æ–°webå‰ç«¯å·¥ç¨‹å¸ˆå°ç™½é›¶åŸºç¡€å…¥é—¨åˆ°å¤§ç¥å…¨å¥—æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1dFQ8wgT æå–å¯†ç ï¼š7g4e ã€41ã€‘2017å¹´æœ€æ–°pythoné«˜çº§æ¨¡å—matplotlibæ•°æ®å¯è§†åŒ–åˆ†æè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1kWyRVmB æå–å¯†ç ï¼šqjaj ã€42ã€‘ä»·å€¼1680å…ƒå®‰å“ç‰¹è®­ç­å®æˆ˜å¼€å‘ç™¾æ€ä¸å¾—å§appé¡¹ç›®æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1c3adHsc æå–å¯†ç ï¼šsxvg ã€43ã€‘2018å¹´æœ€æ–°ä»·å€¼799å…ƒElasticsearché¡¶å°–é«˜æ‰‹ç³»åˆ—ï¼šé«˜æ‰‹è¿›é˜¶ç¯‡è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1mkkSBrU æå–å¯†ç ï¼šzmjn ã€44ã€‘2017å¹´æœ€æ–°æ·±åº¦å­¦ä¹ æ¡†æ¶Caffeä½¿ç”¨æ¡ˆä¾‹è§†é¢‘è¯¾ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1dGFsBnz æå–å¯†ç ï¼šq4dg ã€45ã€‘ç‚¼æ•°æˆç²¾å¤§æ•°æ®çš„çŸ©é˜µè®¡ç®—åŸºç¡€è¯¾ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1mkaJbpY æå–å¯†ç ï¼špnnc ã€46ã€‘2018å¹´æœ€æ–°redisä»å…¥é—¨åˆ°ç²¾é€šä¸åˆ†å¸ƒå¼æ¶æ„è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1gggc7Fd æå–å¯†ç ï¼šimg8 ã€47ã€‘2018å¹´æœ€æ–°åŠ¨åŠ›èŠ‚ç‚¹Javaå¤œæ ¡è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1i6v7013 æå–å¯†ç ï¼šdbnt ã€48ã€‘å…¨ç½‘æœ€æ–°åŸºäºElasticSearchçš„æ‰¾æˆ¿ç½‘å®æˆ˜å¼€å‘ä¼ä¸šçº§æˆ¿å±‹æœç´¢ç½‘è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1bqUVrsF æå–å¯†ç ï¼šidjy ã€49ã€‘Javaé«˜æ€§èƒ½é«˜å¹¶å‘ç§’æ€ç³»ç»Ÿå®æˆ˜è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1bqVBoqb æå–å¯†ç ï¼šztqe ã€50ã€‘2017æœ€æ–°æœ€ç³»ç»Ÿçš„PHPé¢è¯•è§†é¢‘æ•™ç¨‹ä¸‹è½½é«˜è–ªæ— å¿§ https://pan.baidu.com/s/1o81Mu8q æå–å¯†ç ï¼šda2f ã€51ã€‘2017å¹´æœ€æ–°ç‚¼æ•°æˆé‡‘æœºå™¨è¯»å¿ƒæœ¯ä¹‹ç¥ç»ç½‘ç»œä¸æ·±åº¦å­¦ä¹ è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1mhJkQzI æå–å¯†ç ï¼špvc6 ã€52ã€‘æå…´åç³»åˆ—ä¹‹Java8ã€Oracleã€JavaScriptã€HTML5ã€Springã€Strutsã€Hibernateç³»åˆ—è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1o7O6ytc æå–å¯†ç ï¼šicgf ã€53ã€‘2017å¹´æœ€æ–°Python+scripyå®ç°æœç´¢å¼•æ“çˆ¬è™«è¯¾ç¨‹è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1mhLSFVy æå–å¯†ç ï¼šn333 ã€54ã€‘æœ€æ–°æŸæŸå­¦é™¢å¤§æ•°æ®å·¥ç¨‹å¸ˆè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1o7Cvjwm æå–å¯†ç ï¼šximb ã€55ã€‘2017å¹´Javawebå¼€å‘å·¥ç¨‹å¸ˆæˆé•¿ä¹‹è·¯å…¨å¥—è§†é¢‘æ•™ç¨‹é™„é…å¥—èµ„æ–™ä¸‹è½½ https://pan.baidu.com/s/1qXJcyVa æå–å¯†ç ï¼š31di ã€56ã€‘phpé«˜æ€§èƒ½yii2æ¡†æ¶å¼€å‘é«˜æ€§èƒ½é«˜å¯ç”¨è´Ÿè½½å‡è¡¡é›†ç¾¤æ¶æ„å•†åŸè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1jIKk70i æå–å¯†ç ï¼šb9bt ã€57ã€‘2017æœ€æ–°å…„å¼Ÿè¿laravelå…¥é—¨åˆ°ç²¾é€š+åšå®¢å®æˆ˜å¼€å‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1bZJAW2 æå–å¯†ç ï¼š6p4c ã€58ã€‘2017å¹´æœ€ç³»ç»Ÿçš„PHPæ•™ç¨‹é«˜è–ªå°±ä¸šè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1o7DG2pW æå–å¯†ç ï¼šrrds ã€59ã€‘2017æœ€æ–°å¤§æ•°æ®10ä¸ªå°æ—¶å¿«é€Ÿå…¥é—¨hadoop3é›†ç¾¤å®æˆ˜è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1hsgtagG æå–å¯†ç ï¼šdwin ã€60ã€‘2017å¹´æœ€æ–°Webpack+Reactå…¨æ ˆå·¥ç¨‹æ¶æ„é¡¹ç›®å®æˆ˜ç²¾è®²è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1hsq2s64 æå–å¯†ç ï¼šgprc ã€61ã€‘2017å¹´æœ€æ–°Uberè½¦è¾†ç›‘æ§ç³»ç»Ÿè®¾è®¡å®æˆ˜è®­ç»ƒè¥é«˜æ¸…è§†é¢‘æ•™ç¨‹å…¨å¥—é™„è®²ä¹‰ä»£ç  https://pan.baidu.com/s/1nv9Vm5b æå–å¯†ç ï¼š5bs8 ã€62ã€‘2017å¹´æœ€æ–°DS206äººè„¸è¯†åˆ«ä¸åˆ†æç³»ç»Ÿå®æˆ˜è®­ç»ƒè¥ç¡…è°·è®²å¸ˆæˆè¯¾é«˜æ¸…è§†é¢‘æ•™ç¨‹å…¨å¥—é™„è®²ä¹‰ä»£ç 4å‘¨ https://pan.baidu.com/s/1c2LcBsc æå–å¯†ç ï¼šnv1h ã€63ã€‘2017å¹´æœ€æ–°Reactå¼€å‘Nativeå¼€å‘å®‰å“ä¸ioså¹³å°çš„GitHubAppè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1jI6DiXg æå–å¯†ç ï¼š7cyk ã€64ã€‘2017å¹´æœ€æ–°Googleé¢è¯•å®˜äº²æˆjavaæ ¡æ‹›é¢è¯•è§†é¢‘è®²è§£æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1nuDIkQ1 æå–å¯†ç ï¼šhhnu ã€65ã€‘Androidä¼ æ„Ÿå™¨ã€æ— çº¿ä¼ è¾“ä¸åª’ä½“ç¡¬ä»¶åŠŸèƒ½å¼€å‘è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1bpoA4EV æå–å¯†ç ï¼šcvh9 ã€66ã€‘æœ€æ–°Kaggleç¥å™¨ä¹‹XGBoostä»å…¥é—¨åˆ°ç²¾é€šé«˜æ¸…ç²¾å“è§†é¢‘æ•™ç¨‹é™„ä»£ç æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1nvj6fDR æå–å¯†ç ï¼šx493 ã€67ã€‘Oracleå•†ä¸šæ™ºèƒ½BIäº§å“OBIEE11Gæ·±å…¥æµ…å‡ºå…¨å¥—è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1o81KXPg æå–å¯†ç ï¼šf3sg ã€68ã€‘2017å¹´æœ€æ–°å°è±¡å­¦é™¢åˆ†å¸ƒå¼çˆ¬è™«ç¬¬äºŒæœŸè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1geX7fKB æå–å¯†ç ï¼š2ac9 ã€69ã€‘mongodbä»å…¥é—¨åˆ°ç²¾é€šé«˜æ¸…è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1cpsdjC æå–å¯†ç ï¼š3ng4 ã€70ã€‘æœ€æ–°å¤§æ•°æ®å¿«é€Ÿæ•°æ®æŒ–æ˜å¹³å°RapidMineræ•°æ®åˆ†æè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1bpFE111 æå–å¯†ç ï¼š3z6u ã€71ã€‘æœ€æ–°Pythonè‡ªç„¶è¯­è¨€åˆ†æè§†é¢‘è¯¾ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1ge40FbP æå–å¯†ç ï¼šwa5r ã€72ã€‘æœ€æ–°å°šå­¦å ‚redisè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1c35hRg æå–å¯†ç ï¼šgy5j ã€73ã€‘æœ€æ–°oracle11gDBAå¼€å‘å’Œåº”ç”¨æ•°æ®åº“è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1o7YE5Bk æå–å¯†ç ï¼šeu68 ã€74ã€‘2017vue2nodemongoKoa2Nuxt/VueSSRå…¨æ ˆå¼€å‘å°ç¨‹åºå•†åŸè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1jIw3lR4 æå–å¯†ç ï¼šbmia ã€75ã€‘æœ€æ–°pythonæ•°æ®åˆ†æå‡çº§ç‰ˆè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1i5L7LdV æå–å¯†ç ï¼šbfk7 ã€76ã€‘Pythonæ•°æ®åˆ†æ(æœºå™¨å­¦ä¹ )ç»å…¸æ¡ˆä¾‹è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1nuUCPlf æå–å¯†ç ï¼š3ytg ã€77ã€‘DB2æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1qYysRDE æå–å¯†ç ï¼ši1rx ã€78ã€‘2017å¹´node.jsé›¶åŸºç¡€å…¥é—¨åˆ°ä¼ä¸šçº§å…¨æ ˆæ¡ˆä¾‹å¼€å‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1eRBopRs æå–å¯†ç ï¼šne2a ã€79ã€‘Hadoopå¤§æ•°æ®è§†é¢‘æ•™ç¨‹ï¼šçœŸå®ç”µå•†æ•°æ®ä»“åº“å…¨æµç¨‹å¼€å‘è¯¦è§£(å…±46è®²)è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1bpMzOyr æå–å¯†ç ï¼šm3yt ã€80ã€‘æœ€æ–°è€ç”·å­©pythonå…¨æ ˆå·¥ç¨‹å¸ˆç¬¬2æœŸå…¨å¥—å®Œæ•´ç‰ˆè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1cIycbk æå–å¯†ç ï¼šcgfm ã€81ã€‘ä»·å€¼2400å…ƒçš„pythonå…¨æ ˆå¼€å‘ç³»åˆ—FlaskPythonWebç½‘ç«™ç¼–ç¨‹è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1qXATJju æå–å¯†ç ï¼šhuc3 ã€82ã€‘æœ€æ–°pythonä»å…¥é—¨åˆ°ç²¾é€šåˆ°å¼€å‘çˆ¬è™«å®ä¾‹è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1mirFpeK æå–å¯†ç ï¼š9gmt ã€83ã€‘æå®¢å­¦é™¢VIPæ•™ç¨‹postgresqlæ•™ç¨‹å…¨é›†è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1i4DjPdF æå–å¯†ç ï¼šqgga ã€84ã€‘æœ€æ–°angular4.xæ¡†æ¶ä¸reduxå¼€å‘å¤§å‹ä¼ä¸šçº§ç®¡ç†é¡¹ç›®è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1nvEDQNB æå–å¯†ç ï¼šmqvu ã€85ã€‘2017å¹´æ•°æ®åˆ†æä¸æœºå™¨å­¦ä¹ å®æˆ˜åˆ°ç»å…¸æ¡ˆä¾‹å…¨å¥—é«˜æ¸…è§†é¢‘æ•™ç¨‹ï¼ˆåŸºäºPython3.5anaconda4.2ï¼‰15G https://pan.baidu.com/s/1nvqXoPN æå–å¯†ç ï¼širdj ã€86ã€‘2017å¹´æœ€æ–°å¤§æ•°æ®å®æ—¶åˆ†æStormå…¥é—¨åˆ°ç²¾é€šå­¦ä¹ è·¯çº¿è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1pL7OfvP æå–å¯†ç ï¼š2ze2 ã€87ã€‘ä½¿ç”¨phpé«˜å¯ç”¨webappåç«¯å¼€å‘è§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1qXTQ5FQ æå–å¯†ç ï¼špybc ã€88ã€‘2017å¹´æœ€æ–°javaç®—æ³•è¯¦è§£ä¸ç®—æ³•å¼€å‘å°æ¸¸æˆè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1dF0GWNn æå–å¯†ç ï¼št6tk ã€89ã€‘2017å¹´9æœˆæœ€æ–°pythonflaskå¼€å‘å°è§†é¢‘ç½‘ç«™è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1nuHfvZF æå–å¯†ç ï¼špygf ã€90ã€‘2017å¹´5æœˆç‚¼æ•°æˆé‡‘ã€ŠMySQLDBAä»å°ç™½åˆ°å¤§ç¥å®æˆ˜ã€‹è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1jHFP8sm æå–å¯†ç ï¼šqnmj ã€91ã€‘Vueä»å…¥é—¨åˆ°ç²¾é€šè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1pKCX6Wj æå–å¯†ç ï¼šh6hd ã€92ã€‘åŒ—é£ç½‘ä»C++èµ·æ­¥åˆ°MFCå®æˆ˜VC++è½¯ä»¶å·¥ç¨‹å¸ˆé«˜ç«¯åŸ¹è®­(æœåŠ¡å™¨ç«¯å¼€å‘æ–¹å‘)332è¯¾å…¨ https://pan.baidu.com/s/1c1SSWKg æå–å¯†ç ï¼šiw7p ã€93ã€‘2017æœ€æ–°python3ä»é›¶åŸºç¡€å…¥é—¨åˆ°ç²¾è®²è¶…æ¸…è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1c2Nd468 æå–å¯†ç ï¼šh46d ã€94ã€‘2017å¹´æœ€æ–°ä½¿ç”¨MUIå¼€å‘è·¨å¹³å°æ··åˆAPPå…¨å¥—å®Œæ•´è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1dFxYZ0d æå–å¯†ç ï¼š9ury ã€95ã€‘æœ€æ–°äººè„¸è¯†åˆ«æ·±åº¦å­¦ä¹ é¡¹ç›®å®æˆ˜è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1o8onm2m æå–å¯†ç ï¼š7aqr ã€96ã€‘2017å¹´æœ€æ–°Pythonç½‘ç»œçˆ¬è™«å®æˆ˜æ¡ˆä¾‹è§†é¢‘æ•™ç¨‹ä¸‹è½½å…±5ç« 34è¯¾ https://pan.baidu.com/s/1micMg8w æå–å¯†ç ï¼š23gt ã€97ã€‘åŸºäºHadoopï¼ŒSparkå¤§æ•°æ®æŠ€æœ¯çš„æ¨èç³»ç»Ÿç®—æ³•å®æˆ˜æ•™ç¨‹ https://pan.baidu.com/s/1dFnP9K1 æå–å¯†ç ï¼šdjyk ã€98ã€‘ https://pan.baidu.com/s/1gf0CGuB æå–å¯†ç ï¼š4tei ã€99ã€‘2017å¹´æœ€æ–°äº‘çŸ¥æ¢¦phpå…¨æ ˆå¼€å‘å…¨å¥—è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1qYPwSsW æå–å¯†ç ï¼šiv93 ã€100ã€‘Pythonç¼–ç¨‹é«˜çº§è¿›é˜¶è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1bpnnEph æå–å¯†ç ï¼šy9sp ã€101ã€‘2017å¹´5æœˆæœ€æ–°è¯¾ç¨‹å°è±¡å­¦é™¢æ·±åº¦å­¦ä¹ ç¬¬å››æœŸè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1o7IzeXk æå–å¯†ç ï¼škptc ã€102ã€‘æœ€æ–°è‡ªåŠ¨èŠå¤©æœºå™¨äººé¡¹ç›®ç­å®æˆ˜è§†é¢‘è¯¾ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1kU9bNev æå–å¯†ç ï¼š6p5z ã€103ã€‘æ·±åº¦å­¦ä¹ å…¥é—¨è§†é¢‘è¯¾ç¨‹ä¸Šç¯‡+ä¸‹ç¯‡ä¸‹è½½ https://pan.baidu.com/s/1slG7qxv æå–å¯†ç ï¼šu2c4 ã€104ã€‘ä¸ƒæœˆåœ¨çº¿æœºå™¨å­¦ä¹ ç®—æ³•ç­9æœˆåœ¨çº¿ç­è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1nuLiXCl æå–å¯†ç ï¼švdkz ã€105ã€‘æœ€æ–°å°è±¡å­¦é™¢æœºå™¨å­¦ä¹ å‡çº§ç‰ˆIIIè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1gfeXSgb æå–å¯†ç ï¼šdt7t ã€106ã€‘æœ€æ–°ä¼˜è¾¾å­¦åŸudacityæ— äººé©¾é©¶å·¥ç¨‹å¸ˆè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1c1UUEXi æå–å¯†ç ï¼šmjbs ã€107ã€‘2017å¹´æ·±åº¦å­¦ä¹ é¡¹ç›®å®æˆ˜ä¹‹å¯¹æŠ—ç”Ÿæˆç½‘ç»œè§†é¢‘è¯¾ç¨‹ https://pan.baidu.com/s/1hs8chxU æå–å¯†ç ï¼š76mw ã€108ã€‘2017å¹´æ·±åº¦å­¦ä¹ ä¹‹Tensorflowé¡¹ç›®å®æˆ˜è§†é¢‘è¯¾ç¨‹-æ–‡æœ¬åˆ†ç±» https://pan.baidu.com/s/1c1Kf1wG æå–å¯†ç ï¼šdt52 ã€109ã€‘2017å¹´kaggleæ¡ˆä¾‹å®æˆ˜ç­è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1boYu4FX æå–å¯†ç ï¼š4bhc ã€110ã€‘æ·±åº¦å­¦ä¹ å®æˆ˜å†³èƒœAI-å¼ºåŒ–å­¦ä¹ å®æˆ˜ç³»åˆ—è§†é¢‘è¯¾ç¨‹ https://pan.baidu.com/s/1eRHZ1yq æå–å¯†ç ï¼šifu2 ã€111ã€‘2017å¹´æœ€æ–°ä»ç†è®ºåˆ°å®è·µæœºå™¨å­¦ä¹ è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1jHPsHSU æå–å¯†ç ï¼šxx9x ã€112ã€‘2017æœ€æ–°åŸºäºspringsecurityä¸spingmvcåˆ†å¸ƒå¼æƒé™ç®¡ç†ç³»ç»Ÿ https://pan.baidu.com/s/1c13keOw æå–å¯†ç ï¼šxea9 ã€113ã€‘Javaé«˜å¹¶å‘ç¨‹åºè®¾è®¡å®æˆ˜è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1c1CDsnI æå–å¯†ç ï¼šxsic ã€114ã€‘Sqoopã€Flumeã€Oozieã€Hueå¤§æ•°æ®å·¥å…·è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1bo47OGR æå–å¯†ç ï¼šhxw7 ã€115ã€‘æ·±å…¥JVMå†…æ ¸â€”åŸç†ã€è¯Šæ–­ä¸ä¼˜åŒ–è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1jIL46PK æå–å¯†ç ï¼š78yd ã€116ã€‘Hadoop,Hbase,Hiveæºç è§£æä¸å¼€å‘å®æˆ˜ https://pan.baidu.com/s/1hsznJsK æå–å¯†ç ï¼šdpmq ã€117ã€‘ä¼ æ™ºæ’­å®¢é»‘é©¬P2Pé‡‘èé¡¹ç›®ç½‘ç»œå€Ÿè´·å¹³å°å¼€å‘å®æˆ˜æ•™ç¨‹ https://pan.baidu.com/s/1pLieuzL æå–å¯†ç ï¼šgbxy ã€118ã€‘2017å¹´7æœˆæœ€æ–°å¾®æœåŠ¡æ¶æ„çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³è§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1bo47p2R æå–å¯†ç ï¼š94hx ã€119ã€‘äº¿çº§æµé‡ç”µå•†ç³»ç»Ÿå¤§å‹é«˜å¹¶å‘ä¸é«˜å¯ç”¨ç¼“å­˜æ¶æ„å®æˆ˜ https://pan.baidu.com/s/1pLmhZir æå–å¯†ç ï¼š6aj9 ã€120ã€‘2017Spark2.0å¤§å‹é¡¹ç›®å®æˆ˜ï¼šç§»åŠ¨ç”µå•†appäº¤äº’å¼æ•°æ®åˆ†æå¹³å° https://pan.baidu.com/s/1o8EAk2Y æå–å¯†ç ï¼šgcsq ã€121ã€‘NO89ä¸­ç§»åŠ¨å¤§å‹åˆ†å¸ƒå¼redis,solr,Linux,nginx,springmvc,mybatisç”µå•†é¡¹ç›® https://pan.baidu.com/s/1qY7K2SW æå–å¯†ç ï¼šcjj4 ã€122ã€‘SpringBootä»å‰ç«¯åˆ°åå°æ‰“é€ ä¼ä¸šçº§åšå®¢å…¨æ ˆå®æˆ˜è§†é¢‘ https://pan.baidu.com/s/1pKLc2BT æå–å¯†ç ï¼š8tjw ã€123ã€‘ï¼ˆ2017å¹´ï¼‰æœ€æ–°æ·±åº¦å­¦ä¹ ä¸æœºå™¨å­¦ä¹  https://pan.baidu.com/s/1c76kgA æå–å¯†ç ï¼š5qyv ã€124ã€‘SpringMvc+Spring+Mybatisæ•´åˆè§†é¢‘æ•™ç¨‹ http://pan.baidu.com/s/1gfP90Pl æå–å¯†ç ï¼škveg ã€125ã€‘Struts2+Spring3+Hibernate4+Maven+EasyUIæ•´åˆå…¥é—¨è§†é¢‘æ•™ç¨‹ http://pan.baidu.com/s/1bpztkOR æå–å¯†ç ï¼škrbn ã€126ã€‘elkæ—¥å¿—åˆ†æè§†é¢‘ELKStackè§†é¢‘æ•™ç¨‹ä»¥åŠSolræ•™ç¨‹ http://pan.baidu.com/s/1qYwQOSc æå–å¯†ç ï¼šqr9u ã€127ã€‘å¾è€å¸ˆhadoophbasezookeepersparkkafkaå¤§æ•°æ®è§†é¢‘æ•™ç¨‹ http://pan.baidu.com/s/1miLtQqO æå–å¯†ç ï¼š97tj ã€128ã€‘2017å¹´æœ€æ–°é¡¹ç›®å®æˆ˜SpringBootè§†é¢‘æ•™ç¨‹å¾®æœåŠ¡æ•´åˆMybatis http://pan.baidu.com/s/1boMH2Cv æå–å¯†ç ï¼šgvt5 ã€129ã€‘ä¼ æ™ºæ’­å®¢æœ€æ–°å¤§æ•°æ®ç¬¬3æœŸå®æˆ˜åŸ¹è®­å®Œæ•´ç‰ˆè§†é¢‘æ•™ç¨‹ http://pan.baidu.com/s/1miLZwwg æå–å¯†ç ï¼š56hs ã€130ã€‘[å¤§æ•°æ®]æå®¢å­¦é™¢å¤§æ•°æ®å·¥ç¨‹å¸ˆå…¨å¥—è§†é¢‘ä»£ç è¯¾ä»¶ http://pan.baidu.com/s/1c160ug4 æå–å¯†ç ï¼š6d28 ã€131ã€‘2017æ–°ç‰ˆMySQLåŠ å¼ºè§†é¢‘æ•™ç¨‹46è¯¾é™„è¯¾ä»¶æºç  http://pan.baidu.com/s/1eSouP6U æå–å¯†ç ï¼šnh8i ã€132ã€‘Pythonçˆ¬è™«é¡¹ç›®ç­ä»é›¶å¼€å§‹å®ç°çˆ¬è™«ç³»ç»Ÿ http://pan.baidu.com/s/1i5QiuzV æå–å¯†ç ï¼š2vpd ã€133ã€‘Mongodb/Redis/HBaseNoSqlè§†é¢‘æ•™ç¨‹2017æ•°æ®åº“è‡ªå­¦æ•™ç¨‹ http://pan.baidu.com/s/1kVytRIB æå–å¯†ç ï¼šmtnb ã€134ã€‘Mahouté›¶åŸºç¡€å…¥é—¨åˆ°ç²¾é€šå®æˆ˜è§†é¢‘æ•™ç¨‹ï¼ˆå…¨å¥—ï¼‰ä¸‹è½½ http://pan.baidu.com/s/1kUPNJaJ æå–å¯†ç ï¼špvka ã€135ã€‘2017å¹´æœ€æ–°æ•´ç†æ·±åº¦å­¦ä¹ ç¥ç»ç½‘ç»œç®—æ³•å…¨å¥—è§†é¢‘æ•™ç¨‹ http://pan.baidu.com/s/1pLsfdIb æå–å¯†ç ï¼švy41 ã€136ã€‘é˜¿é‡Œå¼€æºåˆ†å¸ƒå¼æ¡†æ¶dubbo&amp;mycatè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1geZwIYZ æå–å¯†ç ï¼šh7iw ã€137ã€‘æå®¢å­¦é™¢pythonå¼€å‘å·¥ç¨‹å¸ˆè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1miDOboc æå–å¯†ç ï¼šgwaa ã€138ã€‘2017æœ€æ–°pythonæ•™ç¨‹è€ç”·å­©Python14æœŸè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1kVbWgzP æå–å¯†ç ï¼š9hk7 ã€139ã€‘è¾¾å†…2017Webå‰ç«¯å…¨å¥—æœ€æ–°ä»·å€¼2ä¸‡å…ƒè§†é¢‘æ•™ç¨‹ http://pan.baidu.com/s/1jIA3oma æå–å¯†ç ï¼šrfqk ã€140ã€‘è¾¾å†…Javaå…¨å¥—æœ€æ–°ä»·å€¼2ä¸‡å…ƒè§†é¢‘æ•™ç¨‹ https://pan.baidu.com/s/1sl545sx æå–å¯†ç ï¼šsa8i ã€141ã€‘SparkMLlibæœºå™¨å­¦ä¹ ç®—æ³•ä¸æºç è§£æ https://pan.baidu.com/s/1pLptvMN æå–å¯†ç ï¼šncek ã€142ã€‘å¤§æ•°æ®å¼€å‘ä¹‹hadoopå·¥ç¨‹å¸ˆæˆé•¿ä¹‹è·¯é›¶åŸºç¡€åˆ°ç²¾é€šä¸‹è½½ https://pan.baidu.com/s/1i4LciTf æå–å¯†ç ï¼š8z4m ã€143ã€‘KafkaåŸç†å‰–æåŠå®æˆ˜æ¼”ç»ƒè§†é¢‘æ•™ç¨‹ä¸‹è½½ https://pan.baidu.com/s/1mhAgeBA æå–å¯†ç ï¼š26ny","link":"/2020/09/28/%E5%90%84%E7%A7%8D%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99%EF%BC%8C%E5%8C%85%E6%8B%AC%E4%B8%80%E4%BA%9B%E7%99%BE%E5%BA%A6%E4%BA%91%E8%A7%86%E9%A2%91%E9%93%BE%E6%8E%A5%E8%BF%98%E6%9C%89pdf%E8%B5%84%E6%96%99%20--%E6%90%AC%E8%BF%90%E5%B7%A5/"},{"title":"29 åº”ç”¨ç¨‹åºè¿”å›æŒ‰é”®æ‰§è¡Œæµç¨‹","text":"ä»è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å¼€å§‹åˆ†æandroidç³»ç»Ÿçš„äº‹ä»¶åˆ†å‘æµç¨‹ï¼Œå…¶å®ç½‘ä¸Šå·²ç»æœ‰äº†å¾ˆå¤šå…³äºandroidç³»ç»Ÿçš„äº‹ä»¶åˆ†å‘æµç¨‹çš„æ–‡ç« ï¼Œå¥ˆä½•çœ‹äº†å¾ˆå¤šä½†æ˜¯å°è±¡è¿˜ä¸æ˜¯å¾ˆæ·±ï¼Œæ‰€ä»¥è¿™é‡Œæ€»ç»“ä¸€ç•ªã€‚androidç³»ç»Ÿçš„äº‹ä»¶åˆ†å‘æµç¨‹åˆ†ä¸ºå¾ˆå¤šéƒ¨åˆ†ï¼š Nativeå±‚ â€“&gt; ViewRootImplå±‚ â€“&gt; DecorViewå±‚ â€“&gt; Activityå±‚ â€“&gt; ViewGroupå±‚ â€“&gt; Viewå±‚ æ‰€ä»¥androidç³»ç»Ÿçš„äº‹ä»¶åˆ†å‘æµç¨‹æ˜¯ä»Nativeå±‚å¼€å§‹çš„ï¼Œç„¶ååˆ†å‘åˆ°ViewRootImplä¸­ï¼Œç„¶ååˆ†å‘åˆ°DecorViewå±‚ï¼Œç„¶ååˆ†å‘åˆ°ViewGroupå±‚ï¼Œæœ€ååˆ†å‘åˆ°Viewå±‚ä¸­ã€‚ä¸‹é¢æˆ‘ä»¬å°†ä»Nativeå±‚å¼€å§‹åˆ†æäº‹ä»¶çš„åˆ†å‘æµç¨‹ã€‚ åœ¨Nativeå±‚androidç³»ç»Ÿçš„äº‹ä»¶æµç¨‹ï¼š Androidç³»ç»Ÿæ˜¯ä»ä»åº•å±‚é©±åŠ¨ä¸­è·å–å„ç§åŸå§‹çš„ç”¨æˆ·æ¶ˆæ¯ï¼ŒåŒ…æ‹¬æŒ‰é”®ã€è§¦æ‘¸å±ã€é¼ æ ‡ã€æ»šè¿¹çƒç­‰ç”¨æˆ·äº‹ä»¶æ¶ˆæ¯ã€‚ åœ¨è·å–ç”¨æˆ·æ¶ˆæ¯ä¹‹åï¼Œandroidç³»ç»Ÿä¼šå¯¹æœ€åŸå§‹çš„æ¶ˆæ¯è¿›è¡Œé¢„å¤„ç†ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ–¹é¢ï¼Œå°†æ¶ˆæ¯è½¬åŒ–æˆç³»ç»Ÿå¯ä»¥å¤„ç†çš„æ¶ˆæ¯äº‹ä»¶ï¼›å¦ä¸€æ–¹é¢ï¼Œå¤„ç†ä¸€äº›ç‰¹æ®Šçš„äº‹ä»¶ï¼Œæ¯”å¦‚HOMEã€MENUã€POWERé”®ç­‰å¤„ç†ï¼ˆå‰é¢çš„å‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»åˆ†æäº†ç³»ç»ŸæŒ‰é”®å¤„ç†é€»è¾‘çš„æ‰§è¡Œæµç¨‹ï¼‰ã€‚ å°†å¤„ç†åçš„æ¶ˆæ¯äº‹ä»¶åˆ†å‘åˆ°å„ä¸ªåº”ç”¨è¿›ç¨‹ï¼Œè¿™ä¸ªéœ€è¦ä½¿ç”¨IPCæœºåˆ¶ï¼ŒAndroidç³»ç»Ÿä½¿ç”¨ç®¡é“æ¥è¿›è¡Œæ¶ˆæ¯çš„ä¼ é€’ã€‚ Androidç³»ç»Ÿä½¿ç”¨InputManagerç±»æ¥ç®¡ç†æ¶ˆæ¯ï¼Œè€Œå…·ä½“çš„åŠŸèƒ½åˆ™æ˜¯é€šè¿‡InputReaderThreadå’ŒInputDispatcherThreadä¸¤ä¸ªçº¿ç¨‹æ¥å®ç°ã€‚å…¶ä¸­InputReaderThreadçº¿ç¨‹è´Ÿè´£æ¶ˆæ¯çš„è¯»å–ï¼Œè€ŒInputDispatcherThreadåˆ™è´Ÿè´£æ¶ˆæ¯çš„é¢„å¤„ç†å’Œåˆ†å‘åˆ°å„ä¸ªåº”ç”¨è¿›ç¨‹ä¸­ã€‚ Acitivtyç³»ç»Ÿåœ¨SystemServerè¿›ç¨‹ä¸­å¯åŠ¨WindowManagerServiceæœåŠ¡ï¼Œç„¶ååœ¨WindowManagerServiceæœåŠ¡ä¸­å¯åŠ¨InputManagerServiceæœåŠ¡ã€‚ å¯ä»¥çœ‹åˆ°åœ¨Nativeå±‚ï¼Œä¸»è¦åˆ›å»ºäº†ä¸¤ä¸ªä¸¤ä¸ªçº¿ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨äºè¯»å–æ¶ˆæ¯ï¼Œå¦ä¸€ä¸ªç”¨äºåˆ†å‘æ¶ˆæ¯ï¼Œæ¶ˆæ¯ç»è¿‡åˆ†å‘æœ€ç»ˆä¼šä¸Šä¼ è‡³Appä¸­ã€‚ åœ¨ViewRootImplå±‚androidç³»ç»Ÿçš„äº‹ä»¶æµç¨‹ åœ¨Nativeå±‚çš„äº‹ä»¶åˆ†å‘çº¿ç¨‹ä¸­ï¼Œç»è¿‡äº‹ä»¶çš„åˆ†å‘æµç¨‹ï¼Œæœ€ç»ˆä¼šè°ƒç”¨InputEventSenderçš„dispatchInputEventFinishedæ–¹æ³•ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“ä»£ç çš„å®ç°ï¼š 123private void dispatchInputEventFinished(int seq, boolean handled) { onInputEventFinished(seq, handled); }åœ¨dispatchInputEventFinishedæ–¹æ³•ä¸­æˆ‘ä»¬æœ€ç»ˆè°ƒç”¨çš„æ˜¯onInputEventFinishedæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬æŸ¥çœ‹onInputEventFinishedæ–¹æ³•çš„å®ç°ï¼Œå‘ç°å…¶æ˜¯ä¸€ä¸ªç©ºæ–¹æ³•ã€‚ã€‚ã€‚ï¼Œå¥½å§ï¼Œç»è¿‡åˆ†ææˆ‘ä»¬å‘ç°ï¼ŒNativeå±‚æœ€ç»ˆè°ƒç”¨çš„å¹¶ä¸æ˜¯InputEventSenderï¼Œè€Œæ˜¯è°ƒç”¨InputEventSenderçš„å­ç±»ImeInputEventSenderï¼Œå³ImeInputEventSenderçš„onInputEventFinishedæ–¹æ³•ï¼Œè¯¥ç±»å®šä¹‰åœ¨æºæ–‡ä»¶InputMethodManagerä¸­ï¼š 12345678910private final class ImeInputEventSender extends InputEventSender { public ImeInputEventSender(InputChannel inputChannel, Looper looper) { super(inputChannel, looper); } @Override public void onInputEventFinished(int seq, boolean handled) { finishedInputEvent(seq, handled, false); } } å¯ä»¥çœ‹åˆ°åœ¨å…¶onInputEventFinishedæ–¹æ³•ä¸­åˆè°ƒç”¨äº†finishedInputEventæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬åœ¨ç»§ç»­çœ‹ä¸€ä¸‹finishedInputEventæ–¹æ³•çš„å®ç°ã€‚ 12345678910111213141516171819202122void finishedInputEvent(int seq, boolean handled, boolean timeout) { final PendingEvent p; synchronized (mH) { int index = mPendingEvents.indexOfKey(seq); if (index &lt; 0) { return; // spurious, event already finished or timed out } p = mPendingEvents.valueAt(index); mPendingEvents.removeAt(index); Trace.traceCounter(Trace.TRACE_TAG_INPUT, PENDING_EVENT_COUNTER, mPendingEvents.size()); if (timeout) { Log.w(TAG, &quot;Timeout waiting for IME to handle input event after &quot; + INPUT_METHOD_NOT_RESPONDING_TIMEOUT + &quot; ms: &quot; + p.mInputMethodId); } else { mH.removeMessages(MSG_TIMEOUT_INPUT_EVENT, p); } } invokeFinishedInputEventCallback(p, handled); } åœ¨æ–¹æ³•finishedInputEventä¸­ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„å¤„ç†ä¹‹åæœ€ç»ˆè°ƒç”¨çš„æ˜¯invokeFinishedInputEventCallbackæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹invokeFinishedInputEventCallbackæ–¹æ³•çš„å®ç°ã€‚ 1234567891011121314void invokeFinishedInputEventCallback(PendingEvent p, boolean handled) { p.mHandled = handled; if (p.mHandler.getLooper().isCurrentThread()) { // Already running on the callback handler thread so we can send the // callback immediately. p.run(); } else { // Post the event to the callback handler thread. // In this case, the callback will be responsible for recycling the event. Message msg = Message.obtain(p.mHandler, p); msg.setAsynchronous(true); msg.sendToTarget(); } } å¯ä»¥å‘ç°è¿™é‡Œæˆ‘ä»¬é¦–å…ˆåˆ¤æ–­PendingEventçš„mHandleræ‰€åœ¨çš„çº¿ç¨‹æ˜¯å¦æ˜¯å½“å‰çº¿ç¨‹ï¼Œè‹¥æ˜¯çš„è¯åˆ™ç›´æ¥è°ƒç”¨p.runæ–¹æ³•ï¼Œè‹¥ä¸æ˜¯çš„è¯åˆ™å‘é€ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œè€Œå¼‚æ­¥æ¶ˆæ¯æœ€ç»ˆä¹Ÿæ˜¯æ‰§è¡Œçš„p.runæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹PendingEventçš„runæ–¹æ³•ã€‚ 12345678@Override public void run() { mCallback.onFinishedInputEvent(mToken, mHandled); synchronized (mH) { recyclePendingEventLocked(this); } } å¯ä»¥å‘ç°åœ¨runæ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨äº†mCallbackçš„onFinishedInputEventæ–¹æ³•ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯è¿™é‡Œçš„mCallbackå°±æ˜¯æˆ‘ä»¬ViewRootImplä¸­çš„ImeInputStageç±»å¯¹è±¡ï¼Œè€Œè¿™é‡Œçš„ViewRootImplå¯¹è±¡å°±æ˜¯æˆ‘ä»¬çš„ç³»ç»Ÿå½“å‰ç•Œé¢ï¼Œå‰é¢æˆ‘ä»¬åˆ†æActivityçš„åŠ è½½ç»˜åˆ¶æµç¨‹çš„æ—¶å€™çŸ¥é“Activityä¸­ä¿å­˜äº†ä¸€ä¸ªWindowå¯¹è±¡ç”¨äºè¡¨ç¤ºçª—å£ä¿¡æ¯ï¼Œè€ŒWindowå¯¹è±¡å†…éƒ¨å°±æ˜¯é€šè¿‡ViewRootImplå¯¹è±¡å®ç°çª—å£çš„åŠ è½½ç»˜åˆ¶ï¼Œæ‰€ä»¥è¿™é‡Œçš„mCallbackå¯¹è±¡å°±æ˜¯æˆ‘ä»¬å½“å‰çš„Appè·å–ç„¦ç‚¹çš„çª—å£çš„ViewRootImplä¸­çš„ImeInputStageå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹è¯¥å¯¹è±¡çš„onFinishedInputEventæ–¹æ³•çš„å®ç°ã€‚ 12345678910111213final class ImeInputStage extends AsyncInputStage implements InputMethodManager.FinishedInputEventCallback { ... @Override public void onFinishedInputEvent(Object token, boolean handled) { QueuedInputEvent q = (QueuedInputEvent)token; if (handled) { finish(q, true); return; } forward(q); } } è¿™æ ·ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ä¹‹åæˆ‘ä»¬æ¶ˆæ¯çš„å¤„ç†é€»è¾‘ä¸Šä¼ è‡³äº†ViewRootImplä¸­ï¼Œè€Œåœ¨ViewRootImplä¸­ç»è¿‡ä¸€äº›åˆ—çš„è°ƒç”¨ä¹‹åæˆ‘ä»¬ViewRootImpl$ViewPostImeInputStage.processKeyEventæ–¹æ³•ï¼š 12345678910111213141516171819202122at android.view.ViewRootImpl$ViewPostImeInputStage.processKeyEvent(ViewRootImpl.java:4152)at android.view.ViewRootImpl$ViewPostImeInputStage.onProcess(ViewRootImpl.java:4114)at android.view.ViewRootImpl$InputStage.deliver(ViewRootImpl.java:3662)at android.view.ViewRootImpl$InputStage.onDeliverToNext(ViewRootImpl.java:3715)at android.view.ViewRootImpl$InputStage.forward(ViewRootImpl.java:3681)at android.view.ViewRootImpl$AsyncInputStage.forward(ViewRootImpl.java:3807)at android.view.ViewRootImpl$InputStage.apply(ViewRootImpl.java:3689)at android.view.ViewRootImpl$AsyncInputStage.apply(ViewRootImpl.java:3864)at android.view.ViewRootImpl$InputStage.deliver(ViewRootImpl.java:3662)at android.view.ViewRootImpl$InputStage.onDeliverToNext(ViewRootImpl.java:3715)at android.view.ViewRootImpl$InputStage.forward(ViewRootImpl.java:3681)at android.view.ViewRootImpl$InputStage.apply(ViewRootImpl.java:3689)at android.view.ViewRootImpl$InputStage.deliver(ViewRootImpl.java:3662)at android.view.ViewRootImpl$InputStage.onDeliverToNext(ViewRootImpl.java:3715)at android.view.ViewRootImpl$InputStage.forward(ViewRootImpl.java:3681)at android.view.ViewRootImpl$AsyncInputStage.forward(ViewRootImpl.java:3840)at android.view.ViewRootImpl$ImeInputStage.onFinishedInputEvent(ViewRootImpl.java:4006)at android.view.inputmethod.InputMethodManager$PendingEvent.run(InputMethodManager.java:2272)at android.view.inputmethod.InputMethodManager.invokeFinishedInputEventCallback(InputMethodManager.java:1893)at android.view.inputmethod.InputMethodManager.finishedInputEvent(InputMethodManager.java:1884)at android.view.inputmethod.InputMethodManager$ImeInputEventSender.onInputEventFinished(InputMethodManager.java:2249)at android.view.InputEventSender.dispatchInputEventFinished(InputEventSender.java:141) è¿™æ˜¯é€šè¿‡å¼‚å¸¸ä¿¡æ¯æ‰“å°çš„å †æ ˆä¿¡æ¯ï¼Œä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ViewRootImplä¸­æˆ‘ä»¬ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ä¹‹åæœ€ç»ˆæ‰§è¡Œçš„æ˜¯ï¼šViewRootImpl$ViewPostImeInputStage.processKeyEventæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹processKeyEventæ–¹æ³•ã€‚ 12345678private int processKeyEvent(QueuedInputEvent q) { ... // Deliver the key to the view hierarchy. if (mView.dispatchKeyEvent(event)) { return FINISH_HANDLED; } ...} å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†mViewçš„dispatchKeyEventæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬åˆ†æè¿‡Activityçª—å£åŠ è½½ç»˜åˆ¶æµç¨‹ï¼Œä»ä¸­æˆ‘ä»¬çŸ¥é“ViewRootImplä¸­çš„mViewå¯¹è±¡å°±æ˜¯æˆ‘ä»¬PhoneWindowä¸­çš„mDecorViewå¯¹è±¡ï¼ˆDecorViewï¼‰ï¼Œæ‰€ä»¥ç»è¿‡å±‚å±‚è°ƒç”¨æˆ‘ä»¬æœ€ç»ˆæ‰§è¡Œåˆ°äº†DecorViewå±‚ã€‚ åœ¨DecorViewå±‚androidç³»ç»Ÿçš„äº‹ä»¶æµç¨‹ ä»ä¸Šé¢æˆ‘ä»¬çŸ¥é“åœ¨ViewRootImplä¸­æˆ‘ä»¬æœ€ç»ˆè°ƒç”¨äº†mView.dispatchKeyEventæ–¹æ³•ï¼Œå³æ‰§è¡Œçš„æ˜¯PhoneWindow%DecorView.dispatchKeyEventæ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728293031323334353637@Override public boolean dispatchKeyEvent(KeyEvent event) { final int keyCode = event.getKeyCode(); final int action = event.getAction(); final boolean isDown = action == KeyEvent.ACTION_DOWN; if (isDown &amp;&amp; (event.getRepeatCount() == 0)) { // First handle chording of panel key: if a panel key is held // but not released, try to execute a shortcut in it. if ((mPanelChordingKey &gt; 0) &amp;&amp; (mPanelChordingKey != keyCode)) { boolean handled = dispatchKeyShortcutEvent(event); if (handled) { return true; } } // If a panel is open, perform a shortcut on it without the // chorded panel key if ((mPreparedPanel != null) &amp;&amp; mPreparedPanel.isOpen) { if (performPanelShortcut(mPreparedPanel, keyCode, event, 0)) { return true; } } } if (!isDestroyed()) { final Callback cb = getCallback(); final boolean handled = cb != null &amp;&amp; mFeatureId &lt; 0 ? cb.dispatchKeyEvent(event) : super.dispatchKeyEvent(event); if (handled) { return true; } } return isDown ? PhoneWindow.this.onKeyDown(mFeatureId, event.getKeyCode(), event) : PhoneWindow.this.onKeyUp(mFeatureId, event.getKeyCode(), event); } ä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚æœå½“å‰çš„PhoneWindowä¸æ˜¯destroyåº„åˆ™ï¼Œåˆ™æ‰§è¡Œcb.dispatchKeyEventæ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„callbackå¯¹è±¡å°±æ˜¯æˆ‘ä»¬çš„Activityå¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œæœ€ç»ˆä¼šæ‰§è¡Œåˆ°Activityçš„dispatchKeyEventæ–¹æ³•ã€‚ã€‚ã€‚ åœ¨Activityå±‚androidç³»ç»Ÿçš„äº‹ä»¶æµç¨‹ æ‰€ä»¥æˆ‘ä»¬è¿™é‡Œç»§ç»­çœ‹ä¸€ä¸‹Actiivtyä¸­çš„dispatchKeyEventæ–¹æ³•ï¼š 12345678910111213141516171819public boolean dispatchKeyEvent(KeyEvent event) { onUserInteraction(); // Let action bars open menus in response to the menu key prioritized over // the window handling it if (event.getKeyCode() == KeyEvent.KEYCODE_MENU &amp;&amp; mActionBar != null &amp;&amp; mActionBar.onMenuKeyEvent(event)) { return true; } Window win = getWindow(); if (win.superDispatchKeyEvent(event)) { return true; } View decor = mDecor; if (decor == null) decor = win.getDecorView(); return event.dispatch(this, decor != null ? decor.getKeyDispatcherState() : null, this); } ä»ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é¦–å…ˆè°ƒç”¨äº†Activityçš„windowå¯¹è±¡çš„superDispatchKeyEventæ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å°†å¤„ç†æ–¹æ³•ä¸‹å‘å¸¦Activityä¸­çš„Viewï¼Œè€Œè¿™é‡Œæˆ‘ä»¬åˆ†æçš„æ˜¯è¿”å›æŒ‰é”®ï¼Œæ˜¾ç„¶çš„Viewå±‚æ˜¯æ— æ³•å¤„ç†è¿™é‡Œçš„è¿”å›æŒ‰é”®çš„ï¼Œæ‰€ä»¥win.superDispatchKeyEventæ–¹æ³•è¿”å›çš„æ˜¯falseï¼Œæ‰€ä»¥æœ€ç»ˆæˆ‘ä»¬æ‰§è¡Œçš„æ˜¯event.dispatchæ–¹æ³•ã€‚è¿™æ ·æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹event.dispatchæ–¹æ³•çš„å®ç°ã€‚ 123456789101112131415public final boolean dispatch(Callback receiver, DispatcherState state, Object target) { switch (mAction) { ... case ACTION_UP: if (DEBUG) Log.v(TAG, &quot;Key up to &quot; + target + &quot; in &quot; + state + &quot;: &quot; + this); if (state != null) { state.handleUpEvent(this); } return receiver.onKeyUp(mKeyCode, this); ... } return false; } è¿™é‡Œæˆ‘ä»¬æš‚æ—¶åˆ†æä¸€ä¸‹ACTION_UPäº‹ä»¶ï¼Œå¯ä»¥å‘ç°è¿™é‡Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯receiver.onKeyUpæ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„receiverå°±æ˜¯æˆ‘ä»¬çš„Actiivtyï¼Œæ‰€ä»¥è¿™é‡Œåˆå›åˆ°äº†Activityå¹¶ä¸”æ‰§è¡Œå…¶onKeyUpæ–¹æ³•ã€‚ 1234567891011public boolean onKeyUp(int keyCode, KeyEvent event) { if (getApplicationInfo().targetSdkVersion &gt;= Build.VERSION_CODES.ECLAIR) { if (keyCode == KeyEvent.KEYCODE_BACK &amp;&amp; event.isTracking() &amp;&amp; !event.isCanceled()) { onBackPressed(); return true; } } return false; } çœ‹onKeyUpæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°å½“æˆ‘ä»¬æŒ‰çš„æ˜¯è¿”å›æŒ‰é”®æ—¶ï¼Œå…¶å›è°ƒäº†onBackPressedæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹onBackPressedæ–¹æ³•ã€‚ 123456789public void onBackPressed() { if (mActionBar != null &amp;&amp; mActionBar.collapseActionView()) { return; } if (!mFragments.getFragmentManager().popBackStackImmediate()) { finishAfterTransition(); } } å¯ä»¥çœ‹åˆ°ï¼Œåœ¨onBackPressedæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬æœ€ç»ˆè°ƒç”¨çš„æ˜¯finishAfterTransitionæ–¹æ³•ï¼Œæ‰€ä»¥ç»§ç»­çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 12345public void finishAfterTransition() { if (!mActivityTransitionState.startExitBackTransition(this)) { finish(); } } O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼ŒåŸæ¥finishæ–¹æ³•æ˜¯åœ¨è¿™é‡Œè°ƒç”¨çš„ï¼Œè¿™æ ·æˆ‘ä»¬æŒ‰ä¸‹è¿”å›æŒ‰é”®å¹¶æŠ¬èµ·ä¹‹åï¼Œç»è¿‡å±‚å±‚çš„è°ƒç”¨ä¹‹åæœ€ç»ˆè°ƒç”¨äº†æˆ‘ä»¬çš„finishæ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯finishæ‰Activityçš„æ–¹æ³•ï¼Œä¹Ÿå°±è§£é‡Šäº†æˆ‘ä»¬åœ¨Appä¸­é»˜è®¤æŒ‰ä¸‹è¿”å›æŒ‰é”®ä¹‹åAcitivtyä¼šè¢«é”€æ¯äº†ã€‚ æ€»ç»“ï¼š æœ¬æ–‡ä¸­ç”±äºæ˜¯åˆ†æçš„è¿”å›æŒ‰é”®çš„å¤„ç†æµç¨‹ï¼Œæ‰€ä»¥äº‹ä»¶çš„åˆ†å‘æµç¨‹æ²¡æœ‰åšè¯´æ˜ï¼Œä¸‹é¢çš„æ–‡ç« ä¸­ä¼šç€é‡ä»‹ç»Androidçš„äº‹ä»¶åˆ†å‘æµç¨‹ï¼› äº‹ä»¶åˆ†å‘æµç¨‹ä»Native â€“&gt; ViewRootImplå±‚ â€“&gt; DecorViewå±‚ â€“&gt; Activityå±‚éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ— è®ºæ˜¯æŒ‰é”®åˆ†å‘æµç¨‹è¿˜æ˜¯è§¦æ‘¸äº‹ä»¶åˆ†å‘æµç¨‹ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåäºŒï¼‰â€“&gt;ToaståŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸‰ï¼‰â€“&gt;Androidå¼‚å¸¸å¤„ç†æµç¨‹androidæºç è§£æï¼ˆäºŒåå››ï¼‰â€“&gt;onSaveInstanceStateæ‰§è¡Œæ—¶æœºandroidæºç è§£æï¼ˆäºŒåäº”ï¼‰â€“&gt;onLowMemoryæ‰§è¡Œæµç¨‹androidæºç è§£æï¼ˆäºŒåå…­ï¼‰â€“&gt;æˆªå±äº‹ä»¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸ƒï¼‰â€“&gt;HOMEäº‹ä»¶æµç¨‹androidæºç è§£æï¼ˆäºŒåå…«ï¼‰â€“&gt;ç”µæºå¼€å…³æœºæŒ‰é”®äº‹ä»¶æµç¨‹","link":"/2020/09/11/%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%BF%94%E5%9B%9E%E6%8C%89%E9%94%AE%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/"},{"title":"11 åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹","text":"è½¬è½½è¯·æ ‡æ˜å‡ºå¤„ï¼šä¸€ç‰‡æ«å¶çš„ä¸“æ  åœ¨android guideä¸­æœ‰è¿™æ ·çš„ä¸€æ®µå…³äºandroidåº”ç”¨ç¨‹åºè¿›ç¨‹çš„æè¿°ï¼š 1By default, every application runs in its own Linux process. Android starts the process when any of the application's components need to be executed, then shuts down the process when it's no longer needed or when the system must recover memory for other applications. æ¯ä¸€ä¸ªandroidåº”ç”¨é»˜è®¤éƒ½æ˜¯åœ¨ä»–è‡ªå·±çš„linuxè¿›ç¨‹ä¸­è¿è¡Œã€‚androidæ“ä½œç³»ç»Ÿä¼šåœ¨è¿™ä¸ªandroidåº”ç”¨ä¸­çš„ç»„ä»¶éœ€è¦è¢«æ‰§è¡Œçš„æ—¶å€™å¯åŠ¨è¿™ä¸ªåº”ç”¨è¿›ç¨‹ï¼Œå¹¶ä¸”ä¼šåœ¨è¿™ä¸ªåº”ç”¨è¿›ç¨‹æ²¡æœ‰ä»»ä½•ç»„ä»¶æ‰§è¡Œæˆ–è€…æ˜¯ç³»ç»Ÿéœ€è¦ä¸ºå…¶ä»–åº”ç”¨ç”³è¯·æ›´å¤šå†…å­˜çš„æ—¶å€™æ€æ­»è¿™ä¸ªåº”ç”¨è¿›ç¨‹ã€‚æ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦å¯åŠ¨è¿™ä¸ªåº”ç”¨çš„å››å¤§ç»„ä»¶ä¹‹ä¸€çš„æ—¶å€™å¦‚æœè¿™ä¸ªåº”ç”¨çš„è¿›ç¨‹è¿˜æ²¡æœ‰å¯åŠ¨ï¼Œé‚£ä¹ˆå°±ä¼šå…ˆå¯åŠ¨è¿™ä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚ æœ¬èŠ‚ä¸»è¦æ˜¯é€šè¿‡åˆ†æActivityçš„å¯åŠ¨è¿‡ç¨‹ä»‹ç»åº”ç”¨ç¨‹åºè¿›ç¨‹çš„å¯åŠ¨æµç¨‹ã€‚ åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ç®€è¦çš„ä»‹ç»äº†Launcherçš„å¯åŠ¨æµç¨‹ï¼Œåœ¨SystemServerè¿›ç¨‹æ‰§è¡Œå®Œæˆï¼Œå„ç§ç³»ç»ŸæœåŠ¡å¯åŠ¨å®Œæˆä¹‹åï¼Œä¼šè°ƒç”¨ActivityManagerServiceä¸­çš„systemReady()æ–¹æ³•ï¼Œåœ¨systemReadyï¼ˆï¼‰æ–¹æ³•ä¸­ä¼šæ‰§è¡ŒLauncherå¯åŠ¨çš„ç›¸å…³é€»è¾‘äº†ï¼Œå…·ä½“å¯ä»¥å‚è€ƒï¼š androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹ Launcheråº”ç”¨ç¨‹åºåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šé€šè¿‡PackageManagerServiceæœåŠ¡è¯·æ±‚æŸ¥è¯¢ç³»ç»Ÿæ‰€æœ‰çš„å·²å®‰è£…åº”ç”¨çš„åŒ…åï¼Œå›¾æ ‡å’Œåº”ç”¨åç§°ç­‰ä¿¡æ¯ï¼Œç„¶åå¡«å……åˆ°Launcherä¸­çš„Adapterä¸­ï¼Œè¿™æ ·ç‚¹å‡»æŸä¸€é¡¹åº”ç”¨å›¾æ ‡çš„æ—¶å€™å°±å¯ä»¥æ ¹æ®è¯¥å›¾æ ‡çš„åŒ…åå’Œå¯åŠ¨Activityçš„ç±»ååˆå§‹åŒ–Intentå¯¹è±¡ï¼Œç„¶åè°ƒç”¨startActivity(Intent)å¯åŠ¨ç›¸å…³çš„åº”ç”¨ç¨‹åºäº†ã€‚ å…¶å®androidä¸­åº”ç”¨è¿›ç¨‹å¯ä»¥é€šè¿‡è®¸å¤šæ–¹å¼å¯åŠ¨ï¼Œæ¯”å¦‚å¯åŠ¨ä¸€ä¸ªActivityï¼Œå¯åŠ¨ä¸€ä¸ªServiceï¼Œå¯åŠ¨ä¸€ä¸ªContentProvideræˆ–è€…æ˜¯ä¸€ä¸ªBroadcastReceiverï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥é€šè¿‡å¯åŠ¨å››å¤§ç»„ä»¶çš„æ–¹å¼å¯åŠ¨åº”ç”¨è¿›ç¨‹ï¼Œåœ¨åº”ç”¨è¿›ç¨‹æ²¡æœ‰å¯åŠ¨çš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬é€šè¿‡å¯åŠ¨è¿™äº›ç»„ä»¶ï¼Œè¿™æ—¶å€™ç³»ç»Ÿä¼šåˆ¤æ–­å½“å‰è¿™äº›ç»„ä»¶æ‰€éœ€è¦çš„åº”ç”¨è¿›ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œè‹¥æ²¡æœ‰çš„è¯ï¼Œåˆ™ä¼šå¯åŠ¨åº”ç”¨è¿›ç¨‹ã€‚ è¿™é‡Œæˆ‘ä»¬é€šè¿‡Launcherç®€å•åˆ†æä¸€ä¸‹åº”ç”¨è¿›ç¨‹çš„å¯åŠ¨æµç¨‹ã€‚é€šè¿‡ä¸Šä¸€ç¯‡Launcherå¯åŠ¨æµç¨‹ï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸€ä¸ªlauncherä¸­çš„å›¾æ ‡å¯¹åº”ç€ä¸€ä¸ªåº”ç”¨æŠ¥åå’Œå¯åŠ¨activityç±»åï¼ŒæŸ¥çœ‹LauncherActivityä¸­çš„å›¾æ ‡ç‚¹å‡»äº‹ä»¶: 1234protected void onListItemClick(ListView l, View v, int position, long id) { Intent intent = intentForPosition(position); startActivity(intent); }åœ¨é€šè¿‡åº”ç”¨åŒ…åå’Œå¯åŠ¨activityç±»åæ„é€ å®ŒæˆIntentä¹‹åï¼Œæˆ‘ä»¬è°ƒç”¨äº†startActivityæ–¹æ³•æ¥å¯åŠ¨è¿™ä¸ªactivityï¼Œå¾ˆæ˜æ˜¾çš„ï¼Œå½“å‰è¿™ä¸ªåº”ç”¨å¹¶æ²¡æœ‰å¯åŠ¨ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è°ƒç”¨çš„startActivityæ–¹æ³•ä¸å•å•ä¸ºæˆ‘ä»¬å¯åŠ¨äº†è¿™ä¸ªactivityä¹ŸåŒæ—¶åœ¨å¯åŠ¨activityä¹‹å‰å¯åŠ¨äº†è¿™ä¸ªåº”ç”¨è¿›ç¨‹ï¼Œå¥½äº†ï¼Œé‚£æˆ‘ä»¬è¿™é‡Œå°±ä»¥è¿™ä¸ªæ–¹æ³•ä¸ºå…¥å£åˆ†æä¸€ä¸‹åº”ç”¨è¿›ç¨‹çš„å¯åŠ¨æµç¨‹ã€‚ è·Ÿè¸ªä»£ç åˆ°Activityï¼Œå‘ç°å…¶è°ƒç”¨äº†startActivityçš„é‡è½½æ–¹æ³•ï¼š 1234@Override public void startActivity(Intent intent) { this.startActivity(intent, null); } ç»§ç»­è·Ÿè¿›ï¼š 12345678910@Override public void startActivity(Intent intent, @Nullable Bundle options) { if (options != null) { startActivityForResult(intent, -1, options); } else { // Note we want to go through this call for compatibility with // applications that may have overridden the method. startActivityForResult(intent, -1); } } å¾ˆæ˜æ˜¾çš„æˆ‘ä»¬æ­¤æ—¶ä¼ é€’çš„optionsä¸ºç©ºï¼š 123public void startActivityForResult(Intent intent, int requestCode) { startActivityForResult(intent, requestCode, null); } å¥½å§ï¼Œæœ€åè°ƒç”¨çš„è¿˜æ˜¯è¿™ä¸ªé‡è½½æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627public void startActivityForResult(Intent intent, int requestCode, @Nullable Bundle options) { if (mParent == null) { Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity( this, mMainThread.getApplicationThread(), mToken, this, intent, requestCode, options); if (ar != null) { mMainThread.sendActivityResult( mToken, mEmbeddedID, requestCode, ar.getResultCode(), ar.getResultData()); } if (requestCode &gt;= 0) { mStartedActivity = true; } cancelInputsAndStartExitTransition(options); // TODO Consider clearing/flushing other event sources and events for child windows. } else { if (options != null) { mParent.startActivityFromChild(this, intent, requestCode, options); } else { // Note we want to go through this method for compatibility with // existing applications that may have overridden it. mParent.startActivityFromChild(this, intent, requestCode); } } } å¯ä»¥å‘ç°è¿™é‡Œè°ƒç”¨äº†mInstrumentation.execStartActivityæ–¹æ³•ï¼Œè¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹Instrumentationå¯¹è±¡ï¼Œä»–æ˜¯Androidç³»ç»Ÿä¸­åº”ç”¨ç¨‹åºç«¯æ“ä½œActivityçš„å…·ä½“æ“ä½œç±»ï¼Œè¿™é‡Œçš„æ“ä½œæ®µæ˜¯ç›¸å¯¹äºActivityManagerServiceæœåŠ¡ç«¯æ¥è¯´çš„ã€‚ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬åœ¨æ‰§è¡Œå¯¹Activityçš„å…·ä½“æ“ä½œæ—¶ï¼Œæ¯”å¦‚å›è°ƒç”Ÿå‘½å‘¨æœŸçš„å„ä¸ªæ–¹æ³•éƒ½æ˜¯å€ŸåŠ©äºInstrumentationç±»æ¥å®ç°çš„ã€‚ å¥½äº†ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹Instrumentationçš„execStartActivityæ–¹æ³•ï¼š 123456789101112131415161718public ActivityResult execStartActivity( Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, int requestCode, Bundle options) { ... try { intent.migrateExtraStreamToClipData(); intent.prepareToLeaveProcess(); int result = ActivityManagerNative.getDefault() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); checkStartActivityResult(result, intent); } catch (RemoteException e) { throw new RuntimeException(&quot;Failure from system&quot;, e); } return null; } è¿™é‡Œä¸»è¦å…³æ³¨è¿™ä¸ªä»£ç ï¼š 12345int result = ActivityManagerNative.getDefault() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); è¿™æ–­ä»£ç å®é™…ä¸Šæ˜¯è¿›ç¨‹é—´é€šè®¯ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°ActivityManagerNativeç»§æ‰¿äºBinderæ¥å£ï¼Œæ‰€ä»¥ActivityManagerNativeå°±æ˜¯ä¸€ä¸ªBinderå¯¹è±¡ï¼Œç„¶åä¸Šé¢ä¸€èŠ‚æˆ‘ä»¬ä»‹ç»SystemServerè¿›ç¨‹çš„æ—¶å€™å¯¹ActivityManagerServiceæœ‰è¿‡äº†è§£ï¼Œå‘ç°å…¶ç»§æ‰¿äºActivityManagerNativeï¼Œå¥½å§ï¼Œäº†è§£è¿‡Binderæœºåˆ¶çš„ç«¥é‹å°±çŸ¥é“äº†ï¼ŒActivityManagerServiceå°±æ˜¯è¿™ä¸ªBinderæœºåˆ¶çš„æœåŠ¡å™¨ç«¯è€ŒActivityManagerNativeå°±æ˜¯è¿™ä¸ªBinderæœºåˆ¶çš„å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œè°ƒç”¨çš„startActivityå®é™…ä¸Šæ˜¯è®²å‚æ•°ä¼ é€’ç»™ActivityManagerServiceå¹¶æ‰§è¡ŒActivityManagerServiceçš„startActivityæ–¹æ³•ã€‚ æ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityManagerServiceçš„startActivityæ–¹æ³•ï¼š 12345678@Override public final int startActivity(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle options) { return startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo, options, UserHandle.getCallingUserId()); } è°ƒç”¨äº†startActivityAsUseræ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹startActivityAsUseræ–¹æ³•ï¼š 123456789101112@Override public final int startActivityAsUser(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle options, int userId) { enforceNotIsolatedCaller(&quot;startActivity&quot;); userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId, false, ALLOW_FULL_ONLY, &quot;startActivity&quot;, null); // TODO: Switch to user app stacks here. return mStackSupervisor.startActivityMayWait(caller, -1, callingPackage, intent, resolvedType, null, null, resultTo, resultWho, requestCode, startFlags, profilerInfo, null, null, options, false, userId, null, null); } ç»§ç»­æŸ¥çœ‹startActivityMayWaitæ–¹æ³•ï¼š 1234567891011121314151617181920final int startActivityMayWait(IApplicationThread caller, int callingUid, String callingPackage, Intent intent, String resolvedType, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, WaitResult outResult, Configuration config, Bundle options, boolean ignoreTargetSecurity, int userId, IActivityContainer iContainer, TaskRecord inTask) { ... int res = startActivityLocked(caller, intent, resolvedType, aInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity, componentSpecified, null, container, inTask); ... return res; } } è¿™ä¸ªæ–¹æ³•çš„é€»è¾‘æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨çš„æ˜¯å…¶è°ƒç”¨äº†startActivityLockedæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åˆå§‹åŒ–å…¶ä»–é€»è¾‘ä¹‹åï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨startActivityLockedæ–¹æ³•ï¼š 12err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor, startFlags, true, options, inTask); ä»£ç é‡ä¹Ÿæ˜¯æ¯”è¾ƒå¤§çš„ï¼Œåœ¨æ–¹æ³•ä½“ä¸­è°ƒç”¨äº†startActivityUncheckedLockedæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­è·Ÿè¿›startActivityUncheckedLockedæ–¹æ³•ï¼š 1targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options); ç„¶åæˆ‘ä»¬æŸ¥çœ‹startActivityLockedæ–¹æ³•çš„å®ç°ï¼š 123if (doResume) { mStackSupervisor.resumeTopActivitiesLocked(this, r, options); } å¯ä»¥å‘ç°å…¶è°ƒç”¨äº†resumeTopActivitiesLockedæ–¹æ³•ï¼š 1stack.resumeTopActivityLocked(null); ç»§ç»­è·Ÿè¿›ï¼š 123final boolean resumeTopActivityLocked(ActivityRecord prev) { return resumeTopActivityLocked(prev, null); } ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹resumeTopActivityLockedæ–¹æ³•çš„å®ç°ï¼š 1result = resumeTopActivityInnerLocked(prev, options); ç»§ç»­æŸ¥çœ‹resumeTopActivityInnerLockedæ–¹æ³•çš„å®ç°ï¼š 1mStackSupervisor.startSpecificActivityLocked(next, true, true); å¯ä»¥å‘ç°åœ¨æ–¹æ³•ä½“ä¸­æ‰§è¡Œäº†ç›¸å…³é€»è¾‘åˆ¤æ–­ä¸åˆå§‹åŒ–æ“ä½œä¹‹åè°ƒç”¨äº†startSpecificActivityLockedæ–¹æ³•ï¼š 12mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0, &quot;activity&quot;, r.intent.getComponent(), false, false, true); å¯ä»¥å‘ç°åœ¨æ–¹æ³•ä½“ä¸­è°ƒç”¨äº†startProcessLockedæ–¹æ³•ï¼Œä»åå­—å¯ä»¥çœ‹å‡ºæ¥è¿™ä¸ªæ–¹æ³•å°±æ˜¯å¯åŠ¨è¿›ç¨‹çš„ã€‚ 123456789final ProcessRecord startProcessLocked(String processName, ApplicationInfo info, boolean knownToBeDead, int intentFlags, String hostingType, ComponentName hostingName, boolean allowWhileBooting, boolean isolated, boolean keepIfLarge) { return startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType, hostingName, allowWhileBooting, isolated, 0 /* isolatedUid */, keepIfLarge, null /* ABI override */, null /* entryPoint */, null /* entryPointArgs */, null /* crashHandler */); } æŸ¥çœ‹startProcessLockedæ–¹æ³•çš„å®ç°ï¼š 1234checkTime(startTime, &quot;startProcess: stepping in to startProcess&quot;); startProcessLocked( app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs); checkTime(startTime, &quot;startProcess: done starting proc!&quot;); æŸ¥çœ‹startProcessLockedæ–¹æ³•çš„å…·ä½“å®ç°ï¼› 123456checkTime(startTime, &quot;startProcess: asking zygote to start proc&quot;); Process.ProcessStartResult startResult = Process.start(entryPoint, app.processName, uid, uid, gids, debugFlags, mountExternal, app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet, app.info.dataDir, entryPointArgs); checkTime(startTime, &quot;startProcess: returned from zygote!&quot;); æŸ¥çœ‹å…³é”®ä»£ç ï¼Œè¿™é‡Œè°ƒç”¨äº†Process.startæ–¹æ³•ï¼š 123456789101112131415161718192021public static final ProcessStartResult start(final String processClass, final String niceName, int uid, int gid, int[] gids, int debugFlags, int mountExternal, int targetSdkVersion, String seInfo, String abi, String instructionSet, String appDataDir, String[] zygoteArgs) { try { return startViaZygote(processClass, niceName, uid, gid, gids, debugFlags, mountExternal, targetSdkVersion, seInfo, abi, instructionSet, appDataDir, zygoteArgs); } catch (ZygoteStartFailedEx ex) { Log.e(LOG_TAG, &quot;Starting VM process through Zygote failed&quot;); throw new RuntimeException( &quot;Starting VM process through Zygote failed&quot;, ex); } } è¿™é‡Œçš„processClasså°±æ˜¯è¦å¯åŠ¨çš„è¿›ç¨‹çš„åç§°ï¼Œè¿™é‡Œä¼ é€’çš„å°±æ˜¯ActivityThreadï¼š 1&quot;android.app.ActivityThread&quot; å…·ä½“çš„Processå¯åŠ¨è¿›ç¨‹çš„Nativeå±‚ä»£ç è¿™é‡Œä¸åšè¿‡å¤šçš„åˆ†æï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¯åŠ¨äº†AcitivtyThreadè¿›ç¨‹å¹¶æ‰§è¡Œäº†ActivityThreadçš„mainæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»å¸¸è¯´çš„è¿›ç¨‹çš„å¯åŠ¨æ–¹æ³•å°±æ˜¯ActivityThreadçš„mainæ–¹æ³•å°±æ˜¯è¿™é‡Œä½“ç°çš„ã€‚ æ€»ç»“ï¼š androidåº”ç”¨è¿›ç¨‹ä¼šåœ¨éœ€è¦å¯åŠ¨å…¶ç»„ä»¶çš„æ—¶å€™å¯åŠ¨ï¼Œå½“æ²¡æœ‰ä»»ä½•ç»„ä»¶è¿è¡Œæˆ–è€…æ˜¯ç³»ç»Ÿå†…å­˜è¾ƒä½çš„æ—¶å€™åº”ç”¨è¿›ç¨‹ä¼šè¢«æ€æ­»ã€‚ åœ¨å¯åŠ¨åº”ç”¨å››å¤§ç»„ä»¶çš„æ—¶å€™è‹¥å‘ç°å½“å‰åº”ç”¨çš„è¿›ç¨‹æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™ä¼šé¦–å…ˆå¯åŠ¨åº”ç”¨ç¨‹åºçš„è¿›ç¨‹ã€‚ æˆ‘ä»¬å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºé…ç½®å¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„JVMå’Œè¿è¡Œç¯å¢ƒï¼Œå„ä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šè®¯éœ€è¦é€šè¿‡Binderæœºåˆ¶ã€‚ Launcherå¯åŠ¨çš„è¿‡ç¨‹ä¹Ÿæ˜¯å…ˆå¯åŠ¨Launcherè¿›ç¨‹å†å¯åŠ¨å…¶Activityç»„ä»¶ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹","link":"/2020/09/11/%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"title":"çƒ­ä¿®å¤æŠ€æœ¯åŸç†æ€»ç»“","text":"#1.ä»€ä¹ˆæ˜¯çƒ­ä¿®å¤ ä¼ ç»Ÿæ›´æ–°æµç¨‹ï¼šç‰ˆæœ¬ä¸Šçº¿-&gt;ç”¨æˆ·å®‰è£…-&gt;å‘ç°bug-&gt;ç´§æ€¥ä¿®å¤-&gt;é‡æ–°å‘ç‰ˆ-&gt;ç”¨æˆ·å®‰è£… å¼Šç«¯:é‡æ–°å‘ç‰ˆæœ¬ä»£ä»·é«˜ :ç”¨æˆ·ä¸‹è½½å®‰è£…æˆæœ¬é«˜ :bugä¿®å¤ä¸åŠæ—¶ï¼Œä½“éªŒå·® è§£å†³æ–¹æ¡ˆ Hybridæ–¹æ¡ˆ:ä¸šåŠ¡é€»è¾‘ä»¥H5æ–¹å¼åŠ è½½ æ’ä»¶åŒ–æ–¹æ¡ˆ:Atlasæˆ–è€…DroidPluginæ–¹æ¡ˆ çƒ­ä¿®å¤æ–¹æ¡ˆ:é‡‡ç”¨çƒ­ä¿®å¤æŠ€æœ¯ï¼Œå°†æ›´æ–°è¡¥ä¸ä¸Šä¼ åˆ°äº‘ç«¯ï¼ŒAPPä»äº‘ç«¯ä¸‹æ‹‰è¡¥ä¸ç›´æ¥åº”ç”¨ç”Ÿæ•ˆ çƒ­ä¿®å¤æ›´æ–°æµç¨‹:ç‰ˆæœ¬ä¸Šçº¿-&gt;ç”¨æˆ·å®‰è£…-&gt;å‘ç°bug-&gt;ç´§æ€¥ä¿®å¤-&gt;æ‰“å‡ºè¡¥ä¸,æ¨é€ç»™ç”¨æˆ·-&gt;è‡ªåŠ¨æ‹‰å–è¡¥ä¸ä¿®å¤ ä¼˜åŠ¿ 1.æ— éœ€é‡æ–°å‘ç‰ˆï¼Œå®æ—¶é«˜æ•ˆçƒ­ä¿®å¤ 2.ç”¨æˆ·æ— æ„ŸçŸ¥ä¿®å¤ï¼Œæ— éœ€ä¸‹è½½æ–°åº”ç”¨,ä»£ä»·å° 3.ä¿®å¤æˆåŠŸç‡é«˜ï¼ŒæŠŠæŸå¤±é™åˆ°æœ€ä½ ##2.çƒ­ä¿®å¤æ¡†æ¶ è…¾è®¯QQæ§ä»¶çš„è¶…æŠ€è¡¥ä¸æŠ€æœ¯ï¼Œå¾®ä¿¡çš„Tinkerï¼Œé¥¿äº†ä¹ˆçš„Amigoï¼Œç¾å›¢çš„Robust éä¾µå…¥å¼Androidçƒ­ä¿®å¤æ–¹æ¡ˆSophixSophixä¸æ”¯æŒå››å¤§ç»„ä»¶çš„ä¿®å¤,å¦‚æœè¦ä¿®å¤å››å¤§ç»„ä»¶ï¼Œå¿…é¡»åœ¨AndroidManifesté‡Œé¢„å…ˆæ’å…¥ä»£ç†ç»„ä»¶ï¼Œå¹¶ä¸”å£°æ˜æ‰€æœ‰æƒé™ã€‚å¯¹appè¿è¡Œæµç¨‹çš„ä¾µå…¥æ€§å¤ªå¼ºã€‚æœªä½œå¤„ç†ã€‚ ##3.Androidçƒ­ä¿®å¤çš„ä¸‰å¤§é¢†åŸŸ:ä»£ç ä¿®å¤,èµ„æºä¿®å¤,Soä¿®å¤ã€‚ ###3.1ä»£ç ä¿®å¤ ###ä»£ç ä¿®å¤æ–¹æ¡ˆ:ä¸€ç§æ˜¯é˜¿é‡Œç³»çš„åº•å±‚æ›¿æ¢æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯è…¾è®¯ç³»çš„ç±»åŠ è½½æ–¹æ¡ˆä¼˜åŠ£: åº•å±‚æ›¿æ¢æ–¹æ¡ˆé™åˆ¶å¤šï¼Œä½†æ—¶æ•ˆæ€§å¥½ï¼ŒåŠ è½½å¿«ï¼Œç«‹å³è§æ•ˆã€‚ç±»åŠ è½½æ–¹æ¡ˆæ—¶æ•ˆæ€§å·®ï¼Œéœ€è¦é‡æ–°å†·å¯åŠ¨æ‰èƒ½è§æ•ˆï¼Œä½†ä¿®å¤èŒƒå›´å¹¿ï¼Œé™åˆ¶å°‘ã€‚ ###åº•å±‚æ›¿æ¢æ–¹æ¡ˆ åº•å±‚æ›¿æ¢æ–¹æ¡ˆæ˜¯åœ¨å·²ç»åŠ è½½äº†çš„ç±»ä¸­ç›´æ¥æ›¿æ¢æ‰åŸæœ‰æ–¹æ³•ï¼Œæ˜¯åœ¨åŸæ¥ç±»çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ã€‚å› è€Œæ— æ³•å®ç°å¯¹åŸæœ‰ç±»è¿›è¡Œæ–¹æ³•å’Œå­—æ®µçš„å¢å‡ï¼Œå› ä¸ºè¿™æ ·å°†ç ´ååŸæœ‰ç±»ç»“æ„ã€‚ä¸€æ—¦è¡¥ä¸ç±»ä¸­å‡ºç°äº†æ–¹æ³•çš„å¢åŠ æˆ–å‡å°‘ï¼Œå°±ä¼šå¯¼è‡´è¿™ä¸ªç±»ä»¥åŠæ•´ä¸ªDexçš„æ–¹æ³•æ•°çš„å˜åŒ–ã€‚æ–¹æ³•æ•°çš„å˜åŒ–ä¼´éšç€æ–¹æ³•ç´¢å¼•çš„å˜åŒ–ï¼Œè¿™æ ·åœ¨è®¿é—®æ–¹æ³•æ—¶å°±æ— æ³•æ­£å¸¸çš„ç´¢å¼•åˆ°æ­£ç¡®çš„æ–¹æ³•äº†ã€‚å¦‚æœå­—æ®µå‘ç”Ÿäº†å¢åŠ å’Œå‡å°‘ï¼Œå’Œæ–¹æ³•å˜åŒ–çš„æƒ…å†µä¸€æ ·ï¼Œæ‰€æœ‰å­—æ®µçš„ç´¢å¼•éƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚æ›´ä¸¥é‡çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœåœ¨ç¨‹åºè¿è¡Œä¸­é—´æŸå„ç±»çªç„¶å¢åŠ äº†ä¸€ä¸ªå­—æ®µï¼Œé‚£ä¹ˆå¯¹äºåŸå…ˆå·²ç»äº§ç”Ÿçš„è¿™ä¸ªç±»çš„å®ä¾‹ï¼Œä»–ä»¬è¿˜æ˜¯åŸæ¥çš„ç»“æ„ï¼Œè¿™æ˜¯æ— æ³•æ”¹å˜çš„ã€‚è€Œæ–°æ–¹æ³•ä½¿ç”¨åˆ°è¿™äº›è€çš„å®ä¾‹å¯¹è±¡æ—¶ï¼Œè®¿é—®æ–°å¢å­—æ®µå°±ä¼šäº§ç”Ÿä¸å¯é¢„æœŸçš„ç»“æœã€‚ä¼ ç»Ÿçš„åº•å±‚æ›¿æ¢æ–¹å¼ï¼Œä¸è®ºæ˜¯Dexposedã€Andfixæˆ–è€…å…¶ä»–å®‰å…¨ç•Œçš„Hookæ–¹æ¡ˆï¼Œéƒ½æ˜¯ç›´æ¥ä¾èµ–ä¿®æ”¹è™šæ‹Ÿæœºæ–¹æ³•å®ä½“çš„å…·ä½“å­—æ®µï¼Œä¾‹å¦‚ï¼Œæ”¹Dalvikæ–¹æ³•çš„jniå‡½æ•°æŒ‡é’ˆã€ä¿®æ”¹ç±»æˆ–è€…æ–¹æ³•çš„è®¿é—®æƒé™ã€‚Androidå¼€æºï¼Œå„å¤§å‚å•†å¯¹ä»£ç è¿›è¡Œæ”¹é€ ï¼ŒAndfixé‡Œçš„ArtMethodçš„ç»“æ„æ˜¯æ ¹æ®Androidæºç ä¸­çš„ç»“æ„å†™æ­»çš„ã€‚å¦‚æœArtMethodåšä¿®æ”¹ï¼Œè¿™ç§æ›¿æ¢æœºåˆ¶å°±ä¼šå‡ºé—®é¢˜ã€‚ Sophixæ˜¯ä¸€ç§æ— è§†åº•å±‚å…·ä½“ç»“æ„çš„æ›¿æ¢æ–¹å¼ï¼Œè§£å†³äº†å…¼å®¹æ€§é—®é¢˜ã€‚å¿½ç•¥äº†åº•å±‚ArtMethodç»“æ„çš„å·®å¼‚ï¼Œå¯¹äºAndroidç‰ˆæœ¬ä¸éœ€è¦åŒºåˆ†ï¼Œä»£ç é‡å¤§å¤§å‡å°‘ã€‚åªè¦ArtMethodæ•°ç»„æ˜¯ä»¥çº¿æ€§ç»“æ„æ’åˆ—ï¼Œå°±ä¸ä¼šå‡ºç°é—®é¢˜ã€‚ ###ç±»åŠ è½½æ–¹æ¡ˆç±»åŠ è½½æ–¹æ¡ˆçš„åŸç†æ˜¯åœ¨appé‡æ–°å¯åŠ¨åè®©Classloaderå»åŠ è½½æ–°çš„ç±»ã€‚å› ä¸ºappè¿è¡Œæ—¶ï¼Œæ‰€æœ‰éœ€è¦å‘ç”Ÿå˜æ›´çš„ç±»å·²ç»è¢«åŠ è½½è¿‡äº†ï¼Œåœ¨Androidä¸Šæ˜¯æ— æ³•å¯¹ä¸€ä¸ªç±»è¿›è¡Œå¸è½½ã€‚å¦‚æœä¸é‡æ–°å¯åŠ¨ï¼ŒåŸæ¥çš„ç±»è¿˜åœ¨è™šæ‹Ÿæœºä¸Šï¼Œå°±æ— æ³•åŠ è½½æ–°ç±»ã€‚åªæœ‰é‡æ–°å¯åŠ¨ï¼Œåœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‰ï¼ŒæŠ¢å…ˆåŠ è½½è¡¥ä¸ä¸­çš„æ–°ç±»ï¼Œå½“è®¿é—®è¿™ä¸ªç±»æ—¶å°±ä¼šResolveä¸ºæ–°ç±»ï¼Œè¾¾åˆ°çƒ­ä¿®å¤ç›®çš„ã€‚ ###åº•å±‚æ›¿æ¢åŸç† Andfixå³æ—¶ç”Ÿæ•ˆï¼Œå…¶åŸç†æ˜¯ï¼Œåœ¨å·²ç»åŠ è½½çš„ç±»ä¸­ç›´æ¥åœ¨nativeå±‚æ›¿æ¢æ‰åŸæœ‰æ–¹æ³•ï¼Œå®åœ¨åŸæœ‰ç±»åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ã€‚å…¶æ ¸å¿ƒåœ¨äºreplaceMethodå‡½æ•°ï¼Œè¿™æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ã€‚ å…¶å‚æ•°æ˜¯åœ¨Javaå±‚é€šè¿‡åå°„æœºåˆ¶å¾—åˆ°çš„Methodå¯¹è±¡æ‰€å¯¹åº”çš„jobjectã€‚srcå¯¹åº”çš„äº‹éœ€è¦è¢«æ›¿æ¢çš„åŸæœ‰æ–¹æ³•ã€‚destå¯¹åº”çš„å°±æ˜¯æ–°æ–¹æ³•ï¼Œæ–°æ–¹æ³•å­˜åœ¨äºè¡¥ä¸åŒ…ä¸­çš„æ–°ç±»ä¸­ï¼Œä¹Ÿå°±æ˜¯è¡¥ä¸æ–¹æ³•ã€‚ Androidçš„javaè¿è¡Œç¯å¢ƒï¼Œåœ¨4.4ä»¥ä¸‹ç”¨çš„äº‹dalvikè™šæ‹Ÿæœºï¼Œè€Œåœ¨4.4ä»¥ä¸Šç”¨çš„æ˜¯artè™šæ‹Ÿæœºã€‚ æˆ‘ä»¬ä»¥artä¸ºä¾‹ï¼Œå¯¹äºä¸åŒAndroidç‰ˆæœ¬çš„artï¼Œåº•å±‚Javaå¯¹è±¡çš„æ•°æ®ç»“æ„æ˜¯ä¸åŒçš„ï¼Œå› è€Œä¼šè¿›ä¸€æ­¥åŒºåˆ†ä¸åŒçš„æ›¿æ¢å‡½æ•°ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥Android6.0ä¸ºä¾‹ï¼Œå¯¹åº”çš„å°±æ˜¯replace_6_0. æ¯ä¸€ä¸ªJavaæ–¹æ³•åœ¨artä¸­éƒ½å¯¹åº”ç€ä¸€ä¸ªArtMethodï¼ŒArtMethodè®°å½•äº†è¿™ä¸ªJavaæ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€å±ç±»ã€è®¿é—®æƒé™ã€ä»£ç æ‰§è¡Œåœ°å€ç­‰ã€‚ é€šè¿‡env-&gt;FromReflectedMethodï¼Œå¯ä»¥ç”±Methodå¯¹è±¡å¾—åˆ°è¿™ä¸ªæ–¹æ³•å¯¹åº”çš„ArtMethodçš„çœŸæ­£èµ·å§‹åœ°å€ã€‚ç„¶åå¯ä»¥æŠŠå®ƒå¼ºè½¬æˆArtMethodæŒ‡é’ˆï¼Œä»è€Œå¯¹å…¶æ‰€æœ‰æˆå‘˜è¿›è¡Œä¿®æ”¹ã€‚è¿™æ ·å…¨éƒ¨æ›¿æ¢å®Œä¹‹åå°±å®Œæˆäº†çƒ­ä¿®å¤é€»è¾‘ï¼Œä»¥åè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶å°±ä¼šç›´æ¥èµ°åˆ°æ–°æ–¹æ³•çš„å®ç°ä¸­äº†ã€‚ ä¸ºä»€ä¹ˆè¿™æ ·æ›¿æ¢å®Œå°±å¯ä»¥å®ç°çƒ­ä¿®å¤äº†å‘¢ï¼Ÿéœ€è¦ä»è™šæ‹Ÿæœºè°ƒç”¨æ–¹æ³•çš„åŸç†è¯´èµ·ã€‚ åœ¨Artè™šæ‹Ÿæœºä¸­ArtMethodç»“æ„ä¸­ï¼ŒåŒ…å«ä¸¤ä¸ªé‡8_point_from_quick_compiled_code_äº†ï¼Œä»–ä»¬æ˜¯æ–¹æ³•çš„æ‰§è¡Œå…¥å£ã€‚Javaä»£ç åœ¨Androidä¸­ä¼šè¢«ç¼–è¯‘æˆDexCodeã€‚ä½ ä¹Ÿä¸ Artä¸­å¯ä»¥é‡‡ç”¨è§£ææ¨¡å¼æˆ–è€…AOTæœºå™¨ç æ¨¡å¼æ‰§è¡Œã€‚ è§£ææ¨¡å¼ï¼Œå°±æ˜¯å»é™¤Dex Codeï¼Œé€æ¡è§£ææ‰§è¡Œï¼Œå¦‚æœæ–¹æ³•çš„è°ƒç”¨è€…ä»¥è§£ææ¨¡å¼è¿è¡Œï¼Œåœ¨è°ƒç”¨æ–¹æ³•æ—¶ï¼Œå°±ä¼šå–å¾—è¿™ä¸ªæ–¹æ³•çš„entry_point_from_interpreter_,ç„¶åä»–äº¤è½¬è¿‡å»æ‰§è¡Œã€‚AOTçš„æ–¹å¼ï¼Œå°±ä¼šå…ˆé¢„ç¼–è¯‘å¥½Dex Code å¯¹åº”çš„æœºå™¨ç ï¼Œç„¶åæ‰§è¡ŒæœŸç›´æ¥æ‰§è¡Œæœºå™¨ç ï¼Œä¸éœ€è¦ä¸€æ¡æ¡è§£ææ‰§è¡ŒDex Codeã€‚å¦‚æœæ–¹æ³•çš„è°ƒç”¨è€…æ˜¯ä»¥AOTæœºå™¨ç æ–¹å¼æ‰§è¡Œçš„ï¼Œåœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ˜¯ï¼Œå°±æ˜¯è·³è½¬åˆ°entry_point_from_quick_compiled_codeæ‰§è¡Œã€‚å› æ­¤ï¼Œå½“æŠŠä¸€ä¸ªæ—§æ–¹æ³•çš„æ‰€æœ‰æˆå‘˜å­—æ®µéƒ½æ¢æˆæ–°æ–¹æ³•åï¼Œæ‰§è¡Œæ—¶æ‰€æœ‰æ•°æ®å°±å¯ä»¥ä¿æŒå’Œæ–°æ–¹æ³•çš„ä¸€è‡³ã€‚è¿™æ ·åœ¨æ‰€æœ‰æ‰§è¡Œåˆ°æ—§æ–¹æ³•çš„åœ°æ–¹ï¼Œå›å–å¾—æ–°æ–¹æ³•çš„æ‰§è¡Œå…¥å£ã€æ‰€å±classã€æ–¹æ³•ç´¢å¼•å·åŠæ‰€å±dexä¿¡æ¯ï¼Œç„¶åæƒ³è°ƒç”¨æ—§æ–¹æ³•ä¸€æ ·çš„æ‰§è¡Œåˆ°æ–°æ–¹æ³•çš„é€»è¾‘ã€‚ Nativeæ›¿æ¢æ–¹æ¡ˆï¼Œæ¯”å¦‚Andfixå’Œå…¶ä»–å®‰å…¨ç•Œçš„Hookæ–¹æ¡ˆï¼Œéƒ½æ˜¯å†™æ­»ArtMethodç»“æ„ä½“ï¼Œè¿™æ ·ä¼šå¸¦æ¥å…¼å®¹æ€§é—®é¢˜ã€‚Nativeå±‚æ›¿æ¢æ€è·¯ï¼Œå…¶å®å°±æ˜¯æ›¿æ¢ArtMethodçš„æ‰€æœ‰æˆå‘˜ Sophixé‡‡å–çš„æ˜¯å°†ArtMethodçš„ä½œä¸ºæ•´ä½“è¿›è¡Œæ›¿æ¢ã€‚ è®¿é—®æƒé™çš„é—®é¢˜ æ–¹æ³•è°ƒç”¨æ—¶çš„æƒé™æ£€æŸ¥ã€åŒåŒ…åä¸‹çš„æƒé™é—®é¢˜ã€åå°„è°ƒç”¨éé™æ€æ–¹æ³•é—®é¢˜ã€‚ å³æ—¶ç”Ÿæ•ˆåœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¸é€‚ç”¨ï¼Ÿ å¼•èµ·åŸæœ‰ç±»ä¸­å‘ç”Ÿç»“æ„å˜åŒ–çš„ä¿®æ”¹ ä¿®å¤äº†çš„éé™æ€æ–¹æ³•ä¼šè¢«åå°„è°ƒç”¨ å†…éƒ¨ç±»ç¼–è¯‘ å†…éƒ¨ç±»ä¼šåœ¨ç¼–è¯‘å™¨ä¼šè¢«ç¼–è¯‘ä¸ºè·Ÿå¤–éƒ¨ç±»ä¸€æ ·çš„é¡¶çº§ç±»ã€‚ å†·å¯åŠ¨ç±»åŠ è½½åŸç†å½“ç±»ç»“æ„å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¦‚æ–°å¢å‡å°‘ç±»çš„method/fieldå†çƒ­éƒ¨ç½²æ¨¡å¼ä¸‹ä¼šå—åˆ°é™åˆ¶ï¼Œä½†æ˜¯å†·éƒ¨ç½²èƒ½å¤Ÿè¾¾åˆ°ä¿®å¤ç›®çš„ã€‚ ##å†·å¯åŠ¨å®ç°æ–¹æ¡ˆ ##æ’æ¡©å®ç°çš„å‰å› åæœ å¦‚æœä»…ä»…æŠŠè¡¥ä¸ç±»æ‰“å…¥è¡¥ä¸åŒ…ä¸­è€Œä¸åšä»»ä½•å¤„ç†çš„è¯ï¼Œ åœ¨è¿è¡Œæ—¶ç±»åŠ è½½çš„æ—¶å€™ä¼šå¼‚å¸¸é€€å‡ºã€‚åŠ è½½ä¸€ä¸ªdexæ–‡ä»¶åˆ°æœ¬åœ°å†…å­˜æ—¶ï¼Œå¦‚æœä¸å­˜åœ¨odexæ–‡ä»¶ï¼Œé¦–å…ˆä¼šæ‰§è¡Œdexoptï¼Œdexopt çš„å…¥å£åœ¨davilk/opt/OptMain.cppçš„mainæ–¹æ³•ï¼Œæœ€åè°ƒç”¨åˆ°verifyAndOptimizeClassæ‰§è¡ŒçœŸæ­£çš„verify/optimizeæ“ä½œã€‚ Apkç¬¬ä¸€æ¬¡å®‰è£…çš„æ—¶å€™ï¼Œä¼šå¯¹åŸdexæ‰§è¡Œdexopt,æ­¤æ—¶å‡å¦‚apkåªå­˜åœ¨ä¸€ä¸ªdexï¼Œæ‰€ä»¥dvmVerifyClass(clazz)ç»“æœä¸ºtrue,æ‰€ä»¥apkä¸­æ‰€æœ‰çš„ç±»éƒ½ä¼šè¢«æ‰“ä¸ŠCLASS_ISPREVERIFIEDæ ‡è¯†ï¼Œæ¥ä¸‹æ¥æ‰§è¡ŒdvmOptimizeClassï¼Œç±»æ¥ç€è¢«æ‰“ä¸ŠCLASS_ISOPTIMIZEDæ ‡è¯†ã€‚ ç°åœ¨åŠ å…¥Aç±»æ˜¯è¡¥ä¸ç±»ï¼Œæ‰€ä»¥è¡¥ä¸Aç±»åœ¨å•ç‹¬çš„dexä¸­ï¼Œç±»Bä¸­çš„æŸä¸ªæ–¹æ³•å¼•ç”¨åˆ°è¡¥ä¸ç±»Aï¼Œæ‰€ä»¥æ‰§è¡Œåˆ°è¯¥æ–¹æ³•ä¼šå°è¯•è§£æç±»Aã€‚ ç±»Bç”±äºè¢«æ‰“ä¸Šäº†CLASS_ISPREVERIFIEDæ ‡å¿—ï¼Œæ¥ä¸‹æ¥referreræ˜¯ç±»Bï¼ŒresClassCheckæ˜¯è¡¥ä¸ç±»Aï¼Œä»–ä»¬å±äºä¸åŒçš„dexã€‚æ‰€ä»¥ä¼šæç¤ºdvmThrowlllegalAccessErrorã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªå•ç‹¬æ— å…³å¸®åŠ©ç±»æ”¾åˆ°ä¸€ä¸ªå•ç‹¬çš„dexä¸­ï¼ŒåŸdexä¸­æ‰€æœ‰ç±»çš„æ„é€ å‡½æ•°éƒ½å¼•ç”¨è¿™ä¸ªç±»ï¼Œä¸€èˆ¬çš„å®ç°æ–¹æ³•éƒ½æ˜¯ä¾µå…¥dexæ‰“åŒ…æµç¨‹ï¼Œåˆ©ç”¨.classå­—èŠ‚ç ä¿®æ”¹æŠ€æœ¯ï¼Œåœ¨æ‰€æœ‰.classæ–‡ä»¶çš„æ„é€ å‡½æ•°ä¸­å¼•ç”¨è¿™ä¸ªå¸®åŠ©ç±»ï¼Œæ’æ¡©ç”±æ­¤è€Œæ¥ã€‚Artä¸‹å†·å¯åŠ¨å®ç° Dalvikä¸‹å’ŒArtä¸‹å¯¹DexFile.loadDexå°è¯•æŠŠä¸€ä¸ªdexæ–‡ä»¶è§£æåŠ è½½åˆ°nativeå†…å­˜å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿå®é™…éƒ½æ˜¯è°ƒç”¨äº†DexFile.openDexFileNativeè¿™ä¸ªnativeæ–¹æ³•ã€‚Dalvikå°è¯•åŠ è½½ä¸€ä¸ªå‹ç¼©æ–‡ä»¶çš„æ—¶å€™åªä¼šå»æŠŠclasses.dexåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œå¦‚æœæ­¤æ—¶å†…å­˜æ–‡ä»¶ä¸­æœ‰å¤šä¸ªdexï¼Œé‚£ä¹ˆé™¤äº†classes.dexä¹‹å¤–çš„å…¶ä»–dexè¢«ç›´æ¥å¿½ç•¥æ‰Artè™šæ‹Ÿæœºæ–¹æ³•è°ƒç”¨é“¾DexFile-&gt;openDexFileNative-&gt;OpenDexFilesFromat-&gt;LoadDexFilesArtä¸‹é»˜è®¤æ”¯æŒåŠ è½½å‹ç¼©æ–‡ä»¶ä¸­åŒ…å«å¤šä¸ªdexï¼Œé¦–å…ˆè‚¯å®šä¼˜å…ˆåŠ è½½primary dexå…¶å®å°±æ˜¯classes.dexï¼Œåç»­ä¼šåŠ è½½å…¶ä»–çš„dexã€‚æ‰€ä»¥è¡¥ä¸ç±»åªéœ€è¦æ”¾åˆ°classes.dexå³å¯ï¼Œåç»­å‡ºç°åœ¨å…¶ä»–dexä¸­çš„â€œè¡¥ä¸ç±»â€œæ˜¯ä¸ä¼šè¢«é‡å¤åŠ è½½çš„ã€‚ Artæœ€ç»ˆå†·å¯åŠ¨è§£å†³æ–¹æ¡ˆ æŠŠè¡¥ä¸dexå‘½åä¸ºclasses.dexã€‚åŸapkä¸­çš„dexä¸€æ¬¡å‘½åä¸ºclasses(2,3,4â€¦).dexå°±å¥½äº†ï¼Œç„¶åä¸€èµ·æ‰“åŒ…ä¸ºä¸€ä¸ªå‹ç¼©æ–‡ä»¶ã€‚ç„¶åDexFile.LoadDexå¾—åˆ°DexFileå¯¹è±¡ï¼Œæœ€åæŠŠè¯¥DexFileå¯¹è±¡æ•´ä¸ªæ›¿æ¢æ—§çš„dexElementsæ•°æ®å°±å¯ä»¥äº†ã€‚ Sophix å’Œ tinker æ–¹æ¡ˆ è¡¥ä¸dexå¿…é¡»å‘½åä¸ºclasses.dex loadDexå¾—åˆ°çš„DexFileå®Œæ•´æ›¿æ¢æ‰dexElementsæ•°ç»„è€Œä¸æ˜¯æ’å…¥ DexFile.loadDexå°è¯•æŠŠä¸€ä¸ªdexæ–‡ä»¶è§£æå¹¶åŠ è½½åˆ°nativeå†…å­˜ï¼Œåœ¨åŠ è½½åˆ°nativeå†…å­˜ä¹‹å‰ï¼Œå¦‚æœdexä¸å­˜åœ¨å¯¹åº”çš„odexï¼Œé‚£ä¹ˆDalvikä¸‹å›æ‰§è¡Œdexoptï¼ŒArtä¸‹å›æ‰§è¡Œdexoatï¼Œæœ€åå¾—åˆ°çš„éƒ½æ˜¯ä¸€ä¸ªä¼˜åŒ–åçš„odexï¼Œå®é™…ä¸Šæœ€åè™šæ‹Ÿæœºæ‰§è¡Œçš„äº‹è¿™ä¸ªodexè€Œä¸æ˜¯dexã€‚dexè¶³å¤Ÿå¤§é‚£ä¹ˆdexopt/dexoatå®é™…ä¸Šæ˜¯å¾ˆå¥½ä¼¼çš„ï¼ŒDalvikä¸‹å®é™…å½±å“æ¯”è¾ƒä¸‹ï¼Œå› ä¸ºloadDexä»…ä»…æ˜¯è¡¥ä¸åŒ…ï¼ŒArtä¸‹å½±å“éå¸¸å¤§ï¼Œå› ä¸ºloadDexæ˜¯è¡¥ä¸dexå’Œapkä¸­åŸdexåˆå¹¶æˆä¸€ä¸ªå®Œæ•´è¡¥ä¸å‹ç¼©åŒ…ï¼Œæ‰€ä»¥dexoatéå¸¸è€—æ—¶ã€‚å¦‚æœä¼˜åŒ–åçš„odexæ–‡ä»¶æ²¡ç”Ÿæˆæˆ–è€…æ²¡ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„odexæ–‡ä»¶ï¼Œé‚£ä¹ˆloadDexä¾¿ä¸èƒ½åœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™è¿›è¡Œçš„ï¼Œå› ä¸ºä¼šé˜»å¡loadDexçº¿ç¨‹ï¼Œä¸€èˆ¬æ˜¯ä¸»çº¿ç¨‹ã€‚æ‰€ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒSophixæŠŠloadDexå½“åšä¸€ä¸ªäº‹åŠ¡æ¥çœ‹ï¼Œå¦‚æœä¸­é€”è¢«æ‰“æ–­ï¼Œé‚£ä¹ˆå°±åˆ é™¤odexæ–‡ä»¶ï¼Œé‡å¯çš„æ—¶å€™å¦‚æœå‘ç°å­˜åœ¨odexæ–‡ä»¶ï¼ŒloadDexå®Œä¹‹åï¼Œåå°„æ³¨å…¥/æ›¿æ¢dexElementsæ•°ç»„ï¼Œå®ç°patchã€‚å¦‚æœä¸å­˜åœ¨odexæ–‡ä»¶ï¼Œé‚£ä¹ˆé‡å¯å¦ä¸€å­è¿›ç¨‹loadDexï¼Œé‡å¯ä¹‹ååœ¨ç”Ÿæ•ˆã€‚ å…·ä½“å®æ–½æ–¹æ¡ˆå¯¹Dalvikå’ŒArtä¸‹ Dalvikä¸‹é‡‡ç”¨è‡ªè¡Œç ”å‘çš„å…¨é‡Dexæ–¹æ¡ˆ Artä¸‹æœ¬è´¨ä¸Šè™šæ‹Ÿæœºå·²ç»æ”¯æŒå¤šdexçš„åŠ è½½ï¼Œæˆ‘ä»¬åªéœ€æŠŠè¡¥ä¸dexä½œä¸ºä¸»dex(classes.dex)åŠ è½½è€Œå·² å†·å¯åŠ¨æ–¹æ¡ˆé™åˆ¶ï¼Ÿå½“æ–°å¢ä¸€ä¸ªpubllic/protected/defaultæ–¹æ³•ï¼Œä¼šå‡ºç°æ–¹æ³•è°ƒç”¨é”™ä¹±ã€‚ Googleçš„dexmergeæ–¹æ¡ˆ æŠŠè¡¥ä¸dexå’ŒåŸdexåˆå¹¶ä¸€ä¸ªå®Œæ•´çš„dexã€‚ Dalvikä¸‹å®Œæ•´DEXæ–¹æ¡ˆçš„æ–°æ¢ç´¢ å†·å¯åŠ¨ç±»åŠ è½½ä¿®å¤ å¯¹äºAndroidä¸‹çš„å†·å¯åŠ¨ç±»åŠ è½½ä¿®å¤ï¼Œæœ€æ—©çš„å®ç°æ–¹æ¡ˆæ˜¯QQç©ºé—´æå‡ºçš„dexæ’å…¥æ–¹æ¡ˆã€‚ä¸»è¦æ€æƒ³æ˜¯ï¼ŒæŠŠæ’å…¥æ–°dexæ’å…¥åˆ°ClassLoaderç´¢å¼•è·¯å¾„çš„æœ€å‰é¢ï¼Œè¿™æ ·åœ¨loadä¸€ä¸ªclassæ—¶ï¼Œä¼˜å…ˆæ‰¾åˆ°è¡¥ä¸ä¸­çš„ã€‚è¿™ç±»æ’å…¥dex çš„æ–¹æ¡ˆï¼Œä¼šé‡åˆ°ä¸€ä¸ªä¸»è¦çš„é—®é¢˜ï¼Œå°±æ˜¯å¦‚ä½•è§£å†³Dalvikè™šæ‹Ÿæœºä¸‹ç±»çš„pre-verifyé—®é¢˜ã€‚ å¦‚æœä¸€ä¸ªç±» ä¸­ç›´æ¥å¼•ç”¨åˆ°çš„æ‰€æœ‰éç³»ç»Ÿç±»éƒ½å’Œè¯¥ç±»åœ¨åŒä¸€ä¸ªdexé‡Œçš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±ä¼šè¢«æ‰“ä¸ŠCLASS_ISPREVERIFIED,å…·ä½“åˆ¤å®šä»£ç å¯è§è™šæ‹Ÿæœºä¸­çš„verifyAndOptimizeClasså‡½æ•°ã€‚ è…¾è®¯çš„ä¸‰å¤§çƒ­ä¿®å¤æ–¹æ¡ˆæ˜¯å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼š QQæ§ä»¶çš„å¤„ç†æ–¹å¼ï¼Œæ˜¯åœ¨æ¯ä¸ªç±»ä¸­æ’å…¥ä¸€ä¸ªæ¥è‡ªå…¶ä»–dexçš„hack.class,ç”±æ­¤è®©æ‰€æœ‰ç±»é‡Œé¢éƒ½æ— æ³•æ»¡è¶³pre-verifiedæ¡ä»¶ã€‚ Tinkerçš„æ–¹å¼ï¼Œæ˜¯åˆæˆå…¨é‡çš„dexæ–‡ä»¶ï¼Œè¿™æ ·æ‰€æœ‰classçš„éƒ½åœ¨å…¨é‡dexä¸­è§£å†³ï¼Œä»è€Œæ¶ˆé™¤classé‡å¤è€Œå¸¦æ¥çš„å†²çªã€‚ Qfixçš„æ–¹å¼ï¼Œæ˜¯å–å¾—è™šæ‹Ÿæœºä¸­çš„æŸäº›åº•å±‚å‡½æ•°ï¼Œæå‰resolveæ‰€æœ‰è¡¥ä¸ç±»ï¼Œä»¥æ­¤ç»•è¿‡Pre-verifyæ£€æŸ¥ã€‚Sophixçš„æ–¹å¼ï¼Œè¡¥ä¸ä¸­å·²åŒ…å«å˜åŠ¨çš„ç±»ï¼Œä¸»è¦åœ¨åŸå…ˆåŸºçº¿åŒ…ä¸­dexé‡Œè¾¹ï¼Œå»æ‰è¡¥ä¸ä¸­å·²æœ‰çš„classã€‚è¿™æ ·ï¼Œè¡¥ä¸+å»é™¤äº†è¡¥ä¸ç±»çš„åŸºçº¿åŒ…=appä¸­æ‰€æœ‰ç±»ã€‚å‚è€ƒAndroidåŸç”Ÿmulti-dexçš„å®ç°ï¼Œæ˜¯æŠŠä¸€ä¸ªapkæ‰€ç”¨åˆ°çš„æ‰€æœ‰ç±»æ‹†åˆ†åˆ°classes.dexã€classes2.dexã€classes.dexâ€¦ä¹‹ä¸­ï¼Œè€Œæ¯ä¸ªdexéƒ½åªåŒ…å«äº†éƒ¨åˆ†çš„ç±»çš„å®šä¹‰ï¼Œä½†å•ä¸ªdexä¹Ÿæ˜¯å¯ä»¥åŠ è½½çš„ï¼Œå› ä¸ºåªè¦æŠŠæ‰€æœ‰dexéƒ½loadè¿›å»ï¼Œæœ¬dexä¸­ä¸å­˜åœ¨çš„ç±»å°±å¯ä»¥åœ¨è¿è¡ŒæœŸé—´åœ¨å…¶ä»–dexä¸­æ‰¾åˆ°ã€‚ #èµ„æºçƒ­ä¿®å¤æŠ€æœ¯ ##3.2èµ„æºä¿®å¤InstantRunèµ„æºçƒ­ä¿®å¤åŸç†ï¼š æ„é€ ä¸€ä¸ªæ–°çš„AssetManagerï¼Œå¹¶é€šè¿‡åå°„è°ƒç”¨addAssetPathï¼ŒæŠŠè¿™ä¸ªå®Œæ•´çš„æ–°èµ„æºåŒ…åŠ å…¥åˆ°AssetMangerä¸­ï¼Œè¿™æ ·å°±å¾—åˆ°ä¸€ä¸ªå«æœ‰æ‰€æœ‰æ–°èµ„æºçš„AssetManagerã€‚ æ‰¾åˆ°æ‰€æœ‰ä¹‹å‰å¼•ç”¨åˆ°æ„¿ä½ æœ‰Assetmanagerçš„åœ°æ–¹ï¼Œé€šè¿‡åå°„ï¼ŒæŠŠå¼•ç”¨å¤„æ›¿æ¢æˆæ–°çš„AssetManagerã€‚Sophix èµ„æºçƒ­ä¿®å¤åŸç†:æ„é€ ä¸€ä¸ªpackage id ä¸º0x66çš„èµ„æºåŒ…ï¼Œå…¶ä¸­åŒ…å«æ”¹å˜äº†çš„èµ„æºé¡¹ï¼Œç„¶åç›´æ¥åœ¨åŸæœ‰çš„AssetManagerä¸­addAssetPathè¿™ä¸ªåŒ…å°±å¯ä»¥äº†ã€‚ç”±äºè¡¥ä¸åŒ…çš„package id ä¸º0x66,ä¸ä¸ç›®å‰å·²ç»åŠ è½½çš„0x7få†²çªï¼Œå› æ­¤ç›´æ¥åŠ å…¥åˆ°å·²æœ‰çš„AssetManangerä¸­å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚æ›¿æ¢æ–¹å¼æ›´åŠ ä¼˜é›…ï¼Œç›´æ¥åœ¨åŸæœ‰çš„AssetManageerå¯¹è±¡ä¸Šè¿›è¡Œææ„å’Œé‡æ„ï¼ŒåŸå…ˆAssetManagerå¯¹è±¡çš„å¼•ç”¨æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œä¸ç”¨åƒInstantRunè¿›è¡Œç¹çä¿®æ”¹ã€‚ ###èµ„æºæ›¿æ¢æ–¹æ¡ˆä¼˜åŠ¿ ä¸ä¿®æ”¹AssetManagerçš„å¼•ç”¨å¤„ï¼Œæ›¿æ¢æ›´å¿«æ›´å®‰å…¨ã€‚ ä¸å¿…ä¸‹å‘å®Œæ•´åŒ…ï¼Œè¡¥ä¸åŒ…ä¸­åªåŒ…å«æœ‰å˜åŠ¨çš„èµ„æº ä¸è¦åœ¨è¿è¡Œæ—¶åˆæˆå®Œæ•´åŒ…ã€‚ä¸å ç”¨è¿è¡Œæ—¶è®¡ç®—å’Œå†…å­˜èµ„æºã€‚ ä¸€ä¸ªAndroidè¿›ç¨‹åªåŒ…å«ä¸€ä¸ªResTable,ResTableçš„æˆå‘˜å˜é‡mPackageGroupså°±æ˜¯æ‰€æœ‰è§£æè¿‡çš„èµ„æºåŒ…çš„é›†åˆã€‚ä»»ä½• ä¸€ä¸ªèµ„æºåŒ…ä¸­éƒ½å«æœ‰resources.arsc,ä»–è®°å½•äº†æ‰€æœ‰èµ„æºçš„idåˆ†é…æƒ…å†µä»¥åŠèµ„æºä¸­çš„æ‰€æœ‰å­—ç¬¦ä¸²ã€‚è¿™äº›ä¿¡æ¯æ˜¯ä»¥äºŒè¿›åˆ¶æ–¹å¼å­˜å‚¨çš„ã€‚åº•å±‚çš„AssetManageråšçš„äº‹å°±æ˜¯è§£æè¿™ä¸ªæ–‡ä»¶ï¼Œç„¶åæŠŠç›¸å…³ä¿¡æ¯å­˜å‚¨åˆ°mPackageGroupsé‡Œé¢ã€‚ èµ„æºä¿¡æ¯ä¸»è¦æ˜¯æŒ‡æ¯éš”èµ„æºçš„åç§°ä»¥åŠä»–å¯¹åº”çš„ç¼–å·ã€‚æ¯éš”èµ„æºï¼Œéƒ½æœ‰å”¯ä¸€ç¼–å·ã€‚ ç¼–å·æ˜¯ä¸€ä¸ª32ä½æ•°å­—ï¼Œç”¨åå…­è¿›åˆ¶æ¥æ ‡è¯†å°±æ˜¯0xPPTTEEEEã€‚PPä¸ºpackage idï¼ŒTTä¸ºtype idï¼ŒEEEEä¸ºentry idã€‚ è¿è¡Œæ—¶èµ„æºçš„è§£æ é»˜è®¤ç”±Android SDKç¼–å‡ºæ¥çš„apkï¼Œæ˜¯ç”±aaptå·¥å…·è¿›è¡Œæ‰“åŒ…çš„ï¼Œå…¶èµ„æºåŒ…çš„package id æ˜¯ 0x7fã€‚ç³»ç»Ÿçš„èµ„æºåŒ…ï¼Œä¹Ÿå°±æ˜¯framework-res.jarï¼Œpackage id ä¸º0x01ã€‚åœ¨èµ°åˆ°app çš„ç¬¬ä¸€è¡Œä»£ç ä¹‹å‰ï¼Œç³»ç»Ÿå°±å·²ç»å¸®æˆ‘ä»¬æ„é€ å¥½ä¸€ä¸ªå·²ç»æ·»åŠ äº†å®‰è£…åŒ…èµ„æºçš„AssetManageräº†ã€‚ å› æ­¤ï¼Œè¿™ä¸ªAssetManageré‡Œå°±å·²ç»åŒ…å«äº†ç³»ç»Ÿèµ„æºåŒ…ä»¥åŠappçš„å®‰è£…åŒ…ï¼Œå°±æ˜¯package id ä¸º0x01çš„framework-res.jarä¸­çš„èµ„æºå’Œpackage idä¸º0x7fçš„appå®‰è£…åŒ…èµ„æºã€‚ å¦‚æœæ­¤æ—¶ç›´æ¥åœ¨addAssetPathå…¶å®è¡¥ä¸åŒ…é‡Œçš„èµ„æºæ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚å› ä¸ºåœ¨getResTableå·²ç»æ‰§è¡Œå¾ˆå¤šæ¬¡äº†ã€‚ä¸ä¼šå‘ç”ŸçœŸæ­£çš„è§£æã€‚ ###Sophixèµ„æºè§£å†³æ–¹æ¡ˆ æ„é€ ä¸€ä¸ªpackage id ä¸º0x66çš„èµ„æºåŒ…ï¼ŒåŒ…å«äº†æ”¹å˜çš„èµ„æºé¡¹ï¼Œç„¶åç›´æ¥åœ¨åŸæœ‰AssetManagerä¸­addAssetPathè¿™ä¸ªåŒ…ã€‚ä¸ä¸å·²ç»åŠ è½½çš„0x7få†²çªã€‚ è€Œèµ„æºçš„æ”¹å˜åŒ…å«å¢åŠ ã€å‡å°‘ã€ä¿®æ”¹è¿™ä¸‰ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ å¯¹äºæ–°å¢èµ„æºï¼Œç›´æ¥åŠ å…¥è¡¥ä¸åŒ…ï¼Œç„¶åæ–°ä»£ç é‡Œç›´æ¥å¼•ç”¨å°±å¯ä»¥äº† å¯¹äºå‡å°‘èµ„æºï¼Œæˆ‘ä»¬åªè¦ä¸ä½¿ç”¨ä»–å°±è¡Œäº†ï¼Œå› æ­¤ä¸ç”¨è€ƒè™‘è¿™ç§æƒ…å†µï¼Œä»–ä¹Ÿä¸å½±å“è¡¥ä¸åŒ… å¯¹äºä¿®æ”¹èµ„æºï¼Œæ¯”å¦‚æ›¿æ¢äº†ä¸€å¼ å›¾ç‰‡ä¹‹ç±»çš„æƒ…å†µã€‚æˆ‘ä»¬æŠŠå®ƒè§†ä¸ºæ–°å¢èµ„æºï¼Œåœ¨æ‰“è¡¥ä¸çš„æ—¶å€™ï¼Œä»£ç åœ¨å¼•ç”¨å¤„ä¹Ÿä¼šåšå“åº”ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥æŠŠåŸæ¥ä½¿ç”¨å°±èµ„æºidçš„åœ°æ–¹å˜æˆæ–°idã€‚#3.3 Soåº“ä¿®å¤Soåº“ä¿®å¤æœ¬è´¨ä¸Šæ˜¯å¯¹nativeæ–¹æ³•çš„ä¿®å¤å’Œæ›¿æ¢ã€‚Sophixé‡‡ç”¨çš„æ˜¯ç±»ä¼¼ç±»ä¿®å¤åå°„æ³¨å…¥æ–¹å¼ã€‚æŠŠè¡¥ä¸soåº“çš„è·¯å¾„æ’å…¥åˆ°nativeLibraryDirectoriesæ•°ç»„çš„æœ€å‰é¢ï¼Œè¾¾åˆ°åŠ è½½soåº“æ—¶æ—¶è¡¥ä¸soåº“ï¼Œè€Œä¸æ˜¯åŸæ¥soåº“çš„ç›®å½•ï¼Œä»è€Œè¾¾åˆ°ä¿®å¤çš„ç›®çš„ã€‚é‡‡ç”¨è¿™ç§æ–¹æ¡ˆï¼Œå®Œå…¨ç”±Sophixåœ¨å¯åŠ¨æœŸé—´åå°„æ³¨å…¥patchä¸­çš„soåº“ã€‚å…¶ä»–æ–¹æ¡ˆæ˜¯æ‰‹åŠ¨æ›¿æ¢ç³»ç»Ÿçš„System.loadæ¥å®ç°æ›¿æ¢ç›®çš„ã€‚Java Apiæä¾›ä¸€ä¸‹ä¸¤ä¸ªæ¥å£åŠ è½½ä¸€ä¸ªsoåº“ System.loadLibrary(String libName);ä¼ è¿›å»çš„å‚æ•° soåº“åç§°ï¼Œè¡¨ç¤ºçš„soåº“æ–‡ä»¶ï¼Œä½äºapkå‹ç¼©æ–‡ä»¶ä¸­çš„libsç›®å½•ï¼Œæœ€åå¤åˆ¶åˆ°apkå®‰è£…ç›®å½•ä¸‹ã€‚ System.load(String pathName)ä¼ è¿›å»çš„å‚æ•° soåº“åœ¨ç£ç›˜ä¸­çš„å®Œæ•´è·¯å¾„ã€‚åŠ è½½ä¸€ä¸ªè‡ªå®šä¹‰å¤–éƒ¨soåº“æ–‡ä»¶ã€‚ä¸¤ç§æ–¹å¼åŠ è½½ä¸€ä¸ªsoåº“ï¼Œå®é™…ä¸Šæœ€åéƒ½è°ƒç”¨nativeLoadè¿™ä¸ªnativeæ–¹æ³•å»åŠ è½½soåº“ï¼Œè¿™ä¸ªæ–¹æ³•çš„å‚æ•°fileName soåº“åœ¨ç£ç›˜ä¸­çš„å®Œæ•´è·¯å¾„åã€‚ JNIç¼–ç¨‹ä¸­ï¼ŒåŠ¨æ€æ³¨å†Œçš„natvieæ–¹æ³•å¿…é¡»å®ç°JNI_ONLoadæ–¹æ³•ï¼ŒåŒæ—¶å®ç°ä¸€ä¸ªJNINativeMethod[]æ•°ç»„ ï¼Œé™æ€æ³¨å†Œçš„nativeæ–¹æ³•å¿…é¡»æ˜¯Java+ç±»å®Œæ•´è·¯å¾„+æ–¹æ³•åçš„æ ¼å¼ã€‚ ##3.1. SOåº“å†·éƒ¨ç½²é‡å¯ç”Ÿæ•ˆå®ç°æ–¹æ¡ˆ SOåº“ä¿®å¤æ–¹æ¡ˆ æ¥å£è°ƒç”¨æ›¿æ¢æ–¹æ¡ˆï¼Œéœ€è¦å¼ºåˆ¶ä¾µå…¥ç”¨æˆ·æ¥å£è°ƒç”¨ åå°„æ³¨å…¥æ–¹æ¡ˆï¼Œé‡å¯ç”Ÿæ•ˆ æ€»ç»“ï¼š åŠ¨æ€æ³¨å†Œçš„nativeæ–¹æ³•æ˜ å°„é€šè¿‡åŠ è½½soåº“è¿‡ç¨‹ä¸­è°ƒç”¨JNI_OnLoadæ–¹æ³•è°ƒç”¨å®Œæˆ é™æ€æ³¨å†Œçš„nativeæ–¹æ³•æ˜ å°„æ˜¯åœ¨è¯¥nativeæ–¹æ³•ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™æ‰å®Œæˆæ˜ å°„ï¼Œå½“ç„¶å‰ææ˜¯è¯¥soåº“å·²ç»loadè¿‡ã€‚ ##3.2 SOåº“çƒ­éƒ¨ç½²å®æ—¶ç”Ÿæ•ˆåˆ†æ ###3.2.1åŠ¨æ€æ³¨å†Œnativeæ–¹æ³•å®æ—¶ç”Ÿæ•ˆåŠ¨æ€æ³¨å†Œçš„nativeæ–¹æ³•è°ƒç”¨ä¸€æ¬¡JNI_OnLoadæ–¹æ³•éƒ½ä¼šé‡æ–°å®Œæˆä¸€æ¬¡æ˜ å°„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯å¦åªè¦å…ˆåŠ è½½åŸæ¥çš„soåº“ï¼Œç„¶ååœ¨åŠ è½½è¡¥ä¸soåº“ï¼Œå°±å®ŒæˆJavaå±‚nativeæ–¹æ³•åˆ°nativeå±‚patchåçš„æ–°æ–¹æ³•æ˜ å°„ï¼Œè¿™æ ·å°±å®ŒæˆåŠ¨æ€æ³¨å†Œnativeæ–¹æ³•çš„patchå®æ—¶ä¿®å¤ã€‚ å®æµ‹å‘ç°artä¸‹è¿™æ ·æ˜¯å¯ä»¥å®æ—¶ç”Ÿæ•ˆï¼Œä½†Dalvikä¸‹åšä¸åˆ°è¯•è¯•ç”Ÿæ•ˆã€‚åŸå› Dalvikç¬¬äºŒæ¬¡loadè¡¥ä¸soåº“ï¼Œæ‰§è¡Œçš„ä»ç„¶æ˜¯åŸæ¥çš„soåº“çš„JNI_OnLoadæ–¹æ³•ï¼Œè€Œä¸æ˜¯è¡¥ä¸soåº“çš„JNI_OnLoadæ–¹æ³•ã€‚Dalvikè™šæ‹Ÿæœºä¸‹dlopenæ–¹æ³•å®ç°ï¼Œåº•å±‚æ–¹æ³•ä¼šæ ¡éªŒsoåº“æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œæ–¹æ³•çš„åˆ¤æ–­ä¾æ®æ˜¯åˆ¤æ–­name,å¦‚æœåŠ è½½è¿‡ç›´æ¥è¿”å›è¯¥soåº“çš„å¥æŸ„ã€‚å¦‚æœsoåº“ä»æœªåŠ è½½è¿‡ï¼Œåˆ™load_libraryæ‰§è¡ŒåŠ è½½ã€‚æ‰€ä»¥Dalvikä¸‹é¢åŠ è½½ä¿®å¤åçš„è¡¥ä¸soæ‹¿åˆ°çš„è¿˜æ˜¯åŸsoåº“æ–‡ä»¶çš„å¥æŸ„ï¼Œæ‰€ä»¥æ‰§è¡Œçš„ä»ç„¶æ˜¯åŸsoåº“çš„JNI_OnLoadæ–¹æ³•ï¼ŒArtä¸‹ä¸å­˜åœ¨é—®é¢˜ï¼Œå› Artä¸‹è¯¥æ–¹æ³•ä»¥nameä½œä¸ºkeyå»æŸ¥æ‰¾ä¸æ˜¯bname,æ‰€ä»¥artä¸‹é‡æ–°loadä¸€éè¡¥ä¸soåº“ï¼Œæ‹¿åˆ°çš„æ˜¯è¡¥ä¸soåº“çš„å¥æŸ„ï¼Œç„¶åæ‰§è¡Œè¡¥ä¸soåº“çš„JNI_OnLoadã€‚è§£å†³Dalvikä¸‹è¯¥é—®é¢˜ï¼Œå¯å¯¹è¡¥ä¸soåº“è¿›è¡Œæ”¹åã€‚ ###3.2.2é™æ€æ³¨å†Œnativeæ–¹æ³•å®æ—¶ç”Ÿæ•ˆé™æ€æ³¨å†Œnativeæ–¹æ³•çš„æ˜ å°„å®åœ¨nativeæ–¹æ³•ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™å®Œæˆæ˜ å°„ï¼Œå¦‚æœnativeæ–¹æ³•åœ¨åŠ è½½è¡¥ä¸soåº“ä¹‹å‰å·²ç»æ‰§è¡Œè¿‡ï¼Œæ˜¯å¦è¿™ä¸ªé™æ€æ³¨å†Œnativeæ–¹æ³•ä¸€å®šå¾—ä¸åˆ°ä¿®å¤ï¼Ÿå¹¸è¿çš„æ˜¯ï¼Œç³»ç»ŸJNI APIæä¾›äº†è§£æ³¨å†Œçš„æ¥å£ UnregisterNativesï¼ˆJNIEnv* env,jclass jclazzï¼‰å‡½æ•°å›å§jclazzæ‰€åœ¨ç±»çš„æ‰€æœ‰nativeæ–¹æ³•éƒ½é‡æ–°æŒ‡å‘ä¸ºdvmResolveNativeMethodï¼Œæ‰€ä»¥è°ƒç”¨unregisterNativesä¹‹åä¸ç®¡æ˜¯é™æ€æ³¨å†Œè¿˜æ˜¯åŠ¨æ€æ³¨å†Œçš„nativeæ–¹æ³•ä¹‹å‰æ˜¯å¦æ‰§è¡Œè¿‡åœ¨åŠ è½½è¡¥ä¸so çš„æ—¶å€™éƒ½ä¼šé‡æ–°å»åšæ˜ å°„ã€‚æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦ä»¥ä¸‹è°ƒç”¨ã€‚ ##3.3 SOåº“å†·éƒ¨ç½²é‡å¯ç”Ÿæ•ˆå®ç°æ–¹æ¡ˆ ###3.3.1.æ¥å£è°ƒç”¨æ›¿æ¢æ–¹æ¡ˆSdkæä¾›æ¥å£æ›¿æ¢Systemé»˜è®¤åŠ è½½soåº“æ¥å£ SOPatchManagerã€‚loadLibraryæ¥å£åŠ è½½soåº“çš„æ—¶å€™æœ‰é™å°è¯•å»åŠ è½½sdkæŒ‡å®šç›®å½•ä¸‹çš„è¡¥ä¸soï¼ŒåŠ è½½ç­–ç•¥å¦‚ä¸‹ï¼š å¦‚æœå­˜åœ¨åˆ™åŠ è½½è¡¥ä¸soåº“è€Œä¸ä¼šå»åŠ è½½å®‰è£…apkå®‰è£…ç›®å½•ä¸‹çš„soåº“ã€‚ å¦‚æœä¸å­˜åœ¨è¡¥ä¸soï¼Œé‚£ä¹ˆè°ƒç”¨System.loadLibraryå»åŠ è½½å®‰è£…apkç›®å½•ä¸‹çš„soåº“ã€‚ æ–¹æ¡ˆä¼˜ç¼ºç‚¹ï¼šä¼˜ç‚¹ï¼šä¸éœ€è¦å¯¹ä¸åŒsdkç‰ˆæœ¬è¿›è¡Œå…¼å®¹ï¼Œå› ä¸ºæ‰€æœ‰çš„SDKç‰ˆæœ¬éƒ½æœ‰System.loadLibraryè¿™ä¸ªæ¥å£ã€‚ç¼ºç‚¹ï¼šè°ƒç”¨æ–¹éœ€è¦æ›¿æ¢æ‰Systemé»˜è®¤åŠ è½½soåº“æ¥å£ä¸ºsdkæä¾›çš„æ¥å£ï¼Œå¦‚æœæ˜¯å·²ç»ç¼–è¯‘æ··æ·†å¥½çš„ä¸‰æ–¹åº“çš„soåº“éœ€è¦patchï¼Œé‚£ä¹ˆæ˜¯å¾ˆéš¾åšåˆ°æ¥å£çš„æ›¿æ¢ã€‚ ###3.3.2åå°„æ³¨å…¥æ–¹æ¡ˆSystem.loadLibrary(â€œnative-libâ€)ï¼ŒåŠ è½½soåº“çš„åŸç†ï¼Œå…¶å®native-libè¿™ä¸ª soåº“æœ€ç»ˆä¼ ç»™nativeæ–¹æ³•æ‰§è¡Œçš„å‚æ•°æ˜¯soåº“åœ¨ç£ç›˜ä¸­çš„å®Œæ•´è·¯å¾„ï¼Œæ¯”å¦‚/data/app-lib/com.taobao.jni-2/libnative-lib.so,soåº“ä¼šåœ¨DexPathList.nativeLibraryDirectories/nativeLibraryPathElementså˜é‡æ‰€è¡¨ç¤ºçš„ç›®å½•ä¸‹å»éå†æœç´¢ã€‚ å¯ä»¥å‘ç°ä¼šéå†nativeLibraryDirectoriesæ•°ç»„ï¼Œå¦‚æœæ‰¾åˆ°äº†IoUtils.canOpenReadOnly(path)è¿”å›trueï¼Œé‚£ä¹ˆå°±ç›´æ¥è¿”å›è¯¥pathï¼ŒIoUtilsã€‚canOpenReadOnly(path)è¿”å›trueçš„å‰æè‚¯å®šæ˜¯éœ€è¦pathæ ‡è¯†çš„soæ–‡ä»¶å­˜åœ¨çš„ã€‚æˆ‘ä»¬å¯ä»¥é‡‡å–ç±»ä¼¼ç±»ä¿®å¤åå°„æ³¨å…¥æ–¹å¼ï¼Œåªè¦æŠŠæˆ‘ä»¬çš„è¡¥ä¸soåº“çš„è·¯å¾„æ’å…¥åˆ°nativeLibraryDirectoriesæ•°ç»„çš„æœ€å‰é¢å°±èƒ½å¤Ÿè¾¾åˆ°åŠ è½½soåº“çš„æ—¶å€™æ˜¯è¡¥ä¸soåº“è€Œä¸æ˜¯åŸæ¥soåº“çš„ç›®å½•ï¼Œä»è€Œè¾¾åˆ°ä¿®å¤çš„ç›®çš„ã€‚ Sdk23ä»¥ä¸ŠfindLibrary å®ç°å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œåªéœ€æŠŠè¡¥ä¸soåº“çš„å®Œæ•´è·¯å¾„è¿å‚æ•°æ„å»ºä¸€ä¸ªElementå¯¹è±¡ï¼Œç„¶åå†æ’å…¥nativeLibraryPathElementsæ•°ç»„çš„æœ€å‰é¢å°±å¥½äº†ã€‚ ä¼˜ç‚¹ï¼šå¯ä»¥ä¿®å¤ä¸‰æ–¹åº“çš„soåº“ã€‚åŒäº‹æ¥å…¥æ–¹ä¸éœ€è¦æƒ³æ–¹æ¡ˆ1ä¸€æ ·å¼ºåˆ¶ä¾µå…¥ç”¨æˆ·æ¥å£è°ƒç”¨ã€‚ç¼ºç‚¹ï¼šéœ€è¦ä¸æ–­çš„å¯¹sdkè¿›è¡Œé€‚é…ï¼Œå¦‚ä¸Šsdk23ä¸ºåˆ†ç•Œçº¿ï¼ŒfindLibraryæ¥å£å®ç°å·²å‘ç”Ÿå˜åŒ–ã€‚ä¸ç®¡æ˜¯è¡¥ä¸åŒ…è¿˜æ˜¯apkä¸­ä¸€ä¸ªsoåº“å­˜åœ¨å¤šç§cpuæ¶æ„çš„soæ–‡ä»¶ï¼Œæ¯”å¦‚armeabiï¼Œarm64-v8a,x86ç­‰ã€‚åŠ è½½å¯å®šæ˜¯åŠ è½½å…¶ä¸­ä¸€ä¸ªsoåº“æ–‡ä»¶çš„ï¼Œå¦‚ä½•é€‰æ‹©æœºå‹å¯¹åº”çš„soåº“æ–‡ä»¶å°†æ˜¯é‡ç‚¹æ‰€åœ¨ã€‚ è™šæ‹Ÿæœºç©¶ç«Ÿå¦‚ä½•é€‰æ‹©å“ªä¸ªabisç›®å½•ä½œä¸ºå‚æ•°æ„å»ºPathClassLoaderå¯¹è±¡ï¼ŒåŸç†å¦‚å›¾ å®é™…ä¸Šè¡¥ä¸soä¹Ÿå­˜åœ¨ç±»ä¼¼çš„é—®é¢˜ï¼Œæˆ‘ä»¬çš„è¡¥ä¸soåº“æ–‡ä»¶æ”¾åˆ°è¡¥ä¸åŒ…çš„libsç›®å½•ä¸‹ï¼Œlibsç›®å½•å’Œ.dexæ–‡ä»¶resèµ„æºæ–‡ä»¶ä¸€èµ·æ‰“åŒ…æˆä¸€ä¸ªå‹ç¼©æ–‡ä»¶ä½œä¸ºæœ€åçš„è¡¥ä¸åŒ…ï¼Œlibsç›®å½•å¯èƒ½ä¹ŸåŒ…å«å¤šç§abisç›®å½•ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦é€‰æ‹©æ‰‹æœºæœ€åˆé€‚çš„primaryCpuAbiï¼Œç„¶åä»libsç›®å½•ä¸‹é€‰æ‹©è¿™ä¸ªprimaryCpuAbiå­ç›®å½•æ’å…¥åˆ°nativeLibraryDirectories/nativeLibraryPathElementsæ•°ç»„ã€‚æ‰€ä»¥æ€ä¹ˆé€‰æ‹©primaryCpuAbiæ˜¯å…³é”®ï¼Œå…·ä½“å®ç°å¦‚å›¾ï¼š 1.sdk&gt;=21æ—¶ï¼Œç›´æ¥åå°„æ‹¿åˆ°ApplicationInfoå¯¹è±¡çš„primaryCpuAbiå³å¯2.sdk&lt;21æ—¶ï¼Œæœ‰é›¨æ­¤æ—¶ä¸æ”¯æŒ64ä½ï¼Œæ‰€ä»¥ç›´æ¥å§Build.CPU_ABI,Build.CPU_ABI2ä½œä¸ºprimaryCpuAbiå³å¯ã€‚","link":"/2019/10/11/%E7%83%AD%E4%BF%AE%E5%A4%8D%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86%E6%80%BB%E7%BB%93/"},{"title":"23 Androidå¼‚å¸¸å¤„ç†æµç¨‹ Android é¡¹ç›®æ„å»ºæµç¨‹","text":"å‰é¢çš„å‡ ç¯‡æ–‡ç« éƒ½æ˜¯è®²è§£çš„androidä¸­çš„çª—å£æ˜¾ç¤ºæœºåˆ¶ï¼ŒåŒ…æ‹¬Activityçª—å£åŠ è½½ç»˜åˆ¶æµç¨‹ï¼ŒDialogçª—å£åŠ è½½ç»˜åˆ¶æµç¨‹ï¼ŒPopupWindowçª—å£åŠ è½½ç»˜åˆ¶æµç¨‹ï¼ŒToastçª—å£åŠ è½½ç»˜åˆ¶æµç¨‹ç­‰ç­‰ã€‚æ•´ä¸ªAndroidçš„ç•Œé¢æ˜¾ç¤ºçš„åŸç†éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯é€šè¿‡Windowå¯¹è±¡æ§åˆ¶Viewç»„ä»¶ï¼Œå®ç°åŠ è½½ä¸ç»˜åˆ¶æµç¨‹ã€‚ è¿™ç¯‡æ–‡ç« ä¼‘æ¯ä¸€ä¸‹ï¼Œä¸åœ¨è®²è§£Androidçš„çª—å£ç»˜åˆ¶æœºåˆ¶ï¼Œç©¿æ’çš„è®²è§£ä¸€ä¸‹Androidç³»ç»Ÿçš„å¼‚å¸¸å¤„ç†æµç¨‹ã€‚O(âˆ©_âˆ©)Oå“ˆå“ˆ~ å¼€å‘è¿‡androidé¡¹ç›®çš„ç«¥é‹å¯¹androidç³»ç»Ÿä¸­é”™è¯¯å¼¹çª—ï¼Œforce closeåº”è¯¥ä¸é™Œç”Ÿäº†ï¼Œå½“æˆ‘ä»¬çš„Appå¼‚å¸¸å´©æºƒæ—¶ï¼Œå°±ä¼šå¼¹å‡ºä¸€ä¸ªforce closeçš„å¼¹çª—ï¼Œå‘Šè¯‰æˆ‘ä»¬Appå´©æºƒï¼Œä»¥åŠä¸€ä¸‹ç®€æ˜“çš„é”™è¯¯ä¿¡æ¯ï¼š é‚£ä¹ˆè¿™é‡Œçš„force closeå¼¹çª—æ˜¯å¦‚ä½•å¼¹å‡ºçš„å‘¢ï¼Ÿ è¿˜æœ‰æˆ‘ä»¬åœ¨å¼€å‘Appçš„è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šè‡ªå®šä¹‰Applicationï¼Œè‡ªå®šä¹‰UncaughtExceptionHandlerå®ç°Appçš„å…¨å±€å¼‚å¸¸å¤„ç†ï¼Œé‚£ä¹ˆè¿™é‡Œçš„UncaughtExceptionHandleræ˜¯å¦‚ä½•å®ç°å¯¹å¼‚å¸¸çš„å…¨å±€å¤„ç†çš„å‘¢ï¼Ÿï¼ˆå¯å‚è€ƒï¼š åœ¨Androidä¸­è‡ªå®šä¹‰æ•è·Applicationå…¨å±€å¼‚å¸¸ï¼‰ å¸¦ç€è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼€å§‹ä»Šå¤©çš„å¼‚å¸¸æµç¨‹åˆ†æã€‚ åœ¨androidåº”ç”¨è¿›ç¨‹çš„å¯åŠ¨æµç¨‹ä¸­æˆ‘ä»¬åœ¨ç»è¿‡ä¸€ç³»åˆ—çš„æ“ä½œä¹‹åä¼šè°ƒç”¨RuntimeInit.zygoteInitæ–¹æ³•ï¼ˆå¯å‚è€ƒï¼šAndroidåº”ç”¨ç¨‹åºè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹çš„æºä»£ç åˆ†æï¼‰ è€Œæˆ‘ä»¬ä¹Ÿæ˜¯ä»è¿™é‡Œå¼€å§‹åˆ†ææˆ‘ä»¬çš„Androidç³»ç»Ÿå¼‚å¸¸å¤„ç†æµç¨‹ï¼Œå¥½äº†ï¼Œè®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹zygoteInitæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567891011public static final void zygoteInit(int targetSdkVersion, String[] argv, ClassLoader classLoader) throws ZygoteInit.MethodAndArgsCaller { if (DEBUG) Slog.d(TAG, &quot;RuntimeInit: Starting application from zygote&quot;); Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;RuntimeInit&quot;); redirectLogStreams(); commonInit(); nativeZygoteInit(); applicationInit(targetSdkVersion, argv, classLoader); } å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•ä½“ä¸­æˆ‘ä»¬è°ƒç”¨äº†commonInitæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨äºåˆå§‹åŒ–æ“ä½œçš„ï¼Œç»§ç»­çœ‹ä¸€ä¸‹commonInitæ–¹æ³•çš„å®ç°ï¼š 12345private static final void commonInit() { ... Thread.setDefaultUncaughtExceptionHandler(new UncaughtHandler()); ... }å¯ä»¥çœ‹åˆ°åœ¨è¿™é‡Œæˆ‘ä»¬è°ƒç”¨äº†Thread.setDefaultUncaughtExceptionHandleræ–¹æ³•ï¼Œè¿™æ ·å½“æˆ‘ä»¬çš„è¿›ç¨‹å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œå¼‚å¸¸ä¿¡æ¯å°±ä¼šè¢«æˆ‘ä»¬æ–°åˆ›å»ºçš„UncaughtHandleræ‰€æ•è·ã€‚ çœ‹è¿‡æˆ‘ä»¬å‰é¢å†™è¿‡çš„å…³äºAndroidå…¨å±€å¼‚å¸¸å¤„ç†æ–‡ç« çš„ç«¥é‹åº”è¯¥çŸ¥é“ï¼Œæˆ‘ä»¬å®ç°å¯¹Androidå¼‚å¸¸å…¨å±€å¤„ç†çš„æ“ä½œä¹Ÿæ˜¯é€šè¿‡è®¾ç½®Thread.setDefaultUncaughtExceptionHandleræ¥å®ç°çš„ï¼Œå…·ä½“å¯å‚è€ƒï¼š åœ¨Androidä¸­è‡ªå®šä¹‰æ•è·Applicationå…¨å±€å¼‚å¸¸æ‰€ä»¥Androidç³»ç»Ÿé»˜è®¤çš„å¼‚å¸¸ä¿¡æ¯éƒ½ä¼šè¢«è¿™é‡Œçš„UncaughtHandleræ‰€æ•è·å¹¶è¢«å…¶uncaughtExceptionæ–¹æ³•å›è°ƒï¼Œæ‰€ä»¥è‹¥æˆ‘ä»¬ä¸é‡å†™Thread.setDefaultUncaughtExceptionHandleræ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é‡Œçš„UncaughtHandlerå°±æ˜¯æˆ‘ä»¬é»˜è®¤çš„å¼‚å¸¸å¤„ç†æ“ä½œ è¿™æ ·æˆ‘ä»¬çœ‹ä¸€ä¸‹UncaughtHandlerçš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536private static class UncaughtHandler implements Thread.UncaughtExceptionHandler { public void uncaughtException(Thread t, Throwable e) { try { // Don't re-enter -- avoid infinite loops if crash-reporting crashes. if (mCrashing) return; mCrashing = true; if (mApplicationObject == null) { Clog_e(TAG, &quot;*** FATAL EXCEPTION IN SYSTEM PROCESS: &quot; + t.getName(), e); } else { StringBuilder message = new StringBuilder(); message.append(&quot;FATAL EXCEPTION: &quot;).append(t.getName()).append(&quot;\\n&quot;); final String processName = ActivityThread.currentProcessName(); if (processName != null) { message.append(&quot;Process: &quot;).append(processName).append(&quot;, &quot;); } message.append(&quot;PID: &quot;).append(Process.myPid()); Clog_e(TAG, message.toString(), e); } // Bring up crash dialog, wait for it to be dismissed ActivityManagerNative.getDefault().handleApplicationCrash( mApplicationObject, new ApplicationErrorReport.CrashInfo(e)); } catch (Throwable t2) { try { Clog_e(TAG, &quot;Error reporting crash&quot;, t2); } catch (Throwable t3) { // Even Clog_e() fails! Oh well. } } finally { // Try everything to make sure this process goes away. Process.killProcess(Process.myPid()); System.exit(10); } } } è¿™é‡ŒuncaughtExceptionæ–¹æ³•æœ€ç»ˆä¼šè¢«æ‰§è¡Œå¼‚å¸¸ä¿¡æ¯çš„å¤„ç†ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹åœ¨è¿™é‡Œæˆ‘ä»¬è°ƒç”¨äº†ActivityManagerNative.getDefault().handleApplicationCrashæ–¹æ³•ï¼Œçœ‹è¿‡æˆ‘ä»¬å‰é¢Activityå¯åŠ¨æµç¨‹çš„ç«¥é‹åº”è¯¥çŸ¥é“è¿™é‡Œçš„ActivityManagerNativeå…¶å®æ˜¯ActivityManagerServiceçš„Binderå®¢æˆ·ç«¯ï¼Œè€Œè¿™é‡Œçš„handleApplicationCrashæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨çš„æ˜¯ActivityManagerServiceçš„handleApplicationCrashæ–¹æ³•ã€‚æœ€ååœ¨finallyåˆ†ä¹‹ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†Process.killProcess(Process.myPid)å’ŒSystem.exit(10)ï¼Œè¿™æ ·æˆ‘ä»¬çš„åº”ç”¨è¿›ç¨‹å°±ä¼šé€€å‡ºäº†ã€‚ ç„¶åæˆ‘ä»¬åœ¨è¿™é‡Œå…ˆç®€å•çš„åˆ†æä¸€ä¸‹Binderçš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ï¼Œçœ‹ä¸€ä¸‹handleApplicationCrashæ–¹æ³•å…·ä½“åšäº†å“ªäº›äº‹ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹ActivityManagerNativeçš„getDefaultæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ 123static public IActivityManager getDefault() { return gDefault.get(); } å¯ä»¥å‘ç°ï¼Œå…¶æ˜¯ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¹¶æ‰§è¡Œäº†gDefault.getæ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹gDefault.getæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 12345678910111213private static final Singleton&lt;IActivityManager&gt; gDefault = new Singleton&lt;IActivityManager&gt;() { protected IActivityManager create() { IBinder b = ServiceManager.getService(&quot;activity&quot;); if (false) { Log.v(&quot;ActivityManager&quot;, &quot;default service binder = &quot; + b); } IActivityManager am = asInterface(b); if (false) { Log.v(&quot;ActivityManager&quot;, &quot;default service = &quot; + am); } return am; } }; å¯ä»¥å‘ç°è¿™é‡Œè¿”å›ä¸€ä¸ªIActivityManagerç±»å‹çš„amå¯¹è±¡ï¼Œè€Œè¿™ä¸ªamå¯¹è±¡æ˜¯é€šè¿‡è°ƒç”¨asInterfaceæ–¹æ³•åˆ›å»ºçš„ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªasInterfaceæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 123456789101112static public IActivityManager asInterface(IBinder obj) { if (obj == null) { return null; } IActivityManager in = (IActivityManager)obj.queryLocalInterface(descriptor); if (in != null) { return in; } return new ActivityManagerProxy(obj); } å¯ä»¥å‘ç°è¯¥æ–¹æ³•æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªActivityManagerProxyå¯¹è±¡ï¼Œæ‰€ä»¥ActivityManagerNative.getDefault()æ–¹æ³•æœ€ç»ˆè¿”å›çš„æ˜¯ä¸€ä¸ªActivityManagerProxyå¯¹è±¡ï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ActivityManagerProxyçš„handleApplicationCrashæ–¹æ³•ã€‚ 12345678910111213public void handleApplicationCrash(IBinder app, ApplicationErrorReport.CrashInfo crashInfo) throws RemoteException { Parcel data = Parcel.obtain(); Parcel reply = Parcel.obtain(); data.writeInterfaceToken(IActivityManager.descriptor); data.writeStrongBinder(app); crashInfo.writeToParcel(data, 0); mRemote.transact(HANDLE_APPLICATION_CRASH_TRANSACTION, data, reply, 0); reply.readException(); reply.recycle(); data.recycle(); } è¿™é‡Œå°±æ˜¯å…·ä½“çš„Binderä¼ è¾“æ•°æ®çš„é€»è¾‘äº†ï¼Œè¿™é‡ŒActivityManagerNativeæœ€ä¸ºBinderçš„clentç«¯ï¼Œè€Œæˆ‘ä»¬çš„ActivityManagerServiceåŒæ ·æ˜¯ç»§æ‰¿ä¸ActivityManagerNativeï¼Œæœ€ä¸ºBinderçš„serverç«¯ï¼Œé€šè¿‡ä¼ è¾“æœ€ç»ˆActivityManagerServiceçš„handleApplicationCrashæ–¹æ³•ä¼šè¢«æ‰§è¡Œã€‚ 1234567public void handleApplicationCrash(IBinder app, ApplicationErrorReport.CrashInfo crashInfo) { ProcessRecord r = findAppProcess(app, &quot;Crash&quot;); final String processName = app == null ? &quot;system_server&quot; : (r == null ? &quot;unknown&quot; : r.processName); handleApplicationCrashInner(&quot;crash&quot;, r, processName, crashInfo); } å¯ä»¥çœ‹åˆ°åœ¨ActivityManagerServiceçš„handleApplicationCrashæ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨äº†handleApplicationCreashInneræ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹handleApplicationCrashInneræ–¹æ³•çš„å®ç°ã€‚ 1234567891011121314void handleApplicationCrashInner(String eventType, ProcessRecord r, String processName, ApplicationErrorReport.CrashInfo crashInfo) { EventLog.writeEvent(EventLogTags.AM_CRASH, Binder.getCallingPid(), UserHandle.getUserId(Binder.getCallingUid()), processName, r == null ? -1 : r.info.flags, crashInfo.exceptionClassName, crashInfo.exceptionMessage, crashInfo.throwFileName, crashInfo.throwLineNumber); addErrorToDropBox(eventType, r, processName, null, null, null, null, null, crashInfo); crashApplication(r, crashInfo); } å¯ä»¥å‘ç°åœ¨handleApplicationCrashInneræ–¹æ³•ä¸­ä¸»è¦è°ƒç”¨äº†ä¸¤ä¸ªæ–¹æ³•addErrorToDropBoxå’ŒcrashApplicationï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹addErrorToDropBoxæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394public void addErrorToDropBox(String eventType, ProcessRecord process, String processName, ActivityRecord activity, ActivityRecord parent, String subject, final String report, final File logFile, final ApplicationErrorReport.CrashInfo crashInfo) { // NOTE -- this must never acquire the ActivityManagerService lock, // otherwise the watchdog may be prevented from resetting the system. final String dropboxTag = processClass(process) + &quot;_&quot; + eventType; final DropBoxManager dbox = (DropBoxManager) mContext.getSystemService(Context.DROPBOX_SERVICE); // Exit early if the dropbox isn't configured to accept this report type. if (dbox == null || !dbox.isTagEnabled(dropboxTag)) return; final StringBuilder sb = new StringBuilder(1024); appendDropBoxProcessHeaders(process, processName, sb); if (activity != null) { sb.append(&quot;Activity: &quot;).append(activity.shortComponentName).append(&quot;\\n&quot;); } if (parent != null &amp;&amp; parent.app != null &amp;&amp; parent.app.pid != process.pid) { sb.append(&quot;Parent-Process: &quot;).append(parent.app.processName).append(&quot;\\n&quot;); } if (parent != null &amp;&amp; parent != activity) { sb.append(&quot;Parent-Activity: &quot;).append(parent.shortComponentName).append(&quot;\\n&quot;); } if (subject != null) { sb.append(&quot;Subject: &quot;).append(subject).append(&quot;\\n&quot;); } sb.append(&quot;Build: &quot;).append(Build.FINGERPRINT).append(&quot;\\n&quot;); if (Debug.isDebuggerConnected()) { sb.append(&quot;Debugger: Connected\\n&quot;); } sb.append(&quot;\\n&quot;); // Do the rest in a worker thread to avoid blocking the caller on I/O // (After this point, we shouldn't access AMS internal data structures.) Thread worker = new Thread(&quot;Error dump: &quot; + dropboxTag) { @Override public void run() { if (report != null) { sb.append(report); } if (logFile != null) { try { sb.append(FileUtils.readTextFile(logFile, DROPBOX_MAX_SIZE, &quot;\\n\\n[[TRUNCATED]]&quot;)); } catch (IOException e) { Slog.e(TAG, &quot;Error reading &quot; + logFile, e); } } if (crashInfo != null &amp;&amp; crashInfo.stackTrace != null) { sb.append(crashInfo.stackTrace); } String setting = Settings.Global.ERROR_LOGCAT_PREFIX + dropboxTag; int lines = Settings.Global.getInt(mContext.getContentResolver(), setting, 0); if (lines &gt; 0) { sb.append(&quot;\\n&quot;); // Merge several logcat streams, and take the last N lines InputStreamReader input = null; try { java.lang.Process logcat = new ProcessBuilder(&quot;/system/bin/logcat&quot;, &quot;-v&quot;, &quot;time&quot;, &quot;-b&quot;, &quot;events&quot;, &quot;-b&quot;, &quot;system&quot;, &quot;-b&quot;, &quot;main&quot;, &quot;-b&quot;, &quot;crash&quot;, &quot;-t&quot;, String.valueOf(lines)).redirectErrorStream(true).start(); try { logcat.getOutputStream().close(); } catch (IOException e) {} try { logcat.getErrorStream().close(); } catch (IOException e) {} input = new InputStreamReader(logcat.getInputStream()); int num; char[] buf = new char[8192]; while ((num = input.read(buf)) &gt; 0) sb.append(buf, 0, num); } catch (IOException e) { Slog.e(TAG, &quot;Error running logcat&quot;, e); } finally { if (input != null) try { input.close(); } catch (IOException e) {} } } dbox.addText(dropboxTag, sb.toString()); } }; if (process == null) { // If process is null, we are being called from some internal code // and may be about to die -- run this synchronously. worker.run(); } else { worker.start(); } } å¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“å¾ˆé•¿ï¼Œä½†æ˜¯é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåœ¨æ–¹æ³•ä½“æœ€åé€šè¿‡åˆ¤æ–­åº”ç”¨è¿›ç¨‹æ˜¯å¦ä¸ºç©ºï¼ˆæ˜¯å¦è¢«é”€æ¯ï¼‰æ¥æ‰§è¡Œworker.runæ–¹æ³•æˆ–è€…æ˜¯worker.startæ–¹æ³•ï¼Œè¿™é‡Œçš„workeræ˜¯ä¸€ä¸ªThreadå¯¹è±¡ï¼Œè€Œåœ¨æˆ‘ä»¬çš„workerå¯¹è±¡çš„runæ–¹æ³•ä¸­ä¸»è¦çš„æ‰§è¡Œé€»è¾‘å°±æ˜¯å°†å´©æºƒä¿¡æ¯å†™å…¥ç³»ç»Ÿlogä¸­ï¼Œæ‰€ä»¥addErrorToDropBoxæ–¹æ³•çš„ä¸»è¦æ‰§è¡Œé€»è¾‘å°±æ˜¯è®²Appçš„å´©æºƒä¿¡æ¯å†™å…¥ç³»ç»Ÿlogä¸­ã€‚ã€‚ã€‚ã€‚ ç»§ç»­å›åˆ°æˆ‘ä»¬çš„handleApplicationCrashInneræ–¹æ³•ä¸­ï¼Œçœ‹ä¸€ä¸‹crashApplicationæ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105private void crashApplication(ProcessRecord r, ApplicationErrorReport.CrashInfo crashInfo) { long timeMillis = System.currentTimeMillis(); String shortMsg = crashInfo.exceptionClassName; String longMsg = crashInfo.exceptionMessage; String stackTrace = crashInfo.stackTrace; if (shortMsg != null &amp;&amp; longMsg != null) { longMsg = shortMsg + &quot;: &quot; + longMsg; } else if (shortMsg != null) { longMsg = shortMsg; } AppErrorResult result = new AppErrorResult(); synchronized (this) { if (mController != null) { try { String name = r != null ? r.processName : null; int pid = r != null ? r.pid : Binder.getCallingPid(); int uid = r != null ? r.info.uid : Binder.getCallingUid(); if (!mController.appCrashed(name, pid, shortMsg, longMsg, timeMillis, crashInfo.stackTrace)) { if (&quot;1&quot;.equals(SystemProperties.get(SYSTEM_DEBUGGABLE, &quot;0&quot;)) &amp;&amp; &quot;Native crash&quot;.equals(crashInfo.exceptionClassName)) { Slog.w(TAG, &quot;Skip killing native crashed app &quot; + name + &quot;(&quot; + pid + &quot;) during testing&quot;); } else { Slog.w(TAG, &quot;Force-killing crashed app &quot; + name + &quot; at watcher's request&quot;); if (r != null) { r.kill(&quot;crash&quot;, true); } else { // Huh. Process.killProcess(pid); killProcessGroup(uid, pid); } } return; } } catch (RemoteException e) { mController = null; Watchdog.getInstance().setActivityController(null); } } final long origId = Binder.clearCallingIdentity(); // If this process is running instrumentation, finish it. if (r != null &amp;&amp; r.instrumentationClass != null) { Slog.w(TAG, &quot;Error in app &quot; + r.processName + &quot; running instrumentation &quot; + r.instrumentationClass + &quot;:&quot;); if (shortMsg != null) Slog.w(TAG, &quot; &quot; + shortMsg); if (longMsg != null) Slog.w(TAG, &quot; &quot; + longMsg); Bundle info = new Bundle(); info.putString(&quot;shortMsg&quot;, shortMsg); info.putString(&quot;longMsg&quot;, longMsg); finishInstrumentationLocked(r, Activity.RESULT_CANCELED, info); Binder.restoreCallingIdentity(origId); return; } // Log crash in battery stats. if (r != null) { mBatteryStatsService.noteProcessCrash(r.processName, r.uid); } // If we can't identify the process or it's already exceeded its crash quota, // quit right away without showing a crash dialog. if (r == null || !makeAppCrashingLocked(r, shortMsg, longMsg, stackTrace)) { Binder.restoreCallingIdentity(origId); return; } Message msg = Message.obtain(); msg.what = SHOW_ERROR_MSG; HashMap data = new HashMap(); data.put(&quot;result&quot;, result); data.put(&quot;app&quot;, r); msg.obj = data; mUiHandler.sendMessage(msg); Binder.restoreCallingIdentity(origId); } int res = result.get(); Intent appErrorIntent = null; synchronized (this) { if (r != null &amp;&amp; !r.isolated) { // XXX Can't keep track of crash time for isolated processes, // since they don't have a persistent identity. mProcessCrashTimes.put(r.info.processName, r.uid, SystemClock.uptimeMillis()); } if (res == AppErrorDialog.FORCE_QUIT_AND_REPORT) { appErrorIntent = createAppErrorIntentLocked(r, timeMillis, crashInfo); } } if (appErrorIntent != null) { try { mContext.startActivityAsUser(appErrorIntent, new UserHandle(r.userId)); } catch (ActivityNotFoundException e) { Slog.w(TAG, &quot;bug report receiver dissappeared&quot;, e); } } } å¯ä»¥å‘ç°åœ¨æ–¹æ³•ä½“ä¸­æˆ‘ä»¬è°ƒç”¨äº†mUiHandler.sendMessage(msg)ï¼Œå…¶ä¸­mUiHandleræ˜¯ä¸€ä¸ªåœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„Handlerå¯¹è±¡ï¼Œè€Œè¿™é‡Œçš„msgæ˜¯ä¸€ä¸ªwhatå€¼ä¸ºSHOW_ERROR_MSGçš„æ¶ˆæ¯ï¼Œè¿™å¥è¯çš„æœ¬è´¨å°±æ˜¯å‘Uiçº¿ç¨‹ä¸­å‘é€ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹mUiHanderçš„å¤„ç†é€»è¾‘ã€‚ åœ¨mUiHandlerçš„handeMessageæ–¹æ³•ä¸­ï¼Œæ ¹æ®whatå€¼å¾—ä¸åŒï¼Œæ‰§è¡Œäº†å¦‚ä¸‹é€»è¾‘ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243case SHOW_ERROR_MSG: { HashMap&lt;String, Object&gt; data = (HashMap&lt;String, Object&gt;) msg.obj; boolean showBackground = Settings.Secure.getInt(mContext.getContentResolver(), Settings.Secure.ANR_SHOW_BACKGROUND, 0) != 0; synchronized (ActivityManagerService.this) { ProcessRecord proc = (ProcessRecord)data.get(&quot;app&quot;); AppErrorResult res = (AppErrorResult) data.get(&quot;result&quot;); if (proc != null &amp;&amp; proc.crashDialog != null) { Slog.e(TAG, &quot;App already has crash dialog: &quot; + proc); if (res != null) { res.set(0); } return; } boolean isBackground = (UserHandle.getAppId(proc.uid) &gt;= Process.FIRST_APPLICATION_UID &amp;&amp; proc.pid != MY_PID); for (int userId : mCurrentProfileIds) { isBackground &amp;= (proc.userId != userId); } if (isBackground &amp;&amp; !showBackground) { Slog.w(TAG, &quot;Skipping crash dialog of &quot; + proc + &quot;: background&quot;); if (res != null) { res.set(0); } return; } if (mShowDialogs &amp;&amp; !mSleeping &amp;&amp; !mShuttingDown) { Dialog d = new AppErrorDialog(mContext, ActivityManagerService.this, res, proc); d.show(); proc.crashDialog = d; } else { // The device is asleep, so just pretend that the user // saw a crash dialog and hit &quot;force quit&quot;. if (res != null) { res.set(0); } } } ensureBootCompleted(); } å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•ä½“ä¸­æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªAppErrorDialogå¯¹è±¡ï¼Œå¹¶æ‰§è¡Œäº†showæ–¹æ³•ï¼Œè¿™æ ·è¯¥Dialogå°±ä¼šè¢«æ˜¾ç¤ºå‡ºæ¥ã€‚è€Œè¿™é‡Œçš„Dialogçš„æ˜¾ç¤ºå†…å®¹å°±æ˜¯ï¼šApp already has crash dialog: â€¦. O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼ŒåŸæ¥æˆ‘ä»¬Appå´©æºƒçš„æ—¶å€™å¼¹å‡ºæ˜‚çš„å¼‚å¸¸æç¤ºæ¡†å°±æ˜¯åœ¨è¿™é‡Œå¼¹å‡ºæ¥çš„ã€‚è¿™é‡Œå¯¹AppErrorDialogä¸åšè¿‡å¤šçš„ä»‹ç»ï¼Œåœ¨å…¶çš„æ„é€ æ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†å¦‚ä¸‹çš„ä»£ç ï¼š 1234// After the timeout, pretend the user clicked the quit button mHandler.sendMessageDelayed( mHandler.obtainMessage(FORCE_QUIT), DISMISS_TIMEOUT); è¿™é‡Œçš„å¸¸é‡DISMISS_TIME = 5 60 1000ï¼Œä¹Ÿå°±æ˜¯äº”åˆ†é’Ÿï¼Œç›¸å½“äºè¿™é‡Œå‘é€äº†ä¸€ä¸ªå»¶æ—¶å¼‚æ­¥æ¶ˆæ¯äº”åˆ†é’Ÿä¹‹åå–æ¶ˆå´©æºƒå¼¹çª—çš„æ˜¾ç¤ºã€‚æ‰€ä»¥æˆ‘ä»¬çš„Appè‹¥æœå´©æºƒä¹‹åä¸ä¸»åŠ¨å–æ¶ˆå¼¹çª—ï¼Œå´©æºƒå¼¹çª—ä¹Ÿä¼šé»˜è®¤åœ¨äº”åˆ†é’Ÿä¹‹åå–æ¶ˆã€‚ å¥½å§ï¼Œæ–‡ç« å¼€å¤´æˆ‘ä»¬æ‰€æåˆ°çš„ä¸¤ä¸ªé—®é¢˜æˆ‘ä»¬å·²ç»è§£å†³æ‰ä¸€ä¸ªäº†ï¼Œforce closeå¼¹çª—æ˜¯å¦‚ä½•å¼¹å‡ºæ¥çš„ï¼Œç›¸ä¿¡å¤§å®¶å·²ç»æœ‰æ‰€äº†è§£äº†ï¼Œå…¶å®ç¬¬äºŒä¸ªé—®é¢˜ä¹Ÿå·²ç»è¯´æ˜äº†ï¼Œæˆ‘ä»¬çŸ¥é“ç³»ç»Ÿé»˜è®¤çš„Appå¼‚å¸¸å¤„ç†æµç¨‹å°±æ˜¯ä»Thread.setDefaultUncaughtExceptionHandler(new UncaughtHandler());å¼€å§‹çš„ï¼Œå¹¶åˆ›å»ºäº†è‡ªå·±çš„UncaughtHandlerå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥ç®¡ç³»ç»Ÿé»˜è®¤çš„å¼‚å¸¸å¤„ç†é€»è¾‘å…¶å®ä¹Ÿå°±æ˜¯ä»Thread.setDefaultUncaughtExceptionHandlerå¼€å§‹çš„ï¼Œå¹¶é‡å†™å…¶uncaughtExceptionæ–¹æ³•ï¼Œé‚£ä¹ˆAppå¼‚å¸¸ä¿¡æ¯å°±ä¼šè¢«æˆ‘ä»¬è‡ªå®šä¹‰çš„UncaughtHandleræ‰€æ•è·ï¼Œæ•è·ä¹‹åå¥”æºƒä¿¡æ¯çš„è®°å½•ä¸ä¸ŠæŠ¥å°±å¯ä»¥åšå®šåˆ¶äº†ã€‚ã€‚ã€‚ è¿™æ ·æˆ‘ä»¬å°±å¤§æ¦‚åˆ†æå®Œæˆäº†Androidç³»ç»Ÿçš„å¼‚å¸¸å¤„ç†æµç¨‹ã€‚O(âˆ©_âˆ©)Oå“ˆå“ˆ~ æ€»ç»“ï¼š Appåº”ç”¨è¿›ç¨‹å¯åŠ¨æ—¶ä¼šç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨ï¼Œæ‰§è¡ŒThread.setDefaultUncaughtExceptionHandleræ–¹æ³•ï¼Œåˆ›å»ºé»˜è®¤çš„UncaughtHandlerå¼‚å¸¸å¤„ç†å¯¹è±¡ã€‚ é»˜è®¤çš„UncaughtHandlerå¼‚å¸¸å¤„ç†å¯¹è±¡ï¼Œåœ¨å…¶å›è°ƒæ–¹æ³•uncaughtExceptionæ–¹æ³•ä¸­ä¼šæ‰§è¡Œå¼¹çª—å¼‚å¸¸å¼¹çª—çš„æ“ä½œï¼Œè¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬åŸç”Ÿçš„force closeå¼¹çª—ï¼Œå¹¶ä¸”å¼¹çª—å¦‚æœä¸ä¸»åŠ¨å–æ¶ˆçš„è¯ï¼Œä¼šåœ¨äº”åˆ†é’Ÿå†…é»˜è®¤å–æ¶ˆã€‚ è‡ªå®šä¹‰Appçš„å…¨å±€å¼‚å¸¸å¤„ç†é€»è¾‘ï¼Œéœ€è¦æ¥ç®¡UncaughtHandlerï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºè‡ªèº«çš„UncaughtHandlerå¯¹è±¡ï¼Œå¹¶è°ƒç”¨Thread.setDefaultUncaughtExceptionHandleræ–¹æ³•ï¼Œæ¥ç®¡é»˜è®¤çš„å¼‚å¸¸å¤„ç†é€»è¾‘ã€‚ force closeå¼¹çª—ï¼Œå¼¹çª—çš„æ—¶å€™Appåº”ç”¨å¯èƒ½å·²ç»é€€å‡ºï¼Œè¯¥å¼¹çª—çš„å¼¹çª—æ˜¯SystemServerè¿›ç¨‹ä¸­çš„ActivityManagerServiceæœåŠ¡æ§åˆ¶çš„ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåäºŒï¼‰â€“&gt;ToaståŠ è½½ç»˜åˆ¶æµç¨‹","link":"/2020/09/11/Android%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B/"},{"title":"19 DialogåŠ è½½ç»˜åˆ¶æµç¨‹","text":"å‰é¢ä¸¤ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬åˆ†æäº†Activityçš„å¸ƒå±€æ–‡ä»¶åŠ è½½ã€ç»˜åˆ¶æµç¨‹ï¼Œç®—æ˜¯å¯¹æ•´ä¸ªAndroidç³»ç»Ÿä¸­ç•Œé¢çš„æ˜¾ç¤ºæµç¨‹æœ‰äº†ä¸€ä¸ªå¤§æ¦‚çš„äº†è§£ï¼Œå…¶å®Androidç³»ç»Ÿä¸­æ‰€æœ‰çš„æ˜¾ç¤ºæ§ä»¶ï¼ˆæ³¨æ„è¿™é‡Œæ˜¯æ§ä»¶ï¼Œè€Œä¸æ˜¯ç»„ä»¶ï¼‰çš„åŠ è½½ç»˜åˆ¶æµç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼ŒåŒ…æ‹¬ï¼šDialogçš„åŠ è½½ç»˜åˆ¶æµç¨‹ï¼ŒPopupWindowçš„åŠ è½½ç»˜åˆ¶æµç¨‹ï¼ŒToastçš„æ˜¾ç¤ºåŸç†ç­‰ï¼Œä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è¯´åœ¨ä»‹ç»äº†Activityç•Œé¢çš„åŠ è½½ç»˜åˆ¶æµç¨‹ä¹‹åï¼Œå°±ä¼šåˆ†æä¸€ä¸‹å‰©ä½™å‡ ä¸ªæ§ä»¶çš„æ˜¾ç¤ºæ§åˆ¶æµç¨‹ï¼Œè¿™é‡Œæˆ‘æ‰“ç®—å…ˆåˆ†æä¸€ä¸‹Dialogçš„åŠ è½½ç»˜åˆ¶æµç¨‹ã€‚ å¯èƒ½æœ‰çš„åŒå­¦é—®è¿™é‡Œä¸ºä»€ä¹ˆæ²¡æœ‰Fragmentï¼Ÿå…¶å®ä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´Fragmentå¹¶ä¸æ˜¯ä¸€ä¸ªæ˜¾ç¤ºæ§ä»¶ï¼Œè€Œåªæ˜¯ä¸€ä¸ªæ˜¾ç¤ºç»„ä»¶ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿå…¶å®åƒæˆ‘ä»¬çš„Activityï¼ŒDialogï¼ŒPopupWindowä»¥åŠToastç±»çš„å†…éƒ¨éƒ½ç®¡ç†ç»´æŠ¤ç€ä¸€ä¸ªWindowå¯¹è±¡ï¼Œè¿™ä¸ªWindowå¯¹è±¡ä¸ä½†æ˜¯ä¸€ä¸ªViewç»„ä»¶çš„é›†åˆç®¡ç†å¯¹è±¡ï¼Œå®ƒä¹Ÿå®ç°äº†ç»„ä»¶çš„åŠ è½½ä¸ç»˜åˆ¶æµç¨‹ï¼Œè€Œæˆ‘ä»¬çš„Fragmentç»„ä»¶å¦‚æœçœ‹è¿‡æºç çš„è¯ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼Œåªæ˜¯ä¸€ä¸ªViewç»„ä»¶çš„é›†åˆå¹¶é€šè¿‡æ§åˆ¶å˜é‡å®ç°äº†å…¶ç‰¹å®šçš„ç”Ÿå‘½å‘¨æœŸï¼Œä½†æ˜¯å…¶ç”±äºå¹¶æ²¡æœ‰ç»´æŠ¤Windowç±»å‹çš„æˆå‘˜å˜é‡ï¼Œæ‰€ä»¥å…¶ä¸å…·å¤‡ç»„ä»¶çš„åŠ è½½ä¸ç»˜åˆ¶åŠŸèƒ½ï¼Œå› æ­¤å…¶ä¸èƒ½å•ç‹¬çš„è¢«ç»˜åˆ¶å‡ºæ¥ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æŠŠå®ƒç§°ä¹‹ä¸ºç»„ä»¶è€Œä¸æ˜¯æ§ä»¶çš„åŸå› ã€‚ï¼ˆåœ¨åˆ†æå®Œè¿™å‡ ä¸ªæ§ä»¶çš„åŠ è½½ç»˜åˆ¶æµç¨‹ä¹‹åï¼Œæœ‰æ—¶é—´çš„è¯ï¼Œä¹Ÿä¼šåˆ†æä¸€ä¸‹Fragmentçš„ç›¸å…³æºç ï¼‰ å¥½å§ï¼Œå¼€å§‹æˆ‘ä»¬ä»Šå¤©å…³äºDialogçš„è®²è§£ï¼Œç›¸ä¿¡å¤§å®¶åœ¨å¹³æ—¶çš„å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸ä¼šä½¿ç”¨åˆ°Dialogå¼¹çª—ï¼Œä½¿ç”¨Dialogå¯ä»¥åœ¨Activityå¼¹å‡ºå¼¹çª—ï¼Œç¡®è®¤æ¶ˆæ¯ç­‰ã€‚ä¸ºäº†æ›´å¥½çš„åˆ†æDialogçš„æºç ï¼Œæˆ‘ä»¬è¿™é‡Œæš‚æ—¶å†™ä¸€ä¸ªç®€å•çš„demoï¼Œçœ‹ä¸€ä¸‹Dialogçš„ä½¿ç”¨å®ä¾‹ã€‚ 12345678910111213141516171819title.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { AlertDialog.Builder builder = new AlertDialog.Builder(MainActivity.this); builder.setIcon(R.mipmap.ic_launcher); builder.setMessage(&quot;this is the content view!!!&quot;); builder.setTitle(&quot;this is the title view!!!&quot;); builder.setView(R.layout.activity_second); builder.setPositiveButton(&quot;çŸ¥é“äº†&quot;, new DialogInterface.OnClickListener() { @Override public void onClick(DialogInterface dialog, int which) { alertDialog.dismiss(); } }); alertDialog = builder.create(); alertDialog.show(); } }); æˆ‘ä»¬åœ¨Activityä¸­è·å–ä¸€ä¸ªtextViewç»„ä»¶ï¼Œå¹¶ç›‘å¬TextViewçš„ç‚¹å‡»äº‹ä»¶ï¼Œå¹¶åœ¨ç‚¹å‡»äº‹ä»¶ä¸­ï¼Œåˆå§‹åŒ–ä¸€ä¸ªAlertDialogå¼¹çª—ï¼Œå¹¶æ‰§è¡ŒAlertDialogçš„showæ–¹æ³•å±•ç¤ºå¼¹çª—ï¼Œåœ¨å¼¹çª—ä¸­å®šä¹‰ä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶ç›‘å¬å¼¹çª—æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼Œè‹¥ç”¨æˆ·ç‚¹å‡»äº†å¼¹çª—çš„æŒ‰é’®ï¼Œåˆ™æ‰§è¡ŒAlertDialogçš„dismissæ–¹æ³•ï¼Œå–æ¶ˆå±•ç¤ºAlertDialogã€‚å¥½å§ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªå¼¹çª—å¼¹å‡ºçš„å±•ç¤ºç»“æœï¼šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®šä¹‰çš„iconï¼Œtitleï¼Œmessageå’Œbuttonéƒ½å·²ç»æ˜¾ç¤ºå‡ºæ¥äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬ç‚¹å‡»å¼¹çª—æŒ‰é’®çŸ¥é“äº†ï¼Œè¿™æ—¶å€™å¼¹çª—å°±ä¼šæ¶ˆå¤±äº†ã€‚ ä¸€èˆ¬æˆ‘ä»¬ä½¿ç”¨Dialogçš„å¤§æ¦‚æµç¨‹éƒ½æ˜¯è¿™æ ·çš„ï¼Œå¯èƒ½å®šåˆ¶Dialogçš„æ—¶å€™æœ‰ä¸€äº›å®šåˆ¶åŒ–çš„æ“ä½œï¼Œä½†æ˜¯åŸºæœ¬æ“ä½œæµç¨‹è¿˜æ˜¯è¿™æ ·çš„ã€‚ é‚£ä¹ˆæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹AlertDialog.Builderçš„æ„é€ æ–¹æ³•ï¼Œè¿™é‡Œçš„Builderæ˜¯AlertDialogçš„å†…éƒ¨ç±»ï¼Œç”¨äºå°è£…AlertDialogçš„æ„é€ è¿‡ç¨‹ï¼Œçœ‹ä¸€ä¸‹Builderçš„æ„é€ æ–¹æ³•ï¼š 123public Builder(Context context) { this(context, resolveDialogTheme(context, 0)); }å¥½å§ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯Builderçš„é‡è½½æ„é€ æ–¹æ³•ï¼š 1234public Builder(Context context, int themeResId) { P = new AlertController.AlertParams(new ContextThemeWrapper( context, resolveDialogTheme(context, themeResId))); } é‚£ä¹ˆè¿™é‡Œçš„Pæ˜¯AlertDialog.Builderä¸­çš„ä¸€ä¸ªAlertController.AlertParamsç±»å‹çš„æˆå‘˜å˜é‡ï¼Œå¯è§åœ¨è¿™é‡Œæ‰§è¡Œäº†Pçš„åˆå§‹åŒ–æ“ä½œã€‚ 12345public AlertParams(Context context) { mContext = context; mCancelable = true; mInflater = (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE); } å¯ä»¥çœ‹åˆ°è¿™é‡Œä¸»è¦æ‰§è¡Œäº†AlertController.AlertParamsçš„åˆå§‹åŒ–æ“ä½œï¼Œåˆå§‹åŒ–äº†ä¸€äº›æˆå‘˜å˜é‡ã€‚è¿™æ ·æ‰§è¡Œäº†ä¸€ç³»åˆ—æ“ä½œä¹‹åæˆ‘ä»¬çš„ä»£ç ï¼š 1AlertDialog.Builder builder = new AlertDialog.Builder(MainActivity.this); å°±å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨äº†builder.setIconæ–¹æ³•ï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹setIconæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234public Builder setIcon(@DrawableRes int iconId) { P.mIconId = iconId; return this; } å¯ä»¥çœ‹åˆ°AlertDialogçš„Builderçš„setIconæ–¹æ³•ï¼Œè¿™é‡Œæ‰§è¡Œçš„å°±æ˜¯ç»™ç±»å‹ä¸ºAlertController.AlertParamsçš„Pçš„mIconIdèµ‹å€¼ä¸ºä¼ é€’çš„iconIdï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•è¿”å›çš„ç±»å‹å°±æ˜¯Builderã€‚ ç„¶åæˆ‘ä»¬è°ƒç”¨äº†builder.setMessageæ–¹æ³•ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹builder.setMessageæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234public Builder setMessage(CharSequence message) { P.mMessage = message; return this; } å¥½å§ï¼Œè¿™é‡Œè·ŸsetIconæ–¹æ³•çš„å®ç°é€»è¾‘ç±»ä¼¼ï¼Œéƒ½æ˜¯ç»™æˆå‘˜å˜é‡çš„mMessageèµ‹å€¼ä¸ºæˆ‘ä»¬ä¼ é€’çš„Messageå€¼ï¼Œä¸”å’ŒsetIconæ–¹æ³•ç±»ä¼¼çš„ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›å€¼ä¹Ÿæ˜¯Builderã€‚ å†çœ‹ä¸€ä¸‹builder.setTitleæ–¹æ³•ï¼š 1234public Builder setTitle(CharSequence title) { P.mTitle = title; return this; } å¯ä»¥å‘ç°builderçš„setIconã€setMessageã€setTitleç­‰æ–¹æ³•éƒ½æ˜¯ç»™Builderçš„æˆå‘˜å˜é‡Pçš„iconï¼Œmessageï¼Œtitleèµ‹å€¼ã€‚ ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹builder.setViewæ–¹æ³•ï¼š 123456public Builder setView(int layoutResId) { P.mView = null; P.mViewLayoutResId = layoutResId; P.mViewSpacingSpecified = false; return this; } å¯ä»¥å‘ç°è¿™é‡Œçš„setViewå’ŒsetIconï¼ŒsetMessageï¼ŒsetTitleç­‰æ–¹æ³•éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯å°†æˆ‘ä»¬ä¼ é€’çš„æ•°æ®å€¼èµ‹å€¼ç»™Builderçš„æˆå‘˜å˜é‡Pã€‚ ç„¶åæˆ‘ä»¬è°ƒç”¨äº†builder.setPositiveButtonæ–¹æ³•ï¼š 123456builder.setPositiveButton(&quot;çŸ¥é“äº†&quot;, new DialogInterface.OnClickListener() { @Override public void onClick(DialogInterface dialog, int which) { alertDialog.dismiss(); } }); å¥½å§ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹builderçš„setPositiveButtonçš„æºç ï¼š 12345public Builder setPositiveButton(CharSequence text, final OnClickListener listener) { P.mPositiveButtonText = text; P.mPositiveButtonListener = listener; return this; } å¥½å§ï¼Œå¯ä»¥å‘ç°è·Ÿä¸Šé¢å‡ ä¸ªæ–¹æ³•è¿˜æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯ä¸ºBuilderçš„æˆå‘˜å˜é‡Pçš„ç›¸åº”æˆå‘˜å˜é‡èµ‹å€¼ã€‚ã€‚ã€‚ ä¸Šé¢çš„å‡ è¡Œä»£ç æˆ‘ä»¬éƒ½æ˜¯è°ƒç”¨çš„builder.setXXXç­‰æ–¹æ³•ï¼Œä¸»è¦å°±æ˜¯ä¸ºBuilderçš„æˆå‘˜å˜é‡Pçš„ç›¸åº”æˆå‘˜å˜é‡å€¼èµ‹å€¼ã€‚å¹¶ä¸”setXXæ–¹æ³•è¿”å›å€¼éƒ½æ˜¯Builderç±»å‹çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¶ˆæ¯ççš„æ–¹å¼è¿ç»­æ‰§è¡Œï¼š 1builder.setIcon().setMessage().setTitle().setView().setPositiveButton()... è¿™æ ·ä»£ç æ˜¾å¾—æ¯”è¾ƒç®€æ´ï¼Œsetæ–¹æ³•çš„æ‰§è¡Œé¡ºåºæ˜¯æ²¡æœ‰å›ºå®šæ¨¡å¼çš„ï¼Œè¿™é‡Œå¤šè¯´ä¸€ä¸‹ï¼Œè¿™ç§ç¼–ç¨‹æ–¹å¼å¾ˆä¼˜ç§€ï¼Œå¹³æ—¶æˆ‘ä»¬åœ¨è®¾è®¡æ„é€ ç±»å·¥å…·ç±»çš„æ—¶å€™ä¹Ÿå¯ä»¥å‚è€ƒè¿™ç§æ¨¡å¼ï¼Œæ„é€ ç±»æœ‰ä¸åŒçš„åŠŸèƒ½æˆ–è€…ç‰¹æ€§ï¼Œå¹¶ä¸”éƒ½ä¸æ˜¯å¿…é¡»çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡setæ–¹æ³•è®¾ç½®ä¸åŒçš„ç‰¹æ€§å€¼å¹¶è¿”å›æ„é€ ç±»æœ¬èº«ã€‚ ç„¶åæˆ‘ä»¬è°ƒç”¨äº†builder.createæ–¹æ³•ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•è¿”å›äº†AlertDialogã€‚ 123456789101112131415public AlertDialog create() { // Context has already been wrapped with the appropriate theme. final AlertDialog dialog = new AlertDialog(P.mContext, 0, false); P.apply(dialog.mAlert); dialog.setCancelable(P.mCancelable); if (P.mCancelable) { dialog.setCanceledOnTouchOutside(true); } dialog.setOnCancelListener(P.mOnCancelListener); dialog.setOnDismissListener(P.mOnDismissListener); if (P.mOnKeyListener != null) { dialog.setOnKeyListener(P.mOnKeyListener); } return dialog; } å¯ä»¥çœ‹åˆ°è¿™é‡Œé¦–å…ˆæ„é€ äº†ä¸€ä¸ªAlertDialogï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ„é€ æ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567AlertDialog(Context context, @StyleRes int themeResId, boolean createContextThemeWrapper) { super(context, createContextThemeWrapper ? resolveDialogTheme(context, themeResId) : 0, createContextThemeWrapper); mWindow.alwaysReadCloseOnTouchAttr(); mAlert = new AlertController(getContext(), this, getWindow()); } å¯ä»¥çœ‹åˆ°è¿™é‡Œé¦–å…ˆè°ƒç”¨äº†superçš„æ„é€ æ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çš„AlertDialogç»§æ‰¿äºDialogï¼Œæ‰€ä»¥è¿™é‡Œæ‰§è¡Œçš„å°±æ˜¯Dialogçš„æ„é€ æ–¹æ³•ï¼Œå¥½å§ï¼Œç»§ç»­çœ‹ä¸€ä¸‹Dialogçš„æ„é€ æ–¹æ³•ï¼š 1234567891011121314151617181920212223Dialog(@NonNull Context context, @StyleRes int themeResId, boolean createContextThemeWrapper) { if (createContextThemeWrapper) { if (themeResId == 0) { final TypedValue outValue = new TypedValue(); context.getTheme().resolveAttribute(R.attr.dialogTheme, outValue, true); themeResId = outValue.resourceId; } mContext = new ContextThemeWrapper(context, themeResId); } else { mContext = context; } mWindowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE); final Window w = new PhoneWindow(mContext); mWindow = w; w.setCallback(this); w.setOnWindowDismissedCallback(this); w.setWindowManager(mWindowManager, null, null); w.setGravity(Gravity.CENTER); mListenersHandler = new ListenersHandler(this); } å¯ä»¥å‘ç°åœ¨Dialogçš„æ„é€ æ–¹æ³•ä¸­ç›´æ¥ç›´æ¥æ„é€ äº†ä¸€ä¸ªPhoneWindowï¼Œå¹¶èµ‹å€¼ç»™Dialogçš„æˆå‘˜å˜é‡mWindowï¼Œä»è¿™é‡Œå¯ä»¥çœ‹å‡ºå…¶å®Dialogå’ŒActivityçš„æ˜¾ç¤ºé€»è¾‘éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½æ˜¯é€šè¿‡å¯¹åº”çš„Windowå˜é‡æ¥å®ç°çª—å£çš„åŠ è½½ä¸æ˜¾ç¤ºçš„ã€‚ç„¶åæˆ‘ä»¬æ‰§è¡Œäº†ä¸€äº›Windowå¯¹è±¡çš„åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚è®¾ç½®å›è°ƒå‡½æ•°ä¸ºæœ¬èº«ï¼Œç„¶åè°ƒç”¨äº†Windowç±»çš„setWindowManageræ–¹æ³•ï¼Œå¹¶ä¼ å…¥äº†WindowManagerï¼Œå¯ä»¥å‘ç°è¿™é‡Œçš„WindowManagerå¯¹è±¡æ˜¯é€šè¿‡æ–¹æ³•ï¼š 1mWindowManager = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE); è·å–çš„ï¼Œè€Œæˆ‘ä»¬çš„contextä¼ å…¥çš„æ˜¯Activityå¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œçš„WindowManagerå¯¹è±¡å…¶å®å’ŒActivityè·å–çš„WindowManagerå¯¹è±¡æ˜¯ä¸€è‡´çš„ã€‚ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹windowç±»çš„setWindowManageræ–¹æ³•ï¼š 1234567891011public void setWindowManager(WindowManager wm, IBinder appToken, String appName, boolean hardwareAccelerated) { mAppToken = appToken; mAppName = appName; mHardwareAccelerated = hardwareAccelerated || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, false); if (wm == null) { wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE); } mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(this); } å¯ä»¥çœ‹åˆ°è·ŸActivityçš„Windowå¯¹è±¡çš„windowManagerçš„è·å–æ–¹å¼æ˜¯ç›¸åŒçš„ï¼Œéƒ½æ˜¯é€šè¿‡newçš„æ–¹å¼åˆ›å»ºä¸€ä¸ªæ–°çš„WindowManagerImplå¯¹è±¡ã€‚å¥½å§ï¼Œç»§ç»­å›åˆ°æˆ‘ä»¬çš„AlertDialogçš„æ„é€ æ–¹æ³•ä¸­ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é™¤äº†è°ƒç”¨Dialogçš„æ„é€ æ–¹æ³•ä¹‹å¤–è¿˜æ‰§è¡Œäº†ï¼š 1mAlert = new AlertController(getContext(), this, getWindow()); ç›¸å½“äºåˆå§‹åŒ–äº†AlertDiaogçš„æˆå‘˜å˜é‡mAlertã€‚ ç»§ç»­å›åˆ°æˆ‘ä»¬çš„AlertDialog.Builder.createæ–¹æ³•ï¼Œåœ¨åˆ›å»ºäº†ä¸€ä¸ªAlertDialogä¹‹åï¼Œåˆæ‰§è¡Œäº†P.apply(dialog.mAlert)ï¼›æˆ‘ä»¬çŸ¥é“è¿™é‡Œçš„Pæ˜¯ä¸€ä¸ªAlertController.AlertParamsçš„å˜é‡ï¼Œè€Œdialog.mAlertæ˜¯æˆ‘ä»¬åˆšåˆšåˆ›å»ºçš„AlertDialogä¸­çš„ä¸€ä¸ªAlertControllerç±»å‹çš„å˜é‡ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹applyæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051ublic void apply(AlertController dialog) { if (mCustomTitleView != null) { dialog.setCustomTitle(mCustomTitleView); } else { if (mTitle != null) { dialog.setTitle(mTitle); } if (mIcon != null) { dialog.setIcon(mIcon); } if (mIconId != 0) { dialog.setIcon(mIconId); } if (mIconAttrId != 0) { dialog.setIcon(dialog.getIconAttributeResId(mIconAttrId)); } } if (mMessage != null) { dialog.setMessage(mMessage); } if (mPositiveButtonText != null) { dialog.setButton(DialogInterface.BUTTON_POSITIVE, mPositiveButtonText, mPositiveButtonListener, null); } if (mNegativeButtonText != null) { dialog.setButton(DialogInterface.BUTTON_NEGATIVE, mNegativeButtonText, mNegativeButtonListener, null); } if (mNeutralButtonText != null) { dialog.setButton(DialogInterface.BUTTON_NEUTRAL, mNeutralButtonText, mNeutralButtonListener, null); } if (mForceInverseBackground) { dialog.setInverseBackgroundForced(true); } // For a list, the client can either supply an array of items or an // adapter or a cursor if ((mItems != null) || (mCursor != null) || (mAdapter != null)) { createListView(dialog); } if (mView != null) { if (mViewSpacingSpecified) { dialog.setView(mView, mViewSpacingLeft, mViewSpacingTop, mViewSpacingRight, mViewSpacingBottom); } else { dialog.setView(mView); } } else if (mViewLayoutResId != 0) { dialog.setView(mViewLayoutResId); } } çœ‹åˆ°äº†ä¹ˆï¼Ÿå°±æ˜¯æˆ‘ä»¬åœ¨åˆå§‹åŒ–AlertDialog.Builderçš„æ—¶å€™è®¾ç½®çš„iconã€titleã€messageèµ‹å€¼ç»™äº†AlertController.AlertParamsï¼Œè¿™é‡Œå°±æ˜¯å°†æˆ‘ä»¬åˆå§‹åŒ–æ—¶å€™è®¾ç½®çš„å±æ€§å€¼èµ‹å€¼ç»™æˆ‘ä»¬åˆ›å»ºçš„Dialogå¯¹è±¡çš„mAlertæˆå‘˜å˜é‡ã€‚ã€‚ã€‚ã€‚ ç»§ç»­æˆ‘ä»¬çš„AlertDialog.Builder.createæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œäº†AlertController.AlertParams.applyæ–¹æ³•ä¹‹ååˆè°ƒç”¨äº†ï¼š 1dialog.setCancelable(P.mCancelable); å¯ä»¥å‘ç°è¿™ä¸ªä¹Ÿæ˜¯AertController.AlertParamsçš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œæˆ‘ä»¬åœ¨åˆå§‹åŒ–AlertDialog.Builderçš„æ—¶å€™ä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®builder.setCancelableèµ‹å€¼ï¼Œç”±äºè¯¥å±æ€§ä¸ºæˆå‘˜å˜é‡ï¼Œæ‰€ä»¥é»˜è®¤å€¼ä¸ºfalseï¼Œè€Œæˆ‘ä»¬å¹¶æ²¡æœ‰é€šè¿‡builder.setCancelableä¿®æ”¹è¿™ä¸ªå±æ€§å€¼ï¼Œæ‰€ä»¥è¿™é‡Œè®¾ç½®çš„dialogçš„cancelableçš„å€¼ä¸ºfalseã€‚ç„¶åæˆ‘ä»¬çš„createæ–¹æ³•æœ‰è®¾ç½®äº†dialogçš„cancelListenerå’ŒdismissListenerå¹¶è¿”å›äº†æˆ‘ä»¬åˆ›å»ºçš„Dialogå¯¹è±¡ã€‚è¿™æ ·æˆ‘ä»¬å°±è·å–åˆ°äº†æˆ‘ä»¬çš„Dialogå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨äº†dialogçš„showæ–¹æ³•ç”¨äºæ˜¾ç¤ºdialogï¼Œå¥½å§ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹showæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445public void show() { if (mShowing) { if (mDecor != null) { if (mWindow.hasFeature(Window.FEATURE_ACTION_BAR)) { mWindow.invalidatePanelMenu(Window.FEATURE_ACTION_BAR); } mDecor.setVisibility(View.VISIBLE); } return; } mCanceled = false; if (!mCreated) { dispatchOnCreate(null); } onStart(); mDecor = mWindow.getDecorView(); if (mActionBar == null &amp;&amp; mWindow.hasFeature(Window.FEATURE_ACTION_BAR)) { final ApplicationInfo info = mContext.getApplicationInfo(); mWindow.setDefaultIcon(info.icon); mWindow.setDefaultLogo(info.logo); mActionBar = new WindowDecorActionBar(this); } WindowManager.LayoutParams l = mWindow.getAttributes(); if ((l.softInputMode &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION) == 0) { WindowManager.LayoutParams nl = new WindowManager.LayoutParams(); nl.copyFrom(l); nl.softInputMode |= WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION; l = nl; } try { mWindowManager.addView(mDecor, l); mShowing = true; sendShowMessage(); } finally { } } æ–¹æ³•ä½“çš„å†…å®¹æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬æ…¢æ…¢çœ‹ï¼Œç”±äºä¸€å¼€å§‹mShowingå˜é‡ç”¨äºè¡¨ç¤ºå½“å‰dialogæ˜¯å¦æ­£åœ¨æ˜¾ç¤ºï¼Œç”±äºæˆ‘ä»¬åˆšåˆšå¼€å§‹è°ƒç”¨æ‰§è¡Œshowæ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œçš„mShowingå˜é‡çš„å€¼ä¸ºfalseï¼Œæ‰€ä»¥ifåˆ†æ”¯çš„å†…å®¹ä¸ä¼šè¢«æ‰§è¡Œï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼š 123if (!mCreated) { dispatchOnCreate(null); } mCreatedè¿™ä¸ªæ§åˆ¶å˜é‡æ§åˆ¶dispatchOnCreateæ–¹æ³•åªè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œç”±äºæˆ‘ä»¬æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ‰§è¡ŒdispatchOnCreateæ–¹æ³•ï¼Œå¥½å§ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹dispatchOnCreateæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ï¼š 123456void dispatchOnCreate(Bundle savedInstanceState) { if (!mCreated) { onCreate(savedInstanceState); mCreated = true; } } å¥½å§ï¼Œå¯ä»¥çœ‹åˆ°ä»£ç çš„æ‰§è¡Œé€»è¾‘å¾ˆç®€å•å°±æ˜¯å›è°ƒäº†Dialogçš„onCreateæ–¹æ³•ï¼Œé‚£ä¹ˆonCreateæ–¹æ³•å†…éƒ¨åˆæ‰§è¡Œäº†é‚£äº›é€»è¾‘å‘¢ï¼Ÿç”±äºæˆ‘ä»¬åˆ›å»ºçš„æ˜¯AlertDialogå¯¹è±¡ï¼Œè¯¥å¯¹è±¡ç»§æ‰¿äºDialogï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™æ—¶å€™éœ€è¦çœ‹ä¸€ä¸‹AlertDialogçš„onCreateæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ï¼š 12345@Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); mAlert.installContent(); } å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢é™¤äº†è°ƒç”¨super.onCreateæ–¹æ³•ä¹‹å¤–å°±æ˜¯è°ƒç”¨äº†mAlert.installContentæ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„super.onCreateæ–¹æ³•å°±æ˜¯è°ƒç”¨çš„Dialogçš„onCreateæ–¹æ³•ï¼ŒDialogçš„onCreateæ–¹æ³•åªæ˜¯ä¸€ä¸ªç©ºçš„å®ç°é€»è¾‘ï¼Œæ‰€ä»¥æˆ‘ä»¬å…·ä½“æ¥çœ‹ä¸€ä¸‹mAlert.installContentçš„å®ç°é€»è¾‘ã€‚ 12345678public void installContent() { /* We use a custom title so never request a window title */ mWindow.requestFeature(Window.FEATURE_NO_TITLE); int contentView = selectContentView(); mWindow.setContentView(contentView); setupView(); setupDecor(); } å¯ä»¥çœ‹åˆ°è¿™é‡Œå®ç°Windowçª—å£çš„é¡µé¢è®¾ç½®å¸ƒå±€åˆå§‹åŒ–ç­‰æ“ä½œï¼Œè¿™é‡Œè®¾ç½®äº†mWindowå¯¹è±¡ä¸ºNO_TITLEï¼Œç„¶åé€šè¿‡è°ƒç”¨selectContentViewè®¾ç½®Windowå¯¹è±¡çš„å¸ƒå±€æ–‡ä»¶ã€‚ 12345678910private int selectContentView() { if (mButtonPanelSideLayout == 0) { return mAlertDialogLayout; } if (mButtonPanelLayoutHint == AlertDialog.LAYOUT_HINT_SIDE) { return mButtonPanelSideLayout; } // TODO: use layout hint side for long messages/lists return mAlertDialogLayout; } å¯ä»¥çœ‹åˆ°è¿™é‡Œé€šè¿‡æ‰§è¡ŒselectContentViewæ–¹æ³•è¿”å›å¸ƒå±€æ–‡ä»¶çš„idå€¼ï¼Œè¿™é‡Œçš„é»˜è®¤å€¼æ˜¯mAlertDialogLayoutã€‚çœ‹è¿‡Activityå¸ƒå±€åŠ è½½æµç¨‹ï¼ˆandroidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹ï¼‰çš„ç«¥é‹åº”è¯¥çŸ¥é“ï¼Œä»è¿™ä¸ªæ–¹æ³•å¼€å§‹æˆ‘ä»¬å°±æŠŠæŒ‡å®šå¸ƒå±€æ–‡ä»¶çš„å†…å®¹åŠ è½½åˆ°å†…å­˜ä¸­çš„Windowå¯¹è±¡ä¸­ã€‚æˆ‘ä»¬è¿™é‡Œçœ‹ä¸€ä¸‹å…·ä½“çš„å¸ƒå±€æ–‡ä»¶ã€‚ 12mAlertDialogLayout = a.getResourceId( R.styleable.AlertDialog_layout, R.layout.alert_dialog); ä¹Ÿå°±æ˜¯R.layout.alert_dialogçš„å¸ƒå±€æ–‡ä»¶ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹è¯¥å¸ƒå±€æ–‡ä»¶çš„æºç ï¼ŒO(âˆ©_âˆ©)Oå“ˆå“ˆ~ ç»§ç»­å›åˆ°æˆ‘ä»¬çš„installContentæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œäº†mWindow.setContentViewæ–¹æ³•ä¹‹åï¼Œåˆè°ƒç”¨äº†setupViewæ–¹æ³•å’ŒsetupDectoræ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„ä¸»è¦ä½œç”¨å°±æ˜¯åˆå§‹åŒ–å¸ƒå±€æ–‡ä»¶ä¸­çš„ç»„ä»¶å’ŒWindowå¯¹è±¡ä¸­çš„mDectoræˆå‘˜å˜é‡ï¼Œè¿™é‡Œå°±ä¸åœ¨è¯¦ç»†çš„è¯´æ˜ã€‚ ç„¶åå›åˆ°æˆ‘ä»¬çš„showæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œäº†dispatchOnCreateæ–¹æ³•ä¹‹åæˆ‘ä»¬åˆè°ƒç”¨äº†onStartæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºè®¾ç½®ActionBarï¼Œè¿™é‡Œä¸åšè¿‡å¤šçš„è¯´æ˜ï¼Œç„¶ååˆå§‹åŒ–WindowManager.LayoutParamså¯¹è±¡ï¼Œå¹¶æœ€ç»ˆè°ƒç”¨æˆ‘ä»¬çš„mWindowManager.addView()æ–¹æ³•ã€‚ O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œåˆ°äº†è¿™ä¸€æ­¥å¤§å®¶å¦‚æœçœ‹äº†ä¸Šä¸€ç¯‡Acitivtyå¸ƒå±€ç»˜åˆ¶æµç¨‹çš„è¯ï¼Œå°±åº”è¯¥çŸ¥é“é¡ºç€è¿™ä¸ªæ–¹æ³•æ•´ä¸ªDialogçš„ç•Œé¢å°±ä¼šè¢«ç»˜åˆ¶å‡ºæ¥äº†ã€‚ æœ€åæˆ‘ä»¬è°ƒç”¨äº†sendShowMessageæ–¹æ³•ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š 123456private void sendShowMessage() { if (mShowMessage != null) { // Obtain a new message so this dialog can be re-used Message.obtain(mShowMessage).sendToTarget(); } } è¿™é‡Œä¼šå‘é€ä¸€ä¸ªDialogå·²ç»æ˜¾ç¤ºçš„å¼‚æ­¥æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯æœ€ç»ˆä¼šåœ¨ListenersHandlerä¸­çš„handleMessageæ–¹æ³•ä¸­è¢«æ‰§è¡Œï¼š 12345678910111213141516171819202122private static final class ListenersHandler extends Handler { private WeakReference&lt;DialogInterface&gt; mDialog; public ListenersHandler(Dialog dialog) { mDialog = new WeakReference&lt;DialogInterface&gt;(dialog); } @Override public void handleMessage(Message msg) { switch (msg.what) { case DISMISS: ((OnDismissListener) msg.obj).onDismiss(mDialog.get()); break; case CANCEL: ((OnCancelListener) msg.obj).onCancel(mDialog.get()); break; case SHOW: ((OnShowListener) msg.obj).onShow(mDialog.get()); break; } } } ç”±äºæˆ‘ä»¬çš„msg.what = SHOW,æ‰€ä»¥ä¼šæ‰§è¡ŒOnShowListener.onShowæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªOnShowListeneræ˜¯ä½•æ—¶èµ‹å€¼çš„å‘¢ï¼Ÿè¿˜è®°å¾—æˆ‘ä»¬æ„é€ AlertDialog.Builderä¹ˆï¼Ÿ 123456alertDialog.setOnShowListener(new DialogInterface.OnShowListener() { @Override public void onShow(DialogInterface dialog) { } }); è¿™æ ·å°±ä¸ºæˆ‘ä»¬çš„AlertDialog.Builderè®¾ç½®äº†OnShowListenerï¼Œå¯ä»¥çœ‹ä¸€ä¸‹setOnShowListeneræ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567public void setOnShowListener(OnShowListener listener) { if (listener != null) { mShowMessage = mListenersHandler.obtainMessage(SHOW, listener); } else { mShowMessage = null; } } è¿™æ ·å°±ä¸ºæˆ‘ä»¬çš„Dialogä¸­çš„mListenersHandleræ„é€ äº†Messageå¯¹è±¡ï¼Œå¹¶ä¸”å½“æˆ‘ä»¬åœ¨Dialogä¸­å‘é€showMessageçš„æ—¶å€™è¢«mListenersHandleræ‰€æ¥æ”¶ã€‚ã€‚ã€‚ã€‚ æ³¨ï¼šè¿™é‡Œè¯´ä¸€ä¸‹æˆ‘ä»¬å¹³æ—¶å¼€å‘ä¸­è‹¥åˆ›å»ºçš„Dialogä½¿ç”¨çš„Contextå¯¹è±¡ä¸æ˜¯Activityï¼Œå°±ä¼šæŠ¥å‡ºï¼š 12345678910111213141516Process: com.example.aaron.helloworld, PID: 11948 android.view.WindowManager$BadTokenException: Unable to add window -- token null is not for an applicationat android.view.ViewRootImpl.setView(ViewRootImpl.java:690)at android.view.WindowManagerGlobal.addView(WindowManagerGlobal.java:282)at android.view.WindowManagerImpl.addView(WindowManagerImpl.java:69)at android.app.Dialog.show(Dialog.java:298)at com.example.aaron.helloworld.MainActivity$1.onClick(MainActivity.java:59)at android.view.View.performClick(View.java:4811)at android.view.View$PerformClick.run(View.java:20136)at android.os.Handler.handleCallback(Handler.java:815)at android.os.Handler.dispatchMessage(Handler.java:104)at android.os.Looper.loop(Looper.java:194)at android.app.ActivityThread.main(ActivityThread.java:5552)at java.lang.reflect.Method.invoke(Native Method)at java.lang.reflect.Method.invoke(Method.java:372)at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:964)at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:759) çš„å¼‚å¸¸ï¼Œè¿™æ˜¯ç”±äºWindowManager.addViewæ–¹æ³•æœ€ç»ˆä¼šè°ƒç”¨ViewRootImpl.setViewæ–¹æ³•ï¼Œè€Œè¿™æ—¶å€™ä¼šæœ‰mTokençš„æ£€æŸ¥ï¼Œè‹¥æˆ‘ä»¬ä¼ å…¥çš„Contextå¯¹è±¡ä¸æ˜¯Activityï¼Œè¿™æ—¶å€™çš„mTokenä¸ºç©ºï¼Œå°±ä¼šå‡ºç°ä¸Šè¿°é—®é¢˜ã€‚ã€‚ã€‚ æ€»ç»“ï¼š Dialogå’ŒActivityçš„æ˜¾ç¤ºé€»è¾‘æ˜¯ç›¸ä¼¼çš„éƒ½æ˜¯å†…éƒ¨ç®¡ç†è¿™ä¸€ä¸ªWindowå¯¹è±¡ï¼Œç”¨WIndowå¯¹è±¡å®ç°ç•Œé¢çš„åŠ è½½ä¸æ˜¾ç¤ºé€»è¾‘ï¼› Dialogä¸­çš„Windowå¯¹è±¡ä¸Activityä¸­çš„Windowå¯¹è±¡æ˜¯ç›¸ä¼¼çš„ï¼Œéƒ½å¯¹åº”ç€ä¸€ä¸ªWindowManagerå¯¹è±¡ï¼› Dialogç›¸å…³çš„å‡ ä¸ªç±»ï¼šDialogï¼ŒAlertDialogï¼ŒAlertDialog.Builderï¼ŒAlertControllerï¼ŒAlertController.AlertParamsï¼Œå…¶ä¸­Dialogæ˜¯çª—å£çš„çˆ¶ç±»ï¼Œä¸»è¦å®ç°Windowå¯¹è±¡çš„åˆå§‹åŒ–å’Œä¸€äº›å…±æœ‰é€»è¾‘ï¼Œè€ŒAlertDialogæ˜¯å…·ä½“çš„Dialogçš„æ“ä½œå®ç°ç±»ï¼ŒAlertDialog.Builderç±»æ˜¯AlertDialogçš„å†…éƒ¨ç±»ï¼Œä¸»è¦ç”¨äºæ„é€ AlertDialogï¼ŒAlertControlleræ˜¯AlertDialogçš„æ§åˆ¶ç±»ï¼ŒAlertController.AlertParamsç±»æ˜¯æ§åˆ¶å‚æ•°ç±»ï¼› æ„é€ æ˜¾ç¤ºDialogçš„ä¸€èˆ¬æµç¨‹ï¼Œæ„é€ AlertDialog.Builderï¼Œç„¶åè®¾ç½®å„ç§å±æ€§ï¼Œæœ€åè°ƒç”¨AlertDialog.Builder.createæ–¹æ³•è·å–AlertDialogå¯¹è±¡ï¼Œå¹¶ä¸”createæ–¹æ³•ä¸­ä¼šæ‰§è¡Œï¼Œæ„é€ AlertDialogï¼Œè®¾ç½®dialogå„ç§å±æ€§çš„æ“ä½œã€‚æœ€åæˆ‘ä»¬è°ƒç”¨Dialog.showæ–¹æ³•å±•ç¤ºçª—å£ï¼Œåˆå§‹åŒ–Dialogçš„å¸ƒå±€æ–‡ä»¶ï¼ŒWindowå¯¹è±¡ç­‰ï¼Œç„¶åæ‰§è¡ŒmWindowManager.addViewæ–¹æ³•ï¼Œå¼€å§‹æ‰§è¡Œç»˜åˆ¶Viewçš„æ“ä½œï¼Œå¹¶æœ€ç»ˆå°†Dialogæ˜¾ç¤ºå‡ºæ¥ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹","link":"/2020/09/11/Dialog%E5%8A%A0%E8%BD%BD%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/"},{"title":"9 SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹","text":"è½¬è½½è¯·æ ‡æ˜å‡ºå¤„ï¼šä¸€ç‰‡æ«å¶çš„ä¸“æ  ä¸Šé¢ä¸€æ–‡ä¸­æˆ‘ä»¬è®²è¿‡androidç³»ç»Ÿä¸­æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªè¿›ç¨‹ï¼šinitè¿›ç¨‹ï¼ŒZygoteè¿›ç¨‹ï¼ŒSystemServerè¿›ç¨‹å·²ç»å„ç§åº”ç”¨è¿›ç¨‹ï¼Œå…¶ä¸­Zygoteè¿›ç¨‹æ˜¯æ•´ä¸ªandroidç³»ç»Ÿçš„æ ¹è¿›ç¨‹ï¼ŒåŒ…å«SystemServerè¿›ç¨‹å·²ç»å„ç§åº”ç”¨è¿›ç¨‹åœ¨å†…çš„è¿›ç¨‹éƒ½æ˜¯é€šè¿‡Zygoteè¿›ç¨‹forkå‡ºæ¥çš„ï¼Œå…·ä½“å¯å‚è§ï¼š androidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹é‚£ä¹ˆSystemServerè¿›ç¨‹æ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿ å…¶å®SystemServerè¿›ç¨‹ä¸»è¦çš„ä½œç”¨æ˜¯åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­å¯åŠ¨å„ç§ç³»ç»ŸæœåŠ¡ï¼Œæ¯”å¦‚ActivityManagerServiceï¼ŒPackageManagerServiceï¼ŒWindowManagerServiceæœåŠ¡ï¼Œä»¥åŠå„ç§ç³»ç»Ÿæ€§çš„æœåŠ¡å…¶å®éƒ½æ˜¯åœ¨SystemServerè¿›ç¨‹ä¸­å¯åŠ¨çš„ï¼Œè€Œå½“æˆ‘ä»¬çš„åº”ç”¨éœ€è¦ä½¿ç”¨å„ç§ç³»ç»ŸæœåŠ¡çš„æ—¶å€™å…¶å®ä¹Ÿæ˜¯é€šè¿‡ä¸SystemServerè¿›ç¨‹é€šè®¯è·å–å„ç§æœåŠ¡å¯¹è±¡çš„å¥æŸ„çš„ã€‚ ç”±ä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬çŸ¥é“SystemServerè¿›ç¨‹å…¶å®ä¹Ÿæ˜¯æœ‰Zygoteè¿›ç¨‹forkå‡ºæ¥çš„ï¼Œå¹¶ä¸”æ‰§è¡Œå…¶mainæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬ä»¥android23çš„æºç ä¸ºä¾‹ï¼Œçœ‹ä¸€ä¸‹SystemServerçš„mainæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ï¼š 123456/** * The main entry point from zygote. */ public static void main(String[] args) { new SystemServer().run(); } è¿™é‡Œæ¯”è¾ƒç®€å•ï¼Œåªæ˜¯newå‡ºä¸€ä¸ªSystemServerå¯¹è±¡å¹¶æ‰§è¡Œå…¶runæ–¹æ³•ï¼ŒæŸ¥çœ‹SystemServerç±»çš„å®šä¹‰æˆ‘ä»¬çŸ¥é“å…¶å®finalç±»å‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¸èƒ½é‡å†™æˆ–è€…ç»§æ‰¿ã€‚ ç„¶åæˆ‘ä»¬æŸ¥çœ‹runæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110private void run() { // If a device's clock is before 1970 (before 0), a lot of // APIs crash dealing with negative numbers, notably // java.io.File#setLastModified, so instead we fake it and // hope that time from cell towers or NTP fixes it shortly. if (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) { Slog.w(TAG, &quot;System clock is before 1970; setting to 1970.&quot;); SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME); } // If the system has &quot;persist.sys.language&quot; and friends set, replace them with // &quot;persist.sys.locale&quot;. Note that the default locale at this point is calculated // using the &quot;-Duser.locale&quot; command line flag. That flag is usually populated by // AndroidRuntime using the same set of system properties, but only the system_server // and system apps are allowed to set them. // // NOTE: Most changes made here will need an equivalent change to // core/jni/AndroidRuntime.cpp if (!SystemProperties.get(&quot;persist.sys.language&quot;).isEmpty()) { final String languageTag = Locale.getDefault().toLanguageTag(); SystemProperties.set(&quot;persist.sys.locale&quot;, languageTag); SystemProperties.set(&quot;persist.sys.language&quot;, &quot;&quot;); SystemProperties.set(&quot;persist.sys.country&quot;, &quot;&quot;); SystemProperties.set(&quot;persist.sys.localevar&quot;, &quot;&quot;); } // Here we go! Slog.i(TAG, &quot;Entered the Android system server!&quot;); EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_SYSTEM_RUN, SystemClock.uptimeMillis()); // In case the runtime switched since last boot (such as when // the old runtime was removed in an OTA), set the system // property so that it is in sync. We can't do this in // libnativehelper's JniInvocation::Init code where we already // had to fallback to a different runtime because it is // running as root and we need to be the system user to set // the property. http://b/11463182 SystemProperties.set(&quot;persist.sys.dalvik.vm.lib.2&quot;, VMRuntime.getRuntime().vmLibrary()); // Enable the sampling profiler. if (SamplingProfilerIntegration.isEnabled()) { SamplingProfilerIntegration.start(); mProfilerSnapshotTimer = new Timer(); mProfilerSnapshotTimer.schedule(new TimerTask() { @Override public void run() { SamplingProfilerIntegration.writeSnapshot(&quot;system_server&quot;, null); } }, SNAPSHOT_INTERVAL, SNAPSHOT_INTERVAL); } // Mmmmmm... more memory! VMRuntime.getRuntime().clearGrowthLimit(); // The system server has to run all of the time, so it needs to be // as efficient as possible with its memory usage. VMRuntime.getRuntime().setTargetHeapUtilization(0.8f); // Some devices rely on runtime fingerprint generation, so make sure // we've defined it before booting further. Build.ensureFingerprintProperty(); // Within the system server, it is an error to access Environment paths without // explicitly specifying a user. Environment.setUserRequired(true); // Ensure binder calls into the system always run at foreground priority. BinderInternal.disableBackgroundScheduling(true); // Prepare the main looper thread (this thread). android.os.Process.setThreadPriority( android.os.Process.THREAD_PRIORITY_FOREGROUND); android.os.Process.setCanSelfBackground(false); Looper.prepareMainLooper(); // Initialize native services. System.loadLibrary(&quot;android_servers&quot;); // Check whether we failed to shut down last time we tried. // This call may not return. performPendingShutdown(); // Initialize the system context. createSystemContext(); // Create the system service manager. mSystemServiceManager = new SystemServiceManager(mSystemContext); LocalServices.addService(SystemServiceManager.class, mSystemServiceManager); // Start services. try { startBootstrapServices(); startCoreServices(); startOtherServices(); } catch (Throwable ex) { Slog.e(&quot;System&quot;, &quot;******************************************&quot;); Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex); throw ex; } // For debug builds, log event loop stalls to dropbox for analysis. if (StrictMode.conditionallyEnableDebugLogging()) { Slog.i(TAG, &quot;Enabled StrictMode for system server main thread.&quot;); } // Loop forever. Looper.loop(); throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;); } å¥½å§ï¼Œä»£ç æ¯”è¾ƒå¤šï¼Œæ…¢æ…¢çœ‹ã€‚ã€‚ã€‚ 1234if (System.currentTimeMillis() &lt; EARLIEST_SUPPORTED_TIME) { Slog.w(TAG, &quot;System clock is before 1970; setting to 1970.&quot;); SystemClock.setCurrentTimeMillis(EARLIEST_SUPPORTED_TIME); } é¦–å…ˆåˆ¤æ–­ç³»ç»Ÿå½“å‰æ—¶é—´ï¼Œè‹¥å½“å‰æ—¶é—´å°äº1970å¹´1æœˆ1æ—¥ï¼Œåˆ™ä¸€äº›åˆå§‹åŒ–æ“ä½œå¯èƒ½ä¼šå¤„æ‰€ï¼Œæ‰€ä»¥å½“ç³»ç»Ÿçš„å½“å‰æ—¶é—´å°äº1970å¹´1æœˆ1æ—¥çš„æ—¶å€™ï¼Œè®¾ç½®ç³»ç»Ÿå½“å‰æ—¶é—´ä¸ºè¯¥æ—¶é—´ç‚¹ã€‚ ç„¶åä»£ç ï¼š 12345678if (!SystemProperties.get(&quot;persist.sys.language&quot;).isEmpty()) { final String languageTag = Locale.getDefault().toLanguageTag(); SystemProperties.set(&quot;persist.sys.locale&quot;, languageTag); SystemProperties.set(&quot;persist.sys.language&quot;, &quot;&quot;); SystemProperties.set(&quot;persist.sys.country&quot;, &quot;&quot;); SystemProperties.set(&quot;persist.sys.localevar&quot;, &quot;&quot;); } ä¸»è¦æ˜¯è®¾ç½®ç³»ç»Ÿçš„è¯­è¨€ç¯å¢ƒç­‰ï¼›ä¸‹é¢çš„ä¸»è¦æ˜¯è®¾ç½®è™šæ‹Ÿæœºè¿è¡Œå†…å­˜ï¼ŒåŠ è½½è¿è¡Œåº“ï¼Œè®¾ç½®SystemServerçš„å¼‚æ­¥æ¶ˆæ¯ï¼Œå…·ä½“çš„å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶å¯å‚è§ï¼š androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ ç„¶åä¸‹é¢çš„ä»£ç æ˜¯ï¼š 1234567891011121314151617// Initialize the system context. createSystemContext(); // Create the system service manager. mSystemServiceManager = new SystemServiceManager(mSystemContext); LocalServices.addService(SystemServiceManager.class, mSystemServiceManager); // Start services. try { startBootstrapServices(); startCoreServices(); startOtherServices(); } catch (Throwable ex) { Slog.e(&quot;System&quot;, &quot;******************************************&quot;); Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex); throw ex; } é¦–å…ˆè°ƒç”¨createSystemContext()æ–¹æ³•ï¼š 12345private void createSystemContext() { ActivityThread activityThread = ActivityThread.systemMain(); mSystemContext = activityThread.getSystemContext(); mSystemContext.setTheme(android.R.style.Theme_DeviceDefault_Light_DarkActionBar); } å¯ä»¥çœ‹åˆ°åœ¨SystemServerè¿›ç¨‹ä¸­ä¹Ÿå­˜åœ¨ç€Contextå¯¹è±¡ï¼Œå¹¶ä¸”æ˜¯é€šè¿‡ActivityThread.systemMainæ–¹æ³•åˆ›å»ºcontextçš„ï¼Œè¿™ä¸€éƒ¨åˆ†çš„é€»è¾‘ä»¥åä¼šé€šè¿‡ä»‹ç»Activityçš„å¯åŠ¨æµç¨‹æ¥ä»‹ç»ï¼Œè¿™é‡Œå°±ä¸åœ¨æ‰©å±•ï¼ŒåªçŸ¥é“åœ¨SystemServerè¿›ç¨‹ä¸­ä¹Ÿéœ€è¦åˆ›å»ºContextå¯¹è±¡ã€‚ ç„¶åé€šè¿‡SystemServiceManagerçš„æ„é€ æ–¹æ³•åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„SystemServiceManagerå¯¹è±¡ï¼Œæˆ‘ä»¬çŸ¥é“SystemServerè¿›ç¨‹ä¸»è¦æ˜¯ç”¨æ¥æ„å»ºç³»ç»Ÿå„ç§serviceæœåŠ¡çš„ï¼Œè€ŒSystemServiceManagerå°±æ˜¯è¿™äº›æœåŠ¡çš„ç®¡ç†å¯¹è±¡ã€‚ ç„¶åè°ƒç”¨ï¼š 1LocalServices.addService(SystemServiceManager.class, mSystemServiceManager); æ˜¯å°†SystemServiceManagerå¯¹è±¡ä¿å­˜SystemServerè¿›ç¨‹ä¸­çš„ä¸€ä¸ªæ•°æ®ç»“æ„ä¸­ã€‚ æœ€åå¼€å§‹æ‰§è¡Œï¼š 12345678910// Start services. try { startBootstrapServices(); startCoreServices(); startOtherServices(); } catch (Throwable ex) { Slog.e(&quot;System&quot;, &quot;******************************************&quot;); Slog.e(&quot;System&quot;, &quot;************ Failure starting system services&quot;, ex); throw ex; } é‡Œé¢ä¸»è¦æ¶‰åŠäº†æ˜¯ä¸‰ä¸ªæ–¹æ³•ï¼šstartBootstrapServices() ä¸»è¦ç”¨äºå¯åŠ¨ç³»ç»ŸBootçº§æœåŠ¡startCoreServices() ä¸»è¦ç”¨äºå¯åŠ¨ç³»ç»Ÿæ ¸å¿ƒçš„æœåŠ¡startOtherServices() ä¸»è¦ç”¨äºå¯åŠ¨ä¸€äº›éç´§è¦æˆ–è€…æ˜¯ééœ€è¦åŠæ—¶å¯åŠ¨çš„æœåŠ¡ ä¸‹é¢æˆ‘ä»¬é‡ç‚¹ä»‹ç»è¿™ä¸‰ä¸ªå¯åŠ¨æœåŠ¡çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å¯åŠ¨é‚£äº›ç³»ç»ŸæœåŠ¡å·²ç»å¦‚ä½•å¯åŠ¨ç³»ç»ŸæœåŠ¡ç­‰ã€‚ é¦–å…ˆçœ‹ä¸€ä¸‹startBootstrapServicesæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162private void startBootstrapServices() { // Wait for installd to finish starting up so that it has a chance to // create critical directories such as /data/user with the appropriate // permissions. We need this to complete before we initialize other services. Installer installer = mSystemServiceManager.startService(Installer.class); // Activity manager runs the show. mActivityManagerService = mSystemServiceManager.startService( ActivityManagerService.Lifecycle.class).getService(); mActivityManagerService.setSystemServiceManager(mSystemServiceManager); mActivityManagerService.setInstaller(installer); // Power manager needs to be started early because other services need it. // Native daemons may be watching for it to be registered so it must be ready // to handle incoming binder calls immediately (including being able to verify // the permissions for those calls). mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class); // Now that the power manager has been started, let the activity manager // initialize power management features. mActivityManagerService.initPowerManagement(); // Manages LEDs and display backlight so we need it to bring up the display. mSystemServiceManager.startService(LightsService.class); // Display manager is needed to provide display metrics before package manager // starts up. mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class); // We need the default display before we can initialize the package manager. mSystemServiceManager.startBootPhase(SystemService.PHASE_WAIT_FOR_DEFAULT_DISPLAY); // Only run &quot;core&quot; apps if we're encrypting the device. String cryptState = SystemProperties.get(&quot;vold.decrypt&quot;); if (ENCRYPTING_STATE.equals(cryptState)) { Slog.w(TAG, &quot;Detected encryption in progress - only parsing core apps&quot;); mOnlyCore = true; } else if (ENCRYPTED_STATE.equals(cryptState)) { Slog.w(TAG, &quot;Device encrypted - only parsing core apps&quot;); mOnlyCore = true; } // Start the package manager. Slog.i(TAG, &quot;Package Manager&quot;); mPackageManagerService = PackageManagerService.main(mSystemContext, installer, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore); mFirstBoot = mPackageManagerService.isFirstBoot(); mPackageManager = mSystemContext.getPackageManager(); Slog.i(TAG, &quot;User Service&quot;); ServiceManager.addService(Context.USER_SERVICE, UserManagerService.getInstance()); // Initialize attribute cache used to cache resources from packages. AttributeCache.init(mSystemContext); // Set up the Application instance for the system process and get started. mActivityManagerService.setSystemProcess(); // The sensor service needs access to package manager service, app ops // service, and permissions service, therefore we start it after them. startSensorService(); } é¦–å…ˆæ‰§è¡Œï¼š 1Installer installer = mSystemServiceManager.startService(Installer.class); mSystemServiceManageræ˜¯ç³»ç»ŸæœåŠ¡ç®¡ç†å¯¹è±¡ï¼Œåœ¨mainæ–¹æ³•ä¸­å·²ç»åˆ›å»ºå®Œæˆï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶startServiceæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839public &lt;T extends SystemService&gt; T startService(Class&lt;T&gt; serviceClass) { final String name = serviceClass.getName(); Slog.i(TAG, &quot;Starting &quot; + name); // Create the service. if (!SystemService.class.isAssignableFrom(serviceClass)) { throw new RuntimeException(&quot;Failed to create &quot; + name + &quot;: service must extend &quot; + SystemService.class.getName()); } final T service; try { Constructor&lt;T&gt; constructor = serviceClass.getConstructor(Context.class); service = constructor.newInstance(mContext); } catch (InstantiationException ex) { throw new RuntimeException(&quot;Failed to create service &quot; + name + &quot;: service could not be instantiated&quot;, ex); } catch (IllegalAccessException ex) { throw new RuntimeException(&quot;Failed to create service &quot; + name + &quot;: service must have a public constructor with a Context argument&quot;, ex); } catch (NoSuchMethodException ex) { throw new RuntimeException(&quot;Failed to create service &quot; + name + &quot;: service must have a public constructor with a Context argument&quot;, ex); } catch (InvocationTargetException ex) { throw new RuntimeException(&quot;Failed to create service &quot; + name + &quot;: service constructor threw an exception&quot;, ex); } // Register it. mServices.add(service); // Start it. try { service.onStart(); } catch (RuntimeException ex) { throw new RuntimeException(&quot;Failed to start service &quot; + name + &quot;: onStart threw an exception&quot;, ex); } return service; } å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡åå°„å™¨æ„é€ æ–¹æ³•åˆ›å»ºå‡ºæœåŠ¡ç±»ï¼Œç„¶åæ·»åŠ åˆ°SystemServiceManagerçš„æœåŠ¡åˆ—è¡¨æ•°æ®ä¸­ï¼Œæœ€åè°ƒç”¨äº†service.onStart()æ–¹æ³•ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ é€’çš„æ˜¯Installer.classï¼Œæˆ‘ä»¬è¿™é‡Œæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹Installerçš„onStartæ–¹æ³•ï¼š 12345@Override public void onStart() { Slog.i(TAG, &quot;Waiting for installd to be ready.&quot;); mInstaller.waitForConnection(); } å¾ˆç®€å•å°±æ˜¯æ‰§è¡Œäº†mInstallerçš„waitForConnectionæ–¹æ³•ï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹Installerç±»ï¼Œè¯¥ç±»æ˜¯ç³»ç»Ÿå®‰è£…apkæ—¶çš„ä¸€ä¸ªæœåŠ¡ç±»ï¼Œç»§æ‰¿SystemServiceï¼ˆç³»ç»ŸæœåŠ¡çš„ä¸€ä¸ªæŠ½è±¡æ¥å£ï¼‰ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨å®ŒæˆInstalleræœåŠ¡ä¹‹åæ‰èƒ½å¯åŠ¨å…¶ä»–çš„ç³»ç»ŸæœåŠ¡ã€‚ç„¶åæŸ¥çœ‹waitForConnectionï¼ˆï¼‰æ–¹æ³•ï¼š 123456789public void waitForConnection() { for (;;) { if (execute(&quot;ping&quot;) &gt;= 0) { return; } Slog.w(TAG, &quot;installd not ready&quot;); SystemClock.sleep(1000); } } é€šè¿‡è¿½è¸ªä»£ç å¯ä»¥å‘ç°ï¼Œå…¶åœ¨ä¸æ–­çš„é€šè¿‡pingå‘½ä»¤è¿æ¥Zygoteè¿›ç¨‹ï¼ˆSystemServerå’ŒZygoteè¿›ç¨‹é€šè¿‡socketæ–¹å¼é€šè®¯ï¼Œå…¶ä»–è¿›ç¨‹é€šè¿‡Binderæ–¹å¼é€šè®¯ï¼‰ï¼› æ€»ç»“ï¼šåœ¨å¼€å§‹æ‰§è¡Œå¯åŠ¨æœåŠ¡ä¹‹å‰æ€»æ˜¯ä¼šå…ˆå°è¯•é€šè¿‡socketæ–¹å¼è¿æ¥Zygoteè¿›ç¨‹ï¼Œåœ¨æˆåŠŸè¿æ¥ä¹‹åæ‰ä¼šå¼€å§‹å¯åŠ¨å…¶ä»–æœåŠ¡ã€‚ ç»§ç»­æ¥çœ‹startBootstrapServicesæ–¹æ³•ï¼š 12345// Activity manager runs the show. mActivityManagerService = mSystemServiceManager.startService( ActivityManagerService.Lifecycle.class).getService(); mActivityManagerService.setSystemServiceManager(mSystemServiceManager); mActivityManagerService.setInstaller(installer); è¿™æ®µä»£ç ä¸»è¦æ˜¯ç”¨äºå¯åŠ¨ActivityManagerServiceæœåŠ¡ï¼Œå¹¶ä¸ºå…¶è®¾ç½®SysServiceManagerå’ŒInstallerã€‚ActivityManagerServiceæ˜¯ç³»ç»Ÿä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æœåŠ¡ï¼ŒActivityï¼Œserviceï¼ŒBroadcastï¼ŒcontentProvideréƒ½éœ€è¦é€šè¿‡å…¶ä½™ç³»ç»Ÿäº¤äº’ã€‚ é¦–å…ˆçœ‹ä¸€ä¸‹Lifecycleç±»çš„å®šä¹‰ï¼š 1234567891011121314151617public static final class Lifecycle extends SystemService { private final ActivityManagerService mService; public Lifecycle(Context context) { super(context); mService = new ActivityManagerService(context); } @Override public void onStart() { mService.start(); } public ActivityManagerService getService() { return mService; } } å¯ä»¥çœ‹åˆ°å…¶å®ActivityManagerServiceçš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ï¼Œåœ¨å…¶æ„é€ æ–¹æ³•ä¸­ä¼šåˆ›å»ºä¸€ä¸ªActivityManagerServiceï¼Œé€šè¿‡åˆšåˆšå¯¹InstalleræœåŠ¡çš„åˆ†ææˆ‘ä»¬çŸ¥é“ï¼ŒSystemServiceManagerçš„startServiceæ–¹æ³•ä¼šè°ƒç”¨æœåŠ¡çš„onStart()æ–¹æ³•ï¼Œè€Œåœ¨Lifecycleç±»çš„å®šä¹‰ä¸­æˆ‘ä»¬çœ‹åˆ°å…¶onStartï¼ˆï¼‰æ–¹æ³•ç›´æ¥è°ƒç”¨äº†mService.start()æ–¹æ³•ï¼ŒmServiceæ˜¯Lifecycleç±»ä¸­å¯¹ActivityManagerServiceçš„å¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹ActivityManagerServiceçš„startæ–¹æ³•çš„å®ç°ï¼š 123456789private void start() { Process.removeAllProcessGroups(); mProcessCpuThread.start(); mBatteryStatsService.publish(mContext); mAppOpsService.publish(mContext); Slog.d(&quot;AppOps&quot;, &quot;AppOpsService published&quot;); LocalServices.addService(ActivityManagerInternal.class, new LocalService()); } ç”±äºActivityManagerServiceçš„åˆ›å»ºè¿‡ç¨‹æ¯”è¾ƒå¤æ‚è¿™é‡Œä¸åšè¿‡å¤šçš„åˆ†æäº†ï¼Œä¸»è¦æ˜¯åœ¨å…¶æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–äº†ä¸€äº›å˜é‡ã€‚ ç„¶åæ˜¯å¯åŠ¨PowerManagerServiceæœåŠ¡ï¼š 1mPowerManagerService = mSystemServiceManager.startService(PowerManagerService.class); å¯åŠ¨æ–¹å¼è·Ÿä¸Šé¢çš„ActivityManagerServiceæœåŠ¡ç›¸ä¼¼éƒ½ä¼šè°ƒç”¨å…¶æ„é€ æ–¹æ³•å’ŒonStartæ–¹æ³•ï¼ŒPowerManagerServiceä¸»è¦ç”¨äºè®¡ç®—ç³»ç»Ÿä¸­å’ŒPowerç›¸å…³çš„è®¡ç®—ï¼Œç„¶åå†³ç­–ç³»ç»Ÿåº”è¯¥å¦‚ä½•ååº”ã€‚åŒæ—¶åè°ƒPowerå¦‚ä½•ä¸ç³»ç»Ÿå…¶å®ƒæ¨¡å—çš„äº¤äº’ï¼Œæ¯”å¦‚æ²¡æœ‰ç”¨æˆ·æ´»åŠ¨æ—¶ï¼Œå±å¹•å˜æš—ç­‰ç­‰ã€‚ ç„¶åæ˜¯å¯åŠ¨LightsServiceæœåŠ¡ 1mSystemServiceManager.startService(LightsService.class); ä¸»è¦æ˜¯æ‰‹æœºä¸­å…³äºé—ªå…‰ç¯ï¼ŒLEDç­‰ç›¸å…³çš„æœåŠ¡ï¼›ä¹Ÿæ˜¯ä¼šè°ƒç”¨LightsServiceçš„æ„é€ æ–¹æ³•å’ŒonStartæ–¹æ³•ï¼› ç„¶åæ˜¯å¯åŠ¨DisplayManagerServiceæœåŠ¡ 1mDisplayManagerService = mSystemServiceManager.startService(DisplayManagerService.class); ä¸»è¦æ˜¯æ‰‹æœºæ˜¾ç¤ºæ–¹é¢çš„æœåŠ¡ï¼› ç„¶åæ˜¯å¯åŠ¨PackageManagerServiceï¼Œè¯¥æœåŠ¡ä¹Ÿæ˜¯androidç³»ç»Ÿä¸­ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æœåŠ¡ï¼ŒåŒ…æ‹¬å¤šapkæ–‡ä»¶çš„å®‰è£…ï¼Œè§£æï¼Œåˆ é™¤ï¼Œå¸è½½ç­‰ç­‰æ“ä½œã€‚ 12345Slog.i(TAG, &quot;Package Manager&quot;); mPackageManagerService = PackageManagerService.main(mSystemContext, installer, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore); mFirstBoot = mPackageManagerService.isFirstBoot(); mPackageManager = mSystemContext.getPackageManager(); å¯ä»¥çœ‹åˆ°PackageManagerServiceæœåŠ¡çš„å¯åŠ¨æ–¹å¼ä¸å…¶ä»–æœåŠ¡çš„å¯åŠ¨æ–¹å¼æœ‰ä¸€äº›åŒºåˆ«ï¼Œç›´æ¥è°ƒç”¨äº†PackageManagerServiceçš„é™æ€mainæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶mainæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567public static PackageManagerService main(Context context, Installer installer, boolean factoryTest, boolean onlyCore) { PackageManagerService m = new PackageManagerService(context, installer, factoryTest, onlyCore); ServiceManager.addService(&quot;package&quot;, m); return m; } å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯ç›´æ¥ä½¿ç”¨newçš„æ–¹å¼åˆ›å»ºäº†ä¸€ä¸ªPackageManagerServiceå¯¹è±¡ï¼Œå¹¶åœ¨å…¶æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–ç›¸å…³å˜é‡ï¼Œæœ€åè°ƒç”¨äº†ServiceManager.addServiceæ–¹æ³•ï¼Œä¸»è¦æ˜¯é€šè¿‡Binderæœºåˆ¶ä¸JNIå±‚äº¤äº’ï¼Œè¿™é‡Œä¸å†æ‰©å±•ã€‚ ç„¶åå¯åŠ¨UserManagerServiceå’ŒSensorServiceï¼Œè‡³æ­¤startBootstrapServicesæ–¹æ³•æ‰§è¡Œå®Œæˆã€‚ ç„¶åæŸ¥çœ‹startCoreServicesæ–¹æ³•ï¼š 1234567891011121314private void startCoreServices() { // Tracks the battery level. Requires LightService. mSystemServiceManager.startService(BatteryService.class); // Tracks application usage stats. mSystemServiceManager.startService(UsageStatsService.class); mActivityManagerService.setUsageStatsManager( LocalServices.getService(UsageStatsManagerInternal.class)); // Update after UsageStatsService is available, needed before performBootDexOpt. mPackageManagerService.getUsageStatsIfNoPackageUsageInfo(); // Tracks whether the updatable WebView is in a ready state and watches for update installs. mSystemServiceManager.startService(WebViewUpdateService.class); } å¯ä»¥çœ‹åˆ°è¿™é‡Œå¯åŠ¨äº†BatteryServiceï¼ˆç”µæ± ç›¸å…³æœåŠ¡ï¼‰ï¼ŒUsageStatsServiceï¼ŒWebViewUpdateServiceæœåŠ¡ç­‰ã€‚ æœ€åçœ‹ä¸€ä¸‹startOtherServicesæ–¹æ³•ï¼Œä¸»è¦ç”¨äºå¯åŠ¨ç³»ç»Ÿä¸­å…¶ä»–çš„æœåŠ¡ï¼Œä»£ç å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸è´´ä»£ç äº†ï¼Œå¯åŠ¨çš„æµç¨‹å’ŒActivityManagerServiceçš„æµç¨‹ç±»ä¼¼ï¼Œä¼šè°ƒç”¨æœåŠ¡çš„æ„é€ æ–¹æ³•ä¸onStartæ–¹æ³•åˆå§‹åŒ–å˜é‡ã€‚ æ€»ç»“ï¼š SystemServerè¿›ç¨‹æ˜¯androidä¸­ä¸€ä¸ªå¾ˆé‡è¦çš„è¿›ç¨‹ç”±Zygoteè¿›ç¨‹å¯åŠ¨ï¼› SystemServerè¿›ç¨‹ä¸»è¦ç”¨äºå¯åŠ¨ç³»ç»Ÿä¸­çš„æœåŠ¡ï¼› SystemServerè¿›ç¨‹å¯åŠ¨æœåŠ¡çš„å¯åŠ¨å‡½æ•°ä¸ºmainå‡½æ•°ï¼› SystemServeråœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­é¦–å…ˆä¼šåˆå§‹åŒ–ä¸€äº›ç³»ç»Ÿå˜é‡ï¼ŒåŠ è½½ç±»åº“ï¼Œåˆ›å»ºContextå¯¹è±¡ï¼Œåˆ›å»ºSystemServiceManagerå¯¹è±¡ç­‰ä¹‹åæ‰å¼€å§‹å¯åŠ¨ç³»ç»ŸæœåŠ¡ï¼› SystemServerè¿›ç¨‹å°†ç³»ç»ŸæœåŠ¡åˆ†ä¸ºä¸‰ç±»ï¼šbootæœåŠ¡ï¼ŒcoreæœåŠ¡å’ŒotheræœåŠ¡ï¼Œå¹¶é€æ­¥å¯åŠ¨ SertemServerè¿›ç¨‹åœ¨å°è¯•å¯åŠ¨æœåŠ¡ä¹‹å‰ä¼šé¦–å…ˆå°è¯•ä¸Zygoteå»ºç«‹socketé€šè®¯ï¼Œåªæœ‰é€šè®¯æˆåŠŸä¹‹åæ‰ä¼šå¼€å§‹å°è¯•å¯åŠ¨æœåŠ¡ï¼› åˆ›å»ºçš„ç³»ç»ŸæœåŠ¡è¿‡ç¨‹ä¸­ä¸»è¦é€šè¿‡SystemServiceManagerå¯¹è±¡æ¥ç®¡ç†ï¼Œé€šè¿‡è°ƒç”¨æœåŠ¡å¯¹è±¡çš„æ„é€ æ–¹æ³•å’ŒonStartæ–¹æ³•åˆå§‹åŒ–æœåŠ¡çš„ç›¸å…³å˜é‡ï¼› æœåŠ¡å¯¹è±¡éƒ½æœ‰è‡ªå·±çš„å¼‚æ­¥æ¶ˆæ¯å¯¹è±¡ï¼Œå¹¶è¿è¡Œåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹","link":"/2020/09/11/SystemServer%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"title":"Handlerå¼‚æ­¥ä¼‘æ¯æœºåˆ¶","text":"çŸ¥ä¹ä¸Šçœ‹äº†ä¸€ç¯‡éå¸¸ä¸é”™çš„åšæ–‡ï¼šæœ‰æ²¡æœ‰å¿…è¦é˜…è¯»ANDROIDæºç ç—›å®šæ€è¿‡ï¼Œä¸ºäº†æ›´å¥½çš„æ·±å…¥androidä½“ç³»ï¼Œå†³å®šå­¦ä¹ android frameworkå±‚æºç ï¼Œå°±ä»æœ€ç®€å•çš„androidå¼‚æ­¥æ¶ˆæ¯æœºåˆ¶å¼€å§‹å§ã€‚ ï¼ˆä¸€ï¼‰Handlerçš„å¸¸è§„ä½¿ç”¨æ–¹å¼ 12345678910111213141516171819202122232425262728293031323334353637public class MainActivity extends AppCompatActivity { public static final String TAG = MainActivity.class.getSimpleName(); private TextView texttitle = null; /** * åœ¨ä¸»çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œå¹¶å®ç°å¯¹åº”çš„handleMessageæ–¹æ³• */ public static Handler mHandler = new Handler() { @Override public void handleMessage(Message msg) { if (msg.what == 101) { Log.i(TAG, &quot;æ¥æ”¶åˆ°handleræ¶ˆæ¯...&quot;); } } }; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); texttitle = (TextView) findViewById(R.id.texttitle); texttitle.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { new Thread() { @Override public void run() { // åœ¨å­çº¿ç¨‹ä¸­å‘é€å¼‚æ­¥æ¶ˆæ¯ mHandler.sendEmptyMessage(101); } }.start(); } }); }} å¯ä»¥çœ‹å‡ºï¼Œä¸€èˆ¬handlerçš„ä½¿ç”¨æ–¹å¼éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œç„¶ååœ¨å­çº¿ç¨‹ä¸­è°ƒç”¨mHandler.sendEmptyMessage();æ–¹æ³•ï¼Œç„¶ä¹ˆè¿™é‡Œæœ‰ä¸€ä¸ªç–‘é—®äº†ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerä¹ˆï¼Ÿ ï¼ˆäºŒï¼‰å¦‚ä½•åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Ÿ æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œçœ‹çœ‹ç»“æœ: 123456789101112131415161718texttitle.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { new Thread() { @Override public void run() { Handler mHandler = new Handler() { @Override public void handleMessage(Message msg) { if (msg.what == 101) { Log.i(TAG, &quot;åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œå¹¶æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚ã€‚ã€‚&quot;); } } }; } }.start(); } }); ç‚¹å‡»æŒ‰é’®å¹¶è¿è¡Œè¿™æ®µä»£ç ï¼š å¯ä»¥çœ‹å‡ºæ¥åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerå¯¹è±¡å‡ºé”™äº†ï¼Œéš¾é“Handlerå¯¹è±¡çš„å®šä¹‰æˆ–è€…æ˜¯åˆå§‹åŒ–åªèƒ½åœ¨ä¸»çº¿ç¨‹ä¸­ï¼Ÿå…¶å®ä¸æ˜¯è¿™æ ·çš„ï¼Œé”™è¯¯ä¿¡æ¯ä¸­æç¤ºçš„å·²ç»å¾ˆæ˜æ˜¾äº†ï¼Œåœ¨åˆå§‹åŒ–Handlerå¯¹è±¡ä¹‹å‰éœ€è¦è°ƒç”¨Looper.prepare()æ–¹æ³•ï¼Œé‚£ä¹ˆå¥½äº†ï¼Œæˆ‘ä»¬æ·»åŠ è¿™å¥ä»£ç å†æ¬¡æ‰§è¡Œä¸€æ¬¡ï¼š 12345678910111213141516171819texttitle.setOnClickListener(new View.OnClickListener() { @Override public void onClick(View v) { new Thread() { @Override public void run() { Looper.prepare(); Handler mHandler = new Handler() { @Override public void handleMessage(Message msg) { if (msg.what == 101) { Log.i(TAG, &quot;åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œå¹¶æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚ã€‚ã€‚&quot;); } } }; } }.start(); } }); å†æ¬¡ç‚¹å‡»æŒ‰é’®æ‰§è¡Œè¯¥æ®µä»£ç ä¹‹åï¼Œç¨‹åºå·²ç»ä¸ä¼šæŠ¥é”™äº†ï¼Œé‚£ä¹ˆè¿™è¯´æ˜åˆå§‹åŒ–Handlerå¯¹è±¡çš„æ—¶å€™æˆ‘ä»¬æ˜¯éœ€è¦è°ƒç”¨Looper.prepare()çš„ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹ä¸­ä¸ºä»€ä¹ˆå¯ä»¥ç›´æ¥åˆå§‹åŒ–Handlerå‘¢ï¼Ÿ å…¶å®ä¸æ˜¯è¿™æ ·çš„ï¼Œåœ¨Appåˆå§‹åŒ–çš„æ—¶å€™ä¼šæ‰§è¡ŒActivityThreadçš„mainæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142public static void main(String[] args) { Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;ActivityThreadMain&quot;); SamplingProfilerIntegration.start(); // CloseGuard defaults to true and can be quite spammy. We // disable it here, but selectively enable it later (via // StrictMode) on debug builds, but using DropBox, not logs. CloseGuard.setEnabled(false); Environment.initForCurrentUser(); // Set the reporter for event logging in libcore EventLogger.setReporter(new EventLoggingReporter()); AndroidKeyStoreProvider.install(); // Make sure TrustedCertificateStore looks in the right place for CA certificates final File configDir = Environment.getUserConfigDirectory(UserHandle.myUserId()); TrustedCertificateStore.setDefaultUserDirectory(configDir); Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;); Looper.prepareMainLooper(); ActivityThread thread = new ActivityThread(); thread.attach(false); if (sMainThreadHandler == null) { sMainThreadHandler = thread.getHandler(); } if (false) { Looper.myLooper().setMessageLogging(new LogPrinter(Log.DEBUG, &quot;ActivityThread&quot;)); } // End of event ActivityThreadMain. Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); Looper.loop(); throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;); } å¯ä»¥çœ‹åˆ°åŸæ¥Looper.prepare()æ–¹æ³•åœ¨è¿™é‡Œè°ƒç”¨äº†ï¼Œæ‰€ä»¥åœ¨å…¶ä»–åœ°æ–¹æˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åˆå§‹åŒ–Handleräº†ã€‚ å¹¶ä¸”æˆ‘ä»¬å¯ä»¥çœ‹åˆ°è¿˜è°ƒç”¨äº†ï¼šLooper.loop()æ–¹æ³•ï¼Œé€šè¿‡å‚è€ƒé˜…è¯»å…¶ä»–æ–‡ç« æˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸€ä¸ªHandlerçš„æ ‡å‡†å†™æ³•å…¶å®æ˜¯è¿™æ ·çš„ï¼š 12345678910Looper.prepare();Handler mHandler = new Handler() { @Override public void handleMessage(Message msg) { if (msg.what == 101) { Log.i(TAG, &quot;åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œå¹¶æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚ã€‚ã€‚&quot;); } }};Looper.loop(); ï¼ˆä¸‰ï¼‰æŸ¥çœ‹Handleræºç 1ï¼‰æŸ¥çœ‹Looper.prepare()æ–¹æ³• 12345678910111213141516171819// sThreadLocal.get() will return null unless you've called prepare(). static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();/** Initialize the current thread as a looper. * This gives you a chance to create handlers that then reference * this looper, before actually starting the loop. Be sure to call * {@link #loop()} after calling this method, and end it by calling * {@link #quit()}. */ public static void prepare() { prepare(true); } private static void prepare(boolean quitAllowed) { if (sThreadLocal.get() != null) { throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;); } sThreadLocal.set(new Looper(quitAllowed)); } å¯ä»¥çœ‹åˆ°Looperä¸­æœ‰ä¸€ä¸ªThreadLocalæˆå‘˜å˜é‡ï¼Œç†Ÿæ‚‰JDKçš„åŒå­¦åº”è¯¥çŸ¥é“ï¼Œå½“ä½¿ç”¨ThreadLocalç»´æŠ¤å˜é‡æ—¶ï¼ŒThreadLocalä¸ºæ¯ä¸ªä½¿ç”¨è¯¥å˜é‡çš„çº¿ç¨‹æä¾›ç‹¬ç«‹çš„å˜é‡å‰¯æœ¬ï¼Œæ‰€ä»¥æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½å¯ä»¥ç‹¬ç«‹åœ°æ”¹å˜è‡ªå·±çš„å‰¯æœ¬ï¼Œè€Œä¸ä¼šå½±å“å…¶å®ƒçº¿ç¨‹æ‰€å¯¹åº”çš„å‰¯æœ¬ã€‚å…·ä½“å‚è€ƒï¼šå½»åº•ç†è§£ThreadLocalç”±æ­¤å¯ä»¥çœ‹å‡ºåœ¨æ¯ä¸ªçº¿ç¨‹ä¸­Looper.prepare()èƒ½ä¸”åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥å°è¯•ä¸€ä¸‹è°ƒç”¨ä¸¤æ¬¡çš„æƒ…å†µã€‚ 1234567891011121314/** * è¿™é‡ŒLooper.prepare()æ–¹æ³•è°ƒç”¨äº†ä¸¤æ¬¡*/Looper.prepare();Looper.prepare();Handler mHandler = new Handler() { @Override public void handleMessage(Message msg) { if (msg.what == 101) { Log.i(TAG, &quot;åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œå¹¶æ¥æ”¶åˆ°æ¶ˆæ¯ã€‚ã€‚ã€‚&quot;); } }};Looper.loop(); å†æ¬¡è¿è¡Œç¨‹åºï¼Œç‚¹å‡»æŒ‰é’®ï¼Œæ‰§è¡Œè¯¥æ®µä»£ç ï¼šå¯ä»¥çœ‹åˆ°ç¨‹åºå‡ºé”™ï¼Œå¹¶æç¤ºprepareä¸­çš„Excetionä¿¡æ¯ã€‚ æˆ‘ä»¬ç»§ç»­çœ‹Looperå¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å…¶æ„é€ æ–¹æ³•ä¸­åˆå§‹åŒ–äº†ä¸€ä¸ªMessageQueueå¯¹è±¡ï¼š 1234private Looper(boolean quitAllowed) { mQueue = new MessageQueue(quitAllowed); mThread = Thread.currentThread(); } ç»¼ä¸Šå°ç»“ï¼ˆ1ï¼‰ï¼šLooper.prepare()æ–¹æ³•åˆå§‹è¯äº†ä¸€ä¸ªLooperå¯¹è±¡å¹¶å…³è”åœ¨ä¸€ä¸ªMessageQueueå¯¹è±¡ï¼Œå¹¶ä¸”ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ªLooperå¯¹è±¡ï¼Œåªæœ‰ä¸€ä¸ªMessageQueueå¯¹è±¡ã€‚ 2ï¼‰æŸ¥çœ‹Handlerå¯¹è±¡çš„æ„é€ æ–¹æ³• 12345678910111213141516171819public Handler(Callback callback, boolean async) { if (FIND_POTENTIAL_LEAKS) { final Class&lt;? extends Handler&gt; klass = getClass(); if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp; (klass.getModifiers() &amp; Modifier.STATIC) == 0) { Log.w(TAG, &quot;The following Handler class should be static or leaks might occur: &quot; + klass.getCanonicalName()); } } mLooper = Looper.myLooper(); if (mLooper == null) { throw new RuntimeException( &quot;Can't create handler inside thread that has not called Looper.prepare()&quot;); } mQueue = mLooper.mQueue; mCallback = callback; mAsynchronous = async; } å¯ä»¥çœ‹å‡ºåœ¨Handlerçš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¸»è¦åˆå§‹åŒ–äº†ä¸€ä¸‹å˜é‡ï¼Œå¹¶åˆ¤æ–­Handlerå¯¹è±¡çš„åˆå§‹åŒ–ä¸åº”å†å†…éƒ¨ç±»ï¼Œé™æ€ç±»ï¼ŒåŒ¿åç±»ä¸­ï¼Œå¹¶ä¸”ä¿å­˜äº†å½“å‰çº¿ç¨‹ä¸­çš„Looperå¯¹è±¡ã€‚ç»¼ä¸Šå°ç»“ï¼ˆ2ï¼‰ï¼šLooper.prepare()æ–¹æ³•åˆå§‹è¯äº†ä¸€ä¸ªLooperå¯¹è±¡å¹¶å…³è”åœ¨ä¸€ä¸ªMessageQueueå¯¹è±¡ï¼Œå¹¶ä¸”ä¸€ä¸ªçº¿ç¨‹ä¸­åªæœ‰ä¸€ä¸ªLooperå¯¹è±¡ï¼Œåªæœ‰ä¸€ä¸ªMessageQueueå¯¹è±¡ã€‚è€ŒHandlerçš„æ„é€ æ–¹æ³•åˆ™åœ¨Handlerå†…éƒ¨ç»´æŠ¤äº†å½“å‰çº¿ç¨‹çš„Looperå¯¹è±¡ 3ï¼‰æŸ¥çœ‹handler.sendMessage(msg)æ–¹æ³•ä¸€èˆ¬çš„ï¼Œæˆ‘ä»¬å‘é€å¼‚æ­¥æ¶ˆæ¯çš„æ—¶å€™ä¼šè¿™æ ·è°ƒç”¨ï¼š 1mHandler.sendMessage(new Message()); é€šè¿‡ä¸æ–­çš„è·Ÿè¿›æºä»£ç ï¼Œå…¶æœ€åä¼šè°ƒç”¨ï¼š 1234567private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) { msg.target = this; if (mAsynchronous) { msg.setAsynchronous(true); } return queue.enqueueMessage(msg, uptimeMillis); } åŸæ¥msg.targetå°±æ˜¯Handlerå¯¹è±¡æœ¬èº«ï¼›è€Œè¿™é‡Œçš„queueå¯¹è±¡å°±æ˜¯æˆ‘ä»¬çš„Handlerå†…éƒ¨ç»´æŠ¤çš„Looperå¯¹è±¡å…³è”çš„MessageQueueå¯¹è±¡ã€‚æŸ¥çœ‹messagequeueå¯¹è±¡çš„enqueueMessageæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253boolean enqueueMessage(Message msg, long when) { if (msg.target == null) { throw new IllegalArgumentException(&quot;Message must have a target.&quot;); } if (msg.isInUse()) { throw new IllegalStateException(msg + &quot; This message is already in use.&quot;); } synchronized (this) { if (mQuitting) { IllegalStateException e = new IllegalStateException( msg.target + &quot; sending message to a Handler on a dead thread&quot;); Log.w(TAG, e.getMessage(), e); msg.recycle(); return false; } msg.markInUse(); msg.when = when; Message p = mMessages; boolean needWake; if (p == null || when == 0 || when &lt; p.when) { // New head, wake up the event queue if blocked. msg.next = p; mMessages = msg; needWake = mBlocked; } else { // Inserted within the middle of the queue. Usually we don't have to wake // up the event queue unless there is a barrier at the head of the queue // and the message is the earliest asynchronous message in the queue. needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; for (;;) { prev = p; p = p.next; if (p == null || when &lt; p.when) { break; } if (needWake &amp;&amp; p.isAsynchronous()) { needWake = false; } } msg.next = p; // invariant: p == prev.next prev.next = msg; } // We can assume mPtr != 0 because mQuitting is false. if (needWake) { nativeWake(mPtr); } } return true; } å¯ä»¥çœ‹åˆ°è¿™é‡ŒMessageQueueå¹¶æ²¡æœ‰ä½¿ç”¨åˆ—è¡¨å°†æ‰€æœ‰çš„Messageä¿å­˜èµ·æ¥ï¼Œè€Œæ˜¯ä½¿ç”¨Message.nextä¿å­˜ä¸‹ä¸€ä¸ªMessageï¼Œä»è€ŒæŒ‰ç…§æ—¶é—´å°†æ‰€æœ‰çš„Messageæ’åºï¼› 4ï¼‰æŸ¥çœ‹Looper.Loop()æ–¹æ³• 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950/** * Run the message queue in this thread. Be sure to call * {@link #quit()} to end the loop. */ public static void loop() { final Looper me = myLooper(); if (me == null) { throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn't called on this thread.&quot;); } final MessageQueue queue = me.mQueue; // Make sure the identity of this thread is that of the local process, // and keep track of what that identity token actually is. Binder.clearCallingIdentity(); final long ident = Binder.clearCallingIdentity(); for (;;) { Message msg = queue.next(); // might block if (msg == null) { // No message indicates that the message queue is quitting. return; } // This must be in a local variable, in case a UI event sets the logger Printer logging = me.mLogging; if (logging != null) { logging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot; &quot; + msg.callback + &quot;: &quot; + msg.what); } msg.target.dispatchMessage(msg); if (logging != null) { logging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot; + msg.target + &quot; &quot; + msg.callback); } // Make sure that during the course of dispatching the // identity of the thread wasn't corrupted. final long newIdent = Binder.clearCallingIdentity(); if (ident != newIdent) { Log.wtf(TAG, &quot;Thread identity changed from 0x&quot; + Long.toHexString(ident) + &quot; to 0x&quot; + Long.toHexString(newIdent) + &quot; while dispatching to &quot; + msg.target.getClass().getName() + &quot; &quot; + msg.callback + &quot; what=&quot; + msg.what); } msg.recycleUnchecked(); } } å¯ä»¥çœ‹åˆ°æ–¹æ³•çš„å†…å®¹è¿˜æ˜¯æ¯”è¾ƒå¤šçš„ã€‚å¯ä»¥çœ‹åˆ°Looper.loop()æ–¹æ³•é‡Œèµ·äº†ä¸€ä¸ªæ­»å¾ªç¯ï¼Œä¸æ–­çš„åˆ¤æ–­MessageQueueä¸­çš„æ¶ˆæ¯æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™ç›´æ¥returnæ‰ï¼Œç„¶åæ‰§è¡Œqueue.next()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105Message next() { // Return here if the message loop has already quit and been disposed. // This can happen if the application tries to restart a looper after quit // which is not supported. final long ptr = mPtr; if (ptr == 0) { return null; } int pendingIdleHandlerCount = -1; // -1 only during first iteration int nextPollTimeoutMillis = 0; for (;;) { if (nextPollTimeoutMillis != 0) { Binder.flushPendingCommands(); } nativePollOnce(ptr, nextPollTimeoutMillis); synchronized (this) { // Try to retrieve the next message. Return if found. final long now = SystemClock.uptimeMillis(); Message prevMsg = null; Message msg = mMessages; if (msg != null &amp;&amp; msg.target == null) { // Stalled by a barrier. Find the next asynchronous message in the queue. do { prevMsg = msg; msg = msg.next; } while (msg != null &amp;&amp; !msg.isAsynchronous()); } if (msg != null) { if (now &lt; msg.when) { // Next message is not ready. Set a timeout to wake up when it is ready. nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE); } else { // Got a message. mBlocked = false; if (prevMsg != null) { prevMsg.next = msg.next; } else { mMessages = msg.next; } msg.next = null; if (DEBUG) Log.v(TAG, &quot;Returning message: &quot; + msg); msg.markInUse(); return msg; } } else { // No more messages. nextPollTimeoutMillis = -1; } // Process the quit message now that all pending messages have been handled. if (mQuitting) { dispose(); return null; } // If first time idle, then get the number of idlers to run. // Idle handles only run if the queue is empty or if the first message // in the queue (possibly a barrier) is due to be handled in the future. if (pendingIdleHandlerCount &lt; 0 &amp;&amp; (mMessages == null || now &lt; mMessages.when)) { pendingIdleHandlerCount = mIdleHandlers.size(); } if (pendingIdleHandlerCount &lt;= 0) { // No idle handlers to run. Loop and wait some more. mBlocked = true; continue; } if (mPendingIdleHandlers == null) { mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)]; } mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers); } // Run the idle handlers. // We only ever reach this code block during the first iteration. for (int i = 0; i &lt; pendingIdleHandlerCount; i++) { final IdleHandler idler = mPendingIdleHandlers[i]; mPendingIdleHandlers[i] = null; // release the reference to the handler boolean keep = false; try { keep = idler.queueIdle(); } catch (Throwable t) { Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t); } if (!keep) { synchronized (this) { mIdleHandlers.remove(idler); } } } // Reset the idle handler count to 0 so we do not run them again. pendingIdleHandlerCount = 0; // While calling an idle handler, a new message could have been delivered // so go back and look again for a pending message without waiting. nextPollTimeoutMillis = 0; } } å¯ä»¥çœ‹åˆ°å…¶å¤§æ¦‚çš„å®ç°é€»è¾‘å°±æ˜¯Messageçš„å‡ºæ ˆæ“ä½œï¼Œé‡Œé¢å¯èƒ½å¯¹çº¿ç¨‹ï¼Œå¹¶å‘æ§åˆ¶åšäº†ä¸€äº›é™åˆ¶ç­‰ã€‚è·å–åˆ°æ ˆé¡¶çš„Messageå¯¹è±¡ä¹‹åå¼€å§‹æ‰§è¡Œï¼š1msg.target.dispatchMessage(msg); é‚£ä¹ˆmsg.targetæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡è¿½è¸ªå¯ä»¥çŸ¥é“å°±æ˜¯æˆ‘ä»¬å®šä¹‰çš„Handlerå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹Handlerç±»çš„dispatchMessageæ–¹æ³•ï¼š 123456789101112131415/** * Handle system messages here. */ public void dispatchMessage(Message msg) { if (msg.callback != null) { handleCallback(msg); } else { if (mCallback != null) { if (mCallback.handleMessage(msg)) { return; } } handleMessage(msg); } } å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†callbackï¼ˆRunnableå¯¹è±¡ï¼‰çš„è¯ï¼Œåˆ™ä¼šç›´æ¥è°ƒç”¨handleCallbackæ–¹æ³•ï¼š 123private static void handleCallback(Message message) { message.callback.run(); } å³ï¼Œå¦‚æœæˆ‘ä»¬åœ¨åˆå§‹åŒ–Handlerçš„æ—¶å€™è®¾ç½®äº†callbackï¼ˆRunnableï¼‰å¯¹è±¡ï¼Œåˆ™ç›´æ¥è°ƒç”¨runæ–¹æ³•ã€‚æ¯”å¦‚æˆ‘ä»¬ç»å¸¸å†™çš„runOnUiThreadæ–¹æ³•ï¼š 123456runOnUiThread(new Runnable() { @Override public void run() { } }); çœ‹å…¶å†…éƒ¨å®ç°ï¼š 1234567public final void runOnUiThread(Runnable action) { if (Thread.currentThread() != mUiThread) { mHandler.post(action); } else { action.run(); } } è€Œå¦‚æœmsg.callbackä¸ºç©ºçš„è¯ï¼Œä¼šç›´æ¥è°ƒç”¨æˆ‘ä»¬çš„mCallback.handleMessage(msg)ï¼Œå³handlerçš„handlerMessageæ–¹æ³•ã€‚ç”±äºHandlerå¯¹è±¡æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„ï¼Œæ‰€ä»¥handlerçš„handlerMessageæ–¹æ³•çš„æ‰§è¡Œä¹Ÿä¼šåœ¨ä¸»çº¿ç¨‹ä¸­ã€‚ ç»¼ä¸Šå¯ä»¥çŸ¥é“ï¼š1ï¼‰ä¸»çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œç›´æ¥æ‰§è¡Œï¼š 123456Handler mHandler = new Handler() { @Override public void handleMessage(Message msg) { super.handleMessage(msg); }}; è€Œå¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­å®šä¹‰Handlerï¼Œåˆ™æ ‡å‡†çš„å†™æ³•ä¸ºï¼š 1234567891011// åˆå§‹åŒ–è¯¥çº¿ç¨‹Looperï¼ŒMessageQueueï¼Œæ‰§è¡Œä¸”åªèƒ½æ‰§è¡Œä¸€æ¬¡ Looper.prepare(); // åˆå§‹åŒ–Handlerå¯¹è±¡ï¼Œå†…éƒ¨å…³è”Looperå¯¹è±¡ Handler mHandler = new Handler() { @Override public void handleMessage(Message msg) { super.handleMessage(msg); } }; // å¯åŠ¨æ¶ˆæ¯é˜Ÿåˆ—å‡ºæ ˆæ­»å¾ªç¯ Looper.loop(); 2ï¼‰ä¸€ä¸ªçº¿ç¨‹ä¸­åªå­˜åœ¨ä¸€ä¸ªLooperå¯¹è±¡ï¼Œåªå­˜åœ¨ä¸€ä¸ªMessageQueueå¯¹è±¡ï¼Œå¯ä»¥å­˜åœ¨Nä¸ªHandlerå¯¹è±¡ï¼ŒHandlerå¯¹è±¡å†…éƒ¨å…³è”äº†æœ¬çº¿ç¨‹ä¸­å”¯ä¸€çš„Looperå¯¹è±¡ï¼ŒLooperå¯¹è±¡å†…éƒ¨å…³è”ç€å”¯ä¸€çš„ä¸€ä¸ªMessageQueueå¯¹è±¡ã€‚ 3ï¼‰MessageQueueæ¶ˆæ¯é˜Ÿåˆ—ä¸æ˜¯é€šè¿‡åˆ—è¡¨ä¿å­˜æ¶ˆæ¯ï¼ˆMessageï¼‰åˆ—è¡¨çš„ï¼Œè€Œæ˜¯é€šè¿‡Messageå¯¹è±¡çš„nextå±æ€§å…³è”ä¸‹ä¸€ä¸ªMessageä»è€Œå®ç°åˆ—è¡¨çš„åŠŸèƒ½ï¼ŒåŒæ—¶æ‰€æœ‰çš„æ¶ˆæ¯éƒ½æ˜¯æŒ‰æ—¶é—´æ’åºçš„ã€‚ 4ï¼‰androidä¸­ä¸¤ä¸ªå­çº¿ç¨‹ç›¸äº’äº¤äº’åŒæ ·å¯ä»¥é€šè¿‡Handlerçš„å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶å®ç°ï¼Œå¯ä»¥åœ¨çº¿ç¨‹aä¸­å®šä¹‰Handlerå¯¹è±¡ï¼Œè€Œåœ¨çº¿ç¨‹bä¸­è·å–handlerçš„å¼•ç”¨å¹¶è°ƒç”¨sendMessageæ–¹æ³•ã€‚ 5ï¼‰activityå†…éƒ¨é»˜è®¤å­˜åœ¨ä¸€ä¸ªhandlerçš„æˆå‘˜å˜é‡ï¼Œandroidä¸­ä¸€äº›å…¶ä»–çš„å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶çš„å®ç°æ–¹æ³•ï¼šHandlerçš„postæ–¹æ³•ï¼š 123456mHandler.post(new Runnable() { @Override public void run() { } }); æŸ¥çœ‹å…¶å†…éƒ¨å®ç°ï¼š 1234public final boolean post(Runnable r) { return sendMessageDelayed(getPostMessage(r), 0); } å¯ä»¥å‘ç°å…¶å†…éƒ¨è°ƒç”¨å°±æ˜¯sendMessageç³»åˆ—æ–¹æ³•ã€‚ã€‚ã€‚ viewçš„postæ–¹æ³•ï¼š 123456789public boolean post(Runnable action) { final AttachInfo attachInfo = mAttachInfo; if (attachInfo != null) { return attachInfo.mHandler.post(action); } // Assume that post will succeed later ViewRootImpl.getRunQueue().post(action); return true; } å¯ä»¥å‘ç°å…¶è°ƒç”¨çš„å°±æ˜¯activityä¸­é»˜è®¤ä¿å­˜çš„handlerå¯¹è±¡çš„postæ–¹æ³•ã€‚ activityçš„runOnUiThreadæ–¹æ³•ï¼š 1234567public final void runOnUiThread(Runnable action) { if (Thread.currentThread() != mUiThread) { mHandler.post(action); } else { action.run(); } } åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯UIçº¿ç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è°ƒç”¨handlerçš„postæ–¹æ³•ï¼Œå¦åˆ™ç›´æ¥æ‰§è¡Œrunæ–¹æ³•ã€‚ å‚è€ƒæ–‡ç« ï¼šAndroidå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶å®Œå…¨è§£æï¼Œå¸¦ä½ ä»æºç çš„è§’åº¦å½»åº•ç†è§£ Androidå¼‚æ­¥æ¶ˆæ¯å¤„ç†æœºåˆ¶è¯¦è§£åŠæºç åˆ†æ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶","link":"/2020/09/11/android%E5%BC%82%E6%AD%A5%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/"},{"title":"16 åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹","text":"ä»Šå¤©è®²è®²åº”ç”¨è¿›ç¨‹Contextçš„åˆ›å»ºæµç¨‹ï¼Œç›¸ä¿¡å¤§å®¶å¹³æ—¶åœ¨å¼€å‘è¿‡ç¨‹ä¸­ç»å¸¸ä¼šé‡åˆ°å¯¹Contextå¯¹è±¡çš„ä½¿ç”¨ï¼ŒApplicationæ˜¯Contextï¼ŒActivityæ˜¯Contextï¼ŒServiceä¹Ÿæ˜¯Contextï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªç»å…¸çš„é—®é¢˜æ˜¯ä¸€ä¸ªAppä¸­ä¸€å…±æœ‰å¤šå°‘ä¸ªContextï¼Ÿ è¿™ä¸ªé—®é¢˜çš„ç­”æ¡ˆæ˜¯Application + Nä¸ªActivity + Nä¸ªServiceã€‚ è¿˜æœ‰å°±æ˜¯æˆ‘ä»¬å¹³æ—¶åœ¨ä½¿ç”¨Contextè¿‡ç¨‹ä¸­è®¸å¤šæ—¶å€™ç”±äºä½¿ç”¨ä¸å½“ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æ³„éœ²çš„æƒ…å†µç­‰ç­‰ï¼Œè¿™ä¸ªä¹Ÿæ˜¯éœ€è¦æˆ‘ä»¬æ³¨æ„çš„ã€‚è¿™é‡Œæœ‰ç¯‡ä¸é”™çš„æ–‡ç« ï¼š Android Context æ˜¯ä»€ä¹ˆï¼Ÿ å¥½å§ï¼Œä»€ä¹ˆå«åº”ç”¨è¿›ç¨‹Contextå‘¢ï¼Ÿè¿™æ˜¯æŒ‡çš„æ˜¯Applicationæ‰€ä»£è¡¨çš„Contextçš„åˆ›å»ºæµç¨‹ï¼Œè¿˜è®°å¾—æˆ‘ä»¬å‰å‡ ç¯‡å†™çš„åº”ç”¨è¿›ç¨‹åˆ›å»ºæµç¨‹ä¹ˆï¼Ÿ androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹æœ€åæˆ‘ä»¬å¾—å‡ºç»“è®ºï¼Œåº”ç”¨è¿›ç¨‹çš„èµ·å§‹æ–¹æ³•æ˜¯ActivityThread.mainæ–¹æ³•ï¼Œå¥½å§ï¼Œ ç”±äºè¿˜æœªè®²è§£Serviceç›¸å…³çŸ¥è¯†ï¼Œè¿™é‡Œæš‚æ—¶è®²è§£ä¸€ä¸‹Activityä¸Applicationä¸­Contextå¯¹è±¡çš„åˆ›å»ºè¿‡ç¨‹ã€‚ é¦–å…ˆæˆ‘ä»¬å°±ä»ActivityThread.mainæ–¹æ³•å¼€å§‹çœ‹ä¸€ä¸‹Applicationçš„åˆ›å»ºæµç¨‹ã€‚ã€‚ã€‚ 123456public static void main(String[] args) { ... ActivityThread thread = new ActivityThread(); thread.attach(false); ... }è¿™é‡Œæˆ‘ä»¬å‘ç°åœ¨æ–¹æ³•ä½“ä¸­æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªActivityThreadå¯¹è±¡å¹¶æ‰§è¡Œäº†attachæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344private void attach(boolean system) { sCurrentActivityThread = this; mSystemThread = system; if (!system) { ViewRootImpl.addFirstDrawHandler(new Runnable() { @Override public void run() { ensureJitEnabled(); } }); android.ddm.DdmHandleAppName.setAppName(&quot;&lt;pre-initialized&gt;&quot;, UserHandle.myUserId()); RuntimeInit.setApplicationObject(mAppThread.asBinder()); final IActivityManager mgr = ActivityManagerNative.getDefault(); try { mgr.attachApplication(mAppThread); } catch (RemoteException ex) { // Ignore } // Watch for getting close to heap limit. BinderInternal.addGcWatcher(new Runnable() { @Override public void run() { if (!mSomeActivitiesChanged) { return; } Runtime runtime = Runtime.getRuntime(); long dalvikMax = runtime.maxMemory(); long dalvikUsed = runtime.totalMemory() - runtime.freeMemory(); if (dalvikUsed &gt; ((3*dalvikMax)/4)) { if (DEBUG_MEMORY_TRIM) Slog.d(TAG, &quot;Dalvik max=&quot; + (dalvikMax/1024) + &quot; total=&quot; + (runtime.totalMemory()/1024) + &quot; used=&quot; + (dalvikUsed/1024)); mSomeActivitiesChanged = false; try { mgr.releaseSomeActivities(mAppThread); } catch (RemoteException e) { } } } }); } else { ... } } è¿™é‡Œçœ‹ä¸€ä¸‹é‡ç‚¹å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åœ¨æ–¹æ³•ä½“ä¸­è°ƒç”¨äº†ActivityManagerNative.getDefault().attachApplication(mAppThread)çœ‹è¿‡æˆ‘çš„å‰å‡ ç¯‡æ–‡ç« çš„ç«¥é‹åº”è¯¥çŸ¥é“è¿™é‡Œå°±æ˜¯ä¸€ä¸ªBinderè¿›ç¨‹é—´é€šè®¯ï¼Œå…¶å®ä¸Šæ‰§è¡Œçš„æ˜¯ActivityManagerService.attachApplicationæ–¹æ³•ï¼Œå…·ä½“çš„å¯ä»¥å‚è€ƒå‰å‡ ç¯‡æ–‡ç« çš„ä»‹ç»ï¼Œå¥½å§ï¼Œæ—¢ç„¶è¿™æ ·æˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityManagerService.attachApplicationæ–¹æ³•çš„å…·ä½“å®ç°ã€‚ 123456789@Override public final void attachApplication(IApplicationThread thread) { synchronized (this) { int callingPid = Binder.getCallingPid(); final long origId = Binder.clearCallingIdentity(); attachApplicationLocked(thread, callingPid); Binder.restoreCallingIdentity(origId); } } ç„¶åè¿™é‡Œé¢åˆè°ƒç”¨äº†attachApplicationLockedæ–¹æ³•ï¼š 12345678private final boolean attachApplicationLocked(IApplicationThread thread, int pid) { ... thread.bindApplication(processName, appInfo, providers, app.instrumentationClass, profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,app.instrumentationUiAutomationConnection, testMode, enableOpenGlTrace, isRestrictedBackupMode || !normalMode, app.persistent, new Configuration(mConfiguration), app.compat,getCommonServicesLocked(app.isolated),mCoreSettingsObserver.getCoreSettingsLocked()); ... å¯ä»¥çœ‹åˆ°è¿™é‡Œé¢åˆè°ƒç”¨äº†IApplication.bindApplicationï¼Œä»æ–¹æ³•åç§°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™é‡Œåº”è¯¥æ˜¯ç»‘å®šApplicationçš„æ–¹æ³•ï¼Œè·Ÿä¸Šé¢çš„ActivityManangerNativeç±»ä¼¼çš„ï¼Œå‰é¢å‡ ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å·²ç»åšè¿‡ä»‹ç»ï¼ŒIApplicationThreadæ˜¯ActivityThreadä¸­ApplicationThread binderå¯¹è±¡çš„å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥è¿™é‡Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ApplicationThreadçš„bindApplicationæ–¹æ³•ï¼Œæ—¢ç„¶è¿™æ ·ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ApplicationThreadçš„bindApplicationçš„å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970public final void bindApplication(String processName, ApplicationInfo appInfo, List&lt;ProviderInfo&gt; providers, ComponentName instrumentationName, ProfilerInfo profilerInfo, Bundle instrumentationArgs, IInstrumentationWatcher instrumentationWatcher, IUiAutomationConnection instrumentationUiConnection, int debugMode, boolean enableOpenGlTrace, boolean isRestrictedBackupMode, boolean persistent, Configuration config, CompatibilityInfo compatInfo, Map&lt;String, IBinder&gt; services, Bundle coreSettings) { if (services != null) { // Setup the service cache in the ServiceManager ServiceManager.initServiceCache(services); } setCoreSettings(coreSettings); /* * Two possible indications that this package could be * sharing its runtime with other packages: * * 1.) the sharedUserId attribute is set in the manifest, * indicating a request to share a VM with other * packages with the same sharedUserId. * * 2.) the application element of the manifest has an * attribute specifying a non-default process name, * indicating the desire to run in another packages VM. * * If sharing is enabled we do not have a unique application * in a process and therefore cannot rely on the package * name inside the runtime. */ IPackageManager pm = getPackageManager(); android.content.pm.PackageInfo pi = null; try { pi = pm.getPackageInfo(appInfo.packageName, 0, UserHandle.myUserId()); } catch (RemoteException e) { } if (pi != null) { boolean sharedUserIdSet = (pi.sharedUserId != null); boolean processNameNotDefault = (pi.applicationInfo != null &amp;&amp; !appInfo.packageName.equals(pi.applicationInfo.processName)); boolean sharable = (sharedUserIdSet || processNameNotDefault); // Tell the VMRuntime about the application, unless it is shared // inside a process. if (!sharable) { VMRuntime.registerAppInfo(appInfo.packageName, appInfo.dataDir, appInfo.processName); } } AppBindData data = new AppBindData(); data.processName = processName; data.appInfo = appInfo; data.providers = providers; data.instrumentationName = instrumentationName; data.instrumentationArgs = instrumentationArgs; data.instrumentationWatcher = instrumentationWatcher; data.instrumentationUiAutomationConnection = instrumentationUiConnection; data.debugMode = debugMode; data.enableOpenGlTrace = enableOpenGlTrace; data.restrictedBackupMode = isRestrictedBackupMode; data.persistent = persistent; data.config = config; data.compatInfo = compatInfo; data.initProfilerInfo = profilerInfo; sendMessage(H.BIND_APPLICATION, data); } å¥½å§ï¼Œæœ€åè°ƒç”¨äº†ActivityThread.sendMessage()â€¦ 123private void sendMessage(int what, Object obj) { sendMessage(what, obj, 0, 0, false); } ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶sendMessageçš„é‡è½½æ–¹æ³•ï¼š 1234567891011121314private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) { if (DEBUG_MESSAGES) Slog.v( TAG, &quot;SCHEDULE &quot; + what + &quot; &quot; + mH.codeToString(what) + &quot;: &quot; + arg1 + &quot; / &quot; + obj); Message msg = Message.obtain(); msg.what = what; msg.obj = obj; msg.arg1 = arg1; msg.arg2 = arg2; if (async) { msg.setAsynchronous(true); } mH.sendMessage(msg); } å¯ä»¥å‘ç°è¿™é‡Œè°ƒç”¨äº†mHçš„sendMessageæ–¹æ³•ï¼Œæœ€åé€šè¿‡Handlerçš„å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶è¢«mHçš„handleMessageæ–¹æ³•å¤„ç†ï¼Œç„¶åæ ¹æ®Message.whaté€‰æ‹©å¤„ç†åˆ†æ”¯ï¼Œæœ€ç»ˆè°ƒç”¨äº†ActivityThreadçš„handleBindApplicationæ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990private void handleBindApplication(AppBindData data) { ... // åˆ›å»ºInstrumentation if (data.instrumentationName != null) { InstrumentationInfo ii = null; try { ii = appContext.getPackageManager(). getInstrumentationInfo(data.instrumentationName, 0); } catch (PackageManager.NameNotFoundException e) { } if (ii == null) { throw new RuntimeException( &quot;Unable to find instrumentation info for: &quot; + data.instrumentationName); } mInstrumentationPackageName = ii.packageName; mInstrumentationAppDir = ii.sourceDir; mInstrumentationSplitAppDirs = ii.splitSourceDirs; mInstrumentationLibDir = ii.nativeLibraryDir; mInstrumentedAppDir = data.info.getAppDir(); mInstrumentedSplitAppDirs = data.info.getSplitAppDirs(); mInstrumentedLibDir = data.info.getLibDir(); ApplicationInfo instrApp = new ApplicationInfo(); instrApp.packageName = ii.packageName; instrApp.sourceDir = ii.sourceDir; instrApp.publicSourceDir = ii.publicSourceDir; instrApp.splitSourceDirs = ii.splitSourceDirs; instrApp.splitPublicSourceDirs = ii.splitPublicSourceDirs; instrApp.dataDir = ii.dataDir; instrApp.nativeLibraryDir = ii.nativeLibraryDir; LoadedApk pi = getPackageInfo(instrApp, data.compatInfo, appContext.getClassLoader(), false, true, false); ContextImpl instrContext = ContextImpl.createAppContext(this, pi); try { java.lang.ClassLoader cl = instrContext.getClassLoader(); mInstrumentation = (Instrumentation) cl.loadClass(data.instrumentationName.getClassName()).newInstance(); } catch (Exception e) { throw new RuntimeException( &quot;Unable to instantiate instrumentation &quot; + data.instrumentationName + &quot;: &quot; + e.toString(), e); } mInstrumentation.init(this, instrContext, appContext, new ComponentName(ii.packageName, ii.name), data.instrumentationWatcher, data.instrumentationUiAutomationConnection); if (mProfiler.profileFile != null &amp;&amp; !ii.handleProfiling &amp;&amp; mProfiler.profileFd == null) { mProfiler.handlingProfiling = true; File file = new File(mProfiler.profileFile); file.getParentFile().mkdirs(); Debug.startMethodTracing(file.toString(), 8 * 1024 * 1024); } } else { mInstrumentation = new Instrumentation(); } ... / If the app is being launched for full backup or restore, bring it up in // a restricted environment with the base application class. Application app = data.info.makeApplication(data.restrictedBackupMode, null); mInitialApplication = app; ... try { mInstrumentation.onCreate(data.instrumentationArgs); } catch (Exception e) { throw new RuntimeException( &quot;Exception thrown in onCreate() of &quot; + data.instrumentationName + &quot;: &quot; + e.toString(), e); } try { mInstrumentation.callApplicationOnCreate(app); } catch (Exception e) { if (!mInstrumentation.onException(app, e)) { throw new RuntimeException( &quot;Unable to create application &quot; + app.getClass().getName() + &quot;: &quot; + e.toString(), e); } } } finally { StrictMode.setThreadPolicy(savedPolicy); } } è¿™ä¸ªæ–¹æ³•çš„æ–¹æ³•ä½“æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬æŒ‘é‡ç‚¹çš„çœ‹ï¼Œå¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“ä¸­ç³»ç»Ÿé€šè¿‡åå°„æœºåˆ¶åˆ›å»ºäº†Instrumentationå¯¹è±¡ï¼Œå¹¶æ‰§è¡Œäº†initæ–¹æ³•ï¼Œæ‰§è¡Œäº†Insrtumentationå¯¹è±¡çš„åˆå§‹åŒ–ã€‚ç„¶åæˆ‘ä»¬è°ƒç”¨äº†LockedApk.makeApplicationæ–¹æ³•åˆ›å»ºäº†Applicationå¯¹è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶å…·ä½“çš„å®ç°é€»è¾‘ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public Application makeApplication(boolean forceDefaultAppClass, Instrumentation instrumentation) { if (mApplication != null) { return mApplication; } Application app = null; String appClass = mApplicationInfo.className; if (forceDefaultAppClass || (appClass == null)) { appClass = &quot;android.app.Application&quot;; } try { java.lang.ClassLoader cl = getClassLoader(); if (!mPackageName.equals(&quot;android&quot;)) { initializeJavaContextClassLoader(); } ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, this); app = mActivityThread.mInstrumentation.newApplication( cl, appClass, appContext); appContext.setOuterContext(app); } catch (Exception e) { if (!mActivityThread.mInstrumentation.onException(app, e)) { throw new RuntimeException( &quot;Unable to instantiate application &quot; + appClass + &quot;: &quot; + e.toString(), e); } } mActivityThread.mAllApplications.add(app); mApplication = app; if (instrumentation != null) { try { instrumentation.callApplicationOnCreate(app); } catch (Exception e) { if (!instrumentation.onException(app, e)) { throw new RuntimeException( &quot;Unable to create application &quot; + app.getClass().getName() + &quot;: &quot; + e.toString(), e); } } } // Rewrite the R 'constants' for all library apks. SparseArray&lt;String&gt; packageIdentifiers = getAssets(mActivityThread) .getAssignedPackageIdentifiers(); final int N = packageIdentifiers.size(); for (int i = 0; i &lt; N; i++) { final int id = packageIdentifiers.keyAt(i); if (id == 0x01 || id == 0x7f) { continue; } rewriteRValues(getClassLoader(), packageIdentifiers.valueAt(i), id); } return app; } å¯ä»¥å‘ç°è¿™é‡Œä¹Ÿæ˜¯ä»¥åå°„çš„æœºåˆ¶åˆ›å»ºäº†Applicationå¯¹è±¡ï¼Œå¹¶åˆ›å»ºäº†ä¸€ä¸ªContextImplå¯¹è±¡ï¼Œå¹¶å°†Applicationä¸ContextImplå»ºç«‹å…³è”ã€‚ã€‚ã€‚ ç»§ç»­å›åˆ°æˆ‘ä»¬çš„ActivityThreadçš„handleBindApplicationæ–¹æ³•ï¼Œåœ¨åˆ›å»ºäº†Applicationå¯¹è±¡ä¹‹åæˆ‘ä»¬è°ƒç”¨äº†Instrumentationçš„onCreateæ–¹æ³•ï¼Œç„¶åè°ƒç”¨äº†Instrumentationçš„callApplicationOnCreateæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶å…·ä½“å®ç°ï¼š 123public void callApplicationOnCreate(Application app) { app.onCreate(); } å’‹æ ·ï¼ŸåŸæ¥Applicationçš„onCreateç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ˜¯åœ¨è¿™é‡Œå›è°ƒæ»´å•Šã€‚ è¿™æ ·æˆ‘ä»¬æ•´ä¸ªApplicationçš„åˆ›å»ºæ‰§è¡Œæµç¨‹å°±è®²è§£å®Œäº†ã€‚ æ€»ç»“ï¼š åº”ç”¨è¿›ç¨‹å¯åŠ¨ â€“&gt; åˆ›å»ºInstrumentation â€“&gt; åˆ›å»ºApplicationå¯¹è±¡ â€“&gt; åˆ›å»ºApplicationç›¸å…³çš„ContextImplå¯¹è±¡ï¼› ActivityThread.mainæ–¹æ³•â€“&gt; ActivityManagerService.bindApplicationæ–¹æ³• â€“&gt; ActivityThread.handleBindApplication â€“&gt; åˆ›å»ºInstrumentationï¼Œåˆ›å»ºApplicationï¼› æ¯ä¸ªåº”ç”¨è¿›ç¨‹å¯¹åº”ä¸€ä¸ªInstrumentationï¼Œå¯¹åº”ä¸€ä¸ªApplicationï¼› Instrumentationä¸Applicationéƒ½æ˜¯é€šè¿‡javaåå°„æœºåˆ¶åˆ›å»ºï¼› Applicationåˆ›å»ºè¿‡ç¨‹ä¸­ä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªContextImplå¯¹è±¡ï¼Œå¹¶å»ºç«‹å…³è”ï¼› æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Acitivtyä¸­çš„Contextåˆ›å»ºæµç¨‹ï¼Œå¤§å®¶éƒ½çŸ¥é“æˆ‘ä»¬Activityçš„å…·ä½“åˆ›å»ºè¿‡ç¨‹æ˜¯åœ¨ActivityThreadçš„performLaunchActivity,å¯å‚è§ï¼š androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶å…·ä½“çš„å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) { ... Activity activity = null; try { java.lang.ClassLoader cl = r.packageInfo.getClassLoader(); activity = mInstrumentation.newActivity( cl, component.getClassName(), r.intent); StrictMode.incrementExpectedActivityCount(activity.getClass()); r.intent.setExtrasClassLoader(cl); r.intent.prepareToEnterProcess(); if (r.state != null) { r.state.setClassLoader(cl); } } catch (Exception e) { if (!mInstrumentation.onException(activity, e)) { throw new RuntimeException( &quot;Unable to instantiate activity &quot; + component + &quot;: &quot; + e.toString(), e); } } try { Application app = r.packageInfo.makeApplication(false, mInstrumentation); ... if (activity != null) { Context appContext = createBaseContextForActivity(r, activity); CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager()); Configuration config = new Configuration(mCompatConfiguration); if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Launching activity &quot; + r.activityInfo.name + &quot; with config &quot; + config); activity.attach(appContext, this, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor); if (customIntent != null) { activity.mIntent = customIntent; } r.lastNonConfigurationInstances = null; activity.mStartedActivity = false; int theme = r.activityInfo.getThemeResource(); if (theme != 0) { activity.setTheme(theme); } activity.mCalled = false; if (r.isPersistable()) { mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState); } else { mInstrumentation.callActivityOnCreate(activity, r.state); } if (!activity.mCalled) { throw new SuperNotCalledException( &quot;Activity &quot; + r.intent.getComponent().toShortString() + &quot; did not call through to super.onCreate()&quot;); } r.activity = activity; r.stopped = true; if (!r.activity.mFinished) { activity.performStart(); r.stopped = false; } if (!r.activity.mFinished) { if (r.isPersistable()) { if (r.state != null || r.persistentState != null) { mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state, r.persistentState); } } else if (r.state != null) { mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state); } } ... return activity; } è¿™é‡Œç®€è¦è¯´æ˜ä¸€ä¸‹ï¼ŒActivityä¹Ÿæ˜¯ç³»ç»Ÿé€šè¿‡åå°„æœºåˆ¶åˆ›å»ºçš„ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡LockedApk.makeApplicationåˆ›å»ºä¸€ä¸ªApplicationï¼Œé€šè¿‡æŸ¥çœ‹æºç æˆ‘ä»¬çŸ¥é“è‹¥è¿™æ—¶å€™LockedApkä¸­çš„mApplicationä¸ä¸ºç©ºåˆ™ç›´æ¥è¿”å›å½“å‰çš„mApplicationåˆå› ä¸ºå½“æˆ‘ä»¬åˆ›å»ºåº”ç”¨è¿›ç¨‹çš„æ—¶å€™Applicationå·²ç»è¢«åˆ›å»ºï¼Œæ‰€ä»¥å½“åˆ›å»ºActivityçš„æ—¶å€™è¿™æ—¶å€™Applicationè‚¯å®šä¸ä¸ºç©ºï¼Œæ‰€ä»¥è¿™æ—¶å€™è¿”å›çš„å°±æ˜¯åº”ç”¨è¿›ç¨‹åˆ›å»ºçš„æ—¶å€™åˆ›å»ºçš„Applicationï¼Œè¿™ä¹Ÿä»ä¾§é¢è¯´æ˜äº†ä¸€ä¸ªåº”ç”¨è¿›ç¨‹å¯¹åº”ç€ä¸€ä¸ªApplicationã€‚ç„¶åæˆ‘ä»¬é€šè¿‡createBaseContextForActivityåˆ›å»ºäº†ä¸€ä¸ªContextImplå¯¹è±¡ã€‚ 123456789101112131415161718192021222324252627282930private Context createBaseContextForActivity(ActivityClientRecord r, final Activity activity) { int displayId = Display.DEFAULT_DISPLAY; try { displayId = ActivityManagerNative.getDefault().getActivityDisplayId(r.token); } catch (RemoteException e) { } ContextImpl appContext = ContextImpl.createActivityContext( this, r.packageInfo, displayId, r.overrideConfig); appContext.setOuterContext(activity); Context baseContext = appContext; final DisplayManagerGlobal dm = DisplayManagerGlobal.getInstance(); // For debugging purposes, if the activity's package name contains the value of // the &quot;debug.use-second-display&quot; system property as a substring, then show // its content on a secondary display if there is one. String pkgName = SystemProperties.get(&quot;debug.second-display.pkg&quot;); if (pkgName != null &amp;&amp; !pkgName.isEmpty() &amp;&amp; r.packageInfo.mPackageName.contains(pkgName)) { for (int id : dm.getDisplayIds()) { if (id != Display.DEFAULT_DISPLAY) { Display display = dm.getCompatibleDisplay(id, appContext.getDisplayAdjustments(id)); baseContext = appContext.createDisplayContext(display); break; } } } return baseContext; } å¯ä»¥å‘ç°è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ªContextImplå¯¹è±¡ï¼Œå¹¶é€šè¿‡ContextImplçš„setOuterContextæ–¹æ³•ï¼Œè®©è¯¥ContextImplæŒæœ‰äº†Activityçš„å¼•ç”¨ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼Œæˆ‘ä»¬è°ƒç”¨äº†activity.attachæ–¹æ³•ï¼ŒæŸ¥çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354final void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent.getComponent(); mActivityInfo = info; mTitle = title; mParent = parent; mEmbeddedID = id; mLastNonConfigurationInstances = lastNonConfigurationInstances; if (voiceInteractor != null) { if (lastNonConfigurationInstances != null) { mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor; } else { mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this, Looper.myLooper()); } } mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); if (mParent != null) { mWindow.setContainer(mParent.getWindow()); } mWindowManager = mWindow.getWindowManager(); mCurrentConfig = config; } é™¤äº†ä¸€ä¸‹åˆå§‹åŒ–æ“ä½œä¹‹å¤–ï¼Œè¿˜è°ƒç”¨äº†attachBaseContextæ–¹æ³•ï¼Œè®©ActivityæŒæœ‰äº†ContextImplçš„å¼•ç”¨ï¼Œè¿™æ ·å°±ç›¸å½“äºActivityä¸ContextImplå¯¹è±¡ç›¸äº’æŒæœ‰äº†å¯¹æ–¹çš„å¼•ç”¨ï¼Œå¹¶ä¸”Activityæ˜¯ç»§æ‰¿ä¸Contextã€‚ æ€»ç»“ï¼š Activityä¸­åˆ›å»ºContextImplå¯¹è±¡çš„å…·ä½“å®ç°åœ¨ActivityThreadçš„performLauncherAcitivtyæ–¹æ³•ä¸­ï¼› Activityçš„åˆ›å»ºä¼´éšç€ContextImplçš„åˆ›å»ºï¼ŒäºŒè€…ç›¸äº’æŒæœ‰å¯¹æ–¹çš„å¼•ç”¨ï¼› åˆ›å»ºActivity â€“&gt; åˆ›å»ºActivityç›¸å…³ContextImplå¯¹è±¡ï¼› åˆ›å»ºåº”ç”¨è¿›ç¨‹ â€“&gt; åˆ›å»ºApplication â€“&gt; åˆ›å»ºApplicationç›¸å…³ContextImplå¯¹è±¡ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹","link":"/2020/09/11/%E5%BA%94%E7%94%A8%E8%BF%9B%E7%A8%8BContext%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B/"},{"title":"26 æˆªå±äº‹ä»¶æµç¨‹","text":"ä»Šå¤©è¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸»è¦è®²ä¸€ä¸‹Androidç³»ç»Ÿä¸­çš„æˆªå±äº‹ä»¶å¤„ç†æµç¨‹ã€‚ç”¨è¿‡androidç³»ç»Ÿæ‰‹æœºçš„åŒå­¦åº”è¯¥éƒ½çŸ¥é“ï¼Œä¸€èˆ¬çš„androidæ‰‹æœºæŒ‰ä¸‹éŸ³é‡å‡å°‘é”®å’Œç”µæºæŒ‰é”®å°±ä¼šè§¦å‘æˆªå±äº‹ä»¶ï¼ˆå›½å†…å®šåˆ¶æœºåšä¸ªä¿®æ”¹çš„è¿™é‡Œå°±ä¸åšè€ƒè™‘äº†ï¼‰ã€‚é‚£ä¹ˆè¿™é‡Œçš„æˆªå±äº‹ä»¶æ˜¯å¦‚ä½•è§¦å‘çš„å‘¢ï¼Ÿè§¦å‘ä¹‹åandroidç³»ç»Ÿæ˜¯å¦‚ä½•å®ç°æˆªå±æ“ä½œçš„å‘¢ï¼Ÿå¸¦ç€è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œå¼€å§‹æˆ‘ä»¬çš„æºç é˜…è¯»æµç¨‹ã€‚ æˆ‘ä»¬çŸ¥é“è¿™é‡Œçš„æˆªå±äº‹ä»¶æ˜¯é€šè¿‡æˆ‘ä»¬çš„æŒ‰é”®æ“ä½œè§¦å‘çš„ï¼Œæ‰€ä»¥è¿™é‡Œå°±éœ€è¦æˆ‘ä»¬ä»androidç³»ç»Ÿçš„æŒ‰é”®è§¦å‘æ¨¡å—å¼€å§‹çœ‹èµ·ï¼Œç”±äºæˆ‘ä»¬åœ¨ä¸åŒçš„Appé¡µé¢ï¼Œæ“ä½œéŸ³é‡å‡å°‘é”®å’Œç”µæºé”®éƒ½ä¼šè§¦å‘ç³»ç»Ÿçš„æˆªå±å¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œçš„æŒ‰é”®è§¦å‘é€»è¾‘åº”è¯¥æ˜¯Androidç³»ç»Ÿçš„å…¨å±€æŒ‰é”®å¤„ç†é€»è¾‘ã€‚ åœ¨androidç³»ç»Ÿä¸­ï¼Œç”±äºæˆ‘ä»¬çš„æ¯ä¸€ä¸ªAndroidç•Œé¢éƒ½æ˜¯ä¸€ä¸ªActivityï¼Œè€Œç•Œé¢çš„æ˜¾ç¤ºéƒ½æ˜¯é€šè¿‡Windowå¯¹è±¡å®ç°çš„ï¼Œæ¯ä¸ªWindowå¯¹è±¡å®é™…ä¸Šéƒ½æ˜¯PhoneWindowçš„å®ä¾‹ï¼Œè€Œæ¯ä¸ªPhoneWindowå¯¹è±¡éƒ½ä¸€ä¸ªPhoneWindowManagerå¯¹è±¡ï¼Œå½“æˆ‘ä»¬åœ¨Activityç•Œé¢æ‰§è¡ŒæŒ‰é”®æ“ä½œçš„æ—¶å€™ï¼Œåœ¨å°†æŒ‰é”®çš„å¤„ç†æ“ä½œåˆ†å‘åˆ°Appä¹‹å‰ï¼Œé¦–å…ˆä¼šå›è°ƒPhoneWindowManagerä¸­çš„dispatchUnhandledKeyæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç”¨äºæ‰§è¡Œå½“å‰Appå¤„ç†æŒ‰é”®ä¹‹å‰çš„æ“ä½œï¼Œæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/** {@inheritDoc} */ @Override public KeyEvent dispatchUnhandledKey(WindowState win, KeyEvent event, int policyFlags) { ... KeyEvent fallbackEvent = null; if ((event.getFlags() &amp; KeyEvent.FLAG_FALLBACK) == 0) { final KeyCharacterMap kcm = event.getKeyCharacterMap(); final int keyCode = event.getKeyCode(); final int metaState = event.getMetaState(); final boolean initialDown = event.getAction() == KeyEvent.ACTION_DOWN &amp;&amp; event.getRepeatCount() == 0; // Check for fallback actions specified by the key character map. final FallbackAction fallbackAction; if (initialDown) { fallbackAction = kcm.getFallbackAction(keyCode, metaState); } else { fallbackAction = mFallbackActions.get(keyCode); } if (fallbackAction != null) { ... final int flags = event.getFlags() | KeyEvent.FLAG_FALLBACK; fallbackEvent = KeyEvent.obtain( event.getDownTime(), event.getEventTime(), event.getAction(), fallbackAction.keyCode, event.getRepeatCount(), fallbackAction.metaState, event.getDeviceId(), event.getScanCode(), flags, event.getSource(), null); if (!interceptFallback(win, fallbackEvent, policyFlags)) { fallbackEvent.recycle(); fallbackEvent = null; } if (initialDown) { mFallbackActions.put(keyCode, fallbackAction); } else if (event.getAction() == KeyEvent.ACTION_UP) { mFallbackActions.remove(keyCode); fallbackAction.recycle(); } } } ... return fallbackEvent; } è¿™é‡Œæˆ‘ä»¬å…³æ³¨ä¸€ä¸‹æ–¹æ³•ä½“ä¸­è°ƒç”¨çš„ï¼šinterceptFallbackæ–¹æ³•ï¼Œé€šè¿‡è°ƒç”¨è¯¥æ–¹æ³•å°†å¤„ç†æŒ‰é”®çš„æ“ä½œä¸‹å‘åˆ°è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 1234567891011private boolean interceptFallback(WindowState win, KeyEvent fallbackEvent, int policyFlags) { int actions = interceptKeyBeforeQueueing(fallbackEvent, policyFlags); if ((actions &amp; ACTION_PASS_TO_USER) != 0) { long delayMillis = interceptKeyBeforeDispatching( win, fallbackEvent, policyFlags); if (delayMillis == 0) { return true; } } return false; }ç„¶åæˆ‘ä»¬çœ‹åˆ°åœ¨interceptFallbackæ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨äº†interceptKeyBeforeQueueingæ–¹æ³•ï¼Œé€šè¿‡é˜…è¯»æˆ‘ä»¬æˆ‘ä»¬çŸ¥é“è¯¥æ–¹æ³•ä¸»è¦å®ç°äº†å¯¹æˆªå±æŒ‰é”®çš„å¤„ç†æµç¨‹ï¼Œè¿™æ ·æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹interceptKeyBeforeWueueingæ–¹æ³•çš„å¤„ç†ï¼š 123456789101112131415161718192021222324252627282930313233343536@Override public int interceptKeyBeforeQueueing(KeyEvent event, int policyFlags) { if (!mSystemBooted) { // If we have not yet booted, don't let key events do anything. return 0; } ... // Handle special keys. switch (keyCode) { case KeyEvent.KEYCODE_VOLUME_DOWN: case KeyEvent.KEYCODE_VOLUME_UP: case KeyEvent.KEYCODE_VOLUME_MUTE: { if (mUseTvRouting) { // On TVs volume keys never go to the foreground app result &amp;= ~ACTION_PASS_TO_USER; } if (keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) { if (down) { if (interactive &amp;&amp; !mScreenshotChordVolumeDownKeyTriggered &amp;&amp; (event.getFlags() &amp; KeyEvent.FLAG_FALLBACK) == 0) { mScreenshotChordVolumeDownKeyTriggered = true; mScreenshotChordVolumeDownKeyTime = event.getDownTime(); mScreenshotChordVolumeDownKeyConsumed = false; cancelPendingPowerKeyAction(); interceptScreenshotChord(); } } else { mScreenshotChordVolumeDownKeyTriggered = false; cancelPendingScreenshotChordAction(); } } ... return result; } å¯ä»¥å‘ç°è¿™é‡Œé¦–å…ˆåˆ¤æ–­å½“å‰ç³»ç»Ÿæ˜¯å¦å·²ç»bootå®Œæ¯•ï¼Œè‹¥å°šæœªå¯åŠ¨å®Œæ¯•ï¼Œåˆ™æ‰€æœ‰çš„æŒ‰é”®æ“ä½œéƒ½å°†å¤±æ•ˆï¼Œè‹¥å¯åŠ¨å®Œæˆï¼Œåˆ™æ‰§è¡Œåç»­çš„æ“ä½œï¼Œè¿™é‡Œæˆ‘ä»¬åªæ˜¯å…³æ³¨éŸ³é‡å‡å°‘æŒ‰é”®å’Œç”µæºæŒ‰é”®ç»„åˆçš„å¤„ç†äº‹ä»¶ã€‚å¦å¤–è¿™é‡Œå¤šè¯´ä¸€å¥æƒ³å®‰å“ç³»ç»Ÿçš„HOMEæŒ‰é”®äº‹ä»¶ï¼ŒMENUæŒ‰é”®äº‹ä»¶ï¼Œè¿›ç¨‹åˆ—è¡¨æŒ‰é”®äº‹ä»¶ç­‰ç­‰éƒ½æ˜¯åœ¨è¿™é‡Œå®ç°çš„ï¼Œåç»­ä¸­æˆ‘ä»¬ä¼šé™†ç»­ä»‹ç»è¿™æ–¹é¢çš„å†…å®¹ã€‚ å›åˆ°æˆ‘ä»¬çš„interceptKeyBeforeQueueingæ–¹æ³•ï¼Œå½“æˆ‘ç”¨æŒ‰ä¸‹éŸ³é‡å‡å°‘æŒ‰é”®çš„æ—¶å€™å›è¿›å…¥åˆ°ï¼šcase KeyEvent.KEYCODE_VOLUME_MUTEåˆ†æ”¯å¹¶æ‰§è¡Œç›¸åº”çš„é€»è¾‘ï¼Œç„¶ååŒæ—¶åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æŒ‰ä¸‹äº†ç”µæºé”®ï¼Œè‹¥åŒæ—¶æŒ‰ä¸‹äº†ç”µæºé”®ï¼Œåˆ™æ‰§è¡Œï¼š 12345678if (interactive &amp;&amp; !mScreenshotChordVolumeDownKeyTriggered &amp;&amp; (event.getFlags() &amp; KeyEvent.FLAG_FALLBACK) == 0) { mScreenshotChordVolumeDownKeyTriggered = true; mScreenshotChordVolumeDownKeyTime = event.getDownTime(); mScreenshotChordVolumeDownKeyConsumed = false; cancelPendingPowerKeyAction(); interceptScreenshotChord(); } å¯ä»¥å‘ç°è¿™é‡Œçš„interceptScreenshotChrodæ–¹æ³•å°±æ˜¯ç³»ç»Ÿå‡†å¤‡å¼€å§‹æ‰§è¡Œæˆªå±æ“ä½œçš„å¼€å§‹ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹interceptcreenshotChordæ–¹æ³•çš„å®ç°ã€‚ 123456789101112131415private void interceptScreenshotChord() { if (mScreenshotChordEnabled &amp;&amp; mScreenshotChordVolumeDownKeyTriggered &amp;&amp; mScreenshotChordPowerKeyTriggered &amp;&amp; !mScreenshotChordVolumeUpKeyTriggered) { final long now = SystemClock.uptimeMillis(); if (now &lt;= mScreenshotChordVolumeDownKeyTime + SCREENSHOT_CHORD_DEBOUNCE_DELAY_MILLIS &amp;&amp; now &lt;= mScreenshotChordPowerKeyTime + SCREENSHOT_CHORD_DEBOUNCE_DELAY_MILLIS) { mScreenshotChordVolumeDownKeyConsumed = true; cancelPendingPowerKeyAction(); mHandler.postDelayed(mScreenshotRunnable, getScreenshotChordLongPressDelay()); } } } åœ¨æ–¹æ³•ä½“ä¸­æˆ‘ä»¬æœ€ç»ˆä¼šæ‰§è¡Œå‘é€ä¸€ä¸ªå»¶è¿Ÿçš„å¼‚æ­¥æ¶ˆæ¯ï¼Œè¯·æ±‚æ‰§è¡Œæˆªå±çš„æ“ä½œè€Œè¿™é‡Œçš„å»¶æ—¶æ—¶é—´ï¼Œè‹¥å½“å‰è¾“å…¥æ¡†æ˜¯æ‰“å¼€çŠ¶æ€ï¼Œåˆ™å»¶æ—¶æ—¶é—´ä¸ºè¾“å…¥æ¡†å…³é—­æ—¶é—´åŠ ä¸Šç³»ç»Ÿé…ç½®çš„æŒ‰é”®è¶…æ—¶æ—¶é—´ï¼Œè‹¥å½“å‰è¾“å…¥æ¡†æ²¡æœ‰æ‰“å¼€åˆ™ç›´æ¥æ˜¯ç³»ç»Ÿé…ç½®çš„æŒ‰é”®è¶…æ—¶å¤„ç†æ—¶é—´ï¼Œå¯çœ‹ä¸€ä¸‹getScreenshotChordLongPressDelayæ–¹æ³•çš„å…·ä½“å®ç°ã€‚ 12345678private long getScreenshotChordLongPressDelay() { if (mKeyguardDelegate.isShowing()) { // Double the time it takes to take a screenshot from the keyguard return (long) (KEYGUARD_SCREENSHOT_CHORD_DELAY_MULTIPLIER * ViewConfiguration.get(mContext).getDeviceGlobalActionKeyTimeout()); } return ViewConfiguration.get(mContext).getDeviceGlobalActionKeyTimeout(); } å›åˆ°æˆ‘ä»¬çš„interceptScreenshotChordæ–¹æ³•ï¼Œå‘é€äº†å¼‚æ­¥æ¶ˆæ¯ä¹‹åç³»ç»Ÿæœ€ç»ˆä¼šè¢«æˆ‘ä»¬å‘é€çš„Runnableå¯¹è±¡çš„runæ–¹æ³•æ‰§è¡Œï¼Œè¿™é‡Œå…³äºå¼‚æ­¥æ¶ˆæ¯çš„é€»è¾‘å¯å‚è€ƒï¼šandroidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ è¿™æ ·æˆ‘ä»¬çœ‹ä¸€ä¸‹Runnableç±»å‹çš„mScreenshotRunnableçš„runæ–¹æ³•çš„å®ç°: 123456private final Runnable mScreenshotRunnable = new Runnable() { @Override public void run() { takeScreenshot(); } }; å¥½å§ï¼Œæ–¹æ³•ä½“ä¸­å¹¶æœªæ‰§è¡Œå…¶ä»–æ“ä½œï¼Œç›´æ¥å°±æ˜¯è°ƒç”¨äº†takeScreenshotæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹takeScreenshotæ–¹æ³•çš„å®ç°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253private void takeScreenshot() { synchronized (mScreenshotLock) { if (mScreenshotConnection != null) { return; } ComponentName cn = new ComponentName(&quot;com.android.systemui&quot;, &quot;com.android.systemui.screenshot.TakeScreenshotService&quot;); Intent intent = new Intent(); intent.setComponent(cn); ServiceConnection conn = new ServiceConnection() { @Override public void onServiceConnected(ComponentName name, IBinder service) { synchronized (mScreenshotLock) { if (mScreenshotConnection != this) { return; } Messenger messenger = new Messenger(service); Message msg = Message.obtain(null, 1); final ServiceConnection myConn = this; Handler h = new Handler(mHandler.getLooper()) { @Override public void handleMessage(Message msg) { synchronized (mScreenshotLock) { if (mScreenshotConnection == myConn) { mContext.unbindService(mScreenshotConnection); mScreenshotConnection = null; mHandler.removeCallbacks(mScreenshotTimeout); } } } }; msg.replyTo = new Messenger(h); msg.arg1 = msg.arg2 = 0; if (mStatusBar != null &amp;&amp; mStatusBar.isVisibleLw()) msg.arg1 = 1; if (mNavigationBar != null &amp;&amp; mNavigationBar.isVisibleLw()) msg.arg2 = 1; try { messenger.send(msg); } catch (RemoteException e) { } } } @Override public void onServiceDisconnected(ComponentName name) {} }; if (mContext.bindServiceAsUser( intent, conn, Context.BIND_AUTO_CREATE, UserHandle.CURRENT)) { mScreenshotConnection = conn; mHandler.postDelayed(mScreenshotTimeout, 10000); } } } å¯ä»¥å‘ç°è¿™é‡Œé€šè¿‡åå°„æœºåˆ¶åˆ›å»ºäº†ä¸€ä¸ªTakeScreenshotServiceå¯¹è±¡ç„¶åè°ƒç”¨äº†bindServiceAsUserï¼Œè¿™æ ·å°±åˆ›å»ºäº†TakeScreenshotServiceæœåŠ¡å¹¶åœ¨æœåŠ¡åˆ›å»ºä¹‹åå‘é€äº†ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ã€‚å¥½äº†ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹TakeScreenshotServiceçš„å®ç°é€»è¾‘ã€‚ 1234567891011121314151617181920212223242526272829303132public class TakeScreenshotService extends Service { private static final String TAG = &quot;TakeScreenshotService&quot;; private static GlobalScreenshot mScreenshot; private Handler mHandler = new Handler() { @Override public void handleMessage(Message msg) { switch (msg.what) { case 1: final Messenger callback = msg.replyTo; if (mScreenshot == null) { mScreenshot = new GlobalScreenshot(TakeScreenshotService.this); } mScreenshot.takeScreenshot(new Runnable() { @Override public void run() { Message reply = Message.obtain(null, 1); try { callback.send(reply); } catch (RemoteException e) { } } }, msg.arg1 &gt; 0, msg.arg2 &gt; 0); } } }; @Override public IBinder onBind(Intent intent) { return new Messenger(mHandler).getBinder(); }} å¯ä»¥å‘ç°åœ¨åœ¨TakeScreenshotServiceç±»çš„å®šä¹‰ä¸­æœ‰ä¸€ä¸ªHandleræˆå‘˜å˜é‡ï¼Œè€Œæˆ‘ä»¬åœ¨å¯åŠ¨TakeScreentshowServiceçš„æ—¶å€™å›å‘é€ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œè¿™æ ·å°±ä¼šæ‰§è¡ŒmHandlerçš„handleMessageæ–¹æ³•ï¼Œç„¶ååœ¨handleMessageæ–¹æ³•ä¸­æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªGlobalScreenshowå¯¹è±¡ï¼Œç„¶åæ‰§è¡Œäº†takeScreenshotæ–¹æ³•ï¼Œå¥½å§ï¼Œç»§ç»­çœ‹ä¸€ä¸‹takeScreentshotæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950/** * Takes a screenshot of the current display and shows an animation. */ void takeScreenshot(Runnable finisher, boolean statusBarVisible, boolean navBarVisible) { // We need to orient the screenshot correctly (and the Surface api seems to take screenshots // only in the natural orientation of the device :!) mDisplay.getRealMetrics(mDisplayMetrics); float[] dims = {mDisplayMetrics.widthPixels, mDisplayMetrics.heightPixels}; float degrees = getDegreesForRotation(mDisplay.getRotation()); boolean requiresRotation = (degrees &gt; 0); if (requiresRotation) { // Get the dimensions of the device in its native orientation mDisplayMatrix.reset(); mDisplayMatrix.preRotate(-degrees); mDisplayMatrix.mapPoints(dims); dims[0] = Math.abs(dims[0]); dims[1] = Math.abs(dims[1]); } // Take the screenshot mScreenBitmap = SurfaceControl.screenshot((int) dims[0], (int) dims[1]); if (mScreenBitmap == null) { notifyScreenshotError(mContext, mNotificationManager); finisher.run(); return; } if (requiresRotation) { // Rotate the screenshot to the current orientation Bitmap ss = Bitmap.createBitmap(mDisplayMetrics.widthPixels, mDisplayMetrics.heightPixels, Bitmap.Config.ARGB_8888); Canvas c = new Canvas(ss); c.translate(ss.getWidth() / 2, ss.getHeight() / 2); c.rotate(degrees); c.translate(-dims[0] / 2, -dims[1] / 2); c.drawBitmap(mScreenBitmap, 0, 0, null); c.setBitmap(null); // Recycle the previous bitmap mScreenBitmap.recycle(); mScreenBitmap = ss; } // Optimizations mScreenBitmap.setHasAlpha(false); mScreenBitmap.prepareToDraw(); // Start the post-screenshot animation startAnimation(finisher, mDisplayMetrics.widthPixels, mDisplayMetrics.heightPixels, statusBarVisible, navBarVisible); } å¯ä»¥çœ‹åˆ°è¿™é‡Œåä¸¤ä¸ªå‚æ•°ï¼šstatusBarVisibleï¼ŒnavBarVisibleæ˜¯å¦å¯è§ï¼Œè€Œè¿™ä¸¤ä¸ªå‚æ•°åœ¨æˆ‘ä»¬PhoneWindowManager.takeScreenshotæ–¹æ³•ä¼ é€’çš„ï¼š 1234if (mStatusBar != null &amp;&amp; mStatusBar.isVisibleLw()) msg.arg1 = 1; if (mNavigationBar != null &amp;&amp; mNavigationBar.isVisibleLw()) msg.arg2 = 1; å¯è§è‹¥æœmStatusBarå¯è§ï¼Œåˆ™ä¼ é€’çš„statusBarVisibleä¸ºtrueï¼Œè‹¥mNavigationBarå¯è§ï¼Œåˆ™ä¼ é€’çš„navBarVisibleä¸ºtrueã€‚ç„¶åæˆ‘ä»¬åœ¨æˆªå±çš„æ—¶å€™åˆ¤æ–­nStatusBaræ˜¯å¦å¯è§ï¼ŒmNavigationBaræ˜¯å¦å¯è§ï¼Œè‹¥å¯è§çš„æ—¶å€™åˆ™æˆªå±åŒæ ·å°†å…¶æˆªå±å‡ºæ¥ã€‚ç»§ç»­å›åˆ°æˆ‘ä»¬çš„takeScreenshotæ–¹æ³•ï¼Œç„¶åè°ƒç”¨äº†ï¼š 12// Take the screenshotmScreenBitmap = SurfaceControl.screenshot((int) dims[0], (int) dims[1]); æ–¹æ³•ï¼Œçœ‹æ³¨é‡Šï¼Œè¿™é‡Œå°±æ˜¯æ‰§è¡Œæˆªå±äº‹ä»¶çš„å…·ä½“æ“ä½œäº†ï¼Œç„¶åæˆ‘çœ‹ä¸€ä¸‹SurfaceControl.screenshotæ–¹æ³•çš„å…·ä½“å®ç°ï¼Œå¦å¤–è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆªå±ä¹‹åè¿”å›çš„æ˜¯ä¸€ä¸ªBitmapå¯¹è±¡ï¼Œå…¶å®ç†Ÿæ‚‰androidç»˜åˆ¶æœºåˆ¶çš„ç«¥é‹åº”è¯¥çŸ¥é“androidä¸­æ‰€æœ‰æ˜¾ç¤ºèƒ½å¤Ÿæ˜¾ç¤ºçš„ä¸œè¥¿ï¼Œåœ¨å†…å­˜ä¸­è¡¨ç°éƒ½æ˜¯Bitmapå¯¹è±¡ã€‚ 1234567public static Bitmap screenshot(int width, int height) { // TODO: should take the display as a parameter IBinder displayToken = SurfaceControl.getBuiltInDisplay( SurfaceControl.BUILT_IN_DISPLAY_ID_MAIN); return nativeScreenshot(displayToken, new Rect(), width, height, 0, 0, true, false, Surface.ROTATION_0); } å¥½å§ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯nativeScreenshotæ–¹æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œå…·ä½“çš„å®ç°åœ¨JNIå±‚ï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šçš„ä»‹ç»äº†ã€‚ç»§ç»­å›åˆ°æˆ‘ä»¬çš„takeScreenshotæ–¹æ³•ï¼Œåœ¨è°ƒç”¨äº†æˆªå±æ–¹æ³•screentshotä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦æˆªå±æˆåŠŸï¼š 12345if (mScreenBitmap == null) { notifyScreenshotError(mContext, mNotificationManager); finisher.run(); return; } è‹¥æˆªå±ä¹‹åï¼Œæˆªå±çš„bitmapå¯¹è±¡ä¸ºç©ºï¼Œè¿™é‡Œåˆ¤æ–­æˆªå±å¤±è´¥ï¼Œè°ƒç”¨äº†notifyScreenshotErroræ–¹æ³•ï¼Œå‘é€æˆªå±å¤±è´¥çš„notificationé€šçŸ¥ã€‚ 123456789101112131415161718192021static void notifyScreenshotError(Context context, NotificationManager nManager) { Resources r = context.getResources(); // Clear all existing notification, compose the new notification and show it Notification.Builder b = new Notification.Builder(context) .setTicker(r.getString(R.string.screenshot_failed_title)) .setContentTitle(r.getString(R.string.screenshot_failed_title)) .setContentText(r.getString(R.string.screenshot_failed_text)) .setSmallIcon(R.drawable.stat_notify_image_error) .setWhen(System.currentTimeMillis()) .setVisibility(Notification.VISIBILITY_PUBLIC) // ok to show outside lockscreen .setCategory(Notification.CATEGORY_ERROR) .setAutoCancel(true) .setColor(context.getColor( com.android.internal.R.color.system_notification_accent_color)); Notification n = new Notification.BigTextStyle(b) .bigText(r.getString(R.string.screenshot_failed_text)) .build(); nManager.notify(R.id.notification_screenshot, n); } ç„¶åç»§ç»­çœ‹takeScreenshotæ–¹æ³•ï¼Œåˆ¤æ–­æˆªå±çš„å›¾åƒæ˜¯å¦éœ€è¦æ—‹è½¬ï¼Œè‹¥éœ€è¦çš„è¯ï¼Œåˆ™æ—‹è½¬å›¾åƒï¼š 1234567891011121314if (requiresRotation) { // Rotate the screenshot to the current orientation Bitmap ss = Bitmap.createBitmap(mDisplayMetrics.widthPixels, mDisplayMetrics.heightPixels, Bitmap.Config.ARGB_8888); Canvas c = new Canvas(ss); c.translate(ss.getWidth() / 2, ss.getHeight() / 2); c.rotate(degrees); c.translate(-dims[0] / 2, -dims[1] / 2); c.drawBitmap(mScreenBitmap, 0, 0, null); c.setBitmap(null); // Recycle the previous bitmap mScreenBitmap.recycle(); mScreenBitmap = ss; } åœ¨takeScreenshotæ–¹æ³•çš„æœ€åè‹¥æˆªå±æˆåŠŸï¼Œæˆ‘ä»¬è°ƒç”¨äº†ï¼š 123// Start the post-screenshot animation startAnimation(finisher, mDisplayMetrics.widthPixels, mDisplayMetrics.heightPixels, statusBarVisible, navBarVisible); å¼€å§‹æˆªå±çš„åŠ¨ç”»ï¼Œå¥½å§ï¼Œçœ‹ä¸€ä¸‹åŠ¨ç”»æ•ˆæœçš„å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445/** * Starts the animation after taking the screenshot */ private void startAnimation(final Runnable finisher, int w, int h, boolean statusBarVisible, boolean navBarVisible) { // Add the view for the animation mScreenshotView.setImageBitmap(mScreenBitmap); mScreenshotLayout.requestFocus(); // Setup the animation with the screenshot just taken if (mScreenshotAnimation != null) { mScreenshotAnimation.end(); mScreenshotAnimation.removeAllListeners(); } mWindowManager.addView(mScreenshotLayout, mWindowLayoutParams); ValueAnimator screenshotDropInAnim = createScreenshotDropInAnimation(); ValueAnimator screenshotFadeOutAnim = createScreenshotDropOutAnimation(w, h, statusBarVisible, navBarVisible); mScreenshotAnimation = new AnimatorSet(); mScreenshotAnimation.playSequentially(screenshotDropInAnim, screenshotFadeOutAnim); mScreenshotAnimation.addListener(new AnimatorListenerAdapter() { @Override public void onAnimationEnd(Animator animation) { // Save the screenshot once we have a bit of time now saveScreenshotInWorkerThread(finisher); mWindowManager.removeView(mScreenshotLayout); // Clear any references to the bitmap mScreenBitmap = null; mScreenshotView.setImageBitmap(null); } }); mScreenshotLayout.post(new Runnable() { @Override public void run() { // Play the shutter sound to notify that we've taken a screenshot mCameraSound.play(MediaActionSound.SHUTTER_CLICK); mScreenshotView.setLayerType(View.LAYER_TYPE_HARDWARE, null); mScreenshotView.buildLayer(); mScreenshotAnimation.start(); } }); } å¥½å§ï¼Œç»è¿‡ç€ä¸€äº›åˆ—çš„æ“ä½œä¹‹åæˆ‘ä»¬å®ç°äº†æˆªå±ä¹‹åçš„åŠ¨ç”»æ•ˆæœäº†ï¼Œè¿™é‡Œæš‚æ—¶ä¸åˆ†æåŠ¨ç”»æ•ˆæœï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹åŠ¨ç”»æ•ˆæœä¹‹ååšäº†å“ªäº›ï¼Ÿè¿˜è®°ä¸è®°çš„ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æˆªå±ä¹‹åéƒ½ä¼šæ”¶åˆ°ä¸€ä¸ªæˆªå±çš„notificationé€šçŸ¥ï¼Ÿè¿™é‡Œåº”è¯¥ä¹Ÿæ˜¯åœ¨å…¶AnimatorListenerAdapterçš„onAnimationEndæ–¹æ³•ä¸­å®ç°çš„ï¼Œä¹Ÿå°±æ˜¯åŠ¨ç”»æ‰§è¡Œå®Œæˆä¹‹åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶saveScreenshotInWorkerThreadæ–¹æ³•çš„å®ç°ï¼š 1234567891011121314151617/** * Creates a new worker thread and saves the screenshot to the media store. */ private void saveScreenshotInWorkerThread(Runnable finisher) { SaveImageInBackgroundData data = new SaveImageInBackgroundData(); data.context = mContext; data.image = mScreenBitmap; data.iconSize = mNotificationIconSize; data.finisher = finisher; data.previewWidth = mPreviewWidth; data.previewheight = mPreviewHeight; if (mSaveInBgTask != null) { mSaveInBgTask.cancel(false); } mSaveInBgTask = new SaveImageInBackgroundTask(mContext, data, mNotificationManager, R.id.notification_screenshot).execute(data); } å¥½å§ï¼Œè¿™é‡Œä¸»è¦é€»è¾‘å°±æ˜¯æ„é€ äº†ä¸€ä¸ªSaveImageInBackgroundTaskå¯¹è±¡ï¼Œçœ‹æ ·å­å‘é€æˆªå±æˆåŠŸçš„é€šçŸ¥åº”è¯¥æ˜¯åœ¨è¿™é‡Œå®ç°çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹SaveImageInBackgroundTaskæ„é€ æ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647SaveImageInBackgroundTask(Context context, SaveImageInBackgroundData data, NotificationManager nManager, int nId) { ... // Show the intermediate notification mTickerAddSpace = !mTickerAddSpace; mNotificationId = nId; mNotificationManager = nManager; final long now = System.currentTimeMillis(); mNotificationBuilder = new Notification.Builder(context) .setTicker(r.getString(R.string.screenshot_saving_ticker) + (mTickerAddSpace ? &quot; &quot; : &quot;&quot;)) .setContentTitle(r.getString(R.string.screenshot_saving_title)) .setContentText(r.getString(R.string.screenshot_saving_text)) .setSmallIcon(R.drawable.stat_notify_image) .setWhen(now) .setColor(r.getColor(com.android.internal.R.color.system_notification_accent_color)); mNotificationStyle = new Notification.BigPictureStyle() .bigPicture(picture.createAshmemBitmap()); mNotificationBuilder.setStyle(mNotificationStyle); // For &quot;public&quot; situations we want to show all the same info but // omit the actual screenshot image. mPublicNotificationBuilder = new Notification.Builder(context) .setContentTitle(r.getString(R.string.screenshot_saving_title)) .setContentText(r.getString(R.string.screenshot_saving_text)) .setSmallIcon(R.drawable.stat_notify_image) .setCategory(Notification.CATEGORY_PROGRESS) .setWhen(now) .setColor(r.getColor( com.android.internal.R.color.system_notification_accent_color)); mNotificationBuilder.setPublicVersion(mPublicNotificationBuilder.build()); Notification n = mNotificationBuilder.build(); n.flags |= Notification.FLAG_NO_CLEAR; mNotificationManager.notify(nId, n); // On the tablet, the large icon makes the notification appear as if it is clickable (and // on small devices, the large icon is not shown) so defer showing the large icon until // we compose the final post-save notification below. mNotificationBuilder.setLargeIcon(icon.createAshmemBitmap()); // But we still don't set it for the expanded view, allowing the smallIcon to show here. mNotificationStyle.bigLargeIcon((Bitmap) null); } å¯ä»¥å‘ç°åœ¨æ„é€ æ–¹æ³•çš„åé¢ç‹—ä»”äº†ä¸€ä¸ªNotificationBuilderå¯¹è±¡ï¼Œç„¶åå‘é€äº†ä¸€ä¸ªæˆªå±æˆåŠŸçš„Notificationï¼Œè¿™æ ·æˆ‘ä»¬åœ¨æˆªå±åŠ¨ç”»ä¹‹åå°±æ”¶åˆ°äº†Notificationçš„é€šçŸ¥äº†ã€‚ æ€»ç»“ï¼š åœ¨PhoneWindowManagerçš„dispatchUnhandledKeyæ–¹æ³•ä¸­å¤„ç†Appæ— æ³•å¤„ç†çš„æŒ‰é”®äº‹ä»¶ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬éŸ³é‡å‡å°‘é”®å’Œç”µæºæŒ‰é”®çš„ç»„åˆæŒ‰é”® é€šè¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨å¯åŠ¨TakeScreenshotServiceæœåŠ¡ï¼Œå¹¶é€šè¿‡å…¶æ‰§è¡Œæˆªå±çš„æ“ä½œã€‚ å…·ä½“çš„æˆªå±ä»£ç æ˜¯åœ¨nativeå±‚å®ç°çš„ã€‚ æˆªå±æ“ä½œæ—¶å€™ï¼Œè‹¥æˆªå±å¤±è´¥åˆ™ç›´æ¥å‘é€æˆªå±å¤±è´¥çš„notificationé€šçŸ¥ã€‚ æˆªå±ä¹‹åï¼Œè‹¥æˆªå±æˆåŠŸï¼Œåˆ™å…ˆæ‰§è¡Œæˆªå±çš„åŠ¨ç”»ï¼Œå¹¶åœ¨åŠ¨ç”»æ•ˆæœæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå‘é€æˆªå±æˆåŠŸçš„notificationçš„é€šçŸ¥ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåäºŒï¼‰â€“&gt;ToaståŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸‰ï¼‰â€“&gt;Androidå¼‚å¸¸å¤„ç†æµç¨‹androidæºç è§£æï¼ˆäºŒåå››ï¼‰â€“&gt;onSaveInstanceStateæ‰§è¡Œæ—¶æœºandroidæºç è§£æï¼ˆäºŒåäº”ï¼‰â€“&gt;onLowMemoryæ‰§è¡Œæµç¨‹","link":"/2020/09/11/%E6%88%AA%E5%B1%8F%E4%BA%8B%E4%BB%B6%E6%B5%81%E7%A8%8B/"},{"title":"17 Activityå¸ƒå±€åŠ è½½æµç¨‹","text":"å¥½å§ï¼Œç»ˆäºè¦å¼€å§‹è®²è®²Activityçš„å¸ƒå±€åŠ è½½æµç¨‹äº†ï¼Œå¤§å®¶éƒ½çŸ¥é“åœ¨Androidä½“ç³»ä¸­Activityæ‰®æ¼”äº†ä¸€ä¸ªç•Œé¢å±•ç¤ºçš„è§’è‰²ï¼Œè¿™ä¹Ÿæ˜¯å®ƒä¸androidä¸­å¦å¤–ä¸€ä¸ªå¾ˆé‡è¦çš„ç»„ä»¶Serviceæœ€å¤§çš„ä¸åŒï¼Œä½†æ˜¯è¿™ä¸ªå±•ç¤ºçš„ç•Œé¢çš„åŠŸèƒ½æ˜¯Activityç›´æ¥æ§åˆ¶çš„ä¹ˆï¼Ÿç•Œé¢çš„å¸ƒå±€æ–‡ä»¶æ˜¯å¦‚ä½•åŠ è½½åˆ°å†…å­˜å¹¶è¢«Activityç®¡ç†çš„ï¼Ÿandroidä¸­çš„Viewæ˜¯ä¸€ä¸ªæ€æ ·çš„æ¦‚å¿µï¼ŸåŠ è½½åˆ°å†…å­˜ä¸­çš„å¸ƒå±€æ–‡ä»¶æ˜¯å¦‚ä½•ç»˜åˆ¶å‡ºæ¥çš„ï¼Ÿ è¦æƒ³å›ç­”è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦å¯¹androidçš„ç•Œé¢åŠ è½½ä¸ç»˜åˆ¶æµç¨‹æœ‰æ‰€äº†è§£ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸€ä¸‹Activityçš„å¸ƒå±€åŠ è½½çš„æµç¨‹ã€‚è€Œè‡³äºAcitivtyçš„å¸ƒå±€ç»˜åˆ¶æµç¨‹æˆ‘ä»¬åœ¨ä¸‹ä¸€ç¯‡ä¸­åœ¨åšä»‹ç»ã€‚ å…¶å®Activityå¯¹ç•Œé¢å¸ƒå±€çš„ç®¡ç†æ˜¯éƒ½æ˜¯é€šè¿‡Windowå¯¹è±¡æ¥å®ç°çš„ï¼ŒWindowå¯¹è±¡ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸€ä¸ªçª—å£å¯¹è±¡ï¼Œè€ŒActivityä»ç”¨æˆ·è§’åº¦å°±æ˜¯ä¸€ä¸ªä¸ªçš„çª—å£å®ä¾‹ï¼Œå› æ­¤ä¸éš¾æƒ³è±¡æ¯ä¸ªActivityä¸­éƒ½å¯¹åº”ç€ä¸€ä¸ªWindowå¯¹è±¡ï¼Œè€Œè¿™ä¸ªWindowå¯¹è±¡å°±æ˜¯è´Ÿè´£åŠ è½½æ˜¾ç¤ºç•Œé¢çš„ã€‚è‡³äºwindowå¯¹è±¡æ˜¯å¦‚ä½•å±•ç¤ºä¸åŒçš„ç•Œé¢çš„ï¼Œé‚£æ˜¯é€šè¿‡å®šä¹‰ä¸åŒçš„Viewç»„ä»¶å®ç°ä¸åŒçš„ç•Œé¢å±•ç¤ºã€‚ åºŸè¯ä¸å¤šè¯´äº†ï¼Œä¸çŸ¥é“å¤§å®¶æ˜¯å¦è¿˜è®°å¾—æˆ‘ä»¬è®²è¿‡çš„Activityçš„å¯åŠ¨æµç¨‹ä¹ˆï¼Ÿä¸ç†Ÿæ‚‰çš„ç«¥é‹å¯ä»¥å‚è€ƒï¼š androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹ ï¼Œåœ¨æ–‡ç« ä¸­æˆ‘ä»¬ä»‹ç»åˆ°å½“ActivityManagerServiceæ¥æ”¶åˆ°å¯åŠ¨Activityçš„è¯·æ±‚ä¹‹åä¼šé€šè¿‡IApplicationThreadè¿›ç¨‹é—´é€šè®¯å‘ŠçŸ¥ApplicationThreadå¹¶æ‰§è¡ŒhandleLauncherActivityæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥ä¸‹å…¶å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent) { // If we are getting ready to gc after going to the background, well // we are back active so skip it. unscheduleGcIdler(); mSomeActivitiesChanged = true; if (r.profilerInfo != null) { mProfiler.setProfiler(r.profilerInfo); mProfiler.startProfiling(); } // Make sure we are running with the most recent config. handleConfigurationChanged(null, null); if (localLOGV) Slog.v( TAG, &quot;Handling launch of &quot; + r); // Initialize before creating the activity WindowManagerGlobal.initialize(); Activity a = performLaunchActivity(r, customIntent); if (a != null) { r.createdConfig = new Configuration(mConfiguration); Bundle oldState = r.state; handleResumeActivity(r.token, false, r.isForward, !r.activity.mFinished &amp;&amp; !r.startsNotResumed); if (!r.activity.mFinished &amp;&amp; r.startsNotResumed) { // The activity manager actually wants this one to start out // paused, because it needs to be visible but isn't in the // foreground. We accomplish this by going through the // normal startup (because activities expect to go through // onResume() the first time they run, before their window // is displayed), and then pausing it. However, in this case // we do -not- need to do the full pause cycle (of freezing // and such) because the activity manager assumes it can just // retain the current state it has. try { r.activity.mCalled = false; mInstrumentation.callActivityOnPause(r.activity); // We need to keep around the original state, in case // we need to be created again. But we only do this // for pre-Honeycomb apps, which always save their state // when pausing, so we can not have them save their state // when restarting from a paused state. For HC and later, // we want to (and can) let the state be saved as the normal // part of stopping the activity. if (r.isPreHoneycomb()) { r.state = oldState; } if (!r.activity.mCalled) { throw new SuperNotCalledException( &quot;Activity &quot; + r.intent.getComponent().toShortString() + &quot; did not call through to super.onPause()&quot;); } } catch (SuperNotCalledException e) { throw e; } catch (Exception e) { if (!mInstrumentation.onException(r.activity, e)) { throw new RuntimeException( &quot;Unable to pause activity &quot; + r.intent.getComponent().toShortString() + &quot;: &quot; + e.toString(), e); } } r.paused = true; } } else { // If there was an error, for any reason, tell the activity // manager to stop us. try { ActivityManagerNative.getDefault() .finishActivity(r.token, Activity.RESULT_CANCELED, null, false); } catch (RemoteException ex) { // Ignore } } }å¯ä»¥å‘ç°è¿™é‡Œçš„handleLauncherActivityæ–¹æ³•å†…éƒ¨è°ƒç”¨äº†performLaunchActivityæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿæ˜¯å…·ä½“å¯åŠ¨Activityçš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å®ƒçš„å…·ä½“å®ç°é€»è¾‘ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) { ... Activity activity = null; try { java.lang.ClassLoader cl = r.packageInfo.getClassLoader(); activity = mInstrumentation.newActivity( cl, component.getClassName(), r.intent); StrictMode.incrementExpectedActivityCount(activity.getClass()); r.intent.setExtrasClassLoader(cl); r.intent.prepareToEnterProcess(); if (r.state != null) { r.state.setClassLoader(cl); } } catch (Exception e) { if (!mInstrumentation.onException(activity, e)) { throw new RuntimeException( &quot;Unable to instantiate activity &quot; + component + &quot;: &quot; + e.toString(), e); } } ... Application app = r.packageInfo.makeApplication(false, mInstrumentation); if (localLOGV) Slog.v(TAG, &quot;Performing launch of &quot; + r); if (localLOGV) Slog.v( TAG, r + &quot;: app=&quot; + app + &quot;, appName=&quot; + app.getPackageName() + &quot;, pkg=&quot; + r.packageInfo.getPackageName() + &quot;, comp=&quot; + r.intent.getComponent().toShortString() + &quot;, dir=&quot; + r.packageInfo.getAppDir()); if (activity != null) { Context appContext = createBaseContextForActivity(r, activity); CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager()); Configuration config = new Configuration(mCompatConfiguration); if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Launching activity &quot; + r.activityInfo.name + &quot; with config &quot; + config); activity.attach(appContext, this, getInstrumentation(), r.token, r.ident, app, r.intent, r.activityInfo, title, r.parent, r.embeddedID, r.lastNonConfigurationInstances, config, r.referrer, r.voiceInteractor); ... return activity; } ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°è¿™é‡Œæ˜¯é€šè¿‡åå°„çš„æœºåˆ¶åˆ›å»ºçš„Activityï¼Œå¹¶è°ƒç”¨äº†Activityçš„attachæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é‡Œçš„attachæ–¹æ³•æ˜¯åšä»€ä¹ˆçš„å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­æ¥çœ‹ä¸€ä¸‹attachæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354final void attach(Context context, ActivityThread aThread, Instrumentation instr, IBinder token, int ident, Application application, Intent intent, ActivityInfo info, CharSequence title, Activity parent, String id, NonConfigurationInstances lastNonConfigurationInstances, Configuration config, String referrer, IVoiceInteractor voiceInteractor) { attachBaseContext(context); mFragments.attachHost(null /*parent*/); mWindow = new PhoneWindow(this); mWindow.setCallback(this); mWindow.setOnWindowDismissedCallback(this); mWindow.getLayoutInflater().setPrivateFactory(this); if (info.softInputMode != WindowManager.LayoutParams.SOFT_INPUT_STATE_UNSPECIFIED) { mWindow.setSoftInputMode(info.softInputMode); } if (info.uiOptions != 0) { mWindow.setUiOptions(info.uiOptions); } mUiThread = Thread.currentThread(); mMainThread = aThread; mInstrumentation = instr; mToken = token; mIdent = ident; mApplication = application; mIntent = intent; mReferrer = referrer; mComponent = intent.getComponent(); mActivityInfo = info; mTitle = title; mParent = parent; mEmbeddedID = id; mLastNonConfigurationInstances = lastNonConfigurationInstances; if (voiceInteractor != null) { if (lastNonConfigurationInstances != null) { mVoiceInteractor = lastNonConfigurationInstances.voiceInteractor; } else { mVoiceInteractor = new VoiceInteractor(voiceInteractor, this, this, Looper.myLooper()); } } mWindow.setWindowManager( (WindowManager)context.getSystemService(Context.WINDOW_SERVICE), mToken, mComponent.flattenToString(), (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != 0); if (mParent != null) { mWindow.setContainer(mParent.getWindow()); } mWindowManager = mWindow.getWindowManager(); mCurrentConfig = config; } å¯ä»¥çœ‹åˆ°åœ¨attachæ–¹æ³•è¿™é‡Œåˆå§‹åŒ–äº†ä¸€äº›Activityçš„æˆå‘˜å˜é‡ï¼Œä¸»è¦æ˜¯mWindowå¯¹è±¡ï¼Œå¹¶ä¸”mWindowçš„æˆå‘˜å®ä¾‹æ˜¯PhoneWindowå®ä¾‹ï¼Œè¿™æ ·ä¹Ÿä»ä¾§é¢è¯´æ˜äº†ä¸€ä¸ªActivityå¯¹åº”ç€ä¸€ä¸ªWindowå¯¹è±¡ã€‚é™¤äº†windowå¯¹è±¡è¿˜åˆå§‹åŒ–äº†ä¸€äº›Activityçš„å…¶ä»–æˆå‘˜å˜é‡ï¼Œè¿™é‡Œä¸å†åšè®¨è®ºï¼Œç»§ç»­å›åˆ°æˆ‘ä»¬çš„performLaunchActivityæ–¹æ³•ï¼Œåœ¨è°ƒç”¨äº†Activityçš„attachæ–¹æ³•ä¹‹ååˆè°ƒç”¨äº†ï¼š 1mInstrumentation.callActivityOnCreate(activity, r.state); è¿™é‡Œçš„mInstrumentationæ˜¯ç±»Instrumentationï¼Œæ¯ä¸ªåº”ç”¨è¿›ç¨‹å¯¹åº”ç€ä¸€ä¸ªInstrumentationå’Œä¸€ä¸ªActivityThreadï¼ŒInstrumentationå°±æ˜¯å…·ä½“æ“ä½œActivityå›è°ƒå…¶ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„ï¼Œæˆ‘ä»¬è¿™é‡Œçœ‹ä¸€ä¸‹å®ƒçš„callActivityOnCreateæ–¹æ³•çš„å®ç°ï¼š 12345public void callActivityOnCreate(Activity activity, Bundle icicle) { prePerformCreate(activity); activity.performCreate(icicle); postPerformCreate(activity); } è¿™é‡Œä»£ç æ¯”è¾ƒç®€æ´ï¼ŒpreOerformCreateæ–¹æ³•å’ŒpostPerformCreateæ–¹æ³•æˆ‘ä»¬è¿™é‡Œæš‚æ—¶ä¸ç®¡ï¼Œä¸»è¦çš„æ‰§è¡Œé€»è¾‘æ˜¯è°ƒç”¨äº†activity.performCreateæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Activityçš„performCreateæ–¹æ³•çš„å®ç°ï¼š 12345final void performCreate(Bundle icicle) { onCreate(icicle); mActivityTransitionState.readState(icicle); performCreateCommon(); } åŸæ¥onCreateçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•æ˜¯åœ¨è¿™é‡Œå›è°ƒçš„ï¼Œå…¶å®è¿™é‡Œçš„é€»è¾‘åœ¨å‰é¢å‡ ç¯‡æ–‡ç« ä¸­æœ‰è®²è¿°ï¼Œä¹Ÿå¯ä»¥å‚è€ƒå‰é¢çš„æ–‡ç« ã€‚ è‡³æ­¤æˆ‘ä»¬å°±å›è°ƒåˆ°äº†æˆ‘ä»¬Activityçš„onCreateæ–¹æ³•ï¼Œå¤§å®¶å¹³æ—¶åœ¨é‡å†™onCreateæ–¹æ³•çš„æ—¶å€™ï¼Œæ€ä¹ˆåŠ è½½å¸ƒå±€æ–‡ä»¶çš„å‘¢ï¼Ÿè¿™é‡Œçœ‹ä¸€ä¸‹æˆ‘ä»¬çš„onCreateæ–¹æ³•çš„å…¸å‹å†™æ³•ï¼š 12345@Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); } æ— è®ºæˆ‘ä»¬æ€ä¹ˆå˜åŒ–ï¼Œæˆ‘ä»¬çš„onCreateæ–¹æ³•ä¸€èˆ¬éƒ½æ˜¯ä¼šè°ƒç”¨è¿™ä¸¤å¥è¯çš„å§ï¼Ÿé‚£ä¹ˆè¿™é‡Œçš„ä¸¤æ®µä»£ç åˆ†è¾¨æ˜¯ä»€ä¹ˆå«ä¹‰å‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹super.onCreateæ–¹æ³•çš„å®ç°é€»è¾‘ï¼Œç”±äºæˆ‘ä»¬çš„Activityç±»ç»§æ‰¿ä¸Activityï¼Œæ‰€ä»¥è¿™é‡Œçš„super.onCreateæ–¹æ³•ï¼Œå°±æ˜¯è°ƒç”¨çš„Activity.onCreateæ–¹æ³•ï¼Œå¥½å§ï¼Œæ—¢ç„¶è¿™æ ·æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Activityçš„onCreateæ–¹æ³•ï¼š 123456789101112131415161718192021222324protected void onCreate(@Nullable Bundle savedInstanceState) { if (DEBUG_LIFECYCLE) Slog.v(TAG, &quot;onCreate &quot; + this + &quot;: &quot; + savedInstanceState); if (mLastNonConfigurationInstances != null) { mFragments.restoreLoaderNonConfig(mLastNonConfigurationInstances.loaders); } if (mActivityInfo.parentActivityName != null) { if (mActionBar == null) { mEnableDefaultActionBarUp = true; } else { mActionBar.setDefaultDisplayHomeAsUpEnabled(true); } } if (savedInstanceState != null) { Parcelable p = savedInstanceState.getParcelable(FRAGMENTS_TAG); mFragments.restoreAllState(p, mLastNonConfigurationInstances != null ? mLastNonConfigurationInstances.fragments : null); } mFragments.dispatchCreate(); getApplication().dispatchActivityCreated(this, savedInstanceState); if (mVoiceInteractor != null) { mVoiceInteractor.attachActivity(this); } mCalled = true; } å¯ä»¥å‘ç°ï¼ŒActivityçš„onCreateæ–¹æ³•ä¸»è¦æ˜¯åšäº†ä¸€äº›Acitivtyçš„åˆå§‹åŒ–æ“ä½œï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬ä¸åœ¨è‡ªå·±çš„Activityè°ƒç”¨super.onCreateæ–¹æ³•å‘¢ï¼Ÿå¥½å§ï¼Œå°è¯•ä¹‹åï¼ŒAndroidStudioåœ¨æ‰“å¼€çš„Acitivtyçš„onCreateæ–¹æ³•ä¸­å¦‚æœä¸è°ƒç”¨super.onCreateæ–¹æ³•çš„è¯ï¼Œä¼šæŠ¥é”™ã€‚ã€‚ã€‚æœ‰æœ¨æœ‰æé”™ã€‚ã€‚ã€‚ 1FATAL EXCEPTION: main Process: com.example.aaron.helloworld, PID: 18001 android.util.SuperNotCalledException: Activity {com.example.aaron.helloworld/com.example.aaron.helloworld.SecondActivity} did not call through to super.onCreate() at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2422) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:2528) at android.app.ActivityThread.access$800(ActivityThread.java:169) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1421) at android.os.Handler.dispatchMessage(Handler.java:111) at android.os.Looper.loop(Looper.java:194) at android.app.ActivityThread.main(ActivityThread.java:5552) at java.lang.reflect.Method.invoke(Native Method) at java.lang.reflect.Method.invoke(Method.java:372) at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:964) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:759) å¯ä»¥çœ‹åˆ°å¦‚æœä¸è°ƒç”¨super.onCreateæ–¹æ³•çš„è¯ï¼Œä¼šåœ¨Activityçš„performLaunchActivityä¸­æŠ¥é”™ï¼Œæˆ‘ä»¬çŸ¥é“è¿™é‡Œçš„performLaunchActivityæ–¹æ³•å°±æ˜¯æˆ‘ä»¬å¯åŠ¨Activityçš„æ—¶å€™å›å›è°ƒçš„æ–¹æ³•ï¼Œæˆ‘ä»¬æ‰¾æ‰¾æ–¹æ³•ä½“å®ç°ä¸­throwsçš„Exceptionã€‚ã€‚ã€‚ 1234567891011activity.mCalled = false; if (r.isPersistable()) { mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState); } else { mInstrumentation.callActivityOnCreate(activity, r.state); } if (!activity.mCalled) { throw new SuperNotCalledException( &quot;Activity &quot; + r.intent.getComponent().toShortString() + &quot; did not call through to super.onCreate()&quot;); } åœ¨Activityçš„performLaunchActivityæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨äº†Activityçš„onCreateæ–¹æ³•ä¹‹åä¼šæ‰§è¡Œä¸€ä¸ªåˆ¤æ–­é€»è¾‘ï¼Œè‹¥Activityçš„mCalledä¸ºfalseï¼Œåˆ™ä¼šæŠ›å‡ºæˆ‘ä»¬åˆšåˆšæ•è·çš„å¼‚å¸¸ï¼Œé‚£ä¹ˆè¿™ä¸ªmCalledæˆå‘˜å˜é‡æ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¢«èµ‹å€¼çš„å‘¢ï¼Ÿå¥½å§ï¼Œå°±æ˜¯åœ¨Activityçš„onCreateæ–¹æ³•èµ‹å€¼çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å®ç°è‡ªå·±çš„Activityçš„æ—¶å€™åªæœ‰è°ƒç”¨äº†super.onCreateæ–¹æ³•æ‰ä¸ä¼šæŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ï¼Œåè¿‡æ¥è¯´ï¼Œæˆ‘ä»¬å®ç°è‡ªå·±çš„Actiivtyï¼Œé‚£ä¹ˆä¸€å®šè¦åœ¨onCreateæ–¹æ³•ä¸­è°ƒç”¨super.onCreateæ–¹æ³•ã€‚ ç„¶åæˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹onCreateä¸­çš„setContentViewæ–¹æ³•ï¼Œè¿™é‡Œçš„å‚æ•°å°±æ˜¯ä¸€ä¸ªLayoutå¸ƒå±€æ–‡ä»¶ï¼Œå¯ä»¥å‘ç°è¿™é‡Œçš„setContentViewæ–¹æ³•å°±æ˜¯Acitivtyä¸­çš„setContentViewï¼Œå¥½å§æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Activityä¸­setContentViewçš„å®ç°ï¼š 1234public void setContentView(@LayoutRes int layoutResID) { getWindow().setContentView(layoutResID); initWindowDecorActionBar(); } è¿™é‡Œçš„getWindowæ–¹æ³•å°±æ˜¯è·å–Acitivtyçš„mWindowæˆå‘˜å˜é‡ï¼Œä»åˆšåˆšæˆ‘ä»¬åœ¨Activity.attachæ–¹æ³•æˆ‘ä»¬çŸ¥é“è¿™é‡Œçš„mWindowçš„å®ä¾‹æ˜¯PhoneWindowï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„å…¶å®æ˜¯PhoneWindowçš„setConentViewæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹PhoneWindowçš„setContentViewæ˜¯å¦‚ä½•å®ç°çš„ã€‚ 123456789101112131415161718192021222324@Override public void setContentView(int layoutResID) { // Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window // decor, when theme attributes and the like are crystalized. Do not check the feature // before this happens. if (mContentParent == null) { installDecor(); } else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) { mContentParent.removeAllViews(); } if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) { final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID, getContext()); transitionTo(newScene); } else { mLayoutInflater.inflate(layoutResID, mContentParent); } mContentParent.requestApplyInsets(); final Callback cb = getCallback(); if (cb != null &amp;&amp; !isDestroyed()) { cb.onContentChanged(); } } è¿™é‡Œçš„mContentParentå¯¹è±¡æ˜¯ä¸€ä¸ªViewå¯¹è±¡ï¼Œç”±äºç¬¬ä¸€æ¬¡mContentParentä¸ºç©ºï¼Œæ‰€ä»¥æ‰§è¡ŒinstallerDectoræ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹installerDectoræ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567891011private void installDecor() { if (mDecor == null) { mDecor = generateDecor(); mDecor.setDescendantFocusability(ViewGroup.FOCUS_AFTER_DESCENDANTS); mDecor.setIsRootNamespace(true); if (!mInvalidatePanelMenuPosted &amp;&amp; mInvalidatePanelMenuFeatures != 0) { mDecor.postOnAnimation(mInvalidatePanelMenuRunnable); } } ... } è¿™é‡Œçš„mDectoræ˜¯ä¸€ä¸ªDectorViewå¯¹è±¡ï¼Œè€ŒDectorViewç»§æ‰¿ä¸FrameLayoutï¼Œæ‰€ä»¥è¿™é‡Œçš„mDectorå…¶å®å°±æ˜¯ä¸€ä¸ªFrameLayoutå¯¹è±¡ï¼Œå¹¶é€šè¿‡è°ƒç”¨generateDector()æ–¹æ³•åˆå§‹åŒ–ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹generateDectoræ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123protected DecorView generateDecor() { return new DecorView(getContext(), -1); } å¥½å§ï¼Œå°±æ˜¯é€šè¿‡newçš„æ–¹å¼åˆ›å»ºäº†ä¸€ä¸ªDectorViewå¯¹è±¡ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­çœ‹installDectoræ–¹æ³•ï¼š 12if (mContentParent == null) { mContentParent = generateLayout(mDecor); è¿™é‡Œåˆå§‹åŒ–äº†mContentParentå¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªViewå¯¹è±¡ï¼Œæˆ‘ä»¬è°ƒç”¨äº†generateLayoutæ–¹æ³•ï¼Œå¥½å§ï¼Œæ¥çœ‹ä¸€ä¸‹generateLayoutæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122protected ViewGroup generateLayout(DecorView decor) { ... // Inflate the window decor. int layoutResource; int features = getLocalFeatures(); // System.out.println(&quot;Features: 0x&quot; + Integer.toHexString(features)); if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) { layoutResource = R.layout.screen_swipe_dismiss; } else if ((features &amp; ((1 &lt;&lt; FEATURE_LEFT_ICON) | (1 &lt;&lt; FEATURE_RIGHT_ICON))) != 0) { if (mIsFloating) { TypedValue res = new TypedValue(); getContext().getTheme().resolveAttribute( R.attr.dialogTitleIconsDecorLayout, res, true); layoutResource = res.resourceId; } else { layoutResource = R.layout.screen_title_icons; } // XXX Remove this once action bar supports these features. removeFeature(FEATURE_ACTION_BAR); // System.out.println(&quot;Title Icons!&quot;); } else if ((features &amp; ((1 &lt;&lt; FEATURE_PROGRESS) | (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != 0 &amp;&amp; (features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) == 0) { // Special case for a window with only a progress bar (and title). // XXX Need to have a no-title version of embedded windows. layoutResource = R.layout.screen_progress; // System.out.println(&quot;Progress!&quot;); } else if ((features &amp; (1 &lt;&lt; FEATURE_CUSTOM_TITLE)) != 0) { // Special case for a window with a custom title. // If the window is floating, we need a dialog layout if (mIsFloating) { TypedValue res = new TypedValue(); getContext().getTheme().resolveAttribute( R.attr.dialogCustomTitleDecorLayout, res, true); layoutResource = res.resourceId; } else { layoutResource = R.layout.screen_custom_title; } // XXX Remove this once action bar supports these features. removeFeature(FEATURE_ACTION_BAR); } else if ((features &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) == 0) { // If no other features and not embedded, only need a title. // If the window is floating, we need a dialog layout if (mIsFloating) { TypedValue res = new TypedValue(); getContext().getTheme().resolveAttribute( R.attr.dialogTitleDecorLayout, res, true); layoutResource = res.resourceId; } else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) != 0) { layoutResource = a.getResourceId( R.styleable.Window_windowActionBarFullscreenDecorLayout, R.layout.screen_action_bar); } else { layoutResource = R.layout.screen_title; } // System.out.println(&quot;Title!&quot;); } else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_MODE_OVERLAY)) != 0) { layoutResource = R.layout.screen_simple_overlay_action_mode; } else { // Embedded, so no decoration is needed. layoutResource = R.layout.screen_simple; // System.out.println(&quot;Simple!&quot;); } mDecor.startChanging(); View in = mLayoutInflater.inflate(layoutResource, null); decor.addView(in, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT)); mContentRoot = (ViewGroup) in; ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT); if (contentParent == null) { throw new RuntimeException(&quot;Window couldn't find content container view&quot;); } if ((features &amp; (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS)) != 0) { ProgressBar progress = getCircularProgressBar(false); if (progress != null) { progress.setIndeterminate(true); } } if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) { registerSwipeCallbacks(); } // Remaining setup -- of background and title -- that only applies // to top-level windows. if (getContainer() == null) { final Drawable background; if (mBackgroundResource != 0) { background = getContext().getDrawable(mBackgroundResource); } else { background = mBackgroundDrawable; } mDecor.setWindowBackground(background); final Drawable frame; if (mFrameResource != 0) { frame = getContext().getDrawable(mFrameResource); } else { frame = null; } mDecor.setWindowFrame(frame); mDecor.setElevation(mElevation); mDecor.setClipToOutline(mClipToOutline); if (mTitle != null) { setTitle(mTitle); } if (mTitleColor == 0) { mTitleColor = mTextColor; } setTitleColor(mTitleColor); } mDecor.finishChanging(); return contentParent; } å¯ä»¥å‘ç°è¿™é‡Œå°±æ˜¯é€šè¿‡è°ƒç”¨LayoutInflater.inflateæ–¹æ³•æ¥åŠ è½½å¸ƒå±€æ–‡ä»¶åˆ°å†…å­˜ä¸­ï¼Œå…³äºLayoutInflater.inflateræ˜¯å¦‚ä½•åŠ è½½å¸ƒå±€æ–‡ä»¶çš„ï¼Œå¹¶ä¸”ï¼Œé€šè¿‡å¯¹ä»£ç çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°PhoneWindowä¸­çš„å‡ ä¸ªæˆå‘˜å˜é‡ï¼šmDectorï¼ŒmContentRootï¼ŒmContentParentçš„å…³ç³»mDector â€“&gt; mContentRoot â€“&gt; mContentParentï¼ˆåŒ…å«ï¼‰å¹¶ä¸”æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¸å‹çš„å¸ƒå±€æ–‡ä»¶ï¼š 12345678910111213141516171819&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:fitsSystemWindows=&quot;true&quot; android:orientation=&quot;vertical&quot;&gt; &lt;ViewStub android:id=&quot;@+id/action_mode_bar_stub&quot; android:inflatedId=&quot;@+id/action_mode_bar&quot; android:layout=&quot;@layout/action_mode_bar&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;wrap_content&quot; android:theme=&quot;?attr/actionBarTheme&quot; /&gt; &lt;FrameLayout android:id=&quot;@android:id/content&quot; android:layout_width=&quot;match_parent&quot; android:layout_height=&quot;match_parent&quot; android:foregroundInsidePadding=&quot;false&quot; android:foregroundGravity=&quot;fill_horizontal|top&quot; android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;&lt;/LinearLayout&gt; è¿™é‡Œå°±æ˜¯æ•´ä¸ªActivityåŠ è½½çš„è·Ÿå¸ƒå±€æ–‡ä»¶ï¼šscreen_simple.xmlï¼Œå…¶ä¸­ViewStubå¯¹åº”ç€Activityä¸­çš„titleBarè€Œè¿™é‡Œçš„FrameLayouté‡Œé¢ä¸»è¦ç”¨äºå¡«å……å†…å®¹ã€‚ ç„¶åæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹LayoutInflater.inflateræ–¹æ³•ï¼š 123public View inflate(@LayoutRes int resource, @Nullable ViewGroup root) { return inflate(resource, root, root != null); } è¿™é‡Œè°ƒç”¨äº†inflateçš„é‡è½½æ–¹æ³•ã€‚ã€‚ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) { synchronized (mConstructorArgs) { Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;inflate&quot;); final Context inflaterContext = mContext; final AttributeSet attrs = Xml.asAttributeSet(parser); Context lastContext = (Context) mConstructorArgs[0]; mConstructorArgs[0] = inflaterContext; View result = root; try { // Look for the root node. int type; while ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp; type != XmlPullParser.END_DOCUMENT) { // Empty } if (type != XmlPullParser.START_TAG) { throw new InflateException(parser.getPositionDescription() + &quot;: No start tag found!&quot;); } final String name = parser.getName(); if (DEBUG) { System.out.println(&quot;**************************&quot;); System.out.println(&quot;Creating root view: &quot; + name); System.out.println(&quot;**************************&quot;); } if (TAG_MERGE.equals(name)) { if (root == null || !attachToRoot) { throw new InflateException(&quot;&lt;merge /&gt; can be used only with a valid &quot; + &quot;ViewGroup root and attachToRoot=true&quot;); } rInflate(parser, root, inflaterContext, attrs, false); } else { // Temp is the root view that was found in the xml final View temp = createViewFromTag(root, name, inflaterContext, attrs); ViewGroup.LayoutParams params = null; if (root != null) { if (DEBUG) { System.out.println(&quot;Creating params from root: &quot; + root); } // Create layout params that match root, if supplied params = root.generateLayoutParams(attrs); if (!attachToRoot) { // Set the layout params for temp if we are not // attaching. (If we are, we use addView, below) temp.setLayoutParams(params); } } if (DEBUG) { System.out.println(&quot;-----&gt; start inflating children&quot;); } // Inflate all children under temp against its context. rInflateChildren(parser, temp, attrs, true); if (DEBUG) { System.out.println(&quot;-----&gt; done inflating children&quot;); } // We are supposed to attach all the views we found (int temp) // to root. Do that now. if (root != null &amp;&amp; attachToRoot) { root.addView(temp, params); } // Decide whether to return the root that was passed in or the // top view found in xml. if (root == null || !attachToRoot) { result = temp; } } } catch (XmlPullParserException e) { InflateException ex = new InflateException(e.getMessage()); ex.initCause(e); throw ex; } catch (Exception e) { InflateException ex = new InflateException( parser.getPositionDescription() + &quot;: &quot; + e.getMessage()); ex.initCause(e); throw ex; } finally { // Don't retain static reference on context. mConstructorArgs[0] = lastContext; mConstructorArgs[1] = null; } Trace.traceEnd(Trace.TRACE_TAG_VIEW); return result; } } é€šè¿‡åˆ†ææºç ï¼Œä¸éš¾å‘ç°ï¼Œä¸»è¦æ˜¯é€šè¿‡å¾ªç¯è§£æxmlæ–‡ä»¶å¹¶å°†ä¿¡æ¯è§£æåˆ°å†…å­˜Viewå¯¹è±¡ï¼Œå¸ƒå±€æ–‡ä»¶ä¸­å®šä¹‰çš„ä¸€ä¸ªä¸ªç»„ä»¶éƒ½è¢«é¡ºåºçš„è§£æåˆ°äº†å†…å­˜ä¸­å¹¶è¢«çˆ¶å­Viewçš„å½¢å¼ç»„ç»‡èµ·æ¥ï¼Œè¿™æ ·é€šè¿‡ç»™å®šçš„ä¸€ä¸ªroot Viewå°±å¯ä»¥å°†æ•´ä¸ªå¸ƒå±€æ–‡ä»¶ä¸­å®šä¹‰çš„ç»„ä»¶å…¨éƒ¨è§£æã€‚åˆ†æå®Œè§£æå¸ƒå±€æ–‡ä»¶ï¼Œå›åˆ°æˆ‘ä»¬çš„setContentVIewæ–¹æ³•ï¼Œåœ¨è°ƒç”¨äº†installDectoræ–¹æ³•ä¹‹åï¼Œåˆè°ƒç”¨äº†ï¼š 1mLayoutInflater.inflate(layoutResID, mContentParent); è¿™ä¸ªæ–¹æ³•çš„å«ä¹‰å°±æ˜¯å°†æˆ‘ä»¬ä¼ é€’çš„å®¢æˆ·ç«¯çš„layoutIdå¯¹åº”çš„å¸ƒå±€æ–‡ä»¶ä½œä¸ºmContentParentçš„å­ViewåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œè¿™æ ·æˆ‘ä»¬çš„layoutIdä½œä¸ºmContentParentçš„å­Viewï¼Œè€ŒmContentParentåˆæ˜¯mContentRootçš„å­Viewï¼ŒmContentRootåˆæ˜¯mDectorçš„å­Viewï¼Œé€šè¿‡LayoutInflaterçš„inflateæ–¹æ³•é€æ­¥åŠ è½½åˆ°äº†å†…å­˜ä¸­ï¼Œè€Œæˆ‘ä»¬çš„ActivityåˆæŒæœ‰è‡ªèº«çš„PhoneWindowçš„å¼•ç”¨ï¼Œè¿™å°±ç›¸å½“äºæˆ‘ä»¬çš„ActivityæŒæœ‰äº†æˆ‘ä»¬å®šä¹‰çš„å¸ƒå±€æ–‡ä»¶çš„å¼•ç”¨ï¼Œå› è€ŒActivityçš„å¸ƒå±€æ–‡ä»¶è¢«åŠ è½½åˆ°äº†å†…å­˜ä¸­ã€‚ æ€»ç»“ï¼š Activityçš„å±•ç¤ºç•Œé¢çš„ç‰¹æ€§æ˜¯é€šè¿‡Windowå¯¹è±¡æ¥æ§åˆ¶çš„ï¼› æ¯ä¸ªActivityå¯¹è±¡éƒ½å¯¹åº”è¿™ä¸ªä¸€ä¸ªWindowå¯¹è±¡ï¼Œå¹¶ä¸”Windowå¯¹è±¡çš„åˆå§‹åŒ–åœ¨å¯åŠ¨Activityçš„æ—¶å€™å®Œæˆï¼Œåœ¨æ‰§è¡ŒActivityçš„onCreateæ–¹æ³•ä¹‹å‰ï¼› æ¯ä¸ªWindowå¯¹è±¡å†…éƒ¨éƒ½å­˜åœ¨ä¸€ä¸ªFrameLayoutç±»å‹çš„mDectorå¯¹è±¡ï¼Œå®ƒæ˜¯Acitivtyç•Œé¢çš„root viewï¼› Activityä¸­çš„windowå¯¹è±¡çš„å®ä¾‹æ˜¯PhoneWindowå¯¹è±¡ï¼ŒPhoneWindowå¯¹è±¡ä¸­çš„å‡ ä¸ªæˆå‘˜å˜é‡mDectorï¼ŒmContentRootï¼ŒmContentParentéƒ½æ˜¯Viewç»„ä»¶ï¼Œå®ƒä»¬çš„å…³ç³»æ˜¯ï¼šmDector â€“&gt; mContentRoot â€“&gt; mContentParent â€“&gt; è‡ªå®šä¹‰layoutView LayoutInflater.inflateä¸»è¦ç”¨äºå°†å¸ƒå±€æ–‡ä»¶åŠ è½½åˆ°å†…å­˜Viewç»„ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥è®¾å®šåŠ è½½åˆ°æŸä¸€ä¸ªçˆ¶ç»„ä»¶ä¸­ï¼› å…¸å‹çš„Activityçš„onCreateæ–¹æ³•ä¸­éœ€è¦è°ƒç”¨super.onCreateæ–¹æ³•å’ŒsetContentViewæ–¹æ³•ï¼Œè‹¥ä¸è°ƒç”¨super.onCreateæ–¹æ³•ï¼Œæ‰§è¡Œå¯åŠ¨è¯¥Activityçš„é€»è¾‘ä¼šæŠ¥é”™ï¼Œè‹¥ä¸æ‰§è¡ŒsetContentViewçš„æ–¹æ³•ï¼Œè¯¥Activityåªä¼šæ˜¾ç¤ºä¸€ä¸ªç©ºé¡µé¢ã€‚ å¥½äº†ï¼Œå…³äºActivityçš„å¸ƒå±€åŠ è½½æµç¨‹æˆ‘ä»¬æš‚æ—¶ä»‹ç»è¿™ä¹ˆå¤šï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬å°†ä»‹ç»ä¸€ä¸‹Activityçš„å¸ƒå±€æ˜¾ç¤ºæµç¨‹ã€‚ å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹","link":"/2020/09/11/Activity%E5%B8%83%E5%B1%80%E5%8A%A0%E8%BD%BD%E6%B5%81%E7%A8%8B/"},{"title":"28 ç”µæºå¼€å…³æœºæŒ‰é”®äº‹ä»¶æµç¨‹","text":"å‰é¢æˆ‘ä»¬è®²è§£äº†ç³»ç»Ÿæˆªå±æŒ‰é”®å¤„ç†æµç¨‹ï¼ŒHOMEæŒ‰é”®å¤„ç†æµç¨‹ï¼Œä»Šå¤©å†æ¥è®²è§£ä¸€ä¸‹ç”µæºå¼€å…³æœºæŒ‰é”®äº‹ä»¶æµç¨‹ï¼Œå½“ç„¶è¿™ä¹Ÿæ˜¯ç³»ç»ŸæŒ‰é”®å¤„ç†æµç¨‹æ–¹é¢çš„æœ€åä¸€ç¯‡åšå®¢äº†ã€‚ å’Œæˆªå±æŒ‰é”®ã€HOMEæŒ‰é”®çš„å¤„ç†æµç¨‹ç±»ä¼¼ï¼Œç”µæºæŒ‰é”®ç”±äºä¹Ÿæ˜¯ç³»ç»Ÿçº§åˆ«çš„æŒ‰é”®ï¼Œæ‰€ä»¥å¯¹å…¶çš„äº‹ä»¶å¤„ç†é€»è¾‘æ˜¯å’Œæˆªå±æŒ‰é”®ã€HOMEæŒ‰é”®ç±»ä¼¼ï¼Œä¸åœ¨æŸä¸€ä¸ªAppä¸­ï¼Œè€Œæ˜¯åœ¨PhoneWindowManagerçš„dispatchUnhandledKeyæ–¹æ³•ä¸­ã€‚æ‰€ä»¥å’Œå‰é¢ä¸¤ç¯‡ç±»ä¼¼ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿæ˜¯ä»PhoneWindowManagerçš„dispatchUnhandledKeyæ–¹æ³•å¼€å§‹æˆ‘ä»¬ä»Šå¤©ç”µæºå¼€å…³æœºæŒ‰é”®çš„äº‹ä»¶æµç¨‹åˆ†æã€‚ ä¸‹é¢é¦–å…ˆçœ‹ä¸€ä¸‹dispatchUnhandledKeyæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public KeyEvent dispatchUnhandledKey(WindowState win, KeyEvent event, int policyFlags) { ... KeyEvent fallbackEvent = null; if ((event.getFlags() &amp; KeyEvent.FLAG_FALLBACK) == 0) { final KeyCharacterMap kcm = event.getKeyCharacterMap(); final int keyCode = event.getKeyCode(); final int metaState = event.getMetaState(); final boolean initialDown = event.getAction() == KeyEvent.ACTION_DOWN &amp;&amp; event.getRepeatCount() == 0; // Check for fallback actions specified by the key character map. final FallbackAction fallbackAction; if (initialDown) { fallbackAction = kcm.getFallbackAction(keyCode, metaState); } else { fallbackAction = mFallbackActions.get(keyCode); } if (fallbackAction != null) { if (DEBUG_INPUT) { Slog.d(TAG, &quot;Fallback: keyCode=&quot; + fallbackAction.keyCode + &quot; metaState=&quot; + Integer.toHexString(fallbackAction.metaState)); } final int flags = event.getFlags() | KeyEvent.FLAG_FALLBACK; fallbackEvent = KeyEvent.obtain( event.getDownTime(), event.getEventTime(), event.getAction(), fallbackAction.keyCode, event.getRepeatCount(), fallbackAction.metaState, event.getDeviceId(), event.getScanCode(), flags, event.getSource(), null); if (!interceptFallback(win, fallbackEvent, policyFlags)) { fallbackEvent.recycle(); fallbackEvent = null; } if (initialDown) { mFallbackActions.put(keyCode, fallbackAction); } else if (event.getAction() == KeyEvent.ACTION_UP) { mFallbackActions.remove(keyCode); fallbackAction.recycle(); } } } ... return fallbackEvent; } é€šè¿‡å‰é¢ä¸¤ç¯‡æ–‡ç« çš„åˆ†æï¼ˆ androidæºç è§£æï¼ˆäºŒåå…­ï¼‰â€“&gt;æˆªå±äº‹ä»¶æµç¨‹&nbsp;&nbsp;androidæºç è§£æï¼ˆäºŒåä¸ƒï¼‰â€“&gt;HOMEäº‹ä»¶æµç¨‹ï¼‰æˆ‘ä»¬çŸ¥é“å…³äºç³»ç»ŸæŒ‰é”®çš„å¤„ç†é€»è¾‘è¢«ä¸‹æ”¾åˆ°äº†interceptFallbackæ–¹æ³•ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹interceptFallbackæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 1234567891011private boolean interceptFallback(WindowState win, KeyEvent fallbackEvent, int policyFlags) { int actions = interceptKeyBeforeQueueing(fallbackEvent, policyFlags); if ((actions &amp; ACTION_PASS_TO_USER) != 0) { long delayMillis = interceptKeyBeforeDispatching( win, fallbackEvent, policyFlags); if (delayMillis == 0) { return true; } } return false; }é€šè¿‡åˆ†æinterceptFallbackæ–¹æ³•çš„æºç ï¼Œæˆ‘ä»¬çŸ¥é“å…³äºç”µæºæŒ‰é”®çš„å¤„ç†é€»è¾‘åœ¨interceptKeyBeforeQueueingæ–¹æ³•ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»§ç»­çœ‹ä¸€ä¸‹interceptKeyBeforeQueueingæ–¹æ³•ä¸­å…³äºç”µæºæŒ‰é”®çš„å¤„ç†é€»è¾‘ã€‚ 12345678910111213141516public int interceptKeyBeforeQueueing(KeyEvent event, int policyFlags) { ... case KeyEvent.KEYCODE_POWER: { result &amp;= ~ACTION_PASS_TO_USER; isWakeKey = false; // wake-up will be handled separately if (down) { interceptPowerKeyDown(event, interactive); } else { interceptPowerKeyUp(event, interactive, canceled); } break; } ... return result; } è¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹ç”µæºæŒ‰é”®çš„å¤„ç†äº‹ä»¶ï¼Œå¯ä»¥å‘ç°å½“ç”µæºæŒ‰é”®æŒ‰ä¸‹çš„æ—¶å€™æˆ‘ä»¬è°ƒç”¨äº†interceptPowerKeyDownæ–¹æ³•ï¼Œå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å¤„ç†ç”µæºäº‹ä»¶çš„äº†ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹interceptPowerKeyDownæ–¹æ³•çš„æ‰§è¡Œé€»è¾‘ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162private void interceptPowerKeyDown(KeyEvent event, boolean interactive) { ... // Latch power key state to detect screenshot chord. if (interactive &amp;&amp; !mScreenshotChordPowerKeyTriggered &amp;&amp; (event.getFlags() &amp; KeyEvent.FLAG_FALLBACK) == 0) { mScreenshotChordPowerKeyTriggered = true; mScreenshotChordPowerKeyTime = event.getDownTime(); interceptScreenshotChord(); } // Stop ringing or end call if configured to do so when power is pressed. TelecomManager telecomManager = getTelecommService(); boolean hungUp = false; if (telecomManager != null) { if (telecomManager.isRinging()) { // Pressing Power while there's a ringing incoming // call should silence the ringer. telecomManager.silenceRinger(); } else if ((mIncallPowerBehavior &amp; Settings.Secure.INCALL_POWER_BUTTON_BEHAVIOR_HANGUP) != 0 &amp;&amp; telecomManager.isInCall() &amp;&amp; interactive) { // Otherwise, if &quot;Power button ends call&quot; is enabled, // the Power button will hang up any current active call. hungUp = telecomManager.endCall(); } } // If the power key has still not yet been handled, then detect short // press, long press, or multi press and decide what to do. mPowerKeyHandled = hungUp || mScreenshotChordVolumeDownKeyTriggered || mScreenshotChordVolumeUpKeyTriggered; if (!mPowerKeyHandled) { if (interactive) { // When interactive, we're already awake. // Wait for a long press or for the button to be released to decide what to do. if (hasLongPressOnPowerBehavior()) { Message msg = mHandler.obtainMessage(MSG_POWER_LONG_PRESS); msg.setAsynchronous(true); mHandler.sendMessageDelayed(msg, ViewConfiguration.get(mContext).getDeviceGlobalActionKeyTimeout()); } } else { wakeUpFromPowerKey(event.getDownTime()); if (mSupportLongPressPowerWhenNonInteractive &amp;&amp; hasLongPressOnPowerBehavior()) { Message msg = mHandler.obtainMessage(MSG_POWER_LONG_PRESS); msg.setAsynchronous(true); mHandler.sendMessageDelayed(msg, ViewConfiguration.get(mContext).getDeviceGlobalActionKeyTimeout()); mBeganFromNonInteractive = true; } else { final int maxCount = getMaxMultiPressPowerCount(); if (maxCount &lt;= 1) { mPowerKeyHandled = true; } else { mBeganFromNonInteractive = true; } } } } } è¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹if(interactive)åˆ†æ”¯ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å‘é€ä¸€ä¸ªä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œå¹¶ä¸”msgçš„whatä¸ºMSG_POWER_LONG_PRESSï¼Œå³é•¿æŒ‰ç”µæºäº‹ä»¶çš„å¼‚æ­¥æ¶ˆæ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸€ä¸‹mHandlerçš„handleMessageæ–¹æ³•å¯¹è¯¥whatæ¶ˆæ¯çš„å¤„ç†é€»è¾‘ã€‚ 123case MSG_POWER_LONG_PRESS: powerLongPress(); break; æˆ‘ä»¬å¯ä»¥å‘ç°åœ¨mHandlerçš„handleMessageæ–¹æ³•ä¸­å½“msgçš„whatä¸ºMSG_POWER_LONG_PRESSæ—¶æˆ‘ä»¬è°ƒç”¨äº†powerLongPressæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åº”è¯¥å°±æ˜¯å¤„ç†ç”µæºæŒ‰é”®é•¿æŒ‰çš„é€»è¾‘ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹powerLongPressæ–¹æ³•çš„å®ç°ã€‚ 123456789101112131415161718192021private void powerLongPress() { final int behavior = getResolvedLongPressOnPowerBehavior(); switch (behavior) { case LONG_PRESS_POWER_NOTHING: break; case LONG_PRESS_POWER_GLOBAL_ACTIONS: mPowerKeyHandled = true; if (!performHapticFeedbackLw(null, HapticFeedbackConstants.LONG_PRESS, false)) { performAuditoryFeedbackForAccessibilityIfNeed(); } showGlobalActionsInternal(); break; case LONG_PRESS_POWER_SHUT_OFF: case LONG_PRESS_POWER_SHUT_OFF_NO_CONFIRM: mPowerKeyHandled = true; performHapticFeedbackLw(null, HapticFeedbackConstants.LONG_PRESS, false); sendCloseSystemWindows(SYSTEM_DIALOG_REASON_GLOBAL_ACTIONS); mWindowManagerFuncs.shutdown(behavior == LONG_PRESS_POWER_SHUT_OFF); break; } } å¯ä»¥å‘ç°è¿™é‡Œæœ‰å››ä¸ªswitchåˆ†ä¹‹ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªä»€ä¹ˆéƒ½ä¸åšç›´æ¥breakæ‰ï¼Œç¬¬äºŒä¸ªcaseåˆ™éœ€è¦å¼¹å‡ºé€‰æ‹©æ“ä½œç•Œé¢ï¼Œæ¯”å¦‚ï¼šé£è¡Œæ¨¡å¼ï¼Œå¼€å…³æœºï¼Œé™éŸ³æ¨¡å¼ï¼Œé‡æ–°å¯åŠ¨ç­‰ï¼Œè¿™é‡Œå¯ä»¥å‚çœ‹ä¸€ä¸‹å°ç±³æ‰‹æœºçš„å…³æœºç•Œé¢ï¼š ç„¶åç¬¬ä¸‰ç¬¬å››ä¸ªcaseåˆ†ä¹‹åˆ™æ˜¯ç›´æ¥è°ƒç”¨å…³æœºæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆçœ‹ç¬¬äºŒä¸ªcaseï¼Œçœ‹çœ‹ç³»ç»Ÿæ˜¯å¦‚ä½•æ˜¾ç¤ºå‡ºå…³æœºæ“ä½œç•Œé¢çš„ã€‚é‚£æˆ‘ä»¬çœ‹ä¸€ä¸‹showGlobalActionsInternalæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 12345678910111213void showGlobalActionsInternal() { sendCloseSystemWindows(SYSTEM_DIALOG_REASON_GLOBAL_ACTIONS); if (mGlobalActions == null) { mGlobalActions = new GlobalActions(mContext, mWindowManagerFuncs); } final boolean keyguardShowing = isKeyguardShowingAndNotOccluded(); mGlobalActions.showDialog(keyguardShowing, isDeviceProvisioned()); if (keyguardShowing) { // since it took two seconds of long press to bring this up, // poke the wake lock so they have some time to see the dialog. mPowerManager.userActivity(SystemClock.uptimeMillis(), false); } } å¯ä»¥å‘ç°æˆ‘ä»¬é¦–å…ˆè°ƒç”¨äº†sendCloseSystemWindowsæ–¹æ³•ï¼Œå‰é¢æˆ‘ä»¬åˆ†æHOMEæŒ‰é”®æµç¨‹çš„æ—¶å€™ï¼ˆandroidæºç è§£æï¼ˆäºŒåä¸ƒï¼‰â€“&gt;HOMEäº‹ä»¶æµç¨‹ï¼‰çŸ¥é“è¯¥æ–¹æ³•ç”¨äºå…³æœºç³»ç»Ÿå¼¹çª—ï¼Œæ¯”å¦‚è¾“å…¥æ³•ï¼Œå£çº¸ç­‰ã€‚ç„¶åæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªGlobalActionså¯¹è±¡ï¼Œå¹¶è°ƒç”¨äº†å…¶showDialogæ–¹æ³•ï¼Œé€šè¿‡åˆ†ææºç ï¼Œæˆ‘ä»¬å‘ç°è¯¥æ–¹æ³•å°±æ˜¯ç”¨äºæ˜¾ç¤ºé•¿æŒ‰ç”µæºæŒ‰é”®å¼¹å‡ºæ“ä½œç•Œé¢çš„ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹GlobalActionsçš„æ„é€ æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031public GlobalActions(Context context, WindowManagerFuncs windowManagerFuncs) { mContext = context; mWindowManagerFuncs = windowManagerFuncs; mAudioManager = (AudioManager) mContext.getSystemService(Context.AUDIO_SERVICE); mDreamManager = IDreamManager.Stub.asInterface( ServiceManager.getService(DreamService.DREAM_SERVICE)); // receive broadcasts IntentFilter filter = new IntentFilter(); filter.addAction(Intent.ACTION_CLOSE_SYSTEM_DIALOGS); filter.addAction(Intent.ACTION_SCREEN_OFF); filter.addAction(TelephonyIntents.ACTION_EMERGENCY_CALLBACK_MODE_CHANGED); context.registerReceiver(mBroadcastReceiver, filter); ConnectivityManager cm = (ConnectivityManager) context.getSystemService(Context.CONNECTIVITY_SERVICE); mHasTelephony = cm.isNetworkSupported(ConnectivityManager.TYPE_MOBILE); // get notified of phone state changes TelephonyManager telephonyManager = (TelephonyManager) context.getSystemService(Context.TELEPHONY_SERVICE); telephonyManager.listen(mPhoneStateListener, PhoneStateListener.LISTEN_SERVICE_STATE); mContext.getContentResolver().registerContentObserver( Settings.Global.getUriFor(Settings.Global.AIRPLANE_MODE_ON), true, mAirplaneModeObserver); Vibrator vibrator = (Vibrator) mContext.getSystemService(Context.VIBRATOR_SERVICE); mHasVibrator = vibrator != null &amp;&amp; vibrator.hasVibrator(); mShowSilentToggle = SHOW_SILENT_TOGGLE &amp;&amp; !mContext.getResources().getBoolean( com.android.internal.R.bool.config_useFixedVolume); } å¯ä»¥çœ‹åˆ°åœ¨GlobalActionså¯¹è±¡çš„æ„é€ æ–¹æ³•ä¸­æˆ‘ä»¬ä¸»è¦ç”¨äºåˆå§‹åŒ–å…¶æˆå‘˜å˜é‡ï¼Œç”±äºæˆ‘ä»¬çš„ç”µæºé•¿æŒ‰æ“ä½œç•Œé¢æ˜¯ä¸€ä¸ªå…¨å±€é¡µé¢ï¼Œæ‰€ä»¥è¿™é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ªWindowå¯¹è±¡ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹GlobalActionsçš„showDialogæ–¹æ³•ã€‚ 123456789101112public void showDialog(boolean keyguardShowing, boolean isDeviceProvisioned) { mKeyguardShowing = keyguardShowing; mDeviceProvisioned = isDeviceProvisioned; if (mDialog != null) { mDialog.dismiss(); mDialog = null; // Show delayed, so that the dismiss of the previous dialog completes mHandler.sendEmptyMessage(MESSAGE_SHOW); } else { handleShow(); } } å¯ä»¥çœ‹åˆ°åœ¨showDialogæ–¹æ³•ä¸­æˆ‘ä»¬é¦–å…ˆåˆ¤æ–­mDialogæ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ºç©ºåˆ™å‘é€msgçš„whatä¸ºMESSAGE_SHOWçš„å¼‚æ­¥æ¶ˆæ¯ï¼Œå¦åˆ™è°ƒç”¨handleShowæ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„mDialogæ˜¯ä¸€ä¸ªç±»å‹ä¸ºGlobalActionsDialogçš„å˜é‡ï¼Œç”±äºæˆ‘ä»¬çš„mDialogä¸ºç©ºï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹handleShowæ–¹æ³•ã€‚ 1234567891011121314151617private void handleShow() { awakenIfNecessary(); mDialog = createDialog(); prepareDialog(); // If we only have 1 item and it's a simple press action, just do this action. if (mAdapter.getCount() == 1 &amp;&amp; mAdapter.getItem(0) instanceof SinglePressAction &amp;&amp; !(mAdapter.getItem(0) instanceof LongPressAction)) { ((SinglePressAction) mAdapter.getItem(0)).onPress(); } else { WindowManager.LayoutParams attrs = mDialog.getWindow().getAttributes(); attrs.setTitle(&quot;GlobalActions&quot;); mDialog.getWindow().setAttributes(attrs); mDialog.show(); mDialog.getWindow().getDecorView().setSystemUiVisibility(View.STATUS_BAR_DISABLE_EXPAND); } åœ¨æ–¹æ³•ä½“ä¸­æˆ‘ä»¬è°ƒç”¨äº†createDialogæ–¹æ³•ï¼Œåˆ›å»ºäº†GlobalActionsDialogç±»å‹çš„mDialogï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹createDialogçš„å®ç°æ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118private GlobalActionsDialog createDialog() { ... mAirplaneModeOn = new ToggleAction( R.drawable.ic_lock_airplane_mode, R.drawable.ic_lock_airplane_mode_off, R.string.global_actions_toggle_airplane_mode, R.string.global_actions_airplane_mode_on_status, R.string.global_actions_airplane_mode_off_status) { void onToggle(boolean on) { if (mHasTelephony &amp;&amp; Boolean.parseBoolean( SystemProperties.get(TelephonyProperties.PROPERTY_INECM_MODE))) { mIsWaitingForEcmExit = true; // Launch ECM exit dialog Intent ecmDialogIntent = new Intent(TelephonyIntents.ACTION_SHOW_NOTICE_ECM_BLOCK_OTHERS, null); ecmDialogIntent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); mContext.startActivity(ecmDialogIntent); } else { changeAirplaneModeSystemSetting(on); } } @Override protected void changeStateFromPress(boolean buttonOn) { if (!mHasTelephony) return; // In ECM mode airplane state cannot be changed if (!(Boolean.parseBoolean( SystemProperties.get(TelephonyProperties.PROPERTY_INECM_MODE)))) { mState = buttonOn ? State.TurningOn : State.TurningOff; mAirplaneState = mState; } } public boolean showDuringKeyguard() { return true; } public boolean showBeforeProvisioning() { return false; } }; onAirplaneModeChanged(); mItems = new ArrayList&lt;Action&gt;(); String[] defaultActions = mContext.getResources().getStringArray( com.android.internal.R.array.config_globalActionsList); ArraySet&lt;String&gt; addedKeys = new ArraySet&lt;String&gt;(); for (int i = 0; i &lt; defaultActions.length; i++) { String actionKey = defaultActions[i]; if (addedKeys.contains(actionKey)) { // If we already have added this, don't add it again. continue; } if (GLOBAL_ACTION_KEY_POWER.equals(actionKey)) { mItems.add(new PowerAction()); } else if (GLOBAL_ACTION_KEY_AIRPLANE.equals(actionKey)) { mItems.add(mAirplaneModeOn); } else if (GLOBAL_ACTION_KEY_BUGREPORT.equals(actionKey)) { if (Settings.Global.getInt(mContext.getContentResolver(), Settings.Global.BUGREPORT_IN_POWER_MENU, 0) != 0 &amp;&amp; isCurrentUserOwner()) { mItems.add(getBugReportAction()); } } else if (GLOBAL_ACTION_KEY_SILENT.equals(actionKey)) { if (mShowSilentToggle) { mItems.add(mSilentModeAction); } } else if (GLOBAL_ACTION_KEY_USERS.equals(actionKey)) { if (SystemProperties.getBoolean(&quot;fw.power_user_switcher&quot;, false)) { addUsersToMenu(mItems); } } else if (GLOBAL_ACTION_KEY_SETTINGS.equals(actionKey)) { mItems.add(getSettingsAction()); } else if (GLOBAL_ACTION_KEY_LOCKDOWN.equals(actionKey)) { mItems.add(getLockdownAction()); } else if (GLOBAL_ACTION_KEY_VOICEASSIST.equals(actionKey)) { mItems.add(getVoiceAssistAction()); } else if (GLOBAL_ACTION_KEY_ASSIST.equals(actionKey)) { mItems.add(getAssistAction()); } else { Log.e(TAG, &quot;Invalid global action key &quot; + actionKey); } // Add here so we don't add more than one. addedKeys.add(actionKey); } mAdapter = new MyAdapter(); AlertParams params = new AlertParams(mContext); params.mAdapter = mAdapter; params.mOnClickListener = this; params.mForceInverseBackground = true; GlobalActionsDialog dialog = new GlobalActionsDialog(mContext, params); dialog.setCanceledOnTouchOutside(false); // Handled by the custom class. dialog.getListView().setItemsCanFocus(true); dialog.getListView().setLongClickable(true); dialog.getListView().setOnItemLongClickListener( new AdapterView.OnItemLongClickListener() { @Override public boolean onItemLongClick(AdapterView&lt;?&gt; parent, View view, int position, long id) { final Action action = mAdapter.getItem(position); if (action instanceof LongPressAction) { return ((LongPressAction) action).onLongPress(); } return false; } }); dialog.getWindow().setType(WindowManager.LayoutParams.TYPE_KEYGUARD_DIALOG); dialog.setOnDismissListener(this); return dialog; } æ–¹æ³•ä½“çš„å†…å®¹æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬çœ‹é‡ç‚¹çš„å†…å®¹ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡è°ƒç”¨mContext.getResources().getStringArray(com.android.internal.R.array.config_globalActionsList)è·å¾—æ“ä½œåˆ—è¡¨ï¼Œè¿™é‡Œå¯èƒ½åŒ…å«ï¼šé£è¡Œæ¨¡å¼ã€å¼€å…³æœºã€é™éŸ³æ¨¡å¼ã€é‡å¯ç­‰ç­‰ï¼Œç„¶åæˆ‘ä»¬è½®è®­æ“ä½œåˆ—è¡¨ï¼Œå¹¶æ·»åŠ ç›¸åº”çš„Actionæœ€åæˆ‘ä»¬å°†è¿™ä¸ªæ“ä½œåˆ—è¡¨ä¿å­˜åˆ°Dialogçš„adapterä¸­å¹¶è¿”å›è¯¥dialogï¼Œç„¶åæˆ‘ä»¬å›åˆ°æˆ‘ä»¬åˆšåˆšçš„handleShowæ–¹æ³•ï¼Œåœ¨å¾—åˆ°è¿”å›çš„dialogä¹‹åæˆ‘ä»¬è°ƒç”¨äº†dialogçš„showæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬å°±æ˜¾ç¤ºå‡ºäº†ç”µæºé•¿æŒ‰æ“ä½œç•Œé¢ï¼Œæ¯”å¦‚å°ç±³çš„ç•Œé¢ï¼š å¥½å§ï¼Œç»§ç»­æˆ‘ä»¬çš„åˆ†æï¼Œå½“æˆ‘ä»¬é•¿æŒ‰ç”µæºæŒ‰é”®å¼¹å‡ºæ“ä½œå¼¹çª—ä¹‹åï¼Œè¿™æ—¶å€™ç‚¹å‡»å…³æœºæ˜¯æ€ä¹ˆæ ·çš„æµç¨‹å‘¢ï¼Ÿæˆ‘ä»¬å‘ç°åœ¨createDialogæ–¹æ³•ä¸­å…³æœºæ“ä½œadapterçš„itemï¼Œæˆ‘ä»¬æ·»åŠ äº†ï¼š 1mItems.add(new PowerAction()); è¿™æ ·ä¸éš¾å‘ç°æˆ‘ä»¬å¯¹å…³æœºæŒ‰é’®çš„æ“ä½œå°è£…åœ¨äº†PowerActionä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹PowerActionçš„å®ç°ã€‚ 1234567891011121314151617181920212223242526272829303132private final class PowerAction extends SinglePressAction implements LongPressAction { private PowerAction() { super(com.android.internal.R.drawable.ic_lock_power_off, R.string.global_action_power_off); } @Override public boolean onLongPress() { UserManager um = (UserManager) mContext.getSystemService(Context.USER_SERVICE); if (!um.hasUserRestriction(UserManager.DISALLOW_SAFE_BOOT)) { mWindowManagerFuncs.rebootSafeMode(true); return true; } return false; } @Override public boolean showDuringKeyguard() { return true; } @Override public boolean showBeforeProvisioning() { return true; } @Override public void onPress() { // shutdown by making sure radio and power are handled accordingly. mWindowManagerFuncs.shutdown(false /* confirm */); } } å¯ä»¥å‘ç°åœ¨PowerActionç±»çš„æˆå‘˜å‡½æ•°onPressæ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨äº†mWindowManagerFuncs.showdownæ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ä¹Ÿå°±æ˜¯å¼€å§‹æ‰§è¡Œæˆ‘ä»¬çš„å…³æœºæ“ä½œäº†ï¼Œé‚£ä¹ˆè¿™é‡Œçš„mWindowManagerFuncsåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„å‘¢ï¼Ÿé€šè¿‡åˆ†ææˆ‘ä»¬å‘ç°è¿™é‡Œçš„mWindowManagerFuncsæˆå‘˜å˜é‡æ˜¯åœ¨GlobalActionsçš„æ„é€ æ–¹æ³•ä¸­èµ‹å€¼çš„ã€‚ 12345public GlobalActions(Context context, WindowManagerFuncs windowManagerFuncs) { ... mWindowManagerFuncs = windowManagerFuncs; ...} å¥½å§ï¼Œå›åˆ°æˆ‘ä»¬çš„PhoneWindowManagerï¼Œæ—©æ„é€ GlobalActionsæ—¶ï¼Œç›´æ¥ä¼ é€’çš„æ˜¯PhoneWindowManagerçš„æˆå‘˜å˜é‡mWindowManagerFuncsï¼Œé‚£ä¹ˆPhoneWindowManagerçš„mWindowManagerFuncsæˆå‘˜å˜é‡åˆæ˜¯ä½•æ—¶è¢«èµ‹å€¼çš„å‘¢?é€šè¿‡åˆ†ææºç æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°PhoneWindowManagerçš„mWindowManagerFuncså˜é‡æ˜¯åœ¨PhoneWindowManagerçš„initæ–¹æ³•ä¸­åˆå§‹åŒ–çš„ï¼Œå¥½å§ï¼Œå†æ¬¡æŸ¥æ‰¾PhoneWindowManagerçš„initæ–¹æ³•æ˜¯ä½•æ—¶è¢«è°ƒç”¨çš„ã€‚ ç»è¿‡æŸ¥æ‰¾ç»ˆäºåœ¨WindowManagerServiceä¸­æˆ‘ä»¬æ‰¾åˆ°äº†PhoneWindowManagerçš„initæ–¹æ³•çš„è°ƒç”¨ã€‚ 12345678910private void initPolicy() { UiThread.getHandler().runWithScissors(new Runnable() { @Override public void run() { WindowManagerPolicyThread.set(Thread.currentThread(), Looper.myLooper()); mPolicy.init(mContext, WindowManagerService.this, WindowManagerService.this); } }, 0); } è¿™é‡Œçš„mPolicyå°±æ˜¯ä¸€ä¸ªPhoneWindowManagerçš„å®åŠ›ï¼Œå¯ä»¥å‘ç°è¿™é‡Œçš„initæ–¹æ³•ä¸­mWindowManagerFuncsä¼ é€’çš„å°±æ˜¯ä¸€ä¸ªWindowManagerServiceçš„å®ä¾‹ï¼ŒO(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œè®©æˆ‘ä»¬å¥½æ‰¾ã€‚ ç„¶ä¹ˆåœ¨PowerActionçš„onPressæ–¹æ³•ä¸­è°ƒç”¨çš„mWindowManagerFuncs.shutdown(false / confirm /);æ–¹æ³•ï¼Œå®é™…ä¸Šè°ƒç”¨çš„å°±æ˜¯WindowManagerServiceçš„shutdownæ–¹æ³•ï¼Œè¿™æ ·æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹WindowManagerServiceçš„shutdownæ–¹æ³•çš„å®ç°ã€‚ 1234@Override public void shutdown(boolean confirm) { ShutdownThread.shutdown(mContext, confirm); } å¥½å§ï¼Œè¿™é‡Œå¾ˆç®€å•å°±æ˜¯ç›´æ¥è°ƒç”¨äº†ShutdownThreadçš„shutdownæ–¹æ³•ï¼Œçœ‹æ ·å­è¿™é‡Œå°±æ˜¯æ‰§è¡Œå…³æœºæ“ä½œçš„å°è£…äº†ï¼Œç»§ç»­çœ‹ä¸€ä¸‹ShutdownThreadçš„shutdownæ–¹æ³•ã€‚ 12345public static void shutdown(final Context context, boolean confirm) { mReboot = false; mRebootSafeMode = false; shutdownInner(context, confirm); } å¯ä»¥çœ‹åˆ°åœ¨ShutdownThreadçš„shutdownæ–¹æ³•ä¸­ä»£ç å¾ˆç®€å•ï¼Œå…·ä½“çš„æ“ä½œä¸‹å‘åˆ°äº†shutdownInneræ–¹æ³•ä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹shutdownInneræ–¹æ³•çš„å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445static void shutdownInner(final Context context, boolean confirm) { // ensure that only one thread is trying to power down. // any additional calls are just returned synchronized (sIsStartedGuard) { if (sIsStarted) { Log.d(TAG, &quot;Request to shutdown already running, returning.&quot;); return; } } final int longPressBehavior = context.getResources().getInteger( com.android.internal.R.integer.config_longPressOnPowerBehavior); final int resourceId = mRebootSafeMode ? com.android.internal.R.string.reboot_safemode_confirm : (longPressBehavior == 2 ? com.android.internal.R.string.shutdown_confirm_question : com.android.internal.R.string.shutdown_confirm); Log.d(TAG, &quot;Notifying thread to start shutdown longPressBehavior=&quot; + longPressBehavior); if (confirm) { final CloseDialogReceiver closer = new CloseDialogReceiver(context); if (sConfirmDialog != null) { sConfirmDialog.dismiss(); } sConfirmDialog = new AlertDialog.Builder(context) .setTitle(mRebootSafeMode ? com.android.internal.R.string.reboot_safemode_title : com.android.internal.R.string.power_off) .setMessage(resourceId) .setPositiveButton(com.android.internal.R.string.yes, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { beginShutdownSequence(context); } }) .setNegativeButton(com.android.internal.R.string.no, null) .create(); closer.dialog = sConfirmDialog; sConfirmDialog.setOnDismissListener(closer); sConfirmDialog.getWindow().setType(WindowManager.LayoutParams.TYPE_KEYGUARD_DIALOG); sConfirmDialog.show(); } else { beginShutdownSequence(context); } } å¯ä»¥çœ‹åˆ°æ–¹æ³•ä½“ä¸­ï¼Œé¦–å…ˆåˆ¤æ–­è‹¥ç”¨æˆ·ç‚¹å‡»äº†å…³æœºæŒ‰é”®æ˜¯å¦å¼¹å‡ºç¡®è®¤æ¡†ï¼Œè‹¥å¼¹å‡ºåˆ™å¼¹å‡ºå…³æœºç¡®è®¤æ¡†ï¼Œè‹¥ä¸éœ€è¦ç¡®è®¤ï¼Œåˆ™ç›´æ¥è°ƒç”¨beginShutdownSequenceæ–¹æ³•ï¼Œæ‰§è¡Œå…³æœºæ“ä½œã€‚è€Œåœ¨å…³æœºç¡®è®¤æ¡†ä¸­æˆ‘ä»¬çš„ç¡®è®¤æŒ‰é’®ä¹Ÿæ˜¯æ‰§è¡Œäº†beginShutdownSequenceæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹å…³æœºæ–¹æ³•beginShutdownSequenceã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172private static void beginShutdownSequence(Context context) { synchronized (sIsStartedGuard) { if (sIsStarted) { Log.d(TAG, &quot;Shutdown sequence already running, returning.&quot;); return; } sIsStarted = true; } ... if (PowerManager.REBOOT_RECOVERY.equals(mRebootReason)) { mRebootUpdate = new File(UNCRYPT_PACKAGE_FILE).exists(); if (mRebootUpdate) { pd.setTitle(context.getText(com.android.internal.R.string.reboot_to_update_title)); pd.setMessage(context.getText( com.android.internal.R.string.reboot_to_update_prepare)); pd.setMax(100); pd.setProgressNumberFormat(null); pd.setProgressStyle(ProgressDialog.STYLE_HORIZONTAL); pd.setProgress(0); pd.setIndeterminate(false); } else { // Factory reset path. Set the dialog message accordingly. pd.setTitle(context.getText(com.android.internal.R.string.reboot_to_reset_title)); pd.setMessage(context.getText( com.android.internal.R.string.reboot_to_reset_message)); pd.setIndeterminate(true); } } else { pd.setTitle(context.getText(com.android.internal.R.string.power_off)); pd.setMessage(context.getText(com.android.internal.R.string.shutdown_progress)); pd.setIndeterminate(true); } pd.setCancelable(false); pd.getWindow().setType(WindowManager.LayoutParams.TYPE_KEYGUARD_DIALOG); pd.show(); sInstance.mProgressDialog = pd; sInstance.mContext = context; sInstance.mPowerManager = (PowerManager)context.getSystemService(Context.POWER_SERVICE); // make sure we never fall asleep again sInstance.mCpuWakeLock = null; try { sInstance.mCpuWakeLock = sInstance.mPowerManager.newWakeLock( PowerManager.PARTIAL_WAKE_LOCK, TAG + &quot;-cpu&quot;); sInstance.mCpuWakeLock.setReferenceCounted(false); sInstance.mCpuWakeLock.acquire(); } catch (SecurityException e) { Log.w(TAG, &quot;No permission to acquire wake lock&quot;, e); sInstance.mCpuWakeLock = null; } // also make sure the screen stays on for better user experience sInstance.mScreenWakeLock = null; if (sInstance.mPowerManager.isScreenOn()) { try { sInstance.mScreenWakeLock = sInstance.mPowerManager.newWakeLock( PowerManager.FULL_WAKE_LOCK, TAG + &quot;-screen&quot;); sInstance.mScreenWakeLock.setReferenceCounted(false); sInstance.mScreenWakeLock.acquire(); } catch (SecurityException e) { Log.w(TAG, &quot;No permission to acquire wake lock&quot;, e); sInstance.mScreenWakeLock = null; } } // start the thread that initiates shutdown sInstance.mHandler = new Handler() { }; sInstance.start(); } åœ¨æ–¹æ³•beginShutdownSequenceä¸­æˆ‘ä»¬é¦–å…ˆåˆå§‹åŒ–äº†ä¸€ä¸ªProcessçš„dialogï¼Œè¯¥dialogç”¨äºæ˜¾ç¤ºå…³æœºç•Œé¢ï¼Œç„¶åæˆ‘ä»¬è°ƒç”¨äº†sInstance.startæ–¹æ³•ï¼Œå†å¾€ä¸‹çš„æ–¹æ³•ä¸­å°±æ˜¯çœŸæ­£çš„shutdownæ–¹æ³•çš„å®ç°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯nativeæ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œå°±ä¸åšè¿‡å¾—è§£è¯»äº†ã€‚ã€‚ã€‚ æ€»ç»“ï¼š ç”µæºæŒ‰é”®æ˜¯ç³»ç»ŸæŒ‰é”®ï¼Œæ‰€ä»¥å¯¹ç”µæºæŒ‰é”®çš„å¤„ç†é€»è¾‘ä¹Ÿæ˜¯åœ¨PhoneWindowManagerçš„dispatchUnhandledKeyæ–¹æ³•ä¸­ï¼› åœ¨PhoneWindowManagerçš„dispatchUnhandleKeyæ–¹æ³•å¤„ç†PoweræŒ‰é”®ä¹‹åä¼šé¦–å…ˆæ˜¾ç¤ºç³»ç»Ÿæ“ä½œå¼¹çª—ï¼Œä¸€èˆ¬åŒ…æ‹¬ä½†ä¸é™äºï¼šé£è¡Œæ¨¡å¼ï¼Œé™éŸ³æ¨¡å¼ï¼Œé‡æ–°å¯åŠ¨ï¼Œå…³æœºç­‰ï¼› å½“ç”¨æˆ·ç‚¹å‡»å…³æœºæŒ‰é’®æ˜¯è°ƒç”¨çš„æ˜¯WindowManagerService.shutdownæ–¹æ³•ï¼Œè€Œå†…éƒ¨è°ƒç”¨çš„æ˜¯ShutdownThread.shutdownæ–¹æ³•ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåäºŒï¼‰â€“&gt;ToaståŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸‰ï¼‰â€“&gt;Androidå¼‚å¸¸å¤„ç†æµç¨‹androidæºç è§£æï¼ˆäºŒåå››ï¼‰â€“&gt;onSaveInstanceStateæ‰§è¡Œæ—¶æœºandroidæºç è§£æï¼ˆäºŒåäº”ï¼‰â€“&gt;onLowMemoryæ‰§è¡Œæµç¨‹androidæºç è§£æï¼ˆäºŒåå…­ï¼‰â€“&gt;æˆªå±äº‹ä»¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸ƒï¼‰â€“&gt;HOMEäº‹ä»¶æµç¨‹","link":"/2020/09/11/%E7%94%B5%E6%BA%90%E5%BC%80%E5%85%B3%E6%9C%BA%E6%8C%89%E9%94%AE%E4%BA%8B%E4%BB%B6%E6%B5%81%E7%A8%8B/"},{"title":"12 ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹","text":"æœ€è¿‘æœ‰åŒå­¦é—®æˆ‘å…³äºManifestä½•æ—¶è¢«ç³»ç»Ÿè§£æçš„é—®é¢˜ï¼Œæ­£å¥½ä¹Ÿåˆ†æåˆ°è¿™ä¸€å—äº†ï¼Œç´¢æ€§è¿™ä¸€ç« å°±è®²è§£ä¸€ä¸‹androidç³»ç»Ÿä½•æ—¶è§£æManifestå§ï¼Œè¿™é‡Œçš„ManifestæŒ‡çš„æ˜¯androidå®‰è£…æ–‡ä»¶apkä¸­çš„androidManifest.xmlæ–‡ä»¶æ˜¯ä½•æ—¶è¢«è§£æçš„ã€‚å¤§å®¶åº”è¯¥éƒ½çŸ¥é“ï¼ŒAndroidç³»ç»Ÿå¯åŠ¨ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸€ä¸ªåº”ç”¨ä¸­æ‰“å¼€å¦ä¸€ä¸ªä»æœªæ‰“å¼€è¿‡çš„åº”ç”¨ï¼Œæˆ–è€…æ˜¯åœ¨ä¸€ä¸ªåº”ç”¨ä¸­å‘é€å¹¿æ’­ï¼Œå¦‚æœå¦å¤–ä¸€ä¸ªåº”ç”¨è®¾ç½®äº†è¿™ä¸ªå¹¿æ’­çš„æ¥æ”¶å™¨ï¼Œé‚£ä¹ˆè¿™ä¸ªåº”ç”¨è¿›ç¨‹å°±ä¼šè¢«å¯åŠ¨å¹¶æ¥æ”¶è¯¥å¹¿æ’­å¹¶ä½œå‡ºç›¸åº”çš„å¤„ç†ï¼Œè¿™æ ·çš„ä¾‹å­å¾ˆå¤šï¼Œæˆ‘ä»¬å¯ä»¥çŒœæµ‹åˆ°Androidç³»ç»Ÿåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæŠ“å–åˆ°äº†ç³»ç»Ÿä¸­æ‰€æœ‰å®‰è£…çš„åº”ç”¨ä¿¡æ¯ï¼ˆåº”è¯¥æ˜¯è§£æapkæ–‡ä»¶çš„Manifestä¿¡æ¯ï¼‰ï¼Œå³åœ¨Androidç³»ç»Ÿçš„å¯åŠ¨è¿‡ç¨‹ä¸­å°±å·²ç»è§£æäº†ç³»ç»Ÿä¸­å®‰è£…åº”ç”¨çš„androidManifest.xmlæ–‡ä»¶å¹¶ä¿å­˜èµ·æ¥äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹å…·ä½“æ˜¯å¦‚ä½•çš„å‘¢? å…¶å®androidç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ä¸­è§£æManifestçš„æµç¨‹æ˜¯é€šè¿‡PackageManagerServiceæœåŠ¡æ¥å®ç°çš„ã€‚è¿™é‡Œæˆ‘ä»¬é‡ç‚¹åˆ†æä¸€ä¸‹PackageManagerServiceæœåŠ¡æ˜¯å¦‚ä½•è§£æManifestçš„ã€‚ é¦–å…ˆçœ‹ä¸€ä¸‹åœ¨SystemServerè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­æ˜¯å¦‚ä½•å¯åŠ¨PackageManagerServiceæœåŠ¡çš„ï¼š 123456789private void startBootstrapServices() { ... mPackageManagerService = PackageManagerService.main(mSystemContext, installer, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF, mOnlyCore); mFirstBoot = mPackageManagerService.isFirstBoot(); mPackageManager = mSystemContext.getPackageManager(); ... } åœ¨SystemServerè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨SystemServerç±»çš„startBootstrapServicesæ–¹æ³•ï¼ˆä¸»è¦ç”¨äºå¯åŠ¨ActivityManagerServiceæœåŠ¡å’ŒPackageManagerServiceæœåŠ¡ï¼‰ï¼Œç„¶åä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¼šè°ƒç”¨PackageManagerService.mainé™æ€æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯ç”¨æ¥åˆå§‹åŒ–PackageManagerServiceæœåŠ¡å¹¶æ‰§è¡Œç›¸å…³é€»è¾‘çš„ã€‚ä¸‹é¢æˆ‘æ¥çœ‹ä¸€ä¸‹mainæ–¹æ³•çš„å…·ä½“é€»è¾‘ï¼š 1234567public static PackageManagerService main(Context context, Installer installer, boolean factoryTest, boolean onlyCore) { PackageManagerService m = new PackageManagerService(context, installer, factoryTest, onlyCore); ServiceManager.addService(&quot;package&quot;, m); return m; }å¯ä»¥å‘ç°mainæ–¹æ³•çš„å®ç°é€»è¾‘ä¸»è¦æ˜¯åˆ›å»ºäº†ä¸€ä¸ªPackageManagerServiceå¯¹è±¡ï¼Œå¹¶å°†è¿™ä¸ªå¯¹è±¡æ·»åŠ åˆ°ServierManagerä¸­ä¸ºå…¶ä»–ç»„ä»¶æä¾›æœåŠ¡ã€‚å¥½å§ï¼Œçœ‹æ¥PackageManagerServiceçš„åˆå§‹åŒ–æ“ä½œä¸»è¦æ˜¯åœ¨PackageManagerServiceçš„æ„é€ æ–¹æ³•ä¸­äº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶æ„é€ æ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 1234567File dataDir = Environment.getDataDirectory(); mAppDataDir = new File(dataDir, &quot;data&quot;); mAppInstallDir = new File(dataDir, &quot;app&quot;); mAppLib32InstallDir = new File(dataDir, &quot;app-lib&quot;); mAsecInternalPath = new File(dataDir, &quot;app-asec&quot;).getPath(); mUserAppDataDir = new File(dataDir, &quot;user&quot;); mDrmAppPrivateInstallDir = new File(dataDir, &quot;app-private&quot;); PackageManagerServiceçš„æ„é€ æ–¹æ³•ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œè¿™é‡Œå°±ä¸è´´å‡ºæ‰€æœ‰çš„ä»£ç äº†ï¼Œæˆ‘ä»¬ä¸»è¦å’Œè§£æManifestç›¸å…³çš„ä¸»è¦ä»£ç ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­æœ‰è¿™æ ·å‡ æ®µä»£ç ã€‚å¯ä»¥å‘ç°åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œè§£æäº†ç³»ç»Ÿä¸­å‡ ä¸ªapkçš„å®‰è£…ç›®å½•ï¼Œè¿™å‡ ä¸ªç›®å½•å°±æ˜¯ç³»ç»Ÿä¸­å®‰è£…apkçš„ç›®å½•ï¼Œandroidç³»ç»Ÿä¼šé»˜è®¤è§£æè¿™å‡ ä¸ªç›®å½•ä¸‹apkæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬androidæ‰‹æœºåœ¨å…¶ä»–çš„ç›®å½•ä¸‹å­˜åœ¨apkæ–‡ä»¶ç³»ç»Ÿæ˜¯ä¸ä¼šé»˜è®¤è§£æçš„ï¼Œåè¿‡æ¥è¯´ï¼Œå¦‚æœæˆ‘ä»¬æŠŠæˆ‘ä»¬çš„apkæ–‡ä»¶ç§»åŠ¨åˆ°è¿™å‡ ä¸ªç›®å½•ä¸‹ï¼Œé‚£ä¹ˆé‡æ–°å¯åŠ¨æ“ä½œç³»ç»Ÿï¼Œè¯¥apkæ–‡ä»¶å°±ä¼šè¢«ç³»ç»Ÿè§£æå¹¶æ‰§è¡Œç›¸å…³çš„é€»è¾‘æ“ä½œï¼Œå…·ä½“åšä»€ä¹ˆæ“ä½œå‘¢ï¼Ÿæˆ‘ä»¬çœ‹ä¸‹é¢çš„å®ç°ã€‚ 123456789101112131415161718192021222324252627282930313233343536/ overlay packages if they reside in VENDOR_OVERLAY_DIR. File vendorOverlayDir = new File(VENDOR_OVERLAY_DIR); scanDirLI(vendorOverlayDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags | SCAN_TRUSTED_OVERLAY, 0); // Find base frameworks (resource packages without code). scanDirLI(frameworkDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR | PackageParser.PARSE_IS_PRIVILEGED, scanFlags | SCAN_NO_DEX, 0); // Collected privileged system packages. final File privilegedAppDir = new File(Environment.getRootDirectory(), &quot;priv-app&quot;); scanDirLI(privilegedAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR | PackageParser.PARSE_IS_PRIVILEGED, scanFlags, 0); // Collect ordinary system packages. final File systemAppDir = new File(Environment.getRootDirectory(), &quot;app&quot;); scanDirLI(systemAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0); // Collect all vendor packages. File vendorAppDir = new File(&quot;/vendor/app&quot;); try { vendorAppDir = vendorAppDir.getCanonicalFile(); } catch (IOException e) { // failed to look up canonical path, continue with original one } scanDirLI(vendorAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0); // Collect all OEM packages. final File oemAppDir = new File(Environment.getOemDirectory(), &quot;app&quot;); scanDirLI(oemAppDir, PackageParser.PARSE_IS_SYSTEM | PackageParser.PARSE_IS_SYSTEM_DIR, scanFlags, 0); åœ¨æˆ‘ä»¬åˆšåˆšçš„PackageManagerService.maniæ–¹æ³•ä¸­ï¼Œè§£æå®Œåˆšåˆšçš„å‡ ä¸ªç³»ç»Ÿç›®å½•ä¹‹åç³»ç»Ÿä¼šè°ƒç”¨scanDirLIæ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•ä¸»è¦æ˜¯åšä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿçœ‹å®ƒçš„åå­—åº”è¯¥æ˜¯éå†è¿™ä¸ªç³»ç»Ÿç›®å½•ã€‚å¥½å§ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦å°±æ˜¯ç”¨äºè§£æä¸Šé¢å‡ ä¸ªç›®å½•ä¸‹çš„apkæ–‡ä»¶çš„ã€‚ä¸ä¿¡ï¼Ÿæˆ‘ä»¬çœ‹ä¸€ä¸‹scanDirLIæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738private void scanDirLI(File dir, int parseFlags, int scanFlags, long currentTime) { final File[] files = dir.listFiles(); if (ArrayUtils.isEmpty(files)) { Log.d(TAG, &quot;No files in app dir &quot; + dir); return; } if (DEBUG_PACKAGE_SCANNING) { Log.d(TAG, &quot;Scanning app dir &quot; + dir + &quot; scanFlags=&quot; + scanFlags + &quot; flags=0x&quot; + Integer.toHexString(parseFlags)); } for (File file : files) { final boolean isPackage = (isApkFile(file) || file.isDirectory()) &amp;&amp; !PackageInstallerService.isStageName(file.getName()); if (!isPackage) { // Ignore entries which are not packages continue; } try { scanPackageLI(file, parseFlags | PackageParser.PARSE_MUST_BE_APK, scanFlags, currentTime, null); } catch (PackageManagerException e) { Slog.w(TAG, &quot;Failed to parse &quot; + file + &quot;: &quot; + e.getMessage()); // Delete invalid userdata apps if ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM) == 0 &amp;&amp; e.error == PackageManager.INSTALL_FAILED_INVALID_APK) { logCriticalInfo(Log.WARN, &quot;Deleting invalid package at &quot; + file); if (file.isDirectory()) { mInstaller.rmPackageDir(file.getAbsolutePath()); } else { file.delete(); } } } } } å¯ä»¥æ”¾ä¸‹å…¶é¦–å…ˆä¼šéå†è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ˜¯apkæ–‡ä»¶ï¼Œå¦‚æœæ˜¯apkæ–‡ä»¶åˆ™è°ƒç”¨scanPackageLIæ–¹æ³•ï¼ŒscanPackageLIæ–¹æ³•çš„åå­—å¾ˆæ˜æ˜¾ï¼Œå°±æ˜¯ç”¨äºè§£æè¿™ä¸ªapkæ–‡ä»¶çš„ã€‚ ç»§ç»­çœ‹ä¸€ä¸‹scanPakcageLIæ–¹æ³•çš„å®ç°ï¼š 123456789101112131415161718192021private PackageParser.Package scanPackageLI(File scanFile, int parseFlags, int scanFlags, long currentTime, UserHandle user) throws PackageManagerException { if (DEBUG_INSTALL) Slog.d(TAG, &quot;Parsing: &quot; + scanFile); parseFlags |= mDefParseFlags; PackageParser pp = new PackageParser(); pp.setSeparateProcesses(mSeparateProcesses); pp.setOnlyCoreApps(mOnlyCore); pp.setDisplayMetrics(mMetrics); if ((scanFlags &amp; SCAN_TRUSTED_OVERLAY) != 0) { parseFlags |= PackageParser.PARSE_TRUSTED_OVERLAY; } final PackageParser.Package pkg; try { pkg = pp.parsePackage(scanFile, parseFlags); } catch (PackageParserException e) { throw PackageManagerException.from(e); } ...} å¥½å§ï¼Œè¿™ä¸ªæ–¹æ³•ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œåªæ˜¯åˆ—å‡ºé‡ç‚¹ç›¸å…³çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°åœ¨è¿™ä¸ªæ–¹æ³•ä¸­åˆ›å»ºäº†ä¸€ä¸ªPackagerParserå¯¹è±¡ï¼Œå¹¶è°ƒç”¨äº†parsePackageæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯è§£æManifestçš„ä¸»è¦æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å…¶å…·ä½“çš„å®ç°ï¼š 1234567public Package parsePackage(File packageFile, int flags) throws PackageParserException { if (packageFile.isDirectory()) { return parseClusterPackage(packageFile, flags); } else { return parseMonolithicPackage(packageFile, flags); } } å¯ä»¥å‘ç°ï¼Œè‹¥æˆ‘ä»¬è§£æçš„Fileå¯¹è±¡æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹åˆ™æ‰§è¡Œè°ƒç”¨parseClusterPackageæ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨æ‰§è¡ŒparseMonolithicPackageæ–¹æ³•ï¼Œå¾ˆæ˜æ˜¾çš„å› ä¸ºæˆ‘ä»¬è¿™é‡Œè§£æçš„æ˜¯apkæ–‡ä»¶ï¼ˆåœ¨ä¸Šä¸€æ–¹æ³•ä¸­æˆ‘ä»¬å¾ªç¯éå†å¾—åˆ°äº†apkæ–‡ä»¶ï¼Œè¿™é‡Œçš„Fileå¯¹è±¡å°±ä»£è¡¨äº†ä¸€ä¸ªä¸ªçš„apkæ–‡ä»¶ä¿¡æ¯ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œä¼šæ‰§è¡ŒparseMonolithicPackageæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹parseMonolithicPackageæ–¹æ³•ï¼š 123456789101112131415161718public Package parseMonolithicPackage(File apkFile, int flags) throws PackageParserException { if (mOnlyCoreApps) { final PackageLite lite = parseMonolithicPackageLite(apkFile, flags); if (!lite.coreApp) { throw new PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED, &quot;Not a coreApp: &quot; + apkFile); } } final AssetManager assets = new AssetManager(); try { final Package pkg = parseBaseApk(apkFile, assets, flags); pkg.codePath = apkFile.getAbsolutePath(); return pkg; } finally { IoUtils.closeQuietly(assets); } } å¯ä»¥çœ‹å‡ºï¼Œè¿™é‡Œåˆè°ƒç”¨äº†parseBaseApkæ–¹æ³•ï¼š 12345private Package parseBaseApk(File apkFile, AssetManager assets, int flags) ... final Package pkg = parseBaseApk(res, parser, flags, outError); ... } å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªparseBaseApkæ–¹æ³•è°ƒç”¨äº†å…¶é‡è½½çš„parseBaseApkæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370while ((type = parser.next()) != XmlPullParser.END_DOCUMENT &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; outerDepth)) { if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) { continue; } String tagName = parser.getName(); if (tagName.equals(&quot;application&quot;)) { if (foundApp) { if (RIGID_PARSER) { outError[0] = &quot;&lt;manifest&gt; has more than one &lt;application&gt;&quot;; mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return null; } else { Slog.w(TAG, &quot;&lt;manifest&gt; has more than one &lt;application&gt;&quot;); XmlUtils.skipCurrentTag(parser); continue; } } foundApp = true; if (!parseBaseApplication(pkg, res, parser, attrs, flags, outError)) { return null; } } else if (tagName.equals(&quot;overlay&quot;)) { pkg.mTrustedOverlay = trustedOverlay; sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestResourceOverlay); pkg.mOverlayTarget = sa.getString( com.android.internal.R.styleable.AndroidManifestResourceOverlay_targetPackage); pkg.mOverlayPriority = sa.getInt( com.android.internal.R.styleable.AndroidManifestResourceOverlay_priority, -1); sa.recycle(); if (pkg.mOverlayTarget == null) { outError[0] = &quot;&lt;overlay&gt; does not specify a target package&quot;; mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return null; } if (pkg.mOverlayPriority &lt; 0 || pkg.mOverlayPriority &gt; 9999) { outError[0] = &quot;&lt;overlay&gt; priority must be between 0 and 9999&quot;; mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return null; } XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;key-sets&quot;)) { if (!parseKeySets(pkg, res, parser, attrs, outError)) { return null; } } else if (tagName.equals(&quot;permission-group&quot;)) { if (parsePermissionGroup(pkg, flags, res, parser, attrs, outError) == null) { return null; } } else if (tagName.equals(&quot;permission&quot;)) { if (parsePermission(pkg, res, parser, attrs, outError) == null) { return null; } } else if (tagName.equals(&quot;permission-tree&quot;)) { if (parsePermissionTree(pkg, res, parser, attrs, outError) == null) { return null; } } else if (tagName.equals(&quot;uses-permission&quot;)) { if (!parseUsesPermission(pkg, res, parser, attrs)) { return null; } } else if (tagName.equals(&quot;uses-permission-sdk-m&quot;) || tagName.equals(&quot;uses-permission-sdk-23&quot;)) { if (!parseUsesPermission(pkg, res, parser, attrs)) { return null; } } else if (tagName.equals(&quot;uses-configuration&quot;)) { ConfigurationInfo cPref = new ConfigurationInfo(); sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestUsesConfiguration); cPref.reqTouchScreen = sa.getInt( com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqTouchScreen, Configuration.TOUCHSCREEN_UNDEFINED); cPref.reqKeyboardType = sa.getInt( com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqKeyboardType, Configuration.KEYBOARD_UNDEFINED); if (sa.getBoolean( com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqHardKeyboard, false)) { cPref.reqInputFeatures |= ConfigurationInfo.INPUT_FEATURE_HARD_KEYBOARD; } cPref.reqNavigation = sa.getInt( com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqNavigation, Configuration.NAVIGATION_UNDEFINED); if (sa.getBoolean( com.android.internal.R.styleable.AndroidManifestUsesConfiguration_reqFiveWayNav, false)) { cPref.reqInputFeatures |= ConfigurationInfo.INPUT_FEATURE_FIVE_WAY_NAV; } sa.recycle(); pkg.configPreferences = ArrayUtils.add(pkg.configPreferences, cPref); XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;uses-feature&quot;)) { FeatureInfo fi = parseUsesFeature(res, attrs); pkg.reqFeatures = ArrayUtils.add(pkg.reqFeatures, fi); if (fi.name == null) { ConfigurationInfo cPref = new ConfigurationInfo(); cPref.reqGlEsVersion = fi.reqGlEsVersion; pkg.configPreferences = ArrayUtils.add(pkg.configPreferences, cPref); } XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;feature-group&quot;)) { FeatureGroupInfo group = new FeatureGroupInfo(); ArrayList&lt;FeatureInfo&gt; features = null; final int innerDepth = parser.getDepth(); while ((type = parser.next()) != XmlPullParser.END_DOCUMENT &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) { if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) { continue; } final String innerTagName = parser.getName(); if (innerTagName.equals(&quot;uses-feature&quot;)) { FeatureInfo featureInfo = parseUsesFeature(res, attrs); // FeatureGroups are stricter and mandate that // any &lt;uses-feature&gt; declared are mandatory. featureInfo.flags |= FeatureInfo.FLAG_REQUIRED; features = ArrayUtils.add(features, featureInfo); } else { Slog.w(TAG, &quot;Unknown element under &lt;feature-group&gt;: &quot; + innerTagName + &quot; at &quot; + mArchiveSourcePath + &quot; &quot; + parser.getPositionDescription()); } XmlUtils.skipCurrentTag(parser); } if (features != null) { group.features = new FeatureInfo[features.size()]; group.features = features.toArray(group.features); } pkg.featureGroups = ArrayUtils.add(pkg.featureGroups, group); } else if (tagName.equals(&quot;uses-sdk&quot;)) { if (SDK_VERSION &gt; 0) { sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestUsesSdk); int minVers = 0; String minCode = null; int targetVers = 0; String targetCode = null; TypedValue val = sa.peekValue( com.android.internal.R.styleable.AndroidManifestUsesSdk_minSdkVersion); if (val != null) { if (val.type == TypedValue.TYPE_STRING &amp;&amp; val.string != null) { targetCode = minCode = val.string.toString(); } else { // If it's not a string, it's an integer. targetVers = minVers = val.data; } } val = sa.peekValue( com.android.internal.R.styleable.AndroidManifestUsesSdk_targetSdkVersion); if (val != null) { if (val.type == TypedValue.TYPE_STRING &amp;&amp; val.string != null) { targetCode = minCode = val.string.toString(); } else { // If it's not a string, it's an integer. targetVers = val.data; } } sa.recycle(); if (minCode != null) { boolean allowedCodename = false; for (String codename : SDK_CODENAMES) { if (minCode.equals(codename)) { allowedCodename = true; break; } } if (!allowedCodename) { if (SDK_CODENAMES.length &gt; 0) { outError[0] = &quot;Requires development platform &quot; + minCode + &quot; (current platform is any of &quot; + Arrays.toString(SDK_CODENAMES) + &quot;)&quot;; } else { outError[0] = &quot;Requires development platform &quot; + minCode + &quot; but this is a release platform.&quot;; } mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK; return null; } } else if (minVers &gt; SDK_VERSION) { outError[0] = &quot;Requires newer sdk version #&quot; + minVers + &quot; (current version is #&quot; + SDK_VERSION + &quot;)&quot;; mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK; return null; } if (targetCode != null) { boolean allowedCodename = false; for (String codename : SDK_CODENAMES) { if (targetCode.equals(codename)) { allowedCodename = true; break; } } if (!allowedCodename) { if (SDK_CODENAMES.length &gt; 0) { outError[0] = &quot;Requires development platform &quot; + targetCode + &quot; (current platform is any of &quot; + Arrays.toString(SDK_CODENAMES) + &quot;)&quot;; } else { outError[0] = &quot;Requires development platform &quot; + targetCode + &quot; but this is a release platform.&quot;; } mParseError = PackageManager.INSTALL_FAILED_OLDER_SDK; return null; } // If the code matches, it definitely targets this SDK. pkg.applicationInfo.targetSdkVersion = android.os.Build.VERSION_CODES.CUR_DEVELOPMENT; } else { pkg.applicationInfo.targetSdkVersion = targetVers; } } XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;supports-screens&quot;)) { sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestSupportsScreens); pkg.applicationInfo.requiresSmallestWidthDp = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_requiresSmallestWidthDp, 0); pkg.applicationInfo.compatibleWidthLimitDp = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_compatibleWidthLimitDp, 0); pkg.applicationInfo.largestWidthLimitDp = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_largestWidthLimitDp, 0); // This is a trick to get a boolean and still able to detect // if a value was actually set. supportsSmallScreens = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_smallScreens, supportsSmallScreens); supportsNormalScreens = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_normalScreens, supportsNormalScreens); supportsLargeScreens = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_largeScreens, supportsLargeScreens); supportsXLargeScreens = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_xlargeScreens, supportsXLargeScreens); resizeable = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_resizeable, resizeable); anyDensity = sa.getInteger( com.android.internal.R.styleable.AndroidManifestSupportsScreens_anyDensity, anyDensity); sa.recycle(); XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;protected-broadcast&quot;)) { sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestProtectedBroadcast); // Note: don't allow this value to be a reference to a resource // that may change. String name = sa.getNonResourceString( com.android.internal.R.styleable.AndroidManifestProtectedBroadcast_name); sa.recycle(); if (name != null &amp;&amp; (flags&amp;PARSE_IS_SYSTEM) != 0) { if (pkg.protectedBroadcasts == null) { pkg.protectedBroadcasts = new ArrayList&lt;String&gt;(); } if (!pkg.protectedBroadcasts.contains(name)) { pkg.protectedBroadcasts.add(name.intern()); } } XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;instrumentation&quot;)) { if (parseInstrumentation(pkg, res, parser, attrs, outError) == null) { return null; } } else if (tagName.equals(&quot;original-package&quot;)) { sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestOriginalPackage); String orig =sa.getNonConfigurationString( com.android.internal.R.styleable.AndroidManifestOriginalPackage_name, 0); if (!pkg.packageName.equals(orig)) { if (pkg.mOriginalPackages == null) { pkg.mOriginalPackages = new ArrayList&lt;String&gt;(); pkg.mRealPackage = pkg.packageName; } pkg.mOriginalPackages.add(orig); } sa.recycle(); XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;adopt-permissions&quot;)) { sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestOriginalPackage); String name = sa.getNonConfigurationString( com.android.internal.R.styleable.AndroidManifestOriginalPackage_name, 0); sa.recycle(); if (name != null) { if (pkg.mAdoptPermissions == null) { pkg.mAdoptPermissions = new ArrayList&lt;String&gt;(); } pkg.mAdoptPermissions.add(name); } XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;uses-gl-texture&quot;)) { // Just skip this tag XmlUtils.skipCurrentTag(parser); continue; } else if (tagName.equals(&quot;compatible-screens&quot;)) { // Just skip this tag XmlUtils.skipCurrentTag(parser); continue; } else if (tagName.equals(&quot;supports-input&quot;)) { XmlUtils.skipCurrentTag(parser); continue; } else if (tagName.equals(&quot;eat-comment&quot;)) { // Just skip this tag XmlUtils.skipCurrentTag(parser); continue; } else if (RIGID_PARSER) { outError[0] = &quot;Bad element under &lt;manifest&gt;: &quot; + parser.getName(); mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return null; } else { Slog.w(TAG, &quot;Unknown element under &lt;manifest&gt;: &quot; + parser.getName() + &quot; at &quot; + mArchiveSourcePath + &quot; &quot; + parser.getPositionDescription()); XmlUtils.skipCurrentTag(parser); continue; } } åœ¨è¿™ä¸ªparseBaseApkæ–¹æ³•ä¸­æœ‰ä¸€ä¸ªwhileå¾ªç¯ï¼Œè¯¥å¾ªç¯ä¸»è¦å°±æ˜¯ç”¨äºè§£æAndroidManifest.xmlæ–‡ä»¶ä¸­çš„èŠ‚ç‚¹ä¿¡æ¯ã€‚åœ¨å¼€å§‹è§£æapplicationèŠ‚ç‚¹çš„æ—¶å€™ï¼ŒåŒæ—¶è°ƒç”¨äº†parseBaseApplicationæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è§£æäº†applicationèŠ‚ç‚¹ä¸‹çš„activityï¼Œserviceï¼Œbroadcastï¼Œcontentprovierç­‰ç»„ä»¶çš„å®šä¹‰ä¿¡æ¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128while ((type = parser.next()) != XmlPullParser.END_DOCUMENT &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) { if (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) { continue; } String tagName = parser.getName(); if (tagName.equals(&quot;activity&quot;)) { Activity a = parseActivity(owner, res, parser, attrs, flags, outError, false, owner.baseHardwareAccelerated); if (a == null) { mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; } owner.activities.add(a); } else if (tagName.equals(&quot;receiver&quot;)) { Activity a = parseActivity(owner, res, parser, attrs, flags, outError, true, false); if (a == null) { mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; } owner.receivers.add(a); } else if (tagName.equals(&quot;service&quot;)) { Service s = parseService(owner, res, parser, attrs, flags, outError); if (s == null) { mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; } owner.services.add(s); } else if (tagName.equals(&quot;provider&quot;)) { Provider p = parseProvider(owner, res, parser, attrs, flags, outError); if (p == null) { mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; } owner.providers.add(p); } else if (tagName.equals(&quot;activity-alias&quot;)) { Activity a = parseActivityAlias(owner, res, parser, attrs, flags, outError); if (a == null) { mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; } owner.activities.add(a); } else if (parser.getName().equals(&quot;meta-data&quot;)) { // note: application meta-data is stored off to the side, so it can // remain null in the primary copy (we like to avoid extra copies because // it can be large) if ((owner.mAppMetaData = parseMetaData(res, parser, attrs, owner.mAppMetaData, outError)) == null) { mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; } } else if (tagName.equals(&quot;library&quot;)) { sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestLibrary); // Note: don't allow this value to be a reference to a resource // that may change. String lname = sa.getNonResourceString( com.android.internal.R.styleable.AndroidManifestLibrary_name); sa.recycle(); if (lname != null) { lname = lname.intern(); if (!ArrayUtils.contains(owner.libraryNames, lname)) { owner.libraryNames = ArrayUtils.add(owner.libraryNames, lname); } } XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;uses-library&quot;)) { sa = res.obtainAttributes(attrs, com.android.internal.R.styleable.AndroidManifestUsesLibrary); // Note: don't allow this value to be a reference to a resource // that may change. String lname = sa.getNonResourceString( com.android.internal.R.styleable.AndroidManifestUsesLibrary_name); boolean req = sa.getBoolean( com.android.internal.R.styleable.AndroidManifestUsesLibrary_required, true); sa.recycle(); if (lname != null) { lname = lname.intern(); if (req) { owner.usesLibraries = ArrayUtils.add(owner.usesLibraries, lname); } else { owner.usesOptionalLibraries = ArrayUtils.add( owner.usesOptionalLibraries, lname); } } XmlUtils.skipCurrentTag(parser); } else if (tagName.equals(&quot;uses-package&quot;)) { // Dependencies for app installers; we don't currently try to // enforce this. XmlUtils.skipCurrentTag(parser); } else { if (!RIGID_PARSER) { Slog.w(TAG, &quot;Unknown element under &lt;application&gt;: &quot; + tagName + &quot; at &quot; + mArchiveSourcePath + &quot; &quot; + parser.getPositionDescription()); XmlUtils.skipCurrentTag(parser); continue; } else { outError[0] = &quot;Bad element under &lt;application&gt;: &quot; + tagName; mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED; return false; } } } è¿™æ ·ï¼Œç»è¿‡è¿™é‡Œå¾ªç¯éå†ï¼Œæ•´ä¸ªandroidManifestçš„èŠ‚ç‚¹ä¿¡æ¯å°±è¢«è§£æå¹¶ä¿å­˜åœ¨äº†Packageå¯¹è±¡ä¸­ã€‚å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¹³æ—¶åœ¨Manifestä¸­å®šä¹‰çš„å„ç§èŠ‚ç‚¹ï¼Œå…¶å®éƒ½æ˜¯åœ¨è¿™é‡Œæœ‰æ‰€ä½“ç°ã€‚å½“androidManifest.xmlæ–‡ä»¶è¢«è§£æå®Œæˆä¹‹åä¼šè°ƒç”¨æˆ‘ä»¬åˆšåˆšä»‹ç»çš„scanPackageLIçš„é‡è½½æ–¹æ³•ï¼Œå°†è§£æå®Œæˆçš„Packageå¯¹è±¡ä¿¡æ¯ä¿å­˜çš„Settingå¯¹è±¡ä¸­ï¼Œè¿™ä¸ªå¯¹è±¡ç”¨äºä¿å­˜appçš„å®‰è£…ä¿¡æ¯ï¼Œå…·ä½“å®ç°æ˜¯åœ¨æ–¹æ³•ï¼š 12private PackageParser.Package scanPackageLI(File scanFile, int parseFlags, int scanFlags, long currentTime, UserHandle user) throws PackageManagerException å½“è§£æå®Œæˆmanifestæ–‡ä»¶ä¹‹åä¼šè°ƒç”¨å…¶é‡è½½æ–¹æ³•ï¼š 123// Note that we invoke the following method only if we are about to unpack an application PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanFlags | SCAN_UPDATE_SIGNATURE, currentTime, user); è¿™æ ·ï¼Œè§£æçš„manifestæ–‡ä»¶ä¿¡æ¯å°±ä¼šè¢«ä¿å­˜åˆ°Settingsä¸­ï¼Œå¹¶æŒä¹…åŒ–ï¼Œç„¶åæ‰§è¡Œå®‰è£…apkçš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¯¥é‡è½½æ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567891011121314private PackageParser.Package scanPackageLI(PackageParser.Package pkg, int parseFlags, int scanFlags, long currentTime, UserHandle user) throws PackageManagerException { boolean success = false; try { final PackageParser.Package res = scanPackageDirtyLI(pkg, parseFlags, scanFlags, currentTime, user); success = true; return res; } finally { if (!success &amp;&amp; (scanFlags &amp; SCAN_DELETE_DATA_ON_FAILURES) != 0) { removeDataDirsLI(pkg.volumeUuid, pkg.packageName); } } } å¯ä»¥å‘ç°å…¶å†…éƒ¨è°ƒç”¨äº†scanPackageDirtyLIæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å®é™…å®ç°æŒä¹…åŒ–manifestä¿¡æ¯å¹¶å®‰è£…APKæ“ä½œçš„ï¼š 12345678private PackageParser.Package scanPackageDirtyLI(PackageParser.Package pkg, int parseFlags, int scanFlags, long currentTime, UserHandle user) throws PackageManagerException { ... // And now re-install the app. ret = createDataDirsLI(pkg.volumeUuid, pkgName, pkg.applicationInfo.uid, pkg.applicationInfo.seinfo); ...} å¯ä»¥å‘ç°å…¶å†…éƒ¨è°ƒç”¨äº†createDataDirLIï¼Œè¯¥æ–¹æ³•ä¸»è¦å®ç°å®‰è£…apkçš„æ“ä½œã€‚ 1234567891011121314151617private int createDataDirsLI(String volumeUuid, String packageName, int uid, String seinfo) { int[] users = sUserManager.getUserIds(); int res = mInstaller.install(volumeUuid, packageName, uid, uid, seinfo); if (res &lt; 0) { return res; } for (int user : users) { if (user != 0) { res = mInstaller.createUserData(volumeUuid, packageName, UserHandle.getUid(user, uid), user, seinfo); if (res &lt; 0) { return res; } } } return res; } æŸ¥çœ‹è¯¥æ–¹æ³•çš„å®ç°ï¼š1234567891011121314public int install(String uuid, String name, int uid, int gid, String seinfo) { StringBuilder builder = new StringBuilder(&quot;install&quot;); builder.append(' '); builder.append(escapeNull(uuid)); builder.append(' '); builder.append(name); builder.append(' '); builder.append(uid); builder.append(' '); builder.append(gid); builder.append(' '); builder.append(seinfo != null ? seinfo : &quot;!&quot;); return mInstaller.execute(builder.toString()); }æ€ä¹ˆæ ·ï¼Ÿå¾ˆç†Ÿæ‚‰å§ï¼Œè¿™é‡Œçš„Installerå…¶å®è°ƒç”¨çš„å°±æ˜¯æˆ‘ä»¬å¹³æ—¶è¿è¡Œandroidé¡¹ç›®å¾ˆç†Ÿæ‚‰çš„installå‘½ä»¤ï¼ŒåŸæ¥androidç³»ç»Ÿå®‰è£…apkæ–‡ä»¶åº•å±‚éƒ½æ˜¯è°ƒç”¨çš„adbå‘½ä»¤ã€‚ æ€»ç»“ï¼š androidç³»ç»Ÿå¯åŠ¨ä¹‹åä¼šè§£æå›ºå®šç›®å½•ä¸‹çš„apkæ–‡ä»¶ï¼Œå¹¶æ‰§è¡Œè§£æï¼ŒæŒä¹…åŒ–apkä¿¡æ¯ï¼Œé‡æ–°å®‰è£…ç­‰æ“ä½œï¼› è§£æManifestæµç¨‹ï¼šZygoteè¿›ç¨‹ â€“&gt; SystemServerè¿›ç¨‹ â€“&gt; PackgeManagerServiceæœåŠ¡ â€“&gt; scanDirLIæ–¹æ³• â€“&gt; scanPackageLIæ–¹æ³• â€“&gt; PackageParser.parserPackageæ–¹æ³•ï¼› è§£æå®ŒæˆManifestä¹‹åä¼šå°†apkçš„Manifestä¿¡æ¯ä¿å­˜åœ¨Settingså¯¹è±¡ä¸­å¹¶æŒä¹…åŒ–ï¼Œç„¶åæ‰§è¡Œé‡æ–°å®‰è£…çš„æ“ä½œï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹","link":"/2020/09/11/%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E5%B9%B6%E8%A7%A3%E6%9E%90Manifest%E7%9A%84%E6%B5%81%E7%A8%8B/"},{"title":"30 è§¦æ‘¸äº‹ä»¶åˆ†å‘æµç¨‹","text":"å‰é¢ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬åˆ†æäº†Appè¿”å›æŒ‰é”®çš„åˆ†å‘æµç¨‹ï¼Œä»Nativeå±‚åˆ°ViewRootImplå±‚åˆ°DocorViewå±‚åˆ°Activityå±‚ï¼Œä»¥åŠåœ¨Activityä¸­çš„dispatchKeyEventæ–¹æ³•ä¸­åˆ†å‘äº‹ä»¶ï¼Œæœ€ç»ˆè°ƒç”¨äº†Activityçš„finishæ–¹æ³•ï¼Œå³é”€æ¯Activityï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹å‡å¦‚æˆ‘ä»¬ä¸é‡å†™Activityçš„onBackPressæ–¹æ³•æˆ–è€…æ˜¯onKeyDownæ–¹æ³•ï¼Œå½“æˆ‘ä»¬æŒ‰ä¸‹å¹¶æŠ¬èµ·è¿”å›æŒ‰é”®çš„æ—¶å€™é»˜è®¤éƒ½æ˜¯é”€æ¯å½“å‰Activityã€‚è€Œæœ¬æ–‡ä¸­æˆ‘ä»¬ä¸»è¦ä»‹ç»è§¦æ‘¸äº‹ä»¶çš„åˆ†å‘æµç¨‹ï¼Œä»Nativeå±‚åˆ°Activityå±‚è§¦æ‘¸äº‹ä»¶çš„åˆ†å‘äº†æµç¨‹å’ŒæŒ‰é”®çš„åˆ†å‘äº‹ä»¶éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å¼‚å¸¸å †æ ˆä¿¡æ¯çœ‹ä¸€ä¸‹ã€‚ 123456789101112131415161718192021at com.example.aaron.helloworld.MainActivity.dispatchTouchEvent(MainActivity.java:103)at com.android.internal.policy.impl.PhoneWindow$DecorView.dispatchTouchEvent(PhoneWindow.java:2359)at android.view.View.dispatchPointerEvent(View.java:8698)at android.view.ViewRootImpl$ViewPostImeInputStage.processPointerEvent(ViewRootImpl.java:4530)at android.view.ViewRootImpl$ViewPostImeInputStage.onProcess(ViewRootImpl.java:4388)at android.view.ViewRootImpl$InputStage.deliver(ViewRootImpl.java:3924)at android.view.ViewRootImpl$InputStage.onDeliverToNext(ViewRootImpl.java:3977)at android.view.ViewRootImpl$InputStage.forward(ViewRootImpl.java:3943)at android.view.ViewRootImpl$AsyncInputStage.forward(ViewRootImpl.java:4053)at android.view.ViewRootImpl$InputStage.apply(ViewRootImpl.java:3951)at android.view.ViewRootImpl$AsyncInputStage.apply(ViewRootImpl.java:4110)at android.view.ViewRootImpl$InputStage.deliver(ViewRootImpl.java:3924)at android.view.ViewRootImpl$InputStage.onDeliverToNext(ViewRootImpl.java:3977)at android.view.ViewRootImpl$InputStage.forward(ViewRootImpl.java:3943)at android.view.ViewRootImpl$InputStage.apply(ViewRootImpl.java:3951)at android.view.ViewRootImpl$InputStage.deliver(ViewRootImpl.java:3924)at android.view.ViewRootImpl.deliverInputEvent(ViewRootImpl.java:6345)at android.view.ViewRootImpl.doProcessInputEvents(ViewRootImpl.java:6301)at android.view.ViewRootImpl.enqueueInputEvent(ViewRootImpl.java:6254)at android.view.ViewRootImpl$WindowInputEventReceiver.onInputEvent(ViewRootImpl.java:6507)at android.view.InputEventReceiver.dispatchInputEvent(InputEventReceiver.java:185) è¿™æ ·ç»è¿‡ä¸€ç³»åˆ—çš„æ–¹æ³•è°ƒç”¨ä¹‹åæœ€ç»ˆè°ƒç”¨äº†Activityçš„dispatchTouchEventæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬ä¹Ÿæ˜¯ä»Activiytçš„dispatchTouchEventæ–¹æ³•å¼€å§‹å¯¹è§¦æ‘¸äº‹ä»¶çš„åˆ†å‘è¿›è¡Œåˆ†æã€‚ åœ¨å…·ä½“æŸ¥çœ‹Activityçš„dispatchTouchEventæ–¹æ³•ä¹‹å‰æˆ‘ä»¬å…ˆç®€å•ä»‹ç»ä¸€ä¸‹è§¦æ‘¸äº‹ä»¶ï¼Œè§¦æ‘¸äº‹ä»¶æ˜¯ç”±ä¸€ä¸ªè§¦æ‘¸æŒ‰ä¸‹äº‹ä»¶ã€Nä¸ªè§¦æ‘¸æ»‘åŠ¨äº‹ä»¶å’Œä¸€ä¸ªè§¦æ‘¸æŠ¬èµ·äº‹ä»¶ç»„æˆçš„ï¼Œé€šå¸¸çš„ä¸€ä¸ªè§¦æ‘¸äº‹ä»¶ä¸­åªèƒ½å­˜åœ¨ä¸€ä¸ªè§¦æ‘¸æŒ‰ä¸‹å’Œä¸€ä¸ªè§¦æ‘¸æŠ¬èµ·äº‹ä»¶ï¼Œä½†æ˜¯è§¦æ‘¸æ»‘åŠ¨äº‹ä»¶å¯ä»¥æœ‰é›¶ä¸ªæˆ–è€…å¤šä¸ªã€‚å¥½äº†ï¼ŒçŸ¥é“è¿™ä¸ªæ¦‚å¿µä»¥åï¼Œä¸‹é¢æˆ‘ä»¬å°±å…·ä½“çœ‹ä¸€ä¸‹Activityä¸­çš„dispatchTouchEventçš„å®ç°é€»è¾‘ã€‚ 123456789public boolean dispatchTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { onUserInteraction(); } if (getWindow().superDispatchTouchEvent(ev)) { return true; } return onTouchEvent(ev); } åœ¨çœ‹ä¸€ä¸‹dispatchTouchEventæ–¹æ³•ä¹‹å‰æˆ‘ä»¬é¦–å…ˆéœ€è¦è§£é‡Šä¸€ä¸‹MotionEventçš„æ¦‚å¿µã€‚MotionEventæ˜¯ä¸€ä¸ªè§¦æ‘¸åŠ¨ä½œçš„å°è£…ï¼Œé‡Œé¢åŒ…å«äº†è§¦æ‘¸åŠ¨ä½œçš„ç±»å‹ï¼Œä»¥åŠæ“ä½œç­‰å±æ€§ï¼Œæˆ‘ä»¬å…·ä½“çš„å¯ä»¥çœ‹ä¸€ä¸‹MotionEventçš„è¯´æ˜ï¼š Object used to report movement (mouse, pen, finger, trackball) events. Motion events may hold either absolute or relative movements and other data, depending on the type of device. ç„¶ååœ¨dispatchTouchEventæ–¹æ³•ä¸­ï¼Œä¼šé¦–å…ˆåˆ¤æ–­MotionEventçš„åŠ¨ä½œç±»å‹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è§¦ç›®åŠ¨ä½œçš„ç±»å‹ï¼Œåˆ¤æ–­å…¶æ˜¯å¦æ˜¯â€œæŒ‰ä¸‹â€æ“ä½œï¼Œè‹¥æ˜¯çš„æ¹–æ³½ï¼Œåˆ™æ‰§è¡ŒonUserInteractionæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åˆæ˜¯å®ç°äº†ä»€ä¹ˆé€»è¾‘å‘¢ï¼Ÿ 12public void onUserInteraction() { }å¯ä»¥å‘ç°å…¶åœ¨Activityä¸­åªæ˜¯ä¸€ä¸ªç®€å•çš„ç©ºå®ç°æ–¹æ³•ï¼ŒåŒæ ·çš„æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¯¥æ–¹æ³•çš„ä»‹ç»ï¼š Called whenever a key, touch, or trackball event is dispatched to the activity. Implement this method if you wish to know that the user has interacted with the device in some way while your activity is running. This callback and {@link #onUserLeaveHint} are intended to help activities manage status bar notifications intelligently; specifically, for helping activities determine the proper time to cancel a notfication. ç†è§£ä¸Šå°±æ˜¯ç”¨æˆ·åœ¨è§¦å±ç‚¹å‡»ï¼ŒæŒ‰homeï¼Œbackï¼Œmenué”®éƒ½ä¼šè§¦å‘æ­¤æ–¹æ³•ã€‚ å›åˆ°Activityçš„dispatchTouchEventæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨äº†getWindow().suerDispatchTouchEvent()æ–¹æ³•ï¼Œæˆ‘ä»¬åˆ†æè¿‡Activityçš„åŠ è½½ç»˜åˆ¶æµç¨‹ï¼Œè€Œè¿™é‡Œçš„getWindow()å°±æ˜¯è¿”å›Activityä¸­çš„mWindowå¯¹è±¡ï¼Œè€Œæˆ‘ä»¬çŸ¥é“Activityä¸­çš„mWindowå¯¹è±¡å°±æ˜¯ä¸€ä¸ªPhoneWindowçš„å®ä¾‹ã€‚å¹¶ä¸”è¿™é‡Œçš„window.superDispatchTouchEventè‹¥è¿”å›å€¼ä¸ºtureï¼Œåˆ™ç›´æ¥è¿”å›trueï¼Œå¦åˆ™çš„è¯ä¼šæ‰§è¡ŒActivityçš„onTouchEventæ–¹æ³•ï¼Œç»§ç»­æˆ‘ä»¬çœ‹ä¸€ä¸‹PhoneWindowçš„superDispatchTouchEventæ–¹æ³•ã€‚ 1234@Override public boolean superDispatchTouchEvent(MotionEvent event) { return mDecor.superDispatchTouchEvent(event); } å¯ä»¥çœ‹åˆ°åœ¨PhoneWindowä¸­çš„superDispatchTouchEventæ–¹æ³•ä¸­è°ƒç”¨çš„æ˜¯mDecor.superDispatchTouchEventæ–¹æ³•ï¼Œè€Œè¿™é‡Œçš„mDecoræ˜¯æˆ‘ä»¬Activityæ˜¾ç¤ºçš„ViewTreeçš„æ ¹Viewï¼Œå¹¶ä¸”mDecoræ˜¯ä¸€ä¸ªFrameLayoutçš„å­ç±»ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹mDecorçš„superDispatchTouchEventæ–¹æ³•ã€‚ 1234567private final class DecorView extends FrameLayout implements RootViewSurfaceTaker { ... public boolean superDispatchTouchEvent(MotionEvent event) { return super.dispatchTouchEvent(event); } ...} åœ¨DecorViewçš„superDispatchTouchEventæ–¹æ³•ä¸­æˆ‘ä»¬è°ƒç”¨äº†super.dispatchTouchEventæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬çš„DecorViewç»§æ‰¿äºFrameLayoutï¼Œä½†æ˜¯ç»è¿‡æŸ¥çœ‹ä¹‹åæˆ‘ä»¬çŸ¥é“FrameLayoutä¸­å¹¶æ²¡æœ‰å®ç°dispatchTouchEventæ–¹æ³•ï¼Œè€Œç”±äºæˆ‘ä»¬çš„FrameLayoutç»§æ‰¿äºViewGroupï¼Œæ‰€ä»¥è¿™é‡Œçš„dispatchTouchEventæ–¹æ³•åº”è¯¥å°±æ˜¯ViewGroupçš„dispatchTouchEventæ–¹æ³•ã€‚ å¥½äº†ï¼Œè¿™é‡Œå…ˆæš‚æ—¶è¯´ä¸€ä¸‹Acitivtyä¸­çš„äº‹ä»¶åˆ†å‘æµç¨‹ ViewRootImplå±‚çš„äº‹ä»¶åˆ†å‘ä¼šé¦–å…ˆè°ƒç”¨Activityçš„dispatchTouchEventæ–¹æ³•ï¼› Activityçš„dispatchTouchEventæ–¹æ³•ä¸­ä¼šé€šè¿‡Window.superDispatchTouchEventæ–¹æ³•å°†äº‹ä»¶ä¼ é€’ç»™DecorViewå³ViewGroupã€‚ è‹¥windowçš„superDispatchTouchEventæ–¹æ³•è¿”å›trueï¼Œåˆ™äº‹ä»¶åˆ†å‘å®Œæˆï¼ŒActivityçš„dispatchTouchEventç›´æ¥è¿”å›ä¸ºtrueï¼Œå¦åˆ™çš„è¯è°ƒç”¨Activityçš„onTouchEventæ–¹æ³•ï¼Œå¹¶ä¸”Acitivtyçš„dispatchTouchEventè¿”å›å€¼ä¸Activityçš„onTouchEventè¿”å›å€¼ä¸€è‡´ã€‚ ä¸‹é¢æˆ‘ä»¬åœ¨ç»§ç»­çœ‹ä¸€ä¸‹ViewGroupçš„dispatchTouchEventæ–¹æ³•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214public boolean dispatchTouchEvent(MotionEvent ev) { if (mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onTouchEvent(ev, 1); } // If the event targets the accessibility focused view and this is it, start // normal event dispatch. Maybe a descendant is what will handle the click. if (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) { ev.setTargetAccessibilityFocus(false); } boolean handled = false; if (onFilterTouchEventForSecurity(ev)) { final int action = ev.getAction(); final int actionMasked = action &amp; MotionEvent.ACTION_MASK; // Handle an initial down. if (actionMasked == MotionEvent.ACTION_DOWN) { // Throw away all previous state when starting a new touch gesture. // The framework may have dropped the up or cancel event for the previous gesture // due to an app switch, ANR, or some other state change. cancelAndClearTouchTargets(ev); resetTouchState(); } // Check for interception. final boolean intercepted; if (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null) { final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0; if (!disallowIntercept) { intercepted = onInterceptTouchEvent(ev); ev.setAction(action); // restore action in case it was changed } else { intercepted = false; } } else { // There are no touch targets and this action is not an initial down // so this view group continues to intercept touches. intercepted = true; } // If intercepted, start normal event dispatch. Also if there is already // a view that is handling the gesture, do normal event dispatch. if (intercepted || mFirstTouchTarget != null) { ev.setTargetAccessibilityFocus(false); } // Check for cancelation. final boolean canceled = resetCancelNextUpFlag(this) || actionMasked == MotionEvent.ACTION_CANCEL; // Update list of touch targets for pointer down, if needed. final boolean split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != 0; TouchTarget newTouchTarget = null; boolean alreadyDispatchedToNewTouchTarget = false; if (!canceled &amp;&amp; !intercepted) { // If the event is targeting accessiiblity focus we give it to the // view that has accessibility focus and if it does not handle it // we clear the flag and dispatch the event to all children as usual. // We are looking up the accessibility focused host to avoid keeping // state since these events are very rare. View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus() ? findChildWithAccessibilityFocus() : null; if (actionMasked == MotionEvent.ACTION_DOWN || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN) || actionMasked == MotionEvent.ACTION_HOVER_MOVE) { final int actionIndex = ev.getActionIndex(); // always 0 for down final int idBitsToAssign = split ? 1 &lt;&lt; ev.getPointerId(actionIndex) : TouchTarget.ALL_POINTER_IDS; // Clean up earlier touch targets for this pointer id in case they // have become out of sync. removePointersFromTouchTargets(idBitsToAssign); final int childrenCount = mChildrenCount; if (newTouchTarget == null &amp;&amp; childrenCount != 0) { final float x = ev.getX(actionIndex); final float y = ev.getY(actionIndex); // Find a child that can receive the event. // Scan children from front to back. final ArrayList&lt;View&gt; preorderedList = buildOrderedChildList(); final boolean customOrder = preorderedList == null &amp;&amp; isChildrenDrawingOrderEnabled(); final View[] children = mChildren; for (int i = childrenCount - 1; i &gt;= 0; i--) { final int childIndex = customOrder ? getChildDrawingOrder(childrenCount, i) : i; final View child = (preorderedList == null) ? children[childIndex] : preorderedList.get(childIndex); // If there is a view that has accessibility focus we want it // to get the event first and if not handled we will perform a // normal dispatch. We may do a double iteration but this is // safer given the timeframe. if (childWithAccessibilityFocus != null) { if (childWithAccessibilityFocus != child) { continue; } childWithAccessibilityFocus = null; i = childrenCount - 1; } if (!canViewReceivePointerEvents(child) || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue; } newTouchTarget = getTouchTarget(child); if (newTouchTarget != null) { // Child is already receiving touch within its bounds. // Give it the new pointer in addition to the ones it is handling. newTouchTarget.pointerIdBits |= idBitsToAssign; break; } resetCancelNextUpFlag(child); if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) { // Child wants to receive touch within its bounds. mLastTouchDownTime = ev.getDownTime(); if (preorderedList != null) { // childIndex points into presorted list, find original index for (int j = 0; j &lt; childrenCount; j++) { if (children[childIndex] == mChildren[j]) { mLastTouchDownIndex = j; break; } } } else { mLastTouchDownIndex = childIndex; } mLastTouchDownX = ev.getX(); mLastTouchDownY = ev.getY(); newTouchTarget = addTouchTarget(child, idBitsToAssign); alreadyDispatchedToNewTouchTarget = true; break; } // The accessibility focus didn't handle the event, so clear // the flag and do a normal dispatch to all children. ev.setTargetAccessibilityFocus(false); } if (preorderedList != null) preorderedList.clear(); } if (newTouchTarget == null &amp;&amp; mFirstTouchTarget != null) { // Did not find a child to receive the event. // Assign the pointer to the least recently added target. newTouchTarget = mFirstTouchTarget; while (newTouchTarget.next != null) { newTouchTarget = newTouchTarget.next; } newTouchTarget.pointerIdBits |= idBitsToAssign; } } } // Dispatch to touch targets. if (mFirstTouchTarget == null) { // No touch targets so treat this as an ordinary view. handled = dispatchTransformedTouchEvent(ev, canceled, null, TouchTarget.ALL_POINTER_IDS); } else { // Dispatch to touch targets, excluding the new touch target if we already // dispatched to it. Cancel touch targets if necessary. TouchTarget predecessor = null; TouchTarget target = mFirstTouchTarget; while (target != null) { final TouchTarget next = target.next; if (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) { handled = true; } else { final boolean cancelChild = resetCancelNextUpFlag(target.child) || intercepted; if (dispatchTransformedTouchEvent(ev, cancelChild, target.child, target.pointerIdBits)) { handled = true; } if (cancelChild) { if (predecessor == null) { mFirstTouchTarget = next; } else { predecessor.next = next; } target.recycle(); target = next; continue; } } predecessor = target; target = next; } } // Update list of touch targets for pointer up or cancel, if needed. if (canceled || actionMasked == MotionEvent.ACTION_UP || actionMasked == MotionEvent.ACTION_HOVER_MOVE) { resetTouchState(); } else if (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) { final int actionIndex = ev.getActionIndex(); final int idBitsToRemove = 1 &lt;&lt; ev.getPointerId(actionIndex); removePointersFromTouchTargets(idBitsToRemove); } } if (!handled &amp;&amp; mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onUnhandledEvent(ev, 1); } return handled; } å‰é¢æˆ‘ä»¬çŸ¥é“è§¦æ‘¸äº‹ä»¶æ˜¯ç”±ä¸€ä¸ªè§¦æ‘¸æŒ‰ä¸‹äº‹ä»¶ï¼Œä¸€ä¸ªè§¦æ‘¸æŠ¬èµ·äº‹ä»¶å’ŒNä¸ªè§¦æ‘¸æ»‘åŠ¨äº‹ä»¶ç»„æˆçš„ï¼Œè€Œè¿™é‡Œçš„è§¦æ‘¸æŒ‰ä¸‹äº‹ä»¶å°±æ˜¯è¿™é‡Œçš„ACTION_DOWNï¼ŒåŒæ—¶å‹è°ŠACTION_DOWNæ˜¯ä¸€ç³»åˆ—äº‹ä»¶çš„å¼€ç«¯ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ACTION_DOWNæ—¶è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œä»ä¸Šé¢æºç ä¸­æ³¨é‡Šä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼Œæ¸…é™¤ä»¥å¾€çš„TouchçŠ¶æ€ç„¶åå¼€å§‹æ–°çš„æ‰‹åŠ¿ã€‚å¹¶åœ¨åœ¨cancelAndClearTouchTargets(ev)æ–¹æ³•ä¸­å°†mFirstTouchTargetè®¾ç½®ä¸ºäº†nullï¼Œæ¥ç€åœ¨resetTouchState()æ–¹æ³•ä¸­é‡ç½®TouchçŠ¶æ€æ ‡è¯†ã€‚ ç„¶åæ ‡è®°ViewGroupæ˜¯å¦æ‹¦æˆªTouchäº‹ä»¶çš„ä¼ é€’ï¼Œif (actionMasked == MotionEvent.ACTION_DOWN || mFirstTouchTarget != null)è¿™ä¸€æ¡åˆ¤æ–­è¯­å¥è¯´æ˜å½“äº‹ä»¶ä¸ºACTION_DOWNæˆ–è€…mFirstTouchTargetä¸ä¸ºnull(å³å·²ç»æ‰¾åˆ°èƒ½å¤Ÿæ¥æ”¶touchäº‹ä»¶çš„ç›®æ ‡ç»„ä»¶)æ—¶ifæˆç«‹ï¼Œå¦åˆ™ifä¸æˆç«‹ï¼Œç„¶åå°†interceptedè®¾ç½®ä¸ºtrueï¼Œä¹Ÿå³æ‹¦æˆªäº‹ä»¶ã€‚è¿™é‡Œè¯´æ˜ä¸€ä¸‹ViewGroupä¸­çš„onInterceptTouchEventæ–¹æ³•æ˜¯ViewGroupä¸­ç‰¹æœ‰çš„æ–¹æ³•ç”¨äºè¡¨ç¤ºæ˜¯å¦æ‹¦æˆªè§¦æ‘¸äº‹ä»¶ï¼Œè¿”å›ä¸ºtrueçš„è¯åˆ™è¡¨ç¤ºæ‹¦æˆªäº‹ä»¶ï¼Œäº‹ä»¶ä¸åœ¨å‘å­Viewä¸­åˆ†å‘ï¼Œè‹¥èŒƒå›´ä¸ºfalseçš„è¯ï¼Œåˆ™è¡¨ç¤ºä¸æ‹¦æˆªäº‹ä»¶ï¼Œç»§ç»­åˆ†å‘äº‹ä»¶ã€‚ 123public boolean onInterceptTouchEvent(MotionEvent ev) { return false; } ä¸€èˆ¬çš„æˆ‘ä»¬å¯ä»¥åœ¨è‡ªå®šä¹‰çš„ViewGroupä¸­é‡å†™è¯¥æ–¹æ³•ï¼Œç”¨äºæ‹¦æˆªäº‹ä»¶çš„åˆ†å‘ã€‚è€Œå½“æˆ‘ä»¬åœ¨çˆ¶ViewGroupé‡å†™è¯¥æ–¹æ³•è¿”å›ä¸ºtrueæ‰§è¡Œäº‹ä»¶æ‹¦æˆªçš„é€»è¾‘çš„æ—¶å€™ï¼Œå¯ä»¥åœ¨å­Viewä¸­é€šè¿‡è°ƒç”¨requestDisallowInterceptTouchEventæ–¹æ³•ï¼Œé‡æ–°è®¾ç½®çˆ¶ViewGroupçš„onInterceptTouchEventæ–¹æ³•ä¸ºfalseï¼Œä¸æ‹¦æˆªå¯¹äº‹ä»¶çš„åˆ†å‘é€»è¾‘ã€‚ 123456789101112131415161718public void requestDisallowInterceptTouchEvent(boolean disallowIntercept) { if (disallowIntercept == ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0)) { // We're already in this state, assume our ancestors are too return; } if (disallowIntercept) { mGroupFlags |= FLAG_DISALLOW_INTERCEPT; } else { mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT; } // Pass it up to our parent if (mParent != null) { mParent.requestDisallowInterceptTouchEvent(disallowIntercept); } } æ¯”å¦‚å¸¸è§çš„å‘æˆ‘ä»¬çš„ViewPagerä¸­ç”±äºéœ€è¦å¤„ç†å·¦å³æ»‘åŠ¨äº‹ä»¶ä»è€Œåœ¨å…¶onInterceptTouchEventæ–¹æ³•ä¸­é‡å†™äº†è¿”å›å€¼ï¼Œè¿”å›ä¸ºtrueï¼Œæ‹¦æˆªå¯¹äº‹ä»¶çš„å¤„ç†é€»è¾‘ï¼Œä½†æ˜¯è‹¥è¿™æ—¶å€™ViewPagerä¸­åµŒå¥—äº†ListViewï¼Œåˆ™listViewä¹Ÿéœ€è¦å¤„ç†è§¦æ‘¸äº‹ä»¶çš„é€»è¾‘ï¼Œä½†æ˜¯ViewPagerä¸­å·²ç»é‡å†™äº†onInterceptTouchEventæ–¹æ³•ï¼Œè¿™æ—¶å€™æ€ä¹ˆåŠå‘¢ï¼Ÿå¹¸è¿çš„æ˜¯ListViewä¹Ÿåœ¨å†…éƒ¨çš„å®ç°ä¸­è°ƒç”¨äº†requestDisallowInterceptTouchEventæ–¹æ³•ï¼Œä¿è¯è‡ªèº«è·å¾—å¯¹è§¦æ‘¸äº‹ä»¶çš„å¤„ç†ã€‚ ç„¶ååœ¨ä»£ç ä¸­æˆ‘ä»¬åˆ¤æ–­childrenCountä¸ªæ•°æ˜¯å¦ä¸ä¸º0ï¼Œç»§ç»­æˆ‘ä»¬è·å–å­Viewçš„listé›†åˆpreorderedListï¼›æœ€åé€šè¿‡ä¸€ä¸ªforå¾ªç¯å€’åºéå†æ‰€æœ‰çš„å­viewï¼Œè¿™æ˜¯å› ä¸ºpreorderedListä¸­çš„é¡ºåºæ˜¯æŒ‰ç…§addViewæˆ–è€…XMLå¸ƒå±€æ–‡ä»¶ä¸­çš„é¡ºåºæ¥çš„ï¼ŒåaddViewæ·»åŠ çš„å­Viewï¼Œä¼šå› ä¸ºAndroidçš„UIååˆ·æ–°æœºåˆ¶æ˜¾ç¤ºåœ¨ä¸Šå±‚ï¼›å‡å¦‚ç‚¹å‡»çš„åœ°æ–¹æœ‰ä¸¤ä¸ªå­Viewéƒ½åŒ…å«çš„ç‚¹å‡»çš„åæ ‡ï¼Œé‚£ä¹ˆåè¢«æ·»åŠ åˆ°å¸ƒå±€ä¸­çš„é‚£ä¸ªå­viewä¼šå…ˆå“åº”äº‹ä»¶ï¼›ä¹Ÿå°±æ˜¯è¯´åè¢«æ·»åŠ çš„å­viewä¼šæµ®åœ¨ä¸Šå±‚ï¼Œç‚¹å‡»çš„æ—¶å€™æœ€ä¸Šå±‚çš„é‚£ä¸ªç»„ä»¶å…ˆå»å“åº”äº‹ä»¶ã€‚ ç„¶åä»£ç é€šè¿‡è°ƒç”¨getTouchTargetå»æŸ¥æ‰¾å½“å‰å­Viewæ˜¯å¦åœ¨mFirstTouchTarget.nextè¿™æ¡targeté“¾ä¸­çš„æŸä¸€ä¸ªtargeä¸­ï¼Œå¦‚æœåœ¨åˆ™è¿”å›è¿™ä¸ªtargetï¼Œå¦åˆ™è¿”å›nullã€‚åœ¨è¿™æ®µä»£ç çš„ifåˆ¤æ–­é€šè¿‡è¯´æ˜æ‰¾åˆ°äº†æ¥æ”¶Touchäº‹ä»¶çš„å­Viewï¼Œå³newTouchTargetï¼Œé‚£ä¹ˆï¼Œæ—¢ç„¶å·²ç»æ‰¾åˆ°äº†ï¼Œæ‰€ä»¥æ‰§è¡Œbreakè·³å‡ºforå¾ªç¯ã€‚å¦‚æœæ²¡æœ‰breakåˆ™ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œè¿™é‡Œä½ å¯ä»¥çœ‹è§ä¸€æ®µifåˆ¤æ–­çš„ä»£ç if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign))ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•åˆæ˜¯æ‰§è¡Œä»€ä¹ˆé€»è¾‘çš„å‘¢ï¼Ÿ åœ¨è¯¥æ–¹æ³•ä¸­ä¸ºä¸€ä¸ªé€’å½’è°ƒç”¨ï¼Œä¼šé€’å½’è°ƒç”¨dispatchTouchEvent()æ–¹æ³•ã€‚åœ¨dispatchTouchEvent()ä¸­å¦‚æœå­Viewä¸ºViewGroupå¹¶ä¸”Touchæ²¡æœ‰è¢«æ‹¦æˆªé‚£ä¹ˆé€’å½’è°ƒç”¨dispatchTouchEvent()ï¼Œå¦‚æœå­Viewä¸ºViewé‚£ä¹ˆå°±ä¼šè°ƒç”¨å…¶onTouchEvent()ã€‚dispatchTransformedTouchEventæ–¹æ³•å¦‚æœè¿”å›trueåˆ™è¡¨ç¤ºå­Viewæ¶ˆè´¹æ‰è¯¥äº‹ä»¶ã€‚1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel, View child, int desiredPointerIdBits) { final boolean handled; // Canceling motions is a special case. We don't need to perform any transformations // or filtering. The important part is the action, not the contents. final int oldAction = event.getAction(); if (cancel || oldAction == MotionEvent.ACTION_CANCEL) { event.setAction(MotionEvent.ACTION_CANCEL); if (child == null) { handled = super.dispatchTouchEvent(event); } else { handled = child.dispatchTouchEvent(event); } event.setAction(oldAction); return handled; } // Calculate the number of pointers to deliver. final int oldPointerIdBits = event.getPointerIdBits(); final int newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits; // If for some reason we ended up in an inconsistent state where it looks like we // might produce a motion event with no pointers in it, then drop the event. if (newPointerIdBits == 0) { return false; } // If the number of pointers is the same and we don't need to perform any fancy // irreversible transformations, then we can reuse the motion event for this // dispatch as long as we are careful to revert any changes we make. // Otherwise we need to make a copy. final MotionEvent transformedEvent; if (newPointerIdBits == oldPointerIdBits) { if (child == null || child.hasIdentityMatrix()) { if (child == null) { handled = super.dispatchTouchEvent(event); } else { final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; event.offsetLocation(offsetX, offsetY); handled = child.dispatchTouchEvent(event); event.offsetLocation(-offsetX, -offsetY); } return handled; } transformedEvent = MotionEvent.obtain(event); } else { transformedEvent = event.split(newPointerIdBits); } // Perform any necessary transformations and dispatch. if (child == null) { handled = super.dispatchTouchEvent(transformedEvent); } else { final float offsetX = mScrollX - child.mLeft; final float offsetY = mScrollY - child.mTop; transformedEvent.offsetLocation(offsetX, offsetY); if (! child.hasIdentityMatrix()) { transformedEvent.transform(child.getInverseMatrix()); } handled = child.dispatchTouchEvent(transformedEvent); } // Done. transformedEvent.recycle(); return handled; }ç„¶ååœ¨åœ¨ViewGroupçš„dispatchTransformedTouchEventæ–¹æ³•ä¸­ï¼Œè°ƒç”¨äº†è¯¥ViewGroupçš„child Viewçš„dispatchTouchEventæ–¹æ³•ï¼Œè‹¥å…¶å­Viewä¹Ÿæ˜¯ViewGroupï¼Œåˆ™é‡å¤æ‰§è¡ŒViewGroupçš„dispatchTouchEventæ–¹æ³•ï¼Œè‹¥å…¶å­Viewæ˜¯Viewï¼Œåˆ™æ‰§è¡ŒViewçš„dispatchTouchEventæ–¹æ³•ã€‚ ä½†è¿™é‡Œå¤§æ¦‚åˆ†æäº†ä¸€ä¸‹ViewGroupçš„äº‹ä»¶åˆ†å‘æµç¨‹ é¦–å…ˆåœ¨androidçš„äº‹ä»¶åˆ†å‘æµç¨‹ä¸­ï¼Œé€šè¿‡è°ƒç”¨Activityçš„dispatchTouchEventï¼Œäº‹ä»¶ä¼šé¦–å…ˆè¢«æ´¾å‘æ˜¯å…ˆä¼ é€’åˆ°æœ€é¡¶çº§çš„DecorViewä¹Ÿå°±æ˜¯ViewGroupï¼Œå†ç”±ViewGroupé€’å½’ä¼ é€’åˆ°Viewçš„ã€‚ åœ¨ViewGroupä¸­å¯ä»¥é€šè¿‡è®¾ç½®onInterceptTouchEventæ–¹æ³•å¯¹äº‹ä»¶ä¼ é€’è¿›è¡Œæ‹¦æˆªï¼ŒonInterceptTouchEventæ–¹æ³•è¿”å›trueä»£è¡¨ä¸å…è®¸äº‹ä»¶ç»§ç»­å‘å­Viewä¼ é€’ï¼Œè¿”å›falseä»£è¡¨ä¸å¯¹äº‹ä»¶è¿›è¡Œæ‹¦æˆªï¼Œé»˜è®¤è¿”å›falseã€‚ ä¸‹é¢æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹Viewçš„dispatchTouchEventæ–¹æ³•ã€‚12345678910111213141516171819public boolean dispatchTouchEvent(MotionEvent event) { ... if (onFilterTouchEventForSecurity(event)) { //noinspection SimplifiableIfStatement ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnTouchListener != null &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; li.mOnTouchListener.onTouch(this, event)) { result = true; } if (!result &amp;&amp; onTouchEvent(event)) { result = true; } } ... return result; }Viewçš„dispatchTouchEventæ–¹æ³•çš„å†…å®¹æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹Viewå¯¹è§¦æ‘¸äº‹ä»¶çš„å¤„ç†é€»è¾‘ï¼Œé¦–å…ˆè°ƒç”¨äº†onFilterTouchEventForSecurity(event)æ–¹æ³•åˆ¤æ–­å½“å‰çš„Viewæ˜¯å¦è¢«é®ç›–ï¼Œè‹¥æ²¡æœ‰çš„è¯ï¼Œåˆ™åˆ¤æ–­Viewçš„mListenerInfoåŸè¾¹å˜é‡æ˜¯å¦ä¸ºç©ºï¼Œè€Œè¿™é‡Œçš„mListenerInfoåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡åˆ†ææºç æˆ‘ä»¬çŸ¥é“è¿™é‡Œçš„mListenerInfoæ˜¯é€šè¿‡setOnClickListeneræ–¹æ³•è®¾ç½®çš„ã€‚ 123456public void setOnClickListener(@Nullable OnClickListener l) { if (!isClickable()) { setClickable(true); } getListenerInfo().mOnClickListener = l; } å¯ä»¥å½“å‰Viewä¸€æ—¦æ‰§è¡Œäº†setOnClickListeneræ–¹æ³•æ”¹Viewçš„mListenerInfoå°±ä¸ä¸ºç©ºï¼Œè‹¥åæœ‰åˆ¤æ–­äº†è¯¥Viewæ˜¯å¦å¯ç‚¹å‡»ï¼Œæœ€åæ˜¯åˆ¤æ–­Viewçš„onTouchListenerçš„onTouchæ–¹æ³•çš„è¿”å›å€¼ã€‚ æ‰€ä»¥å½“æˆ‘ä»¬ä¸ºå½“å‰Viewè®¾ç½®äº†OnTouchListenerå¹¶ä¸”è¿”å›å€¼ä¸ºtrueçš„è¯ï¼Œåˆ™ç›´æ¥æ‰§è¡Œå…¶onTouchæ–¹æ³•ï¼Œè‹¥onTouchæ–¹æ³•è¿”å›ä¸ºtrueçš„è¯ï¼Œåˆ™ç›´æ¥è¿”å›ä¸åœ¨æ‰§è¡Œåç»­çš„Viewçš„onTouchEventæ–¹æ³•ï¼Œå¦åˆ™ç»§ç»­æ‰§è¡ŒViewçš„onTouchEventæ–¹æ³•ï¼Œè€Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹Viewçš„onTouchEventæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138public boolean onTouchEvent(MotionEvent event) { final float x = event.getX(); final float y = event.getY(); final int viewFlags = mViewFlags; final int action = event.getAction(); if ((viewFlags &amp; ENABLED_MASK) == DISABLED) { if (action == MotionEvent.ACTION_UP &amp;&amp; (mPrivateFlags &amp; PFLAG_PRESSED) != 0) { setPressed(false); } // A disabled view that is clickable still consumes the touch // events, it just doesn't respond to them. return (((viewFlags &amp; CLICKABLE) == CLICKABLE || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE); } if (mTouchDelegate != null) { if (mTouchDelegate.onTouchEvent(event)) { return true; } } if (((viewFlags &amp; CLICKABLE) == CLICKABLE || (viewFlags &amp; LONG_CLICKABLE) == LONG_CLICKABLE) || (viewFlags &amp; CONTEXT_CLICKABLE) == CONTEXT_CLICKABLE) { switch (action) { case MotionEvent.ACTION_UP: boolean prepressed = (mPrivateFlags &amp; PFLAG_PREPRESSED) != 0; if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0 || prepressed) { // take focus if we don't have it already and we should in // touch mode. boolean focusTaken = false; if (isFocusable() &amp;&amp; isFocusableInTouchMode() &amp;&amp; !isFocused()) { focusTaken = requestFocus(); } if (prepressed) { // The button is being released before we actually // showed it as pressed. Make it show the pressed // state now (before scheduling the click) to ensure // the user sees it. setPressed(true, x, y); } if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) { // This is a tap, so remove the longpress check removeLongPressCallback(); // Only perform take click actions if we were in the pressed state if (!focusTaken) { // Use a Runnable and post this rather than calling // performClick directly. This lets other visual state // of the view update before click actions start. if (mPerformClick == null) { mPerformClick = new PerformClick(); } if (!post(mPerformClick)) { performClick(); } } } if (mUnsetPressedState == null) { mUnsetPressedState = new UnsetPressedState(); } if (prepressed) { postDelayed(mUnsetPressedState, ViewConfiguration.getPressedStateDuration()); } else if (!post(mUnsetPressedState)) { // If the post failed, unpress right now mUnsetPressedState.run(); } removeTapCallback(); } mIgnoreNextUpEvent = false; break; case MotionEvent.ACTION_DOWN: mHasPerformedLongPress = false; if (performButtonActionOnTouchDown(event)) { break; } // Walk up the hierarchy to determine if we're inside a scrolling container. boolean isInScrollingContainer = isInScrollingContainer(); // For views inside a scrolling container, delay the pressed feedback for // a short period in case this is a scroll. if (isInScrollingContainer) { mPrivateFlags |= PFLAG_PREPRESSED; if (mPendingCheckForTap == null) { mPendingCheckForTap = new CheckForTap(); } mPendingCheckForTap.x = event.getX(); mPendingCheckForTap.y = event.getY(); postDelayed(mPendingCheckForTap, ViewConfiguration.getTapTimeout()); } else { // Not inside a scrolling container, so show the feedback right away setPressed(true, x, y); checkForLongClick(0); } break; case MotionEvent.ACTION_CANCEL: setPressed(false); removeTapCallback(); removeLongPressCallback(); mInContextButtonPress = false; mHasPerformedLongPress = false; mIgnoreNextUpEvent = false; break; case MotionEvent.ACTION_MOVE: drawableHotspotChanged(x, y); // Be lenient about moving outside of buttons if (!pointInView(x, y, mTouchSlop)) { // Outside button removeTapCallback(); if ((mPrivateFlags &amp; PFLAG_PRESSED) != 0) { // Remove any future long press/tap checks removeLongPressCallback(); setPressed(false); } } break; } return true; } return false; } åœ¨ACTIONä¸ºMotionEvent.ACTION_UPæ—¶ï¼Œæˆ‘ä»¬ç»è¿‡å±‚å±‚è°ƒç”¨æœ€ç»ˆæ‰§è¡Œäº†performClickï¼Œæ–¹æ³•è€Œè¿™ä¸ªæ–¹æ³•ä¸­æˆ‘ä»¬å›è°ƒäº†Viewçš„OnClickListenerçš„onClickæ–¹æ³•ã€‚ã€‚ã€‚ 1234567891011121314public boolean performClick() { final boolean result; final ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnClickListener != null) { playSoundEffect(SoundEffectConstants.CLICK); li.mOnClickListener.onClick(this); result = true; } else { result = false; } sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_CLICKED); return result; } æ‰€ä»¥Viewç»„ä»¶åˆ†å‘è§¦æ‘¸äº‹ä»¶çš„æ—¶å€™ï¼š Viewæ§ä»¶ä¼šé¦–å…ˆæ‰§è¡ŒdispatchTouchEventæ–¹æ³•ã€‚ Viewæ§ä»¶åœ¨dispatchTouchEventæ–¹æ³•ä¸­å…ˆæ‰§è¡ŒonTouchæ–¹æ³•ï¼Œåæ‰§è¡ŒonClickæ–¹æ³•ã€‚ Viewçš„onTouchè¿”å›falseæˆ–è€…mOnTouchListenerä¸ºnullï¼ˆæ§ä»¶æ²¡æœ‰è®¾ç½®setOnTouchListeneræ–¹æ³•ï¼‰æˆ–è€…æ§ä»¶ä¸æ˜¯enableçš„æƒ…å†µä¸‹ä¼šè°ƒè¿onTouchEventï¼ŒdispatchTouchEventè¿”å›å€¼ä¸onTouchEventè¿”å›ä¸€æ ·ã€‚ Viewæ§ä»¶ä¸æ˜¯enableçš„ï¼Œé‚£ä¹ˆå³ä½¿è®¾ç½®äº†onTouchæ–¹æ³•ä¹Ÿä¸ä¼šæ‰§è¡Œï¼Œåªèƒ½é€šè¿‡é‡å†™æ§ä»¶çš„onTouchEventæ–¹æ³•å¤„ç†ï¼ŒdispatchTouchEventè¿”å›å€¼ä¸onTouchEventè¿”å›ä¸€æ ·ã€‚ å¦‚æœæ§ä»¶ï¼ˆViewï¼‰æ˜¯enableä¸”onTouchè¿”å›trueæƒ…å†µä¸‹ï¼ŒdispatchTouchEventç›´æ¥è¿”å›trueï¼Œä¸ä¼šè°ƒç”¨onTouchEventæ–¹æ³•ã€‚ å‚è€ƒï¼šhttp://blog.csdn.net/xiaanming/article/details/21696315http://blog.csdn.net/guolin_blog/article/details/9097463http://blog.csdn.net/guolin_blog/article/details/9153747 å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹androidæºç è§£æï¼ˆåå…«ï¼‰â€“&gt;Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆåä¹ï¼‰â€“&gt;DialogåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåï¼‰â€“&gt;Dialogå–æ¶ˆç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸€ï¼‰â€“&gt;PopupWindowåŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåäºŒï¼‰â€“&gt;ToaståŠ è½½ç»˜åˆ¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸‰ï¼‰â€“&gt;Androidå¼‚å¸¸å¤„ç†æµç¨‹androidæºç è§£æï¼ˆäºŒåå››ï¼‰â€“&gt;onSaveInstanceStateæ‰§è¡Œæ—¶æœºandroidæºç è§£æï¼ˆäºŒåäº”ï¼‰â€“&gt;onLowMemoryæ‰§è¡Œæµç¨‹androidæºç è§£æï¼ˆäºŒåå…­ï¼‰â€“&gt;æˆªå±äº‹ä»¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¸ƒï¼‰â€“&gt;HOMEäº‹ä»¶æµç¨‹androidæºç è§£æï¼ˆäºŒåå…«ï¼‰â€“&gt;ç”µæºå¼€å…³æœºæŒ‰é”®äº‹ä»¶æµç¨‹androidæºç è§£æï¼ˆäºŒåä¹ï¼‰â€“&gt;åº”ç”¨ç¨‹åºè¿”å›æŒ‰é”®æ‰§è¡Œæµç¨‹","link":"/2020/09/11/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E5%88%86%E5%8F%91%E6%B5%81%E7%A8%8B/"},{"title":"13 apkå®‰è£…æµç¨‹","text":"ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ç»™å¤§å®¶åˆ†æäº†ä¸€ä¸‹androidç³»ç»Ÿå¯åŠ¨ä¹‹åè°ƒç”¨PackageManagerServiceæœåŠ¡å¹¶è§£æç³»ç»Ÿç‰¹å®šç›®å½•ï¼Œè§£æapkæ–‡ä»¶å¹¶å®‰è£…çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªå®‰è£…è¿‡æœŸå®é™…ä¸Šæ˜¯æ²¡æœ‰å›¾å½¢ç•Œé¢çš„ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯æˆ‘ä»¬å¹³æ—¶æ¯”è¾ƒç†Ÿæ‚‰çš„adbå‘½ä»¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¹³æ—¶å®‰è£…apkæ–‡ä»¶çš„æ—¶å€™å¤§éƒ¨åˆ†æ˜¯éƒ½è¿‡å›¾å½¢ç•Œé¢å®‰è£…çš„ï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼å®‰è£…apkå…·ä½“çš„æµç¨‹æ˜¯æ€æ ·çš„å‘¢ï¼Ÿ ä¸‹é¢æˆ‘ä»¬å°±æ¥å…·ä½“çœ‹ä¸€ä¸‹apkçš„å…·ä½“å®‰è£…è¿‡ç¨‹ï¼Œç›¸ä¿¡å¤§å®¶éƒ½çŸ¥é“å¦‚æœæˆ‘ä»¬æƒ³åœ¨ä»£ç é‡Œæ‰§è¡Œapkçš„å®‰è£…ï¼Œé‚£ä¹ˆä¸€èˆ¬éƒ½æ˜¯è¿™æ ·ï¼š 1234Intent intent = new Intent(Intent.ACTION_VIEW);intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);intent.setDataAndType(Uri.parse(&quot;file://&quot; + path),&quot;application/vnd.android.package-archive&quot;);context.startActivity(intent); è¿™æ ·ï¼Œæˆ‘ä»¬å°±ä¼šæ‰“å¼€å®‰è£…apkæ–‡ä»¶çš„ç¨‹åºå¹¶æ‰§è¡Œå®‰è£…é€»è¾‘äº†ï¼Œé‚£ä¹ˆè¿™æ®µä»£ç å…·ä½“æ˜¯æ‰“å¼€é‚£ä¸ªactivityå‘¢ï¼Ÿå¥½å§ï¼Œä»è¿™ä¸ªé—®é¢˜å¼€å§‹ï¼Œæˆ‘ä»¬æ¥è§£æapkçš„å®‰è£…æµç¨‹â€¦ è¿™é‡Œè·Ÿå¤§å§ç®€å•ä»‹ç»ä¸€ä¸‹androidçš„æºç ï¼Œå¹³æ—¶æˆ‘ä»¬ä½¿ç”¨çš„android.jaré‡Œé¢çš„javaæºç åªæ˜¯androidç³»ç»Ÿæºç çš„ä¸€éƒ¨åˆ†ï¼Œè¿˜æœ‰å¥½å¤šæºç å¹¶æ²¡æœ‰æ‰“å…¥åˆ°android.jarä¸­ï¼Œè¿™é‡Œä¸ºå¤§å®¶æ¨èä¸€ä¸ªandroidæºç çš„åœ°å€ï¼šhttps://github.com/androidé‡Œé¢æ ¹æ®androidç³»ç»Ÿçš„ä¸åŒæ¨¡å—åŒ…å«äº†è®¸å¤šandroidæ¨¡å—çš„æºç ã€‚ è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°platform_packages_apps_packageinstalleråº“ï¼Œè¿™é‡Œé¢å°±æ˜¯androidç³»ç»Ÿå®‰è£…ç¨‹åºçš„æºç äº†ã€‚ è¿™é‡Œæˆ‘ä»¬æ‰¾åˆ°å…¶androidManifest.xmlï¼Œç„¶åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å…¶å…·ä½“çš„å®šä¹‰ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot; package=&quot;com.android.packageinstaller&quot; coreApp=&quot;true&quot;&gt; &lt;original-package android:name=&quot;com.android.packageinstaller&quot; /&gt; ... &lt;application android:label=&quot;@string/app_name&quot; android:allowBackup=&quot;false&quot; android:theme=&quot;@style/Theme.DialogWhenLarge&quot; android:supportsRtl=&quot;true&quot;&gt; &lt;activity android:name=&quot;.PackageInstallerActivity&quot; android:configChanges=&quot;orientation|keyboardHidden|screenSize&quot; android:excludeFromRecents=&quot;true&quot;&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt; &lt;action android:name=&quot;android.intent.action.INSTALL_PACKAGE&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;data android:scheme=&quot;file&quot; /&gt; &lt;data android:mimeType=&quot;application/vnd.android.package-archive&quot; /&gt; &lt;/intent-filter&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.intent.action.INSTALL_PACKAGE&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;data android:scheme=&quot;file&quot; /&gt; &lt;data android:scheme=&quot;package&quot; /&gt; &lt;/intent-filter&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.content.pm.action.CONFIRM_PERMISSIONS&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;/intent-filter&gt; &lt;/activity&gt; &lt;activity android:name=&quot;.InstallAppProgress&quot; android:configChanges=&quot;orientation|keyboardHidden|screenSize&quot; android:exported=&quot;false&quot; /&gt; &lt;activity android:name=&quot;.UninstallerActivity&quot; android:configChanges=&quot;orientation|keyboardHidden|screenSize&quot; android:excludeFromRecents=&quot;true&quot; android:theme=&quot;@style/Theme.AlertDialogActivity&quot;&gt; &lt;intent-filter android:priority=&quot;1&quot;&gt; &lt;action android:name=&quot;android.intent.action.DELETE&quot; /&gt; &lt;action android:name=&quot;android.intent.action.UNINSTALL_PACKAGE&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;data android:scheme=&quot;package&quot; /&gt; &lt;/intent-filter&gt; &lt;/activity&gt; &lt;activity android:name=&quot;.UninstallAppProgress&quot; android:configChanges=&quot;orientation|keyboardHidden|screenSize&quot; android:exported=&quot;false&quot; /&gt; &lt;activity android:name=&quot;.permission.ui.GrantPermissionsActivity&quot; android:configChanges=&quot;orientation|keyboardHidden|screenSize&quot; android:excludeFromRecents=&quot;true&quot; android:theme=&quot;@style/GrantPermissions&quot;&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.content.pm.action.REQUEST_PERMISSIONS&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;/intent-filter&gt; &lt;/activity&gt; &lt;activity android:name=&quot;.permission.ui.ManagePermissionsActivity&quot; android:configChanges=&quot;orientation|keyboardHidden|screenSize&quot; android:excludeFromRecents=&quot;true&quot; android:label=&quot;@string/app_permissions&quot; android:theme=&quot;@style/Settings&quot; android:permission=&quot;android.permission.GRANT_RUNTIME_PERMISSIONS&quot;&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.intent.action.MANAGE_PERMISSIONS&quot; /&gt; &lt;action android:name=&quot;android.intent.action.MANAGE_APP_PERMISSIONS&quot; /&gt; &lt;action android:name=&quot;android.intent.action.MANAGE_PERMISSION_APPS&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;/intent-filter&gt; &lt;/activity&gt; &lt;activity android:name=&quot;.permission.ui.OverlayWarningDialog&quot; android:excludeFromRecents=&quot;true&quot; android:theme=&quot;@android:style/Theme.DeviceDefault.Light.Dialog.NoActionBar&quot; /&gt; &lt;provider android:name=&quot;.wear.WearPackageIconProvider&quot; android:authorities=&quot;com.google.android.packageinstaller.wear.provider&quot; android:grantUriPermissions=&quot;true&quot; android:exported=&quot;true&quot; /&gt; &lt;activity android:name=&quot;.permission.ui.wear.WarningConfirmationActivity&quot; android:permission=&quot;android.permission.GRANT_RUNTIME_PERMISSIONS&quot; android:theme=&quot;@style/Settings&quot;/&gt; &lt;/application&gt; &lt;/manifest&gt;å¥½å§ï¼Œè¿™é‡Œæˆ‘ä»¬å¤§æ¦‚çœ‹ä¸€ä¸‹Activityçš„å®šä¹‰ï¼Œè¿™é‡Œæˆ‘ä»¬é‡ç‚¹çœ‹ä¸€ä¸‹PackageInstallerActivityçš„å®šä¹‰ï¼š 123456789101112131415161718192021&lt;activity android:name=&quot;.PackageInstallerActivity&quot; android:configChanges=&quot;orientation|keyboardHidden|screenSize&quot; android:excludeFromRecents=&quot;true&quot;&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.intent.action.VIEW&quot; /&gt; &lt;action android:name=&quot;android.intent.action.INSTALL_PACKAGE&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;data android:scheme=&quot;file&quot; /&gt; &lt;data android:mimeType=&quot;application/vnd.android.package-archive&quot; /&gt; &lt;/intent-filter&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.intent.action.INSTALL_PACKAGE&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;data android:scheme=&quot;file&quot; /&gt; &lt;data android:scheme=&quot;package&quot; /&gt; &lt;/intent-filter&gt; &lt;intent-filter&gt; &lt;action android:name=&quot;android.content.pm.action.CONFIRM_PERMISSIONS&quot; /&gt; &lt;category android:name=&quot;android.intent.category.DEFAULT&quot; /&gt; &lt;/intent-filter&gt; &lt;/activity&gt; æ©ï¼Ÿè¿™é‡Œä¸å°±æ˜¯æˆ‘ä»¬åˆšåˆšå®šä¹‰çš„å¯åŠ¨å®‰è£…Apk activityçš„intent filterï¼Ÿå¥½å§ï¼Œæ‰€ä»¥è¯´ä¸€å¼€å§‹æˆ‘ä»¬è°ƒç”¨çš„startActivityå…¶å®å¯åŠ¨çš„å°±æ˜¯PackageInstallerActivityï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸€ä¸‹PackageInstellerActivityçš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134@Override protected void onCreate(Bundle icicle) { super.onCreate(icicle); mPm = getPackageManager(); mInstaller = mPm.getPackageInstaller(); mUserManager = (UserManager) getSystemService(Context.USER_SERVICE); final Intent intent = getIntent(); if (PackageInstaller.ACTION_CONFIRM_PERMISSIONS.equals(intent.getAction())) { final int sessionId = intent.getIntExtra(PackageInstaller.EXTRA_SESSION_ID, -1); final PackageInstaller.SessionInfo info = mInstaller.getSessionInfo(sessionId); if (info == null || !info.sealed || info.resolvedBaseCodePath == null) { Log.w(TAG, &quot;Session &quot; + mSessionId + &quot; in funky state; ignoring&quot;); finish(); return; } mSessionId = sessionId; mPackageURI = Uri.fromFile(new File(info.resolvedBaseCodePath)); mOriginatingURI = null; mReferrerURI = null; } else { mSessionId = -1; mPackageURI = intent.getData(); mOriginatingURI = intent.getParcelableExtra(Intent.EXTRA_ORIGINATING_URI); mReferrerURI = intent.getParcelableExtra(Intent.EXTRA_REFERRER); } final boolean unknownSourcesAllowedByAdmin = isUnknownSourcesAllowedByAdmin(); final boolean unknownSourcesAllowedByUser = isUnknownSourcesEnabled(); boolean requestFromUnknownSource = isInstallRequestFromUnknownSource(intent); mInstallFlowAnalytics = new InstallFlowAnalytics(); mInstallFlowAnalytics.setContext(this); mInstallFlowAnalytics.setStartTimestampMillis(SystemClock.elapsedRealtime()); mInstallFlowAnalytics.setInstallsFromUnknownSourcesPermitted(unknownSourcesAllowedByAdmin &amp;&amp; unknownSourcesAllowedByUser); mInstallFlowAnalytics.setInstallRequestFromUnknownSource(requestFromUnknownSource); mInstallFlowAnalytics.setVerifyAppsEnabled(isVerifyAppsEnabled()); mInstallFlowAnalytics.setAppVerifierInstalled(isAppVerifierInstalled()); mInstallFlowAnalytics.setPackageUri(mPackageURI.toString()); if (DeviceUtils.isWear(this)) { showDialogInner(DLG_NOT_SUPPORTED_ON_WEAR); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_NOT_ALLOWED_ON_WEAR); return; } final String scheme = mPackageURI.getScheme(); if (scheme != null &amp;&amp; !&quot;file&quot;.equals(scheme) &amp;&amp; !&quot;package&quot;.equals(scheme)) { Log.w(TAG, &quot;Unsupported scheme &quot; + scheme); setPmResult(PackageManager.INSTALL_FAILED_INVALID_URI); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_FAILED_UNSUPPORTED_SCHEME); finish(); return; } final PackageUtil.AppSnippet as; if (&quot;package&quot;.equals(mPackageURI.getScheme())) { mInstallFlowAnalytics.setFileUri(false); try { mPkgInfo = mPm.getPackageInfo(mPackageURI.getSchemeSpecificPart(), PackageManager.GET_PERMISSIONS | PackageManager.GET_UNINSTALLED_PACKAGES); } catch (NameNotFoundException e) { } if (mPkgInfo == null) { Log.w(TAG, &quot;Requested package &quot; + mPackageURI.getScheme() + &quot; not available. Discontinuing installation&quot;); showDialogInner(DLG_PACKAGE_ERROR); setPmResult(PackageManager.INSTALL_FAILED_INVALID_APK); mInstallFlowAnalytics.setPackageInfoObtained(); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_FAILED_PACKAGE_MISSING); return; } as = new PackageUtil.AppSnippet(mPm.getApplicationLabel(mPkgInfo.applicationInfo), mPm.getApplicationIcon(mPkgInfo.applicationInfo)); } else { mInstallFlowAnalytics.setFileUri(true); final File sourceFile = new File(mPackageURI.getPath()); PackageParser.Package parsed = PackageUtil.getPackageInfo(sourceFile); // Check for parse errors if (parsed == null) { Log.w(TAG, &quot;Parse error when parsing manifest. Discontinuing installation&quot;); showDialogInner(DLG_PACKAGE_ERROR); setPmResult(PackageManager.INSTALL_FAILED_INVALID_APK); mInstallFlowAnalytics.setPackageInfoObtained(); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_FAILED_TO_GET_PACKAGE_INFO); return; } mPkgInfo = PackageParser.generatePackageInfo(parsed, null, PackageManager.GET_PERMISSIONS, 0, 0, null, new PackageUserState()); mPkgDigest = parsed.manifestDigest; as = PackageUtil.getAppSnippet(this, mPkgInfo.applicationInfo, sourceFile); } mInstallFlowAnalytics.setPackageInfoObtained(); //set view setContentView(R.layout.install_start); mInstallConfirm = findViewById(R.id.install_confirm_panel); mInstallConfirm.setVisibility(View.INVISIBLE); PackageUtil.initSnippetForNewApp(this, as, R.id.app_snippet); mOriginatingUid = getOriginatingUid(intent); // Block the install attempt on the Unknown Sources setting if necessary. if (!requestFromUnknownSource) { initiateInstall(); return; } // If the admin prohibits it, or we're running in a managed profile, just show error // and exit. Otherwise show an option to take the user to Settings to change the setting. final boolean isManagedProfile = mUserManager.isManagedProfile(); if (!unknownSourcesAllowedByAdmin || (!unknownSourcesAllowedByUser &amp;&amp; isManagedProfile)) { showDialogInner(DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_BLOCKED_BY_UNKNOWN_SOURCES_SETTING); } else if (!unknownSourcesAllowedByUser) { // Ask user to enable setting first showDialogInner(DLG_UNKNOWN_SOURCES); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_BLOCKED_BY_UNKNOWN_SOURCES_SETTING); } else { initiateInstall(); } } è¿™é‡Œæˆ‘ä»¬ä¸»è¦å…ˆçœ‹ä¸€ä¸‹PackageInstallerActivityçš„onCreateæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134@Override protected void onCreate(Bundle icicle) { super.onCreate(icicle); mPm = getPackageManager(); mInstaller = mPm.getPackageInstaller(); mUserManager = (UserManager) getSystemService(Context.USER_SERVICE); final Intent intent = getIntent(); if (PackageInstaller.ACTION_CONFIRM_PERMISSIONS.equals(intent.getAction())) { final int sessionId = intent.getIntExtra(PackageInstaller.EXTRA_SESSION_ID, -1); final PackageInstaller.SessionInfo info = mInstaller.getSessionInfo(sessionId); if (info == null || !info.sealed || info.resolvedBaseCodePath == null) { Log.w(TAG, &quot;Session &quot; + mSessionId + &quot; in funky state; ignoring&quot;); finish(); return; } mSessionId = sessionId; mPackageURI = Uri.fromFile(new File(info.resolvedBaseCodePath)); mOriginatingURI = null; mReferrerURI = null; } else { mSessionId = -1; mPackageURI = intent.getData(); mOriginatingURI = intent.getParcelableExtra(Intent.EXTRA_ORIGINATING_URI); mReferrerURI = intent.getParcelableExtra(Intent.EXTRA_REFERRER); } final boolean unknownSourcesAllowedByAdmin = isUnknownSourcesAllowedByAdmin(); final boolean unknownSourcesAllowedByUser = isUnknownSourcesEnabled(); boolean requestFromUnknownSource = isInstallRequestFromUnknownSource(intent); mInstallFlowAnalytics = new InstallFlowAnalytics(); mInstallFlowAnalytics.setContext(this); mInstallFlowAnalytics.setStartTimestampMillis(SystemClock.elapsedRealtime()); mInstallFlowAnalytics.setInstallsFromUnknownSourcesPermitted(unknownSourcesAllowedByAdmin &amp;&amp; unknownSourcesAllowedByUser); mInstallFlowAnalytics.setInstallRequestFromUnknownSource(requestFromUnknownSource); mInstallFlowAnalytics.setVerifyAppsEnabled(isVerifyAppsEnabled()); mInstallFlowAnalytics.setAppVerifierInstalled(isAppVerifierInstalled()); mInstallFlowAnalytics.setPackageUri(mPackageURI.toString()); if (DeviceUtils.isWear(this)) { showDialogInner(DLG_NOT_SUPPORTED_ON_WEAR); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_NOT_ALLOWED_ON_WEAR); return; } final String scheme = mPackageURI.getScheme(); if (scheme != null &amp;&amp; !&quot;file&quot;.equals(scheme) &amp;&amp; !&quot;package&quot;.equals(scheme)) { Log.w(TAG, &quot;Unsupported scheme &quot; + scheme); setPmResult(PackageManager.INSTALL_FAILED_INVALID_URI); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_FAILED_UNSUPPORTED_SCHEME); finish(); return; } final PackageUtil.AppSnippet as; if (&quot;package&quot;.equals(mPackageURI.getScheme())) { mInstallFlowAnalytics.setFileUri(false); try { mPkgInfo = mPm.getPackageInfo(mPackageURI.getSchemeSpecificPart(), PackageManager.GET_PERMISSIONS | PackageManager.GET_UNINSTALLED_PACKAGES); } catch (NameNotFoundException e) { } if (mPkgInfo == null) { Log.w(TAG, &quot;Requested package &quot; + mPackageURI.getScheme() + &quot; not available. Discontinuing installation&quot;); showDialogInner(DLG_PACKAGE_ERROR); setPmResult(PackageManager.INSTALL_FAILED_INVALID_APK); mInstallFlowAnalytics.setPackageInfoObtained(); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_FAILED_PACKAGE_MISSING); return; } as = new PackageUtil.AppSnippet(mPm.getApplicationLabel(mPkgInfo.applicationInfo), mPm.getApplicationIcon(mPkgInfo.applicationInfo)); } else { mInstallFlowAnalytics.setFileUri(true); final File sourceFile = new File(mPackageURI.getPath()); PackageParser.Package parsed = PackageUtil.getPackageInfo(sourceFile); // Check for parse errors if (parsed == null) { Log.w(TAG, &quot;Parse error when parsing manifest. Discontinuing installation&quot;); showDialogInner(DLG_PACKAGE_ERROR); setPmResult(PackageManager.INSTALL_FAILED_INVALID_APK); mInstallFlowAnalytics.setPackageInfoObtained(); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_FAILED_TO_GET_PACKAGE_INFO); return; } mPkgInfo = PackageParser.generatePackageInfo(parsed, null, PackageManager.GET_PERMISSIONS, 0, 0, null, new PackageUserState()); mPkgDigest = parsed.manifestDigest; as = PackageUtil.getAppSnippet(this, mPkgInfo.applicationInfo, sourceFile); } mInstallFlowAnalytics.setPackageInfoObtained(); //set view setContentView(R.layout.install_start); mInstallConfirm = findViewById(R.id.install_confirm_panel); mInstallConfirm.setVisibility(View.INVISIBLE); PackageUtil.initSnippetForNewApp(this, as, R.id.app_snippet); mOriginatingUid = getOriginatingUid(intent); // Block the install attempt on the Unknown Sources setting if necessary. if (!requestFromUnknownSource) { initiateInstall(); return; } // If the admin prohibits it, or we're running in a managed profile, just show error // and exit. Otherwise show an option to take the user to Settings to change the setting. final boolean isManagedProfile = mUserManager.isManagedProfile(); if (!unknownSourcesAllowedByAdmin || (!unknownSourcesAllowedByUser &amp;&amp; isManagedProfile)) { showDialogInner(DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_BLOCKED_BY_UNKNOWN_SOURCES_SETTING); } else if (!unknownSourcesAllowedByUser) { // Ask user to enable setting first showDialogInner(DLG_UNKNOWN_SOURCES); mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_BLOCKED_BY_UNKNOWN_SOURCES_SETTING); } else { initiateInstall(); } } å¯ä»¥å‘ç°ï¼Œåœ¨onCreateæ–¹æ³•ä¸­ï¼Œé¦–å…ˆæ‰§è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œè·å–PackageManagerå’ŒInstallerã€UserManagerç­‰å¯¹è±¡ï¼Œç„¶åä¼šæ ¹æ®å½“å‰Intentçš„ä¿¡æ¯æœ€ä¸€äº›é€»è¾‘åˆ¤æ–­å¹¶å¼¹å‡ºæ¶ˆæ¯å¼¹çª—ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“çš„æ¶ˆæ¯å¼¹çª—ç±»å‹ï¼š 12345678private static final int DLG_BASE = 0; private static final int DLG_UNKNOWN_SOURCES = DLG_BASE + 1; private static final int DLG_PACKAGE_ERROR = DLG_BASE + 2; private static final int DLG_OUT_OF_SPACE = DLG_BASE + 3; private static final int DLG_INSTALL_ERROR = DLG_BASE + 4; private static final int DLG_ALLOW_SOURCE = DLG_BASE + 5; private static final int DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES = DLG_BASE + 6; private static final int DLG_NOT_SUPPORTED_ON_WEAR = DLG_BASE + 7; å¯ä»¥å‘ç°å½“åˆ†æIntentå¯¹è±¡çš„æ—¶å€™ï¼Œå¦‚æœå¯ä»¥å¾—åˆ°è¿™æ ·å‡ ç§ç»“æœï¼šä¸çŸ¥é“apkçš„æ¥æºï¼Œpackageä¿¡æ¯é”™è¯¯ï¼Œå­˜å‚¨ç©ºé—´ä¸å¤Ÿï¼Œå®‰è£…æ—¶æŠ¥ï¼Œæ¥æºæ­£ç¡®ï¼Œå…è®¸æœªçŸ¥æ¥æºçš„apkæ–‡ä»¶ï¼Œåœ¨wearä¸Šä¸æ”¯æŒç­‰ï¼Œè¿™æ ·æ ¹æ®ä¸åŒçš„æ¶ˆæ¯ç±»å‹ä¼šå¼¹å‡ºä¸åŒçš„æ¶ˆæ¯å¼¹çª—ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119@Override public Dialog onCreateDialog(int id, Bundle bundle) { switch (id) { case DLG_UNKNOWN_SOURCES: return new AlertDialog.Builder(this) .setTitle(R.string.unknown_apps_dlg_title) .setMessage(R.string.unknown_apps_dlg_text) .setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { Log.i(TAG, &quot;Finishing off activity so that user can navigate to settings manually&quot;); finish(); }}) .setPositiveButton(R.string.settings, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { Log.i(TAG, &quot;Launching settings&quot;); launchSecuritySettings(); } }) .setOnCancelListener(this) .create(); case DLG_ADMIN_RESTRICTS_UNKNOWN_SOURCES: return new AlertDialog.Builder(this) .setTitle(R.string.unknown_apps_dlg_title) .setMessage(R.string.unknown_apps_admin_dlg_text) .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { finish(); } }) .setOnCancelListener(this) .create(); case DLG_PACKAGE_ERROR : return new AlertDialog.Builder(this) .setTitle(R.string.Parse_error_dlg_title) .setMessage(R.string.Parse_error_dlg_text) .setPositiveButton(R.string.ok, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { finish(); } }) .setOnCancelListener(this) .create(); case DLG_OUT_OF_SPACE: // Guaranteed not to be null. will default to package name if not set by app CharSequence appTitle = mPm.getApplicationLabel(mPkgInfo.applicationInfo); String dlgText = getString(R.string.out_of_space_dlg_text, appTitle.toString()); return new AlertDialog.Builder(this) .setTitle(R.string.out_of_space_dlg_title) .setMessage(dlgText) .setPositiveButton(R.string.manage_applications, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { //launch manage applications Intent intent = new Intent(&quot;android.intent.action.MANAGE_PACKAGE_STORAGE&quot;); intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK); startActivity(intent); finish(); } }) .setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { Log.i(TAG, &quot;Canceling installation&quot;); finish(); } }) .setOnCancelListener(this) .create(); case DLG_INSTALL_ERROR : // Guaranteed not to be null. will default to package name if not set by app CharSequence appTitle1 = mPm.getApplicationLabel(mPkgInfo.applicationInfo); String dlgText1 = getString(R.string.install_failed_msg, appTitle1.toString()); return new AlertDialog.Builder(this) .setTitle(R.string.install_failed) .setNeutralButton(R.string.ok, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { finish(); } }) .setMessage(dlgText1) .setOnCancelListener(this) .create(); case DLG_ALLOW_SOURCE: CharSequence appTitle2 = mPm.getApplicationLabel(mSourceInfo); String dlgText2 = getString(R.string.allow_source_dlg_text, appTitle2.toString()); return new AlertDialog.Builder(this) .setTitle(R.string.allow_source_dlg_title) .setMessage(dlgText2) .setNegativeButton(R.string.cancel, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { setResult(RESULT_CANCELED); finish(); }}) .setPositiveButton(R.string.ok, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { SharedPreferences prefs = getSharedPreferences(PREFS_ALLOWED_SOURCES, Context.MODE_PRIVATE); prefs.edit().putBoolean(mSourceInfo.packageName, true).apply(); startInstallConfirm(); } }) .setOnCancelListener(this) .create(); case DLG_NOT_SUPPORTED_ON_WEAR: return new AlertDialog.Builder(this) .setTitle(R.string.wear_not_allowed_dlg_title) .setMessage(R.string.wear_not_allowed_dlg_text) .setPositiveButton(R.string.ok, new DialogInterface.OnClickListener() { public void onClick(DialogInterface dialog, int which) { setResult(RESULT_OK); finish(); } }) .setOnCancelListener(this) .create(); } return null; } æ¶ˆæ¯å¼¹çª—çš„ä¸»è¦ä½œç”¨ï¼Œç”¨äºæç¤ºç”¨æˆ·å½“å‰å®‰è£…apkæ–‡ä»¶çš„ç‰¹æ€§ã€‚éƒ½çŸ¥é“androidç³»ç»Ÿåœ¨android apkæ–‡ä»¶ä¹‹å‰ä¼šè§£æå™¨manifestæ–‡ä»¶ï¼Œè¿™ä¸ªæ“ä½œä¹Ÿæ˜¯æ—©onCreateæ–¹æ³•ä¸­æ‰§è¡Œçš„ï¼š 1PackageParser.Package parsed = PackageUtil.getPackageInfo(sourceFile); æˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹getPackageInfoæ–¹æ³•çš„å®ç°ï¼š 12345678910public static PackageParser.Package getPackageInfo(File sourceFile) { final PackageParser parser = new PackageParser(); try { PackageParser.Package pkg = parser.parseMonolithicPackage(sourceFile, 0); parser.collectManifestDigest(pkg); return pkg; } catch (PackageParserException e) { return null; } } å¥½å§ï¼Œåˆ°äº†è¿™é‡Œæ˜¯ä¸æ˜¯ä»£ç å˜å¾—å¾ˆç†Ÿæ‚‰äº†ï¼ŸparseMonolithicPackageå°±æ˜¯æˆ‘ä»¬ä¸Šä¸€èŠ‚åˆ†æçš„androidç³»ç»Ÿè§£æmanifestæ–‡ä»¶çš„è¿‡ç¨‹ï¼Œå…·ä½“çš„å¯å‚è€ƒï¼šhttp://blog.csdn.net/qq_23547831/article/details/51203482 è€ŒcollectManifestDigestæ–¹æ³•ï¼Œæˆ‘ä»¬è¿™é‡Œç®€å•çš„ä»‹ç»ä¸€ä¸‹ï¼Œå…¶ä¸»è¦æ˜¯è¦äº‰apkçš„ç­¾åæ˜¯å¦æ­£ç¡®ã€‚å¥½å§é€šè¿‡è¿™ä¸¤éƒ¨æˆ‘ä»¬å°±æŠŠapkæ–‡ä»¶çš„manifestå’Œç­¾åä¿¡æ¯éƒ½è§£æå®Œæˆå¹¶ä¿å­˜åœ¨äº†Packageä¸­ã€‚ æ¥ç€å¾€ä¸‹èµ°ï¼Œåœ¨æ‰€æœ‰çš„è§£æå®Œæˆä¹‹åæˆ‘ä»¬ä¼šåœ¨onCreateæ–¹æ³•ä¸­æ‰§è¡ŒinitiateInstall();æ–¹æ³•ï¼Œåˆšæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯åˆå§‹åŒ–å®‰è£…ã€‚ 123456789101112131415161718192021222324252627282930313233343536private void initiateInstall() { String pkgName = mPkgInfo.packageName; // Check if there is already a package on the device with this name // but it has been renamed to something else. String[] oldName = mPm.canonicalToCurrentPackageNames(new String[] { pkgName }); if (oldName != null &amp;&amp; oldName.length &gt; 0 &amp;&amp; oldName[0] != null) { pkgName = oldName[0]; mPkgInfo.packageName = pkgName; mPkgInfo.applicationInfo.packageName = pkgName; } // Check if package is already installed. display confirmation dialog if replacing pkg try { // This is a little convoluted because we want to get all uninstalled // apps, but this may include apps with just data, and if it is just // data we still want to count it as &quot;installed&quot;. mAppInfo = mPm.getApplicationInfo(pkgName, PackageManager.GET_UNINSTALLED_PACKAGES); if ((mAppInfo.flags&amp;ApplicationInfo.FLAG_INSTALLED) == 0) { mAppInfo = null; } } catch (NameNotFoundException e) { mAppInfo = null; } mInstallFlowAnalytics.setReplace(mAppInfo != null); mInstallFlowAnalytics.setSystemApp( (mAppInfo != null) &amp;&amp; ((mAppInfo.flags &amp; ApplicationInfo.FLAG_SYSTEM) != 0)); // If we have a session id, we're invoked to verify the permissions for the given // package. Otherwise, we start the install process. if (mSessionId != -1) { startInstallConfirm(); } else { startInstall(); } } å¥½å§ï¼Œè¿™é‡Œé¢æœ‰è°ƒç”¨äº†startInstallConfirmæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹startInstallConfirmæ–¹æ³•çš„å®ç°: 12345private void startInstallConfirm() { ... //åˆå§‹åŒ–å®‰è£…ç¡®è®¤ç•Œé¢ ...} å¥½å§ï¼Œè¿™ä¸ªæ–¹æ³•çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œä¸»è¦çš„å®ç°é€»è¾‘å°±æ˜¯ç°å®è¯¥activityçš„ç”¨æˆ·ç•Œé¢ï¼Œå¹³æ—¶æˆ‘ä»¬å®‰è£…æŸä¸€ä¸ªåº”ç”¨çš„æ—¶å€™ä¼šå¼¹å‡ºä¸€ä¸ªå®‰è£…ç¡®è®¤é¡µé¢ï¼Œè¿˜æœ‰ä¸€ä¸ªç¡®è®¤å’Œå–æ¶ˆæŒ‰é’®ï¼Œæœ‰å°è±¡ä¹ˆï¼Ÿå…¶å®å°±æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œçš„ç•Œé¢åˆå§‹åŒ–æ“ä½œã€‚ å¥½å§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åœ¨apkå®‰è£…ç¡®è®¤é¡µé¢ï¼Œæˆ‘ä»¬ä¼šç‚¹å‡»ç¡®è®¤æŒ‰é’®æ‰§è¡Œå®‰è£…é€»è¾‘å§ï¼Ÿé‚£ä¹ˆè¿™é‡Œæˆ‘ä»¬æ‰¾ä¸€ä¸‹ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ï¼š 1234567891011121314151617181920212223242526272829public void onClick(View v) { if (v == mOk) { if (mOkCanInstall || mScrollView == null) { mInstallFlowAnalytics.setInstallButtonClicked(); if (mSessionId != -1) { mInstaller.setPermissionsResult(mSessionId, true); // We're only confirming permissions, so we don't really know how the // story ends; assume success. mInstallFlowAnalytics.setFlowFinishedWithPackageManagerResult( PackageManager.INSTALL_SUCCEEDED); finish(); } else { startInstall(); } } else { mScrollView.pageScroll(View.FOCUS_DOWN); } } else if (v == mCancel) { // Cancel and finish setResult(RESULT_CANCELED); if (mSessionId != -1) { mInstaller.setPermissionsResult(mSessionId, false); } mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_CANCELLED_BY_USER); finish(); } } å¾ˆæ˜æ˜¾äº†ï¼Œè¿™é‡Œå½“æˆ‘ä»¬ç‚¹å‡»ç¡®è®¤æŒ‰é’®çš„æ—¶å€™ä¼šæ‰§è¡ŒstartInstallæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¼€å§‹æ‰§è¡Œå®‰è£…é€»è¾‘ï¼š 123456789101112131415161718192021222324252627282930313233private void startInstall() { // Start subactivity to actually install the application Intent newIntent = new Intent(); newIntent.putExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO, mPkgInfo.applicationInfo); newIntent.setData(mPackageURI); newIntent.setClass(this, InstallAppProgress.class); newIntent.putExtra(InstallAppProgress.EXTRA_MANIFEST_DIGEST, mPkgDigest); newIntent.putExtra( InstallAppProgress.EXTRA_INSTALL_FLOW_ANALYTICS, mInstallFlowAnalytics); String installerPackageName = getIntent().getStringExtra( Intent.EXTRA_INSTALLER_PACKAGE_NAME); if (mOriginatingURI != null) { newIntent.putExtra(Intent.EXTRA_ORIGINATING_URI, mOriginatingURI); } if (mReferrerURI != null) { newIntent.putExtra(Intent.EXTRA_REFERRER, mReferrerURI); } if (mOriginatingUid != VerificationParams.NO_UID) { newIntent.putExtra(Intent.EXTRA_ORIGINATING_UID, mOriginatingUid); } if (installerPackageName != null) { newIntent.putExtra(Intent.EXTRA_INSTALLER_PACKAGE_NAME, installerPackageName); } if (getIntent().getBooleanExtra(Intent.EXTRA_RETURN_RESULT, false)) { newIntent.putExtra(Intent.EXTRA_RETURN_RESULT, true); newIntent.addFlags(Intent.FLAG_ACTIVITY_FORWARD_RESULT); } if(localLOGV) Log.i(TAG, &quot;downloaded app uri=&quot;+mPackageURI); startActivity(newIntent); finish(); } å¯ä»¥å‘ç°ï¼Œç‚¹å‡»ç¡®è®¤æŒ‰é’®ä¹‹åæˆ‘ä»¬è°ƒç”¨å¯ç”¨äº†ä¸€ä¸ªæ–°çš„Activityâ€“&gt;InstallAppProgressï¼Œè¿™ä¸ªActivityä¸»è¦ç”¨äºæ‰§è¡Œapkçš„å®‰è£…é€»è¾‘äº†ã€‚ 123456789101112131415161718192021222324252627@Override public void onCreate(Bundle icicle) { super.onCreate(icicle); Intent intent = getIntent(); mAppInfo = intent.getParcelableExtra(PackageUtil.INTENT_ATTR_APPLICATION_INFO); mInstallFlowAnalytics = intent.getParcelableExtra(EXTRA_INSTALL_FLOW_ANALYTICS); mInstallFlowAnalytics.setContext(this); mPackageURI = intent.getData(); final String scheme = mPackageURI.getScheme(); if (scheme != null &amp;&amp; !&quot;file&quot;.equals(scheme) &amp;&amp; !&quot;package&quot;.equals(scheme)) { mInstallFlowAnalytics.setFlowFinished( InstallFlowAnalytics.RESULT_FAILED_UNSUPPORTED_SCHEME); throw new IllegalArgumentException(&quot;unexpected scheme &quot; + scheme); } mInstallThread = new HandlerThread(&quot;InstallThread&quot;); mInstallThread.start(); mInstallHandler = new Handler(mInstallThread.getLooper()); IntentFilter intentFilter = new IntentFilter(); intentFilter.addAction(BROADCAST_ACTION); registerReceiver( mBroadcastReceiver, intentFilter, BROADCAST_SENDER_PERMISSION, null /*scheduler*/); initView(); } å¯ä»¥å‘ç°InstallAppProcessè¿™ä¸ªActivityçš„onCreateæ–¹æ³•ä¸­ä¸»è¦åˆå§‹åŒ–äº†ä¸€äº›æˆå‘˜å˜é‡ï¼Œå¹¶è°ƒç”¨initViewæ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨iniTViewæ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼š 12345678910void initView() { ... mInstallHandler.post(new Runnable() { @Override public void run() { doPackageStage(pm, params); } }); ...} ç»è¿‡ä¸€äº›viewçš„åˆå§‹åŒ–æ“ä½œä¹‹åè°ƒç”¨äº†doPackageStageæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸»è¦æ˜¯é€šè¿‡è°ƒç”¨PackageInstalleræ‰§è¡Œapkæ–‡ä»¶çš„å®‰è£…ï¼Œè¿™é‡Œå°±ä¸åœ¨è¯¦ç»†çš„ä»‹ç»äº†ï¼Œåœ¨apkæ–‡ä»¶å®‰è£…å®Œæˆä¹‹åPackageInstallerä¼šå‘é€ä¸€ä¸ªå®‰è£…å®Œæˆçš„å¹¿æ’­ï¼Œåˆšåˆšæˆ‘ä»¬åœ¨onCreateæ–¹æ³•ä¸­æ³¨å†Œäº†ä¸€ä¸ªå¹¿æ’­æ¥æ”¶å™¨ï¼Œå…¶å¯ä»¥ç”¨æ¥æ¥æ”¶apkå®‰è£…å®Œæˆçš„å¹¿æ’­ï¼š 123456789101112private final BroadcastReceiver mBroadcastReceiver = new BroadcastReceiver() { @Override public void onReceive(Context context, Intent intent) { final int statusCode = intent.getIntExtra( PackageInstaller.EXTRA_STATUS, PackageInstaller.STATUS_FAILURE); if (statusCode == PackageInstaller.STATUS_PENDING_USER_ACTION) { context.startActivity((Intent)intent.getParcelableExtra(Intent.EXTRA_INTENT)); } else { onPackageInstalled(statusCode); } } }; è¿™æ ·apkå®‰è£…å®Œæˆä¹‹åï¼Œè¿™é‡Œçš„å¹¿æ’­æ¥æ”¶å™¨ä¼šæ¥æ”¶åˆ°å¹¿æ’­å¹¶æ‰§è¡ŒonPackageInstalledæ–¹æ³•ï¼Œæ‰§è¡Œåç»­çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹onPackageInstalledæ–¹æ³•çš„å…·ä½“å®ç°é€»è¾‘ï¼š 12345void onPackageInstalled(int statusCode) { Message msg = mHandler.obtainMessage(INSTALL_COMPLETE); msg.arg1 = statusCode; mHandler.sendMessage(msg); } å¥½å§ï¼Œè¿™é‡Œæ˜¯å‘é€Handlerå¼‚æ­¥æ¶ˆæ¯ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¼‚æ­¥æ¶ˆæ¯çš„å¤„ç†é€»è¾‘ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273private Handler mHandler = new Handler() { public void handleMessage(Message msg) { switch (msg.what) { case INSTALL_COMPLETE: mInstallFlowAnalytics.setFlowFinishedWithPackageManagerResult(msg.arg1); if (getIntent().getBooleanExtra(Intent.EXTRA_RETURN_RESULT, false)) { Intent result = new Intent(); result.putExtra(Intent.EXTRA_INSTALL_RESULT, msg.arg1); setResult(msg.arg1 == PackageInstaller.STATUS_SUCCESS ? Activity.RESULT_OK : Activity.RESULT_FIRST_USER, result); finish(); return; } // Update the status text mProgressBar.setVisibility(View.INVISIBLE); // Show the ok button int centerTextLabel; int centerExplanationLabel = -1; LevelListDrawable centerTextDrawable = (LevelListDrawable) getDrawable(R.drawable.ic_result_status); if (msg.arg1 == PackageInstaller.STATUS_SUCCESS) { mLaunchButton.setVisibility(View.VISIBLE); centerTextDrawable.setLevel(0); centerTextLabel = R.string.install_done; // Enable or disable launch button mLaunchIntent = getPackageManager().getLaunchIntentForPackage( mAppInfo.packageName); boolean enabled = false; if(mLaunchIntent != null) { List&lt;ResolveInfo&gt; list = getPackageManager(). queryIntentActivities(mLaunchIntent, 0); if (list != null &amp;&amp; list.size() &gt; 0) { enabled = true; } } if (enabled) { mLaunchButton.setOnClickListener(InstallAppProgress.this); } else { mLaunchButton.setEnabled(false); } } else if (msg.arg1 == PackageInstaller.STATUS_FAILURE_STORAGE){ showDialogInner(DLG_OUT_OF_SPACE); return; } else { // Generic error handling for all other error codes. centerTextDrawable.setLevel(1); centerExplanationLabel = getExplanationFromErrorCode(msg.arg1); centerTextLabel = R.string.install_failed; mLaunchButton.setVisibility(View.INVISIBLE); } if (centerTextDrawable != null) { centerTextDrawable.setBounds(0, 0, centerTextDrawable.getIntrinsicWidth(), centerTextDrawable.getIntrinsicHeight()); mStatusTextView.setCompoundDrawablesRelative(centerTextDrawable, null, null, null); } mStatusTextView.setText(centerTextLabel); if (centerExplanationLabel != -1) { mExplanationTextView.setText(centerExplanationLabel); mExplanationTextView.setVisibility(View.VISIBLE); } else { mExplanationTextView.setVisibility(View.GONE); } mDoneButton.setOnClickListener(InstallAppProgress.this); mOkPanel.setVisibility(View.VISIBLE); break; default: break; } } }; å¯ä»¥å‘ç°ï¼Œå½“apkå®‰è£…å®Œæˆä¹‹åï¼Œæˆ‘ä»¬ä¼šæ›´æ–°UIï¼Œæ˜¾ç¤ºå®Œæˆå’Œæ‰“å¼€æŒ‰é’®ï¼Œæ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬å¹³æ—¶å®‰è£…apkçš„é€»è¾‘å¯¹åº”ä¸Šäº†ï¼Ÿè¿™æ—¶å€™æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶ã€‚ 1234567891011public void onClick(View v) { if(v == mDoneButton) { if (mAppInfo.packageName != null) { Log.i(TAG, &quot;Finished installing &quot;+mAppInfo.packageName); } finish(); } else if(v == mLaunchButton) { startActivity(mLaunchIntent); finish(); } } å¥½å§ï¼Œæ¯”è¾ƒç®€å•ï¼Œç‚¹å‡»å®ŒæˆæŒ‰é’®ï¼Œç›´æ¥finishæ‰è¿™ä¸ªactivityï¼Œç‚¹å‡»æ‰“å¼€ï¼Œåˆ™ç›´æ¥è°ƒç”¨startActivityå¯åŠ¨å®‰è£…çš„åº”ç”¨ï¼Œç„¶åç›´æ¥finishè‡ªèº«ã€‚ æ€»ç»“ï¼š ä»£ç ä¸­æ‰§è¡Œintent.setDataAndType(Uri.parse(â€œfile://â€œ + path),â€application/vnd.android.package-archiveâ€);å¯ä»¥è°ƒèµ·PackageInstallerActivityï¼› PackageInstallerActivityä¸»è¦ç”¨äºæ‰§è¡Œè§£æapkæ–‡ä»¶ï¼Œè§£æmanifestï¼Œè§£æç­¾åç­‰æ“ä½œï¼› InstallAppProcessä¸»è¦ç”¨äºæ‰§è¡Œå®‰è£…apké€»è¾‘ï¼Œç”¨äºåˆå§‹åŒ–å®‰è£…ç•Œé¢ï¼Œç”¨äºåˆå§‹åŒ–ç”¨æˆ·UIã€‚å¹¶è°ƒç”¨PackageInstalleræ‰§è¡Œå®‰è£…é€»è¾‘ï¼› InstallAppProcesså†…æ³¨å†Œæœ‰å¹¿æ’­ï¼Œå½“å®‰è£…å®Œæˆä¹‹åæ¥æ”¶å¹¿æ’­ï¼Œæ›´æ–°UIã€‚æ˜¾ç¤ºapkå®‰è£…å®Œæˆç•Œé¢ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹","link":"/2020/09/11/apk%E5%AE%89%E8%A3%85%E6%B5%81%E7%A8%8B/"},{"title":"18 Activityå¸ƒå±€ç»˜åˆ¶æµç¨‹","text":"è¿™ç¯‡æ–‡ç« æ˜¯æ‰¿æ¥ä¸Šä¸€ç¯‡æ–‡ç« (Androidå¸ƒå±€åŠ è½½æµç¨‹ï¼šandroidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹)æ¥å†™çš„ï¼Œå¤§å®¶éƒ½çŸ¥é“Activityåœ¨Androidä½“ç³»ä¸­æ‰®æ¼”è€…ä¸€ä¸ªç•Œé¢å±•ç¤ºçš„è§’è‰²ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“Activityæ˜¯é€šè¿‡Windowæ¥æ§åˆ¶ç•Œé¢çš„å±•ç¤ºçš„ï¼Œä¸€ä¸ªWindowå¯¹è±¡å°±æ˜¯ä¸€ä¸ªçª—å£å¯¹è±¡ï¼Œè€Œæ¯ä¸ªActivityä¸­éƒ½æœ‰ä¸€ä¸ªç›¸åº”çš„Windowå¯¹è±¡ï¼Œæ‰€ä»¥è¯´ä¸€ä¸ªActivityå¯¹è±¡ä¹Ÿå°±å¯ä»¥è¯´æ˜¯ä¸€ä¸ªçª—å£å¯¹è±¡ï¼Œè€ŒWindowåªæ˜¯æ§åˆ¶ç€ç•Œé¢å¸ƒå±€æ–‡ä»¶çš„åŠ è½½è¿‡ç¨‹ï¼Œé‚£ä¹ˆç•Œé¢å¸ƒå±€æ–‡ä»¶çš„ç»˜åˆ¶æµç¨‹æ˜¯å¦‚ä½•çš„å‘¢ï¼Ÿè¿™ç¯‡æ–‡ç« ä¸»è¦å°±æ˜¯é¡ºç€ä¸Šç¯‡æ–‡ç« çš„æ€è·¯ï¼Œçœ‹ä¸€ä¸‹åœ¨androidç³»ç»Ÿä¸­Activityçš„å¸ƒå±€æ–‡ä»¶æ˜¯å¦‚ä½•ç»˜åˆ¶çš„ã€‚ é¡ºä¾¿åœ¨è¿™é‡Œå¤šè¯´å‡ å¥ï¼Œandroidä¸­æ‰€æœ‰èƒ½æ˜¾ç¤ºçš„ä¸œè¥¿éƒ½æ˜¯é€šè¿‡Windowå¯¹è±¡å®ç°äº†ï¼Œæ— è®ºActivityï¼ŒDialogï¼ŒPopupWindowï¼ŒToastç­‰ã€‚åæœŸæˆ‘å¯èƒ½ä¹Ÿä¼šè®²ä¸€ä¸‹Dialogï¼ŒPopupWindowï¼ŒToastç­‰ç»„ä»¶çš„æ˜¾ç¤ºè¿‡ç¨‹ã€‚ å‰é¢æœ‰ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä»‹ç»è¿‡Activityçš„å¯åŠ¨æµç¨‹ï¼Œå¯å‚è€ƒï¼šandroidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹åœ¨æ‰§è¡ŒActivityThreadçš„handleLauncherActivityæ–¹æ³•ä¸­é€šè¿‡Windowå¯¹è±¡æ§åˆ¶äº†å¸ƒå±€æ–‡ä»¶çš„åŠ è½½æµç¨‹ï¼Œè€ŒAndroidä½“ç³»åœ¨æ‰§è¡ŒActivityçš„onResumeæ–¹æ³•ä¹‹å‰ä¼šå›è°ƒActivityThreadçš„handleResumeActivityæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677final void handleResumeActivity(IBinder token, boolean clearHide, boolean isForward, boolean reallyResume) { ... if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) { r.window = r.activity.getWindow(); View decor = r.window.getDecorView(); decor.setVisibility(View.INVISIBLE); ViewManager wm = a.getWindowManager(); WindowManager.LayoutParams l = r.window.getAttributes(); a.mDecor = decor; l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION; l.softInputMode |= forwardBit; if (a.mVisibleFromClient) { a.mWindowAdded = true; wm.addView(decor, l); } // If the window has already been added, but during resume // we started another activity, then don't yet make the // window visible. } ... // The window is now visible if it has been added, we are not // simply finishing, and we are not starting another activity. if (!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp; r.activity.mDecor != null &amp;&amp; !r.hideForNow) { if (r.newConfig != null) { r.tmpConfig.setTo(r.newConfig); if (r.overrideConfig != null) { r.tmpConfig.updateFrom(r.overrideConfig); } if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Resuming activity &quot; + r.activityInfo.name + &quot; with newConfig &quot; + r.tmpConfig); performConfigurationChanged(r.activity, r.tmpConfig); freeTextLayoutCachesIfNeeded(r.activity.mCurrentConfig.diff(r.tmpConfig)); r.newConfig = null; } if (localLOGV) Slog.v(TAG, &quot;Resuming &quot; + r + &quot; with isForward=&quot; + isForward); WindowManager.LayoutParams l = r.window.getAttributes(); if ((l.softInputMode &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION) != forwardBit) { l.softInputMode = (l.softInputMode &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)) | forwardBit; if (r.activity.mVisibleFromClient) { ViewManager wm = a.getWindowManager(); View decor = r.window.getDecorView(); wm.updateViewLayout(decor, l); } } r.activity.mVisibleFromServer = true; mNumVisibleActivities++; if (r.activity.mVisibleFromClient) { r.activity.makeVisible(); } } if (!r.onlyLocalRequest) { r.nextIdle = mNewActivities; mNewActivities = r; if (localLOGV) Slog.v( TAG, &quot;Scheduling idle handler for &quot; + r); Looper.myQueue().addIdleHandler(new Idler()); } r.onlyLocalRequest = false; // Tell the activity manager we have resumed. if (reallyResume) { try { ActivityManagerNative.getDefault().activityResumed(token); } catch (RemoteException ex) { } } ... } å¯ä»¥çœ‹åˆ°åœ¨åœ¨è·å–äº†Activityçš„Windowç›¸å…³å‚æ•°ä¹‹åæ‰§è¡Œäº†r.activity.makeVisible()æ–¹æ³•ï¼Œçœ‹æ ·å­è¿™ä¸ªå°±æ˜¯Activityçš„æ˜¾ç¤ºæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹makeVisibleæ–¹æ³•çš„å…·ä½“å®ç°é€»è¾‘ï¼š 12345678void makeVisible() { if (!mWindowAdded) { ViewManager wm = getWindowManager(); wm.addView(mDecor, getWindow().getAttributes()); mWindowAdded = true; } mDecor.setVisibility(View.VISIBLE); } é¦–å…ˆåˆ¤æ–­æˆå‘˜å˜é‡mWindowAddedæ˜¯å¦ä¸ºtrueï¼Œå¯ä»¥å‘ç°mWindowAddedæˆå‘˜å˜é‡åªæœ‰åœ¨æ‰§è¡Œä¹‹åæ‰èƒ½èµ‹å€¼ä¸ºtrueï¼Œæ‰€ä»¥è¿™é‡Œçš„ä»£ç çš„ä¸»è¦é€»è¾‘æ˜¯è¯¥ifåˆ†æ”¯åªèƒ½æ‰§è¡Œä¸€æ¬¡ã€‚ è¿™é‡Œçš„ViewManagerå¯¹è±¡æ˜¯é€šè¿‡getWindowManager()æ–¹æ³•è·å–çš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹getWindowManager()æ–¹æ³•çš„å…·ä½“å®ç°: 123public WindowManager getWindowManager() { return mWindowManager; } å¥½å§ï¼ŒåŸæ¥å°±æ˜¯è¿”å›çš„Activityçš„mWindowManagerçš„æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆè¿™ä¸ªmWindowManagerçš„æˆå‘˜å˜é‡æ˜¯ä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„å‘¢ï¼Ÿä¸Šä¸€ç¯‡æ–‡ç« æˆ‘ä»¬åœ¨Activityçš„attachæ–¹æ³•æ–¹æ³•ä¸­åˆå§‹åŒ–äº†Activityçš„ç›¸å…³æˆå‘˜å˜é‡ï¼Œè¿™é‡Œä¹ŸåŒ…æ‹¬äº†mWindowManagerï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹mWindowManagerçš„èµ‹å€¼è¿‡ç¨‹ï¼š 1mWindowManager = mWindow.getWindowManager(); å¥½å§ï¼Œè¿™é‡Œçš„Window.getWindowManager()æ–¹æ³•æ˜¯å…·ä½“å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ 123public WindowManager getWindowManager() { return mWindowManager; } é‚£ä¹ˆè¿™é‡Œçš„Windowå¯¹è±¡çš„mWindowManageræˆå‘˜å˜é‡æ˜¯å…·ä½“å¦‚ä½•èµ‹å€¼çš„ï¼Ÿ 1234567891011public void setWindowManager(WindowManager wm, IBinder appToken, String appName, boolean hardwareAccelerated) { mAppToken = appToken; mAppName = appName; mHardwareAccelerated = hardwareAccelerated || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, false); if (wm == null) { wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE); } mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(this); } å¥½å§ï¼Œå¯ä»¥å‘ç°mWindowManager = ((WindowManagerImpl)vm).createLocalWindowManager(this)åŸæ¥æ˜¯åœ¨è¿™é‡Œèµ‹å€¼çš„ï¼Œæ‰€ä»¥ä¸€ä¸ªActivityå¯¹åº”è¿™ä¸€ä¸ªæ–°çš„Windowï¼Œè€Œè¿™ä¸ªWindowå¯¹è±¡å†…éƒ¨ä¼šå¯¹åº”ç€ä¸€ä¸ªæ–°çš„WindowManagerå¯¹è±¡ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ï¼Œé‚£ä¹ˆcreateLoclWindowManageræ–¹æ³•æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ 123public WindowManagerImpl createLocalWindowManager(Window parentWindow) { return new WindowManagerImpl(mDisplay, parentWindow); } å¥½å§ï¼ŒåŸæ¥æ˜¯newå‡ºäº†ä¸€ä¸ªWindowManagerImplå¯¹è±¡ï¼Œæ‰€ä»¥å›åˆ°æˆ‘ä»¬çš„Activityçš„makeVisibleæ–¹æ³•ï¼ŒViewManagerè·å–çš„æ˜¯ä¸€ä¸ªWindowManagerImplå¯¹è±¡ï¼Œæ‰€ä»¥Windowå¯¹è±¡å†…éƒ¨çš„WindowManagerå¯¹è±¡å…¶å®éƒ½æ˜¯ä¸€ä¸ªWindowManagerImplçš„å®ä¾‹ï¼Œéƒ½æ˜¯è€Œä¸”ä»ç»§æ‰¿å…³ç³»ä¸Šå¯ä»¥çœ‹åˆ°ï¼š WindowManagerImpl â€“&gt; WindowManager â€“&gt; ViewManager; ç»§ç»­å¾€ä¸‹çœ‹ï¼š 1wm.addView(mDecor, getWindow().getAttributes()); è¿™é‡Œçš„mDectoræˆå‘˜å˜é‡ï¼Œé€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« çš„ä»‹ç»ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå®ƒæ˜¯Activityçš„ç•Œé¢æ ¹Viewï¼Œè€ŒgetWindow.getAttrbutesæ–¹æ³•æ˜¯windowManagerä¸­å®šä¹‰çš„Paramså†…éƒ¨ç±»ï¼Œè¯¥å†…éƒ¨ç±»å®šä¹‰äº†è®¸å¤šçš„Windowç±»å‹ï¼Œç”±äºè¿™é‡Œçš„vmæ˜¯WindowManagerImplçš„å®ä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™é‡Œçš„addViewçš„å…·ä½“å®ç°ï¼š 12345@Override public void addView(@NonNull View view, @NonNull ViewGroup.LayoutParams params) { applyDefaultToken(params); mGlobal.addView(view, params, mDisplay, mParentWindow); } ç„¶åæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹mGlobal.addViewæ–¹æ³•ï¼Œè¿™é‡Œçš„mGlobalæ˜¯ä¸€ä¸ªWindowManagerGlobalçš„å•ä¾‹å¯¹è±¡ï¼ŒWindowManagerGlobalæ˜¯Windowå¤„ç†çš„å·¥å…·ç±»ï¼Œé‚£ä¹ˆWindowManagerGlobalçš„addViewå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢? 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public void addView(View view, ViewGroup.LayoutParams params, Display display, Window parentWindow) { ... ViewRootImpl root; View panelParentView = null; synchronized (mLock) { // Start watching for system property changes. if (mSystemPropertyUpdater == null) { mSystemPropertyUpdater = new Runnable() { @Override public void run() { synchronized (mLock) { for (int i = mRoots.size() - 1; i &gt;= 0; --i) { mRoots.get(i).loadSystemProperties(); } } } }; SystemProperties.addChangeCallback(mSystemPropertyUpdater); } int index = findViewLocked(view, false); if (index &gt;= 0) { if (mDyingViews.contains(view)) { // Don't wait for MSG_DIE to make it's way through root's queue. mRoots.get(index).doDie(); } else { throw new IllegalStateException(&quot;View &quot; + view + &quot; has already been added to the window manager.&quot;); } // The previous removeView() had not completed executing. Now it has. } // If this is a panel window, then find the window it is being // attached to for future reference. if (wparams.type &gt;= WindowManager.LayoutParams.FIRST_SUB_WINDOW &amp;&amp; wparams.type &lt;= WindowManager.LayoutParams.LAST_SUB_WINDOW) { final int count = mViews.size(); for (int i = 0; i &lt; count; i++) { if (mRoots.get(i).mWindow.asBinder() == wparams.token) { panelParentView = mViews.get(i); } } } root = new ViewRootImpl(view.getContext(), display); view.setLayoutParams(wparams); mViews.add(view); mRoots.add(root); mParams.add(wparams); } // do this last because it fires off messages to start doing things try { root.setView(view, wparams, panelParentView); } catch (RuntimeException e) { // BadTokenException or InvalidDisplayException, clean up. synchronized (mLock) { final int index = findViewLocked(view, false); if (index &gt;= 0) { removeViewLocked(index, true); } } throw e; } } å¯ä»¥å‘ç°åœ¨WindowManagerGlobalä¸­å­˜åœ¨ç€ä¸‰ä¸ªæ•°æ®åˆ—è¡¨ï¼š 1234private final ArrayList&lt;View&gt; mViews = new ArrayList&lt;View&gt;();private final ArrayList&lt;ViewRootImpl&gt; mRoots = new ArrayList&lt;ViewRootImpl&gt;();private final ArrayList&lt;WindowManager.LayoutParams&gt; mParams = new ArrayList&lt;WindowManager.LayoutParams&gt;(); å…¶ä¸­mViewsä¸»è¦ç”¨äºä¿å­˜Activityçš„mDectorä¹Ÿå°±æ˜¯Activityçš„æ ¹Viewï¼Œè€ŒmRootsä¸»è¦ç”¨äºä¿å­˜ViewRootImplï¼ŒmParamsä¸»è¦ç”¨äºä¿å­˜Windowçš„LayoutParamsï¼ŒWindowManagerGlobalä¸»è¦ä½œä¸ºWindowManagerImplçš„è¾…åŠ©æ–¹æ³•ç±»ï¼Œç”¨äºæ“ä½œViewç»„ä»¶ã€‚ æœ€åæˆ‘ä»¬è°ƒç”¨äº†root.setViewæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¾ˆé‡è¦æˆ‘ä»¬å°±æ˜¯åœ¨è¿™é‡Œå®ç°äº†æˆ‘ä»¬çš„rootä¸ViewRootImplçš„å…³è”çš„ï¼Œé™¤äº†å®ç°äº†mDectorä¸ViewRootImplçš„ç›¸äº’å…³è”ï¼Œæˆ‘ä»¬è¿˜è°ƒç”¨äº†requestLayoutæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹setViewæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) { ... requestLayout(); ... } å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ–¹æ³•ä½“ä¸­åˆè°ƒç”¨äº†requestLayoutæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å…¶å®å°±æ˜¯è°ƒç”¨æ‰§è¡Œé‡ç»˜çš„è¯·æ±‚ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªrequestLayoutæ–¹æ³•å…·ä½“å®ç°ï¼š 12345678@Override public void requestLayout() { if (!mHandlingLayoutInLayoutRequest) { checkThread(); mLayoutRequested = true; scheduleTraversals(); } } å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªcheckThreadæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ£€æŸ¥å½“å‰çº¿ç¨‹çš„æ–¹æ³•ï¼Œè‹¥å½“å‰çº¿ç¨‹éUIçº¿ç¨‹ï¼Œåˆ™æŠ›å‡ºéUIçº¿ç¨‹æ›´æ–°UIçš„é”™è¯¯ï¼š 123456void checkThread() { if (mThread != Thread.currentThread()) { throw new CalledFromWrongThreadException( &quot;Only the original thread that created a view hierarchy can touch its views.&quot;); } } ç›¸ä¿¡å¤§å®¶å¹³æ—¶åœ¨ç¼–ç¨‹çš„è¿‡ç¨‹ä¸­è‚¯å®šä¼šé‡åˆ°è¿‡è¿™ä¸ªé”™è¯¯ï¼ŒViewRootImplæ˜¯å…·ä½“æ›´æ–°Viewçš„ç®¡ç†ç±»ï¼Œæ‰€æœ‰å…³äºViewçš„æ›´æ–°æ“ä½œéƒ½æ˜¯åœ¨è¿™é‡Œæ‰§è¡Œçš„ï¼Œè‡ªç„¶è€Œç„¶çš„å¯¹äºæ›´æ–°çº¿ç¨‹çš„æ£€æµ‹æ˜¯åœ¨è¿™ä¸ªç±»ä¸­æ·»åŠ çš„ï¼Œä¸€èˆ¬åœ¨æ›´æ–°UIçš„æ—¶å€™éƒ½ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•ç”¨äºæ£€æµ‹å½“å‰æ‰§è¡Œæ›´æ–°UIçš„çº¿ç¨‹æ˜¯å¦æ˜¯UIçº¿ç¨‹ï¼Œå¦åˆ™å°±ä¼šæŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ã€‚ ç»§ç»­å›åˆ°æˆ‘ä»¬çš„requestLayoutæ–¹æ³•ï¼Œè¿™é‡Œåˆè°ƒç”¨äº†scheduleTraversalesæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678910111213void scheduleTraversals() { if (!mTraversalScheduled) { mTraversalScheduled = true; mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier(); mChoreographer.postCallback( Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null); if (!mUnbufferedInputDispatch) { scheduleConsumeBatchedInput(); } notifyRendererOfFramePending(); pokeDrawLockIfNeeded(); } } è¿™é‡ŒmChoreographer.postCallbackï¼Œå†…éƒ¨ä¼šè°ƒç”¨ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ï¼Œç”¨äºæ‰§è¡ŒmTraversalRunnableçš„runæ–¹æ³•ï¼Œè¿™ä¸ªmTraversalRunnableæ˜¯ä¸€ä¸ªRunnableå¯¹è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹mTraversalRunnableç±»çš„å®šä¹‰ï¼š 123456final class TraversalRunnable implements Runnable { @Override public void run() { doTraversal(); } } åœ¨TraversalRunnableç±»çš„runæ–¹æ³•ä¸­è°ƒç”¨äº†doTraversalæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°é€»è¾‘ï¼š 1234567891011121314151617void doTraversal() { if (mTraversalScheduled) { mTraversalScheduled = false; mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier); if (mProfile) { Debug.startMethodTracing(&quot;ViewAncestor&quot;); } performTraversals(); if (mProfile) { Debug.stopMethodTracing(); mProfile = false; } } } å¥½å§ï¼Œå…¶å†…éƒ¨åˆå›è°ƒäº†æ–¹æ³•performTraversalsæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ•´ä¸ªViewçš„ç»˜åˆ¶èµ·å§‹æ–¹æ³•ï¼Œä»è¿™ä¸ªæ–¹æ³•å¼€å§‹æˆ‘ä»¬çš„Viewç»è¿‡å¤§å°æµ‹é‡ï¼Œä½ç½®æµ‹é‡ï¼Œç•Œé¢ç»˜åˆ¶ä¸‰ä¸ªé€»è¾‘æ“ä½œä¹‹åå°±å¯ä»¥å±•ç¤ºåœ¨ç•Œé¢ä¸­äº†ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121private void performTraversals() { ... // æ‰§è¡ŒViewç»„ä»¶çš„onMeasureæ–¹æ³•ï¼Œä¸»è¦ç”¨äºæµ‹é‡View if (!mStopped || mReportNextDraw) { boolean focusChangedDueToTouchMode = ensureTouchModeLocally( (relayoutResult&amp;WindowManagerGlobal.RELAYOUT_RES_IN_TOUCH_MODE) != 0); if (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth() || mHeight != host.getMeasuredHeight() || contentInsetsChanged) { int childWidthMeasureSpec = getRootMeasureSpec(mWidth, lp.width); int childHeightMeasureSpec = getRootMeasureSpec(mHeight, lp.height); if (DEBUG_LAYOUT) Log.v(TAG, &quot;Ooops, something changed! mWidth=&quot; + mWidth + &quot; measuredWidth=&quot; + host.getMeasuredWidth() + &quot; mHeight=&quot; + mHeight + &quot; measuredHeight=&quot; + host.getMeasuredHeight() + &quot; coveredInsetsChanged=&quot; + contentInsetsChanged); // Ask host how big it wants to be performMeasure(childWidthMeasureSpec, childHeightMeasureSpec); // Implementation of weights from WindowManager.LayoutParams // We just grow the dimensions as needed and re-measure if // needs be int width = host.getMeasuredWidth(); int height = host.getMeasuredHeight(); boolean measureAgain = false; if (lp.horizontalWeight &gt; 0.0f) { width += (int) ((mWidth - width) * lp.horizontalWeight); childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(width, MeasureSpec.EXACTLY); measureAgain = true; } if (lp.verticalWeight &gt; 0.0f) { height += (int) ((mHeight - height) * lp.verticalWeight); childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(height, MeasureSpec.EXACTLY); measureAgain = true; } if (measureAgain) { if (DEBUG_LAYOUT) Log.v(TAG, &quot;And hey let's measure once more: width=&quot; + width + &quot; height=&quot; + height); performMeasure(childWidthMeasureSpec, childHeightMeasureSpec); } layoutRequested = true; } } } ... // ä¸»è¦ç”¨äºæµ‹é‡Viewç»„ä»¶çš„ä½ç½® ... final boolean didLayout = layoutRequested &amp;&amp; (!mStopped || mReportNextDraw); boolean triggerGlobalLayoutListener = didLayout || mAttachInfo.mRecomputeGlobalAttributes; if (didLayout) { performLayout(lp, desiredWindowWidth, desiredWindowHeight); // By this point all views have been sized and positioned // We can compute the transparent area if ((host.mPrivateFlags &amp; View.PFLAG_REQUEST_TRANSPARENT_REGIONS) != 0) { // start out transparent // TODO: AVOID THAT CALL BY CACHING THE RESULT? host.getLocationInWindow(mTmpLocation); mTransparentRegion.set(mTmpLocation[0], mTmpLocation[1], mTmpLocation[0] + host.mRight - host.mLeft, mTmpLocation[1] + host.mBottom - host.mTop); host.gatherTransparentRegion(mTransparentRegion); if (mTranslator != null) { mTranslator.translateRegionInWindowToScreen(mTransparentRegion); } if (!mTransparentRegion.equals(mPreviousTransparentRegion)) { mPreviousTransparentRegion.set(mTransparentRegion); mFullRedrawNeeded = true; // reconfigure window manager try { mWindowSession.setTransparentRegion(mWindow, mTransparentRegion); } catch (RemoteException e) { } } } if (DBG) { System.out.println(&quot;======================================&quot;); System.out.println(&quot;performTraversals -- after setFrame&quot;); host.debug(); } } ... // ä¸»è¦ç”¨äºViewçš„ç»˜åˆ¶è¿‡ç¨‹ ... if (!cancelDraw &amp;&amp; !newSurface) { if (!skipDraw || mReportNextDraw) { if (mPendingTransitions != null &amp;&amp; mPendingTransitions.size() &gt; 0) { for (int i = 0; i &lt; mPendingTransitions.size(); ++i) { mPendingTransitions.get(i).startChangingAnimations(); } mPendingTransitions.clear(); } performDraw(); } } else { if (viewVisibility == View.VISIBLE) { // Try again scheduleTraversals(); } else if (mPendingTransitions != null &amp;&amp; mPendingTransitions.size() &gt; 0) { for (int i = 0; i &lt; mPendingTransitions.size(); ++i) { mPendingTransitions.get(i).endChangingAnimations(); } mPendingTransitions.clear(); } } mIsInTraversal = false; } å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•performTraversalsæ–¹æ³•ï¼Œæˆ‘ä»¬è°ƒç”¨äº†performMeasureï¼ŒperformLayoutï¼ŒperformDrawä¸‰ä¸ªæ–¹æ³•ï¼Œè¿™å‡ ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºæµ‹é‡Viewç»„ä»¶çš„å¤§å°ï¼Œæµ‹é‡Viewç»„ä»¶çš„ä½ç½®ï¼Œç»˜åˆ¶Viewç»„ä»¶ï¼› å³ï¼šæµ‹é‡å¤§å° â€“&gt; æµ‹é‡ä½ç½® â€“&gt; ç»˜åˆ¶ç»„ä»¶ å¥½å§ï¼Œè¿™é‡Œæˆ‘ä»¬è°ƒç”¨äº†performMeasureæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹performMeasureæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) { Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;measure&quot;); try { mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); } finally { Trace.traceEnd(Trace.TRACE_TAG_VIEW); } } å¯ä»¥çœ‹åˆ°åœ¨performMeasureæ–¹æ³•ä¸­æˆ‘ä»¬åˆè°ƒç”¨äº†mViewçš„measureæ–¹æ³•ï¼Œè¿™é‡Œçš„mViewå°±æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹çš„Activityçš„mDectoræ ¹ç»„ä»¶ï¼Œè¿™é‡Œçš„measureæ–¹æ³•å°±æ˜¯è°ƒç”¨çš„mDectorç»„ä»¶çš„measureæ–¹æ³•ï¼š 12345public final void measure(int widthMeasureSpec, int heightMeasureSpec) { ... onMeasure(widthMeasureSpec, heightMeasureSpec); ... } åœ¨Viewçš„measureæ–¹æ³•ä¸­ï¼Œåˆè°ƒç”¨äº†onMeasureæ–¹æ³•ï¼Œç”±äºæˆ‘ä»¬çš„mDectorå¯¹è±¡æ˜¯ä¸€ä¸ªFrameLayoutï¼Œæ‰€ä»¥è¿™é‡Œçš„onMeasureæ‰§è¡Œçš„æ˜¯FrameLayoutçš„onMeasureæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889@Override protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { int count = getChildCount(); final boolean measureMatchParentChildren = MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY || MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY; mMatchParentChildren.clear(); int maxHeight = 0; int maxWidth = 0; int childState = 0; for (int i = 0; i &lt; count; i++) { final View child = getChildAt(i); if (mMeasureAllChildren || child.getVisibility() != GONE) { measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0); final LayoutParams lp = (LayoutParams) child.getLayoutParams(); maxWidth = Math.max(maxWidth, child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin); maxHeight = Math.max(maxHeight, child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin); childState = combineMeasuredStates(childState, child.getMeasuredState()); if (measureMatchParentChildren) { if (lp.width == LayoutParams.MATCH_PARENT || lp.height == LayoutParams.MATCH_PARENT) { mMatchParentChildren.add(child); } } } } // Account for padding too maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground(); maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground(); // Check against our minimum height and width maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight()); maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth()); // Check against our foreground's minimum height and width final Drawable drawable = getForeground(); if (drawable != null) { maxHeight = Math.max(maxHeight, drawable.getMinimumHeight()); maxWidth = Math.max(maxWidth, drawable.getMinimumWidth()); } setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState), resolveSizeAndState(maxHeight, heightMeasureSpec, childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT)); count = mMatchParentChildren.size(); if (count &gt; 1) { for (int i = 0; i &lt; count; i++) { final View child = mMatchParentChildren.get(i); final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams(); final int childWidthMeasureSpec; if (lp.width == LayoutParams.MATCH_PARENT) { final int width = Math.max(0, getMeasuredWidth() - getPaddingLeftWithForeground() - getPaddingRightWithForeground() - lp.leftMargin - lp.rightMargin); childWidthMeasureSpec = MeasureSpec.makeMeasureSpec( width, MeasureSpec.EXACTLY); } else { childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec, getPaddingLeftWithForeground() + getPaddingRightWithForeground() + lp.leftMargin + lp.rightMargin, lp.width); } final int childHeightMeasureSpec; if (lp.height == LayoutParams.MATCH_PARENT) { final int height = Math.max(0, getMeasuredHeight() - getPaddingTopWithForeground() - getPaddingBottomWithForeground() - lp.topMargin - lp.bottomMargin); childHeightMeasureSpec = MeasureSpec.makeMeasureSpec( height, MeasureSpec.EXACTLY); } else { childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec, getPaddingTopWithForeground() + getPaddingBottomWithForeground() + lp.topMargin + lp.bottomMargin, lp.height); } child.measure(childWidthMeasureSpec, childHeightMeasureSpec); } } } å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ªå¾ªç¯é€»è¾‘ï¼Œè·å–è¯¥Viewçš„æ‰€æœ‰å­Viewï¼Œå¹¶æ‰§è¡Œæ‰€æœ‰å­Viewçš„measureæ–¹æ³•ï¼Œè¿™æ ·åˆå›åˆ°Viewçš„measureæ–¹æ³•ï¼Œè¿™æ ·ç»è¿‡ä¸€ç³»åˆ—çš„å¾ªç¯éå†è¿‡ç¨‹ï¼Œå¦‚æœæ˜¯ViewGroupå°±ä¼šè°ƒç”¨å…¶ViewGroupçš„onMeasureæ–¹æ³•ï¼Œè‹¥æœæ˜¯Viewç»„ä»¶å°±ä¼šè°ƒç”¨Viewçš„onMeasureæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Viewçš„onMeasureæ–¹æ³•ï¼š 1234protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) { setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec), getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec)); } å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä¸­è°ƒç”¨äº†setMeasuredDimensionæ–¹æ³•ï¼š 123456789101112protected final void setMeasuredDimension(int measuredWidth, int measuredHeight) { boolean optical = isLayoutModeOptical(this); if (optical != isLayoutModeOptical(mParent)) { Insets insets = getOpticalInsets(); int opticalWidth = insets.left + insets.right; int opticalHeight = insets.top + insets.bottom; measuredWidth += optical ? opticalWidth : -opticalWidth; measuredHeight += optical ? opticalHeight : -opticalHeight; } setMeasuredDimensionRaw(measuredWidth, measuredHeight); } å¥½å§ï¼Œæ–¹æ³•ä½“é‡Œé¢åˆè°ƒç”¨äº†setMeasuredDimensionRawæ–¹æ³•ï¼š 123456private void setMeasuredDimensionRaw(int measuredWidth, int measuredHeight) { mMeasuredWidth = measuredWidth; mMeasuredHeight = measuredHeight; mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET; } è¿™æ ·æŠŠViewç»„ä»¶å³å…¶å­Viewçš„å¤§å°æµ‹é‡å‡ºæ¥äº†ï¼Œå¹¶ä¸”ä¿å­˜åœ¨äº†æˆå‘˜å˜é‡mMeasuredWithå’ŒmMeasuredHeightä¸­ã€‚ ç»§ç»­å›åˆ°æˆ‘ä»¬çš„performTranslesæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬ç»§ç»­çœ‹performLayoutæ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273private void performLayout(WindowManager.LayoutParams lp, int desiredWindowWidth, int desiredWindowHeight) { mLayoutRequested = false; mScrollMayChange = true; mInLayout = true; final View host = mView; if (DEBUG_ORIENTATION || DEBUG_LAYOUT) { Log.v(TAG, &quot;Laying out &quot; + host + &quot; to (&quot; + host.getMeasuredWidth() + &quot;, &quot; + host.getMeasuredHeight() + &quot;)&quot;); } Trace.traceBegin(Trace.TRACE_TAG_VIEW, &quot;layout&quot;); try { host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight()); mInLayout = false; int numViewsRequestingLayout = mLayoutRequesters.size(); if (numViewsRequestingLayout &gt; 0) { // requestLayout() was called during layout. // If no layout-request flags are set on the requesting views, there is no problem. // If some requests are still pending, then we need to clear those flags and do // a full request/measure/layout pass to handle this situation. ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, false); if (validLayoutRequesters != null) { // Set this flag to indicate that any further requests are happening during // the second pass, which may result in posting those requests to the next // frame instead mHandlingLayoutInLayoutRequest = true; // Process fresh layout requests, then measure and layout int numValidRequests = validLayoutRequesters.size(); for (int i = 0; i &lt; numValidRequests; ++i) { final View view = validLayoutRequesters.get(i); Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view + &quot; during layout: running second layout pass&quot;); view.requestLayout(); } measureHierarchy(host, lp, mView.getContext().getResources(), desiredWindowWidth, desiredWindowHeight); mInLayout = true; host.layout(0, 0, host.getMeasuredWidth(), host.getMeasuredHeight()); mHandlingLayoutInLayoutRequest = false; // Check the valid requests again, this time without checking/clearing the // layout flags, since requests happening during the second pass get noop'd validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, true); if (validLayoutRequesters != null) { final ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters; // Post second-pass requests to the next frame getRunQueue().post(new Runnable() { @Override public void run() { int numValidRequests = finalRequesters.size(); for (int i = 0; i &lt; numValidRequests; ++i) { final View view = finalRequesters.get(i); Log.w(&quot;View&quot;, &quot;requestLayout() improperly called by &quot; + view + &quot; during second layout pass: posting in next frame&quot;); view.requestLayout(); } } }); } } } } finally { Trace.traceEnd(Trace.TRACE_TAG_VIEW); } mInLayout = false; } å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•ä½“ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°è¯¥æ–¹æ³•æ‰§è¡Œäº†layoutæ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¯¥layoutæ–¹æ³•çš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132public void layout(int l, int t, int r, int b) { if ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != 0) { onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec); mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT; } int oldL = mLeft; int oldT = mTop; int oldB = mBottom; int oldR = mRight; boolean changed = isLayoutModeOptical(mParent) ? setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b); if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) { onLayout(changed, l, t, r, b); mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED; ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnLayoutChangeListeners != null) { ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy = (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone(); int numListeners = listenersCopy.size(); for (int i = 0; i &lt; numListeners; ++i) { listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB); } } } mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT; mPrivateFlags3 |= PFLAG3_IS_LAID_OUT; } å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–¹æ³•ä½“ä¸­æ‰§è¡Œäº†onLayoutæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯å…·ä½“æ‰§è¡Œæµ‹é‡ä½ç½®çš„æ–¹æ³•äº†ï¼Œç”±äºæˆ‘ä»¬çš„mDectoræ˜¯ä¸€ä¸ªFrameLayoutï¼Œæ‰€ä»¥è·Ÿmeasureç±»ä¼¼çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹FrameLayoutçš„onLayoutæ–¹æ³•çš„å®ç°ï¼š æˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå¾ªç¯é€»è¾‘ï¼Œè·å–æ‰€æœ‰çš„validLayoutRequestersä¹Ÿå°±æ˜¯éœ€è¦æ‰§è¡ŒLayoutæ–¹æ³•çš„Viewçš„é›†åˆï¼Œé€šè¿‡å¾ªç¯æ‰§è¡Œviewçš„requestLayoutæ–¹æ³•ã€‚è¿™é‡Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹requestLayoutæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234@Override protected void onLayout(boolean changed, int left, int top, int right, int bottom) { layoutChildren(left, top, right, bottom, false /* no force left gravity */); } å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†layoutChildrenæ–¹æ³•ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹layoutChildrenæ–¹æ³•çš„å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364void layoutChildren(int left, int top, int right, int bottom, boolean forceLeftGravity) { final int count = getChildCount(); final int parentLeft = getPaddingLeftWithForeground(); final int parentRight = right - left - getPaddingRightWithForeground(); final int parentTop = getPaddingTopWithForeground(); final int parentBottom = bottom - top - getPaddingBottomWithForeground(); for (int i = 0; i &lt; count; i++) { final View child = getChildAt(i); if (child.getVisibility() != GONE) { final LayoutParams lp = (LayoutParams) child.getLayoutParams(); final int width = child.getMeasuredWidth(); final int height = child.getMeasuredHeight(); int childLeft; int childTop; int gravity = lp.gravity; if (gravity == -1) { gravity = DEFAULT_CHILD_GRAVITY; } final int layoutDirection = getLayoutDirection(); final int absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection); final int verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK; switch (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) { case Gravity.CENTER_HORIZONTAL: childLeft = parentLeft + (parentRight - parentLeft - width) / 2 + lp.leftMargin - lp.rightMargin; break; case Gravity.RIGHT: if (!forceLeftGravity) { childLeft = parentRight - width - lp.rightMargin; break; } case Gravity.LEFT: default: childLeft = parentLeft + lp.leftMargin; } switch (verticalGravity) { case Gravity.TOP: childTop = parentTop + lp.topMargin; break; case Gravity.CENTER_VERTICAL: childTop = parentTop + (parentBottom - parentTop - height) / 2 + lp.topMargin - lp.bottomMargin; break; case Gravity.BOTTOM: childTop = parentBottom - height - lp.bottomMargin; break; default: childTop = parentTop + lp.topMargin; } child.layout(childLeft, childTop, childLeft + width, childTop + height); } } } è·Ÿmeasureç±»ä¼¼çš„ï¼Œè¿™é‡Œä¹Ÿæ˜¯éå†æ‰§è¡ŒViewçš„layoutæ–¹æ³•ï¼Œè‹¥æ˜¯ViewGroupåˆ™æ‰§è¡Œå…·ä½“çš„ViewGroupçš„layoutæ–¹æ³•ï¼Œè‹¥æ˜¯Viewï¼Œåˆ™æ‰§è¡ŒViewçš„layoutæ–¹æ³•ï¼Œå¥½å§ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹Viewçš„layoutçš„å…·ä½“å®ç°é€»è¾‘ï¼š 1234567891011121314151617181920212223242526272829303132public void layout(int l, int t, int r, int b) { if ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != 0) { onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec); mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT; } int oldL = mLeft; int oldT = mTop; int oldB = mBottom; int oldR = mRight; boolean changed = isLayoutModeOptical(mParent) ? setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b); if (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) { onLayout(changed, l, t, r, b); mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED; ListenerInfo li = mListenerInfo; if (li != null &amp;&amp; li.mOnLayoutChangeListeners != null) { ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy = (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone(); int numListeners = listenersCopy.size(); for (int i = 0; i &lt; numListeners; ++i) { listenersCopy.get(i).onLayoutChange(this, l, t, r, b, oldL, oldT, oldR, oldB); } } } mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT; mPrivateFlags3 |= PFLAG3_IS_LAID_OUT; } è¿™æ ·ç»è¿‡layoutæ–¹æ³•ï¼Œå¦‚æœæ˜¯Viewç»„ä»¶çš„è¯å°±å·²ç»å°†Viewç»„ä»¶çš„ä½ç½®ä¿¡æ¯è®¡ç®—å‡ºæ¥å¹¶ä¿å­˜åœ¨å¯¹è±¡çš„æˆå‘˜å˜é‡ä¸­ã€‚ å¥½å§ï¼Œç»è¿‡äº†æµ‹é‡å¤§å°ä¸æµ‹é‡ä½ç½®çš„é€»è¾‘ä¹‹åï¼Œæˆ‘ä»¬æœ€åçœ‹ä¸€ä¸‹performTraversalsæ–¹æ³•ä¸­çš„performDrawæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨å°±æ˜¯æ‰§è¡ŒViewç»„ä»¶çš„ç»˜åˆ¶é€»è¾‘äº†ã€‚ 12345private void performDraw() { ... draw(fullRedrawNeeded); ... } å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†ViewRootImplçš„drawæ–¹æ³•ï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹drawæ–¹æ³•çš„å®ç°ï¼š 1234567private void draw(boolean fullRedrawNeeded) { ... if (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) { return; } ... } å¯ä»¥çœ‹åˆ°è¿™é‡Œåˆè°ƒç”¨äº†drawSoftwareæ–¹æ³•ï¼Œçœ‹åå­—è¿™é‡Œåº”è¯¥å°±æ˜¯è°ƒç”¨æ‰§è¡Œç»˜åˆ¶çš„æ–¹æ³•ï¼š 12345678private boolean drawSoftware(Surface surface, AttachInfo attachInfo, int xoff, int yoff, boolean scalingRequired, Rect dirty) { ... mView.draw(canvas); ... return true; } å¯ä»¥çœ‹åˆ°è¿™é‡Œè°ƒç”¨äº†mViewçš„drawæ–¹æ³•ï¼Œè¿™é‡Œçš„mViewæ˜¯æˆ‘ä»¬çš„mDectorï¼Œå¥½å§ï¼Œçœ‹ä¸€ä¸‹drawæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193public void draw(Canvas canvas) { final int privateFlags = mPrivateFlags; final boolean dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp; (mAttachInfo == null || !mAttachInfo.mIgnoreDirtyState); mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN; /* * Draw traversal performs several drawing steps which must be executed * in the appropriate order: * * 1. Draw the background * 2. If necessary, save the canvas' layers to prepare for fading * 3. Draw view's content * 4. Draw children * 5. If necessary, draw the fading edges and restore layers * 6. Draw decorations (scrollbars for instance) */ // Step 1, draw the background, if needed int saveCount; if (!dirtyOpaque) { drawBackground(canvas); } // skip step 2 &amp; 5 if possible (common case) final int viewFlags = mViewFlags; boolean horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != 0; boolean verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != 0; if (!verticalEdges &amp;&amp; !horizontalEdges) { // Step 3, draw the content if (!dirtyOpaque) onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); // Overlay is part of the content and draws beneath Foreground if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) { mOverlay.getOverlayView().dispatchDraw(canvas); } // Step 6, draw decorations (foreground, scrollbars) onDrawForeground(canvas); // we're done... return; } /* * Here we do the full fledged routine... * (this is an uncommon case where speed matters less, * this is why we repeat some of the tests that have been * done above) */ boolean drawTop = false; boolean drawBottom = false; boolean drawLeft = false; boolean drawRight = false; float topFadeStrength = 0.0f; float bottomFadeStrength = 0.0f; float leftFadeStrength = 0.0f; float rightFadeStrength = 0.0f; // Step 2, save the canvas' layers int paddingLeft = mPaddingLeft; final boolean offsetRequired = isPaddingOffsetRequired(); if (offsetRequired) { paddingLeft += getLeftPaddingOffset(); } int left = mScrollX + paddingLeft; int right = left + mRight - mLeft - mPaddingRight - paddingLeft; int top = mScrollY + getFadeTop(offsetRequired); int bottom = top + getFadeHeight(offsetRequired); if (offsetRequired) { right += getRightPaddingOffset(); bottom += getBottomPaddingOffset(); } final ScrollabilityCache scrollabilityCache = mScrollCache; final float fadeHeight = scrollabilityCache.fadingEdgeLength; int length = (int) fadeHeight; // clip the fade length if top and bottom fades overlap // overlapping fades produce odd-looking artifacts if (verticalEdges &amp;&amp; (top + length &gt; bottom - length)) { length = (bottom - top) / 2; } // also clip horizontal fades if necessary if (horizontalEdges &amp;&amp; (left + length &gt; right - length)) { length = (right - left) / 2; } if (verticalEdges) { topFadeStrength = Math.max(0.0f, Math.min(1.0f, getTopFadingEdgeStrength())); drawTop = topFadeStrength * fadeHeight &gt; 1.0f; bottomFadeStrength = Math.max(0.0f, Math.min(1.0f, getBottomFadingEdgeStrength())); drawBottom = bottomFadeStrength * fadeHeight &gt; 1.0f; } if (horizontalEdges) { leftFadeStrength = Math.max(0.0f, Math.min(1.0f, getLeftFadingEdgeStrength())); drawLeft = leftFadeStrength * fadeHeight &gt; 1.0f; rightFadeStrength = Math.max(0.0f, Math.min(1.0f, getRightFadingEdgeStrength())); drawRight = rightFadeStrength * fadeHeight &gt; 1.0f; } saveCount = canvas.getSaveCount(); int solidColor = getSolidColor(); if (solidColor == 0) { final int flags = Canvas.HAS_ALPHA_LAYER_SAVE_FLAG; if (drawTop) { canvas.saveLayer(left, top, right, top + length, null, flags); } if (drawBottom) { canvas.saveLayer(left, bottom - length, right, bottom, null, flags); } if (drawLeft) { canvas.saveLayer(left, top, left + length, bottom, null, flags); } if (drawRight) { canvas.saveLayer(right - length, top, right, bottom, null, flags); } } else { scrollabilityCache.setFadeColor(solidColor); } // Step 3, draw the content if (!dirtyOpaque) onDraw(canvas); // Step 4, draw the children dispatchDraw(canvas); // Step 5, draw the fade effect and restore layers final Paint p = scrollabilityCache.paint; final Matrix matrix = scrollabilityCache.matrix; final Shader fade = scrollabilityCache.shader; if (drawTop) { matrix.setScale(1, fadeHeight * topFadeStrength); matrix.postTranslate(left, top); fade.setLocalMatrix(matrix); p.setShader(fade); canvas.drawRect(left, top, right, top + length, p); } if (drawBottom) { matrix.setScale(1, fadeHeight * bottomFadeStrength); matrix.postRotate(180); matrix.postTranslate(left, bottom); fade.setLocalMatrix(matrix); p.setShader(fade); canvas.drawRect(left, bottom - length, right, bottom, p); } if (drawLeft) { matrix.setScale(1, fadeHeight * leftFadeStrength); matrix.postRotate(-90); matrix.postTranslate(left, top); fade.setLocalMatrix(matrix); p.setShader(fade); canvas.drawRect(left, top, left + length, bottom, p); } if (drawRight) { matrix.setScale(1, fadeHeight * rightFadeStrength); matrix.postRotate(90); matrix.postTranslate(right, top); fade.setLocalMatrix(matrix); p.setShader(fade); canvas.drawRect(right - length, top, right, bottom, p); } canvas.restoreToCount(saveCount); // Overlay is part of the content and draws beneath Foreground if (mOverlay != null &amp;&amp; !mOverlay.isEmpty()) { mOverlay.getOverlayView().dispatchDraw(canvas); } // Step 6, draw decorations (foreground, scrollbars) onDrawForeground(canvas); } æ•´ä¸ªViewçš„ç»˜åˆ¶æµç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ¥šçš„ï¼Œæ•´ä¸ªæ‰§è¡Œé€»è¾‘è¿˜æœ‰ç›¸åº”çš„æ³¨é‡Šï¼Œä¸€å…±å¤§æ¦‚éœ€è¦å…­æ­¥ï¼Œå¹¶ä¸”åœ¨æ‰§è¡Œdrawæ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåŒ…å«å­Viewï¼Œé‚£ä¹ˆä¹Ÿä¼šæ‰§è¡Œå­Viewçš„drawæ–¹æ³•ï¼Œå¥½å§ï¼Œç»è¿‡è¿™æ ·ä¸€ç³»åˆ—çš„æ‰§è¡Œé€»è¾‘ä¹‹åï¼ŒmDectorä»¥åŠå­Viewå°±è¢«ç»˜åˆ¶å‡ºæ¥äº†ã€‚ æ€»ç»“ï¼š Activityæ‰§è¡ŒonResumeä¹‹åå†ActivityThreadä¸­æ‰§è¡ŒActivityçš„makeVisibleæ–¹æ³•ã€‚ Viewçš„ç»˜åˆ¶æµç¨‹åŒ…å«äº†æµ‹é‡å¤§å°ï¼Œæµ‹é‡ä½ç½®ï¼Œç»˜åˆ¶ä¸‰ä¸ªæµç¨‹ï¼› Activtyçš„ç•Œé¢ç»˜åˆ¶æ˜¯ä»mDectorå³æ ¹Viewå¼€å§‹çš„ï¼Œä¹Ÿå°±æ˜¯ä»mDectorçš„æµ‹é‡å¤§å°ï¼Œæµ‹é‡ä½ç½®ï¼Œç»˜åˆ¶ä¸‰ä¸ªæµç¨‹ï¼› Viewä½“ç³»çš„ç»˜åˆ¶æµç¨‹æ˜¯ä»ViewRootImplçš„performTraversalsæ–¹æ³•å¼€å§‹çš„ï¼› Viewçš„æµ‹é‡å¤§å°æµç¨‹:performMeasure â€“&gt; measure â€“&gt; onMeasureç­‰æ–¹æ³•; Viewçš„æµ‹é‡ä½ç½®æµç¨‹ï¼šperformLayout â€“&gt; layout â€“&gt; onLayoutç­‰æ–¹æ³•ï¼› Viewçš„ç»˜åˆ¶æµç¨‹ï¼šonDrawç­‰æ–¹æ³•ï¼› Viewç»„ä»¶çš„ç»˜åˆ¶æµç¨‹ä¼šåœ¨onMeasure,onLayoutä»¥åŠonDrawæ–¹æ³•ä¸­æ‰§è¡Œåˆ†å‘é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯åœ¨onMeasureåŒæ—¶æ‰§è¡Œå­Viewçš„æµ‹é‡å¤§å°é€»è¾‘ï¼Œåœ¨onLayoutä¸­åŒæ—¶æ‰§è¡Œå­Viewçš„æµ‹é‡ä½ç½®é€»è¾‘ï¼Œåœ¨onDrawä¸­åŒæ—¶æ‰§è¡Œå­Viewçš„ç»˜åˆ¶é€»è¾‘ï¼› Activityä¸­éƒ½å¯¹åº”è¿™ä¸ªä¸€ä¸ªWindowå¯¹è±¡ï¼Œè€Œæ¯ä¸€ä¸ªWindowå¯¹è±¡éƒ½å¯¹åº”ç€ä¸€ä¸ªæ–°çš„WindowManagerå¯¹è±¡ï¼ˆWindowManagerImplå®ä¾‹ï¼‰ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹androidæºç è§£æä¹‹ï¼ˆåå››ï¼‰â€“&gt;Activityå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäº”ï¼‰â€“&gt;Activityé”€æ¯æµç¨‹androidæºç è§£æï¼ˆåå…­ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹Contextåˆ›å»ºæµç¨‹androidæºç è§£æï¼ˆåä¸ƒï¼‰â€“&gt;Activityå¸ƒå±€åŠ è½½æµç¨‹","link":"/2020/09/11/Activity%E5%B8%83%E5%B1%80%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B/"},{"title":"å¤šçº¿ç¨‹å¹¶å‘çŸ¥è¯†","text":"Thread åº•å±‚è°ƒç”¨startçš„ nativeæ–¹æ³• å¹¶è¡Œ åŠ å¹¶å‘ æ¦‚å¿µï¼Ÿ å¹¶è¡Œï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œçš„æ¦‚å¿µã€‚ å¹¶å‘ï¼Œå•ä½æ—¶é—´å†…ï¼Œçº¿ç¨‹å¤„ç†æ•°æ®çš„èƒ½åŠ›ï¼Œååé‡ã€‚ Javaé»˜è®¤æ˜¯å¤šçº¿ç¨‹ é«˜å¹¶å‘ç¼–ç¨‹çš„æ„ä¹‰åŠå¥½å¤„ï¼Ÿ å¹³è¡¡ä½¿ç”¨æˆ‘ä»¬çš„çº¿ç¨‹(å¥½å¤„) ä¸è¦cpu è¿‡ç´¯(æ„ä¹‰) é¢è¯•é¢˜ 1.run å’Œstartæ–¹æ³•çš„åŒºåˆ«ï¼Ÿ .run()æ—¶å‡½æ•°è°ƒç”¨å’Œçº¿ç¨‹æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œ.start()æ–¹æ³•æ‰§è¡Œnativeåº•å±‚å‡½æ•°ï¼Œç³»ç»Ÿæœ€ç»ˆè°ƒåº¦åˆ°runå‡½æ•°ï¼Œè¿™æ‰æ˜¯çº¿ç¨‹ã€‚ \\2. å¦‚ä½•æ§åˆ¶çº¿ç¨‹çš„æ‰§è¡Œé¡ºåºï¼Ÿ .join() å‡½æ•°æ§åˆ¶ï¼Œè®©t2è·å–æ‰§è¡ŒæƒåŠ›ï¼Œèƒ½å¤Ÿåšåˆ°é¡ºåºæ‰§è¡Œ \\3. å¤šçº¿ç¨‹ä¸­çš„å¹¶è¡Œå’Œå¹¶å‘æ˜¯ä»€ä¹ˆï¼Ÿ å››ä¸ªè½¦é“ï¼Œå››è¾†è½¦å¹¶è¡Œçš„è¡Œé©¶ï¼Œå°±æ˜¯å¹¶è¡Œã€‚ å››ä¸ªè½¦é“ï¼Œäº”ç§’é’Ÿå¤šå°‘çš„è½¦æµé‡ï¼Œå¤šå°‘çš„ååé‡ï¼Œæ˜¯å¹¶å‘ã€‚å•ä½æ—¶é—´å†…çš„æ‰§è¡Œæ•ˆç‡ \\4. åœ¨Javaä¸­èƒ½ä¸èƒ½æŒ‡å®šCPUå»æ‰§è¡ŒæŸä¸ªçº¿ç¨‹ï¼Ÿ ä¸èƒ½ï¼ŒJavaæ˜¯åšä¸åˆ°çš„ï¼Œå”¯ä¸€èƒ½å¤Ÿå»å¹²é¢„çš„æ˜¯Cè¯­è¨€è°ƒç”¨å†…æ ¸çš„APIå»æ‰§è¡Œæ‰è¡Œã€‚ \\5. é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šè€ƒè™‘çº¿ç¨‹ä¼˜å…ˆçº§ä¹ˆï¼Ÿ ä¸ä¼šè€ƒè™‘ä¼˜å…ˆçº§ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºçº¿ç¨‹çš„ä¼˜å…ˆçº§å¾ˆä¾èµ–ä¸ç³»ç»Ÿçš„å¹³å°ï¼Œæ‰€ä»¥è¿™ä¸ªä¼˜å…ˆçº§æ— æ³•å¯¹å·å…¥åº§ï¼Œæ— æ³•åšåˆ°ä½ æƒ³è±¡ä¸­çš„ä¼˜å…ˆçº§ï¼Œå±äº ä¸ç¨³å®šï¼Œæœ‰é£é™©ï¼Œå› ä¸ºæŸäº›å¼€æºæ¡†æ¶ï¼Œä¹Ÿä¸èƒ½ä¾é çº¿ç¨‹ä¼˜å…ˆçº§æ¥è®¾ç½®è‡ªå·±æƒ³è¦çš„ä¼˜å…ˆçº§é¡ºåºï¼Œè¿™ä¸ªæ˜¯ä¸å¯é çš„ã€‚ ä¾‹ï¼šJavaçº¿ç¨‹ä¼˜å…ˆçº§æœ‰åçº§ï¼Œè€Œæ­¤æ—¶æ“ä½œç³»ç»Ÿä¼˜å…ˆçº§æŒ‡æœ‰2~3çº§ï¼Œé‚£å°±å¯¹åº”ä¸ä¸Šäº†ã€‚ \\6. sleep å’Œ wait æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ sleepæ˜¯ä¼‘çœ ï¼Œç­‰ä¼‘çœ æ—¶é—´ä¸€å›½ï¼Œæ‰æœ‰æ‰§è¡Œçš„èµ„æ ¼ï¼Œæ³¨æ„æ˜¯æœ‰èµ„æ ¼ï¼Œå¹¶ä¸èƒ½é©¬ä¸Šå°±ä¼šè¢«æ‰§è¡Œï¼Œä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Œå–å†³äºcpuç³»ç»Ÿè°ƒåº¦ã€‚ waitæ˜¯ç™»å°ï¼Œéœ€è¦å”¤é†’ï¼Œå”¤é†’åï¼Œæ‰æœ‰æ‰§è¡Œçš„èµ„æ ¼ã€‚ sleep()ï¼šçº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œä¸ä¼šé‡Šæ”¾é” wait()ï¼šè°ƒåŠ¨æ–¹æ³•ä¹‹å‰ï¼Œå¿…é¡»è¦æŒæœ‰é”ã€‚è°ƒç”¨äº†wait()æ–¹æ³•ä»¥åï¼Œé”å°±ä¼šè¢«é‡Šæ”¾ï¼Œè¿›å…¥é”çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œæ–¹æ³•è¿”å›åé‡æ–°æ‹¿åˆ°é” å«ä¹‰ä¸åŒ: sleep æ— æ¡ä»¶å¯ä»¥ä¼‘çœ ï¼Œ waitæ˜¯æŸäº›åŸå› ä¸æ¡ä»¶ éœ€è¦ç­‰å¾…ä¸€ä¸‹ã€‚ \\7. åœ¨Javaä¸­èƒ½ä¸èƒ½å¼ºåˆ¶ä¸­æ–­çº¿ç¨‹çš„æ‰§è¡Œ è™½ç„¶æä¾›äº†stopå‡½æ•°ï¼Œä½†æ˜¯æ­¤å‡½æ•°ä¸æ¨èä½¿ç”¨ã€‚å› ä¸ºè¿™ç§æ–¹å¼å¾ˆæš´åŠ›ï¼Œå¾ˆå±é™©ï¼Œä¾‹å¦‚:ä¸‹è½½å›¾ç‰‡5kbï¼Œåªä¸‹è½½äº†4kbç­‰æˆ‘ä»¬å¯ä»¥ä½¿ç”¨interruptæ¥ å¤„ç†æˆ‘çº¿ç¨‹çš„åœæ­¢ï¼Œä½†æ˜¯æ³¨æ„interruptåªæ˜¯åä½œå¼çš„æ–¹å¼ï¼Œå¹¶ä¸èƒ½ç»å¯¹ä¿è¯ç»ˆä¸­æ–­ï¼Œå¹¶ä¸æ˜¯æŠ¢å å¼ã€‚ \\8. å¦‚ä½•è®©å‡ºå½“å‰çº¿ç¨‹çš„æ‰§è¡Œæƒï¼Ÿ yield() ï¼šè®©å‡ºcpuçš„æ‰§è¡Œæƒï¼Œå°†çº¿ç¨‹ä»è¿è¡Œè½¬åˆ°å¯è¿è¡ŒçŠ¶æ€ï¼Œä½†æ˜¯ä¸‹ä¸ªæ—¶é—´ç‰‡ï¼Œè¯¥çº¿ç¨‹ä¾ç„¶æœ‰å¯èƒ½è¢«å†æ¬¡é€‰ä¸­è¿è¡Œ \\9. notify()å’ŒnotifyAll()åŒºåˆ«ï¼Ÿ â€‹ notify()å¯èƒ½å‘ç”Ÿä¿¡å·ä¸¢å¤±çš„æƒ…å†µã€‚å¹¶ä¸”å¯èƒ½ä¼šå¯¼è‡´æ­»é”ç°è±¡ã€‚ â€‹ é”æ± :å‡è®¾çº¿ç¨‹Aå·²ç»æ‹¥æœ‰äº†æŸä¸ªå¯¹è±¡(æ³¨æ„:ä¸æ˜¯ç±»)çš„é”ï¼Œè€Œå…¶å®ƒçš„çº¿ç¨‹æƒ³è¦è°ƒç”¨è¿™ä¸ªå¯¹è±¡çš„æŸä¸ªsynchronizedæ–¹æ³•( â€‹ æˆ–è€…synchronizedå—)ï¼Œç”±äºè¿™äº›çº¿ç¨‹åœ¨è¿›å…¥å¯¹è±¡çš„synchronizedæ–¹æ³•ä¹‹å‰å¿…é¡»å…ˆè·å¾—è¯¥å¯¹è±¡çš„é”çš„æ‹¥æœ‰æƒï¼Œ â€‹ ä½†æ˜¯è¯¥å¯¹è±¡çš„é”ç›®å‰æ­£è¢«çº¿ç¨‹Aæ‹¥æœ‰ï¼Œæ‰€ä»¥è¿™äº›çº¿ç¨‹å°±è¿›å…¥äº†è¯¥å¯¹è±¡çš„é”æ± ä¸­ã€‚ â€‹ ç­‰å¾…æ± :å‡è®¾ä¸€ä¸ªçº¿ç¨‹Aè°ƒç”¨äº†æŸä¸ªå¯¹è±¡çš„wait()æ–¹æ³•ï¼Œçº¿ç¨‹Aå°±ä¼šé‡Šæ”¾è¯¥å¯¹è±¡çš„é”åï¼Œè¿›å…¥åˆ°äº†è¯¥å¯¹è±¡çš„ç­‰å¾…æ± ä¸­ å¦‚æœçº¿ç¨‹è°ƒç”¨äº†å¯¹è±¡çš„ wait()æ–¹æ³•ï¼Œé‚£ä¹ˆçº¿ç¨‹ä¾¿ä¼šå¤„äºè¯¥å¯¹è±¡çš„ç­‰å¾…æ± ä¸­ï¼Œç­‰å¾…æ± ä¸­çš„çº¿ç¨‹ä¸ä¼šå»ç«äº‰è¯¥å¯¹è±¡çš„é”ã€‚ å½“æœ‰çº¿ç¨‹è°ƒç”¨äº†å¯¹è±¡çš„ notifyAll()æ–¹æ³•ï¼ˆå”¤é†’æ‰€æœ‰ wait çº¿ç¨‹ï¼‰æˆ– notify()æ–¹æ³•ï¼ˆåªéšæœºå”¤é†’ä¸€ä¸ª wait çº¿ç¨‹ï¼‰ï¼Œ è¢«å”¤é†’çš„çš„çº¿ç¨‹ä¾¿ä¼šè¿›å…¥è¯¥å¯¹è±¡çš„é”æ± ä¸­ï¼Œé”æ± ä¸­çš„çº¿ç¨‹ä¼šå»ç«äº‰è¯¥å¯¹è±¡é”ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè°ƒç”¨äº†notifyååªè¦ä¸€ä¸ªçº¿ç¨‹ä¼šç”±ç­‰å¾…æ± è¿›å…¥é”æ± ï¼Œ è€ŒnotifyAllä¼šå°†è¯¥å¯¹è±¡ç­‰å¾…æ± å†…çš„æ‰€æœ‰çº¿ç¨‹ç§»åŠ¨åˆ°é”æ± ä¸­ï¼Œç­‰å¾…é”ç«äº‰ ä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ç«äº‰åˆ°å¯¹è±¡é”çš„æ¦‚ç‡å¤§ï¼Œå‡è‹¥æŸçº¿ç¨‹æ²¡æœ‰ç«äº‰åˆ°è¯¥å¯¹è±¡é”ï¼Œå®ƒè¿˜ä¼šç•™åœ¨é”æ± ä¸­ï¼Œå”¯æœ‰çº¿ç¨‹å†æ¬¡è°ƒç”¨ wait()æ–¹æ³•ï¼Œ å®ƒæ‰ä¼šé‡æ–°å›åˆ°ç­‰å¾…æ± ä¸­ã€‚è€Œç«äº‰åˆ°å¯¹è±¡é”çš„çº¿ç¨‹åˆ™ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œç›´åˆ°æ‰§è¡Œå®Œäº† synchronized ä»£ç å—ï¼Œå®ƒä¼šé‡Šæ”¾æ‰è¯¥å¯¹è±¡é”ï¼Œ è¿™æ—¶é”æ± ä¸­çš„çº¿ç¨‹ä¼šç»§ç»­ç«äº‰è¯¥å¯¹è±¡é”ã€‚ å”¤é†’çº¿ç¨‹ï¼Œå¦ä¸€ç§è§£é‡Šå¯ä»¥è¯´æ˜¯å°†çº¿ç¨‹ç”±ç­‰å¾…æ± ç§»åŠ¨åˆ°é”æ± ï¼ŒnotifyAllè°ƒç”¨åï¼Œä¼šå°†å…¨éƒ¨çº¿ç¨‹ç”±ç­‰å¾…æ± ç§»åˆ°é”æ± ï¼Œç„¶åå‚ä¸é”çš„ç«äº‰ ï¼Œç«äº‰æˆåŠŸåˆ™ç»§ç»­æ‰§è¡Œï¼Œå¦‚æœä¸æˆåŠŸåˆ™ç•™åœ¨é”æ± ç­‰å¾…é”è¢«é‡Šæ”¾åå†æ¬¡å‚ä¸ç«äº‰ã€‚è€Œnotifyåªä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ã€‚ 10.è°ƒç”¨yield() ã€sleep()ã€wait()ã€notify()ç­‰æ–¹æ³•å¯¹é”æœ‰ä½•å½±å“ï¼Ÿ yield()ï¼šè®©å‡ºæ—¶é—´ç‰‡ï¼Œä¸ä¼šé‡Šæ”¾é” sleep()ï¼šçº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œä¸ä¼šé‡Šæ”¾é” wait()ï¼šè°ƒåŠ¨æ–¹æ³•ä¹‹å‰ï¼Œå¿…é¡»è¦æŒæœ‰é”ã€‚è°ƒç”¨äº†wait()æ–¹æ³•ä»¥åï¼Œé”å°±ä¼šè¢«é‡Šæ”¾ï¼Œè¿›å…¥é”çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œæ–¹æ³•è¿”å›åé‡æ–°æ‹¿åˆ°é” notify()ï¼šè°ƒåŠ¨æ–¹æ³•ä¹‹å‰ï¼Œå¿…é¡»è¦æŒæœ‰é”ï¼Œè°ƒç”¨notify()æ–¹æ³•æœ¬èº«ä¸ä¼šé‡Šæ”¾é”çš„ã€‚è€Œæ˜¯é€šçŸ¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æŸä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ­¥ä»£ç å—æ‰§è¡Œå®Œæ¯•åæ‰ä¼šé‡Šæ”¾é” notifyAll()ï¼šåŒnotifyï¼Œæœ‰ä¸€ç‚¹ä¸åŒåœ¨äºï¼ŒnotifyAllä¼šå‘å‡ºnä¸ªä¿¡å·ï¼ˆn=ç­‰å¾…çº¿ç¨‹æ•°ï¼‰ï¼Œè€Œnotifyåªä¼šå‘å‡ºä¸€ä¸ªä¿¡å·ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œå°½é‡é€‰æ‹©notifyAll 11.join()å‡½æ•°ä½œç”¨ï¼Ÿ çº¿ç¨‹Aï¼Œæ‰§è¡Œäº†çº¿ç¨‹Bçš„joinæ–¹æ³•ï¼Œçº¿ç¨‹Aå¿…é¡»è¦ç­‰å¾…Bæ‰§è¡Œå®Œæˆäº†ä»¥åï¼Œçº¿ç¨‹Aæ‰èƒ½ç»§ç»­è‡ªå·±çš„å·¥ä½œ 12.sleep å’Œ wait å“ªä¸ªå‡½æ•°æ‰ä¼šæ¸…é™¤interruptä¸­æ–­æ ‡è®°ï¼Ÿ sleep åœ¨æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼Œæ•è·å¼‚å¸¸ä¹‹å‰å°±å·²ç»æ¸…é™¤ä¸­æ–­æ ‡è®°ã€‚ é”ã€å¤šçº¿ç¨‹ã€å”¤é†’æœºåˆ¶ 13ï¼æœ‰å‡ ç§æ–°å¯çº¿ç¨‹çš„æ–¹å¼ï¼Ÿ(ä¸¤ç§) 1.ç»§æ‰¿Threadç±» 2.å®ç°Runnableæ¥å£ å®ç°Callable ä¸¥æ ¼æ„ä¹‰ä¸Šä¸ç®—ã€‚å®ç°Callableçš„æ¥å£å¯¹è±¡ä¼šå°è£…åˆ°FutureTaskã€‚FutureTaskå®ç°RunnableFutureã€‚RunnableFuture æ¥å£ç»§æ‰¿äº†Runnableå’ŒFutureæ¥å£ã€‚ çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ? \\1. åˆå§‹ NEW \\2. è¿è¡Œ RUNNING \\3. å°±ç»ª REDAY \\4. ç­‰å¾… WAITING \\5. é˜»å¡ BLOCK \\6. ç»ˆæ­¢ TERMINATED è¿è¡Œï¼šè·å–åˆ°æ—¶é—´ç‰‡cpuè°ƒåº¦ã€‚ è°ƒç”¨waitè¿›å…¥ç­‰å¾… è°ƒç”¨notifyå”¤é†’ è°ƒç”¨synchronizedä¿®é¥°çš„æ–¹æ³•ä¸­ï¼Œæœªè·å–åˆ°é” è¿›å…¥é˜»å¡çŠ¶æ€ è°ƒç”¨sleepè¿›å…¥ç­‰å¾…æ€ è°ƒç”¨lockæ²¡æœ‰æ‹¿åˆ°é”ï¼Œè¿›å…¥é˜»å¡æ€ï¼Ÿä¸ä¼šï¼åªæ˜¯è¿›å…¥ç­‰å¾…ã€ç­‰å¾…è¶…æ—¶ã€‚ åªæœ‰åœ¨synchronizedä¿®é¥°æ‰ä¼šè¿›å…¥é˜»å¡æ€ã€‚ é”æ¦‚å¿µ æœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ï¼ŒåŠ é”åï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è¿›å…¥ã€‚ synchronized éšå¼é” å¯é‡å…¥é” å†…éƒ¨ä¼šå®Œæˆ é”å®šè§£é”åº•å±‚é€»è¾‘ã€‚JDKå†…ç½®é” æ— æ³•ä¿®æ”¹ã€‚éœ€è¦å…³é”®å­— synchronized lock æ˜¾å¼é” å¯ä»¥æ‰‹åŠ¨æ§åˆ¶é”å®šè§£é” å”¤é†’æœºåˆ¶ ç­‰å¾…åŒºåŸŸ:wait() è·å–å¯¹è±¡çš„é”ğŸ”’ synchronized(å¯¹è±¡é”){ wait() //é‡Šæ”¾é” } é€šçŸ¥åŒºåŸŸ:notify() è·å–å¯¹è±¡çš„é”ğŸ”’ synchronized(å¯¹è±¡é”){ notify() } æ­»é” æ­»é”æ˜¯æŒ‡ ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”¨äºå½¼æ­¤é€šä¿¡é€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œä»–ä»¬ éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ã€‚ æ¡ä»¶ 1.å¤šä¸ªæ“ä½œè€…(M&gt;=2)äº‰å¤ºå¤šä¸ªèµ„æº(N&gt;=2) (N&lt;=M) 2.äº‰å¤ºèµ„æºçš„é¡ºåºä¸å¯¹ 3.æ‹¿åˆ°èµ„æºä¸æ”¾æ‰‹ è§„èŒƒ 1.äº’æ–¥æ¡ä»¶ 2.è¯·æ±‚å’Œä¿æŒ 3.ä¸å‰¥å¤º 4.å¾ªç¯ æ­»é”è§£å†³ï¼Œè§„å®šäº‰å¤ºèµ„æºçš„é¡ºåºï¼Œlock.tryå°è¯•æ‹¿é”ã€‚ æ´»é” çº¿ç¨‹Aã€B é” 1ã€2 çº¿ç¨‹A æŒæœ‰é”1 æƒ³ è·å–é”2 å‘ç°çº¿ç¨‹BæŒæœ‰é”2 é‡Šæ”¾æ‰€æœ‰é” é‡å¤ æŒæœ‰é”1 æƒ³ è·å–é”2 çº¿ç¨‹B æŒæœ‰é”2 æƒ³ è·å–é”1 å‘ç°çº¿ç¨‹AæŒæœ‰é”1 é‡Šæ”¾æ‰€æœ‰é” é‡å¤ æŒæœ‰é”2 æƒ³ è·å–é”1 ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ä¸åœå·¥ä½œã€‚ é”é¥¥é¥¿ ThreadLocal è‡ªå®šä¹‰å­˜åœ¨é—®é¢˜ã€‚ mapå­˜åœ¨ç«äº‰ã€‚ ThreadLocal å®ç°åŸç†ï¼Ÿ thread å˜é‡ class Thread{//æŒæœ‰ThreadLocal.ThreadLocalMap æˆå‘˜å˜é‡ } class ThreadLocalMap{//æŒæœ‰ä¸€ä¸ªEntry[]æ•°ç»„ Entry[] table } class Entry{//æ¯ä¸ªå…ƒç´ ï¼ŒæŒæœ‰ThreadLocal Object value ThreadLocal&lt;?&gt; k , Object v } CASåŸºæœ¬åŸç† Compare And Swap æ¯”è¾ƒå’Œäº¤æ¢ CASåŸç† åˆ©ç”¨ç°ä»£å¤„ç†å™¨éƒ½æ”¯æŒCASçš„æŒ‡ä»¤ å¾ªç¯è¿™ä¸ªæŒ‡ä»¤ï¼ŒçŸ¥é“æˆåŠŸä¸ºæ­¢ æ‰§è¡Œæµç¨‹ 1.getå˜é‡å€¼(æ—§å€¼) 2.è®¡ç®—åå¾—åˆ°æ–°å€¼ 3.compareå†…å­˜ä¸­å˜é‡å€¼å’Œæ—§å€¼ 4.ç›¸ç­‰ æ—§å€¼swapä¸ºæ–°å€¼ 5.ä¸ç›¸ç­‰ é‡å¤æ“ä½œ CASé—®é¢˜ ABAé—®é¢˜ å¼€é”€é—®é¢˜ åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ Atomic åŸå­å˜é‡ç±»ã€‚cas æ“ä½œ å¦‚ä½•å®ç°åŸå­æ“ä½œï¼Ÿ 1.synchronized 2.compare and swap(è½»é‡çº§) æ‚²è§‚é”(synchronized) ä¹è§‚é”(cas) synchronizedæ‰§è¡Œæ—¶ï¼Œé˜»å¡æ—¶ä¼šä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œéå¸¸è€—æ—¶ã€‚ cas ä¸ä¼šè¿›å…¥é˜»å¡ ABAé—®é¢˜ çº¿ç¨‹1 Aâ€“&gt;B çº¿ç¨‹æ‰§è¡ŒAâ€“&gt;B çº¿ç¨‹2 Aâ€“&gt;Câ€“&gt;A è§£å†³ABAé—®é¢˜ ç‰ˆæœ¬æˆ³ AtomicReference AtomicMarkableReference(æ˜¯å¦æ”¹åŠ¨) AtomicStampedReference(æ˜¯å¦æ”¹åŠ¨ï¼Œæ”¹åŠ¨æ¬¡æ•°) AtomicReference è§£å†³åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œï¼Œå¯ä»¥æ”¯æŒæ”¹ä¸¤ä¸ªå˜é‡ã€‚ CAS æ¯”è¾ƒäº¤æ¢æ“ä½œ ä¸ºåŸå­æ“ä½œï¼Œç”±CPUä¿è¯ã€‚ çº¿ç¨‹æ±  AsynTaskå†…éƒ¨ çº¿ç¨‹æ±  æ„é€ å‡½æ•°å„ä¸ªå‚æ•°çš„å«ä¹‰ï¼Ÿ CorePoolSize æ ¸å¿ƒçº¿ç¨‹æ•° maximumPoolSize æœ€å¤§çº¿ç¨‹æ•° keepAliveTime å­˜æ´»æ—¶é—´ TimeUnit ThreadFactory BlockingQueue è¶…è¿‡çš„çº¿ç¨‹è¿›å…¥é˜»å¡é˜Ÿåˆ— RejectedExecutionHandler é»˜è®¤æ‹’ç»ç­–ç•¥ \\1. AbortPolicy ç›´æ¥æŠ›å‡ºå¼‚å¸¸(é»˜è®¤) \\2. DiscardPolicy æŠŠæœ€æ–°æäº¤çš„ä»»åŠ¡åºŸå¼ƒ \\3. CallerRunsPolicy è®©è°ƒç”¨è€…çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ \\4. DiscardOldestPolicy ç›´æ¥ä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€è€çš„ keepAliveTime TimeUnit æ ¹æ®è¿™ä¸¤ä¸ªå‚æ•°æ¥æ§åˆ¶çº¿ç¨‹çš„å­˜æ´»æ—¶é—´ï¼Œçº¿ç¨‹æ± è¶…è¿‡æ•°å€¼å°±ä¼šé”€æ¯ã€‚ ä»€ä¹ˆæ˜¯çº¿ç¨‹æ± ï¼Ÿä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼Ÿ Thread çº¿ç¨‹ æ“ä½œç³»ç»Ÿ T1ï¼šåˆ›å»º T2ï¼šä»»åŠ¡æ‰§è¡Œ T3ï¼šé”€æ¯ ä¸ºäº†ç»Ÿä¸€ç®¡ç†ï¼ŒèŠ‚çœå†…å­˜ã€‚ç”¨åˆ°çº¿ç¨‹æ± ã€‚ \\1. çº¿ç¨‹æ± çš„åˆ›å»º \\2. æäº¤ä»»åŠ¡ \\3. å…³é—­çº¿ç¨‹æ±  Excute Submit futureTask æœ‰è¿”å›å€¼ Shutdownå°è¯•å…³é—­çº¿ç¨‹æ± ï¼Œæ²¡æœ‰æ‰§è¡Œçš„ ShutdownNow çº¿ç¨‹çš„ä¸­æ–­ï¼Œåä½œæœºåˆ¶ åˆç†é…ç½®çº¿ç¨‹ ä»»åŠ¡ç‰¹æ€§ï¼š CPUå¯†é›†å‹ æœºå™¨çš„æ ¸å¿ƒæ•° ç£ç›˜è™šæ‹Ÿå†…å­˜ æœ€å¤š+1 å¯èƒ½ä¼šäº§ç”Ÿé¡µç¼ºå¤±ï¼Œä¸ºä¿è¯cpuè·‘æ»¡+1 IOå¯†é›†å‹ æœºå™¨çš„æ ¸å¿ƒæ•°*2 æ··åˆå‹ JDKä¸­çš„çº¿ç¨‹æ± å·¥ä½œåŸç†ï¼Ÿ åˆ›å»ºçº¿ç¨‹æ± å€¼åï¼Œä¼šæ ¹æ®CorePoolSizeåˆ›å»ºå‡ºçº¿ç¨‹ ï¼Œå½“æœ‰æäº¤ä»»åŠ¡ï¼ŒCorePoolé‡Œè¾¹ä¼šæ‰§è¡Œä»»åŠ¡ï¼Œå½“çº¿ç¨‹éƒ½åœ¨å ç”¨ï¼Œç»§ç»­æœ‰ä»»åŠ¡æäº¤ï¼Œè¶…å‡ºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œä¼šåˆ›å»ºæ–°çº¿ç¨‹å¹¶æ·»åŠ åˆ°BlockingQueueé˜»å¡é˜Ÿåˆ—ä¸­ã€‚å½“é˜»å¡é˜Ÿåˆ—ä¸­ä¹Ÿæ»¡äº†ï¼Œæ ¹æ®maximumPoolç»§ç»­åˆ›å»ºçº¿ç¨‹æ‰§è¡Œã€‚å½“çº¿ç¨‹æ•°è¶…å‡ºmaximumPoolå¤§å°ï¼Œä½¿ç”¨æ‹’ç»ç­–ç•¥ã€‚ DMA ä¸­æ–­ OS é›¶æ‹·è´ æ§åˆ¶å™¨ OS å†…æ ¸ç©ºé—´ ç”¨æˆ·ç©ºé—´ mmap directmeory Javaå¹¶å‘åŸºç¡€çŸ¥è¯†è¡¥å…¨å¯åŠ¨å¯åŠ¨çº¿ç¨‹çš„æ–¹å¼åªæœ‰ï¼š 1ã€X extends Thread;ï¼Œç„¶åX.start 2ã€X implements Runnableï¼›ç„¶åäº¤ç»™Threadè¿è¡Œ çº¿ç¨‹çš„çŠ¶æ€Javaä¸­çº¿ç¨‹çš„çŠ¶æ€åˆ†ä¸º6ç§ï¼š \\1. åˆå§‹(NEW)ï¼šæ–°åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œä½†è¿˜æ²¡æœ‰è°ƒç”¨start()æ–¹æ³•ã€‚ \\2. è¿è¡Œ(RUNNABLE)ï¼šJavaçº¿ç¨‹ä¸­å°†å°±ç»ªï¼ˆreadyï¼‰å’Œè¿è¡Œä¸­ï¼ˆrunningï¼‰ä¸¤ç§çŠ¶æ€ç¬¼ç»Ÿçš„ç§°ä¸ºâ€œè¿è¡Œâ€ã€‚ çº¿ç¨‹å¯¹è±¡åˆ›å»ºåï¼Œå…¶ä»–çº¿ç¨‹(æ¯”å¦‚mainçº¿ç¨‹ï¼‰è°ƒç”¨äº†è¯¥å¯¹è±¡çš„start()æ–¹æ³•ã€‚è¯¥çŠ¶æ€çš„çº¿ç¨‹ä½äºå¯è¿è¡Œçº¿ç¨‹æ± ä¸­ï¼Œç­‰å¾…è¢«çº¿ç¨‹è°ƒåº¦é€‰ä¸­ï¼Œè·å–CPUçš„ä½¿ç”¨æƒï¼Œæ­¤æ—¶å¤„äºå°±ç»ªçŠ¶æ€ï¼ˆreadyï¼‰ã€‚å°±ç»ªçŠ¶æ€çš„çº¿ç¨‹åœ¨è·å¾—CPUæ—¶é—´ç‰‡åå˜ä¸ºè¿è¡Œä¸­çŠ¶æ€ï¼ˆrunningï¼‰ã€‚ \\3. é˜»å¡(BLOCKED)ï¼šè¡¨ç¤ºçº¿ç¨‹é˜»å¡äºé”ã€‚ \\4. ç­‰å¾…(WAITING)ï¼šè¿›å…¥è¯¥çŠ¶æ€çš„çº¿ç¨‹éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹åšå‡ºä¸€äº›ç‰¹å®šåŠ¨ä½œï¼ˆé€šçŸ¥æˆ–ä¸­æ–­ï¼‰ã€‚1 \\5. è¶…æ—¶ç­‰å¾…(TIMED_WAITING)ï¼šè¯¥çŠ¶æ€ä¸åŒäºWAITINGï¼Œå®ƒå¯ä»¥åœ¨æŒ‡å®šçš„æ—¶é—´åè‡ªè¡Œè¿”å›ã€‚ \\6. ç»ˆæ­¢(TERMINATED)ï¼šè¡¨ç¤ºè¯¥çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚ çŠ¶æ€ä¹‹é—´çš„å˜è¿å¦‚ä¸‹å›¾æ‰€ç¤º æ­»é”æ¦‚å¿µæ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç”±äºç«äº‰èµ„æºæˆ–è€…ç”±äºå½¼æ­¤é€šä¿¡è€Œé€ æˆçš„ä¸€ç§é˜»å¡çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚æ­¤æ—¶ç§°ç³»ç»Ÿå¤„äºæ­»é”çŠ¶æ€æˆ–ç³»ç»Ÿäº§ç”Ÿäº†æ­»é”ã€‚ ä¸¾ä¸ªä¾‹å­ï¼šAå’ŒBå»æŒ‰æ‘©æ´—è„šï¼Œéƒ½æƒ³åœ¨æ´—è„šçš„æ—¶å€™ï¼ŒåŒæ—¶é¡ºä¾¿åšä¸ªå¤´éƒ¨æŒ‰æ‘©ï¼Œ13æŠ€å¸ˆæ“…é•¿è¶³åº•æŒ‰æ‘©ï¼Œ14æ“…é•¿å¤´éƒ¨æŒ‰æ‘©ã€‚ è¿™ä¸ªæ—¶å€™Aå…ˆæŠ¢åˆ°14ï¼ŒBå…ˆæŠ¢åˆ°13ï¼Œä¸¤ä¸ªäººéƒ½æƒ³åŒæ—¶æ´—è„šå’Œå¤´éƒ¨æŒ‰æ‘©ï¼Œäºæ˜¯å°±äº’ä¸ç›¸è®©ï¼Œæ‰¬è¨€æˆ‘æ­»ä¹Ÿä¸è®©ä½ ï¼Œè¿™æ ·çš„è¯ï¼ŒAæŠ¢åˆ°14ï¼Œæƒ³è¦13ï¼ŒBæŠ¢åˆ°13ï¼Œæƒ³è¦14ï¼Œåœ¨è¿™ä¸ªæƒ³åŒæ—¶æ´—è„šå’Œå¤´éƒ¨æŒ‰æ‘©çš„äº‹æƒ…ä¸ŠAå’ŒBå°±äº§ç”Ÿäº†æ­»é”ã€‚æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ ç¬¬ä¸€ç§ï¼Œå‡å¦‚è¿™ä¸ªæ—¶å€™ï¼Œæ¥äº†ä¸ª15ï¼Œåˆšå¥½ä¹Ÿæ˜¯æ“…é•¿å¤´éƒ¨æŒ‰æ‘©çš„ï¼ŒAåˆæ²¡æœ‰ä¸¤ä¸ªè„‘è¢‹ï¼Œè‡ªç„¶å°±å½’äº†Bï¼Œäºæ˜¯Bå°±ç¾æ»‹æ»‹çš„æ´—è„šå’Œåšå¤´éƒ¨æŒ‰æ‘©ï¼Œå‰©ä¸‹Aåœ¨æ—è¾¹æ°”é¼“é¼“çš„ï¼Œè¿™ä¸ªæ—¶å€™æ­»é”è¿™ç§æƒ…å†µå°±è¢«æ‰“ç ´äº†ï¼Œä¸å­˜åœ¨äº†ã€‚ ç¬¬äºŒç§ï¼ŒCå‡ºåœºäº†ï¼Œç”¨æ­¦åŠ›å¼ºè¿«Aå’ŒBï¼Œå¿…é¡»å…ˆåšæ´—è„šï¼Œå†å¤´éƒ¨æŒ‰æ‘©ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒAå’ŒBè°å…ˆæŠ¢åˆ°13ï¼Œè°å°±å¯ä»¥è¿›è¡Œä¸‹å»ï¼Œå¦å¤–ä¸€ä¸ªæ²¡æŠ¢åˆ°çš„ï¼Œå°±ç­‰ç€ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿæ­»é”ã€‚ æ‰€ä»¥æ€»ç»“ä¸€ä¸‹ï¼š æ­»é”æ˜¯å¿…ç„¶å‘ç”Ÿåœ¨å¤šæ“ä½œè€…ï¼ˆM&gt;=2ä¸ªï¼‰æƒ…å†µä¸‹ï¼Œäº‰å¤ºå¤šä¸ªèµ„æºï¼ˆN&gt;=2ä¸ªï¼Œä¸”N&lt;=Mï¼‰æ‰ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚å¾ˆæ˜æ˜¾ï¼Œå•çº¿ç¨‹è‡ªç„¶ä¸ä¼šæœ‰æ­»é”ï¼Œåªæœ‰Bä¸€ä¸ªå»ï¼Œä¸è¦2ä¸ªï¼Œæ‰“åä¸ªéƒ½æ²¡é—®é¢˜ï¼›å•èµ„æºå‘¢ï¼Ÿåªæœ‰13ï¼ŒAå’ŒBä¹Ÿåªä¼šäº§ç”Ÿæ¿€çƒˆç«äº‰ï¼Œæ‰“å¾—ä¸å¯å¼€äº¤ï¼Œè°æŠ¢åˆ°å°±æ˜¯è°çš„ï¼Œä½†ä¸ä¼šäº§ç”Ÿæ­»é”ã€‚åŒæ—¶ï¼Œæ­»é”è¿˜æœ‰å‡ ä¸ªè¦æ±‚ï¼Œ1ã€äº‰å¤ºèµ„æºçš„é¡ºåºä¸å¯¹ï¼Œå¦‚æœäº‰å¤ºèµ„æºçš„é¡ºåºæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿæ­»é”ï¼› 2ã€äº‰å¤ºè€…æ‹¿åˆ°èµ„æºä¸æ”¾æ‰‹ã€‚ å­¦æœ¯åŒ–çš„å®šä¹‰æ­»é”çš„å‘ç”Ÿå¿…é¡»å…·å¤‡ä»¥ä¸‹å››ä¸ªå¿…è¦æ¡ä»¶ã€‚ 1ï¼‰äº’æ–¥æ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å¯¹æ‰€åˆ†é…åˆ°çš„èµ„æºè¿›è¡Œæ’å®ƒæ€§ä½¿ç”¨ï¼Œå³åœ¨ä¸€æ®µæ—¶é—´å†…æŸèµ„æºåªç”±ä¸€ä¸ªè¿›ç¨‹å ç”¨ã€‚å¦‚æœæ­¤æ—¶è¿˜æœ‰å…¶å®ƒè¿›ç¨‹è¯·æ±‚èµ„æºï¼Œåˆ™è¯·æ±‚è€…åªèƒ½ç­‰å¾…ï¼Œç›´è‡³å æœ‰èµ„æºçš„è¿›ç¨‹ç”¨æ¯•é‡Šæ”¾ã€‚ 2ï¼‰è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å·²ç»ä¿æŒè‡³å°‘ä¸€ä¸ªèµ„æºï¼Œä½†åˆæå‡ºäº†æ–°çš„èµ„æºè¯·æ±‚ï¼Œè€Œè¯¥èµ„æºå·²è¢«å…¶å®ƒè¿›ç¨‹å æœ‰ï¼Œæ­¤æ—¶è¯·æ±‚è¿›ç¨‹é˜»å¡ï¼Œä½†åˆå¯¹è‡ªå·±å·²è·å¾—çš„å…¶å®ƒèµ„æºä¿æŒä¸æ”¾ã€‚ 3ï¼‰ä¸å‰¥å¤ºæ¡ä»¶ï¼šæŒ‡è¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½è¢«å‰¥å¤ºï¼Œåªèƒ½åœ¨ä½¿ç”¨å®Œæ—¶ç”±è‡ªå·±é‡Šæ”¾ã€‚ 4ï¼‰ç¯è·¯ç­‰å¾…æ¡ä»¶ï¼šæŒ‡åœ¨å‘ç”Ÿæ­»é”æ—¶ï¼Œå¿…ç„¶å­˜åœ¨ä¸€ä¸ªè¿›ç¨‹â€”â€”èµ„æºçš„ç¯å½¢é“¾ï¼Œå³è¿›ç¨‹é›†åˆ{P0ï¼ŒP1ï¼ŒP2ï¼ŒÂ·Â·Â·ï¼ŒPn}ä¸­çš„P0æ­£åœ¨ç­‰å¾…ä¸€ä¸ªP1å ç”¨çš„èµ„æºï¼›P1æ­£åœ¨ç­‰å¾…P2å ç”¨çš„èµ„æºï¼Œâ€¦â€¦ï¼ŒPnæ­£åœ¨ç­‰å¾…å·²è¢«P0å ç”¨çš„èµ„æºã€‚ ç†è§£äº†æ­»é”çš„åŸå› ï¼Œå°¤å…¶æ˜¯äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼Œå°±å¯ä»¥æœ€å¤§å¯èƒ½åœ°é¿å…ã€é¢„é˜²å’Œè§£é™¤æ­»é”ã€‚ åªè¦æ‰“ç ´å››ä¸ªå¿…è¦æ¡ä»¶ä¹‹ä¸€å°±èƒ½æœ‰æ•ˆé¢„é˜²æ­»é”çš„å‘ç”Ÿã€‚ æ‰“ç ´äº’æ–¥æ¡ä»¶ï¼šæ”¹é€ ç‹¬å æ€§èµ„æºä¸ºè™šæ‹Ÿèµ„æºï¼Œå¤§éƒ¨åˆ†èµ„æºå·²æ— æ³•æ”¹é€ ã€‚ æ‰“ç ´ä¸å¯æŠ¢å æ¡ä»¶ï¼šå½“ä¸€è¿›ç¨‹å æœ‰ä¸€ç‹¬å æ€§èµ„æºååˆç”³è¯·ä¸€ç‹¬å æ€§èµ„æºè€Œæ— æ³•æ»¡è¶³ï¼Œåˆ™é€€å‡ºåŸå æœ‰çš„èµ„æºã€‚ æ‰“ç ´å æœ‰ä¸”ç”³è¯·æ¡ä»¶ï¼šé‡‡ç”¨èµ„æºé¢„å…ˆåˆ†é…ç­–ç•¥ï¼Œå³è¿›ç¨‹è¿è¡Œå‰ç”³è¯·å…¨éƒ¨èµ„æºï¼Œæ»¡è¶³åˆ™è¿è¡Œï¼Œä¸ç„¶å°±ç­‰å¾…ï¼Œè¿™æ ·å°±ä¸ä¼šå æœ‰ä¸”ç”³è¯·ã€‚ æ‰“ç ´å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šå®ç°èµ„æºæœ‰åºåˆ†é…ç­–ç•¥ï¼Œå¯¹æ‰€æœ‰è®¾å¤‡å®ç°åˆ†ç±»ç¼–å·ï¼Œæ‰€æœ‰è¿›ç¨‹åªèƒ½é‡‡ç”¨æŒ‰åºå·é€’å¢çš„å½¢å¼ç”³è¯·èµ„æºã€‚ é¿å…æ­»é”å¸¸è§çš„ç®—æ³•æœ‰æœ‰åºèµ„æºåˆ†é…æ³•ã€é“¶è¡Œå®¶ç®—æ³•ã€‚ å±å®³1ã€çº¿ç¨‹ä¸å·¥ä½œäº†ï¼Œä½†æ˜¯æ•´ä¸ªç¨‹åºè¿˜æ˜¯æ´»ç€çš„2ã€æ²¡æœ‰ä»»ä½•çš„å¼‚å¸¸ä¿¡æ¯å¯ä»¥ä¾›æˆ‘ä»¬æ£€æŸ¥ã€‚3ã€ä¸€æ—¦ç¨‹åºå‘ç”Ÿäº†å‘ç”Ÿäº†æ­»é”ï¼Œæ˜¯æ²¡æœ‰ä»»ä½•çš„åŠæ³•æ¢å¤çš„ï¼Œåªèƒ½é‡å¯ç¨‹åºï¼Œå¯¹æ­£å¼å·²å‘å¸ƒç¨‹åºæ¥è¯´ï¼Œè¿™æ˜¯ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ã€‚ è§£å†³å…³é”®æ˜¯ä¿è¯æ‹¿é”çš„é¡ºåºä¸€è‡´ ä¸¤ç§è§£å†³æ–¹å¼ 1ã€ å†…éƒ¨é€šè¿‡é¡ºåºæ¯”è¾ƒï¼Œç¡®å®šæ‹¿é”çš„é¡ºåºï¼› 2ã€é‡‡ç”¨å°è¯•æ‹¿é”çš„æœºåˆ¶ã€‚ å…¶ä»–çº¿ç¨‹å®‰å…¨é—®é¢˜æ´»é”ä¸¤ä¸ªçº¿ç¨‹åœ¨å°è¯•æ‹¿é”çš„æœºåˆ¶ä¸­ï¼Œå‘ç”Ÿå¤šä¸ªçº¿ç¨‹ä¹‹é—´äº’ç›¸è°¦è®©ï¼Œä¸æ–­å‘ç”ŸåŒä¸€ä¸ªçº¿ç¨‹æ€»æ˜¯æ‹¿åˆ°åŒä¸€æŠŠé”ï¼Œåœ¨å°è¯•æ‹¿å¦ä¸€æŠŠé”æ—¶å› ä¸ºæ‹¿ä¸åˆ°ï¼Œè€Œå°†æœ¬æ¥å·²ç»æŒæœ‰çš„é”é‡Šæ”¾çš„è¿‡ç¨‹ã€‚ è§£å†³åŠæ³•ï¼šæ¯ä¸ªçº¿ç¨‹ä¼‘çœ éšæœºæ•°ï¼Œé”™å¼€æ‹¿é”çš„æ—¶é—´ã€‚ çº¿ç¨‹é¥¥é¥¿ä½ä¼˜å…ˆçº§çš„çº¿ç¨‹ï¼Œæ€»æ˜¯æ‹¿ä¸åˆ°æ‰§è¡Œæ—¶é—´ ThreadLocalè¾¨æä¸Synchonizedçš„æ¯”è¾ƒThreadLocalå’ŒSynchonizedéƒ½ç”¨äºè§£å†³å¤šçº¿ç¨‹å¹¶å‘è¨ªé—®ã€‚å¯æ˜¯ThreadLocalä¸synchronizedæœ‰æœ¬è´¨çš„å·®åˆ«ã€‚synchronizedæ˜¯åˆ©ç”¨é”çš„æœºåˆ¶ï¼Œä½¿å˜é‡æˆ–ä»£ç å—åœ¨æŸä¸€æ—¶è¯¥ä»…ä»…èƒ½è¢«ä¸€ä¸ªçº¿ç¨‹è¨ªé—®ã€‚è€ŒThreadLocalä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›äº†å˜é‡çš„å‰¯æœ¬ï¼Œä½¿å¾—æ¯ä¸ªçº¿ç¨‹åœ¨æŸä¸€æ—¶é—´è¨ªé—®åˆ°çš„å¹¶éåŒä¸€ä¸ªå¯¹è±¡ï¼Œè¿™æ ·å°±éš”ç¦»äº†å¤šä¸ªçº¿ç¨‹å¯¹æ•°æ®çš„æ•°æ®å…±äº«ã€‚ ThreadLocalçš„ä½¿ç”¨ThreadLocalç±»æ¥å£å¾ˆç®€å•ï¼Œåªæœ‰4ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ï¼š â€¢ void set(Object value) è®¾ç½®å½“å‰çº¿ç¨‹çš„çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼ã€‚ â€¢ public Object get() è¯¥æ–¹æ³•è¿”å›å½“å‰çº¿ç¨‹æ‰€å¯¹åº”çš„çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚ â€¢ public void remove() å°†å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„å€¼åˆ é™¤ï¼Œç›®çš„æ˜¯ä¸ºäº†å‡å°‘å†…å­˜çš„å ç”¨ï¼Œè¯¥æ–¹æ³•æ˜¯JDK 5.0æ–°å¢çš„æ–¹æ³•ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œå½“çº¿ç¨‹ç»“æŸåï¼Œå¯¹åº”è¯¥çº¿ç¨‹çš„å±€éƒ¨å˜é‡å°†è‡ªåŠ¨è¢«åƒåœ¾å›æ”¶ï¼Œæ‰€ä»¥æ˜¾å¼è°ƒç”¨è¯¥æ–¹æ³•æ¸…é™¤çº¿ç¨‹çš„å±€éƒ¨å˜é‡å¹¶ä¸æ˜¯å¿…é¡»çš„æ“ä½œï¼Œä½†å®ƒå¯ä»¥åŠ å¿«å†…å­˜å›æ”¶çš„é€Ÿåº¦ã€‚ â€¢ protected Object initialValue() è¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼ï¼Œè¯¥æ–¹æ³•æ˜¯ä¸€ä¸ªprotectedçš„æ–¹æ³•ï¼Œæ˜¾ç„¶æ˜¯ä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯ä¸€ä¸ªå»¶è¿Ÿè°ƒç”¨æ–¹æ³•ï¼Œåœ¨çº¿ç¨‹ç¬¬1æ¬¡è°ƒç”¨get()æˆ–set(Object)æ—¶æ‰æ‰§è¡Œï¼Œå¹¶ä¸”ä»…æ‰§è¡Œ1æ¬¡ã€‚ThreadLocalä¸­çš„ç¼ºçœå®ç°ç›´æ¥è¿”å›ä¸€ä¸ªnullã€‚ public final static ThreadLocal RESOURCE = new ThreadLocal();RESOURCEä»£è¡¨ä¸€ä¸ªèƒ½å¤Ÿå­˜æ”¾Stringç±»å‹çš„ThreadLocalå¯¹è±¡ã€‚æ­¤æ—¶ä¸è®ºä»€ä¹ˆä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿå¹¶å‘è®¿é—®è¿™ä¸ªå˜é‡ï¼Œå¯¹å®ƒè¿›è¡Œå†™å…¥ã€è¯»å–æ“ä½œï¼Œéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ å®ç°è§£æ ä¸Šé¢å…ˆå–åˆ°å½“å‰çº¿ç¨‹ï¼Œç„¶åè°ƒç”¨getMapæ–¹æ³•è·å–å¯¹åº”çš„ThreadLocalMapï¼ŒThreadLocalMapæ˜¯ThreadLocalçš„é™æ€å†…éƒ¨ç±»ï¼Œç„¶åThreadç±»ä¸­æœ‰ä¸€ä¸ªè¿™æ ·ç±»å‹æˆå‘˜ï¼Œæ‰€ä»¥getMapæ˜¯ç›´æ¥è¿”å›Threadçš„æˆå‘˜ã€‚ çœ‹ä¸‹ThreadLocalçš„å†…éƒ¨ç±»ThreadLocalMapæºç ï¼š å¯ä»¥çœ‹åˆ°æœ‰ä¸ªEntryå†…éƒ¨é™æ€ç±»ï¼Œå®ƒç»§æ‰¿äº†WeakReferenceï¼Œæ€»ä¹‹å®ƒè®°å½•äº†ä¸¤ä¸ªä¿¡æ¯ï¼Œä¸€ä¸ªæ˜¯ThreadLocal&lt;?&gt;ç±»å‹ï¼Œä¸€ä¸ªæ˜¯Objectç±»å‹çš„å€¼ã€‚getEntryæ–¹æ³•åˆ™æ˜¯è·å–æŸä¸ªThreadLocalå¯¹åº”çš„å€¼ï¼Œsetæ–¹æ³•å°±æ˜¯æ›´æ–°æˆ–èµ‹å€¼ç›¸åº”çš„ThreadLocalå¯¹åº”çš„å€¼ã€‚ å›é¡¾æˆ‘ä»¬çš„getæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯æ‹¿åˆ°æ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰çš„**ThreadLocalMap** ç„¶åå†ç”¨ThreadLocalçš„å½“å‰å®ä¾‹ï¼Œæ‹¿åˆ°Mapä¸­çš„ç›¸åº”çš„Entryï¼Œç„¶åå°±å¯ä»¥æ‹¿åˆ°ç›¸åº”çš„å€¼è¿”å›å‡ºå»ã€‚å½“ç„¶ï¼Œå¦‚æœMapä¸ºç©ºï¼Œè¿˜ä¼šå…ˆè¿›è¡Œmapçš„åˆ›å»ºï¼Œåˆå§‹åŒ–ç­‰å·¥ä½œã€‚ CASåŸºæœ¬åŸç†ä»€ä¹ˆæ˜¯åŸå­æ“ä½œï¼Ÿå¦‚ä½•å®ç°åŸå­æ“ä½œï¼Ÿå‡å®šæœ‰ä¸¤ä¸ªæ“ä½œAå’ŒB(Aå’ŒBå¯èƒ½éƒ½å¾ˆå¤æ‚)ï¼Œå¦‚æœä»æ‰§è¡ŒAçš„çº¿ç¨‹æ¥çœ‹ï¼Œå½“å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒBæ—¶ï¼Œè¦ä¹ˆå°†Bå…¨éƒ¨æ‰§è¡Œå®Œï¼Œè¦ä¹ˆå®Œå…¨ä¸æ‰§è¡ŒBï¼Œé‚£ä¹ˆAå’ŒBå¯¹å½¼æ­¤æ¥è¯´æ˜¯åŸå­çš„ã€‚ å®ç°åŸå­æ“ä½œå¯ä»¥ä½¿ç”¨é”ï¼Œé”æœºåˆ¶ï¼Œæ»¡è¶³åŸºæœ¬çš„éœ€æ±‚æ˜¯æ²¡æœ‰é—®é¢˜çš„äº†ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™æˆ‘ä»¬çš„éœ€æ±‚å¹¶éè¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦æ›´æœ‰æ•ˆï¼Œæ›´åŠ çµæ´»çš„æœºåˆ¶ï¼Œsynchronizedå…³é”®å­—æ˜¯åŸºäºé˜»å¡çš„é”æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´å½“ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰é”çš„æ—¶å€™ï¼Œè®¿é—®åŒä¸€èµ„æºçš„å…¶å®ƒçº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œç›´åˆ°è¯¥çº¿ç¨‹é‡Šæ”¾é”ï¼Œ è¿™é‡Œä¼šæœ‰äº›é—®é¢˜ï¼šé¦–å…ˆï¼Œå¦‚æœè¢«é˜»å¡çš„çº¿ç¨‹ä¼˜å…ˆçº§å¾ˆé«˜å¾ˆé‡è¦æ€ä¹ˆåŠï¼Ÿå…¶æ¬¡ï¼Œå¦‚æœè·å¾—é”çš„çº¿ç¨‹ä¸€ç›´ä¸é‡Šæ”¾é”æ€ä¹ˆåŠï¼Ÿï¼ˆè¿™ç§æƒ…å†µæ˜¯éå¸¸ç³Ÿç³•çš„ï¼‰ã€‚è¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå¦‚æœæœ‰å¤§é‡çš„çº¿ç¨‹æ¥ç«äº‰èµ„æºï¼Œé‚£CPUå°†ä¼šèŠ±è´¹å¤§é‡çš„æ—¶é—´å’Œèµ„æºæ¥å¤„ç†è¿™äº›ç«äº‰ï¼ŒåŒæ—¶ï¼Œè¿˜æœ‰å¯èƒ½å‡ºç°ä¸€äº›ä¾‹å¦‚æ­»é”ä¹‹ç±»çš„æƒ…å†µï¼Œæœ€åï¼Œå…¶å®é”æœºåˆ¶æ˜¯ä¸€ç§æ¯”è¾ƒç²—ç³™ï¼Œç²’åº¦æ¯”è¾ƒå¤§çš„æœºåˆ¶ï¼Œç›¸å¯¹äºåƒè®¡æ•°å™¨è¿™æ ·çš„éœ€æ±‚æœ‰ç‚¹å„¿è¿‡äºç¬¨é‡ã€‚ å®ç°åŸå­æ“ä½œè¿˜å¯ä»¥ä½¿ç”¨å½“å‰çš„å¤„ç†å™¨åŸºæœ¬éƒ½æ”¯æŒCAS()çš„æŒ‡ä»¤ï¼Œåªä¸è¿‡æ¯ä¸ªå‚å®¶æ‰€å®ç°çš„ç®—æ³•å¹¶ä¸ä¸€æ ·ï¼Œæ¯ä¸€ä¸ªCASæ“ä½œè¿‡ç¨‹éƒ½åŒ…å«ä¸‰ä¸ªè¿ç®—ç¬¦ï¼šä¸€ä¸ªå†…å­˜åœ°å€Vï¼Œä¸€ä¸ªæœŸæœ›çš„å€¼Aå’Œä¸€ä¸ªæ–°å€¼Bï¼Œæ“ä½œçš„æ—¶å€™å¦‚æœè¿™ä¸ªåœ°å€ä¸Šå­˜æ”¾çš„å€¼ç­‰äºè¿™ä¸ªæœŸæœ›çš„å€¼Aï¼Œåˆ™å°†åœ°å€ä¸Šçš„å€¼èµ‹ä¸ºæ–°å€¼Bï¼Œå¦åˆ™ä¸åšä»»ä½•æ“ä½œã€‚ CASçš„åŸºæœ¬æ€è·¯å°±æ˜¯ï¼Œå¦‚æœè¿™ä¸ªåœ°å€ä¸Šçš„å€¼å’ŒæœŸæœ›çš„å€¼ç›¸ç­‰ï¼Œåˆ™ç»™å…¶èµ‹äºˆæ–°å€¼ï¼Œå¦åˆ™ä¸åšä»»ä½•äº‹å„¿ï¼Œä½†æ˜¯è¦è¿”å›åŸå€¼æ˜¯å¤šå°‘ã€‚å¾ªç¯CASå°±æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯é‡Œä¸æ–­çš„åšcasæ“ä½œï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢ã€‚ CASå®ç°åŸå­æ“ä½œçš„ä¸‰å¤§é—®é¢˜ABAé—®é¢˜ã€‚å› ä¸ºCASéœ€è¦åœ¨æ“ä½œå€¼çš„æ—¶å€™ï¼Œæ£€æŸ¥å€¼æœ‰æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™æ›´æ–°ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªå€¼åŸæ¥æ˜¯Aï¼Œå˜æˆäº†Bï¼Œåˆå˜æˆäº†Aï¼Œé‚£ä¹ˆä½¿ç”¨CASè¿›è¡Œæ£€æŸ¥æ—¶ä¼šå‘ç°å®ƒçš„å€¼æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯å®é™…ä¸Šå´å˜åŒ–äº†ã€‚ ABAé—®é¢˜çš„è§£å†³æ€è·¯å°±æ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ã€‚åœ¨å˜é‡å‰é¢è¿½åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™æŠŠç‰ˆæœ¬å·åŠ 1ï¼Œé‚£ä¹ˆAâ†’Bâ†’Aå°±ä¼šå˜æˆ1Aâ†’2Bâ†’3Aã€‚ä¸¾ä¸ªé€šä¿—ç‚¹çš„ä¾‹å­ï¼Œä½ å€’äº†ä¸€æ¯æ°´æ”¾æ¡Œå­ä¸Šï¼Œå¹²äº†ç‚¹åˆ«çš„äº‹ï¼Œç„¶ååŒäº‹æŠŠä½ æ°´å–äº†åˆç»™ä½ é‡æ–°å€’äº†ä¸€æ¯æ°´ï¼Œä½ å›æ¥çœ‹æ°´è¿˜åœ¨ï¼Œæ‹¿èµ·æ¥å°±å–ï¼Œå¦‚æœä½ ä¸ç®¡æ°´ä¸­é—´è¢«äººå–è¿‡ï¼Œåªå…³å¿ƒæ°´è¿˜åœ¨ï¼Œè¿™å°±æ˜¯ABAé—®é¢˜ã€‚ å¦‚æœä½ æ˜¯ä¸€ä¸ªè®²å«ç”Ÿè®²æ–‡æ˜çš„å°ä¼™å­ï¼Œä¸ä½†å…³å¿ƒæ°´åœ¨ä¸åœ¨ï¼Œè¿˜è¦åœ¨ä½ ç¦»å¼€çš„æ—¶å€™æ°´è¢«äººåŠ¨è¿‡æ²¡æœ‰ï¼Œå› ä¸ºä½ æ˜¯ç¨‹åºå‘˜ï¼Œæ‰€ä»¥å°±æƒ³èµ·äº†æ”¾äº†å¼ çº¸åœ¨æ—è¾¹ï¼Œå†™ä¸Šåˆå§‹å€¼0ï¼Œåˆ«äººå–æ°´å‰éº»çƒ¦å…ˆåšä¸ªç´¯åŠ æ‰èƒ½å–æ°´ã€‚ å¾ªç¯æ—¶é—´é•¿å¼€é”€å¤§ã€‚è‡ªæ—‹CASå¦‚æœé•¿æ—¶é—´ä¸æˆåŠŸï¼Œä¼šç»™CPUå¸¦æ¥éå¸¸å¤§çš„æ‰§è¡Œå¼€é”€ã€‚ åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œã€‚å½“å¯¹ä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¾ªç¯CASçš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œï¼Œä½†æ˜¯å¯¹å¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯CASå°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨é”ã€‚ è¿˜æœ‰ä¸€ä¸ªå–å·§çš„åŠæ³•ï¼Œå°±æ˜¯æŠŠå¤šä¸ªå…±äº«å˜é‡åˆå¹¶æˆä¸€ä¸ªå…±äº«å˜é‡æ¥æ“ä½œã€‚æ¯”å¦‚ï¼Œæœ‰ä¸¤ä¸ªå…±äº«å˜é‡iï¼2ï¼Œj=aï¼Œåˆå¹¶ä¸€ä¸‹ij=2aï¼Œç„¶åç”¨CASæ¥æ“ä½œijã€‚ä»Java 1.5å¼€å§‹ï¼ŒJDKæä¾›äº†AtomicReferenceç±»æ¥ä¿è¯å¼•ç”¨å¯¹è±¡ä¹‹é—´çš„åŸå­æ€§ï¼Œå°±å¯ä»¥æŠŠå¤šä¸ªå˜é‡æ”¾åœ¨ä¸€ä¸ªå¯¹è±¡é‡Œæ¥è¿›è¡ŒCASæ“ä½œã€‚ Jdkä¸­ç›¸å…³åŸå­æ“ä½œç±»çš„ä½¿ç”¨AtomicIntegerâ€¢int addAndGetï¼ˆint deltaï¼‰ï¼šä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­çš„å€¼ï¼ˆAtomicIntegeré‡Œçš„valueï¼‰ç›¸åŠ ï¼Œå¹¶è¿”å›ç»“æœã€‚ â€¢boolean compareAndSetï¼ˆint expectï¼Œint updateï¼‰ï¼šå¦‚æœè¾“å…¥çš„æ•°å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†è¯¥å€¼è®¾ç½®ä¸ºè¾“å…¥çš„å€¼ã€‚ â€¢int getAndIncrement()ï¼šä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ 1ï¼Œæ³¨æ„ï¼Œè¿™é‡Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„å€¼ã€‚ â€¢int getAndSetï¼ˆint newValueï¼‰ï¼šä»¥åŸå­æ–¹å¼è®¾ç½®ä¸ºnewValueçš„å€¼ï¼Œå¹¶è¿”å›æ—§å€¼ã€‚ AtomicIntegerArrayä¸»è¦æ˜¯æä¾›åŸå­çš„æ–¹å¼æ›´æ–°æ•°ç»„é‡Œçš„æ•´å‹ï¼Œå…¶å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ã€‚ â€¢int addAndGetï¼ˆint iï¼Œint deltaï¼‰ï¼šä»¥åŸå­æ–¹å¼å°†è¾“å…¥å€¼ä¸æ•°ç»„ä¸­ç´¢å¼•içš„å…ƒç´ ç›¸åŠ ã€‚ â€¢boolean compareAndSetï¼ˆint iï¼Œint expectï¼Œint updateï¼‰ï¼šå¦‚æœå½“å‰å€¼ç­‰äºé¢„æœŸå€¼ï¼Œåˆ™ä»¥åŸå­æ–¹å¼å°†æ•°ç»„ä½ç½®içš„å…ƒç´ è®¾ç½®æˆupdateå€¼ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ•°ç»„valueé€šè¿‡æ„é€ æ–¹æ³•ä¼ é€’è¿›å»ï¼Œç„¶åAtomicIntegerArrayä¼šå°†å½“å‰æ•°ç»„å¤åˆ¶ä¸€ä»½ï¼Œæ‰€ä»¥å½“AtomicIntegerArrayå¯¹å†…éƒ¨çš„æ•°ç»„å…ƒç´ è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¸ä¼šå½±å“ä¼ å…¥çš„æ•°ç»„ã€‚ æ›´æ–°å¼•ç”¨ç±»å‹åŸå­æ›´æ–°åŸºæœ¬ç±»å‹çš„AtomicIntegerï¼Œåªèƒ½æ›´æ–°ä¸€ä¸ªå˜é‡ï¼Œå¦‚æœè¦åŸå­æ›´æ–°å¤šä¸ªå˜é‡ï¼Œå°±éœ€è¦ä½¿ç”¨è¿™ä¸ªåŸå­æ›´æ–°å¼•ç”¨ç±»å‹æä¾›çš„ç±»ã€‚AtomicåŒ…æä¾›äº†ä»¥ä¸‹3ä¸ªç±»ã€‚ AtomicReferenceåŸå­æ›´æ–°å¼•ç”¨ç±»å‹ã€‚ AtomicStampedReferenceåˆ©ç”¨ç‰ˆæœ¬æˆ³çš„å½¢å¼è®°å½•äº†æ¯æ¬¡æ”¹å˜ä»¥åçš„ç‰ˆæœ¬å·ï¼Œè¿™æ ·çš„è¯å°±ä¸ä¼šå­˜åœ¨ABAé—®é¢˜äº†ã€‚è¿™å°±æ˜¯AtomicStampedReferenceçš„è§£å†³æ–¹æ¡ˆã€‚AtomicMarkableReferenceè·ŸAtomicStampedReferenceå·®ä¸å¤šï¼Œ AtomicStampedReferenceæ˜¯ä½¿ç”¨pairçš„int stampä½œä¸ºè®¡æ•°å™¨ä½¿ç”¨ï¼ŒAtomicMarkableReferenceçš„pairä½¿ç”¨çš„æ˜¯boolean markã€‚ è¿˜æ˜¯é‚£ä¸ªæ°´çš„ä¾‹å­ï¼ŒAtomicStampedReferenceå¯èƒ½å…³å¿ƒçš„æ˜¯åŠ¨è¿‡å‡ æ¬¡ï¼ŒAtomicMarkableReferenceå…³å¿ƒçš„æ˜¯æœ‰æ²¡æœ‰è¢«äººåŠ¨è¿‡ï¼Œæ–¹æ³•éƒ½æ¯”è¾ƒç®€å•ã€‚ AtomicMarkableReferenceï¼šåŸå­æ›´æ–°å¸¦æœ‰æ ‡è®°ä½çš„å¼•ç”¨ç±»å‹ã€‚å¯ä»¥åŸå­æ›´æ–°ä¸€ä¸ªå¸ƒå°”ç±»å‹çš„æ ‡è®°ä½å’Œå¼•ç”¨ç±»å‹ã€‚æ„é€ æ–¹æ³•æ˜¯AtomicMarkableReferenceï¼ˆV initialRefï¼ŒbooleaninitialMarkï¼‰ã€‚ é˜»å¡é˜Ÿåˆ—å’Œçº¿ç¨‹æ± åŸç†é˜»å¡é˜Ÿåˆ—é˜Ÿåˆ— é˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„çº¿æ€§è¡¨ï¼Œç‰¹æ®Šä¹‹å¤„åœ¨äºå®ƒåªå…è®¸åœ¨è¡¨çš„å‰ç«¯ï¼ˆfrontï¼‰è¿›è¡Œåˆ é™¤æ“ä½œï¼Œè€Œåœ¨è¡¨çš„åç«¯ï¼ˆrearï¼‰è¿›è¡Œæ’å…¥æ“ä½œï¼Œå’Œæ ˆä¸€æ ·ï¼Œé˜Ÿåˆ—æ˜¯ä¸€ç§æ“ä½œå—é™åˆ¶çš„çº¿æ€§è¡¨ã€‚è¿›è¡Œæ’å…¥æ“ä½œçš„ç«¯ç§°ä¸ºé˜Ÿå°¾ï¼Œè¿›è¡Œåˆ é™¤æ“ä½œçš„ç«¯ç§°ä¸ºé˜Ÿå¤´ã€‚ åœ¨é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªé˜Ÿåˆ—å…ƒç´ ç§°ä¸ºå…¥é˜Ÿï¼Œä»é˜Ÿåˆ—ä¸­åˆ é™¤ä¸€ä¸ªé˜Ÿåˆ—å…ƒç´ ç§°ä¸ºå‡ºé˜Ÿã€‚å› ä¸ºé˜Ÿåˆ—åªå…è®¸åœ¨ä¸€ç«¯æ’å…¥ï¼Œåœ¨å¦ä¸€ç«¯åˆ é™¤ï¼Œæ‰€ä»¥åªæœ‰æœ€æ—©è¿›å…¥é˜Ÿåˆ—çš„å…ƒç´ æ‰èƒ½æœ€å…ˆä»é˜Ÿåˆ—ä¸­åˆ é™¤ï¼Œæ•…é˜Ÿåˆ—åˆç§°ä¸ºå…ˆè¿›å…ˆå‡ºï¼ˆFIFOâ€”first in first outï¼‰çº¿æ€§è¡¨ã€‚ ä»€ä¹ˆæ˜¯é˜»å¡é˜Ÿåˆ—1ï¼‰æ”¯æŒé˜»å¡çš„æ’å…¥æ–¹æ³•ï¼šæ„æ€æ˜¯å½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡æ’å…¥å…ƒç´ çš„çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸æ»¡ã€‚ 2ï¼‰æ”¯æŒé˜»å¡çš„ç§»é™¤æ–¹æ³•ï¼šæ„æ€æ˜¯åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œè·å–å…ƒç´ çš„çº¿ç¨‹ä¼šç­‰å¾…é˜Ÿåˆ—å˜ä¸ºéç©ºã€‚ åœ¨å¹¶å‘ç¼–ç¨‹ä¸­ä½¿ç”¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼èƒ½å¤Ÿè§£å†³ç»å¤§å¤šæ•°å¹¶å‘é—®é¢˜ã€‚è¯¥æ¨¡å¼é€šè¿‡å¹³è¡¡ç”Ÿäº§çº¿ç¨‹å’Œæ¶ˆè´¹çº¿ç¨‹çš„å·¥ä½œèƒ½åŠ›æ¥æé«˜ç¨‹åºæ•´ä½“å¤„ç†æ•°æ®çš„é€Ÿåº¦ã€‚ åœ¨çº¿ç¨‹ä¸–ç•Œé‡Œï¼Œç”Ÿäº§è€…å°±æ˜¯ç”Ÿäº§æ•°æ®çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…å°±æ˜¯æ¶ˆè´¹æ•°æ®çš„çº¿ç¨‹ã€‚åœ¨å¤šçº¿ç¨‹å¼€å‘ä¸­ï¼Œå¦‚æœç”Ÿäº§è€…å¤„ç†é€Ÿåº¦å¾ˆå¿«ï¼Œè€Œæ¶ˆè´¹è€…å¤„ç†é€Ÿåº¦å¾ˆæ…¢ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å°±å¿…é¡»ç­‰å¾…æ¶ˆè´¹è€…å¤„ç†å®Œï¼Œæ‰èƒ½ç»§ç»­ç”Ÿäº§æ•°æ®ã€‚åŒæ ·çš„é“ç†ï¼Œå¦‚æœæ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›å¤§äºç”Ÿäº§è€…ï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…å°±å¿…é¡»ç­‰å¾…ç”Ÿäº§è€…ã€‚ ä¸ºäº†è§£å†³è¿™ç§ç”Ÿäº§æ¶ˆè´¹èƒ½åŠ›ä¸å‡è¡¡çš„é—®é¢˜ï¼Œä¾¿æœ‰äº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…æ¨¡å¼æ˜¯é€šè¿‡ä¸€ä¸ªå®¹å™¨æ¥è§£å†³ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¼ºè€¦åˆé—®é¢˜ã€‚ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å½¼æ­¤ä¹‹é—´ä¸ç›´æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡é˜»å¡é˜Ÿåˆ—æ¥è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥ç”Ÿäº§è€…ç”Ÿäº§å®Œæ•°æ®ä¹‹åä¸ç”¨ç­‰å¾…æ¶ˆè´¹è€…å¤„ç†ï¼Œç›´æ¥æ‰”ç»™é˜»å¡é˜Ÿåˆ—ï¼Œæ¶ˆè´¹è€…ä¸æ‰¾ç”Ÿäº§è€…è¦æ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥ä»é˜»å¡é˜Ÿåˆ—é‡Œå–ï¼Œé˜»å¡é˜Ÿåˆ—å°±ç›¸å½“äºä¸€ä¸ªç¼“å†²åŒºï¼Œå¹³è¡¡äº†ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„å¤„ç†èƒ½åŠ›ã€‚ é˜»å¡é˜Ÿåˆ—å¸¸ç”¨äºç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…çš„åœºæ™¯ï¼Œç”Ÿäº§è€…æ˜¯å‘é˜Ÿåˆ—é‡Œæ·»åŠ å…ƒç´ çš„çº¿ç¨‹ï¼Œæ¶ˆè´¹è€…æ˜¯ä»é˜Ÿåˆ—é‡Œå–å…ƒç´ çš„çº¿ç¨‹ã€‚é˜»å¡é˜Ÿåˆ—å°±æ˜¯ç”Ÿäº§è€…ç”¨æ¥å­˜æ”¾å…ƒç´ ã€æ¶ˆè´¹è€…ç”¨æ¥è·å–å…ƒç´ çš„å®¹å™¨ã€‚ Â·æŠ›å‡ºå¼‚å¸¸ï¼šå½“é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœå†å¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œä¼šæŠ›å‡ºIllegalStateExceptionï¼ˆâ€Queuefullâ€ï¼‰å¼‚å¸¸ã€‚å½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œä»é˜Ÿåˆ—é‡Œè·å–å…ƒç´ ä¼šæŠ›å‡ºNoSuchElementExceptionå¼‚å¸¸ã€‚ Â·è¿”å›ç‰¹æ®Šå€¼ï¼šå½“å¾€é˜Ÿåˆ—æ’å…¥å…ƒç´ æ—¶ï¼Œä¼šè¿”å›å…ƒç´ æ˜¯å¦æ’å…¥æˆåŠŸï¼ŒæˆåŠŸè¿”å›trueã€‚å¦‚æœæ˜¯ç§»é™¤æ–¹æ³•ï¼Œåˆ™æ˜¯ä»é˜Ÿåˆ—é‡Œå–å‡ºä¸€ä¸ªå…ƒç´ ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›nullã€‚ Â·ä¸€ç›´é˜»å¡ï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§è€…çº¿ç¨‹å¾€é˜Ÿåˆ—é‡Œputå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—å¯ç”¨æˆ–è€…å“åº”ä¸­æ–­é€€å‡ºã€‚å½“é˜Ÿåˆ—ç©ºæ—¶ï¼Œå¦‚æœæ¶ˆè´¹è€…çº¿ç¨‹ä»é˜Ÿåˆ—é‡Œtakeå…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ä½æ¶ˆè´¹è€…çº¿ç¨‹ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºã€‚ Â·è¶…æ—¶é€€å‡ºï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œå¦‚æœç”Ÿäº§è€…çº¿ç¨‹å¾€é˜Ÿåˆ—é‡Œæ’å…¥å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€æ®µæ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº†æŒ‡å®šçš„æ—¶é—´ï¼Œç”Ÿäº§è€…çº¿ç¨‹å°±ä¼šé€€å‡ºã€‚ å¸¸ç”¨é˜»å¡é˜Ÿåˆ—Â·ArrayBlockingQueueï¼šä¸€ä¸ªç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ Â·LinkedBlockingQueueï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ Â·PriorityBlockingQueueï¼šä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ Â·DelayQueueï¼šä¸€ä¸ªä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ Â·SynchronousQueueï¼šä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚ Â·LinkedTransferQueueï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚ Â·LinkedBlockingDequeï¼šä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚ ä»¥ä¸Šçš„é˜»å¡é˜Ÿåˆ—éƒ½å®ç°äº†BlockingQueueæ¥å£ï¼Œä¹Ÿéƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ æœ‰ç•Œæ— ç•Œï¼Ÿæœ‰é™é˜Ÿåˆ—å°±æ˜¯é•¿åº¦æœ‰é™ï¼Œæ»¡äº†ä»¥åç”Ÿäº§è€…ä¼šé˜»å¡ï¼Œæ— ç•Œé˜Ÿåˆ—å°±æ˜¯é‡Œé¢èƒ½æ”¾æ— æ•°çš„ä¸œè¥¿è€Œä¸ä¼šå› ä¸ºé˜Ÿåˆ—é•¿åº¦é™åˆ¶è¢«é˜»å¡ï¼Œå½“ç„¶ç©ºé—´é™åˆ¶æ¥æºäºç³»ç»Ÿèµ„æºçš„é™åˆ¶ï¼Œå¦‚æœå¤„ç†ä¸åŠæ—¶ï¼Œå¯¼è‡´é˜Ÿåˆ—è¶Šæ¥è¶Šå¤§è¶Šæ¥è¶Šå¤§ï¼Œè¶…å‡ºä¸€å®šçš„é™åˆ¶è‡´ä½¿å†…å­˜è¶…é™ï¼Œæ“ä½œç³»ç»Ÿæˆ–è€…JVMå¸®ä½ è§£å†³çƒ¦æ¼ï¼Œç›´æ¥æŠŠä½  OOM kill çœäº‹äº†ã€‚ æ— ç•Œä¹Ÿä¼šé˜»å¡ï¼Œä¸ºä½•ï¼Ÿå› ä¸ºé˜»å¡ä¸ä»…ä»…ä½“ç°åœ¨ç”Ÿäº§è€…æ”¾å…¥å…ƒç´ æ—¶ä¼šé˜»å¡ï¼Œæ¶ˆè´¹è€…æ‹¿å–å…ƒç´ æ—¶ï¼Œå¦‚æœæ²¡æœ‰å…ƒç´ ï¼ŒåŒæ ·ä¹Ÿä¼šé˜»å¡ã€‚ ArrayBlockingQueueæ˜¯ä¸€ä¸ªç”¨æ•°ç»„å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºï¼ˆFIFOï¼‰çš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚é»˜è®¤æƒ…å†µä¸‹ä¸ä¿è¯çº¿ç¨‹å…¬å¹³çš„è®¿é—®é˜Ÿåˆ—ï¼Œæ‰€è°“å…¬å¹³è®¿é—®é˜Ÿåˆ—æ˜¯æŒ‡é˜»å¡çš„çº¿ç¨‹ï¼Œå¯ä»¥æŒ‰ç…§é˜»å¡çš„å…ˆåé¡ºåºè®¿é—®é˜Ÿåˆ—ï¼Œå³å…ˆé˜»å¡çº¿ç¨‹å…ˆè®¿é—®é˜Ÿåˆ—ã€‚éå…¬å¹³æ€§æ˜¯å¯¹å…ˆç­‰å¾…çš„çº¿ç¨‹æ˜¯éå…¬å¹³çš„ï¼Œå½“é˜Ÿåˆ—å¯ç”¨æ—¶ï¼Œé˜»å¡çš„çº¿ç¨‹éƒ½å¯ä»¥äº‰å¤ºè®¿é—®é˜Ÿåˆ—çš„èµ„æ ¼ï¼Œæœ‰å¯èƒ½å…ˆé˜»å¡çš„çº¿ç¨‹æœ€åæ‰è®¿é—®é˜Ÿåˆ—ã€‚åˆå§‹åŒ–æ—¶æœ‰å‚æ•°å¯ä»¥è®¾ç½® LinkedBlockingQueueæ˜¯ä¸€ä¸ªç”¨é“¾è¡¨å®ç°çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—ã€‚æ­¤é˜Ÿåˆ—çš„é»˜è®¤å’Œæœ€å¤§é•¿åº¦ä¸ºInteger.MAX_VALUEã€‚æ­¤é˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚ Arrayå®ç°å’ŒLinkedå®ç°çš„åŒºåˆ«\\1. é˜Ÿåˆ—ä¸­é”çš„å®ç°ä¸åŒ ArrayBlockingQueueå®ç°çš„é˜Ÿåˆ—ä¸­çš„é”æ˜¯æ²¡æœ‰åˆ†ç¦»çš„ï¼Œå³ç”Ÿäº§å’Œæ¶ˆè´¹ç”¨çš„æ˜¯åŒä¸€ä¸ªé”ï¼› LinkedBlockingQueueå®ç°çš„é˜Ÿåˆ—ä¸­çš„é”æ˜¯åˆ†ç¦»çš„ï¼Œå³ç”Ÿäº§ç”¨çš„æ˜¯putLockï¼Œæ¶ˆè´¹æ˜¯takeLock \\2. åœ¨ç”Ÿäº§æˆ–æ¶ˆè´¹æ—¶æ“ä½œä¸åŒ ArrayBlockingQueueå®ç°çš„é˜Ÿåˆ—ä¸­åœ¨ç”Ÿäº§å’Œæ¶ˆè´¹çš„æ—¶å€™ï¼Œæ˜¯ç›´æ¥å°†æšä¸¾å¯¹è±¡æ’å…¥æˆ–ç§»é™¤çš„ï¼› LinkedBlockingQueueå®ç°çš„é˜Ÿåˆ—ä¸­åœ¨ç”Ÿäº§å’Œæ¶ˆè´¹çš„æ—¶å€™ï¼Œéœ€è¦æŠŠæšä¸¾å¯¹è±¡è½¬æ¢ä¸ºNodeè¿›è¡Œæ’å…¥æˆ–ç§»é™¤ï¼Œä¼šå½±å“æ€§èƒ½ \\3. é˜Ÿåˆ—å¤§å°åˆå§‹åŒ–æ–¹å¼ä¸åŒ ArrayBlockingQueueå®ç°çš„é˜Ÿåˆ—ä¸­å¿…é¡»æŒ‡å®šé˜Ÿåˆ—çš„å¤§å°ï¼› LinkedBlockingQueueå®ç°çš„é˜Ÿåˆ—ä¸­å¯ä»¥ä¸æŒ‡å®šé˜Ÿåˆ—çš„å¤§å°ï¼Œä½†æ˜¯é»˜è®¤æ˜¯Integer.MAX_VALUE PriorityBlockingQueuePriorityBlockingQueueæ˜¯ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é»˜è®¤æƒ…å†µä¸‹å…ƒç´ é‡‡å–è‡ªç„¶é¡ºåºå‡åºæ’åˆ—ã€‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç±»å®ç°compareTo()æ–¹æ³•æ¥æŒ‡å®šå…ƒç´ æ’åºè§„åˆ™ï¼Œæˆ–è€…åˆå§‹åŒ–PriorityBlockingQueueæ—¶ï¼ŒæŒ‡å®šæ„é€ å‚æ•°Comparatoræ¥å¯¹å…ƒç´ è¿›è¡Œæ’åºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½ä¿è¯åŒä¼˜å…ˆçº§å…ƒç´ çš„é¡ºåºã€‚ DelayQueueæ˜¯ä¸€ä¸ªæ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—ã€‚é˜Ÿåˆ—ä½¿ç”¨PriorityQueueæ¥å®ç°ã€‚é˜Ÿåˆ—ä¸­çš„å…ƒç´ å¿…é¡»å®ç°Delayedæ¥å£ï¼Œåœ¨åˆ›å»ºå…ƒç´ æ—¶å¯ä»¥æŒ‡å®šå¤šä¹…æ‰èƒ½ä»é˜Ÿåˆ—ä¸­è·å–å½“å‰å…ƒç´ ã€‚åªæœ‰åœ¨å»¶è¿ŸæœŸæ»¡æ—¶æ‰èƒ½ä»é˜Ÿåˆ—ä¸­æå–å…ƒç´ ã€‚ DelayQueueéå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å°†DelayQueueè¿ç”¨åœ¨ä»¥ä¸‹åº”ç”¨åœºæ™¯ã€‚ ç¼“å­˜ç³»ç»Ÿçš„è®¾è®¡ï¼šå¯ä»¥ç”¨DelayQueueä¿å­˜ç¼“å­˜å…ƒç´ çš„æœ‰æ•ˆæœŸï¼Œä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹å¾ªç¯æŸ¥è¯¢DelayQueueï¼Œä¸€æ—¦èƒ½ä»DelayQueueä¸­è·å–å…ƒç´ æ—¶ï¼Œè¡¨ç¤ºç¼“å­˜æœ‰æ•ˆæœŸåˆ°äº†ã€‚ SynchronousQueueæ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ªputæ“ä½œå¿…é¡»ç­‰å¾…ä¸€ä¸ªtakeæ“ä½œï¼Œå¦åˆ™ä¸èƒ½ç»§ç»­æ·»åŠ å…ƒç´ ã€‚SynchronousQueueå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªä¼ çƒæ‰‹ï¼Œè´Ÿè´£æŠŠç”Ÿäº§è€…çº¿ç¨‹å¤„ç†çš„æ•°æ®ç›´æ¥ä¼ é€’ç»™æ¶ˆè´¹è€…çº¿ç¨‹ã€‚é˜Ÿåˆ—æœ¬èº«å¹¶ä¸å­˜å‚¨ä»»ä½•å…ƒç´ ï¼Œéå¸¸é€‚åˆä¼ é€’æ€§åœºæ™¯ã€‚SynchronousQueueçš„ååé‡é«˜äºLinkedBlockingQueueå’ŒArrayBlockingQueueã€‚ LinkedTransferQueueå¤šäº†tryTransferå’Œtransferæ–¹æ³•ï¼Œ ï¼ˆ1ï¼‰transferæ–¹æ³• å¦‚æœå½“å‰æœ‰æ¶ˆè´¹è€…æ­£åœ¨ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼ˆæ¶ˆè´¹è€…ä½¿ç”¨take()æ–¹æ³•æˆ–å¸¦æ—¶é—´é™åˆ¶çš„poll()æ–¹æ³•æ—¶ï¼‰ï¼Œtransferæ–¹æ³•å¯ä»¥æŠŠç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ ç«‹åˆ»transferï¼ˆä¼ è¾“ï¼‰ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…åœ¨ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼Œtransferæ–¹æ³•ä¼šå°†å…ƒç´ å­˜æ”¾åœ¨é˜Ÿåˆ—çš„tailèŠ‚ç‚¹ï¼Œå¹¶ç­‰åˆ°è¯¥å…ƒç´ è¢«æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ‰è¿”å›ã€‚ ï¼ˆ2ï¼‰tryTransferæ–¹æ³• tryTransferæ–¹æ³•æ˜¯ç”¨æ¥è¯•æ¢ç”Ÿäº§è€…ä¼ å…¥çš„å…ƒç´ æ˜¯å¦èƒ½ç›´æ¥ä¼ ç»™æ¶ˆè´¹è€…ã€‚å¦‚æœæ²¡æœ‰æ¶ˆè´¹è€…ç­‰å¾…æ¥æ”¶å…ƒç´ ï¼Œåˆ™è¿”å›falseã€‚å’Œtransferæ–¹æ³•çš„åŒºåˆ«æ˜¯tryTransferæ–¹æ³•æ— è®ºæ¶ˆè´¹è€…æ˜¯å¦æ¥æ”¶ï¼Œæ–¹æ³•ç«‹å³è¿”å›ï¼Œè€Œtransferæ–¹æ³•æ˜¯å¿…é¡»ç­‰åˆ°æ¶ˆè´¹è€…æ¶ˆè´¹äº†æ‰è¿”å›ã€‚ LinkedBlockingDequeLinkedBlockingDequeæ˜¯ä¸€ä¸ªç”±é“¾è¡¨ç»“æ„ç»„æˆçš„åŒå‘é˜»å¡é˜Ÿåˆ—ã€‚æ‰€è°“åŒå‘é˜Ÿåˆ—æŒ‡çš„æ˜¯å¯ä»¥ä»é˜Ÿåˆ—çš„ä¸¤ç«¯æ’å…¥å’Œç§»å‡ºå…ƒç´ ã€‚åŒå‘é˜Ÿåˆ—å› ä¸ºå¤šäº†ä¸€ä¸ªæ“ä½œé˜Ÿåˆ—çš„å…¥å£ï¼Œåœ¨å¤šçº¿ç¨‹åŒæ—¶å…¥é˜Ÿæ—¶ï¼Œä¹Ÿå°±å‡å°‘äº†ä¸€åŠçš„ç«äº‰ã€‚ å¤šäº†addFirstã€addLastã€offerFirstã€offerLastã€peekFirstå’ŒpeekLastç­‰æ–¹æ³•ï¼Œä»¥Firstå•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ã€è·å–ï¼ˆpeekï¼‰æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚ä»¥Lastå•è¯ç»“å°¾çš„æ–¹æ³•ï¼Œè¡¨ç¤ºæ’å…¥ã€è·å–æˆ–ç§»é™¤åŒç«¯é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚å¦å¤–ï¼Œæ’å…¥æ–¹æ³•addç­‰åŒäºaddLastï¼Œç§»é™¤æ–¹æ³•removeç­‰æ•ˆäºremoveFirstã€‚ä½†æ˜¯takeæ–¹æ³•å´ç­‰åŒäºtakeFirstï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯JDKçš„bugï¼Œä½¿ç”¨æ—¶è¿˜æ˜¯ç”¨å¸¦æœ‰Firstå’ŒLaståç¼€çš„æ–¹æ³•æ›´æ¸…æ¥šã€‚åœ¨åˆå§‹åŒ–LinkedBlockingDequeæ—¶å¯ä»¥è®¾ç½®å®¹é‡é˜²æ­¢å…¶è¿‡åº¦è†¨èƒ€ã€‚å¦å¤–ï¼ŒåŒå‘é˜»å¡é˜Ÿåˆ—å¯ä»¥è¿ç”¨åœ¨â€œå·¥ä½œçªƒå–â€æ¨¡å¼ä¸­ã€‚ çº¿ç¨‹æ± ä¸ºä»€ä¹ˆè¦ç”¨çº¿ç¨‹æ± ï¼ŸJavaä¸­çš„çº¿ç¨‹æ± æ˜¯è¿ç”¨åœºæ™¯æœ€å¤šçš„å¹¶å‘æ¡†æ¶ï¼Œå‡ ä¹æ‰€æœ‰éœ€è¦å¼‚æ­¥æˆ–å¹¶å‘æ‰§è¡Œä»»åŠ¡çš„ç¨‹åºéƒ½å¯ä»¥ä½¿ç”¨çº¿ç¨‹æ± ã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œåˆç†åœ°ä½¿ç”¨çº¿ç¨‹æ± èƒ½å¤Ÿå¸¦æ¥3ä¸ªå¥½å¤„ã€‚ ç¬¬ä¸€ï¼šé™ä½èµ„æºæ¶ˆè€—ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚ ç¬¬äºŒï¼šæé«˜å“åº”é€Ÿåº¦ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚å‡è®¾ä¸€ä¸ªæœåŠ¡å™¨å®Œæˆä¸€é¡¹ä»»åŠ¡æ‰€éœ€æ—¶é—´ä¸ºï¼šT1 åˆ›å»ºçº¿ç¨‹æ—¶é—´ï¼ŒT2 åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ï¼ŒT3 é”€æ¯çº¿ç¨‹æ—¶é—´ã€‚ å¦‚æœï¼šT1 + T3 è¿œå¤§äº T2ï¼Œåˆ™å¯ä»¥é‡‡ç”¨çº¿ç¨‹æ± ï¼Œä»¥æé«˜æœåŠ¡å™¨æ€§èƒ½ã€‚çº¿ç¨‹æ± æŠ€æœ¯æ­£æ˜¯å…³æ³¨å¦‚ä½•ç¼©çŸ­æˆ–è°ƒæ•´T1,T3æ—¶é—´çš„æŠ€æœ¯ï¼Œä»è€Œæé«˜æœåŠ¡å™¨ç¨‹åºæ€§èƒ½çš„ã€‚å®ƒæŠŠT1ï¼ŒT3åˆ†åˆ«å®‰æ’åœ¨æœåŠ¡å™¨ç¨‹åºçš„å¯åŠ¨å’Œç»“æŸçš„æ—¶é—´æ®µæˆ–è€…ä¸€äº›ç©ºé—²çš„æ—¶é—´æ®µï¼Œè¿™æ ·åœ¨æœåŠ¡å™¨ç¨‹åºå¤„ç†å®¢æˆ·è¯·æ±‚æ—¶ï¼Œä¸ä¼šæœ‰T1ï¼ŒT3çš„å¼€é”€äº†ã€‚ ç¬¬ä¸‰ï¼šæé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶åœ°åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€åˆ†é…ã€è°ƒä¼˜å’Œç›‘æ§ã€‚ ThreadPoolExecutor çš„ç±»å…³ç³»Executoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒæ˜¯Executoræ¡†æ¶çš„åŸºç¡€ï¼Œå®ƒå°†ä»»åŠ¡çš„æäº¤ä¸ä»»åŠ¡çš„æ‰§è¡Œåˆ†ç¦»å¼€æ¥ã€‚ ExecutorServiceæ¥å£ç»§æ‰¿äº†Executorï¼Œåœ¨å…¶ä¸Šåšäº†ä¸€äº›shutdown()ã€submit()çš„æ‰©å±•ï¼Œå¯ä»¥è¯´æ˜¯çœŸæ­£çš„çº¿ç¨‹æ± æ¥å£ï¼› AbstractExecutorServiceæŠ½è±¡ç±»å®ç°äº†ExecutorServiceæ¥å£ä¸­çš„å¤§éƒ¨åˆ†æ–¹æ³•ï¼› ThreadPoolExecutoræ˜¯çº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°ç±»ï¼Œç”¨æ¥æ‰§è¡Œè¢«æäº¤çš„ä»»åŠ¡ã€‚ ScheduledExecutorServiceæ¥å£ç»§æ‰¿äº†ExecutorServiceæ¥å£ï¼Œæä¾›äº†å¸¦â€å‘¨æœŸæ‰§è¡Œâ€åŠŸèƒ½ExecutorServiceï¼› ScheduledThreadPoolExecutoræ˜¯ä¸€ä¸ªå®ç°ç±»ï¼Œå¯ä»¥åœ¨ç»™å®šçš„å»¶è¿Ÿåè¿è¡Œå‘½ä»¤ï¼Œæˆ–è€…å®šæœŸæ‰§è¡Œå‘½ä»¤ã€‚ScheduledThreadPoolExecutoræ¯”Timeræ›´çµæ´»ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§ã€‚ çº¿ç¨‹æ± çš„åˆ›å»ºå„ä¸ªå‚æ•°å«ä¹‰public ThreadPoolExecutor(int corePoolSize,int maximumPoolSize,long keepAliveTime,TimeUnit unit,BlockingQueue workQueue,ThreadFactory threadFactory,RejectedExecutionHandler handler) corePoolSizeçº¿ç¨‹æ± ä¸­çš„æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå½“æäº¤ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œç›´åˆ°å½“å‰çº¿ç¨‹æ•°ç­‰äºcorePoolSizeï¼› å¦‚æœå½“å‰çº¿ç¨‹æ•°ä¸ºcorePoolSizeï¼Œç»§ç»­æäº¤çš„ä»»åŠ¡è¢«ä¿å­˜åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¢«æ‰§è¡Œï¼› å¦‚æœæ‰§è¡Œäº†çº¿ç¨‹æ± çš„prestartAllCoreThreads()æ–¹æ³•ï¼Œçº¿ç¨‹æ± ä¼šæå‰åˆ›å»ºå¹¶å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ã€‚ maximumPoolSizeçº¿ç¨‹æ± ä¸­å…è®¸çš„æœ€å¤§çº¿ç¨‹æ•°ã€‚å¦‚æœå½“å‰é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”ç»§ç»­æäº¤ä»»åŠ¡ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå‰ææ˜¯å½“å‰çº¿ç¨‹æ•°å°äºmaximumPoolSize keepAliveTimeçº¿ç¨‹ç©ºé—²æ—¶çš„å­˜æ´»æ—¶é—´ï¼Œå³å½“çº¿ç¨‹æ²¡æœ‰ä»»åŠ¡æ‰§è¡Œæ—¶ï¼Œç»§ç»­å­˜æ´»çš„æ—¶é—´ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥å‚æ•°åªåœ¨çº¿ç¨‹æ•°å¤§äºcorePoolSizeæ—¶æ‰æœ‰ç”¨ TimeUnitkeepAliveTimeçš„æ—¶é—´å•ä½ workQueueworkQueueå¿…é¡»æ˜¯BlockingQueueé˜»å¡é˜Ÿåˆ—ã€‚å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°è¶…è¿‡å®ƒçš„corePoolSizeçš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šè¿›å…¥é˜»å¡é˜Ÿåˆ—è¿›è¡Œé˜»å¡ç­‰å¾…ã€‚é€šè¿‡workQueueï¼Œçº¿ç¨‹æ± å®ç°äº†é˜»å¡åŠŸèƒ½ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œå› ä¸ºä½¿ç”¨æ— ç•Œé˜Ÿåˆ—ä½œä¸ºå·¥ä½œé˜Ÿåˆ—ä¼šå¯¹çº¿ç¨‹æ± å¸¦æ¥å¦‚ä¸‹å½±å“ã€‚ 1ï¼‰å½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°è¾¾åˆ°corePoolSizeåï¼Œæ–°ä»»åŠ¡å°†åœ¨æ— ç•Œé˜Ÿåˆ—ä¸­ç­‰å¾…ï¼Œå› æ­¤çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ä¸ä¼šè¶…è¿‡corePoolSizeã€‚ 2ï¼‰ç”±äº1ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ—¶maximumPoolSizeå°†æ˜¯ä¸€ä¸ªæ— æ•ˆå‚æ•°ã€‚ 3ï¼‰ç”±äº1å’Œ2ï¼Œä½¿ç”¨æ— ç•Œé˜Ÿåˆ—æ—¶keepAliveTimeå°†æ˜¯ä¸€ä¸ªæ— æ•ˆå‚æ•°ã€‚ 4ï¼‰æ›´é‡è¦çš„ï¼Œä½¿ç”¨æ— ç•Œqueueå¯èƒ½ä¼šè€—å°½ç³»ç»Ÿèµ„æºï¼Œæœ‰ç•Œé˜Ÿåˆ—åˆ™æœ‰åŠ©äºé˜²æ­¢èµ„æºè€—å°½ï¼ŒåŒæ—¶å³ä½¿ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ï¼Œä¹Ÿè¦å°½é‡æ§åˆ¶é˜Ÿåˆ—çš„å¤§å°åœ¨ä¸€ä¸ªåˆé€‚çš„èŒƒå›´ã€‚ threadFactoryåˆ›å»ºçº¿ç¨‹çš„å·¥å‚ï¼Œé€šè¿‡è‡ªå®šä¹‰çš„çº¿ç¨‹å·¥å‚å¯ä»¥ç»™æ¯ä¸ªæ–°å»ºçš„çº¿ç¨‹è®¾ç½®ä¸€ä¸ªå…·æœ‰è¯†åˆ«åº¦çš„çº¿ç¨‹åï¼Œå½“ç„¶è¿˜å¯ä»¥æ›´åŠ è‡ªç”±çš„å¯¹çº¿ç¨‹åšæ›´å¤šçš„è®¾ç½®ï¼Œæ¯”å¦‚è®¾ç½®æ‰€æœ‰çš„çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹ã€‚ Executorsé™æ€å·¥å‚é‡Œé»˜è®¤çš„threadFactoryï¼Œçº¿ç¨‹çš„å‘½åè§„åˆ™æ˜¯â€œpool-æ•°å­—-thread-æ•°å­—â€ã€‚ RejectedExecutionHandlerçº¿ç¨‹æ± çš„é¥±å’Œç­–ç•¥ï¼Œå½“é˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œä¸”æ²¡æœ‰ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœç»§ç»­æäº¤ä»»åŠ¡ï¼Œå¿…é¡»é‡‡å–ä¸€ç§ç­–ç•¥å¤„ç†è¯¥ä»»åŠ¡ï¼Œçº¿ç¨‹æ± æä¾›äº†4ç§ç­–ç•¥ï¼š ï¼ˆ1ï¼‰AbortPolicyï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œé»˜è®¤ç­–ç•¥ï¼› ï¼ˆ2ï¼‰CallerRunsPolicyï¼šç”¨è°ƒç”¨è€…æ‰€åœ¨çš„çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼› ï¼ˆ3ï¼‰DiscardOldestPolicyï¼šä¸¢å¼ƒé˜»å¡é˜Ÿåˆ—ä¸­é æœ€å‰çš„ä»»åŠ¡ï¼Œå¹¶æ‰§è¡Œå½“å‰ä»»åŠ¡ï¼› ï¼ˆ4ï¼‰DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼› å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®åº”ç”¨åœºæ™¯å®ç°RejectedExecutionHandleræ¥å£ï¼Œè‡ªå®šä¹‰é¥±å’Œç­–ç•¥ï¼Œå¦‚è®°å½•æ—¥å¿—æˆ–æŒä¹…åŒ–å­˜å‚¨ä¸èƒ½å¤„ç†çš„ä»»åŠ¡ã€‚ çº¿ç¨‹æ± çš„å·¥ä½œæœºåˆ¶1ï¼‰å¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹å°‘äºcorePoolSizeï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼ˆæ³¨æ„ï¼Œæ‰§è¡Œè¿™ä¸€æ­¥éª¤éœ€è¦è·å–å…¨å±€é”ï¼‰ã€‚ 2ï¼‰å¦‚æœè¿è¡Œçš„çº¿ç¨‹ç­‰äºæˆ–å¤šäºcorePoolSizeï¼Œåˆ™å°†ä»»åŠ¡åŠ å…¥BlockingQueueã€‚ 3ï¼‰å¦‚æœæ— æ³•å°†ä»»åŠ¡åŠ å…¥BlockingQueueï¼ˆé˜Ÿåˆ—å·²æ»¡ï¼‰ï¼Œåˆ™åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚ 4ï¼‰å¦‚æœåˆ›å»ºæ–°çº¿ç¨‹å°†ä½¿å½“å‰è¿è¡Œçš„çº¿ç¨‹è¶…å‡ºmaximumPoolSizeï¼Œä»»åŠ¡å°†è¢«æ‹’ç»ï¼Œå¹¶è°ƒç”¨RejectedExecutionHandler.rejectedExecution()æ–¹æ³•ã€‚ æäº¤ä»»åŠ¡execute()æ–¹æ³•ç”¨äºæäº¤ä¸éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ï¼Œæ‰€ä»¥æ— æ³•åˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¢«çº¿ç¨‹æ± æ‰§è¡ŒæˆåŠŸã€‚ submit()æ–¹æ³•ç”¨äºæäº¤éœ€è¦è¿”å›å€¼çš„ä»»åŠ¡ã€‚çº¿ç¨‹æ± ä¼šè¿”å›ä¸€ä¸ªfutureç±»å‹çš„å¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªfutureå¯¹è±¡å¯ä»¥åˆ¤æ–­ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡futureçš„get()æ–¹æ³•æ¥è·å–è¿”å›å€¼ï¼Œget()æ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä»»åŠ¡å®Œæˆï¼Œè€Œä½¿ç”¨getï¼ˆlong timeoutï¼ŒTimeUnit unitï¼‰æ–¹æ³•åˆ™ä¼šé˜»å¡å½“å‰çº¿ç¨‹ä¸€æ®µæ—¶é—´åç«‹å³è¿”å›ï¼Œè¿™æ—¶å€™æœ‰å¯èƒ½ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œå®Œã€‚ å…³é—­çº¿ç¨‹æ± å¯ä»¥é€šè¿‡è°ƒç”¨çº¿ç¨‹æ± çš„shutdownæˆ–shutdownNowæ–¹æ³•æ¥å…³é—­çº¿ç¨‹æ± ã€‚å®ƒä»¬çš„åŸç†æ˜¯éå†çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹ï¼Œç„¶åé€ä¸ªè°ƒç”¨çº¿ç¨‹çš„interruptæ–¹æ³•æ¥ä¸­æ–­çº¿ç¨‹ï¼Œæ‰€ä»¥æ— æ³•å“åº”ä¸­æ–­çš„ä»»åŠ¡å¯èƒ½æ°¸è¿œæ— æ³•ç»ˆæ­¢ã€‚ä½†æ˜¯å®ƒä»¬å­˜åœ¨ä¸€å®šçš„åŒºåˆ«ï¼ŒshutdownNowé¦–å…ˆå°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®æˆSTOPï¼Œç„¶åå°è¯•åœæ­¢æ‰€æœ‰çš„æ­£åœ¨æ‰§è¡Œæˆ–æš‚åœä»»åŠ¡çš„çº¿ç¨‹ï¼Œå¹¶è¿”å›ç­‰å¾…æ‰§è¡Œä»»åŠ¡çš„åˆ—è¡¨ï¼Œè€Œshutdownåªæ˜¯å°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®æˆSHUTDOWNçŠ¶æ€ï¼Œç„¶åä¸­æ–­æ‰€æœ‰æ²¡æœ‰æ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹ã€‚ åªè¦è°ƒç”¨äº†è¿™ä¸¤ä¸ªå…³é—­æ–¹æ³•ä¸­çš„ä»»æ„ä¸€ä¸ªï¼ŒisShutdownæ–¹æ³•å°±ä¼šè¿”å›trueã€‚å½“æ‰€æœ‰çš„ä»»åŠ¡éƒ½å·²å…³é—­åï¼Œæ‰è¡¨ç¤ºçº¿ç¨‹æ± å…³é—­æˆåŠŸï¼Œè¿™æ—¶è°ƒç”¨isTerminaedæ–¹æ³•ä¼šè¿”å›trueã€‚è‡³äºåº”è¯¥è°ƒç”¨å“ªä¸€ç§æ–¹æ³•æ¥å…³é—­çº¿ç¨‹æ± ï¼Œåº”è¯¥ç”±æäº¤åˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡ç‰¹æ€§å†³å®šï¼Œé€šå¸¸è°ƒç”¨shutdownæ–¹æ³•æ¥å…³é—­çº¿ç¨‹æ± ï¼Œå¦‚æœä»»åŠ¡ä¸ä¸€å®šè¦æ‰§è¡Œå®Œï¼Œåˆ™å¯ä»¥è°ƒç”¨shutdownNowæ–¹æ³•ã€‚ åˆç†åœ°é…ç½®çº¿ç¨‹æ± è¦æƒ³åˆç†åœ°é…ç½®çº¿ç¨‹æ± ï¼Œå°±å¿…é¡»é¦–å…ˆåˆ†æä»»åŠ¡ç‰¹æ€§ è¦æƒ³åˆç†åœ°é…ç½®çº¿ç¨‹æ± ï¼Œå°±å¿…é¡»é¦–å…ˆåˆ†æä»»åŠ¡ç‰¹æ€§ï¼Œå¯ä»¥ä»ä»¥ä¸‹å‡ ä¸ªè§’åº¦æ¥åˆ†æã€‚ â€¢ä»»åŠ¡çš„æ€§è´¨ï¼šCPUå¯†é›†å‹ä»»åŠ¡ã€IOå¯†é›†å‹ä»»åŠ¡å’Œæ··åˆå‹ä»»åŠ¡ã€‚ â€¢ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼šé«˜ã€ä¸­å’Œä½ã€‚ â€¢ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼šé•¿ã€ä¸­å’ŒçŸ­ã€‚ â€¢ä»»åŠ¡çš„ä¾èµ–æ€§ï¼šæ˜¯å¦ä¾èµ–å…¶ä»–ç³»ç»Ÿèµ„æºï¼Œå¦‚æ•°æ®åº“è¿æ¥ã€‚ æ€§è´¨ä¸åŒçš„ä»»åŠ¡å¯ä»¥ç”¨ä¸åŒè§„æ¨¡çš„çº¿ç¨‹æ± åˆ†å¼€å¤„ç†ã€‚ CPUå¯†é›†å‹ä»»åŠ¡åº”é…ç½®å°½å¯èƒ½å°çš„çº¿ç¨‹ï¼Œå¦‚é…ç½®Ncpu+1ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚ç”±äºIOå¯†é›†å‹ä»»åŠ¡çº¿ç¨‹å¹¶ä¸æ˜¯ä¸€ç›´åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œåˆ™åº”é…ç½®å°½å¯èƒ½å¤šçš„çº¿ç¨‹ï¼Œå¦‚2*Ncpuã€‚ æ··åˆå‹çš„ä»»åŠ¡ï¼Œå¦‚æœå¯ä»¥æ‹†åˆ†ï¼Œå°†å…¶æ‹†åˆ†æˆä¸€ä¸ªCPUå¯†é›†å‹ä»»åŠ¡å’Œä¸€ä¸ªIOå¯†é›†å‹ä»»åŠ¡ï¼Œåªè¦è¿™ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´ç›¸å·®ä¸æ˜¯å¤ªå¤§ï¼Œé‚£ä¹ˆåˆ†è§£åæ‰§è¡Œçš„ååé‡å°†é«˜äºä¸²è¡Œæ‰§è¡Œçš„ååé‡ã€‚å¦‚æœè¿™ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´ç›¸å·®å¤ªå¤§ï¼Œåˆ™æ²¡å¿…è¦è¿›è¡Œåˆ†è§£ã€‚å¯ä»¥é€šè¿‡Runtime.getRuntime().availableProcessors()æ–¹æ³•è·å¾—å½“å‰è®¾å¤‡çš„CPUä¸ªæ•°ã€‚ ä¼˜å…ˆçº§ä¸åŒçš„ä»»åŠ¡å¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—PriorityBlockingQueueæ¥å¤„ç†ã€‚å®ƒå¯ä»¥è®©ä¼˜å…ˆçº§é«˜çš„ä»»åŠ¡å…ˆæ‰§è¡Œã€‚ æ‰§è¡Œæ—¶é—´ä¸åŒçš„ä»»åŠ¡å¯ä»¥äº¤ç»™ä¸åŒè§„æ¨¡çš„çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œæˆ–è€…å¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œè®©æ‰§è¡Œæ—¶é—´çŸ­çš„ä»»åŠ¡å…ˆæ‰§è¡Œã€‚ å»ºè®®ä½¿ç”¨æœ‰ç•Œé˜Ÿåˆ—ã€‚æœ‰ç•Œé˜Ÿåˆ—èƒ½å¢åŠ ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œé¢„è­¦èƒ½åŠ›ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è®¾å¤§ä¸€ç‚¹å„¿ï¼Œæ¯”å¦‚å‡ åƒã€‚ å¦‚æœå½“æ—¶æˆ‘ä»¬è®¾ç½®æˆæ— ç•Œé˜Ÿåˆ—ï¼Œé‚£ä¹ˆçº¿ç¨‹æ± çš„é˜Ÿåˆ—å°±ä¼šè¶Šæ¥è¶Šå¤šï¼Œæœ‰å¯èƒ½ä¼šæ’‘æ»¡å†…å­˜ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨ï¼Œè€Œä¸åªæ˜¯åå°ä»»åŠ¡å‡ºç°é—®é¢˜ã€‚ AbstractQueuedSynchronizerå­¦ä¹ AQSçš„å¿…è¦æ€§é˜Ÿåˆ—åŒæ­¥å™¨AbstractQueuedSynchronizerï¼ˆä»¥ä¸‹ç®€ç§°åŒæ­¥å™¨æˆ–AQSï¼‰ï¼Œæ˜¯ç”¨æ¥æ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶çš„åŸºç¡€æ¡†æ¶ï¼Œå®ƒä½¿ç”¨äº†ä¸€ä¸ªintæˆå‘˜å˜é‡è¡¨ç¤ºåŒæ­¥çŠ¶æ€ï¼Œé€šè¿‡å†…ç½®çš„FIFOé˜Ÿåˆ—æ¥å®Œæˆèµ„æºè·å–çº¿ç¨‹çš„æ’é˜Ÿå·¥ä½œã€‚å¹¶å‘åŒ…çš„å¤§å¸ˆï¼ˆDoug Leaï¼‰æœŸæœ›å®ƒèƒ½å¤Ÿæˆä¸ºå®ç°å¤§éƒ¨åˆ†åŒæ­¥éœ€æ±‚çš„åŸºç¡€ã€‚ AQSä½¿ç”¨æ–¹å¼å’Œå…¶ä¸­çš„è®¾è®¡æ¨¡å¼AQSçš„ä¸»è¦ä½¿ç”¨æ–¹å¼æ˜¯ç»§æ‰¿ï¼Œå­ç±»é€šè¿‡ç»§æ‰¿AQSå¹¶å®ç°å®ƒçš„æŠ½è±¡æ–¹æ³•æ¥ç®¡ç†åŒæ­¥çŠ¶æ€ï¼Œåœ¨AQSé‡Œç”±ä¸€ä¸ªintå‹çš„stateæ¥ä»£è¡¨è¿™ä¸ªçŠ¶æ€ï¼Œåœ¨æŠ½è±¡æ–¹æ³•çš„å®ç°è¿‡ç¨‹ä¸­å…ä¸äº†è¦å¯¹åŒæ­¥çŠ¶æ€è¿›è¡Œæ›´æ”¹ï¼Œè¿™æ—¶å°±éœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„3ä¸ªæ–¹æ³•ï¼ˆgetState()ã€setState(int newState)å’ŒcompareAndSetState(int expect,int update)ï¼‰æ¥è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå®ƒä»¬èƒ½å¤Ÿä¿è¯çŠ¶æ€çš„æ”¹å˜æ˜¯å®‰å…¨çš„ã€‚ åœ¨å®ç°ä¸Šï¼Œå­ç±»æ¨èè¢«å®šä¹‰ä¸ºè‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„é™æ€å†…éƒ¨ç±»ï¼ŒAQSè‡ªèº«æ²¡æœ‰å®ç°ä»»ä½•åŒæ­¥æ¥å£ï¼Œå®ƒä»…ä»…æ˜¯å®šä¹‰äº†è‹¥å¹²åŒæ­¥çŠ¶æ€è·å–å’Œé‡Šæ”¾çš„æ–¹æ³•æ¥ä¾›è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶ä½¿ç”¨ï¼ŒåŒæ­¥å™¨æ—¢å¯ä»¥æ”¯æŒç‹¬å å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œä¹Ÿå¯ä»¥æ”¯æŒå…±äº«å¼åœ°è·å–åŒæ­¥çŠ¶æ€ï¼Œè¿™æ ·å°±å¯ä»¥æ–¹ä¾¿å®ç°ä¸åŒç±»å‹çš„åŒæ­¥ç»„ä»¶ï¼ˆReentrantLockã€ReentrantReadWriteLockå’ŒCountDownLatchç­‰ï¼‰ã€‚ åŒæ­¥å™¨æ˜¯å®ç°é”ï¼ˆä¹Ÿå¯ä»¥æ˜¯ä»»æ„åŒæ­¥ç»„ä»¶ï¼‰çš„å…³é”®ï¼Œåœ¨é”çš„å®ç°ä¸­èšåˆåŒæ­¥å™¨ã€‚å¯ä»¥è¿™æ ·ç†è§£äºŒè€…ä¹‹é—´çš„å…³ç³»ï¼š é”æ˜¯é¢å‘ä½¿ç”¨è€…çš„ï¼Œå®ƒå®šä¹‰äº†ä½¿ç”¨è€…ä¸é”äº¤äº’çš„æ¥å£ï¼ˆæ¯”å¦‚å¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹å¹¶è¡Œè®¿é—®ï¼‰ï¼Œéšè—äº†å®ç°ç»†èŠ‚ï¼› åŒæ­¥å™¨é¢å‘çš„æ˜¯é”çš„å®ç°è€…ï¼Œå®ƒç®€åŒ–äº†é”çš„å®ç°æ–¹å¼ï¼Œå±è”½äº†åŒæ­¥çŠ¶æ€ç®¡ç†ã€çº¿ç¨‹çš„æ’é˜Ÿã€ç­‰å¾…ä¸å”¤é†’ç­‰åº•å±‚æ“ä½œã€‚é”å’ŒåŒæ­¥å™¨å¾ˆå¥½åœ°éš”ç¦»äº†ä½¿ç”¨è€…å’Œå®ç°è€…æ‰€éœ€å…³æ³¨çš„é¢†åŸŸã€‚ å®ç°è€…éœ€è¦ç»§æ‰¿åŒæ­¥å™¨å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•ï¼Œéšåå°†åŒæ­¥å™¨ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œè€Œè¿™äº›æ¨¡æ¿æ–¹æ³•å°†ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•ã€‚ æ¨¡æ¿æ–¹æ³•æ¨¡å¼åŒæ­¥å™¨çš„è®¾è®¡åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼ã€‚æ¨¡æ¿æ–¹æ³•æ¨¡å¼çš„æ„å›¾æ˜¯ï¼Œå®šä¹‰ä¸€ä¸ªæ“ä½œä¸­çš„ç®—æ³•çš„éª¨æ¶ï¼Œè€Œå°†ä¸€äº›æ­¥éª¤çš„å®ç°å»¶è¿Ÿåˆ°å­ç±»ä¸­ã€‚æ¨¡æ¿æ–¹æ³•ä½¿å¾—å­ç±»å¯ä»¥ä¸æ”¹å˜ä¸€ä¸ªç®—æ³•çš„ç»“æ„å³å¯é‡å®šä¹‰è¯¥ç®—æ³•çš„æŸäº›ç‰¹å®šæ­¥éª¤ã€‚æˆ‘ä»¬æœ€å¸¸è§çš„å°±æ˜¯Springæ¡†æ¶é‡Œçš„å„ç§Templateã€‚ å®é™…ä¾‹å­æˆ‘ä»¬å¼€äº†ä¸ªè›‹ç³•åº—ï¼Œè›‹ç³•åº—ä¸èƒ½åªå–ä¸€ç§è›‹ç³•å‘€ï¼Œäºæ˜¯æˆ‘ä»¬å†³å®šå…ˆå–å¥¶æ²¹è›‹ç³•ï¼ŒèŠå£«è›‹ç³•å’Œæ…•æ–¯è›‹ç³•ã€‚ä¸‰ç§è›‹ç³•åœ¨åˆ¶ä½œæ–¹å¼ä¸Šä¸€æ ·ï¼Œéƒ½åŒ…æ‹¬é€ å‹ï¼Œçƒ˜ç„™å’Œæ¶‚æŠ¹è›‹ç³•ä¸Šçš„ä¸œè¥¿ã€‚æ‰€ä»¥å¯ä»¥å®šä¹‰ä¸€ä¸ªæŠ½è±¡è›‹ç³•æ¨¡å‹ ç„¶åå°±å¯ä»¥æ‰¹é‡ç”Ÿäº§ä¸‰ç§è›‹ç³• è¿™æ ·ä¸€æ¥ï¼Œä¸ä½†å¯ä»¥æ‰¹é‡ç”Ÿäº§ä¸‰ç§è›‹ç³•ï¼Œè€Œä¸”å¦‚æœæ—¥åæœ‰æ‰©å±•ï¼Œåªéœ€è¦ç»§æ‰¿æŠ½è±¡è›‹ç³•æ–¹æ³•å°±å¯ä»¥äº†ï¼Œååˆ†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¤©å¤©ç”Ÿæ„åšå¾—è¶Šæ¥è¶Šèµšé’±ã€‚çªç„¶æœ‰ä¸€å¤©ï¼Œæˆ‘ä»¬å‘ç°å¸‚é¢æœ‰ä¸€ç§æœ€ç®€å•çš„å°è›‹ç³•é”€é‡å¾ˆå¥½ï¼Œè¿™ç§è›‹ç³•å°±æ˜¯ç®€å•çƒ˜çƒ¤æˆå‹å°±å¯ä»¥å–ï¼Œå¹¶ä¸éœ€è¦æ¶‚æŠ¹ä»€ä¹ˆé£Ÿæï¼Œç”±äºåˆ¶ä½œç®€å•é”€å”®é‡å¤§ï¼Œè¿™ä¸ªå“ç§ä¹Ÿå¾ˆèµšé’±ï¼Œäºæ˜¯æˆ‘ä»¬ä¹Ÿæƒ³è¦ç”Ÿäº§è¿™ç§è›‹ç³•ã€‚ä½†æ˜¯æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªé—®é¢˜ï¼ŒæŠ½è±¡è›‹ç³•æ˜¯å®šä¹‰äº†æŠ½è±¡çš„æ¶‚æŠ¹æ–¹æ³•çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰©å±•çš„è¿™ç§è›‹ç³•æ˜¯å¿…é¡»è¦å®ç°æ¶‚æŠ¹æ–¹æ³•ï¼Œè¿™å°±å¾ˆé¸¡å„¿è›‹ç–¼äº†ã€‚æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥å°†åŸæ¥çš„æ¨¡æ¿ä¿®æ”¹ä¸ºå¸¦é’©å­çš„æ¨¡æ¿ã€‚ åšå°è›‹ç³•çš„æ—¶å€™é€šè¿‡flagæ¥æ§åˆ¶æ˜¯å¦æ¶‚æŠ¹ï¼Œå…¶ä½™å·²æœ‰çš„è›‹ç³•åˆ¶ä½œä¸éœ€è¦ä»»ä½•ä¿®æ”¹å¯ä»¥ç…§å¸¸è¿›è¡Œã€‚ AQSä¸­çš„æ–¹æ³•æ¨¡æ¿æ–¹æ³•å®ç°è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶æ—¶ï¼Œå°†ä¼šè°ƒç”¨åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼Œ è¿™äº›æ¨¡æ¿æ–¹æ³•åŒæ­¥å™¨æä¾›çš„æ¨¡æ¿æ–¹æ³•åŸºæœ¬ä¸Šåˆ†ä¸º3ç±»ï¼šç‹¬å å¼è·å–ä¸é‡Šæ”¾åŒæ­¥çŠ¶æ€ã€å…±äº«å¼è·å–ä¸é‡Šæ”¾ã€åŒæ­¥çŠ¶æ€å’ŒæŸ¥è¯¢åŒæ­¥é˜Ÿåˆ—ä¸­çš„ç­‰å¾…çº¿ç¨‹æƒ…å†µã€‚ å¯é‡å†™çš„æ–¹æ³• è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€çš„æ–¹æ³•é‡å†™åŒæ­¥å™¨æŒ‡å®šçš„æ–¹æ³•æ—¶ï¼Œéœ€è¦ä½¿ç”¨åŒæ­¥å™¨æä¾›çš„å¦‚ä¸‹3ä¸ªæ–¹æ³•æ¥è®¿é—®æˆ–ä¿®æ”¹åŒæ­¥çŠ¶æ€ã€‚ â€¢getState()ï¼šè·å–å½“å‰åŒæ­¥çŠ¶æ€ã€‚ â€¢setState(int newState)ï¼šè®¾ç½®å½“å‰åŒæ­¥çŠ¶æ€ã€‚ â€¢compareAndSetState(int expect,int update)ï¼šä½¿ç”¨CASè®¾ç½®å½“å‰çŠ¶æ€ï¼Œè¯¥æ–¹æ³•èƒ½å¤Ÿä¿è¯çŠ¶æ€è®¾ç½®çš„åŸå­æ€§ã€‚ CLHé˜Ÿåˆ—é”CLHé˜Ÿåˆ—é”å³Craig, Landin, and Hagersten (CLH) locksã€‚ CLHé˜Ÿåˆ—é”ä¹Ÿæ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹ä»…ä»…åœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€ï¼Œå‡è®¾å‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹ã€‚ å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦è·å–é”æ—¶ï¼š \\1. åˆ›å»ºä¸€ä¸ªçš„QNodeï¼Œå°†å…¶ä¸­çš„lockedè®¾ç½®ä¸ºtrueè¡¨ç¤ºéœ€è¦è·å–é”ï¼ŒmyPredè¡¨ç¤ºå¯¹å…¶å‰é©±ç»“ç‚¹çš„å¼•ç”¨ \\2. çº¿ç¨‹Aå¯¹tailåŸŸè°ƒç”¨getAndSetæ–¹æ³•ï¼Œä½¿è‡ªå·±æˆä¸ºé˜Ÿåˆ—çš„å°¾éƒ¨ï¼ŒåŒæ—¶è·å–ä¸€ä¸ªæŒ‡å‘å…¶å‰é©±ç»“ç‚¹çš„å¼•ç”¨myPred çº¿ç¨‹Béœ€è¦è·å¾—é”ï¼ŒåŒæ ·çš„æµç¨‹å†æ¥ä¸€é 3.çº¿ç¨‹å°±åœ¨å‰é©±ç»“ç‚¹çš„lockedå­—æ®µä¸Šæ—‹è½¬ï¼Œç›´åˆ°å‰é©±ç»“ç‚¹é‡Šæ”¾é”(å‰é©±èŠ‚ç‚¹çš„é”å€¼ locked == false) 4.å½“ä¸€ä¸ªçº¿ç¨‹éœ€è¦é‡Šæ”¾é”æ—¶ï¼Œå°†å½“å‰ç»“ç‚¹çš„lockedåŸŸè®¾ç½®ä¸ºfalseï¼ŒåŒæ—¶å›æ”¶å‰é©±ç»“ç‚¹ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå‰é©±ç»“ç‚¹é‡Šæ”¾é”ï¼Œçº¿ç¨‹Açš„myPredæ‰€æŒ‡å‘çš„å‰é©±ç»“ç‚¹çš„lockedå­—æ®µå˜ä¸ºfalseï¼Œçº¿ç¨‹Aå°±å¯ä»¥è·å–åˆ°é”ã€‚ CLHé˜Ÿåˆ—é”çš„ä¼˜ç‚¹æ˜¯ç©ºé—´å¤æ‚åº¦ä½ï¼ˆå¦‚æœæœ‰nä¸ªçº¿ç¨‹ï¼ŒLä¸ªé”ï¼Œæ¯ä¸ªçº¿ç¨‹æ¯æ¬¡åªè·å–ä¸€ä¸ªé”ï¼Œé‚£ä¹ˆéœ€è¦çš„å­˜å‚¨ç©ºé—´æ˜¯Oï¼ˆL+nï¼‰ï¼Œnä¸ªçº¿ç¨‹æœ‰nä¸ªmyNodeï¼ŒLä¸ªé”æœ‰Lä¸ªtailï¼‰ã€‚CLHé˜Ÿåˆ—é”å¸¸ç”¨åœ¨SMPä½“ç³»ç»“æ„ä¸‹ã€‚ Javaä¸­çš„AQSæ˜¯CLHé˜Ÿåˆ—é”çš„ä¸€ç§å˜ä½“å®ç°ã€‚ ReentrantLockçš„å®ç°é”çš„å¯é‡å…¥é‡è¿›å…¥æ˜¯æŒ‡ä»»æ„çº¿ç¨‹åœ¨è·å–åˆ°é”ä¹‹åèƒ½å¤Ÿå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šè¢«é”æ‰€é˜»å¡ï¼Œè¯¥ç‰¹æ€§çš„å®ç°éœ€è¦è§£å†³ä»¥ä¸‹ä¸¤ä¸ªé—®é¢˜ã€‚ 1ï¼‰çº¿ç¨‹å†æ¬¡è·å–é”ã€‚é”éœ€è¦å»è¯†åˆ«è·å–é”çš„çº¿ç¨‹æ˜¯å¦ä¸ºå½“å‰å æ®é”çš„çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å†æ¬¡æˆåŠŸè·å–ã€‚ 2ï¼‰é”çš„æœ€ç»ˆé‡Šæ”¾ã€‚çº¿ç¨‹é‡å¤næ¬¡è·å–äº†é”ï¼Œéšååœ¨ç¬¬næ¬¡é‡Šæ”¾è¯¥é”åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿè·å–åˆ°è¯¥é”ã€‚é”çš„æœ€ç»ˆé‡Šæ”¾è¦æ±‚é”å¯¹äºè·å–è¿›è¡Œè®¡æ•°è‡ªå¢ï¼Œè®¡æ•°è¡¨ç¤ºå½“å‰é”è¢«é‡å¤è·å–çš„æ¬¡æ•°ï¼Œè€Œé”è¢«é‡Šæ”¾æ—¶ï¼Œè®¡æ•°è‡ªå‡ï¼Œå½“è®¡æ•°ç­‰äº0æ—¶è¡¨ç¤ºé”å·²ç»æˆåŠŸé‡Šæ”¾ã€‚ nonfairTryAcquireæ–¹æ³•å¢åŠ äº†å†æ¬¡è·å–åŒæ­¥çŠ¶æ€çš„å¤„ç†é€»è¾‘ï¼šé€šè¿‡åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦ä¸ºè·å–é”çš„çº¿ç¨‹æ¥å†³å®šè·å–æ“ä½œæ˜¯å¦æˆåŠŸï¼Œå¦‚æœæ˜¯è·å–é”çš„çº¿ç¨‹å†æ¬¡è¯·æ±‚ï¼Œåˆ™å°†åŒæ­¥çŠ¶æ€å€¼è¿›è¡Œå¢åŠ å¹¶è¿”å›trueï¼Œè¡¨ç¤ºè·å–åŒæ­¥çŠ¶æ€æˆåŠŸã€‚åŒæ­¥çŠ¶æ€è¡¨ç¤ºé”è¢«ä¸€ä¸ªçº¿ç¨‹é‡å¤è·å–çš„æ¬¡æ•°ã€‚ å¦‚æœè¯¥é”è¢«è·å–äº†næ¬¡ï¼Œé‚£ä¹ˆå‰(n-1)æ¬¡tryRelease(int releases)æ–¹æ³•å¿…é¡»è¿”å›falseï¼Œè€Œåªæœ‰åŒæ­¥çŠ¶æ€å®Œå…¨é‡Šæ”¾äº†ï¼Œæ‰èƒ½è¿”å›trueã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•å°†åŒæ­¥çŠ¶æ€æ˜¯å¦ä¸º0ä½œä¸ºæœ€ç»ˆé‡Šæ”¾çš„æ¡ä»¶ï¼Œå½“åŒæ­¥çŠ¶æ€ä¸º0æ—¶ï¼Œå°†å æœ‰çº¿ç¨‹è®¾ç½®ä¸ºnullï¼Œå¹¶è¿”å›trueï¼Œè¡¨ç¤ºé‡Šæ”¾æˆåŠŸã€‚ å…¬å¹³å’Œéå…¬å¹³é”ReentrantLockçš„æ„é€ å‡½æ•°ä¸­ï¼Œé»˜è®¤çš„æ— å‚æ„é€ å‡½æ•°å°†ä¼šæŠŠSyncå¯¹è±¡åˆ›å»ºä¸ºNonfairSyncå¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªâ€œéå…¬å¹³é”â€ï¼›è€Œå¦ä¸€ä¸ªæ„é€ å‡½æ•°ReentrantLock(boolean fair)ä¼ å…¥å‚æ•°ä¸ºtrueæ—¶å°†ä¼šæŠŠSyncå¯¹è±¡åˆ›å»ºä¸ºâ€œå…¬å¹³é”â€FairSyncã€‚ nonfairTryAcquire(int acquires)æ–¹æ³•ï¼Œå¯¹äºéå…¬å¹³é”ï¼Œåªè¦CASè®¾ç½®åŒæ­¥çŠ¶æ€æˆåŠŸï¼Œåˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–äº†é”ï¼Œè€Œå…¬å¹³é”åˆ™ä¸åŒã€‚tryAcquireæ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸nonfairTryAcquire(int acquires)æ¯”è¾ƒï¼Œå”¯ä¸€ä¸åŒçš„ä½ç½®ä¸ºåˆ¤æ–­æ¡ä»¶å¤šäº†hasQueuedPredecessors()æ–¹æ³•ï¼Œå³åŠ å…¥äº†åŒæ­¥é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹çš„åˆ¤æ–­ï¼Œå¦‚æœè¯¥æ–¹æ³•è¿”å›trueï¼Œåˆ™è¡¨ç¤ºæœ‰çº¿ç¨‹æ¯”å½“å‰çº¿ç¨‹æ›´æ—©åœ°è¯·æ±‚è·å–é”ï¼Œå› æ­¤éœ€è¦ç­‰å¾…å‰é©±çº¿ç¨‹è·å–å¹¶é‡Šæ”¾é”ä¹‹åæ‰èƒ½ç»§ç»­è·å–é”ã€‚ æ·±å…¥ç†è§£å¹¶å‘ç¼–ç¨‹å’Œå½’çº³æ€»ç»“JMMåŸºç¡€-è®¡ç®—æœºåŸç†Javaå†…å­˜æ¨¡å‹å³Java Memory Modelï¼Œç®€ç§°JMMã€‚JMMå®šä¹‰äº†Java è™šæ‹Ÿæœº(JVM)åœ¨è®¡ç®—æœºå†…å­˜(RAM)ä¸­çš„å·¥ä½œæ–¹å¼ã€‚JVMæ˜¯æ•´ä¸ªè®¡ç®—æœºè™šæ‹Ÿæ¨¡å‹ï¼Œæ‰€ä»¥JMMæ˜¯éš¶å±äºJVMçš„ã€‚Java1.5ç‰ˆæœ¬å¯¹å…¶è¿›è¡Œäº†é‡æ„ï¼Œç°åœ¨çš„Javaä»æ²¿ç”¨äº†Java1.5çš„ç‰ˆæœ¬ã€‚Jmmé‡åˆ°çš„é—®é¢˜ä¸ç°ä»£è®¡ç®—æœºä¸­é‡åˆ°çš„é—®é¢˜æ˜¯å·®ä¸å¤šçš„ã€‚ ç‰©ç†è®¡ç®—æœºä¸­çš„å¹¶å‘é—®é¢˜ï¼Œç‰©ç†æœºé‡åˆ°çš„å¹¶å‘é—®é¢˜ä¸è™šæ‹Ÿæœºä¸­çš„æƒ…å†µæœ‰ä¸å°‘ç›¸ä¼¼ä¹‹å¤„ï¼Œç‰©ç†æœºå¯¹å¹¶å‘çš„å¤„ç†æ–¹æ¡ˆå¯¹äºè™šæ‹Ÿæœºçš„å®ç°ä¹Ÿæœ‰ç›¸å½“å¤§çš„å‚è€ƒæ„ä¹‰ã€‚ æ ¹æ®ã€ŠJeff Deanåœ¨Googleå…¨ä½“å·¥ç¨‹å¤§ä¼šçš„æŠ¥å‘Šã€‹æˆ‘ä»¬å¯ä»¥çœ‹åˆ° è®¡ç®—æœºåœ¨åšä¸€äº›æˆ‘ä»¬å¹³æ—¶çš„åŸºæœ¬æ“ä½œæ—¶ï¼Œéœ€è¦çš„å“åº”æ—¶é—´æ˜¯ä¸ä¸€æ ·çš„ã€‚ ï¼ˆä»¥ä¸‹æ¡ˆä¾‹ä»…åšè¯´æ˜ï¼Œå¹¶ä¸ä»£è¡¨çœŸå®æƒ…å†µã€‚ï¼‰ å¦‚æœä»å†…å­˜ä¸­è¯»å–1Mçš„intå‹æ•°æ®ç”±CPUè¿›è¡Œç´¯åŠ ï¼Œè€—æ—¶è¦å¤šä¹…ï¼Ÿ åšä¸ªç®€å•çš„è®¡ç®—ï¼Œ1Mçš„æ•°æ®ï¼ŒJavaé‡Œintå‹ä¸º32ä½ï¼Œ4ä¸ªå­—èŠ‚ï¼Œå…±æœ‰10241024/4 = 262144ä¸ªæ•´æ•° ï¼Œåˆ™CPU è®¡ç®—è€—æ—¶ï¼š262144 0.6 = 157 286 çº³ç§’ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ä»å†…å­˜è¯»å–1Mæ•°æ®éœ€è¦250000çº³ç§’ï¼Œä¸¤è€…è™½ç„¶æœ‰å·®è·ï¼ˆå½“ç„¶è¿™ä¸ªå·®è·å¹¶ä¸å°ï¼Œåä¸‡çº³ç§’çš„æ—¶é—´è¶³å¤ŸCPUæ‰§è¡Œå°†è¿‘äºŒåä¸‡æ¡æŒ‡ä»¤äº†ï¼‰ï¼Œä½†æ˜¯è¿˜åœ¨ä¸€ä¸ªæ•°é‡çº§ä¸Šã€‚ä½†æ˜¯ï¼Œæ²¡æœ‰ä»»ä½•ç¼“å­˜æœºåˆ¶çš„æƒ…å†µä¸‹ï¼Œæ„å‘³ç€æ¯ä¸ªæ•°éƒ½éœ€è¦ä»å†…å­˜ä¸­è¯»å–ï¼Œè¿™æ ·åŠ ä¸ŠCPUè¯»å–ä¸€æ¬¡å†…å­˜éœ€è¦100çº³ç§’ï¼Œ262144ä¸ªæ•´æ•°ä»å†…å­˜è¯»å–åˆ°CPUåŠ ä¸Šè®¡ç®—æ—¶é—´ä¸€å…±éœ€è¦262144*100+250000 = 26 464 400 çº³ç§’ï¼Œè¿™å°±å­˜åœ¨ç€æ•°é‡çº§ä¸Šçš„å·®å¼‚äº†ã€‚ è€Œä¸”ç°å®æƒ…å†µä¸­ç»å¤§å¤šæ•°çš„è¿ç®—ä»»åŠ¡éƒ½ä¸å¯èƒ½åªé å¤„ç†å™¨â€œè®¡ç®—â€å°±èƒ½å®Œæˆï¼Œå¤„ç†å™¨è‡³å°‘è¦ä¸å†…å­˜äº¤äº’ï¼Œå¦‚è¯»å–è¿ç®—æ•°æ®ã€å­˜å‚¨è¿ç®—ç»“æœç­‰ï¼Œè¿™ä¸ªI/Oæ“ä½œæ˜¯åŸºæœ¬ä¸Šæ˜¯æ— æ³•æ¶ˆé™¤çš„ï¼ˆæ— æ³•ä»…é å¯„å­˜å™¨æ¥å®Œæˆæ‰€æœ‰è¿ç®—ä»»åŠ¡ï¼‰ã€‚æ—©æœŸè®¡ç®—æœºä¸­cpuå’Œå†…å­˜çš„é€Ÿåº¦æ˜¯å·®ä¸å¤šçš„ï¼Œä½†åœ¨ç°ä»£è®¡ç®—æœºä¸­ï¼Œcpuçš„æŒ‡ä»¤é€Ÿåº¦è¿œè¶…å†…å­˜çš„å­˜å–é€Ÿåº¦,ç”±äºè®¡ç®—æœºçš„å­˜å‚¨è®¾å¤‡ä¸å¤„ç†å™¨çš„è¿ç®—é€Ÿåº¦æœ‰å‡ ä¸ªæ•°é‡çº§çš„å·®è·ï¼Œæ‰€ä»¥ç°ä»£è®¡ç®—æœºç³»ç»Ÿéƒ½ä¸å¾—ä¸åŠ å…¥ä¸€å±‚è¯»å†™é€Ÿåº¦å°½å¯èƒ½æ¥è¿‘å¤„ç†å™¨è¿ç®—é€Ÿåº¦çš„é«˜é€Ÿç¼“å­˜ï¼ˆCacheï¼‰æ¥ä½œä¸ºå†…å­˜ä¸å¤„ç†å™¨ä¹‹é—´çš„ç¼“å†²ï¼šå°†è¿ç®—éœ€è¦ä½¿ç”¨åˆ°çš„æ•°æ®å¤åˆ¶åˆ°ç¼“å­˜ä¸­ï¼Œè®©è¿ç®—èƒ½å¿«é€Ÿè¿›è¡Œï¼Œå½“è¿ç®—ç»“æŸåå†ä»ç¼“å­˜åŒæ­¥å›å†…å­˜ä¹‹ä¸­ï¼Œè¿™æ ·å¤„ç†å™¨å°±æ— é¡»ç­‰å¾…ç¼“æ…¢çš„å†…å­˜è¯»å†™äº†ã€‚ åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå¯„å­˜å™¨åˆ’æ˜¯L0çº§ç¼“å­˜ï¼Œæ¥ç€ä¾æ¬¡æ˜¯L1ï¼ŒL2ï¼ŒL3ï¼ˆæ¥ä¸‹æ¥æ˜¯å†…å­˜ï¼Œæœ¬åœ°ç£ç›˜ï¼Œè¿œç¨‹å­˜å‚¨ï¼‰ã€‚è¶Šå¾€ä¸Šçš„ç¼“å­˜å­˜å‚¨ç©ºé—´è¶Šå°ï¼Œé€Ÿåº¦è¶Šå¿«ï¼Œæˆæœ¬ä¹Ÿæ›´é«˜ï¼›è¶Šå¾€ä¸‹çš„å­˜å‚¨ç©ºé—´è¶Šå¤§ï¼Œé€Ÿåº¦æ›´æ…¢ï¼Œæˆæœ¬ä¹Ÿæ›´ä½ã€‚ä»ä¸Šè‡³ä¸‹ï¼Œæ¯ä¸€å±‚éƒ½å¯ä»¥çœ‹åšæ˜¯æ›´ä¸‹ä¸€å±‚çš„ç¼“å­˜ï¼Œå³ï¼šL0å¯„å­˜å™¨æ˜¯L1ä¸€çº§ç¼“å­˜çš„ç¼“å­˜ï¼ŒL1æ˜¯L2çš„ç¼“å­˜ï¼Œä¾æ¬¡ç±»æ¨ï¼›æ¯ä¸€å±‚çš„æ•°æ®éƒ½æ˜¯æ¥è‡³å®ƒçš„ä¸‹ä¸€å±‚ï¼Œæ‰€ä»¥æ¯ä¸€å±‚çš„æ•°æ®æ˜¯ä¸‹ä¸€å±‚çš„æ•°æ®çš„å­é›†ã€‚ åœ¨ç°ä»£CPUä¸Šï¼Œä¸€èˆ¬æ¥è¯´L0ï¼Œ L1ï¼ŒL2ï¼ŒL3éƒ½é›†æˆåœ¨CPUå†…éƒ¨ï¼Œè€ŒL1è¿˜åˆ†ä¸ºä¸€çº§æ•°æ®ç¼“å­˜ï¼ˆData Cacheï¼ŒD-Cacheï¼ŒL1dï¼‰å’Œä¸€çº§æŒ‡ä»¤ç¼“å­˜ï¼ˆInstruction Cacheï¼ŒI-Cacheï¼ŒL1iï¼‰ï¼Œåˆ†åˆ«ç”¨äºå­˜æ”¾æ•°æ®å’Œæ‰§è¡Œæ•°æ®çš„æŒ‡ä»¤è§£ç ã€‚æ¯ä¸ªæ ¸å¿ƒæ‹¥æœ‰ç‹¬ç«‹çš„è¿ç®—å¤„ç†å•å…ƒã€æ§åˆ¶å™¨ã€å¯„å­˜å™¨ã€L1ã€L2ç¼“å­˜ï¼Œç„¶åä¸€ä¸ªCPUçš„å¤šä¸ªæ ¸å¿ƒå…±äº«æœ€åä¸€å±‚CPUç¼“å­˜L3 Javaå†…å­˜æ¨¡å‹ï¼ˆJMMï¼‰ä»æŠ½è±¡çš„è§’åº¦æ¥çœ‹ï¼ŒJMMå®šä¹‰äº†çº¿ç¨‹å’Œä¸»å†…å­˜ä¹‹é—´çš„æŠ½è±¡å…³ç³»ï¼šçº¿ç¨‹ä¹‹é—´çš„å…±äº«å˜é‡å­˜å‚¨åœ¨ä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ä¸­ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç§æœ‰çš„æœ¬åœ°å†…å­˜ï¼ˆLocal Memoryï¼‰ï¼Œæœ¬åœ°å†…å­˜ä¸­å­˜å‚¨äº†è¯¥çº¿ç¨‹ä»¥è¯»/å†™å…±äº«å˜é‡çš„å‰¯æœ¬ã€‚æœ¬åœ°å†…å­˜æ˜¯JMMçš„ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå¹¶ä¸çœŸå®å­˜åœ¨ã€‚å®ƒæ¶µç›–äº†ç¼“å­˜ã€å†™ç¼“å†²åŒºã€å¯„å­˜å™¨ä»¥åŠå…¶ä»–çš„ç¡¬ä»¶å’Œç¼–è¯‘å™¨ä¼˜åŒ–ã€‚ å¯è§æ€§å¯è§æ€§æ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼ã€‚ ç”±äºçº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å†™ä¸»å†…å­˜ä¸­çš„å˜é‡ï¼Œé‚£ä¹ˆå¯¹äºå…±äº«å˜é‡Vï¼Œå®ƒä»¬é¦–å…ˆæ˜¯åœ¨è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œä¹‹åå†åŒæ­¥åˆ°ä¸»å†…å­˜ã€‚å¯æ˜¯å¹¶ä¸ä¼šåŠæ—¶çš„åˆ·åˆ°ä¸»å­˜ä¸­ï¼Œè€Œæ˜¯ä¼šæœ‰ä¸€å®šæ—¶é—´å·®ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹ A å¯¹å˜é‡ V çš„æ“ä½œå¯¹äºçº¿ç¨‹ B è€Œè¨€å°±ä¸å…·å¤‡å¯è§æ€§äº† ã€‚ è¦è§£å†³å…±äº«å¯¹è±¡å¯è§æ€§è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨volatileå…³é”®å­—æˆ–è€…æ˜¯åŠ é”ã€‚ åŸå­æ€§åŸå­æ€§ï¼šå³ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œ è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¹¶ä¸”æ‰§è¡Œçš„è¿‡ç¨‹ä¸ä¼šè¢«ä»»ä½•å› ç´ æ‰“æ–­ï¼Œè¦ä¹ˆå°±éƒ½ä¸æ‰§è¡Œã€‚ æˆ‘ä»¬éƒ½çŸ¥é“CPUèµ„æºçš„åˆ†é…éƒ½æ˜¯ä»¥çº¿ç¨‹ä¸ºå•ä½çš„,å¹¶ä¸”æ˜¯åˆ†æ—¶è°ƒç”¨,æ“ä½œç³»ç»Ÿå…è®¸æŸä¸ªè¿›ç¨‹æ‰§è¡Œä¸€å°æ®µæ—¶é—´ï¼Œä¾‹å¦‚ 50 æ¯«ç§’ï¼Œè¿‡äº† 50 æ¯«ç§’æ“ä½œç³»ç»Ÿå°±ä¼šé‡æ–°é€‰æ‹©ä¸€ä¸ªè¿›ç¨‹æ¥æ‰§è¡Œï¼ˆæˆ‘ä»¬ç§°ä¸ºâ€œä»»åŠ¡åˆ‡æ¢â€ï¼‰ï¼Œè¿™ä¸ª 50 æ¯«ç§’ç§°ä¸ºâ€œæ—¶é—´ç‰‡â€ã€‚è€Œä»»åŠ¡çš„åˆ‡æ¢å¤§å¤šæ•°æ˜¯åœ¨æ—¶é—´ç‰‡æ®µç»“æŸä»¥å, é‚£ä¹ˆçº¿ç¨‹åˆ‡æ¢ä¸ºä»€ä¹ˆä¼šå¸¦æ¥bugå‘¢ï¼Ÿå› ä¸ºæ“ä½œç³»ç»Ÿåšä»»åŠ¡åˆ‡æ¢ï¼Œå¯ä»¥å‘ç”Ÿåœ¨ä»»ä½•ä¸€æ¡CPU æŒ‡ä»¤æ‰§è¡Œå®Œï¼æ³¨æ„ï¼Œæ˜¯ CPU æŒ‡ä»¤ï¼ŒCPU æŒ‡ä»¤ï¼ŒCPU æŒ‡ä»¤ï¼Œè€Œä¸æ˜¯é«˜çº§è¯­è¨€é‡Œçš„ä¸€æ¡è¯­å¥ã€‚æ¯”å¦‚count++ï¼Œåœ¨javaé‡Œå°±æ˜¯ä¸€å¥è¯ï¼Œä½†é«˜çº§è¯­è¨€é‡Œä¸€æ¡è¯­å¥å¾€å¾€éœ€è¦å¤šæ¡ CPU æŒ‡ä»¤å®Œæˆã€‚å…¶å®count++åŒ…å«äº†ä¸‰ä¸ªCPUæŒ‡ä»¤ï¼ volatileè¯¦è§£volatileç‰¹æ€§å¯ä»¥æŠŠå¯¹volatileå˜é‡çš„å•ä¸ªè¯»/å†™ï¼Œçœ‹æˆæ˜¯ä½¿ç”¨åŒä¸€ä¸ªé”å¯¹è¿™äº›å•ä¸ªè¯»/å†™æ“ä½œåšäº†åŒæ­¥ å¯ä»¥çœ‹æˆ æ‰€ä»¥volatileå˜é‡è‡ªèº«å…·æœ‰ä¸‹åˆ—ç‰¹æ€§ï¼š å¯è§æ€§ã€‚å¯¹ä¸€ä¸ªvolatileå˜é‡çš„è¯»ï¼Œæ€»æ˜¯èƒ½çœ‹åˆ°ï¼ˆä»»æ„çº¿ç¨‹ï¼‰å¯¹è¿™ä¸ªvolatileå˜é‡æœ€åçš„å†™å…¥ã€‚ åŸå­æ€§ï¼šå¯¹ä»»æ„å•ä¸ªvolatileå˜é‡çš„è¯»/å†™å…·æœ‰åŸå­æ€§ï¼Œä½†ç±»ä¼¼äºvolatile++è¿™ç§å¤åˆæ“ä½œä¸å…·æœ‰åŸå­æ€§ã€‚ volatileè™½ç„¶èƒ½ä¿è¯æ‰§è¡Œå®ŒåŠæ—¶æŠŠå˜é‡åˆ·åˆ°ä¸»å†…å­˜ä¸­ï¼Œä½†å¯¹äºcount++è¿™ç§éåŸå­æ€§ã€å¤šæŒ‡ä»¤çš„æƒ…å†µï¼Œç”±äºçº¿ç¨‹åˆ‡æ¢ï¼Œçº¿ç¨‹AåˆšæŠŠcount=0åŠ è½½åˆ°å·¥ä½œå†…å­˜ï¼Œçº¿ç¨‹Bå°±å¯ä»¥å¼€å§‹å·¥ä½œäº†ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´çº¿ç¨‹Aå’ŒBæ‰§è¡Œå®Œçš„ç»“æœéƒ½æ˜¯1ï¼Œéƒ½å†™åˆ°ä¸»å†…å­˜ä¸­ï¼Œä¸»å†…å­˜çš„å€¼è¿˜æ˜¯1ä¸æ˜¯2 volatileçš„å®ç°åŸç†é€šè¿‡å¯¹OpenJDKä¸­çš„unsafe.cppæºç çš„åˆ†æï¼Œä¼šå‘ç°è¢«volatileå…³é”®å­—ä¿®é¥°çš„å˜é‡ä¼šå­˜åœ¨ä¸€ä¸ªâ€œlock:â€çš„å‰ç¼€ã€‚ Lockå‰ç¼€ï¼ŒLockä¸æ˜¯ä¸€ç§å†…å­˜å±éšœï¼Œä½†æ˜¯å®ƒèƒ½å®Œæˆç±»ä¼¼å†…å­˜å±éšœçš„åŠŸèƒ½ã€‚Lockä¼šå¯¹CPUæ€»çº¿å’Œé«˜é€Ÿç¼“å­˜åŠ é”ï¼Œå¯ä»¥ç†è§£ä¸ºCPUæŒ‡ä»¤çº§çš„ä¸€ç§é”ã€‚ åŒæ—¶è¯¥æŒ‡ä»¤ä¼šå°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®ç›´æ¥å†™ä¼šåˆ°ç³»ç»Ÿå†…å­˜ä¸­ï¼Œä¸”è¿™ä¸ªå†™å›å†…å­˜çš„æ“ä½œä¼šä½¿åœ¨å…¶ä»–CPUé‡Œç¼“å­˜äº†è¯¥åœ°å€çš„æ•°æ®æ— æ•ˆã€‚ synchronizedçš„å®ç°åŸç†Synchronizedåœ¨JVMé‡Œçš„å®ç°éƒ½æ˜¯åŸºäºè¿›å…¥å’Œé€€å‡ºMonitorå¯¹è±¡æ¥å®ç°æ–¹æ³•åŒæ­¥å’Œä»£ç å—åŒæ­¥ï¼Œè™½ç„¶å…·ä½“å®ç°ç»†èŠ‚ä¸ä¸€æ ·ï¼Œä½†æ˜¯éƒ½å¯ä»¥é€šè¿‡æˆå¯¹çš„MonitorEnterå’ŒMonitorExitæŒ‡ä»¤æ¥å®ç°ã€‚ å¯¹åŒæ­¥å—ï¼ŒMonitorEnteræŒ‡ä»¤æ’å…¥åœ¨åŒæ­¥ä»£ç å—çš„å¼€å§‹ä½ç½®ï¼Œå½“ä»£ç æ‰§è¡Œåˆ°è¯¥æŒ‡ä»¤æ—¶ï¼Œå°†ä¼šå°è¯•è·å–è¯¥å¯¹è±¡Monitorçš„æ‰€æœ‰æƒï¼Œå³å°è¯•è·å¾—è¯¥å¯¹è±¡çš„é”ï¼Œè€ŒmonitorExitæŒ‡ä»¤åˆ™æ’å…¥åœ¨æ–¹æ³•ç»“æŸå¤„å’Œå¼‚å¸¸å¤„ï¼ŒJVMä¿è¯æ¯ä¸ªMonitorEnterå¿…é¡»æœ‰å¯¹åº”çš„MonitorExitã€‚ å¯¹åŒæ­¥æ–¹æ³•ï¼Œä»åŒæ­¥æ–¹æ³•åç¼–è¯‘çš„ç»“æœæ¥çœ‹ï¼Œæ–¹æ³•çš„åŒæ­¥å¹¶æ²¡æœ‰é€šè¿‡æŒ‡ä»¤monitorenterå’Œmonitorexitæ¥å®ç°ï¼Œç›¸å¯¹äºæ™®é€šæ–¹æ³•ï¼Œå…¶å¸¸é‡æ± ä¸­å¤šäº†ACC_SYNCHRONIZEDæ ‡ç¤ºç¬¦ã€‚ JVMå°±æ˜¯æ ¹æ®è¯¥æ ‡ç¤ºç¬¦æ¥å®ç°æ–¹æ³•çš„åŒæ­¥çš„ï¼šå½“æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œè°ƒç”¨æŒ‡ä»¤å°†ä¼šæ£€æŸ¥æ–¹æ³•çš„ ACC_SYNCHRONIZED è®¿é—®æ ‡å¿—æ˜¯å¦è¢«è®¾ç½®ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œæ‰§è¡Œçº¿ç¨‹å°†å…ˆè·å–monitorï¼Œè·å–æˆåŠŸä¹‹åæ‰èƒ½æ‰§è¡Œæ–¹æ³•ä½“ï¼Œæ–¹æ³•æ‰§è¡Œå®Œåå†é‡Šæ”¾monitorã€‚åœ¨æ–¹æ³•æ‰§è¡ŒæœŸé—´ï¼Œå…¶ä»–ä»»ä½•çº¿ç¨‹éƒ½æ— æ³•å†è·å¾—åŒä¸€ä¸ªmonitorå¯¹è±¡ã€‚ synchronizedä½¿ç”¨çš„é”æ˜¯å­˜æ”¾åœ¨Javaå¯¹è±¡å¤´é‡Œé¢ï¼Œ å…·ä½“ä½ç½®æ˜¯å¯¹è±¡å¤´é‡Œé¢çš„MarkWordï¼ŒMarkWordé‡Œé»˜è®¤æ•°æ®æ˜¯å­˜å‚¨å¯¹è±¡çš„HashCodeç­‰ä¿¡æ¯ï¼Œ ä½†æ˜¯ä¼šéšç€å¯¹è±¡çš„è¿è¡Œæ”¹å˜è€Œå‘ç”Ÿå˜åŒ–ï¼Œä¸åŒçš„é”çŠ¶æ€å¯¹åº”ç€ä¸åŒçš„è®°å½•å­˜å‚¨æ–¹å¼ äº†è§£å„ç§é”è‡ªæ—‹é”åŸç†è‡ªæ—‹é”åŸç†éå¸¸ç®€å•ï¼Œå¦‚æœæŒæœ‰é”çš„çº¿ç¨‹èƒ½åœ¨å¾ˆçŸ­æ—¶é—´å†…é‡Šæ”¾é”èµ„æºï¼Œé‚£ä¹ˆé‚£äº›ç­‰å¾…ç«äº‰é”çš„çº¿ç¨‹å°±ä¸éœ€è¦åšå†…æ ¸æ€å’Œç”¨æˆ·æ€ä¹‹é—´çš„åˆ‡æ¢è¿›å…¥é˜»å¡æŒ‚èµ·çŠ¶æ€ï¼Œå®ƒä»¬åªéœ€è¦ç­‰ä¸€ç­‰ï¼ˆè‡ªæ—‹ï¼‰ï¼Œç­‰æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾é”åå³å¯ç«‹å³è·å–é”ï¼Œè¿™æ ·å°±é¿å…ç”¨æˆ·çº¿ç¨‹å’Œå†…æ ¸çš„åˆ‡æ¢çš„æ¶ˆè€—ã€‚ ä½†æ˜¯çº¿ç¨‹è‡ªæ—‹æ˜¯éœ€è¦æ¶ˆè€—CPUçš„ï¼Œè¯´ç™½äº†å°±æ˜¯è®©CPUåœ¨åšæ— ç”¨åŠŸï¼Œçº¿ç¨‹ä¸èƒ½ä¸€ç›´å ç”¨CPUè‡ªæ—‹åšæ— ç”¨åŠŸï¼Œæ‰€ä»¥éœ€è¦è®¾å®šä¸€ä¸ªè‡ªæ—‹ç­‰å¾…çš„æœ€å¤§æ—¶é—´ã€‚ å¦‚æœæŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œçš„æ—¶é—´è¶…è¿‡è‡ªæ—‹ç­‰å¾…çš„æœ€å¤§æ—¶é—´æ‰”æ²¡æœ‰é‡Šæ”¾é”ï¼Œå°±ä¼šå¯¼è‡´å…¶å®ƒäº‰ç”¨é”çš„çº¿ç¨‹åœ¨æœ€å¤§ç­‰å¾…æ—¶é—´å†…è¿˜æ˜¯è·å–ä¸åˆ°é”ï¼Œè¿™æ—¶äº‰ç”¨çº¿ç¨‹ä¼šåœæ­¢è‡ªæ—‹è¿›å…¥é˜»å¡çŠ¶æ€ã€‚ è‡ªæ—‹é”çš„ä¼˜ç¼ºç‚¹è‡ªæ—‹é”å°½å¯èƒ½çš„å‡å°‘çº¿ç¨‹çš„é˜»å¡ï¼Œè¿™å¯¹äºé”çš„ç«äº‰ä¸æ¿€çƒˆï¼Œä¸”å ç”¨é”æ—¶é—´éå¸¸çŸ­çš„ä»£ç å—æ¥è¯´æ€§èƒ½èƒ½å¤§å¹…åº¦çš„æå‡ï¼Œå› ä¸ºè‡ªæ—‹çš„æ¶ˆè€—ä¼šå°äºçº¿ç¨‹é˜»å¡æŒ‚èµ·æ“ä½œçš„æ¶ˆè€—ï¼ ä½†æ˜¯å¦‚æœé”çš„ç«äº‰æ¿€çƒˆï¼Œæˆ–è€…æŒæœ‰é”çš„çº¿ç¨‹éœ€è¦é•¿æ—¶é—´å ç”¨é”æ‰§è¡ŒåŒæ­¥å—ï¼Œè¿™æ—¶å€™å°±ä¸é€‚åˆä½¿ç”¨è‡ªæ—‹é”äº†ï¼Œå› ä¸ºè‡ªæ—‹é”åœ¨è·å–é”å‰ä¸€ç›´éƒ½æ˜¯å ç”¨cpuåšæ— ç”¨åŠŸï¼Œå ç€XXä¸XXï¼Œçº¿ç¨‹è‡ªæ—‹çš„æ¶ˆè€—å¤§äºçº¿ç¨‹é˜»å¡æŒ‚èµ·æ“ä½œçš„æ¶ˆè€—ï¼Œå…¶å®ƒéœ€è¦cupçš„çº¿ç¨‹åˆä¸èƒ½è·å–åˆ°cpuï¼Œé€ æˆcpuçš„æµªè´¹ã€‚ è‡ªæ—‹é”æ—¶é—´é˜ˆå€¼è‡ªæ—‹é”çš„ç›®çš„æ˜¯ä¸ºäº†å ç€CPUçš„èµ„æºä¸é‡Šæ”¾ï¼Œç­‰åˆ°è·å–åˆ°é”ç«‹å³è¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯å¦‚ä½•å»é€‰æ‹©è‡ªæ—‹çš„æ‰§è¡Œæ—¶é—´å‘¢ï¼Ÿå¦‚æœè‡ªæ—‹æ‰§è¡Œæ—¶é—´å¤ªé•¿ï¼Œä¼šæœ‰å¤§é‡çš„çº¿ç¨‹å¤„äºè‡ªæ—‹çŠ¶æ€å ç”¨CPUèµ„æºï¼Œè¿›è€Œä¼šå½±å“æ•´ä½“ç³»ç»Ÿçš„æ€§èƒ½ã€‚å› æ­¤è‡ªæ—‹æ¬¡æ•°å¾ˆé‡è¦ JVMå¯¹äºè‡ªæ—‹æ¬¡æ•°çš„é€‰æ‹©ï¼Œjdk1.5é»˜è®¤ä¸º10æ¬¡ï¼Œåœ¨1.6å¼•å…¥äº†é€‚åº”æ€§è‡ªæ—‹é”ï¼Œé€‚åº”æ€§è‡ªæ—‹é”æ„å‘³ç€è‡ªæ—‹çš„æ—¶é—´ä¸åœ¨æ˜¯å›ºå®šçš„äº†ï¼Œè€Œæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´ä»¥åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šï¼ŒåŸºæœ¬è®¤ä¸ºä¸€ä¸ªçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶é—´æ˜¯æœ€ä½³çš„ä¸€ä¸ªæ—¶é—´ã€‚ JDK1.6ä¸­-XX:+UseSpinningå¼€å¯è‡ªæ—‹é”ï¼› JDK1.7åï¼Œå»æ‰æ­¤å‚æ•°ï¼Œç”±jvmæ§åˆ¶ï¼› é”çš„çŠ¶æ€ä¸€å…±æœ‰å››ç§çŠ¶æ€ï¼Œæ— é”çŠ¶æ€ï¼Œåå‘é”çŠ¶æ€ï¼Œè½»é‡çº§é”çŠ¶æ€å’Œé‡é‡çº§é”çŠ¶æ€ï¼Œå®ƒä¼šéšç€ç«äº‰æƒ…å†µé€æ¸å‡çº§ã€‚é”å¯ä»¥å‡çº§ä½†ä¸èƒ½é™çº§ï¼Œç›®çš„æ˜¯ä¸ºäº†æé«˜è·å¾—é”å’Œé‡Šæ”¾é”çš„æ•ˆç‡ã€‚ åå‘é”å¼•å…¥èƒŒæ™¯ï¼šå¤§å¤šæ•°æƒ…å†µä¸‹é”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œä¸ºäº†è®©çº¿ç¨‹è·å¾—é”çš„ä»£ä»·æ›´ä½è€Œå¼•å…¥äº†åå‘é”ï¼Œå‡å°‘ä¸å¿…è¦çš„CASæ“ä½œã€‚ åå‘é”ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒä¼šåå‘äºç¬¬ä¸€ä¸ªè®¿é—®é”çš„çº¿ç¨‹ï¼Œå¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒåŒæ­¥é”åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®ï¼Œä¸å­˜åœ¨å¤šçº¿ç¨‹äº‰ç”¨çš„æƒ…å†µï¼Œåˆ™çº¿ç¨‹æ˜¯ä¸éœ€è¦è§¦å‘åŒæ­¥çš„ï¼Œå‡å°‘åŠ é”ï¼è§£é”çš„ä¸€äº›CASæ“ä½œï¼ˆæ¯”å¦‚ç­‰å¾…é˜Ÿåˆ—çš„ä¸€äº›CASæ“ä½œï¼‰ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå°±ä¼šç»™çº¿ç¨‹åŠ ä¸€ä¸ªåå‘é”ã€‚ å¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†å…¶ä»–çº¿ç¨‹æŠ¢å é”ï¼Œåˆ™æŒæœ‰åå‘é”çš„çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼ŒJVMä¼šæ¶ˆé™¤å®ƒèº«ä¸Šçš„åå‘é”ï¼Œå°†é”æ¢å¤åˆ°æ ‡å‡†çš„è½»é‡çº§é”ã€‚å®ƒé€šè¿‡æ¶ˆé™¤èµ„æºæ— ç«äº‰æƒ…å†µä¸‹çš„åŒæ­¥åŸè¯­ï¼Œè¿›ä¸€æ­¥æé«˜äº†ç¨‹åºçš„è¿è¡Œæ€§èƒ½ã€‚ åå‘é”è·å–è¿‡ç¨‹ï¼š æ­¥éª¤1ã€ è®¿é—®Mark Wordä¸­åå‘é”çš„æ ‡è¯†æ˜¯å¦è®¾ç½®æˆ1ï¼Œé”æ ‡å¿—ä½æ˜¯å¦ä¸º01ï¼Œç¡®è®¤ä¸ºå¯åå‘çŠ¶æ€ã€‚ æ­¥éª¤2ã€ å¦‚æœä¸ºå¯åå‘çŠ¶æ€ï¼Œåˆ™æµ‹è¯•çº¿ç¨‹IDæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œè¿›å…¥æ­¥éª¤5ï¼Œå¦åˆ™è¿›å…¥æ­¥éª¤3ã€‚ æ­¥éª¤3ã€ å¦‚æœçº¿ç¨‹IDå¹¶æœªæŒ‡å‘å½“å‰çº¿ç¨‹ï¼Œåˆ™é€šè¿‡CASæ“ä½œç«äº‰é”ã€‚å¦‚æœç«äº‰æˆåŠŸï¼Œåˆ™å°†Mark Wordä¸­çº¿ç¨‹IDè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹IDï¼Œç„¶åæ‰§è¡Œ5ï¼›å¦‚æœç«äº‰å¤±è´¥ï¼Œæ‰§è¡Œ4ã€‚ æ­¥éª¤4ã€ å¦‚æœCASè·å–åå‘é”å¤±è´¥ï¼Œåˆ™è¡¨ç¤ºæœ‰ç«äº‰ã€‚å½“åˆ°è¾¾å…¨å±€å®‰å…¨ç‚¹ï¼ˆsafepointï¼‰æ—¶è·å¾—åå‘é”çš„çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œåå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œç„¶åè¢«é˜»å¡åœ¨å®‰å…¨ç‚¹çš„çº¿ç¨‹ç»§ç»­å¾€ä¸‹æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚ï¼ˆæ’¤é”€åå‘é”çš„æ—¶å€™ä¼šå¯¼è‡´stop the wordï¼‰ æ­¥éª¤5ã€ æ‰§è¡ŒåŒæ­¥ä»£ç ã€‚ åå‘é”çš„é‡Šæ”¾ï¼š åå‘é”çš„æ’¤é”€åœ¨ä¸Šè¿°ç¬¬å››æ­¥éª¤ä¸­æœ‰æåˆ°ã€‚åå‘é”åªæœ‰é‡åˆ°å…¶ä»–çº¿ç¨‹å°è¯•ç«äº‰åå‘é”æ—¶ï¼ŒæŒæœ‰åå‘é”çš„çº¿ç¨‹æ‰ä¼šé‡Šæ”¾åå‘é”ï¼Œçº¿ç¨‹ä¸ä¼šä¸»åŠ¨å»é‡Šæ”¾åå‘é”ã€‚åå‘é”çš„æ’¤é”€ï¼Œéœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹ï¼ˆåœ¨è¿™ä¸ªæ—¶é—´ç‚¹ä¸Šæ²¡æœ‰å­—èŠ‚ç æ­£åœ¨æ‰§è¡Œï¼‰ï¼Œå®ƒä¼šé¦–å…ˆæš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œåˆ¤æ–­é”å¯¹è±¡æ˜¯å¦å¤„äºè¢«é”å®šçŠ¶æ€ï¼Œæ’¤é”€åå‘é”åæ¢å¤åˆ°æœªé”å®šï¼ˆæ ‡å¿—ä½ä¸ºâ€œ01â€ï¼‰æˆ–è½»é‡çº§é”ï¼ˆæ ‡å¿—ä½ä¸ºâ€œ00â€ï¼‰çš„çŠ¶æ€ã€‚ åå‘é”çš„é€‚ç”¨åœºæ™¯ å§‹ç»ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡ŒåŒæ­¥å—ï¼Œåœ¨å®ƒæ²¡æœ‰æ‰§è¡Œå®Œé‡Šæ”¾é”ä¹‹å‰ï¼Œæ²¡æœ‰å…¶å®ƒçº¿ç¨‹å»æ‰§è¡ŒåŒæ­¥å—ï¼Œåœ¨é”æ— ç«äº‰çš„æƒ…å†µä¸‹ä½¿ç”¨ï¼Œä¸€æ—¦æœ‰äº†ç«äº‰å°±å‡çº§ä¸ºè½»é‡çº§é”ï¼Œå‡çº§ä¸ºè½»é‡çº§é”çš„æ—¶å€™éœ€è¦æ’¤é”€åå‘é”ï¼Œæ’¤é”€åå‘é”çš„æ—¶å€™ä¼šå¯¼è‡´stop the wordæ“ä½œï¼› åœ¨æœ‰é”çš„ç«äº‰æ—¶ï¼Œåå‘é”ä¼šå¤šåšå¾ˆå¤šé¢å¤–æ“ä½œï¼Œå°¤å…¶æ˜¯æ’¤é”€åå‘æ‰€çš„æ—¶å€™ä¼šå¯¼è‡´è¿›å…¥å®‰å…¨ç‚¹ï¼Œå®‰å…¨ç‚¹ä¼šå¯¼è‡´stwï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œè¿™ç§æƒ…å†µä¸‹åº”å½“ç¦ç”¨ã€‚ jvmå¼€å¯/å…³é—­åå‘é” å¼€å¯åå‘é”ï¼š-XX:+UseBiasedLocking -XX:BiasedLockingStartupDelay=0 å…³é—­åå‘é”ï¼š-XX:-UseBiasedLocking è½»é‡çº§é”è½»é‡çº§é”æ˜¯ç”±åå‘é”å‡çº§æ¥çš„ï¼Œåå‘é”è¿è¡Œåœ¨ä¸€ä¸ªçº¿ç¨‹è¿›å…¥åŒæ­¥å—çš„æƒ…å†µä¸‹ï¼Œå½“ç¬¬äºŒä¸ªçº¿ç¨‹åŠ å…¥é”äº‰ç”¨çš„æ—¶å€™ï¼Œåå‘é”å°±ä¼šå‡çº§ä¸ºè½»é‡çº§é”ï¼› è½»é‡çº§é”çš„åŠ é”è¿‡ç¨‹ï¼š åœ¨ä»£ç è¿›å…¥åŒæ­¥å—çš„æ—¶å€™ï¼Œå¦‚æœåŒæ­¥å¯¹è±¡é”çŠ¶æ€ä¸ºæ— é”çŠ¶æ€ä¸”ä¸å…è®¸è¿›è¡Œåå‘ï¼ˆé”æ ‡å¿—ä½ä¸ºâ€œ01â€çŠ¶æ€ï¼Œæ˜¯å¦ä¸ºåå‘é”ä¸ºâ€œ0â€ï¼‰ï¼Œè™šæ‹Ÿæœºé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„æ ˆå¸§ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ï¼Œå®˜æ–¹ç§°ä¹‹ä¸º Displaced Mark Wordã€‚ æ‹·è´æˆåŠŸåï¼Œè™šæ‹Ÿæœºå°†ä½¿ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆï¼Œå¹¶å°†Lock recordé‡Œçš„owneræŒ‡é’ˆæŒ‡å‘object mark wordã€‚å¦‚æœæ›´æ–°æˆåŠŸï¼Œåˆ™æ‰§è¡Œæ­¥éª¤4ï¼Œå¦åˆ™æ‰§è¡Œæ­¥éª¤5ã€‚ å¦‚æœè¿™ä¸ªæ›´æ–°åŠ¨ä½œæˆåŠŸäº†ï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±æ‹¥æœ‰äº†è¯¥å¯¹è±¡çš„é”ï¼Œå¹¶ä¸”å¯¹è±¡Mark Wordçš„é”æ ‡å¿—ä½è®¾ç½®ä¸ºâ€œ00â€ï¼Œå³è¡¨ç¤ºæ­¤å¯¹è±¡å¤„äºè½»é‡çº§é”å®šçŠ¶æ€ å¦‚æœè¿™ä¸ªæ›´æ–°æ“ä½œå¤±è´¥äº†ï¼Œè™šæ‹Ÿæœºé¦–å…ˆä¼šæ£€æŸ¥å¯¹è±¡çš„Mark Wordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯å°±è¯´æ˜å½“å‰çº¿ç¨‹å·²ç»æ‹¥æœ‰äº†è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œé‚£å°±å¯ä»¥ç›´æ¥è¿›å…¥åŒæ­¥å—ç»§ç»­æ‰§è¡Œã€‚å¦åˆ™è¯´æ˜å¤šä¸ªçº¿ç¨‹ç«äº‰é”ï¼Œå½“ç«äº‰çº¿ç¨‹å°è¯•å ç”¨è½»é‡çº§é”å¤±è´¥å¤šæ¬¡ä¹‹åï¼Œè½»é‡çº§é”å°±ä¼šè†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œé‡é‡çº§çº¿ç¨‹æŒ‡é’ˆæŒ‡å‘ç«äº‰çº¿ç¨‹ï¼Œç«äº‰çº¿ç¨‹ä¹Ÿä¼šé˜»å¡ï¼Œç­‰å¾…è½»é‡çº§çº¿ç¨‹é‡Šæ”¾é”åå”¤é†’ä»–ã€‚é”æ ‡å¿—çš„çŠ¶æ€å€¼å˜ä¸ºâ€œ10â€ï¼ŒMark Wordä¸­å­˜å‚¨çš„å°±æ˜¯æŒ‡å‘é‡é‡çº§é”ï¼ˆäº’æ–¥é‡ï¼‰çš„æŒ‡é’ˆï¼Œåé¢ç­‰å¾…é”çš„çº¿ç¨‹ä¹Ÿè¦è¿›å…¥é˜»å¡çŠ¶æ€ã€‚ ä¸åŒé”çš„æ¯”è¾ƒ","link":"/2020/10/26/Java%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E8%A1%A5%E5%85%A8/"},{"title":"ä¸­å›½è¿‘ä»£å²å¤§çº²","text":"ä¸€ã€ç¬¬ä¸€æ¬¡é¸¦ç‰‡æˆ˜äº‰æ—¶æœŸ 1.1839å¹´ï¼š æ—åˆ™å¾åœ¨å¹¿å·ç¦çƒŸã€‚ æ—åˆ™å¾ç¼–å†™ã€Šå››æ´²å¿—ã€‹ï¼›ççœ¼çœ‹ä¸–ç•Œç¬¬ä¸€äººï¼› 6æœˆåœ¨è™é—¨æµ·æ»©é”€çƒŸã€‚è‹±å›½æ”¿åºœå†³å®šå‘åŠ¨ä¾µç•¥ä¸­å›½æˆ˜äº‰ã€‚2.1840å¹´ï¼š 6æœˆï¼Œé¸¦ç‰‡æˆ˜äº‰çˆ†å‘ï¼Œè‹±å†›ä»å¹¿å·è½¬æ”»å¦é—¨ï¼Œæ”»é™·å®šæµ·ï¼ŒåŒ—çŠ¯å¤©æ´¥ã€‚3.1841å¹´ï¼š 1æœˆï¼Œç¦å–„åŒè‹±å›½ç­¾è®¢ã€Šç©¿é¼»è‰çº¦ã€‹ï¼Œé“å…‰å¸ä¸æ»¡ï¼Œæ´¾å¥•å±±åˆ°å¹¿å·ä¸»æŒå†›äº‹ï¼Œå¯¹è‹±ä½œæˆ˜ã€‚å…³å¤©åŸ¹åœ¨è™é—¨ç‚®å°æŠ—å‡»è‹±å†›ï¼Œå£®çƒˆç‰ºç‰²ã€‚ 5æœˆï¼Œè‹±å†›è¿›é€¼å¹¿å·ï¼Œå¼ˆå±±æŠ•é™ã€‚ä¸‰å…ƒé‡Œäººæ°‘è¿›è¡ŒæŠ—è‹±æ–—äº‰ã€‚ 9æœˆï¼Œå®šæµ·å†æ¬¡é™·è½ï¼Œä¸‰æ€»å…µæŠ—æ•Œç‰ºç‰²ã€‚4.1842å¹´ï¼š 2æœˆï¼Œå¹¿ä¸œæ°´å¸ˆæç£å…³å¤©åŸ¹åœ¨è™é—¨ä¸è‹±å†›æˆ˜æ­»ã€‚ 6æœˆï¼Œé™ˆåŒ–æˆåšå®ˆå´æ·å£ä»¥èº«æŠ¥å›½ã€‚ 7æœˆï¼Œæµ·é¾„ï¼Œé•‡æ±Ÿä»¥èº«æŠ¥å›½ã€‚ 8æœˆï¼Œè‹±èˆ°åˆ°è¾¾å—äº¬æ±Ÿé¢ï¼Œæ¸…æ”¿åºœè¢«è¿«ç­¾è®¢äº†ã€Šä¸­è‹±å—äº¬æ¡çº¦ã€‹ã€‚é­æºç¼–è‘—ã€Šæµ·å›½å›¾å¿—ã€‹ï¼Œæå‡ºâ€œå¸ˆå¤·é•¿æŠ€ä»¥åˆ¶å¤·â€ 5.1843å¹´ï¼š è‹±å›½å¼ºè¿«æ¸…æ”»åºœç­¾è®¢ã€Šä¸­è‹±äº”å£é€šå•†ç« ç¨‹ã€‹å’Œã€Šä¸­è‹±è™é—¨æ¡çº¦ã€‹ï¼Œä½œä¸ºã€Šå—äº¬æ¡çº¦ã€‹çš„é™„ä»¶ã€‚æ´ªç§€å…¨åˆ›ç«‹æ‹œä¸Šå¸æ•™ã€‚6.1844å¹´ï¼š ã€Šä¸­ç¾æœ›å¦æ¡çº¦ã€‹å’Œã€Šä¸­æ³•é»„åŸ”æ¡çº¦ã€‹ç­¾è®¢ã€‚7.1851å¹´ï¼š 1æœˆ11æ—¥ï¼Œæ´ªç§€å…¨åœ¨å¹¿è¥¿é‡‘ç”°æ‘èµ·ä¹‰ï¼Œå»ºå·å¤ªå¹³å¤©å›½ã€‚ 9æœˆï¼Œåœ¨æ°¸å®‰å·åŸå»ºåˆ¶å°ç‹ã€‚8.1853å¹´ï¼š 3æœˆï¼Œå¤ªå¹³å†›å é¢†å—äº¬ï¼Œæ”¹åå¤©äº¬ï¼Œå®šä¸ºéƒ½åŸã€‚é¢å¸ƒã€Šå¤©æœç”°äº©åˆ¶åº¦ã€‹ã€‚ 4æœˆï¼Œå‘åŠ¨åŒ—ä¼ä¸è¥¿å¾ã€‚ äºŒã€ç¬¬äºŒæ¬¡é¸¦ç‰‡æˆ˜äº‰æ—¶æœŸ 1.1856å¹´ï¼š è‹±å›½åˆ©ç”¨â€œäºšç½—å·äº‹ä»¶â€ã€æ³•å›½åˆ©ç”¨â€œé©¬ç¥ç”«äº‹ä»¶â€å‘åŠ¨ç¬¬äºŒæ¬¡é¸¦ç‰‡æˆ˜äº‰ï¼›ç§‹ï¼Œâ€œå¤©äº¬äº‹å˜â€å‘ç”Ÿï¼Œä¸¥é‡åœ°å‰Šå¼±äº†å¤ªå¹³å¤©å›½çš„é¢†å¯¼å’Œå†›äº‹åŠ›é‡ï¼Œæˆä¸ºå¤ªå¹³å¤©å›½ç”±ç››è½¬è¡°çš„åˆ†æ°´å²­ï¼›2.1858å¹´ï¼š æ²™ä¿„å¼ºè¿«é»‘é¾™æ±Ÿå°†å†›å¥•å±±ç­¾è®¢ã€Šçˆ±ç²æ¡çº¦ã€‹ã€‚è‹±æ³•è”å†›å é¢†å¤©æ´¥ã€‚ä¿„ã€è‹±ã€æ³•ã€ç¾å¼ºè¿«æ¸…æ”¿åºœåˆ†åˆ«ç­¾è®¢ã€Šå¤©æ´¥æ¡çº¦ã€‹ã€‚3.1859å¹´ï¼š 6æœˆï¼Œè‹±æ³•å…¬ä½¿åˆ°åŒ—äº¬äº¤æ¢æ¡çº¦æ–‡æœ¬ï¼Œè“„æ„æŒ‘è¡…ï¼Œç‚®è½°å¤§æ²½å£ï¼Œå²è£æ¤¿ã€ä¹å–„æèº¯ã€‚æ´ªä»åœ©æå‡ºäº†ä¸€ä¸ªç»Ÿç­¹å…¨å±€çš„æ”¹é©æ–¹æ¡ˆã€Šèµ„æ”¿æ–°ç¯‡ã€‹4.1860å¹´ï¼š è‹±æ³•è”å†›æ”»å å¤©æ´¥ã€åŒ—äº¬ã€‚ä¸è‹±ã€æ³•ã€ŠåŒ—äº¬æ¡çº¦ã€‹ç­¾è®¢ã€‚ ä¸‰ã€æ´‹åŠ¡è¿åŠ¨æ—¶æœŸ å…´èµ·æ—©æœŸç»´æ–°æ€æƒ³:ç‹éŸ¬ã€éƒ‘è§‚åº”ã€‚æœ€æ—©åšå‡ºå®Œæ•´è¡¨è¿°çš„æ˜¯å†¯æ¡‚èŠ¬ã€‚ 1.1861å¹´ï¼š 11æœˆï¼Œé‚£æ‹‰æ°å‘åŠ¨æ”¿å˜ï¼ˆå²ç§°â€œè¾›é…‰æ”¿å˜â€æˆ–â€œåŒ—äº¬æ”¿å˜â€ï¼‰ã€‚ ä¸­å¤–ååŠ¨åŠ¿åŠ›å‹¾ç»“èµ·æ¥ï¼Œå…±åŒé•‡å‹å¤ªå¹³å¤©å›½è¿åŠ¨ï¼› æ›¾å›½è—©åˆ›è®¾å®‰åº†å†›æ¢°æ‰€ã€‚å®ƒæ˜¯æ´‹åŠ¡æ´¾åŠçš„ç¬¬ä¸€ä¸ªå†›äº‹å·¥ä¸šã€‚ æ¸…æ”¿åºœè®¾ç«‹â€œæ€»ç†è¡™é—¨â€ï¼Œç”±å¥•î¡„æ‹…ä»»æ€»ç†å¤§è‡£2.1862å¹´ï¼š å¤ªå¹³å¤©å›½å†›æ°‘è¿›è¡Œå¤©äº¬ä¿å«æˆ˜ã€‚ æ€»ç†è¡™é—¨è®¾ç«‹äº¬å¸ˆåŒæ–‡é¦†ã€æ¸…æœ«æœ€æ—©è®¾ç«‹çš„â€³æ´‹åŠ¡å­¦å ‚â€³3.1864å¹´ï¼š 7æœˆï¼Œå¤©äº¬è¢«æ¹˜å†›æ”»ç ´ã€å¤©äº¬é™·è½ï¼Œå¤ªå¹³å¤©å›½å¤±è´¥ã€‚4.1872å¹´ï¼š æé¸¿ç« åœ¨ä¸Šæµ·è®¾ç«‹è½®èˆ¹æ‹›å•†å±€ã€‚å®ƒæ˜¯æ´‹åŠ¡æ´¾åŠçš„ç¬¬ä¸€ä¸ªä¸æ°‘ç”¨æœ‰å…³çš„å·¥ä¸šï¼› é™ˆå¯æºåœ¨å¹¿ä¸œå—æµ·å•†åŠçš„ç»§æ˜Œéš†ç¼«ä¸å‚åˆ›ç«‹ï¼ˆè¿‘ä»£ä¸­å›½ç¬¬ä¸€å®¶ç¼«ä¸å‚ï¼‰ã€‚ 5.1883å¹´ï¼š 12æœˆï¼Œä¸­æ³•æˆ˜äº‰çˆ†å‘ã€‚6.1884å¹´ï¼š 8æœˆä¸‹æ—¬ï¼Œæ³•èˆ°çªç„¶è¢­å‡»é©¬å°¾å†›æ¸¯çš„ç¦å»ºæ°´å¸ˆã€‚æ¸…æ”¿åºœä¸‹è¯å¯¹æ³•å›½æ­£å¼å®£æˆ˜ã€‚ 10æœˆï¼Œåˆ˜é“­ä¼ çš„æ¸…å†›å‡»é€€è¿›çŠ¯å°åŒ—çš„æ³•å†›ã€‚ 7.1885å¹´ï¼š 3æœˆï¼Œæ³•èˆ°è¿›çŠ¯æµ™æ±Ÿé•‡æµ·ã€‚ åˆ˜æ°¸ç¦é»‘æ——å†›å’Œè¶Šå—äººæ°‘é…åˆï¼Œåœ¨ä¸´æ´®å¤§è´¥æ³•å†›ï¼Œæ”¶å¤åå¤šä¸ªå·å¿ã€‚ å†¯å­æåœ¨é•‡å—å…³å¤§è´¥æ³•å†›ï¼Œä¹˜èƒœè¿½å‡»ï¼Œæ”¶å¤è°…å±±ç­‰è¦åœ°ã€‚ 6æœˆï¼Œã€Šä¸­æ³•æ–°çº¦ã€‹ç­¾è®¢ã€‚ 19ä¸–çºª70å¹´ä»£ æ¸…æ”¿åºœå»ºæˆåŒ—æ´‹æ°´å¸ˆ19ä¸–çºª70è‡³80å¹´ä»£ â€œè¾¹ç–†å±æœºâ€è‹±å›½ä»å°åº¦ä¾µäººè¥¿è—ï¼Œåˆä»ç¼…ç”¸å…¥ä¾µäº‘å—ï¼› æ³•å›½åˆ™ä»è¶Šå—ä¾µçŠ¯å¹¿è¥¿ï¼› ä¿„å›½ä»ä¸­äºšäººä¾µæ–°ç–†ï¼›æ—¥æœ¬åå¹¶ç‰çƒã€ä¾µçŠ¯ä¸­å›½å°æ¹¾ã€‚19ä¸–çºª90å¹´ä»£èµ„äº§é˜¶çº§ç»´æ–°æ´¾åˆ›åŠçš„å­¦ä¼šä¸»è¦æœ‰å¼ºå­¦ä¼š æ´‹åŠ¡æ´¾å…´åŠå†›ç”¨å·¥ä¸šï¼š 1865å¹´ï¼Œæé¸¿ç« ç­¹åŠä¸Šæµ·æ±Ÿå—åˆ¶é€ æ€»å±€,å½“æ—¶å›½å†…æœ€å¤§çš„å…µå·¥å‚ï¼›åŒå¹´,æé¸¿ç« åœ¨å—äº¬è®¾ç«‹é‡‘é™µæœºå™¨å±€ï¼› 1866å¹´ï¼Œå·¦å®—æ£ åœ¨ç¦å»ºåˆ›åŠç¦å·èˆ¹æ”¿å±€ï¼Œé™„è®¾æœ‰èˆ¹æ”¿å­¦å ‚ï¼Œæ˜¯å½“æ—¶å›½å†…æœ€å¤§çš„é€ èˆ¹å‚ï¼› 1867å¹´ï¼Œå´‡åšåœ¨å¤©æ´¥å»ºç«‹å¤©æ´¥æœºå™¨å±€ï¼› 1890å¹´ï¼Œå¼ ä¹‹æ´åœ¨æ±‰é˜³åˆ›åŠæ¹–åŒ—æªç‚®å‚ã€‚ æ°‘ç”¨ä¼ä¸šï¼ˆå®˜ç£å•†åŠï¼‰ï¼š1873å¹´æé¸¿ç« åˆ›åŠè½®èˆ¹æ‹›å•†å±€ã€å¼€å¹³çŸ¿åŠ¡å±€ã€å¤©æ´¥ç”µæŠ¥å±€å’Œä¸Šæµ·æœºå™¨ç»‡å¸ƒå±€ 1869å¹´ï¼Œæ–¹ä¸¾èµåœ¨ä¸Šæµ·å¼€è®¾å‘æ˜Œæœºå™¨å‚ï¼Œä¸­å›½æ°‘æ—èµ„æœ¬ä¸»ä¹‰äº§ç”Ÿ 1881å¹´ï¼Œä¸­å›½äººç¬¬ä¸€æ¡é“è·¯å”èƒ¥é“è·¯å»ºæˆé€šè½¦ å››ã€ç»´æ–°å˜æ³•æ—¶æœŸ 1.1888å¹´ï¼š åº·æœ‰ä¸ºç¬¬ä¸€æ¬¡å‘å…‰ç»ªå¸ä¸Šä¹¦ï¼Œè¦æ±‚å˜æ³•ã€‚æˆç«‹åŒ—æ´‹èˆ°é˜Ÿ2.1894å¹´ï¼š æœé²œä¸œå­¦å…šèµ·ä¹‰ï¼Œæ—¥æœ¬ä¹˜æœºå‡ºå…µæœé²œï¼Œå é¢†æ±‰åŸã€‚ 7æœˆï¼Œæ—¥å†›çªç„¶è¢­å‡»åœ¨ç‰™å±±é™„è¿‘çš„ä¸­å›½è¿è¾“èˆ¹å’Œé©»å†›ï¼ŒæŒ‘èµ·ä¾µç•¥ä¸­å›½çš„ç”²åˆæˆ˜äº‰ã€‚ å·¦å®è´µåœ¨å¹³å£¤æˆ˜å½¹ç‰ºç‰²ã€‚ åœ¨é»„æµ·æˆ˜å½¹ä¸­ï¼Œé‚“ä¸–æ˜Œã€æ—æ°¸å‡ç­‰ç‰ºç‰²ã€‚ æ—¥å†›ä¾µå…¥è¾½ä¸œåŠå²›ï¼Œä¸œåŒ—äººæ°‘è‹±å‹‡æŠ—æ•Œï¼Œä¿å«å›½åœŸã€‚ å­™ä¸­å±±åœ¨ç¾å›½æª€é¦™å±±æˆç«‹å…´ä¸­ä¼šã€‚å–Šå‡ºäº†â€æŒ¯å…´ä¸­åâ€è¿™ä¸ªæ—¶ä»£çš„æœ€å¼ºéŸ³ã€‚3.1895å¹´ï¼š åœ¨å¨æµ·å«æˆ˜å½¹ä¸­ï¼ŒåŒ—æ´‹æµ·å†›è¦†ç­ã€‚æ¸…æ”¿åºœå‘æ—¥æœ¬æ±‚å’Œï¼Œè¢«è¿«ç­¾è®¢ä¸­æ—¥ã€Šé©¬å…³æ¡çº¦ã€‹ã€‚ å¾éª§é¢†å¯¼çš„å°æ¹¾ä¹‰å†›å’Œåˆ˜æ°¸ç¦é…åˆï¼ŒæŠ—å‡»æ—¥å†›ï¼› åº·æœ‰ä¸ºç­‰â€œå…¬è½¦ä¸Šä¹¦â€ï¼Œåå¯¹åŒæ—¥æœ¬è®®å’Œï¼Œè¯·æ±‚å˜æ³•ã€‚ä½¿ç»´æ–°æ€æƒ³å‘å±•æˆä¸ºçˆ±å›½æ•‘äº¡è¿åŠ¨ã€‚ åº·æœ‰ä¸ºåœ¨åŒ—äº¬åˆ›åŠã€Šä¸­å¤–è®°é—»ã€‹ã€ä¸¥å¤ã€Šæ•‘äº¡å†³è®ºã€‹ï¼Œå–Šå‡ºäº†â€æ•‘äº¡â€çš„å£å·ï¼›4.1896å¹´ï¼š åº·æœ‰ä¸ºå†™äº†ã€Šæ–°å­¦ä¼ªç»è€ƒã€‹ã€ã€Šå­”å­æ”¹åˆ¶è€ƒã€‹ã€ã€Šäººç±»å…¬ç†ã€‹ï¼› æ¢å¯è¶…å†™äº†ã€Šå˜æ³•é€šè®®ã€‹ï¼› è°­å—£åŒå†™äº†ã€Šä»å­¦ã€‹ï¼› ä¸¥å¤ç¿»è¯‘äº†ã€Šå¤©æ¼”è®ºã€‹ï¼ˆâ€ç‰©ç«å¤©æ‹©â€ã€â€é€‚è€…ç”Ÿå­˜â€ï¼‰ç­‰ã€‚5.1897å¹´ï¼š å¾·å›½å¼ºå èƒ¶å·æ¹¾ï¼Œæ°‘æ—å±æœºä¸¥é‡ï¼›æ¢å¯è¶…ä»»ä¸»ç¬”çš„ä¸Šæµ·ã€Šæ—¶åŠ¡æŠ¥ã€‹ã€ä¸¥å¤ä¸»åŠçš„å¤©æ´¥ã€Šå›½é—»æŠ¥ã€‹ä»¥åŠæ¹–å—çš„ã€Šæ¹˜æŠ¥ã€‹ç­‰ã€‚ä¸¥å¤è¯‘è¿°çš„ã€Šå¤©æ¼”è®ºã€‹åœ¨ ã€Šå›½é—»æŠ¥ã€‹ä¸Šå®šæœŸå‘è¡¨ã€‚ 6.1898å¹´ï¼š 6æœˆï¼Œå…‰ç»ªå¸é¢å¸ƒã€Šå®šå›½æ˜¯è¯ã€‹ä»»åº·æœ‰ä¸ºä¸ºæ€»ç†è¡™é—¨ç« äº¬ã€‚æ¥ç€åˆæ´¾è°­å—£åŒã€æ¨é”ã€åˆ˜å…‰ç¬¬ã€æ—æ—­ç­‰äººå‚é¢„å˜æ³•ã€‚ 9æœˆï¼Œé‚£æ‹‰æ°ï¼ˆæ…ˆç¦§å¤ªåï¼‰å‘åŠ¨æ”¿å˜ï¼Œå›šç¦å…‰ç»ªå¸ï¼Œæ€å®³è°­å—£åŒã€æ¨é”ã€åˆ˜å…‰ç¬¬ã€æ—æ—­ç­‰å…­äººï¼ˆå³æˆŠæˆŒå…­å›å­ï¼‰ã€‚å²ç§°â€œæˆŠæˆŒæ”¿å˜â€ã€‚æˆŠæˆŒå˜æ³•å¤±è´¥ã€‚ äº”ã€å…«å›½è”å†›ä¾µåæˆ˜äº‰æ—¶æœŸ 1.1899å¹´ï¼š ç§‹ï¼Œå±±ä¸œå¹³åŸå¿ä¹‰å’Œå›¢åœ¨æœ±çº¢ç¯é¢†å¯¼ä¸‹ä¸¾è¡Œæ­¦è£…èµ·ä¹‰â€œæ‰¶æ¸…ç­æ´‹â€ï¼›ç¾å›½æå‡ºä¾µç•¥ä¸­å›½çš„â€œé—¨æˆ·å¼€æ”¾â€æ”¿ç­–ï¼›2.1900å¹´ï¼š å¤ï¼Œåœ¨äº¬æ´¥åœ°åŒºä¹‰å’Œå›¢è¿åŠ¨çš„å½±å“ä¸‹ï¼Œå…¶ä»–å„åœ°ä¹Ÿçˆ†å‘äº†ä¹‰å’Œå›¢è¿åŠ¨ï¼Œå…¨å›½æ€èµ·äº†åå¸åå°å»ºæ–—äº‰çš„æµªæ½®ï¼› 6æœˆï¼Œå…«å›½è”å†›ä¾µç•¥ä¸­å›½ã€‚ä¹‰å’Œå›¢åœ¨å»ŠåŠã€è€é¾™å¤´è½¦ç«™ã€ç´«ç«¹æ—ç§Ÿç•Œç­‰åœ°æŠ—å‡»å…«å›½è”å†›ï¼› å›´æ”»åŒ—äº¬ä¸œäº¤æ°‘å··ä½¿é¦†å’Œè¥¿ä»€åº“æ•™å ‚ï¼Œåœ¨åŒ—ä»‘é…åˆæ¸…å†›é˜»å‡»å…«å›½è”å†›ï¼› 7æœˆ17æ—¥è‡³21ï¼Œæ²™ä¿„å‡ºå…µä¾µç•¥æˆ‘å›½ä¸œåŒ—ï¼Œåˆ¶é€ æ±Ÿä¸œå…­åå››å±¯æƒ¨æ¡ˆ ï¼›ä¸1900å¹´7æœˆ16æ—¥å‘ç”Ÿçš„æµ·å…°æ³¡æƒ¨æ¡ˆï¼Œå¹¶ç§°ä¸ºâ€œåºšå­ä¿„éš¾â€ï¼›3.1901å¹´ï¼š 9æœˆï¼Œã€Šè¾›ä¸‘æ¡çº¦ã€‹ç­¾è®¢ã€‚ å…­ã€è¾›äº¥é©å‘½æ—¶æœŸ 1.1902å¹´ï¼š 2æœˆ8æ—¥ï¼Œæ¢å¯è¶…åˆ›åŠã€Šæ–°æ°‘ä¸›æŠ¥ã€‹ï¼› 5æœˆ21æ—¥ï¼Œå¼ ä¹‹æ´åˆ›ç«‹æ¹–åŒ—å¸ˆèŒƒå­¦é™¢ï¼›2.1903å¹´ï¼š 5æœˆ27æ—¥ï¼Œé‚¹å®¹è‘—ã€Šé©å‘½å†›ã€‹ï¼Œç« ç‚³éºŸä¸ºã€Šé©å‘½å†›ã€‹ä½œåºã€‚ 5æœˆï¼Œç« ç‚³éºŸçš„ã€Šé©³åº·æœ‰ä¸ºè®ºé©å‘½ä¹¦ã€‹åœ¨ã€Šè‹æŠ¥ã€‹ä¸Šå‘è¡¨ã€‚3.1904å¹´ï¼š 2æœˆ8æ—¥ï¼Œæ—¥æœ¬å·è¢­æ—…é¡ºï¼Œæ—¥ä¿„æˆ˜äº‰çˆ†å‘ï¼› 2æœˆ15æ—¥ï¼Œåå…´ä¼šæˆç«‹ï¼› 7æœˆ3æ—¥ï¼Œç§‘å­¦è¡¥ä¹ æ‰€åœ¨æ­¦æ˜Œæˆç«‹ï¼› èµ„äº§é˜¶çº§é©å‘½å›¢ä½“åå…´ä¼šã€å…‰å¤ä¼šã€å²³ç‹ä¼šã€ç§‘å­¦è¡¥ä¹ æ‰€æˆç«‹ã€‚ é™ˆå¤©åè‘—ã€ŠçŒ›å›å¤´ã€‹å’Œã€Šè­¦ä¸–é’Ÿã€‹ã€‚4.1905å¹´ï¼š ä¸­å›½åŒç›Ÿä¼šåœ¨æ—¥æœ¬ä¸œäº¬æˆç«‹ï¼Œæå‡ºæ”¿æ²»çº²é¢†ï¼Œé€‰ä¸¾å­™ä¸­å±±ä¸ºæ€»ç†ï¼Œåˆ›åŠäº†ã€Šæ°‘æŠ¥ã€‹ã€‚5.1906å¹´ï¼š é©å‘½å…šåœ¨èä¹¡ã€é†´é™µã€æµé˜³èµ·ä¹‰ï¼Œå®‰æºçŸ¿å·¥å…­åƒäººå‚åŠ æ–—äº‰ï¼Œæœ€ç»ˆå¤±è´¥ã€‚6.1907å¹´ï¼š å­™ä¸­å±±é¢†å¯¼æ½®å·ã€æƒ å·ã€é’¦å·ã€å»‰å·å’Œé•‡å—å…³èµ·ä¹‰ï¼Œæ—‹è´¥ã€‚å¾é”¡éºŸåœ¨å®‰å¾½èµ·ä¹‰ï¼Œå¤±è´¥è¢«å®³ã€‚ç§‹ç‘¾å‡†å¤‡åœ¨æµ™æ±Ÿå“åº”ï¼Œè¢«æ•æ…·æ…¨å°±ä¹‰ã€‚7.1910å¹´ï¼š å¹¿å·æ–°å†›èµ·ä¹‰ã€é»„èŠ±å²—èµ·ä¹‰ï¼›â€œçš‡æ—å†…é˜â€æˆç«‹8.1911å¹´ï¼š 4æœˆï¼Œå­™ä¸­å±±å’Œé»„å…´å‘åŠ¨å¹¿å·èµ·ä¹‰ï¼› 5æœˆï¼Œä¿è·¯è¿åŠ¨çˆ†å‘ã€‚å››å·æœ€ä¸ºæ¿€çƒˆï¼› 10æœˆ10æ—¥ï¼Œï¼ˆå…±è¿›ä¼šå’Œæ–‡å­¦ç¤¾ï¼‰æ­¦æ˜Œèµ·ä¹‰çˆ†å‘ã€‚é©å‘½é¦–å…ˆåœ¨æ­¦æ±‰ä¸‰é•‡å–å¾—èƒœåˆ©ï¼Œæˆç«‹æ¹–åŒ—å†›æ”¿åºœï¼Œæ”¹å›½å·ä¸ºä¸­åæ°‘å›½ã€‚9.1912å¹´ï¼š å…ƒæ—¦ï¼Œä¸­åæ°‘å›½ä¸´æ—¶å¤§æ€»ç»Ÿå­™ä¸­å±±åœ¨å—äº¬å°±èŒï¼Œå®£å‘Šä¸­åæ°‘å›½æˆç«‹ã€‚æ¥ç€æˆç«‹ä¸´æ—¶å‚è®®é™¢ï¼Œä¸ä¹…ï¼Œé¢å¸ƒå‚è®®é™¢åˆ¶å®šçš„ã€Šä¸­åæ°‘å›½ä¸´æ—¶çº¦æ³•ã€‹ã€ã€Šå‘Š å„å‹é‚¦ä¹¦ã€‹ã€‚ã€Šä¸­å›½é‚»å›½ä¸´æ—¶çº¦æ³•ã€‹ä¸­å›½å†å²ä¸Šç¬¬ä¸€æ­¥å…·æœ‰èµ„äº§é˜¶çº§å…±å’Œå›½å®ªæ³•æ€§è´¨çš„å¤§å…¸ï¼› 2æœˆï¼Œæ¸…å¸é€€ä½ã€‚å­™ä¸­å±±è¾èŒï¼Œè¢ä¸–å‡¯çªƒå–äº†é©å‘½æœå®ï¼Œæ¥ä»»ä¸­åæ°‘å›½ä¸´æ—¶å¤§æ€»ç»Ÿã€‚å®‹æ•™ä»ç­‰å‡†å¤‡ç»„ç»‡è´£ä»»å†…é˜ï¼Œä»¥é™åˆ¶è¢ä¸–å‡¯çš„æƒåŠ›ï¼šå°†åŒç›Ÿä¼šæ”¹ ç»„ä¸ºå›½æ°‘å…šã€‚ 10.1913å¹´ï¼š 3æœˆï¼Œè¢ä¸–å‡¯æ´¾äººåœ¨ä¸Šæµ·ç«è½¦ç«™æ€å®³äº†å®‹æ•™ä»ï¼›éæ³•ç­¾è®¢å–„åå¤§å€Ÿæ¬¾ï¼› 7æœˆï¼Œä¸»è¦åœ¨ä¹æ±Ÿã€å—äº¬ä¸€å¸¦ï¼Œå²ç§°â€œèµ£å®ä¹‹å½¹â€ï¼Œç§°â€œäºŒæ¬¡é©å‘½â€ã€‚ï¼›11.1914å¹´ï¼š å­™ä¸­å±±åœ¨æ—¥æœ¬ç»„ç»‡ä¸­åé©å‘½å…šï¼ŒåšæŒåè¢æ­¦è£…æ–—äº‰ï¼› ç§‹ã€æ—¥æœ¬æ´¾å…µå…¥ä¾µå±±ä¸œï¼Œå–ä»£å¾·å›½åœ¨å±±ä¸œçš„ä¾µç•¥åœ°ä½ï¼› ä¸ƒã€æ–°æ–‡åŒ–è¿åŠ¨æ—¶æœŸ æå€¡æ°‘ä¸»ç§‘å­¦ï¼Œåå¯¹ä¸“åˆ¶è¿·ä¿¡ï¼Œä¸»å¼ æ–‡å­¦é©å‘½1.1915å¹´ï¼š 1æœˆï¼Œæ—¥æœ¬æå‡ºç­äº¡ä¸­å›½çš„ã€ŠäºŒåä¸€æ¡ã€‹ã€‚ 5æœˆ9æ—¥ï¼Œâ€œäº”ä¹å›½è€»â€æ—¥ï¼Œæ¥å—ã€ŠäºŒåä¸€æ¡ã€‹ï¼› 9æœˆ15æ—¥ï¼Œé™ˆç‹¬ç§€åˆ›åŠã€Šé’å¹´æ‚å¿—ã€‹ï¼Œåœ¨åˆ›åˆŠå·ä¸Šå‘è¡¨ã€Šæ•¬å‘Šé’å¹´ã€‹ä¸€æ–‡ï¼Œæå‡ºæ°‘ä¸»å’Œç§‘å­¦çš„å£å·ï¼Œæ€èµ·æ–°æ–‡åŒ–è¿åŠ¨ã€‚ 12æœˆ12æ—¥ï¼Œè¢ä¸–å‡¯å½“ä¸Šäº†ä¸­åå¸å›½çš‡å¸ï¼Œæ”¹å¹´ï¼šå·ä¸ºâ€œæ´ªå®ªâ€ã€‚ 12æœˆ15æ—¥ï¼Œè”¡é”·ã€å”ç»§å°§åœ¨äº‘å—ç»„ç»‡â€æŠ¤å›½å†›â€ï¼Œå½¢æˆæŠ¤å›½è¿åŠ¨ã€‚2.1916å¹´ï¼š è¢ä¸–å‡¯åœ¨ç»æœ›ä¸­æ­»å»ã€‚é»å…ƒæ´ªç»§ä»»æ€»ç»Ÿã€‚ æ€»ç†æ®µç¥ºç‘æ“çºµåŒ—äº¬æ”¿åºœå®æƒã€‚ æœäºšæ³‰åœ¨ã€Šä¸œæ–¹æ‚å¿—ã€‹ä¸ŠæŠ¨å‡»æ–°æ–‡åŒ–è¿åŠ¨ï¼Œæ‹‰å¼€ä¸­è¥¿æ–‡åŒ–è®ºæˆ˜åºå¹•3.1917å¹´ï¼š å¼ å‹‹å¤è¾Ÿå¤±è´¥ã€‚æ®µç¥ºç‘ä¸‹ä»¤å¯¹å¾·å®£æˆ˜ï¼Œå®£å¸ƒä¸å†æ¢å¤ã€Šä¸´æ—¶çº¦æ³•ã€‹å’Œå›½ä¼šã€‚ å­™ä¸­å±±åœ¨å¹¿å·å‘åŠ¨ç¬¬ä¸€æ¬¡æŠ¤æ³•è¿åŠ¨ã€‚ é™ˆç‹¬ç§€ä»»åŒ—å¤§æ–‡ç§‘å­¦é•¿ï¼› ä¿„å›½åæœˆé©å‘½èƒœåˆ©ï¼Œæå¤§ä¿ƒè¿›äº†é©¬å…‹æ€ä¸»ä¹‰åœ¨ä¸­å›½çš„ä¼ æ’­ã€‚4.1918å¹´ï¼š é²è¿…å‘è¡¨ã€Šç‹‚äººæ—¥è®°ã€‹ï¼Œå·å¬äººæ°‘èµ·æ¥æ¨ç¿»åƒäººçš„æ—§ç¤¾ä¼šã€‚ æå¤§é’Šå‘è¡¨ã€Šæ³•ã€ä¿„é©å‘½ä¹‹æ¯”è¾ƒè§‚ã€‹ã€ã€Šåº¶æ°‘çš„èƒœåˆ©ã€‹å’Œã€Šå¸ƒå°”ä»€ç»´ä¸»ä¹‰çš„èƒœåˆ©ã€‹ï¼Œçƒ­æƒ…æ­Œé¢‚åæœˆç¤¾ä¼šä¸»ä¹‰é©å‘½ã€‚ 5æœˆï¼ŒæŠ¤æ³•è¿åŠ¨å¤±è´¥ï¼Œæ ‡å¿—ç€æ•´ä¸ªä¸­å›½æ°‘æ—èµ„äº§é˜¶çº§é¢†å¯¼çš„æ—§æ°‘ä¸»ä¸»ä¹‰é©å‘½çš„ç»ˆç»“ã€‚5.1919å¹´ï¼š ã€Šæ–°é’å¹´ã€‹å‡ºç‰ˆâ€œé©¬å…‹æ€ç ”ç©¶ä¸“å·â€ã€æå¤§é’Šå‘è¡¨ã€Šæˆ‘çš„é©¬å…‹æ€ä¸»ä¹‰è§‚ã€‹ï¼› 5æœˆ4æ—¥ï¼Œâ€œäº”å››â€è¿åŠ¨çˆ†å‘ï¼›å·´é»å’Œä¼šä¸Šä¸­å›½å¤–äº¤çš„å¤±è´¥æ˜¯ç›´æ¥å¯¼ç«ç´¢ã€‚ 6æœˆï¼Œä¸­å¿ƒè½¬ç§»åˆ°ä¸Šæµ·ã€‚â€œäº”å››è¿åŠ¨â€æ˜¯æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½çš„å¼€ç«¯ é‚“ä¸­å¤ã€é«˜å›å®‡åŒ—äº¬å¤§å­¦é©¬å…‹æ€å­¦è¯´ç ”ç©¶ä¼š é™ˆç‹¬ç§€ä¸Šæµ·é©¬å…‹æ€ä¸»ä¹‰ç ”ç©¶ä¼š æ–°æ°‘å­¦ä¼šã€äº’åŠ©ç¤¾ã€è§‰æ‚Ÿç¤¾ï¼› 10æœˆï¼Œå°†ä¸­åé©å‘½å…šæ”¹ç»„ä¸ºä¸­å›½å›½æ°‘å…šï¼›å…«ã€ç¬¬ä¸€æ¬¡å›½å…±åˆä½œæ—¶æœŸ 1.1920å¹´ï¼š 8æœˆï¼Œå­™ä¸­å±±ä¼ ä»¤ç²¤å†›é™ˆç‚¯æ˜å›å¸ˆå¹¿ä¸œï¼Œè®¨ä¼æ¡‚ç³»å†›é˜€é‡‘æ˜¥ç…Šã€é™†è£å»¶ã€‚é™ˆæœ›é“ç¬¬ä¸€ç¿»è¯‘ã€Šå…±äº§å…šå®£è¨€ã€‹ 11æœˆï¼Œå­™ä¸­å±±é¢†å¯¼ç¬¬äºŒæ¬¡æŠ¤æ³•è¿åŠ¨ é™ˆç‹¬ç§€åœ¨ä¸Šæµ·åˆ›åŠä¸­å›½å…±äº§å…šç¬¬ä¸€ä¸ªæ—©æœŸç»„ç»‡ï¼Œé™ˆç‹¬ç§€ï¼Œææ±‰ä¿Šã€æè¾¾ï¼›2.1921å¹´ï¼š 7æœˆ23æ—¥ï¼Œä¸­å…±ä¸€å¤§åœ¨ä¸Šæµ·å¬å¼€ï¼Œæ ‡å¿—ä¸­å›½å…±äº§å…šæˆç«‹ï¼› 8æœˆï¼Œä¸­å›½åŠ³åŠ¨ç»„åˆä¹¦è®°éƒ¨æˆç«‹ï¼Œä¸­å›½å…±äº§å…šé¢†å¯¼å·¥äººè¿åŠ¨çš„ä¸“é—¨æœºå…³ï¼› 9æœˆï¼Œå­™å¹³å¹¿è¥¿ï¼Œç»Ÿä¸€ä¸¤å¹¿ï¼›3.1922å¹´ï¼š 1æœˆï¼3æœˆï¼Œé¦™æ¸¯ä¸­å›½æµ·å‘˜å¤§ç½¢å·¥ 6æœˆï¼Œé™ˆç‚¯æ˜ç‚®è½°ï¼Œå­™ç™»æ°¸ä¸°èˆ°ï¼› 7æœˆï¼Œä¸­å…±äºŒå¤§å¬å¼€ï¼Œåˆ¶å®šåå¸åå°å»ºçš„æ°‘ä¸»é©å‘½çº²é¢†ï¼Œ å…šçš„æœ€é«˜çº²é¢†æ˜¯å®ç°ç¤¾ä¼šä¸»ä¹‰ã€å…±äº§ä¸»ä¹‰ å½“å‰é˜¶æ®µçš„çº²é¢†æ˜¯ï¼šæ‰“å€’å†›é˜€,æ¨ç¿»å›½é™…å¸å›½ä¸»ä¹‰çš„å‹è¿«; ç»Ÿä¸€ä¸­å›½ä¸ºçœŸæ­£æ°‘ä¸»å…±å’Œå›½ã€‚ 8æœˆ9æ—¥ï¼Œå­™ç¦»å¹¿èµ´ä¸Šï¼›äºŒæ¬¡é©å‘½æˆ˜äº‰å¤±è´¥ï¼›æ ‡å¿—èµ„äº§é˜¶çº§é¢†å¯¼çš„æ—§æ°‘ä¸»ä¸»ä¹‰é©å‘½èµ°åˆ°äº†å†å²å°½å¤´ï¼› 9æœˆï¼Œå®‰é˜³è·¯çŸ¿å·¥ç½¢å·¥ï¼›4.1923å¹´ï¼š 2æœˆï¼Œäº¬æ±‰é“è·¯å·¥äººä¸¾è¡Œâ€œäºŒä¸ƒâ€å¤§ç½¢å·¥ï¼›ä»1922å¹´1æœˆé¦™æ¸¯æµ·å‘˜ç½¢å·¥åˆ°1923å¹´2æœˆäº¬æ±‰é“è·¯å·¥äººç½¢å·¥ï¼Œåœ¨ä¸­å›½å…±äº§å…šçš„é¢†å¯¼ã€ç»„ç»‡ã€æ¨åŠ¨ä¸‹ï¼Œä¸­å›½æ€èµ·äº†ç¬¬ä¸€ä¸ªå·¥äººè¿åŠ¨çš„é«™æ½®ã€‚ï¼ˆåŒ…æ‹¬å®‰æºè·¯çŸ¿å·¥äººç½¢å·¥ã€å¼€æ»¦äº”çŸ¿å·¥äººç½¢å·¥ï¼‰ 6æœˆï¼Œä¸­å…±ä¸‰å¤§åœ¨å¹¿å·å¬å¼€ï¼Œå†³å®šåŒå›½æ°‘å…šåˆä½œï¼Œå»ºç«‹é©å‘½ç»Ÿä¸€æˆ˜çº¿ï¼Œæ ‡å¿—ç€ç¬¬ä¸€æ¬¡å›½å…±åˆä½œçš„æ­£å¼å½¢æˆ5.1924å¹´ï¼š 1æœˆï¼Œä¸­å›½å›½æ°‘å…šâ€œä¸€å¤§â€å¬å¼€ï¼Œæå‡ºâ€œæ–°ä¸‰æ°‘ä¸»ä¹‰â€ï¼Œé©å‘½ç»Ÿä¸€æˆ˜çº¿æ­£å¼å½¢æˆï¼›å½¢æˆäº†ä»¥å¹¿å·ä¸ºä¸­å¿ƒçš„åå¯¹å¸å›½ä¸»ä¹‰å’Œå°å»ºå†›é˜€çš„é©å‘½æ–°å±€é¢ï¼› 5æœˆï¼Œé»„åŸ”å†›æ ¡çš„å»ºç«‹ï¼› 7æœˆï¼Œå›½æ°‘å…šè®¾ç«‹å†œæ°‘éƒ¨ï¼Œæ—ä¼¯æ¸ ã€æ¾æ¹ƒï¼›å¹¿å·å¼€åŠå†œæ°‘è¿åŠ¨è®²ä¹‰æ‰€ï¼Œæ¾æ¹ƒã€é˜®å•¸ä»™ã€æ¯›æ³½ä¸œï¼› 10æœˆ23æ—¥ï¼Œå†¯ç‰ç¥¥å‘åŠ¨åŒ—äº¬æ”¿å˜6.1925å¹´ï¼š 3æœˆ12æ—¥ï¼Œå­™ä¸­å±±å…ˆç”Ÿé€ä¸–ï¼› 5æœˆ30æ—¥ï¼Œå‘ç”Ÿâ€œäº”å…â€æƒ¨æ¡ˆï¼Œâ€œäº”å…â€åå¸è¿åŠ¨çˆ†å‘ï¼›7.1925å¹´6æœˆï¼1926å¹´10æœˆï¼š é¦™æ¸¯å·¥äººå¤§ç½¢å·¥ï¼Œå½“æ—¶ä¸–ç•Œä¸Šç½¢å·¥æ—¶é—´æœ€é•¿çš„ä¸€æ¬¡ï¼›8.1926å¹´ï¼š 3æœˆï¼Œæ¯›æ³½ä¸œå‘è¡¨ã€Šä¸­å›½ç¤¾ä¼šå„é˜¶çº§çš„åˆ†æã€‹ï¼›è’‹ä»‹çŸ³ç­–åŠ¨â€œä¸­å±±èˆ°äº‹ä»¶â€ï¼› 5æœˆï¼Œè’‹ä»‹çŸ³æå‡ºâ€œæ•´ç†å…šåŠ¡æ¡ˆâ€ï¼› 7æœˆï¼Œå›½æ°‘é©å‘½å†›å‡ºå¸ˆåŒ—ä¼ï¼Œæ¨ç¿»åŒ—æ´‹å†›é˜€ï¼› 9æœˆ1æ—¥ï¼Œæ¯›æ³½ä¸œå‘è¡¨ã€Šå›½æ°‘é©å‘½ä¸å†œæ°‘è¿åŠ¨ã€‹ä¸€æ–‡ï¼ŒæŒ‡å‡ºï¼šâ€å†œæ°‘é—®é¢˜ä¹ƒå›½æ°‘é©å‘½çš„ä¸­å¿ƒé—®é¢˜â€ï¼Œâ€æ‰€è°“å›½æ°‘é©å‘½è¿åŠ¨ï¼Œå…¶å¤§éƒ¨åˆ†å³æ˜¯å†œæ°‘è¿åŠ¨â€ã€‚9.1926å¹´10æœˆï¼1927å¹´3æœˆï¼š ä¸Šæµ·å·¥äººä¸‰æ¬¡æ­¦è£…èµ·ä¹‰ï¼›10.1927å¹´ï¼š 1æœˆï¼Œæ­¦æ±‰å’Œä¹æ±Ÿäººæ°‘æ”¶å›è‹±ç§Ÿç•Œï¼›å›½æ°‘æ”¿åºœä»å¹¿å·è¿åˆ°æ­¦æ±‰ï¼Œæ­¦æ±‰æˆä¸ºå½“æ—¶å…¨å›½é©å‘½çš„ä¸­å¿ƒï¼› 3æœˆï¼Œæ¯›æ³½ä¸œå‘è¡¨ã€Šæ¹–å—å†œæ°‘è¿åŠ¨è€ƒå¯ŸæŠ¥å‘Šã€‹ï¼› 4æœˆ12æ—¥ï¼Œè’‹ä»‹çŸ³åœ¨ä¸Šæµ·å‘åŠ¨åé©å‘½æ”¿å˜ï¼›â€œå››Â·ä¸€äºŒâ€åé©å‘½æ”¿å˜ï¼› 4æœˆ18æ—¥ï¼Œè’‹ä»‹çŸ³åœ¨å—äº¬æˆç«‹å›½æ°‘æ”¿åºœï¼› 4æœˆ27æ—¥è‡³5æœˆ9æ—¥ï¼Œä¸­å›½å…±äº§å…šç¬¬äº”æ¬¡å…¨å›½ä»£è¡¨å¤§ä¼šåœ¨æ­¦æ±‰å¬å¼€ï¼› 5æœˆï¼Œå¤æ–—å¯…ã€è®¸å…‹ç¥¥å›å˜ 7æœˆ15æ—¥ï¼Œæ±ªç²¾å«åœ¨æ­¦æ±‰å¬å¼€â€œåˆ†å…±â€ä¼šè®®ï¼Œåˆ¶é€ â€œä¸ƒÂ·ä¸€äº”â€åé©å‘½æ”¿å˜ã€‚ ç¬¬äºŒæ¬¡å›½å†…é©å‘½æˆ˜äº‰çˆ†å‘ï¼›æ”¿å˜åï¼Œå®æ±‰åˆæµï¼›å›½å…±åˆä½œç ´è£‚ï¼Œå›½æ°‘é©å‘½å¤±è´¥ 8æœˆ1æ—¥ï¼Œâ€œå…«ä¸€â€å—æ˜Œèµ·ä¹‰ï¼›æ‰“å“äº†æ­¦è£…åæŠ—å›½æ°‘å…šååŠ¨ç»Ÿæ²»çš„ç¬¬ä¸€æªã€‚è¿™æ˜¯ä¸­å›½å…±äº§å…šç‹¬ç«‹é¢†å¯¼é©å‘½æˆ˜äº‰ã€åˆ›å»ºäººæ°‘å†›é˜Ÿå’Œæ­¦è£…å¤ºå–æ”¿æƒçš„å¼€ç«¯ã€‚ 8æœˆ7æ—¥ï¼Œåœ¨æ±‰å£å¬å¼€â€œå…«ä¸ƒä¼šè®®â€ï¼Œå½»åº•æ¸…ç®—äº†å¤§é©å‘½åæœŸçš„é™ˆç‹¬ç§€å³å€¾æœºä¼šä¸»ä¹‰é”™è¯¯ï¼Œç¡®å®šäº†åœŸåœ°é©å‘½å’Œæ­¦è£…åæŠ—å›½æ°‘å…šååŠ¨ç»Ÿæ²»çš„æ€»æ–¹é’ˆï¼Œå¹¶é€‰å‡ºäº†ä»¥ç¿ç§‹ç™½ä¸ºé¦–çš„ä¸­å¤®ä¸´æ—¶æ”¿æ²»å±€ã€‚ æ¯›æ³½ä¸œåœ¨ä¼šä¸Šå¼ºè°ƒâ€œæ”¿æƒæ˜¯ç”±æªæ†å­ä¸­å–å¾—çš„â€ï¼›å…«ä¸ƒä¼šè®®â€å¼€å§‹äº†ä»å¤§é©å‘½å¤±è´¥åˆ°åœŸåœ°é©å‘½æˆ˜äº‰å…´èµ·çš„å†å²æ€§è½¬æŠ˜ã€‚ 9æœˆï¼Œæ¯›æ³½ä¸œé¢†å¯¼æ¹˜èµ£è¾¹ç§‹æ”¶èµ·ä¹‰ï¼›å¤±è´¥åï¼Œä¸‰æ¹¾æ”¹ç¼–ï¼Œæ˜ç¡®äº†å…±äº§å…šå¯¹å†›é˜Ÿçš„ç»å¯¹é¢†å¯¼ï¼Œæ­¦è£…å¤ºå–æ”¿æƒçš„ä¿è¯ï¼› 10æœˆï¼Œæ¯›æ³½ä¸œç‡é¢†å·¥å†œé©å‘½å†›åœ¨äº•å†ˆå±±åˆ›ç«‹é©å‘½æ ¹æ®åœ°ï¼› 12æœˆ11æ—¥ï¼Œå¹¿å·èµ·ä¹‰ï¼› ä¸­å›½é©å‘½ç”±æ­¤å‘å±•åˆ°ä¸€ä¸ªæ–°çš„é˜¶æ®µï¼Œå³åœŸåœ°é©å‘½æˆ˜äº‰æ—¶æœŸï¼ˆåå¹´å†…æˆ˜æ—¶æœŸï¼‰ï¼›11.1928å¹´ï¼š 4æœˆï¼Œäº•å†ˆå±±ä¼šå¸ˆï¼Œæˆç«‹ä¸­å›½å·¥å†œçº¢å†›ç¬¬å››å†›ï¼› 6æœˆï¼Œå—äº¬å›½æ°‘æ”¿åºœå®£å¸ƒæ”¹å®šæ–°çº¦ï¼› 10æœˆï¼Œå›½æ°‘å…šä¸­å¤®å¸¸åŠ¡å§”å‘˜ä¼šé€šè¿‡äº†ã€Šè®­æ”¿çº²é¢†ã€‹ï¼› 10æœˆå’Œ11æœˆï¼Œæ¯›æ³½ä¸œå†™äº†ã€Šä¸­å›½çš„çº¢è‰²æ”¿æƒä¸ºä»€ä¹ˆèƒ½å¤Ÿå­˜åœ¨ï¼Ÿã€‹å’Œã€Šäº•å†ˆå±±çš„æ–—äº‰ã€‹ï¼Œé˜è¿°äº†å…±äº§å…šé¢†å¯¼çš„åœŸåœ°é©å‘½ã€æ­¦è£…æ–—äº‰ä¸é©å‘½æ ¹æ®åœ°å»ºè®¾è€…ä¸‰è€…ä¹‹é—´çš„è¾©è¯ç»Ÿä¸€å…³ç³»ã€‚å¼ºè°ƒâ€œå·¥å†œæ­¦è£…å‰²æ®â€çš„æ€æƒ³ï¼› 12æœˆ29æ—¥ï¼Œå¼ å­¦è‰¯ä¸œåŒ—æ˜“å¸œï¼Œå—äº¬å›½æ°‘æ”¿åºœåœ¨å½¢å¼ä¸Šå®Œæˆäº†å…¨å›½ç»Ÿä¸€12.1930å¹´ï¼š 1æœˆï¼Œæ¯›æ³½ä¸œåœ¨ã€Šæ˜Ÿæ˜Ÿä¹‹ç«ï¼Œå¯ä»¥ç‡åŸã€‹ä¸­æŒ‡å‡ºï¼šçº¢å†›ã€æ¸¸å‡»é˜Ÿå’Œçº¢è‰²åŒºåŸŸçš„å»ºè®¾å’Œå‘å±•ï¼Œæ˜¯åŠæ®–æ°‘åœ°ä¸­å›½åœ¨æ— äº§é˜¶çº§é¢†å¯¼ä¹‹ä¸‹çš„å†œæ°‘æˆ˜äº‰çš„æœ€é«˜å½¢å¼å’ŒåŠæ®–æ°‘åœ°å†œæ°‘æ–—äº‰å‘å±•çš„å¿…ç„¶ç»“æœï¼Œå¹¶ä¸”æ˜¯ä¿ƒè¿›å…¨å›½é©å‘½é«˜æ½®çš„æœ€é‡è¦å› ç´ ã€‚ 5æœˆï¼Œ1ã€æ¯›æ³½ä¸œåœ¨ã€Šåå¯¹æœ¬æœ¬ä¸»ä¹‰ã€‹ï¼Œé˜æ˜äº†åšæŒè¾©è¯å”¯ç‰©ä¸»ä¹‰çš„æ€æƒ³è·¯çº¿ï¼ˆå³åšæŒç†è®ºä¸å®é™…ç›¸ç»“åˆçš„åŸåˆ™ï¼‰çš„æç«¯é‡è¦æ€§ï¼Œæå‡ºäº†â€œæ²¡æœ‰è°ƒæŸ»ï¼Œæ²¡æœ‰å‘è¨€æƒâ€å’Œâ€œä¸­å›½é©å‘½æ–—äº‰çš„èƒœåˆ©è¦é ä¸­å›½åŒå¿—äº†è§£ä¸­å›½æƒ…å†µâ€çš„é‡è¦æ€æƒ³ï¼Œè¡¨ç°äº†æ¯›æ³½ä¸œå¼€è¾Ÿæ–°é“è·¯ã€åˆ›é€ æ–°ç†è®ºçš„é©å‘½é¦–åˆ›ç²¾ç¥ã€‚ 2ã€å†œæ‘åŒ…å›´åŸå¸‚ã€æ­¦è£…å¤ºå–æ”¿æƒç†è®ºçš„æå‡ºï¼Œæ ‡å¿—ç€ä¸­å›½åŒ–çš„é©¬å…‹æ€ä¸»ä¹‰å³æ¯›æ³½ä¸œæ€æƒ³çš„åˆæ­¥å½¢æˆã€‚ ä¹ã€æŠ—æ—¥æˆ˜äº‰æ—¶æœŸ 1.1931å¹´ï¼š 9æœˆ18æ—¥ï¼Œæ—¥æœ¬å¸å›½ä¸»ä¹‰å‘åŠ¨â€œä¹Â·ä¸€å…«â€äº‹å˜ï¼› 11æœˆï¼Œä¸­åè‹ç»´åŸƒç¬¬ä¸€æ¬¡å…¨å›½ä»£è¡¨å¤§ä¼šå¬å¼€ï¼Œä¸­åè‹ç»´åŸƒå…±å’Œå›½ä¸´æ—¶ä¸­å¤®æ”¿åºœæˆç«‹ï¼›2.1932å¹´ï¼š 1æœˆ28æ—¥ï¼Œæ—¥æœ¬å¸å›½ä¸»ä¹‰å‘åŠ¨â€œä¸€Â·äºŒå…«â€äº‹å˜ï¼Œåä¹è·¯å†›å¥‹èµ·æŠ—æˆ˜ï¼› 2æœˆä¸œåŒ—å…¨å¢ƒæ²¦é™·ï¼› 3æœˆï¼Œæ—¥æœ¬æ‰¶æ¤å‰æ¸…é€Šå¸æº¥ä»ªå»ºç«‹ä¼ªæ»¡æ´²å›½3.1934å¹´ï¼š 4æœˆï¼Œå…±äº§å…šæå‡ºï¼Œå®‹åº†é¾„ã€ä½•é¦™å‡ã€ææœç­¾åå‘è¡¨äº†ã€Šä¸­å›½äººæ°‘å¯¹æ—¥ä½œæˆ˜çš„åŸºæœ¬çº²é¢†ã€‹ 10æœˆï¼Œå·¥å†œçº¢å†›ç¬¬äº”æ¬¡åâ€œå›´å‰¿â€å¤±è´¥ï¼Œä¸­å¤®é©å‘½æ ¹æ®åœ°ä¸»åŠ›çº¢å†›å¼€å§‹é•¿å¾ï¼›4.1935å¹´ï¼š 1æœˆï¼Œéµä¹‰ä¼šè®®å¬å¼€ï¼›è§£å†³ç»„ç»‡é—®é¢˜ã€å†›äº‹é—®é¢˜ï¼›ç¡®ç«‹æ¯›ä¸ºä»£è¡¨çš„é©¬å…‹æ€ä¸»ä¹‰ä¸»çº¿çš„é¢†å¯¼åœ°ä½ï¼Œç”Ÿæ­»æ”¸å…³è½¬æŠ˜ç‚¹ï¼›æ¯›æ³½ä¸œã€å‘¨æ©æ¥ã€ç‹ç¨¼ç¥¥è´Ÿè´£å†›äº‹è¡ŒåŠ¨ï¼› 2æœˆï¼Œä¸œåŒ—æŠ—æ—¥è”å†›å»ºç«‹ï¼› 6æœˆï¼Œå››å·æ‡‹åŠŸï¼Œçº¢ä¸€ï¼Œçº¢å››ä¼šå¸ˆï¼› 8æœˆ1æ—¥ï¼Œä¸­å…±ä¸­å¤®å‘è¡¨å…«ä¸€å®£è¨€ï¼ˆã€Šä¸ºæŠ—æ—¥æ•‘å›½å‘Šå…¨å›½åŒèƒä¹¦ã€‹ï¼‰ï¼› 10æœˆï¼Œé™•åŒ—å´èµ·é•‡ï¼Œä¸­å¤®çº¢å†›åŒåäº”å†›å›¢èƒœåˆ©ä¼šå¸ˆï¼› 12æœˆ9æ—¥ï¼Œâ€œä¸€äºŒÂ·ä¹â€è¿åŠ¨çˆ†å‘ï¼ˆåå¯¹ååŒ—è‡ªæ²»ã€æ‰“å€’æ—¥æœ¬å¸å›½ä¸»ä¹‰ã€åœæ­¢å†…æˆ˜ï¼Œä¸€è‡´å¯¹å¤–ï¼‰ï¼› 12æœˆï¼Œä¸­å…±ä¸­å¤®ç“¦çª‘å ¡ä¼šè®®ï¼Œæ¯›æ³½ä¸œå‘è¡¨ã€Šè®ºåå¯¹æ—¥æœ¬å¸å›½ä¸»ä¹‰çš„ç­–ç•¥ã€‹ï¼Œé€šè¿‡äº†ã€Šä¸­å¤®å…³äºç›®å‰æ”¿æ²»å½¢åŠ¿ä¸å…šçš„ä»»åŠ¡å†³è®®ã€‹ï¼Œé˜æ˜å…šçš„æŠ—æ—¥æ°‘æ— ç»Ÿä¸€æˆ˜çº¿çš„æ–°æ”¿ç­–ï¼Œæ‰¹åˆ¤å…šå†…çš„å…³é—¨ä¸»ä¹‰å’Œå¯¹äºé©å‘½çš„æ€¥æ€§ç—…,ç³»ç»Ÿåœ°è§£å†³äº†å…šçš„æ”¿æ²»è·¯çº¿ä¸Šçš„é—®é¢˜ã€‚ï¼› ååŒ—äº‹å˜ï¼›5.1936å¹´ï¼š 5æœˆï¼Œå…¨å›½å„ç•Œæ•‘å›½è”åˆä¼šæˆç«‹ï¼› 7æœˆï¼Œè¥¿åº·ç”˜å­œï¼Œçº¢å››æ–¹é¢å†›ï¼Œçº¢äºŒã€å…­æ–¹é¢å†›ä¼šå¸ˆï¼› 10æœˆï¼Œç”˜è‚ƒä¼šå®ã€é™å®å°†å°å ¡ï¼Œçº¢ä¸€ã€çº¢äºŒã€çº¢å››åœ¨èƒœåˆ©ä¼šå¸ˆï¼Œé•¿å¾èƒœåˆ©ç»“æŸï¼›çº¢å››å¼ å›½ç„˜ å¾å‘å‰ 12æœˆï¼Œå¼ å­¦è‰¯ã€æ¨è™åŸæ‰£æŠ¼è’‹ä»‹çŸ³ï¼Œè¥¿å®‰äº‹å˜ï¼ŒæŠ—æ—¥æ°‘æ—ç»Ÿä¸€æˆ˜çº¿åˆæ­¥å½¢æˆï¼› æ¯›æ³½ä¸œå†™äº†ã€Šä¸­å›½é©å‘½æˆ˜äº‰çš„æˆ˜ç•¥é—®é¢˜ã€‹,æ€»ç»“åœŸåœ°é©å‘½æˆ˜äº‰ä¸­å…šå†…åœ¨å†›äº‹é—®é¢˜ä¸Šçš„å¤§äº‰è®ºï¼Œç³»ç»Ÿåœ°è¯´æ˜äº†æœ‰å…³ä¸­å›½é©å‘½æˆ˜äº‰æˆ˜ç•¥æ–¹é¢çš„è¯¸é—®é¢˜ã€‚6.1937å¹´ï¼š 7æœˆ7æ—¥ï¼Œâ€œèŠ¦æ²Ÿæ¡¥äº‹å˜â€ï¼ŒæŠ—æ—¥æˆ˜äº‰å¼€å§‹ï¼› 7æœˆ15æ—¥ï¼Œä¸­å…±æå‡ºå›½å…±åˆä½œçš„æŠ—æ—¥å®£è¨€ï¼› 7æœˆ28æ—¥ï¼Œèµµç™»ç¦¹æŠ—æ—¥æ®‰å›½ï¼› 8æœˆ13æ—¥ï¼Œæ—¥æœ¬å‘åŠ¨â€œå…«Â·ä¸€ä¸‰â€äº‹å˜ï¼Œè“„æ„å·²ä¹…åœ°ä¸ºæ‰©å¤§ä¾µåæˆ˜äº‰åœ¨ä¸­å›½ä¸Šæµ·åˆ¶é€ çš„äº‹å˜ï¼› 8æœˆ22æ—¥ï¼Œä¸­å…±æ´›å·ä¼šè®®ï¼Œä¼šè®®é€šè¿‡äº†ã€Šå…³äºç›®å‰å½¢åŠ¿å’Œå…šçš„ä»»åŠ¡çš„å†³å®šã€‹é¢å¸ƒã€ŠæŠ—æ—¥æ•‘å›½åå¤§çº²é¢†ã€‹ï¼› 9æœˆï¼Œå›½æ°‘å…šå…¬å¸ƒå›½å…±åˆä½œæŠ—æ—¥å®£è¨€ï¼ŒæŠ—æ—¥æ°‘æ—ç»Ÿä¸€æˆ˜çº¿å»ºç«‹ï¼›å…«è·¯å†›å¹³å‹å…³å¤§æ·ï¼› 10æœˆï¼Œå…«è·¯å†›åˆ›ç«‹ç¬¬ä¸€ä¸ªæŠ—æ—¥æ ¹æ®åœ°â€”â€”æ™‹å¯Ÿå†€æ ¹æ®åœ°ï¼› 12æœˆ13æ—¥ï¼Œå—äº¬æ²¦é™·ã€‚æ—¥å†›åˆ¶é€ å—äº¬å¤§å± æ€7.1938å¹´ï¼š 3æœˆï¼Œæå®—ä»æŒ‡æŒ¥å†›é˜Ÿå¼€å±•å¾å·ä¼šæˆ˜ï¼Œå°å„¿åº„æˆ˜å½¹æ˜¯æŠ—æˆ˜ä»¥æ¥æ­£é¢æˆ˜åœºå–å¾—çš„æˆ˜æœæœ€å¤§çš„ä¸€æ¬¡èƒœåˆ©ï¼› 5æœˆï¼Œæ¯›æ³½ä¸œå‘è¡¨ã€Šè®ºæŒä¹…æˆ˜ã€‹ï¼› 10æœˆï¼Œä¸­å…±å¬å¼€å…­å±Šå…­ä¸­å…¨ä¼šï¼Œæ¯›æ³½ä¸œæ˜ç¡®æå‡ºäº†â€é©¬å…‹æ€ä¸»ä¹‰çš„ä¸­å›½åŒ–â€è¿™ä¸ªå‘½é¢˜ï¼› 10æœˆï¼Œå¹¿å·ã€æ­¦æ±‰å¤±å®ˆï¼ŒæŠ—æˆ˜è¿›å…¥ç›¸æŒé˜¶æ®µï¼› 12æœˆï¼Œæ±ªç²¾å«æŠ•é™æ—¥æœ¬ã€‚8.1939å¹´ï¼š 1æœˆï¼Œäº”å±Šäº”ä¸­å…¨ä¼šï¼Œå›½æ°‘å…šæˆç«‹â€é˜²å…±å§”å‘˜ä¼šâ€ï¼Œç¡®å®šäº†â€é˜²å…±ã€é™å…±ã€æº¶å…±ã€åå…±â€çš„æ–¹é’ˆ9.1940å¹´ï¼š 1æœˆï¼Œæ¯›æ³½ä¸œå‘è¡¨ã€Šæ–°æ°‘ä¸»ä¸»ä¹‰è®ºã€‹ï¼› 3æœˆï¼Œæ±ªç²¾å«ä¼ªå›½æ°‘æ”¿åºœåœ¨å—äº¬æˆç«‹ï¼› 5æœˆï¼Œæ£å®œä¼šæˆ˜å›½æ°‘å…šå¼ è‡ªå¿ æèº¯ï¼› 8ï¼11æœˆï¼Œå½­å¾·æ€€æŒ‡æŒ¥å…«è·¯å†›å‘åŠ¨ç™¾å›¢å¤§æˆ˜ï¼›10.1941å¹´ï¼š 1æœˆï¼Œå›½æ°‘å…šå‘åŠ¨ç¬¬äºŒæ¬¡åå…±é«˜æ½®â€”â€”çš–å—äº‹å˜ï¼› 5æœˆï¼Œæ¯›æ³½ä¸œä½œäº†ã€Šæ”¹é€ æˆ‘ä»¬çš„å­¦ä¹ ã€‹çš„æŠ¥å‘Šï¼› 12æœˆï¼Œæ—¥å†›å‘åŠ¨å¤ªå¹³æ´‹æˆ˜äº‰ï¼Œç¾ã€è‹±å¯¹æ—¥å®£æˆ˜ï¼Œæ•´ä¸ªä¸–ç•Œæ ¼å±€å‘ç”Ÿå˜åŒ–ã€‚11.1941ï¼1942å¹´ï¼š ä¸­å›½å…±äº§å…šé‡‡å–â€œä¸‰ä¸‰åˆ¶â€åŸåˆ™ï¼Œ åŠ å¼ºæŠ—æ—¥æ°‘ä¸»æ”¿æƒå»ºè®¾ï¼Œ å®è¡Œå‡ç§Ÿå‡æ¯æ”¿ç­–ï¼Œ å¼€å±•å¤§ç”Ÿäº§è¿åŠ¨å’Œæ•´é£è¿åŠ¨ï¼Œ è¿›è¡Œåâ€œæ‰«è¡â€æ–—äº‰ï¼Œä¿å«è§£æ”¾åŒºï¼›12.1942å¹´ï¼š 1æœˆï¼Œä¸­ã€ç¾ã€è‹±ã€è‹ç­‰26å›½å…±åŒç­¾ç½²ã€Šè”åˆå›½å®£è¨€ã€‹ ç¼…ç”¸åŒ—éƒ¨å¯¹æ—¥ä½œæˆ˜ä»¥èº«æ®‰èŒçš„æ˜¯ä¸­å›½è¿œå¾å†›æˆ´å®‰æ¾œ åã€å›½å…±å†…æˆ˜æ—¶æœŸ 1945-1949 1.1945å¹´ï¼š 4æœˆï¼Œä¸­å…±â€œä¸ƒå¤§â€å¬å¼€ï¼›åŒç¾å›½ã€è‹±å›½ã€è‹è”å‘èµ·æ—§é‡‘å±±ä¼šè®®(è”åˆå›½åˆ¶å®ªä¼šè®®)è‘£å¿…æ­¦å‰å¾€ï¼› 8æœˆ8æ—¥ï¼Œè‹è”å¯¹æ—¥å®£æˆ˜ï¼› 8æœˆ15æ—¥ï¼Œæ—¥æœ¬å®£å¸ƒæ— æ¡ä»¶æŠ•é™ï¼› 9æœˆ2æ—¥ï¼Œæ—¥æœ¬æ­£å¼ç­¾è®¢æŠ•é™ä¹¦ï¼› 9æœˆ3æ—¥ï¼ŒæŠ—æˆ˜èƒœåˆ©çºªå¿µæ—¥ï¼› 8æœˆ25æ—¥ï¼Œä¸­å…±ä¸­å¤®åœ¨ã€Šå¯¹ç›®å‰æ—¶å±€çš„å®£è¨€ã€‹ä¸­æå‡ºçš„å£å·æ˜¯â€œå’Œå¹³ã€æ°‘ä¸»ã€å›¢ç»“â€ï¼› 8æœˆ28æ—¥ï¼10æœˆ10æ—¥ï¼Œå›½å…±é‡åº†è°ˆåˆ¤ï¼Œç­¾è®¢ã€ŠåŒååå®šã€‹ï¼› 9æœˆï¼Œâ€œå‘åŒ—å‘å±•ï¼Œå‘å—é˜²å¾¡â€ï¼› 10æœˆä¸­ä¸‹æ—¬ï¼Œä¸Šå…šã€é‚¯éƒ¸æˆ˜å½¹ï¼Œç²‰ç¢å›½æ°‘å…šçš„å±€éƒ¨è¿›æ”»ï¼› 12æœˆ1æ—¥ï¼Œæ˜†æ˜å­¦ç”Ÿå‘åŠ¨â€œä¸€äºŒÂ·ä¸€â€çˆ±å›½è¿åŠ¨ï¼› 2.1946å¹´ï¼š 1æœˆ10æ—¥ï¼Œå›½å…±ä¸¤å…šç­¾è®¢åœæˆ˜åå®šï¼›æ”¿åä¼šè®®å¼€å¹•ï¼› 2æœˆ10æ—¥ï¼Œå›½æ°‘å…šç‰¹åŠ¡åœ¨é‡åº†åˆ¶é€ çš„ç ´åâ€œåº†ç¥æ”¿åæˆåŠŸå¤§ä¼šâ€çš„äº‹ä»¶ï¼Œæ ¡åœºå£æƒ¨æ¡ˆ 6æœˆï¼Œå›½æ°‘å…šå‘åŠ¨å…¨é¢å†…æˆ˜ï¼Œç¬¬ä¸‰æ¬¡å›½å†…é©å‘½æˆ˜äº‰å¼€å§‹ï¼›èµ·ç‚¹æ˜¯å¤§å±€å›´æ”»ä¸­åŸè§£æ”¾åŒºï¼› 6æœˆ23æ—¥ï¼Œä¸Šæµ·äººæ°‘å›¢ä½“è”åˆä¼šã€å­¦ç”Ÿå’Œå¹³å­˜è¿›ä¸ºåå¯¹å†…æˆ˜ï¼Œè”åˆå‘èµ·ç»„æˆä¸Šæµ·äººæ°‘å’Œå¹³è¯·æ„¿å›¢ï¼Œä¸‹å…³æƒ¨æ¡ˆï¼› 12æœˆ30æ—¥ï¼ŒåŒ—å¹³å­¦ç”Ÿå‘åŠ¨æŠ—è®®ç¾å†›æš´è¡Œçš„è¿åŠ¨ï¼› 3.1947å¹´ï¼š 2æœˆ28æ—¥ï¼Œå°æ¹¾äººæ°‘ä¸¾è¡Œâ€œäºŒÂ·äºŒå…«â€èµ·ä¹‰ï¼› 3æœˆï¼7æœˆï¼Œå»¶å®‰ä¿å«æˆ˜ï¼Œå­Ÿè‰¯å´®æˆ˜å½¹ï¼Œç²‰ç¢å›½æ°‘å…šçš„é‡ç‚¹è¿›æ”»ï¼› 5æœˆ20æ—¥ï¼Œå…¨å›½å­¦ç”Ÿå‘åŠ¨â€œåé¥¥é¥¿ã€åå†…æˆ˜ã€åè¿«å®³â€çš„çˆ±å›½è¿åŠ¨ï¼› 6æœˆ30æ—¥ï¼Œåˆ˜é‚“å¤§å†›æŒºè¿›å¤§åˆ«å±±ï¼› 7æœˆï¼Œäººæ°‘è§£æ”¾å†›å¼€å§‹å…¨å›½è§„æ¨¡çš„åæ”»ï¼› 9æœˆï¼Œä¸­å…±å…¨å›½åœŸåœ°ä¼šè®®å¬å¼€ï¼Œå…¬å¸ƒã€Šä¸­å›½åœŸåœ°æ³•å¤§çº²ã€‹ï¼› 10æœˆ10æ—¥ï¼Œã€Šä¸­å›½äººæ°‘è§£æ”¾å†›å®£è¨€ã€‹å‘è¡¨ï¼›æ‰“åˆ°è’‹ä»‹çŸ³ï¼Œè§£æ”¾å…¨ä¸­å›½ï¼›4.1948å¹´ï¼š 9æœˆï¼11æœˆï¼Œè¾½æ²ˆæˆ˜å½¹ï¼› 11æœˆï¼1949å¹´1æœˆï¼Œæ·®æµ·æˆ˜å½¹ï¼› 12æœˆï¼1949å¹´1æœˆï¼Œå¹³æ´¥æˆ˜å½¹ï¼›5.1949å¹´ï¼š 1æœˆï¼Œå°†é©å‘½è¿›è¡Œåˆ°åº•ï¼› 3æœˆï¼Œè¥¿æŸå¡ä¸­å…±ä¸ƒå±ŠäºŒä¸­å…¨ä¼šï¼›è§„å®šæ”¿æ²»ã€ç»æµã€å¤–äº¤åŸºæœ¬æ”¿ç­–ï¼›å†œä¸šå›½è½¬å˜å·¥ä¸šå›½ã€æ–°æ°‘ä¸»ä¸»ä¹‰ç¤¾ä¼šè½¬å˜ç¤¾ä¼šä¸»ä¹‰ç¤¾ä¼šæ–¹å‘ï¼›æå‡ºâ€œä¸¤ä¸ªåŠ¡å¿…â€è¦æ±‚ï¼› 4æœˆ21æ—¥ï¼Œæ¯›æ³½ä¸œã€æœ±å¾·å‘è€Œè¿›å†›ä»¤ï¼Œè§£æ”¾å†›æ¸¡æ±Ÿä½œæˆ˜ï¼› 4æœˆ23æ—¥ï¼Œè§£æ”¾å—äº¬ï¼Œå›½æ°‘å…šååŠ¨ç»Ÿæ²»ç»“æŸï¼› 6æœˆ30æ—¥ï¼Œæ¯›æ³½ä¸œå‘è¡¨ã€Šè®ºäººæ°‘æ°‘ä¸»ä¸“æ”¿ã€‹ï¼› 9æœˆ21æ—¥ï¼Œä¸­å›½äººæ°‘æ”¿æ²»åå•†ä¼šè®®ç¬¬ä¸€å±Šå…¨ä½“ä¼šè®®å¼€å¹•ï¼› 10æœˆ1æ—¥ï¼Œä¸­åäººæ°‘å…±å’Œå›½æˆç«‹ï¼Œæ°‘ä¸»é©å‘½ç»ˆç»“å’Œç¤¾ä¼šä¸»ä¹‰é©å‘½å¼€å§‹ï¼›æ ‡å¿—ç€ä¸­å›½è¿›å…¥äº†æ–°æ°‘ä¸»ä¸»ä¹‰ç¤¾ä¼šï¼› 1948 9æœˆï¼11æœˆ è¾½æ²ˆæˆ˜å½¹ ä¸­å›½è¿‘ä»£å²è§£æ”¾æˆ˜äº‰çš„â€œä¸‰å¤§æˆ˜å½¹â€ä¹‹ä¸€ï¼Œæˆ˜å½¹ç»“æŸåï¼Œä¸­å›½äººæ°‘è§£æ”¾å†›é¦–æ¬¡åœ¨å…µåŠ›æ•°é‡æ–¹é¢è¶…è¶Šå›½æ°‘å…šå†›ã€‚ 11æœˆï¼æ¬¡å¹´1æœˆ æ·®æµ·æˆ˜å½¹ æ·®æµ·æˆ˜å½¹æ˜¯ä¸‰å¤§æˆ˜å½¹ä¸­è§£æ”¾å†›ç‰ºç‰²æœ€é‡ï¼Œæ­¼æ•Œæ•°é‡æœ€å¤šï¼Œæ”¿æ²»å½±å“æœ€å¤§ã€æˆ˜äº‰æ ·å¼æœ€å¤æ‚çš„æˆ˜å½¹ã€‚ 12æœˆï¼æ¬¡å¹´1æœˆ å¹³æ´¥æˆ˜å½¹ è§£æ”¾æˆ˜äº‰ä¸­å…·æœ‰å†³å®šæ„ä¹‰çš„ä¸‰å¤§æˆ˜å½¹ä¸­çš„æœ€åä¸€ä¸ªæˆ˜å½¹ã€‚å¹³æ´¥æˆ˜å½¹èƒœåˆ©ç»“æŸï¼Œäººæ°‘è§£æ”¾å†›è¿›é©»åŒ—å¹³åŸï¼ŒåŒ—å¹³å®£å‘Šå®Œå…¨è§£æ”¾ã€‚ åä¸€ã€ä¸­åäººæ°‘å…±å’Œå›½æˆç«‹å’Œå·©å›ºæ—¶æœŸï¼š1949â€”1953å¹´ï¼š 1.1950å¹´ï¼š 7æœˆï¼Œä¸­å›½å…±äº§å…šå¬å¼€ä¸ƒå±Šä¸‰ä¸­å…¨ä¼šï¼Œæ¯›åšã€Šä¸ºäº‰å–å›½å®¶è´¢æ”¿ç»æµçŠ¶å†µçš„åŸºæœ¬å¥½è½¬è€Œæ–—äº‰çš„ã€‹æŠ¥å‘Šï¼Œåˆ›å»ºä¸‰ä¸ªæ¡ä»¶ï¼ŒåœŸåœ°æ”¹é©çš„å®Œæˆï¼Œç°æœ‰å·¥å•†ä¸šçš„è°ƒæ•´ï¼Œå›½å®¶æœºæ„æ‰€éœ€ç»è´¹çš„å¤§é‡èŠ‚å‡ï¼›2.1950å¹´10æœˆâ€”1953å¹´7æœˆï¼Œ ä¸­å›½äººæ°‘å¿—æ„¿å†›æŠ—ç¾æ´æœï¼› ä¸­å¤®äººæ°‘æ”¿åºœé¢å¸ƒã€Šä¸­åäººæ°‘å…±å’Œå›½åœŸåœ°æ”¹é©æ³•ã€‹ï¼Œè§„å®šåºŸé™¤åœ°ä¸»é˜¶çº§å°å»ºå‰¥å‰Šçš„åœŸåœ°æ‰€æœ‰åˆ¶ï¼Œå®è¡Œå†œæ°‘çš„åœŸåœ°æ‰€æœ‰åˆ¶ã€‚ æ¯›æ³½ä¸œåœ¨ã€Šåœ¨æ™‹ç»¥å¹²éƒ¨ä¼šè®®ä¸Šçš„è®²è¯ã€‹ç¬¬ä¸€æ¬¡å…¨é¢ã€ç³»ç»Ÿåœ°æå‡ºäº†æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½çš„æ€»è·¯çº¿å’Œæ€»æ”¿ç­–ï¼Œå³â€œæ— äº§é˜¶çº§é¢†å¯¼çš„ï¼Œäººæ°‘å¤§ä¼—çš„ï¼Œåå¯¹å¸å›½ä¸»ä¹‰ã€å°å»ºä¸»ä¹‰å’Œå®˜åƒšèµ„æœ¬ä¸»ä¹‰çš„é©å‘½â€ï¼›3.1950â€”1952å¹´åº•ï¼š åœŸåœ°æ”¹é©ã€‚åœŸåœ°æ”¹é©çš„å®Œæˆï¼Œå½»åº•åºŸé™¤äº†æˆ‘å›½å­˜åœ¨ä¸¤åƒå¤šå¹´çš„å°å»ºåœŸåœ°åˆ¶åº¦ï¼Œåœ°ä¸»é˜¶çº§è¢«æ¶ˆç­ï¼Œå†œæ°‘æˆä¸ºåœŸåœ°çš„ä¸»äººï¼› ä½¿äººæ°‘æ”¿æƒæ›´åŠ å·©å›ºï¼Œå†œæ‘ç”Ÿäº§åŠ›å¤§å¤§è§£æ”¾ï¼Œä¸ºå›½å®¶çš„å·¥ä¸šåŒ–å»ºè®¾å‡†å¤‡äº†æ¡ä»¶ï¼›4.1951å¹´ï¼š 5æœˆï¼ŒåŒè¥¿è—åœ°æ–¹æ”¿åºœè¾¾æˆå…³äºå’Œå¹³è§£æ”¾è¥¿è—åŠæ³•çš„åè®®ï¼› 10æœˆï¼Œè¥¿è—å’Œå¹³è§£æ”¾ï¼› æ ‡å¿—ç€ç¥–å›½å¤§é™†è·å¾—äº†ç»Ÿä¸€ï¼Œå„æ—äººæ°‘å®ç°äº†å¤§å›¢ç»“ï¼›5.1951å¹´åº•-1952å¹´æ˜¥ å¼€å±•åè´ªæ±¡ã€åæµªè´¹ã€åå®˜åƒšä¸»ä¹‰çš„â€œä¸‰åâ€è¿åŠ¨ï¼Œå¤„å†³äº†çŠ¯æœ‰ä¸¥é‡è´ªæ±¡ç½ªçš„å¤©æ´¥åœ°å§”å‰ä»»ä¹¦è®°åˆ˜é’å±±ã€ç°ä»»ä¹¦è®°å¼ å­å–„ï¼›6.1952å¹´ 1æœˆ26æ—¥ï¼Œäº”åè¿åŠ¨æ˜¯æŒ‡å»ºå›½åˆæœŸåœ¨èµ„æœ¬ä¸»ä¹‰å·¥å•†ä¸šè€…ä¸­å¼€çš„åè¡Œè´¿ã€åå·ç¨æ¼ç¨ã€åç›—éª—å›½å®¶è´¢äº§ã€åå·å·¥å‡æ–™ã€åç›—çªƒå›½å®¶ç»æµæƒ…æŠ¥çš„æ–—äº‰ï¼› åäºŒã€å‘ç¤¾ä¼šä¸»ä¹‰è¿‡æ¸¡æ—¶æœŸï¼š1953â€”1956å¹´ï¼š 1.1953â€”1957å¹´ï¼š ç¬¬ä¸€ä¸ªäº”å¹´è®¡åˆ’ã€‚ä¸€äº”è®¡åˆ’çš„å®Œæˆä½¿æˆ‘å›½å¼€å§‹æ”¹å˜äº†å·¥ä¸šè½åçš„é¢è²Œï¼Œå‘ç¤¾ä¼šä¸»ä¹‰å·¥ä¸šåŒ–è¿ˆè¿›ï¼› â€œä¸€åŒ–ä¸‰æ”¹â€ã€‚â€œä¸€åŒ–â€å³ç¤¾ä¼šä¸»ä¹‰å·¥ä¸šåŒ–ï¼Œå°±æ˜¯è¦å‘å±•ç”Ÿäº§åŠ›ã€‚ â€œä¸‰æ”¹â€å³å¯¹å†œä¸šã€æ‰‹å·¥ä¸šã€èµ„æœ¬ä¸»ä¹‰å·¥å•†ä¸šçš„ç¤¾ä¼šä¸»ä¹‰æ”¹é€ ï¼Œå…¶ä¸­å¯¹å†œä¸šã€æ‰‹å·¥ä¸šå®è¡Œåˆä½œåŒ–ï¼Œå¯¹èµ„æœ¬ä¸»ä¹‰å·¥å•†ä¸šå®è¡Œå…¬ç§åˆè¥ å¯¹èµ„æœ¬ä¸»ä¹‰å·¥å•†ä¸šé‡‡å–åˆ©ç”¨ã€é™åˆ¶ã€æ”¹é€ çš„æ”¿ç­–ï¼Œå¯¹èµ„äº§é˜¶çº§é‡‡å–èµä¹°æ”¿ç­–ã€‚ åœ¨ç»è¿‡å§”æ‰˜åŠ å·¥ã€è®¡åˆ’è®¢è´§ã€ç»Ÿè´­åŒ…é”€ã€å§”æ‰˜ç»é”€ä»£é”€ç­‰ä¸€ç³»åˆ—ä»åˆçº§åˆ°é«˜çº§çš„å›½å®¶èµ„æœ¬ä¸»ä¹‰è¿‡æ¸¡å½¢å¼2.1953å¹´åº•ï¼š å‘¨æ©æ¥åœ¨æ¥è§å°åº¦ä»£è¡¨å›¢æ—¶æå‡ºå’Œå¹³å…±å¤„äº”é¡¹åŸåˆ™ï¼Œæˆä¸ºå¤„ç†å›½ä¸å›½ä¹‹é—´å…³ç³»çš„åŸºæœ¬å‡†åˆ™ã€‚3.1954å¹´9æœˆï¼š ç¬¬ä¸€å±Šå…¨å›½äººæ°‘ä»£è¡¨å¤§ä¼šåˆ¶å®šäº†ã€Šä¸­åäººæ°‘å…±å’Œå›½å®ªæ³•ã€‹ï¼Œè¿™æ˜¯æˆ‘å›½ç¬¬ä¸€éƒ¨ç¤¾ä¼šä¸»ä¹‰ç±»å‹çš„å®ªæ³•ã€‚4.1955å¹´ï¼š å‘¨æ©æ¥å‡ºå¸­ä¸‡éš†ä¼šè®®ï¼ˆäºšéå›½é™…ä¼šè®®ï¼‰ï¼Œæå‡ºâ€œæ±‚åŒå­˜å¼‚â€çš„æ–¹é’ˆï¼Œä¿ƒè¿›äº†ä¼šè®®çš„åœ†æ»¡æˆåŠŸï¼Œä¹Ÿä¿ƒè¿›äº†ä¸­å›½åŒäºšéå„å›½çš„å›¢ç»“ä¸åˆä½œã€‚ åä¸‰ã€æ¢ç´¢å»ºè®¾ç¤¾ä¼šä¸»ä¹‰é“è·¯æ—¶æœŸï¼ˆå…¨é¢å»ºè®¾ç¤¾ä¼šä¸»ä¹‰æ—¶æœŸï¼‰ï¼š1956â€”1966å¹´ï¼š 1.1956å¹´ï¼š 4æœˆ25æ—¥ï¼Œæ¯›åœ¨ä¸­å¤®æ”¿æ²»å±€æ‰©å¤§ä¼šè®®ä¸Šä½œäº†ã€Šè®ºåå¤§å…³ç³»ã€‹çš„è®²è¯ï¼Œè°ƒåŠ¨ä¸€åˆ‡ç§¯æå› ç´ ï¼Œä¸ºç¤¾ä¼šä¸»ä¹‰äº‹ä¸šæœåŠ¡ã€‚ä¸ºæ¢ç´¢é€‚åˆä¸­å›½å›½æƒ…çš„ç¤¾ä¼šä¸»ä¹‰å»ºè®¾é“è·¯æå‡ºäº†è®¸å¤šé‡è¦çš„æ€æƒ³åŸåˆ™ï¼Œä»æ€æƒ³ä¸Šã€ç†è®ºä¸Šä¸ºå…«å¤§çš„å¬å¼€ä½œäº†é‡è¦çš„å‡†å¤‡ã€‚ 8æœˆ30æ—¥è‡³9æœˆ12æ—¥ï¼Œåœ¨åŒ—äº¬ä¸¾è¡Œäº†å…«å¤§é¢„å¤‡ä¼šè®®ã€‚æ¯›æ³½ä¸œåœ¨ä¼šä¸Šä½œäº†ã€Šå¢å¼ºå…šçš„å›¢ç»“ï¼Œç»§æ‰¿å…šçš„ä¼ ç»Ÿã€‹çš„è®²è¯ï¼ŒæŒ‡å‡ºå…«å¤§å¬å¼€çš„ç›®çš„å’Œå®—æ—¨æ˜¯ï¼š æ€»ç»“ä¸ƒå¤§ä»¥æ¥çš„ç»éªŒï¼Œå›¢ç»“å…¨å…šï¼Œå›¢ç»“å›½å†…å¤–ä¸€åˆ‡å¯ä»¥å›¢ç»“çš„åŠ›é‡ï¼Œä¸ºå»ºè®¾ç¤¾ä¼šä¸»ä¹‰ä¸­å›½è€Œå¥‹æ–—ã€‚å·å¬å…¨å…šè¦ç»§æ‰¿ä¼˜è‰¯ä¼ ç»Ÿï¼Œåå¯¹ä¸»è§‚ä¸»ä¹‰ã€å®—æ´¾ä¸»ä¹‰å’Œå®˜åƒšä¸»ä¹‰ã€‚ ä¸­å…±æå‡ºâ€œç™¾èŠ±é½æ”¾ï¼Œç™¾å®¶äº‰é¸£â€çš„æ–¹é’ˆï¼Œä½¿æ–‡å­¦è‰ºæœ¯åˆ›ä½œå‡ºç°äº†å´­æ–°çš„å±€é¢ã€‚ 2.1956å¹´ï¼š ä¸­å…±å…«å¤§å¬å¼€ã€‚è¿™æ˜¯æ¢ç´¢å»ºè®¾ç¤¾ä¼šä¸»ä¹‰é“è·¯çš„è‰¯å¥½å¼€ç«¯ã€‚é™ˆäº‘æå‡ºâ€œä¸‰ä¸ªä¸»ä½“ï¼Œä¸‰ä¸ªè¡¥å……â€æ€æƒ³ã€‚å…šå’Œäººæ°‘å½“å‰çš„ä¸»è¦ä»»åŠ¡æ˜¯æŠŠæˆ‘å›½ä»è½åçš„å†œä¸šå›½å˜ä¸ºå…ˆè¿›çš„çš„å·¥ä¸šå›½ï¼› ä¸‰å¤§æ”¹é€ å®Œæˆï¼Œå®ç°äº†æŠŠç”Ÿäº§èµ„æ–™ç§æœ‰åˆ¶è½¬å˜ä¸ºç¤¾ä¼šä¸»ä¹‰å…¬æœ‰åˆ¶çš„ä»»åŠ¡ï¼Œæ ‡å¿—ç€æˆ‘å›½åˆæ­¥å»ºç«‹èµ·ç¤¾ä¼šä¸»ä¹‰çš„åŸºæœ¬åˆ¶åº¦ï¼Œè¿›å…¥ç¤¾ä¼šä¸»ä¹‰åˆçº§é˜¶æ®µï¼› é•¿æ˜¥ç¬¬ä¸€æ±½è½¦åˆ¶é€ å‚å»ºæˆæŠ•äº§ã€æ²ˆé˜³æœºåºŠå‚å»ºæˆæŠ•äº§ã€åŒ—äº¬ç”µå­ç®¡å‚å»ºæˆæŠ•äº§ã€æ²ˆé˜³é£æœºåˆ¶é€ å‚è¯•åˆ¶æˆåŠŸï¼›3.1957å¹´ï¼š 2æœˆï¼Œæ¯›åœ¨æœ€é«˜å›½åŠ¡ä¼šè®®ä¸Šå‘è¡¨ã€Šå…³äºæ­£ç¡®å¤„ç†äººæ°‘å†…éƒ¨çŸ›ç›¾çš„é—®é¢˜ã€‹è®²è¯ï¼ŒåŒºåˆ†å’Œå¤„ç†æ•Œæˆ‘å’Œäººæ°‘å†…éƒ¨ä¸¤ç±»çŸ›ç›¾çš„å­¦è¯´ï¼›å¼ºåˆ¶-ä¸“åˆ¶ï¼›æ°‘ä¸»-è¯´æœæ•™è‚²-å›¢æ‰¹å›¢ï¼› æ­¦æ±‰é•¿æ±Ÿå¤§æ¡¥é€šè½¦ï¼›é’è—ã€åº·è—ã€æ–°è—å…¬è·¯é€šè½¦ï¼›4.1958å¹´ï¼š â€œå¤§è·ƒè¿›â€å’Œäººæ°‘å…¬ç¤¾åŒ–è¿åŠ¨å¼€å§‹ã€‚è¿™æ˜¯å…šåœ¨æ¢ç´¢å»ºè®¾ç¤¾ä¼šä¸»ä¹‰é“è·¯ä¸­çš„ä¸€æ¬¡ä¸¥é‡å¤±è¯¯ã€‚5.20ä¸–çºª60å¹´ä»£åˆï¼š è¥¿è—åœ°åŒºå®Œæˆæ°‘ä¸»æ”¹é©ï¼ŒåºŸé™¤äº†å°å»ºå†œå¥´åˆ¶åº¦ï¼Œç™¾ä¸‡å†œå¥´ç¿»èº«å½“å®¶åšäº†ä¸»äººï¼Œè¿›å…¥ç¤¾ä¼šä¸»ä¹‰é˜¶æ®µã€‚6.1961å¹´æ˜¥ï¼š ä¸­å…±å…«å±Šä¹ä¸­å…¨ä¼šï¼Œå†³å®šå¯¹å›½æ°‘ç»æµå®è¡Œâ€œè°ƒæ•´ã€å·©å›ºã€å……å®ã€æé«˜â€æ–¹é’ˆçš„ä¼šè®® å…šå’Œæ”¿åºœå…¨é¢è°ƒæ•´å›½æ°‘ç»æµ ,æ¢å¤å‘å±•ç”Ÿäº§ã€‚7.1962å¹´æ˜¥ï¼š ä¸­å…±é‡è¦ä¸ºç»Ÿä¸€æ€æƒ³ã€æ€»ç»“ç»éªŒæ•™è®­å’Œæ˜ç¡®å·¥ä½œæ–¹å‘å¬å¼€äº†â€œä¸ƒåƒäººä¼šè®®â€8.1964å¹´ï¼š 10æœˆ16æ—¥ï¼šæˆ‘å›½ç¬¬ä¸€é¢—åŸå­å¼¹çˆ†ç‚¸æˆåŠŸï¼Œæ‰“ç ´äº†å¸å›½ä¸»ä¹‰çš„æ ¸å„æ–­ã€‚ 12æœˆï¼Œå‘¨æ©æ¥ç¬¬ä¸‰å±Šäººå¤§ç¬¬ä¸€æ¬¡ä¼šè®®ï¼Œå››ä¸ªç°ä»£åŒ– åå››ã€â€œæ–‡åŒ–å¤§é©å‘½â€æ—¶æœŸï¼š1966â€”1976å¹´ï¼š 1966å¹´ï¼š ä¸­å›½æˆ˜ç•¥å¯¼å¼¹éƒ¨é˜Ÿç»„å»ºæˆåŠŸï¼Œä¸»è¦æ‹…ä»»æ ¸åå‡»ä»»åŠ¡ã€‚ 1967å¹´ï¼š 6æœˆ17æ—¥ä¸­å›½æˆåŠŸè¯•çˆ†ç¬¬ä¸€æšæ°¢å¼¹ 1970å¹´ï¼š æˆ‘å›½æˆåŠŸå‘å°„ç¬¬ä¸€é¢—äººé€ åœ°çƒå«æ˜Ÿâ€”â€”ä¸œæ–¹çº¢1å·ã€‚ 1971å¹´ï¼š 7æœˆï¼ŒåŸºè¾›æ ¼ç§˜å¯†è®¿åã€‚ 9æœˆ13æ—¥ï¼Œä¹ä¸€ä¸‰äº‹ä»¶ï¼Œæ—å½ªåé©å‘½é›†å›¢è¢«ç²‰ç¢ã€‚ 10æœˆ25æ—¥ï¼Œç¬¬26å±Šè”åˆå›½å¤§ä¼šæ¢å¤äº†æˆ‘å›½åœ¨è”åˆå›½çš„åˆæ³•å¸­ä½ã€‚ 1972å¹´ï¼š 2æœˆï¼Œå°¼å…‹æ¾è®¿åï¼Œä¸­ç¾åŒæ–¹åœ¨ä¸Šæµ·ç­¾ç½²äº†ã€Šä¸­ç¾è”åˆå…¬æŠ¥ã€‹ï¼Œä¸­ç¾å…³ç³»å¼€å§‹èµ°å‘æ­£å¸¸åŒ–ã€‚æ—¥æœ¬é¦–ç›¸ç”°ä¸­è§’è£è®¿åï¼Œä¸­æ—¥å»ºäº¤ã€‚ 1973å¹´ï¼š è¢éš†å¹³åœ¨ä¸–ç•Œä¸Šé¦–æ¬¡è‚²æˆç±¼å‹æ‚äº¤æ°´ç¨»ã€‚ 1976å¹´ï¼š 10æœˆï¼Œç²‰ç¢æ±Ÿé’åé©å‘½é›†å›¢ï¼ˆâ€œå››äººå¸®â€ï¼‰ï¼Œæ ‡å¿—â€œæ–‡åŒ–å¤§é©å‘½â€ç»“æŸã€‚ åäº”ã€ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å»ºè®¾çš„æ–°æ—¶æœŸï¼ˆæ”¹é©å¼€æ”¾æ—¶æœŸï¼‰ï¼š1978å¹´è‡³ä»Š 1978å¹´ï¼š å…³äºçœŸç†æ ‡å‡†é—®é¢˜çš„è®¨è®ºå±•å¼€ã€‚è¿™æ˜¯ä¸€åœºæ·±åˆ»çš„æ€æƒ³è§£æ”¾è¿åŠ¨ï¼Œä¸ºåä¸€å±Šä¸‰ä¸­å…¨ä¼šçš„å¬å¼€å¥ å®šäº†æ€æƒ³åŸºç¡€ã€‚ 12æœˆï¼Œä¸­å…±åä¸€å±Šä¸‰ä¸­å…¨ä¼šå¬å¼€ã€‚è¿™æ˜¯å»ºå›½ä»¥æ¥å…šçš„å†å²ä¸Šå…·æœ‰æ·±è¿œæ„ä¹‰çš„è½¬æŠ˜ï¼Œæ˜¯æ”¹é©å¼€æ”¾çš„å¼€ç«¯ï¼Œä»æ­¤æˆ‘å›½è¿›å…¥ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å»ºè®¾çš„æ–°æ—¶æœŸã€‚ 1979å¹´ï¼š 1æœˆï¼Œã€Šå‘Šå°æ¹¾åŒèƒä¹¦ã€‹ ä¸­ç¾å»ºäº¤ã€‚ 3æœˆï¼Œé‚“å°å¹³åœ¨ä¸­å¤®ç†è®ºå·¥ä½œåŠ¡è™šä¼šä¸Šæ˜ç¡®æå‡ºå¿…é¡»åšæŒå››é¡¹åŸºæœ¬åŸåˆ™ã€‚ åšæŒç¤¾ä¼šä¸»ä¹‰é“è·¯ï¼ŒåšæŒäººæ°‘æ°‘ä¸»ä¸“æ”¿ï¼ŒåšæŒå…±äº§å…šçš„é¢†å¯¼ï¼ŒåšæŒé©¬å…‹æ€åˆ—å®ä¸»ä¹‰ï¼Œæ¯›æ³½ä¸œæ€æƒ³ã€‚ 1980å¹´ï¼š æˆ‘å›½åœ¨å¹¿ä¸œçš„æ·±åœ³,ç æµ·,æ±•å¤´å’Œç¦å»ºçš„å¦é—¨å»ºç«‹ç»æµç‰¹åŒºï¼Œå¼€å§‹å¯¹å¤–å¼€æ”¾ã€‚ 1982å¹´ï¼š ä¸­å…±åäºŒå¤§ï¼Œé‚“å°å¹³æå‡ºå»ºè®¾æœ‰ä¸­å›½ç‰¹è‰²çš„ç¤¾ä¼šä¸»ä¹‰ï¼Œå…¨å›½äººå¤§é¢å¸ƒäº†ç¬¬å››éƒ¨ã€Šä¸­åäººæ°‘å…±å’Œå›½å®ªæ³•ã€‹ã€‚ 1984å¹´ï¼š 12æœˆï¼Œä¸­è‹±ã€Šå…³äºé¦™æ¸¯é—®é¢˜çš„è”åˆç”³æ˜ã€‹ 1985å¹´ï¼š 3æœˆï¼Œã€Šå…³äºç§‘å­¦æŠ€æœ¯ä½“åˆ¶æ”¹é©çš„å†³å®šã€‹ 5æœˆï¼Œã€Šå…³äºæ•™è‚²ä½“åˆ¶æ”¹é©çš„å†³å®šã€‹ 1986å¹´ï¼š é¢å¸ƒã€Šä¸­åäººæ°‘å…±å’Œå›½ä¹‰åŠ¡æ•™è‚²æ³•ã€‹å’Œã€Šä¸­åäººæ°‘å…±å’Œå›½æ°‘æ³•é€šåˆ™ã€‹ã€‚ 1987å¹´ï¼š 4æœˆï¼Œä¸­è‘¡ã€Šå…³äºæ¾³é—¨é—®é¢˜çš„è”åˆç”Ÿå‘½ã€‹ 10æœˆ25æ—¥-11æœˆ1æ—¥ï¼Œä¸­å…±åä¸‰å¤§ï¼Œé‚“å°å¹³é˜æ˜äº†ç¤¾ä¼šä¸»ä¹‰åˆçº§é˜¶æ®µç†è®ºï¼Œæå‡ºäº†å…šåœ¨ç¤¾ä¼šä¸»ä¹‰åˆçº§é˜¶æ®µçš„â€œä¸€ä¸ªä¸­å¿ƒã€ä¸¤ä¸ªåŸºæœ¬ç‚¹â€åŸºæœ¬è·¯çº¿ï¼Œå³ä»¥ç»æµå»ºè®¾ä¸ºä¸­å¿ƒï¼ŒåšæŒå››é¡¹åŸºæœ¬åŸåˆ™ï¼ŒåšæŒæ”¹é©å¼€æ”¾ã€‚å°æ¹¾å½“å±€è°ƒæ•´â€œä¸‰ä¸â€æ”¿ç­–ï¼Œä¸¤å²¸å…³ç³»å‘ç”Ÿäº†å†å²æ€§çš„å˜åŒ–ã€‚åˆ¶å®šäº†ä¸‹ä¸€æ­¥ç»æµä½“åˆ¶æ”¹é©å’Œæ”¿æ²»ä½“åˆ¶æ”¹é©çš„åŸºæœ¬ä»»åŠ¡å’Œå¥‹æ–—ç›®æ ‡ 1988å¹´ï¼š 4æœˆ13æ—¥ï¼Œæµ·å—ç»æµç‰¹åŒºï¼› 1990å¹´ï¼š ä¸­å›½é¦–æ¬¡æˆåŠŸä¸¾åŠäºšæ´²è¿åŠ¨ä¼šã€‚1990å¹´å°æ¹¾æˆç«‹äº†æµ·å³¡äº¤æµåŸºé‡‘ä¼šã€‚ 1991å¹´ï¼š å¤§é™†æˆç«‹äº†æµ·å³¡ä¸¤å²¸å…³ç³»åä¼šã€‚ 1992å¹´ï¼šæ‰©å¤§æ”¹é©ï¼Œå¼€æ”¾ä¸Šæµ·æµ¦ä¸œä½æ–°çš„ç»æµç‰¹åŒºï¼›æµ·åŸºä¼šä¸æµ·åä¼šè¾¾æˆâ€œä¹äºŒå…±è¯†â€ï¼Œå³â€œæµ·å³¡ä¸¤å²¸å‡åšæŒä¸€ä¸ªä¸­å›½åŸåˆ™â€ã€‚ 1992å¹´åˆï¼šé‚“å°å¹³å—å·¡è®²è¯ï¼Œå¼ºè°ƒå‘å±•æ‰æ˜¯ç¡¬é“ç†ã€‚å—å·¡è®²è¯è¿›ä¸€æ­¥è§£æ”¾äº†äººä»¬çš„æ€æƒ³ï¼Œå¯¹å»ºè®¾æœ‰ä¸­å›½ç‰¹è‰²çš„ç¤¾ä¼šä¸»ä¹‰äº§ç”Ÿäº†æ·±è¿œå½±å“ã€‚ 1992å¹´ï¼šä¸­å…±åå››å¤§ï¼Œæå‡ºå»ºç«‹ç¤¾ä¼šä¸»ä¹‰å¸‚åœºç»æµä½“åˆ¶ï¼Œç¡®ç«‹äº†é‚“å°å¹³ç†è®ºåœ¨å…¨å…šçš„æŒ‡å¯¼åœ°ä½ï¼Œå½¢æˆäº†ä»¥æ±Ÿæ³½æ°‘ä¸ºæ ¸å¿ƒçš„ç¬¬ä¸‰ä»£é¢†å¯¼é›†ä½“ã€‚ 1993å¹´ï¼šâ€œæ±ªè¾œä¼šè°ˆâ€ï¼ˆæµ·åä¼šä¼šé•¿æ±ªé“æ¶µå’Œæµ·åŸºä¼šè‘£äº‹é•¿è¾œæŒ¯ç”«åœ¨æ–°åŠ å¡ä¸¾è¡Œçš„ä¼šè°ˆï¼‰ï¼Œå°†â€œåŠ å¼ºä¸¤å²¸ç»æµäº¤æµï¼Œäº’è¡¥äº’åˆ©â€å†™å…¥åè®®ï¼Œæ ‡å¿—ç€æµ·å³¡ä¸¤å²¸å…³ç³»çš„å‘å±•è¿ˆå‡ºäº†å†å²æ€§çš„é‡è¦ä¸€æ­¥ã€‚ 14. 1995å¹´åˆï¼š1æœˆï¼Œæ±Ÿæ³½æ°‘å‘è¡¨ã€Šä¸ºä¿ƒè¿›ç¥–å›½ç»Ÿä¸€å¤§ä¸šçš„å®Œæˆè€Œç»§ç»­å¥‹æ–—ã€‹ï¼Œæå‡ºâ€œå…«é¡¹ä¸»å¼ â€ï¼Œæˆä¸ºæ–°æ—¶æœŸæ¨è¿›ç¥–å›½å’Œå¹³ç»Ÿä¸€è¿›ç¨‹çš„æŒ‡å¯¼æ€æƒ³ã€‚ 1997å¹´ï¼š7æœˆ1æ—¥ï¼šé¦™æ¸¯å›å½’ï¼Œä¸­åäººæ°‘å…±å’Œå›½é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒºæ­£å¼æˆç«‹ã€‚9æœˆ12æ—¥è‡³18æ—¥ï¼Œä¸­å…±åäº”å¤§ï¼ŒæŠŠé‚“å°å¹³ç†è®ºå†™å…¥å…šç« ï¼Œç¡®ç«‹ä¸ºå…šçš„æŒ‡å¯¼æ€æƒ³ã€‚é€šè¿‡äº†å…³äºã€Šä¸­å›½å…±äº§å…šç« ç¨‹ä¿®æ­£æ¡ˆã€‹çš„å†³è®®ï¼› 1999å¹´ï¼š12æœˆ20æ—¥ï¼šæ¾³é—¨å›å½’ï¼Œä¸­åäººæ°‘å…±å’Œå›½æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒºæ­£å¼æˆç«‹ã€‚æˆ‘å›½æˆåŠŸå‘å°„ç¬¬ä¸€è‰˜æ— äººé£èˆ¹â€œç¥èˆŸä¸€å·â€ã€‚ 20ä¸–çºª90å¹´ä»£ï¼šå…šå’Œæ”¿åºœæå‡ºâ€œç§‘æ•™å…´å›½â€æˆ˜ç•¥ï¼ŒæŠŠä¹å¹´ä¹‰åŠ¡æ•™è‚²ä½œä¸ºç§‘æ•™å…´å›½çš„å¥ åŸºå·¥ç¨‹ã€‚ 20ä¸–çºªæœ«ï¼šä¸­å›½æ•´ä½“ä¸Šè¿›å…¥å°åº·ç¤¾ä¼šã€‚ 2000å¹´ï¼šå…¨å›½åŸºæœ¬æ™®åŠä¹å¹´ä¹‰åŠ¡æ•™è‚²ã€‚ 2001å¹´ï¼š12æœˆ11æ—¥ï¼ŒåŠ å…¥ä¸–è´¸ç»„ç»‡ï¼Œæ ‡å¿—ç€å¯¹å¤–å¼€æ”¾è¿›å…¥ä¸€ä¸ªæ–°é˜¶æ®µã€‚ä¸­å›½åœ¨ä¸Šæµ·æˆåŠŸä¸¾åŠäº†äºšå¤ªç»åˆç»„ç»‡ä¼šè®®ï¼ˆAPECä¼šè®®ï¼‰ã€‚è¿™æ˜¯ä¸­å›½è¿„ä»Šä¸¾è¡Œçš„è§„æ¨¡æœ€å¤§ã€è§„æ ¼æœ€é«˜çš„å¤šè¾¹å¤–äº¤æ´»åŠ¨ã€‚ 2002å¹´ï¼š11æœˆ8æ—¥è‡³14æ—¥ï¼Œä¸­å…±åå…­å¤§åŒ—äº¬å¬å¼€ï¼›é«˜ä¸¾é‚“å°å¹³ç†è®ºä¼Ÿå¤§æ——å¸œï¼Œå…¨é¢è´¯å½»â€œä¸‰ä¸ªä»£è¡¨â€é‡è¦æ€æƒ³ï¼Œç»§å¾€å¼€æ¥ï¼Œä¸æ—¶ä¿±è¿›ï¼Œå…¨é¢å»ºè®¾å°åº·ç¤¾ä¼šï¼ŒåŠ å¿«æ¨è¿›ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–ï¼Œä¸ºå¼€åˆ›ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰äº‹ä¸šæ–°å±€é¢è€Œå¥‹æ–—ï¼› 2003å¹´ï¼šæˆ‘å›½æˆåŠŸå‘å°„ç¬¬ä¸€è‰˜è½½äººé£èˆ¹â€œç¥å·äº”å·â€ã€‚ 2004å¹´ï¼š9æœˆï¼Œä¸­å…±åå…­å±Šå››ä¸­å…¨ä¼šæå‡ºçš„æˆ˜ç•¥ä»»åŠ¡æ˜¯æ„å»ºç¤¾ä¼šä¸»ä¹‰å’Œè°ç¤¾ä¼šï¼› 2005å¹´3æœˆ14æ—¥ç¬¬åå±Šäººæ°‘å¤§è¡¨å¤§ä¼šä¸‰æ¬¡ä¼šè®®ï¼Œååˆ†è£‚å›½å®¶æ³• 2007å¹´ï¼š10æœˆ15æ—¥è‡³21æ—¥ï¼Œä¸­å…±åä¸ƒå¤§æ˜ç¡®æŒ‡å‡ºï¼Œé«˜ä¸¾ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ä¼Ÿå¤§æ——å¸œæœ€æ ¹æœ¬çš„æ˜¯è¦åšæŒä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰é“è·¯ã€ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ç†è®ºä½“åˆ¶ï¼› 2008å¹´ï¼šä¸­å›½æˆåŠŸä¸¾åŠäº†å¥¥è¿ä¼šå’Œæ®‹å¥¥ä¼šã€‚ 2010å¹´ï¼š5æœˆï¼Œä¸­å¤®æ–°ç–†å·¥ä½œä¼šè®®ä¸Šä¸­å¤®æ­£å¼æ‰¹å‡†éœå°”æœæ–¯ã€å–€ä»€è®¾ç«‹ç»æµç‰¹åŒºã€‚ 2011å¹´ï¼šç¡®ç«‹å»ºè®¾ç¤¾ä¼šä¸»ä¹‰æ–‡åŒ–å¼ºå›½æˆ˜æ—…ç›®æ ‡çš„ä¼šè®®æ˜¯ 2013å¹´ï¼š11æœˆï¼Œä¸­å…±åå…«å±Šä¸‰ä¸­å…¨ä¼šåšå‡ºã€Šå…³äºå…¨é¢æ·±åŒ–æ”¹é©è‹¥å¹²é‡å¤§é—®é¢˜çš„å†³å®šã€‹ï¼Œæå‡ºäº†å…¨é¢æ·±åŒ–æ”¹é©çš„çŸ¥é“æ€æƒ³ã€é‡è¦æ–¹é’ˆã€ç›®æ ‡ä»»åŠ¡ã€æ”¿æ²»ä¸¾æªï¼Œæ˜ç¡®äº†å…¨é¢æ·±åŒ–æ”¹é©çš„æ€»ç›®æ ‡ã€æ—¶é—´è¡¨ã€è·¯çº¿å›¾ï¼Œæˆä¸ºçŸ¥é“æ–°å½¢åŠ¿ä¸‹å…¨é¢æ·±åŒ–æ”¹é©çš„çº²é¢†æ€§æ–‡ä»¶ï¼›2017å¹´ï¼šç¬¬åäºŒå±Šå…¨å›½äººå¤§å¸¸å§”ä¼šç¬¬äºŒåä¹æ¬¡ä¼šè®®é€šè¿‡çš„æ³•å¾‹ã€Šä¸­åäººæ°‘å…±å’Œå›½å›½æ­Œæ³•ã€‹ ä¸»è¦è¿åŠ¨ï¼š å››ä¸€äºŒäº‹å˜ 1927å¹´4æœˆ12æ—¥ ä¸Šæµ· è’‹ä¸­æ­£å¤§è§„æ¨¡é€®æ•ã€å¤„å†³ä¸­å›½å…±äº§å…šå…šå‘˜ï¼Œå¹¶å–ç¼”è‹è”é¡¾é—®ã€‚ ä¸ƒä¸€äº”äº‹å˜ 1927å¹´7æœˆ15æ—¥ æ­¦æ±‰ æ±ªç²¾å«åˆ†å·¥äº‹ä»¶ ä¹ä¸€å…«äº‹å˜ 1931å¹´9æœˆ18æ—¥ ä¸œåŒ— æ—¥æœ¬å¸å›½ä¸»ä¹‰å‘åŠ¨â€œä¹Â·ä¸€å…«â€äº‹å˜ ä¸€äºŒå…«äº‹å˜ 1932å¹´1æœˆ28æ—¥ ä¸Šæµ· æ—¥æœ¬å¸å›½ä¸»ä¹‰å‘åŠ¨â€œä¸€Â·äºŒå…«â€äº‹å˜ï¼Œæ·æ²ªä¼šæˆ˜ï¼Œè’‹å…‰é¼è”¡å»¶å‡¯æŠ—å‡» ä¸€äºŒä¹è¿åŠ¨ 1935å¹´12ä¹Ÿ9æ—¥ åŒ—å¹³ æŠ—è®®æ—¥æœ¬ä¾µå ï¼›åŒ—å¹³çˆ±å›½å­¦ç”Ÿä¸¾è¡Œçš„æŠ—æ—¥æ¸¸è¡Œè¿åŠ¨ï¼› ä¸ƒä¸ƒäº‹å˜ 1937å¹´7æœˆ7æ—¥ å¢æ²Ÿæ¡¥ æŠ—æ—¥æˆ˜äº‰å¼€å§‹ å…«ä¸€ä¸‰äº‹å˜ 1937å¹´8æœˆ13æ—¥ ä¸Šæµ· è“„æ„å·²ä¹…åœ°ä¸ºæ‰©å¤§ä¾µåæˆ˜äº‰åœ¨ä¸­å›½ä¸Šæµ·åˆ¶é€ çš„äº‹å˜ ä¸€äºŒä¸€è¿åŠ¨ 1945å¹´12æœˆ1æ—¥ æ˜†æ˜ åå¯¹å†…æˆ˜ï¼Œäº‰å–è‡ªç”±ï¼›å¹å“äº†å›½ç»ŸåŒºçˆ±å›½å­¦ç”Ÿè¿åŠ¨çš„ç¬¬ä¸€å£°å·è§’ï¼› æ ¡åœºå£æƒ¨æ¡ˆ 1946å¹´2æœˆ10 é‡åº† åº†ç¥æ”¿åæˆåŠŸå¤§ä¼š ä¸‹å…³æƒ¨æ¡ˆ 1946å¹´6æœˆ23æ—¥ ä¸Šæµ· å’Œå¹³è¯·æ„¿å›¢ ä¸€äºŒä¸‰Oè¿åŠ¨ 1946å¹´12æœˆ30æ—¥ åŒ—å¹³ æŠ—è®®é©»åç¾å†›æš´è¡Œï¼› äº”äºŒOè¿åŠ¨ 1947å¹´5æœˆ20æ—¥ å—äº¬ åé¥¥é¥¿ï¼Œåå†…æˆ˜ï¼ŒæŒ½æ•‘æ•™è‚²å±æœºï¼› é¦™æ¸¯æµ·å‘˜ç½¢å·¥ 1922å¹´1æœˆ é¦™æ¸¯ ä¸­å›½å·¥äººé˜¶çº§ç¬¬ä¸€æ¬¡ç›´æ¥åŒå¸å›½ä¸»ä¹‰åŠ¿åŠ›è¿›è¡Œçš„æœ‰ç»„ç»‡çš„è¾ƒé‡ï¼›å·¥äººè¿åŠ¨ç¬¬ä¸€ä¸ªé«˜æ½®èµ·ç‚¹ã€‚ ä¸»è¦å…šæ´¾ï¼š å…´ä¸­ä¼š 1894å¹´11æœˆ ç¾å›½æª€é¦™å±±ï¼› ä¸­å›½åŒç›Ÿä¼š 1905å¹´8æœˆ æ—¥æœ¬ä¸œäº¬ï¼› ä¸­åé©å‘½å†› 1914å¹´7æœˆ æ—¥æœ¬ä¸œäº¬ï¼› ä¸­å›½å›½æ°‘å…š 1919å¹´10æœˆ ä¸­å›½ä¸Šæµ·ï¼› ä¸­å›½ åœŸåœ°é©å‘½æˆ˜äº‰å‰ä¸­æœŸï¼Œä¸­å›½å…±äº§å…šå†…å‡ºç°çš„ä¸»è¦é”™è¯¯å€¾å‘ï¼š â€œå·¦â€å€¾ç›²ç›®ä¸»ä¹‰ 1927.11-1928.4 â€œå·¦â€å€¾å†’é™©ä¸»ä¹‰ 1930.6-1930.9 â€œå·¦â€å€¾æ•™æ¡ä¸»ä¹‰ 1931.1-1935.1 ä¸ºå›½æèº¯çš„æ¸…æ”¿åºœçˆ±å›½å°†é¢† ç¬¬ä¸€æ¬¡é¸¦ç‰‡æˆ˜äº‰ å…³å¤©åŸ¹ 1841.2 è™é—¨ é™ˆåŒ–æˆ 1842.6 å´æ·è¥¿ç‚®å° æµ·é¾„ 1842.7 é•‡æ±Ÿ ç¬¬äºŒæ¬¡é¸¦ç‰‡æˆ˜äº‰ å²è£æ¤¿ 1859.6 å¤§æ²½ç‚®å° ä¹å–„ 1859.6 å¤§æ²½ç‚®å° ç”²åˆæˆ˜äº‰ å·¦å®è´µ 1894 å¹³å£¤æˆ˜å½¹ ä¸æ±æ˜Œ 1895.2.11 åŒ—æ´‹èˆ°é˜Ÿ é‚“ä¸–æ˜Œ 1894 ç”²åˆæµ·æˆ˜ æ—æ°¸å‡ 1894 ç”²åˆæµ·æˆ˜ åˆ˜æ­¥è‰ é‡è¦å°†é¢†ä»‹ç»ï¼š èµµç™»ç¦¹ï¼ŒæŠ—æ—¥ç‰ºç‰²ï¼› ä½ŸéºŸé˜ï¼ŒæŠ—æ—¥ç‰ºç‰²ï¼› å¼ è‡ªå¿ ï¼Œæ£å®œä¼šæˆ˜ï¼› æˆ´å®‰æ¾œï¼Œç¼…ç”¸æŠ—æˆ˜ï¼› æå®—ä»ï¼Œå°å„¿åº„æˆ˜å½¹ï¼› è°¢æ™‹å…ƒï¼Œä¸Šæµ·å››è¡Œä»“åº“ç‰ºç‰²ï¼› è’‹å…‰é¼è”¡å»¶å‡¯ï¼Œæ·æ²ªä¼šæˆ˜ï¼› ä¸€å¤§å…šï¼ŒäºŒå¤§çº²ã€‚ä¸‰å¤§è¿å›½æåˆä½œï¼Œå››å¤§äº”å¤§å‡€çå¿™ã€‚å…«ä¸€å—æ˜Œç¬¬ä¸€æªï¼Œå…«ä¸ƒæ”¿æƒè¦é æŠ¢ã€‚ç§‹æ”¶å·¥å†œæ¥æˆ˜æ–—ï¼Œä¸‰æ¹¾æ”¹ç¼–æ–°å†›è£…ã€‚éµä¹‰ç”Ÿæ­»è½¬æŠ˜ç‚¹ï¼Œç“¦çª‘æˆ˜çº¿è¦ç»Ÿä¸€ã€‚æ´›å·çº²é¢†æœ‰åæ¡ï¼Œä¸ƒå¤§è€æ¯›æ€æƒ³ç«‹ã€‚ä¸ƒå±ŠäºŒä¸­è¿›åŸå¿™ï¼Œä¸ƒå±Šä¸‰ä¸­å¤å…ƒæ°”ã€‚å…«å¤§ä¸»çŸ›æå»ºè®¾ï¼Œä¹å¤§åå¤§ä¸èƒ½æã€‚åä¸€ä¸‰ä¸­æå¼€æ”¾ï¼Œåä¸€å…­ä¸­è¯„ä»·æ¯›ã€‚åäºŒå°å¹³æä¸­ç‰¹ï¼Œåä¸‰åˆ«å¿˜ä¸‰æ­¥è·‘ã€‚åä¸‰ä¸€ä¸­ä¸¤åŸºæœ¬ï¼Œåå››æ³½æ°‘å»ºå¸‚åœºã€‚åäº”å°å¹³è¿›å…šç« ï¼Œåå…­ä¸‰ä»£è¦å°åº·ã€‚åä¸ƒç§‘è§‚å…¥å…šç« ï¼Œä¸‰å±Šäººå¤§ç°ä»£åŒ–ã€‚åŠ¡è™šå››é¡¹è¦åšæŒï¼Œåå…«ä¸‰ä¸­æ”¹é©å¤§ã€‚åä¹å»ºæˆå¥”å°åº· 1.å°å»ºç¤¾ä¼šçš„åŸºæœ¬ç‰¹ç‚¹ï¼Ÿï¼ˆè¿‡ï¼‰ ç»æµä¸Šï¼Œå°å»ºåœŸåœ°æ‰€æœ‰åˆ¶å ä¸»å¯¼åœ°ä½ï¼Œå°å†œç»æµæ˜¯å…¶åŸºæœ¬ç”Ÿäº§ç»“æ„ï¼› æ”¿æ²»ä¸Šï¼Œå®è¡Œé«˜åº¦ä¸­å¤®é›†æƒçš„å°å»ºå›ä¸»ä¸“åˆ¶åˆ¶åº¦ï¼› æ–‡åŒ–ä¸Šï¼Œä»¥å„’å®¶æ€æƒ³ä¸ºæ ¸å¿ƒï¼› ç¤¾ä¼šç»“æ„ä¸Šï¼Œæ˜¯æ—æƒå’Œæ”¿æƒç›¸ç»“åˆçš„å°å»ºå®—æ³•ç­‰çº§åˆ¶åº¦ï¼› 2.è¿‘ä»£ä¸­å›½ç¤¾ä¼šçš„ä¸»è¦çŸ›ç›¾åŠå…¶å½±å“ï¼Ÿï¼ˆè¿‡ï¼‰ å¸å›½ä¸»ä¹‰å’Œä¸­åæ°‘æ—çš„çŸ›ç›¾ï¼Œå°å»ºç¤¾ä¼šå’Œäººæ°‘å¤§ä¼—çš„çŸ›ç›¾ï¼Œå¸å›½ä¸»ä¹‰å’Œä¸­åæ°‘æ—çš„çŸ›ç›¾æ˜¯ä¸»è¦çŸ›ç›¾ï¼› ä¸¤å¯¹ä¸»è¦çŸ›ç›¾ç›¸äº’äº¤ç»‡åœ¨ä¸€èµ·ï¼Œè´¯ç©¿äº†æ•´ä¸ªåŠæ®–æ°‘åœ°åŠå°å»ºç¤¾ä¼šçš„å§‹ç»ˆï¼Œå¯¹ä¸­å›½ç¤¾ä¼šçš„å‘å±•å˜åŒ–èµ·è¿™å†³å®šæ€§ä½œç”¨ï¼› ç›¸äº’å…³ç³»ï¼š å½“å¤–å›½åˆ—å¼ºå‘ä¸­å›½å‘åŠ¨ä¾µç•¥æˆ˜äº‰æ—¶ï¼Œé˜¶çº§çŸ›ç›¾é™åˆ°æ¬¡è¦åœ°ä½ï¼Œæ°‘æ—çŸ›ç›¾ä¸Šå‡åˆ°ä¸»è¦åœ°ä½ï¼› å½“å¤–å›½ä¾µç•¥è€…åŒä¸­å›½å°å»ºæ”¿æƒç›¸å‹¾ç»“ï¼Œå…±åŒé•‡å‹ä¸­å›½é©å‘½ï¼Œå°¤å…¶æ˜¯å°å»ºåœ°ä¸»é˜¶çº§å¯¹äººæ°‘çš„å‹è¿«ç‰¹åˆ«æ®‹é…·æ—¶ï¼Œé˜¶çº§çŸ›ç›¾ä¸Šå‡ä¸ºä¸»è¦çŸ›ç›¾ï¼› 3.è¿‘ä»£ä»¥æ¥ä¸­åæ°‘æ—é¢ä¸´çš„å†å²ä»»åŠ¡ï¼Ÿï¼ˆè¿‡ï¼‰ ä¸¤å¤§å†å²ä»»åŠ¡ï¼š ä¸€æ˜¯æ±‚å¾—æ°‘æ—ç‹¬ç«‹å’Œäººæ°‘è§£æ”¾ï¼› äºŒæ˜¯å®ç°å›½å®¶ç¹è£å¯Œå¼ºå’Œäººæ°‘å…±åŒå¯Œè£•ï¼› ç›¸äº’åŒºåˆ«ï¼Œç›¸äº’è”ç³»ï¼› å‰è€…è¦ä»æ ¹æœ¬ä¸Šæ¨ç¿»ä¸­å›½åŠæ®–æ°‘åœ°åŠå°å»ºç¤¾ä¼šçš„ç»Ÿæ²»ç§©åºï¼Œç€é‡è§£å†³ç”Ÿäº§å…³ç³»é—®é¢˜ï¼› åè€…è¦æ”¹å˜è¿‘ä»£ä¸­å›½ç»æµã€æ–‡åŒ–å’Œç¤¾ä¼šè½åçš„åœ°ä½å’ŒçŠ¶å†µï¼Œæ˜¯è¦å……åˆ†å‘å±•è¿‘ä»£æ°‘æ—å·¥å•†ä¸šï¼Œç€é‡è§£å†³ç”Ÿäº§åŠ›é—®é¢˜ï¼› åªæœ‰å®Œæˆç¬¬ä¸€å¤§ä»»åŠ¡ï¼Œæ‰èƒ½ä¸ºç¬¬äºŒå¤§ä»»åŠ¡çš„å®Œæˆåˆ›é€ æ¡ä»¶ã€‚ äº‰å–æ°‘æ—ç‹¬ç«‹å’Œäººæ°‘è§£æ”¾æ˜¯å®ç°å›½å®¶ç¹è£å¯Œå¼ºå’Œäººæ°‘å…±åŒå¯Œè£•çš„å‰ææ¡ä»¶ã€‚äº‰å–æ°‘æ—ç‹¬ç«‹å’Œäººæ°‘è§£æ”¾çš„æœ€ç»ˆç›®çš„æ˜¯ä½¿ä¸­å›½èµ°å‘ç°ä»£åŒ–ï¼Œå®ç°å›½å®¶ç¹ è£å¯Œå¼ºå’Œäººæ°‘å…±åŒå¯Œè£•ï¼Œæ˜¯ä¸­å›½æ°‘æ—è‡ªç«‹äºä¸–ç•Œæ°‘æ—ä¹‹æ—ï¼› 4.å¤ªå¹³å¤©å›½å†œæ°‘æˆ˜äº‰çš„å†å²æ„ä¹‰ï¼Ÿï¼ˆè¿‡ï¼‰ å®ƒæ²‰é‡æ‰“å‡»äº†å°å»ºç»Ÿæ²»é˜¶çº§ï¼Œå¼ºçƒˆæ’¼åŠ¨äº†æ¸…æ”¿åºœçš„ç»Ÿæ²»æ ¹åŸºã€‚å®ƒåšæŒäº†14å¹´ä¹‹ä¹…ï¼Œé©å‘½çš„åŠ¿åŠ›å…ˆåæ‰©å±•åˆ°18ä¸ªçœï¼Œå…¶è§„æ¨¡ä¹‹å¤§ï¼Œæ—¶é—´ä¹‹é•¿ï¼Œå½±å“ä¹‹æ·±ï¼Œæ˜¯ä»¥å¾€å†æ¬¡å†œæ°‘èµ·ä¹‰éƒ½æ¯”ä¸ä¸Šçš„ã€‚ å®ƒæ˜¯ä¸­å›½æ—§å¼å†œæ°‘æˆ˜äº‰çš„æœ€é«˜å³°ã€‚å®ƒæŠŠåƒç™¾å¹´æ¥å†œæ°‘å¯¹æ‹¥æœ‰åœŸåœ°çš„æ¸´æœ›ï¼Œåœ¨ã€Šå¤©æœç”°äº©åˆ¶åº¦ã€‹ä¸­æ¯”è¾ƒå®Œæ•´çš„è¡¨è¾¾äº†å‡ºæ¥ã€‚ã€Šèµ„æ”¿æ–°ç¯‡ã€‹åˆ™æ˜¯ä¸­å›½è¿‘ä»£å²ä¸Šç¬¬ä¸€ä¸ªæ¯”è¾ƒç³»ç»Ÿçš„å‘å±•èµ„æœ¬ä¸»ä¹‰çš„æ–¹æ¡ˆã€‚ å®ƒå†²å‡»äº†å­”å­å’Œå„’å®¶ç»å…¸çš„æ­£ç»Ÿæƒå¨ã€‚åœ¨ä¸€å®šç¨‹åº¦ä¸Šå‰Šå¼±äº†å°å»ºç»Ÿæ²»çš„ç²¾ç¥æ”¯æŸ±ã€‚ å®ƒæœ‰åŠ›çš„æ‰“å‡»äº†å¤–å›½ä¾µç•¥åŠ¿åŠ›ã€‚ å®ƒå’Œäºšæ´²å…¶ä»–å›½å®¶çš„æ°‘æ—è§£æ”¾è¿åŠ¨æ±‡åˆåœ¨ä¸€èµ·ï¼Œå†²å‡»äº†è¥¿æ–¹æ®–æ°‘ä¸»ä¹‰åœ¨äºšæ´²çš„ç»Ÿæ²»ã€‚ 5.ç®€è¿°å¤ªå¹³å¤©å›½å®šéƒ½å¤©äº¬åï¼Œå…ˆåé¢å¸ƒçš„ä¸¤ä¸ªé‡è¦çº²é¢†åŠå…¶ç‰¹ç‚¹ï¼Ÿï¼ˆè¿‡ï¼‰ 1853å¹´å†¬é¢å¸ƒã€Šå¤©æœç”°äº©åˆ¶åº¦ã€‹ï¼Œè¿™æ˜¯ä¸€ä¸ªä»¥è§£å†³å†œæ°‘åœŸåœ°é—®é¢˜ä¸ºä¸­å¿ƒçš„æ¯”è¾ƒå®Œæ•´çš„ç¤¾ä¼šæ”¹é©æ–¹æ¡ˆï¼Œæœ€èƒ½ä½“ç°å¤ªå¹³å¤©å›½ç¤¾ä¼šç†æƒ³ï¼› å¤ªå¹³å¤©å›½åæœŸæå‡ºã€Šèµ„æ”¿æ–°ç¯‡ã€‹ï¼Œè¿™æ˜¯ä¸€ä¸ªå¸¦æœ‰é²œæ˜èµ„æœ¬ä¸»ä¹‰è‰²å½©çš„æ”¹é©ä¸å»ºè®¾æ–¹æ¡ˆï¼› 6.å¤ªå¹³å¤©å›½å†œæ°‘æˆ˜äº‰å¤±è´¥çš„ä¸»è¦åŸå› ï¼Ÿï¼ˆè¿‡ï¼‰ ç¼ºä¹å…ˆè¿›é˜¶çº§çš„é¢†å¯¼ï¼ˆæ ¹æœ¬åŸå› ï¼‰ã€‚å†œæ°‘é˜¶çº§ä¸æ˜¯æ–°çš„ç”Ÿäº§åŠ›å’Œç”Ÿäº§å…³ç³»çš„ä»£è¡¨ï¼Œå¸¦æœ‰å°ç”Ÿäº§è€…æ‰€å›ºæœ‰çš„é˜¶çº§å±€é™æ€§ï¼› æ²¡æœ‰ç§‘å­¦ç†è®ºçš„æŒ‡å¯¼ï¼Œå®ƒæ˜¯ä»¥æ‹œä¸Šå¸æ•™æ¥å‘åŠ¨ã€ç»„ç»‡ç¾¤ä¼—çš„ï¼Œä½†æ˜¯æ‹œä¸Šå¸æ•™æ•™ä¹‰ä¸æ˜¯ç§‘å­¦çš„æ€æƒ³ç†è®ºï¼› å¯¹å¤–å›½èµ„æœ¬ä¸»ä¹‰åˆ—å¼ºç¼ºä¹ç†æ€§çš„è®¤è¯†ï¼Œç¬¼ç»Ÿåœ°æŠŠä¿¡å¥‰ä¸Šå¸çš„è¥¿æ–¹äººéƒ½è§†ä¸ºâ€œæ´‹å…„å¼Ÿâ€ï¼› 7.èµ„äº§é˜¶çº§æ€æƒ³ä¸å°å»ºä¸»ä¹‰æ€æƒ³ç¬¬ä¸€æ¬¡æ­£é¢äº¤é”‹æ˜¯ç»´æ–°æ´¾å’Œå®ˆæ—§æ´¾çš„è®ºæˆ˜ï¼ˆè¿‡ï¼‰ è¦ä¸è¦å˜æ³•ï¼› è¦ä¸è¦å…´æ°‘æƒã€è®¾è®®é™¢ã€å®è¡Œå›ä¸»ç«‹å®ªï¼› è¦ä¸è¦åºŸå…«è‚¡ã€æ”¹ç§‘ä¸¾å’Œå…´å­¦å ‚ï¼› 8.èµ„äº§é˜¶çº§é©å‘½æ´¾åŒæ”¹è‰¯æ´¾è®ºæˆ˜çš„ä¸»è¦å†…å®¹åŠé‡è¦æ„ä¹‰ï¼Ÿï¼ˆè¿‡ï¼‰ 1905å¹´è‡³1907å¹´ï¼Œå­™ä¸­å±±ä¸ºä»£è¡¨çš„é©å‘½æ´¾å’Œä»¥åº·æœ‰ä¸ºä¸ºä»£è¡¨çš„æ”¹è‰¯æ´¾ï¼Œåˆ†åˆ«ä»¥ã€Šæ°‘æŠ¥ã€‹å’Œã€Šæ–°æ°‘ä»æŠ¥ã€‹ä¸ºä¸»è¦èˆ†è®ºé˜µåœ°å±•å¼€è®ºæˆ˜ è¦ä¸è¦ä»¥é©å‘½æ‰‹æ®µæ¨ç¿»æ¸…æ”¿åºœï¼Œè®ºæˆ˜ç„¦ç‚¹ï¼› è¦ä¸è¦æ¨ç¿»å¸åˆ¶ï¼Œå®ç°å…±å’Œï¼› è¦ä¸è¦ç¤¾ä¼šé©å‘½ï¼› è®ºæˆ˜ä»¥é©å‘½æ´¾çš„èƒœåˆ©å‘Šç»ˆï¼› é‡è¦æ„ä¹‰ï¼š åˆ’æ¸…äº†é©å‘½ä¸æ”¹è‰¯çš„ç•Œé™ï¼› æ˜¯èµ„äº§é˜¶çº§æ°‘ä¸»æ€æƒ³å’Œä¸‰æ°‘ä¸»ä¹‰æ€æƒ³å¾—åˆ°äº†æ›´å¹¿æ³›çš„ä¼ æ’­ï¼› 9.è¿‘ä»£ä¸­å›½å·¥äººé˜¶çº§çš„ç‰¹ç‚¹ï¼Ÿï¼ˆè¿‡ï¼‰ æ·±å—å¸å›½ä¸»ä¹‰ã€å°å»ºåŠ¿åŠ›å’Œèµ„äº§é˜¶çº§ä¸‰é‡å‹è¿«å’Œå‰¥å‰Šï¼Œé©å‘½æ€§æœ€å¼ºï¼› äººæ•°è™½å°‘ï¼Œä½†ç›¸å¯¹é›†ä¸­ï¼Œä¾¿äºå½¢æˆé©å‘½çš„åŠ›é‡å’Œä¼ æ’­å…ˆè¿›çš„æ€æƒ³ï¼› ä¸»è¦ç”±ç ´äº§å†œæ°‘å’Œå®¶åº­æ‰‹å·¥ä¸šè€…è½¬åŒ–è€Œæ¥ï¼ŒåŒå†œæ°‘æœ‰ç€å¤©ç„¶å…³ç³»ï¼Œä¾¿äºç»“æˆå·¥å†œè”ç›Ÿï¼› 10.æ´‹åŠ¡è¿åŠ¨çš„æŒ‡å¯¼æ€æƒ³å’Œä¸¾åŠçš„æ´‹åŠ¡äº‹ä¸šæ˜¯ä»€ä¹ˆï¼Ÿï¼ˆè¿‡ï¼‰ æ´‹åŠ¡è¿åŠ¨çš„æŒ‡å¯¼æ€æƒ³æ˜¯â€œä¸­å­¦ä¸ºä½“ï¼Œè¥¿å­¦ä¸ºç”¨â€ã€‚ å…´åŠè¿‘ä»£ä¼ä¸šï¼Œæœ€æ—©å…´åŠçš„æ˜¯å†›ç”¨å·¥ä¸šï¼Œ70å¹´ä»£å¼€å§‹å…´åŠæ°‘ç”¨ä¼ä¸šï¼› å»ºç«‹æ–°å¼æµ·é™†å†›ï¼› åˆ›åŠæ–°å¼å­¦å ‚ã€æ´¾é£ç•™å­¦ç”Ÿï¼› 11.æ´‹åŠ¡è¿åŠ¨å¤±è´¥çš„ä¸»è¦åŸå› ï¼Ÿï¼ˆè¿‡ï¼‰ æ´‹åŠ¡è¿åŠ¨å…·æœ‰å°å»ºæ€§ï¼› æ´‹åŠ¡è¿åŠ¨å¯¹è¥¿æ–¹åˆ—å¼ºå…·æœ‰ä¾èµ–æ€§ï¼Œä¼å›¾ä»°ä»—è¥¿æ–¹åˆ—å¼ºæ¥è¾¾åˆ°â€œæ±‚å¼ºâ€ã€â€œæ±‚å¯Œâ€çš„ç›®çš„ï¼› æ´‹åŠ¡ä¼ä¸šçš„ç®¡ç†å…·æœ‰è…æœ½æ€§ï¼Œå¯¹ä¼ä¸šé‡‡å–çš„æ˜¯å°å»ºè¡™é—¨å¼çš„ç®¡ç†æ–¹æ³•ï¼› æ´‹åŠ¡è¿åŠ¨çš„æŒ‡å¯¼æ€æƒ³æ˜¯â€œä¸­å­¦ä¸ºä½“ï¼Œè¥¿å­¦ä¸ºç”¨â€ï¼Œåªæ³¨é‡è¥¿æ³•ç»ƒå…µå’ŒåŠä¼ä¸šï¼Œè€Œä¸å»æ”¹å˜è½åçš„æ”¿æ²»åˆ¶åº¦ï¼› 12.æ´‹åŠ¡è¿åŠ¨çš„å†å²ä½œç”¨ï¼Ÿï¼ˆè¿‡ï¼‰ ä¿ƒè¿›äº†ä¸­å›½æ—©æœŸå·¥ä¸šå’Œæ°‘æ—èµ„æœ¬ä¸»ä¹‰çš„å‘å±•ï¼› å¼€è¾Ÿäº†ä¸€æ‰¹æ–°å¼å­¦å ‚ï¼Œæ´¾å‡ºäº†æœ€æ—©çš„ç•™å­¦ç”Ÿï¼Œæˆä¸ºä¸­å›½è¿‘ä»£æ•™è‚²çš„å¼€ç«¯ï¼› ä¼ æ’­äº†æ–°çŸ¥è¯†ï¼Œæ‰“å¼€äº†äººä»¬çš„çœ¼ç•Œï¼› å¼•èµ·äº†ç¤¾ä¼šé£æ°”å’Œä»·å€¼è§‚å¿µçš„æ”¹å˜ï¼› èµ„äº§é˜¶çº§æ€æƒ³ä¸å°å»ºä¸»ä¹‰æ€æƒ³ç¬¬ä¸€æ¬¡æ­£é¢äº¤é”‹æ˜¯ç»´æ–°æ´¾å’Œå®ˆæ—§æ´¾çš„è®ºæˆ˜ è®ºæˆ˜ä¸»è¦é—®é¢˜ï¼š è¦ä¸è¦å˜æ³•ï¼› è¦ä¸è¦å…´æ°‘æƒã€è®¾è®®é™¢ã€å®è¡Œå›ä¸»ç«‹å®ªï¼› è¦ä¸è¦åºŸå…«è‚¡ã€æ”¹ç§‘ä¸¾å’Œå…´å­¦å ‚ï¼› 13.æˆŠæˆŒå˜æ³•çš„ä¸»è¦å†…å®¹ï¼š æ”¹é©æ”¿åºœæœºæ„ï¼Œè£æ’¤å†—å®˜ï¼Œä»»ç”¨ç»´æ–°äººå£«ï¼› é¼“åŠ±ç§äººå…´åŠå·¥çŸ¿ä¼ä¸šï¼› å¼€åŠæ–°å¼å­¦å ‚å¸å¼•äººæ‰ï¼Œç¿»è¯‘è¥¿æ–¹ä¹¦ç±ï¼Œä¼ æ’­æ–°æ€æƒ³ï¼› åˆ›åŠæŠ¥åˆŠï¼Œå¼€æ”¾è¨€è®ºï¼› è®­ç»ƒæ–°å¼é™†å†›æµ·å†›åŒæ—¶è§„å®šï¼Œç§‘ä¸¾è€ƒè¯•åºŸé™¤å…«è‚¡æ–‡ï¼Œå–æ¶ˆå¤šä½™çš„è¡™é—¨å’Œæ— ç”¨çš„å®˜èŒï¼› 14.æˆŠæˆŒå˜æ³•çš„æ„ä¹‰ï¼šï¼ˆè¿‡ï¼‰ æ˜¯ä¸€æ¬¡å…·æœ‰çˆ±å›½æ•‘äº¡æ„ä¹‰çš„å˜æ³•ç»´æ–°è¿åŠ¨ï¼Œ æ˜¯ä¸€åœºèµ„äº§é˜¶çº§æ€§è´¨çš„çš„æ”¿æ²»æ”¹é©ï¼Œä¹Ÿæ˜¯ä¸€æ¬¡æ€æƒ³å¯è’™è¿åŠ¨ï¼Œ è¿™æ¬¡å˜æ³•ä¿ƒè¿›äº†æ€æƒ³è§£æ”¾ï¼Œå¹¶ä¸”å¯¹æ€æƒ³æ–‡åŒ–çš„å‘å±•å’Œä¿ƒè¿›ä¸­å›½è¿‘ä»£ç¤¾ä¼šçš„è¿›æ­¥èµ·äº†é‡è¦æ¨åŠ¨ä½œç”¨ã€‚ 15.æˆŠæˆŒå¤±è´¥åŸå› ï¼šï¼ˆè¿‡ï¼‰ æ ¹æœ¬åŸå›  èµ„äº§é˜¶çº§ç»´æ–°æ´¾åŠ›é‡è¿‡äºå¼±å°ï¼Œå³èµ„äº§é˜¶çº§çš„è½¯å¼±æ€§ï¼›æ…ˆç¦§æ‰€ä»£è¡¨çš„é¡½å›ºæ´¾æŒæ¡å®æƒï¼Œå®åŠ›å¼ºå¤§ã€‚ ç›´æ¥åŸå›  ç¼ºä¹æ­£ç¡®çš„ç†è®ºæŒ‡å¯¼ï¼› ç¼ºä¹åšå¼ºçš„ç»„ç»‡é¢†å¯¼ï¼› è„±ç¦»å¹¿å¤§äººæ°‘ç¾¤ä¼—ï¼Œåªå¯„å¸Œæœ›äºæ²¡æœ‰å®æƒçš„çš‡å¸å’Œæå°‘æ•°çš„å®˜åƒšï¼› å¯¹å¸å›½ä¸»ä¹‰æŠ±æœ‰ä¸åˆ‡å®é™…çš„å¹»æƒ³ï¼› 16.è¾›äº¥é©å‘½çš„å†å²å±€é™æ€§æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆè¿‡ï¼‰ æ²¡æœ‰æå‡ºå½»åº•çš„åå¯¹å¸å›½ä¸»ä¹‰å’Œåå°å»ºä¸»ä¹‰çš„é©å‘½çº²é¢†ï¼› æ²¡æœ‰å……åˆ†å‘åŠ¨å’Œä¾é æ°‘ä¼—ï¼› æ²¡æœ‰å»ºç«‹åšå¼ºçš„é©å‘½æ”¿å…šï¼› 17.è¾›äº¥é©å‘½çš„å†å²æ„ä¹‰ï¼šï¼ˆè¿‡ï¼‰ 1ï¼‰æ¨ç¿»äº†æ¸…ç‹æœï¼Œç»“æŸäº†ä¸­å›½æ•°åƒå¹´çš„å›ä¸»ä¸“åˆ¶ç»Ÿæ²»ï¼› 2ï¼‰åˆ›å»ºäº†ä¸­åæ°‘å›½ï¼› 3ï¼‰é¢å¸ƒäº†ä¸­å›½å†å²ä¸Šç¬¬ä¸€éƒ¨å…·æœ‰èµ„äº§é˜¶çº§å…±å’Œå›½å®ªæ³•æ€§è´¨çš„ã€Šä¸´æ—¶çº¦æ³•ã€‹ï¼Œä½¿äººæ°‘è·å¾—äº†ä¸€äº›æ°‘ä¸»æƒåˆ©ï¼› 4ï¼‰å¼€åˆ›äº†å®Œå…¨æ„ä¹‰ä¸Šçš„è¿‘ä»£æ°‘æ—æ°‘ä¸»é©å‘½ï¼› 5ï¼‰ç»™ä¸­å›½å…ˆè¿›åˆ†å­ä»¥å·¨å¤§çš„åˆºæ¿€å’Œæ·±åˆ»çš„å¯å‘ï¼Œä½¿ä»–ä»¬è§‰æ‚Ÿåˆ°å¿…é¡»å¦è°‹æ–°çš„æ•‘å›½æ•‘æ°‘ä¹‹è·¯ã€‚ å±€é™æ€§ï¼šè¾›äº¥é©å‘½ä»¥åŒæ—§åŠ¿åŠ›çš„å¦¥åè€Œå‘Šç»ˆï¼Œæ²¡æœ‰ä»æ ¹æœ¬ä¸Šæ”¹å˜ä¸­å›½åŠæ®–æ°‘åœ°åŠå°å»ºç¤¾ä¼šçš„æ€§è´¨ã€‚ 18.1912å¹´å»ºç«‹çš„å—äº¬ä¸´æ—¶é©å‘½æ”¿åºœæ˜¯ä¸€ä¸ªèµ„äº§é˜¶çº§å…±å’Œå›½æ€§è´¨çš„é©å‘½æ”¿æƒï¼Ÿ åœ¨äººå‘˜æ„æˆä¸Šï¼Œèµ„äº§é˜¶çº§é©å‘½æ´¾æ§åˆ¶ç€æ”¿æƒï¼› å…¶å®è¡Œçš„å„é¡¹æ”¿ç­–æªæ–½ï¼Œé›†ä¸­ä½“ç°äº†ä¸­å›½æ°‘æ—èµ„äº§é˜¶çº§çš„æ„¿æœ›å’Œåˆ©ç›Šï¼› ä¸´æ—¶å‚è®®é™¢é¢å¸ƒã€Šä¸­åæ°‘å›½ä¸´æ—¶çº¦æ³•ã€‹ï¼Œæ˜¯ä¸­å›½å†å²ä¸Šç¬¬ä¸€æ­¥å…·æœ‰èµ„äº§é˜¶çº§å…±å’Œå›½å®ªæ³•æ€§è´¨çš„å¤§ç‚¹ï¼› 19.æ–°æ–‡åŒ–è¿åŠ¨çš„å†å²æ„ä¹‰ï¼Ÿ å®ƒæ˜¯èµ„äº§é˜¶çº§æ°‘ä¸»ä¸»ä¹‰çš„æ–°æ–‡åŒ–åŒå°å»ºä¸»ä¹‰æ—§æ–‡åŒ–çš„æ–—äº‰ï¼Œæ˜¯è¾›äº¥é©å‘½çš„æ€æƒ³æ–‡åŒ–é¢†åŸŸçš„å»¶ç»­ï¼Œæ²‰é‡æ‰“å‡»äº†å°å»ºä¸“åˆ¶ä¸»ä¹‰ï¼› å®ƒå¤§åŠ›å®£ä¼ äº†æ°‘ä¸»å’Œç§‘å­¦ï¼Œå¯å‘äº†äººæ°‘çš„ç†æ™ºå’Œæ°‘ä¸»ä¸»ä¹‰è§‰æ‚Ÿï¼Œå°†äººä»¬ä»å°å»ºä¸“åˆ¶æ‰€é€ æˆçš„è’™æ˜§ä¸­è§£æ”¾å‡ºæ¥ï¼Œå¼€å¯äº†æ€æƒ³è§£æ”¾çš„æ½®æµï¼› å®ƒä¸ºä¸­å›½å…ˆè¿›åˆ†å­æ¥å—é©¬å…‹æ€ä¸»ä¹‰åšäº†å‡†å¤‡ï¼Œä¸ºä»¥äº”å››è¿åŠ¨ä¸ºå¼€ç«¯çš„ä¸­å›½æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½åˆ›é€ äº†æ€æƒ³æ–‡åŒ–ä¸Šçš„æ¡ä»¶ï¼› 20.åŒç›Ÿä¼šåœ¨æ—¥æœ¬ä¸œäº¬æˆç«‹ï¼š åˆ›åŠæœºå…³åˆŠç‰©ã€Šæ°‘æŠ¥ã€‹ï¼› æå‡ºâ€œé©±é™¤é‘è™ï¼Œæ¢å¤ä¸­åï¼Œåˆ›ç«‹æ°‘å›½ï¼Œå¹³å‡åœ°æƒâ€çš„çº²é¢†ï¼› å¹¶æ¦‚æ‹¬ä¸ºâ€œæ°‘æ—â€ã€â€œæ°‘æƒâ€ã€â€œæ°‘ç”Ÿâ€çš„â€œä¸‰æ°‘ä¸»ä¹‰â€ï¼› è¿™æ˜¯è¿‘ä»£ä¸­å›½ç¬¬ä¸€ä¸ªé¢†å¯¼èµ„äº§é˜¶çº§é©å‘½çš„å…¨å›½æ€§æ”¿å…šï¼Œå®ƒçš„æˆç«‹æ ‡å¿—ç€ä¸­å›½èµ„äº§é˜¶çº§æ°‘ä¸»é©å‘½è¿›äººåˆ°ä¸€ä¸ªæ–°çš„é˜¶æ®µã€‚ 21.ç®€è¿°å­™ä¸­å±±ä¸‰æ°‘ä¸»ä¹‰å­¦è¯´çš„ä¸»è¦å†…å®¹åŠå…¶æ„ä¹‰ï¼Ÿ æ°‘ä¸»ä¸»ä¹‰ï¼ŒåŒ…æ‹¬â€œé©±é™¤é‘è™ï¼Œæ¢å¤ä¸­åâ€ã€‚ä¸€æ˜¯ä»¥é©å‘½æ‰‹æ®µæ¨ç¿»æ¸…ç‹æœï¼ŒäºŒæ˜¯å˜â€œæ¬¡æ®–æ°‘åœ°â€çš„ä¸­å›½ä¸ºç‹¬ç«‹çš„ä¸­å›½ï¼› æ°‘æƒä¸»ä¹‰ï¼Œâ€œåˆ›ç«‹æ°‘å›½â€ï¼ŒæŒ‡æ¨ç¿»å°å»ºå›ä¸»ä¸“åˆ¶åˆ¶åº¦ï¼Œå»ºç«‹èµ„äº§é˜¶çº§æ°‘ä¸»å…±å’Œå›½ï¼› æ°‘ç”Ÿä¸»ä¹‰ï¼Œâ€œå¹³å‡åœ°æƒâ€ï¼ŒåŸºæœ¬æ–¹æ¡ˆæ˜¯ï¼šæ ¸å®šåœ°ä»·ï¼ŒæŒ‰ä»·å¾ç¨ï¼Œæ¶¨ä»·å½’å…¬ï¼ŒæŒ‰ä»·å”®å–ï¼› æ„ä¹‰ï¼š è¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®Œå¤‡çš„æ°‘ä¸»ä¸»ä¹‰çš„é©å‘½çº²é¢†ï¼Œæ¨åŠ¨äº†é©å‘½æ€æƒ³çš„ä¼ æ’­å’Œé©å‘½è¿åŠ¨çš„å‘å±•ï¼› 22.äº”å››è¿åŠ¨çš„å†å²ç‰¹ç‚¹åŠæ„ä¹‰ï¼Ÿï¼ˆè¿‡ï¼‰ äº”å››è¿åŠ¨æ˜¯ä¸­å›½è¿‘ä»£å²ä¸Šä¸€æ¬¡å½»åº•åå¸å›½åå°å»ºçš„é©å‘½è¿åŠ¨ï¼Œæ˜¯ä¸€åœºçœŸæ­£ç¾¤ä¼—æ€§çš„é©å‘½è¿åŠ¨ï¼› ä¿ƒè¿›äº†é©¬å…‹æ€ä¸»ä¹‰åœ¨ä¸­å›½çš„å¹¿æ³›ä¼ æ’­; ä¿ƒè¿›é©¬å…‹æ€ä¸»ä¹‰åŒä¸­å›½å·¥äººè¿åŠ¨çš„ç»“åˆ; äº”å››è¿åŠ¨æ˜¯ä¸­å›½æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½çš„å¼€ç«¯; æ— äº§é˜¶çº§é€æ¸æ›¿ä»£èµ„äº§é˜¶çº§æˆä¸ºè¿‘ä»£ä¸­å›½æ°‘æ—æ°‘ä¸»é©å‘½çš„é¢†å¯¼è€…ï¼› 23.å…«ä¸€å—æ˜Œèµ·ä¹‰çš„å†å²æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿï¼ˆè¿‡ï¼‰ æ‰“å“æ­¦è£…åæŠ—å›½æ°‘å…šååŠ¨ç»Ÿæ²»çš„ç¬¬ä¸€æª; å®ƒæˆä¸ºå…±äº§å…šç‹¬ç«‹é¢†å¯¼é©å‘½æˆ˜äº‰ã€åˆ›å»ºäººæ°‘å†›é˜Ÿå’Œæ­¦è£…å¤ºå–æ”¿æƒçš„ä¼Ÿå¤§å¼€ç«¯ï¼› æ­å¼€åœŸåœ°é©å‘½æˆ˜äº‰çš„åºå¹•ï¼› ä½“ç°äº†ä¸­å›½å…±äº§å…šäººä¸ºå®è¡Œä¸­å›½äººæ°‘çš„æ ¹æœ¬åˆ©ç›Šå’Œä¸­å›½æ°‘æ—çš„è§£æ”¾äº‹ä¸šè€Œå‰èµ´åç»§çš„é©å‘½ç²¾ç¥ 24.ä¸­å›½å…±äº§å…šæˆç«‹çš„å†å²æ„ä¹‰ï¼Ÿ å®ƒæ ‡å¿—ç€ä¸­å›½é©å‘½ç»ˆäºæœ‰äº†ä¸€ä¸ªåšå¼ºçš„é¢†å¯¼æ ¸å¿ƒï¼Œæœ‰äº†å¯ä¾èµ–çš„ç»„ç»‡è€…å’Œé¢†å¯¼è€…ï¼› ä¸­å›½é©å‘½ä»æ­¤æœ‰äº†ç§‘å­¦çš„æŒ‡å¯¼æ€æƒ³ï¼Œä¸­å›½å…±äº§å…šä»¥é©¬å…‹æ€åˆ—å®ä¸»ä¹‰åŸºæœ¬åŸç†è§‚å¯Ÿå’Œåˆ†æä¸­å›½çš„é—®é¢˜ï¼Œä¸ºä¸­å›½æŒ‡æ˜äº†æ–—äº‰ç›®æ ‡ã€é©å‘½å‰é€”å’Œèƒœåˆ©ä¹‹è·¯ï¼› å®ƒæ²Ÿé€šäº†ä¸­å›½é©å‘½ä¸ä¸–ç•Œé©å‘½çš„è”ç³»ï¼ŒæŠŠä¸­åæ°‘æ—çš„è§£æ”¾è¿åŠ¨åŒä¸–ç•Œæ— äº§é˜¶çº§ç¤¾ä¼šä¸»ä¹‰é©å‘½è¿åŠ¨ç›¸è”ç»“ï¼Œæ˜¯ä¸­å›½é©å‘½æœ‰äº†æ–°çš„å‰é€”ï¼› è‡ªä»æœ‰äº†ä¸­å›½å…±äº§å…šï¼Œä¸­å›½é©å‘½çš„é©å‘½å°±ç„•ç„¶ä¸€æ–°äº†ï¼› 25.æ¯›æ³½ä¸œé¢†å¯¼çš„æ¹˜èµ£è¾¹ç•Œç§‹æ”¶èµ·ä¹‰çš„ç‰¹ç‚¹ï¼Ÿ å®ƒæ”¾å¼ƒäº†â€œå·¦æ´¾å›½æ°‘å…šâ€è¿åŠ¨çš„æ——å·ï¼Œå…¬å¼€æ‰“å‡ºäº†â€œå·¥å†œé©å‘½å†›â€çš„æ°”è´¨ï¼› å®ƒä¸ä»…æ˜¯å†›é˜Ÿçš„è¡ŒåŠ¨ï¼Œè€Œä¸”æœ‰æ•°é‡ä¼—å¤šçš„å·¥å†œæ­¦è£…å‚åŠ ï¼› 26.ä¸‰æ¹¾æ”¹ç¼–çš„ä¸»è¦å†…å®¹ï¼Ÿ å°†åŸæœ‰çš„ä¸€ä¸ªå¸ˆç¼©ç¼–ä¸ºä¸€ä¸ªå›¢ï¼› åœ¨éƒ¨é˜Ÿä¸­å»ºç«‹å…±äº§å…šå„çº§ç»„ç»‡ï¼Œå°†å…šçš„æ”¯éƒ¨å»ºåœ¨è¿ä¸Šï¼› æˆç«‹å„çº§å£«å…µå§”å‘˜ä¼šï¼Œéƒ¨é˜Ÿå†…éƒ¨å®è¡Œæ°‘ä¸»ç®¡ç†ï¼› 27.1926å¹´è‡³1927å¹´ï¼ŒåŒ—ä¼æˆ˜äº‰ç›´æ¥æ‰“å‡»çš„ç›®æ ‡å’Œæˆ˜ç•¥æ–¹é’ˆï¼Ÿ åŒ—ä¼çš„ç›´æ¥ç›®æ ‡æ˜¯æ‰“å€’å¸å›½ä¸»ä¹‰æ”¯æŒçš„åŒ—æ´‹å†›é˜€ï¼šå´ä½©å­šã€å­™ä¼ èŠ³ã€å¼ ä½œéœ–ï¼› åŒ—ä¼çš„æˆ˜ç•¥æ–¹é’ˆï¼šé¦–å…ˆè¿›å†›ä¸¤æ¹–ï¼Œæ¶ˆç­å´ä½©å­šï¼Œç„¶åå¼•å…µä¸œå‘ï¼Œæ¶ˆç­å­™ä¼ èŠ³ï¼Œæœ€åï¼ŒåŒ—ä¸Šè§£å†³å¼ ä½œéœ–ï¼› 28.å…«ä¸ƒä¼šè®®çš„ä¸»è¦å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ å½»åº•æ¸…ç®—å¤§é©å‘½åæœŸé™ˆç‹¬ç§€å³å€¾æœºä¼šä¸»ä¹‰é”™è¯¯ï¼› é€‰å‡ºäº†ä»¥ç¿ç§‹ç™½ä¸ºé¦–çš„ä¸­å¤®ä¸´æ—¶æ”¿æ²»å±€ï¼› ç¡®ç«‹äº†åœŸåœ°é©å‘½å’Œæ­¦è£…æ–—äº‰çš„æ–¹é’ˆï¼› æ¯›æ³½ä¸œæå‡ºäº†â€œé¡»çŸ¥æ”¿æƒæ˜¯ç”±æªæ†å­ä¸­å–å¾—çš„â€é‡è¦ç†è®ºï¼› 29.éµä¹‰ä¼šè®®é›†ä¸­è§£å†³çš„ä¸»è¦é—®é¢˜åŠå…¶æ„ä¹‰ï¼Ÿï¼ˆè¿‡ï¼‰ éµä¹‰ä¼šè®®é›†ä¸­è§£å†³äº†å½“æ—¶å…·æœ‰å†³å®šæ„ä¹‰çš„å†›äº‹å’Œç»„ç»‡é—®é¢˜ï¼› æ„ä¹‰ï¼š å¼€å§‹ç¡®ç«‹äº†ä»¥æ¯›æ³½ä¸œä¸ºä»£è¡¨çš„é©¬å…‹æ€ä¸»ä¹‰æ­£ç¡®çº¿è·¯åœ¨å…šä¸­å¤®çš„é¢†å¯¼åœ°ä½ï¼› åœ¨æå…¶å±æœºçš„æƒ…å†µä¸‹æŒ½æ•‘äº†ä¸­å›½å…±äº§å…šã€æŒ½æ•‘äº†ä¸­å›½å·¥å†œçº¢å†›ã€æŒ½æ•‘äº†ä¸­å›½é©å‘½ï¼› æˆä¸ºä¸­å›½å…±äº§å…šå†å²ä¸Šä¸€ä¸ªç”Ÿæ­»æ”¸å…³çš„è½¬æŠ˜ç‚¹ï¼› ä¸ºå…šå’Œé©å‘½äº‹ä¸šè½¬å±ä¸ºå®‰ã€ä¸æ–­æ‰“å¼€æ–°å±€é¢æä¾›äº†æœ€é‡è¦çš„ä¿è¯ï¼› 30.æ´›å·ä¼šè®®æŒ‡å®šçš„ã€ŠæŠ—æ—¥æ•‘å›½åæ¡çº²é¢†ã€‹çš„ä¸»è¦å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ è¦æ‰“å€’æ—¥æœ¬å¸å›½ä¸»ä¹‰ï¼Œå…³é”®åœ¨äºå®è¡Œå…¨å›½å†›äº‹æ€»åŠ¨å‘˜ã€å…¨å›½äººæ°‘çš„æ€»åŠ¨å‘˜ï¼Œä½¿æŠ—æˆ˜æˆä¸ºå…¨é¢çš„å…¨æ°‘æ—çš„æŠ—æˆ˜ï¼› å¿…é¡»æ”¹é©æ”¿æ²»æœºæ„ï¼Œç»™äººæ°‘ä»¥å……åˆ†çš„æŠ—æ—¥æ°‘ä¸»æƒåˆ©ï¼Œå¹¶é€‚å½“æ”¹å–„å·¥å†œå¤§ä¼—çš„ç”Ÿæ´»ï¼› å¿…é¡»åšæŒç»Ÿä¸€æˆ˜çº¿ä¸­æ— äº§é˜¶çº§çš„é¢†å¯¼æƒï¼Œåœ¨æ•Œåæ”¾æ‰‹å‘åŠ¨ç‹¬ç«‹è‡ªä¸»çš„å±±åœ°æ¸¸å‡»æˆ˜äº‰ï¼Œåœ¨å›½ç»ŸåŒºæ”¾æ‰‹å‘åŠ¨æŠ—æ—¥çš„ç¾¤ä¼—è¿åŠ¨ï¼› 31.äº•å†ˆå±±æ ¹æ®åœ°åˆ›å»ºçš„å†å²æ„ä¹‰ï¼Ÿ å®ƒç‚¹ç‡ƒäº†â€œå·¥å†œæ­¦è£…å‰²æ®â€çš„æ˜Ÿæ˜Ÿä¹‹ç«ï¼Œä¸ºå…±äº§å…šé¢†å¯¼çš„å…¶ä»–å„åœ°çš„èµ·ä¹‰æ­¦è£…æ ‘ç«‹äº†æ¦œæ ·ï¼› å®ƒä»å®è·µä¸Šå¼€è¾Ÿäº†ä¸€æ¡åœ¨æ•Œæˆ‘åŠ›é‡ååˆ†æ‚¬æ®Šçš„æƒ…å†µä¸‹ï¼Œå…±äº§å…šæ·±å…¥å†œæ‘ä¿å­˜å’Œå‘å±•é©å‘½åŠ›é‡çš„æ­£ç¡®é“è·¯ï¼› 32.ä¸­å›½å·¥å†œçº¢å†›é•¿å¾èƒœåˆ©çš„å†å²æ„ä¹‰ï¼Ÿ ä¸­å›½å·¥å†œçº¢å†›çš„é•¿å¾æ˜¯ä¸€éƒ¨ä¼Ÿå¤§çš„é©å‘½è‹±é›„ä¸»ä¹‰å²è¯—ã€‚å®ƒç²‰ç¢äº†å›½æ°‘å…šâ€œå›´å‰¿â€çº¢å†›ã€æ¶ˆç­é©å‘½åŠ›é‡çš„ä¼å›¾ï¼Œæ˜¯ä¸­å›½é©å‘½è½¬å±ä¸ºå®‰çš„å…³é”® é€šè¿‡é•¿å¾ï¼Œä¸­å›½é©å‘½çš„å¤§æœ¬è¥æ”¾åœ¨äº†è¥¿åŒ—ï¼Œè¿™ä½è¿æ¥ä¸­å›½äººæ°‘æŠ—æ—¥æ•‘äº¡çš„æ–°é«˜æ½®å‡†å¤‡äº†æ¡ä»¶ï¼› é•¿å¾ä¿å­˜å¹¶é”¤ç‚¼äº†ä¸­å›½é©å‘½çš„éª¨å¹²åŠ›é‡ï¼Œè¿™æ˜¯å…šå’Œçº¢å†›æä¸ºå®è´µçš„ç²¾åï¼› é•¿å¾æ’­æ’’äº†é©å‘½çš„ç«ç§ï¼Œå®ƒä¸ºæ²¿é€”çš„äººæ°‘ç¾¤ä¼—å®£å¸ƒï¼Œåªæœ‰åœ¨ä¸­å›½å…±äº§å…šçš„é¢†å¯¼ä¸‹ï¼Œä¸­å›½å„æ—äººæ°‘æ‰èƒ½ç¿»èº«å¾—è§£æ”¾ï¼› ä¸­å›½å…±äº§å…šäººå’Œçº¢å†›å°†å£«ç”¨ç”Ÿå‘½å’Œçƒ­è¡€é“¸å°±äº†ä¼Ÿå¤§çš„é•¿å¾ç²¾ç¥ï¼› 33.ä¸­å›½é©å‘½ç»Ÿä¸€æˆ˜çº¿ä¸­çš„ä¸¤ä¸ªè”ç›ŸåŠå…¶å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ ä¸€ä¸ªæ˜¯åŠ³åŠ¨è€…çš„è”ç›Ÿï¼Œä¸»è¦æ˜¯å·¥äººã€å†œæ°‘å’ŒåŸå¸‚å°èµ„äº§é˜¶çº§çš„è”ç›Ÿï¼Œè¿™æ˜¯æœ€åŸºæœ¬çš„ã€é‡è¦çš„ï¼› ä¸€ä¸ªæ˜¯åŠ³åŠ¨è€…ä¸éåŠ³åŠ¨è€…çš„è”ç›Ÿï¼Œä¸»è¦æ˜¯åŠ³åŠ¨è€…æ°‘æ—èµ„äº§é˜¶çº§çš„è”ç›Ÿï¼ŒåŒ…æ‹¬ä¸€éƒ¨åˆ†å¤§èµ„äº§é˜¶çº§çš„æš‚æ—¶è”ç›Ÿï¼Œè¿™æ˜¯è¾…åŠ©çš„ã€é‡è¦çš„ï¼› 34.ä¸­å›½å…±äº§å…šåœ¨å…¨æ°‘æ—æŠ—æˆ˜ä¸­çš„ä¸­æµç ¥æŸ±ä½œç”¨ï¼Ÿ ä¸­å›½å…±äº§å…šçš„ä¸­æµç ¥æŸ±ä½œç”¨æ˜¯ä¸­å›½äººæ°‘æŠ—æ—¥æˆ˜äº‰èƒœåˆ©çš„å…³é”®ã€‚ä¸­å›½å…±äº§å…šè‡ªæˆç«‹ä¹‹æ—¥èµ·å°±æŠŠå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´ä½œä¸ºè‡ªå·±çš„å†å²ä½¿å‘½ã€‚ åœ¨æŠ—æ—¥æˆ˜äº‰ä¸­ï¼Œä¸­å›½å…±äº§å…šåšæŒå…¨é¢æŠ—æˆ˜è·¯çº¿ï¼Œåˆ¶å®šäº†æ­£ç¡®æˆ˜ç•¥ç­–ç•¥ï¼Œå¼€è¾Ÿå¹¿å¤§æ•Œåæˆ˜åœºï¼Œæˆä¸ºåšæŒæŠ—æˆ˜çš„ä¸­åšåŠ›é‡ï¼›ä¸­å›½å…±äº§å…šä»¥è‡ªå·±çš„æ”¿æ²»ä¸»å¼ ï¼Œåšå®šæ„å¿—ã€æ¨¡èŒƒè¡ŒåŠ¨ï¼Œæ”¯æ’‘èµ·å…¨æ°‘æ—æ•‘äº¡å›¾å­˜çš„å¸Œæœ›ï¼Œå¼•é¢†ç€å¤ºå–æˆ˜äº‰èƒœåˆ©çš„æ­£ç¡®æ–¹å‘ã€‚æˆä¸ºå¤ºå–æˆ˜äº‰èƒœåˆ©çš„æ°‘æ—å…ˆé”‹ã€‚ 35.ä¸­å›½äººæ°‘æŠ—æ—¥æˆ˜äº‰èƒœåˆ©çš„ä¸»è¦åŸå› ï¼Ÿ ä»¥çˆ±å›½ä¸»ä¹‰ä¸ºæ ¸å¿ƒçš„ä¼Ÿå¤§æ°‘æ—ç²¾ç¥æ˜¯ä¸­å›½äººæ°‘æŠ—æ—¥æˆ˜äº‰èƒœåˆ©çš„å†³å®šå› ç´ ï¼› ä¸­å›½å…±äº§å…šçš„ä¸­æµç ¥æŸ±ä½œç”¨æ˜¯ä¸­å›½äººæ°‘æŠ—æ—¥æˆ˜äº‰èƒœåˆ©çš„å…³é”®ï¼› å…¨æ°‘æ—æŠ—æˆ˜æ˜¯ä¸­å›½äººæ°‘æŠ—æ—¥æˆ˜äº‰èƒœåˆ©çš„ä¸»è¦æ³•å®ï¼› ä¸–ç•Œæ‰€æœ‰çˆ±å¥½å’Œå¹³å’Œæ­£ä¹‰çš„å›½å®¶å’Œäººæ°‘ã€å›½é™…ç»„ç»‡ä»¥åŠå„ç§åæ³•è¥¿æ–¯åŠ›é‡çš„åŒæƒ…å’Œæ”¯æŒï¼Œæ˜¯ä¸­å›½äººæ°‘æŠ—æ—¥æˆ˜äº‰èƒœåˆ©çš„å›½é™…æ¡ä»¶ï¼› 36.ä¸­å›½äººæ°‘æŠ—æ—¥æˆ˜äº‰åœ¨ä¸–ç•Œåæ³•è¥¿æ–¯æˆ˜äº‰ä¸­çš„åœ°ä½ï¼Ÿ ä¸­å›½äººæ°‘æŠ—æ—¥æˆ˜äº‰æ˜¯ä¸–ç•Œåæ³•è¥¿æ–¯æˆ˜äº‰çš„ä¸œæ–¹ä¸»æˆ˜åœºã€‚ä¸­å›½æŠ—æˆ˜å¼€å§‹æœ€æ—©ï¼ŒæŒç»­æ—¶é—´æœ€é•¿ï¼Œç‰µåˆ¶å’ŒæŠ—å‡»äº†æ—¥æœ¬å†›å›½ä¸»ä¹‰çš„ä¸»è¦å…µåŠ›ï¼Œå¯¹æ—¥æœ¬ä¾µç•¥è€…çš„å½»åº•è¦†ç­èµ·åˆ°äº†å†³å®šæ€§ä½œç”¨ï¼› ä¸­å›½äººæ°‘çš„æŒä¹…æŠ—æˆ˜ï¼Œéåˆ¶äº†æ—¥æœ¬çš„â€œåŒ—è¿›â€è®¡åˆ’ï¼Œè¿Ÿæ»äº†æ—¥æœ¬çš„â€œå—è¿›â€æ­¥ä¼ï¼Œè¾¾è¾¾å‡è½»äº†å…¶ä»–æˆ˜åœºçš„å‹åŠ›ï¼Œä¸ºç›Ÿå›½å†›é˜Ÿå®Œæˆæˆ˜ç•¥è½¬æŠ˜å’Œå®æ–½æˆ˜ç•¥åæ”»åˆ›é€ äº†æœ‰åˆ©æ¡ä»¶ï¼› ä¸­å›½ä½œä¸ºäºšå¤ªåœ°åŒºç›Ÿå†›å¯¹æ—¥ä½œæˆ˜çš„é‡è¦åæ–¹åŸºåœ°ï¼Œä¸ºç›Ÿå†›æä¾›äº†å¤§é‡æˆ˜ç•¥ç‰©èµ„å’Œå†›äº‹æƒ…æŠ¥ï¼Œä¸­å›½å†›é˜Ÿå‡ºé”…ä½œæˆ˜ï¼Œä¸è¿‘æ‰“å‡»äº†æ—¥æœ¬ï¼Œè¿˜å¯¹ç›Ÿå†›ç»™ä¸äº†å®é™…æ”¯æ´ï¼› ä¸­å›½ä¸ºæˆ˜èƒœæ³•è¥¿æ–¯ã€ç»´æŠ¤ä¸–ç•Œå’Œå¹³ä»˜å‡ºäº†å·¨å¤§çš„ç‰ºç‰²ï¼Œåšå‡ºäº†ä¼Ÿå¤§çš„è´¡çŒ®ï¼› 37.ä¸­å›½å…±äº§å…šæŠ—æ—¥æ°‘æ—ç»Ÿä¸€æˆ˜çº¿çš„ç­–ç•¥æ€»æ–¹é’ˆæ˜¯ä»€ä¹ˆï¼Ÿ å‘å±•è¿›æ­¥åŠ¿åŠ›ï¼Œè¿›æ­¥åŠ¿åŠ›ä¸»è¦æŒ‡å·¥äººã€å†œæ°‘å’ŒåŸå¸‚å°èµ„äº§é˜¶çº§ï¼› äº‰å–ä¸­é—´åŠ¿åŠ›ï¼Œä¸­é—´åŠ¿åŠ›ä¸»è¦æŒ‡æ°‘æ—èµ„äº§é˜¶çº§ã€å¼€æ˜ç»…å£«å’Œåœ°æ–¹å®åŠ›æ´¾ï¼› å­¤ç«‹é¡½å›ºåŠ¿åŠ›ï¼Œé¡½å›ºåŠ¿åŠ›ä¸»è¦æŒ‡å¤§åœ°ä¸»å¤§èµ„äº§é˜¶çº§çš„æŠ—æ—¥æ‹ï¼Œä»¥è’‹ä»‹çŸ³é›†å›¢ä¸ºä»£è¡¨çš„å›½æ°‘å…šäº²è‹±ç¾æ´¾ï¼› 38.ä¸­å›½æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½èƒœåˆ©çš„åŸºæœ¬ç»éªŒï¼Ÿ å»ºç«‹å¹¿æ³›çš„ç»Ÿä¸€æˆ˜çº¿ã€‚è¿™æ˜¯åšæŒå’Œå‘å±•é©å‘½çš„æ”¿æ²»åŸºç¡€ã€‚ç»Ÿä¸€æˆ˜çº¿ä¸­å­˜åœ¨ç€ä¸¤ä¸ªè”ç›Ÿï¼šä¸€ä¸ªæ˜¯åŠ³åŠ¨è€…çš„è”ç›Ÿï¼Œä¸€ä¸ªæ˜¯åŠ³åŠ¨è€…ä¸éåŠ³åŠ¨è€…çš„è”ç›Ÿï¼Œå¿… é¡»åšæŒä¾é ç¬¬ä¸€ä¸ªè”ç›Ÿï¼Œäº‰å–å»ºç«‹å’Œå¤¸å¤§ç¬¬äºŒä¸ªè”ç›Ÿï¼› åšæŒé©å‘½çš„æ­¦è£…æ–—äº‰ï¼Œä¸­å›½é©å‘½åªèƒ½ä»¥é•¿æœŸçš„æ­¦è£…æ–—äº‰ä½œä¸ºä¸»è¦å½¢å¼ï¼šä¸­å›½é©å‘½å¿…é¡»èµ°å†œæ‘åŒ…å›´åŸå¸‚ã€æ­¦è£…å¤ºå–æ”¿æƒçš„é“è·¯ï¼›å¿…é¡»å»ºç«‹ä¸€ç›´å…šç»å¯¹ é¢†å¯¼ä¸‹çš„æ–°å¼äººæ°‘å†›é˜Ÿï¼› åŠ å¼ºå…±äº§å…šè‡ªèº«çš„å»ºè®¾ï¼Œç€é‡ä»æ€æƒ³ä¸Šå»ºå…šï¼šåŸ¹è‚²å’Œå‘æ‰¬ç†è®ºä¸å®é™…ç›¸ç»“åˆã€å¯†åˆ‡è”ç³»ç¾¤ä¼—å’Œè‡ªæˆ‘æ‰¹è¯„çš„ä½œé£ï¼›æˆä¸ºç»Ÿä¸€æˆ˜çº¿å’Œæ­¦è£…æ–—äº‰è¿™ä¸¤ä¸ªæ­¦ å™¨ä»¥å®è¡Œå¯¹æ•Œå†²é”‹é™·é˜µçš„è‹±å‹‡æˆ˜å£«ï¼Œæˆä¸ºä¸­å›½å„æ—äººæ°‘æ‹¥æˆ´çš„é¢†å¯¼æ ¸å¿ƒï¼› 39.æ–°æ°‘ä¸»ä¸»ä¹‰ç¤¾ä¼šçš„äº”ç§ç»æµæˆåˆ†åŠç‰¹ç‚¹ï¼Ÿ ç¤¾ä¼šä¸»ä¹‰æ€§è´¨çš„å›½è¥ç»æµï¼› åŠç¤¾ä¼šä¸»ä¹‰æ€§è´¨çš„åˆä½œç¤¾ç»æµï¼› å†œæ°‘å’Œæ‰‹å·¥ä¸šè€…çš„ä¸ªä½“ç»æµï¼› ç§äººèµ„æœ¬ä¸»ä¹‰ç»æµï¼› å›½å®¶èµ„æœ¬ä¸»ä¹‰ç»æµï¼› ç‰¹ç‚¹ï¼šæ—¢æœ‰ç¤¾ä¼šä¸»ä¹‰å› ç´ ï¼Œåˆæœ‰èµ„æœ¬ä¸»ä¹‰å› ç´ ï¼Œæœ¬èº«å…·æœ‰è¿‡æ¸¡æ€§ï¼› 40.åœ¨ã€Šè®ºæŒä¹…æˆ˜ã€‹ä¸€æ–‡ä¸­ï¼Œæ¯›æ³½ä¸œå¦‚ä½•é˜è¿°æŠ—æ—¥æˆ˜äº‰æ˜¯æŒä¹…æˆ˜ï¼Œæœ€åèƒœåˆ©å±äºä¸­å›½ï¼Ÿ ä¸­æ—¥åŒå‘å­˜åœ¨ç€ç›¸äº’çŸ›ç›¾çš„å››ä¸ªç‰¹ç‚¹ï¼šæ•Œå¼ºæˆ‘å¼±ï¼Œæ•Œå°æˆ‘å¤§ï¼Œæ•Œé€€æ­¥æˆ‘è¿›æ­¥ï¼Œæ•Œå¯¡åŠ©æˆ‘å¤šåŠ©ï¼› ä¸€æ–¹é¢ï¼Œæ—¥æœ¬æ˜¯å¼ºå›½ï¼Œä¸­å›½æ˜¯å¼±å›½ï¼Œå¼ºå›½å¼±å›½çš„å¯¹æ¯”ï¼Œå†³å®šäº†æŠ—æ—¥æˆ˜äº‰åªèƒ½æ˜¯æŒä¹…æˆ˜ï¼› ä¸€æ–¹é¢ï¼Œæ—¥æœ¬æ˜¯æ•ˆæœï¼Œå‘åŠ¨çš„äº‹é€€æ­¥çš„ã€é‡è›®çš„ä¾µç•¥æˆ˜äº‰ï¼Œåœ¨å›½é™…ä¸Šå¤±é“å¯¡åŠ©ï¼›è€Œä¸­å›½æ˜¯å¤§å›½ï¼Œè¿›è¡Œçš„æ˜¯è¿›æ­¥çš„ã€æ­£ä¹‰çš„åä¾µç•¥æˆ˜äº‰ï¼Œå›½é™…ä¸Šå¾—é“ å¤šåŠ©ï¼› ä¸­å›½å·²ç»æœ‰äº†ä»£è¡¨ä¸­åæ°‘æ—å’Œä¸­å›½äººæ°‘æ ¹æœ¬åˆ©ç›Šçš„å…±äº§å…šåŠå…¶é¢†å¯¼çš„äººæ°‘å†›é˜Ÿå’ŒæŠ—æ—¥æ ¹æ®åœ°ã€‚å› æ­¤ï¼Œæœ€åèƒœåˆ©æ˜¯ä¸­å›½çš„ï¼› 41.æ¯›æ³½ä¸œåœ¨ã€Šè®ºæŒä¹…æˆ˜ã€‹ä¸­å¯¹æŠ—æ—¥æˆ˜äº‰å†å²è¿›ç¨‹çš„é˜è¿°ã€‚ ä¸­å›½æŠ—æ—¥æˆ˜äº‰å°†ç»è¿‡æˆ˜ç•¥é˜²å¾¡ã€æˆ˜ç•¥ç›¸æŒã€æˆ˜ç•¥åæ”»ä¸‰ä¸ªé˜¶æ®µï¼› æˆ˜ç•¥ç›¸æŒé˜¶æ®µï¼Œæ—¶ä¸­å›½æŠ—æ—¥æˆ˜äº‰å–å¾—æœ€åèƒœåˆ©çš„æœ€å…³é”®çš„é˜¶æ®µï¼› åªè¦åšæŒæŒä¹…æŠ—æˆ˜ã€åšæŒæŠ—æ—¥æ°‘æ—ç»Ÿä¸€æˆ˜çº¿ï¼Œä¸­å›½å°†åœ¨è¿™ä¸ªé˜¶æ®µè·å¾—è½¬å¼±ä¸ºå¼ºçš„åŠ›é‡ï¼› 42.ç®€è¿°ä¸­å›½æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½å–å¾—èƒœåˆ©çš„ä¸»è¦åŸå› ï¼Ÿ ä¸€æ˜¯æœ‰äº†ä¸­å›½å·¥äººé˜¶çº§çš„å…ˆé”‹é˜Ÿï¼Œä¸­å›½å…±äº§å…šçš„é¢†å¯¼ã€‚å®ƒä»¥é©¬å…‹æ€åˆ—å®ä¸»ä¹‰åŸºæœ¬åŸç†ä¸ä¸­å›½å®é™…ç›¸ç»“åˆçš„æ¯›æ³½ä¸œæ€æƒ³ä½œä¸ºä¸€åˆ‡å·¥ä½œçš„æŒ‡é’ˆï¼Œåˆ¶å®šå‡ºç¬¦åˆä¸­å›½å›½æƒ…å’Œäººæ°‘åˆ©ç›Šçš„çº²é¢†ã€è·¯çº¿ã€æ–¹é’ˆå’Œæ”¿ç­–ï¼›ä»–å…·æœ‰è¿œè§ï¼Œæœ€å¯Œæœ‰ç‰ºç‰²ç²¾ç¥ï¼Œæœ€åšå®šï¼Œä»è€Œèµ¢å¾—äº†ä¸­å›½äººæ°‘çš„è¡·å¿ƒæ‹¥æŠ¤ï¼› äºŒæ˜¯äººæ°‘ç¾¤ä¼—å’Œå„ç•Œäººå£«çš„å¹¿æ³›å‚åŠ å’Œå¤§åŠ›æ”¯æŒã€‚å·¥äººã€å†œæ°‘ã€åŸå¸‚å°èµ„äº§é˜¶çº§ç¾¤ä¼—æ˜¯æ°‘ä¸»é©å‘½çš„ä¸»è¦åŠ›é‡ï¼›éšç€æ–—äº‰çš„å‘å±•ï¼Œæ°‘æ—èµ„äº§é˜¶çº§ä¹Ÿé€æ­¥å‘å…±äº§å…šé æ‹¢ï¼› ä¸‰æ˜¯å›½é™…æ— äº§é˜¶çº§å’Œäººæ°‘ç¾¤ä¼—çš„æ”¯æŒï¼› 43.ä¸­å›½å…±äº§å…šåœ¨è¿‡æ¸¡æ—¶æœŸæ€»è·¯çº¿çš„å†…å®¹åŠå…¶ç‰¹ç‚¹ï¼Ÿ è¦åœ¨ä¸€ä¸ªç›¸å½“é•¿çš„æ—¶æœŸå†…ï¼Œé€æ­¥å®ç°å›½å®¶çš„ç¤¾ä¼šä¸»ä¹‰å·¥ä¸šåŒ–ï¼Œå¹¶é€æ­¥å®ç°å›½å®¶å¯¹å†œä¸šã€æ‰‹å·¥ä¸šå’Œå¯¹èµ„æœ¬ä¸»ä¹‰å·¥å•†ä¸šçš„ç¤¾ä¼šä¸»ä¹‰æ”¹é€ ã€‚ è¿™æ˜¯ç¤¾ä¼šä¸»ä¹‰å»ºè®¾åŒç¤¾ä¼šä¸»ä¹‰æ”¹é€ åŒæ—¶å¹¶ä¸¾çš„æ€»è·¯çº¿ï¼Œä½“ç°äº†ç”Ÿäº§åŠ›å’Œå˜é©ç”Ÿäº§å…³ç³»çš„æœ‰æœºç»Ÿä¸€ã€‚ 44.å…¨å›½è§£æ”¾æˆ˜äº‰æ—¶æœŸï¼Œå„æ°‘ä¸»å…šæ´¾ä¸ä¸­å›½å…±äº§å…šå›¢ç»“åˆä½œçš„é‡è¦è¡¨ç°ï¼Ÿ åœ¨é‡åº†è°ˆåˆ¤å’Œæ”¿åä¼šè®®æœŸé—´ï¼Œå„æ°‘ä¸»å…šæ´¾ä½œä¸ºâ€œç¬¬ä¸‰æ–¹é¢â€ï¼ŒåŒå…±äº§å…šä¸€èµ·åå¯¹å›½æ°‘å…šååŠ¨æ´¾çš„å†…æˆ˜ã€ç‹¬è£æ”¿ç­–ï¼Œä¸ºå’Œå¹³æ°‘ä¸»äºŒå…±åŒåŠªåŠ›ã€‚ åœ¨å›½æ°‘å…šå½“å±€æ’•æ¯æ”¿ååè®®ã€å‘é¢å…¨é¢å†…æˆ˜åï¼Œæ°‘ä¸»å…šæ´¾ä¸­çš„å¤§å¤šæ•°åŒå…±äº§å…šä¿æŒä¸€è‡´ï¼Œæ‹’ç»å‚åŠ å›½æ°‘å…šä¸€æ‰‹åŒ…åŠçš„â€œå›½æ°‘å¤§ä¼šâ€ã€åå¯¹å›½æ°‘å…šç‚®åˆ¶çš„â€œå®ªæ³•â€ 45.æ¯›æ³½ä¸œæå‡ºçš„ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å»ºè®¾çš„æˆ˜ç•¥ç›®æ ‡å’Œæ­¥éª¤ï¼Ÿ ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å»ºè®¾çš„æˆ˜ç•¥ç›®æ ‡ï¼šæŠŠä¸­å›½å»ºè®¾æˆä¸ºä¸€ä¸ªå…·æœ‰ç°ä»£å†œä¸šã€ç°ä»£å·¥ä¸šã€ç°ä»£å›½é˜²å’Œç°ä»£ç§‘å­¦å¼ºå›½ã€‚ ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å»ºè®¾çš„æ­¥éª¤ï¼šé‡‡å–â€œä¸¤æ­¥èµ°â€çš„å‘å±•æˆ˜ç•¥ï¼Œ ç¬¬ä¸€æ­¥ï¼Œå»ºç«‹ä¸€ä¸ªç‹¬ç«‹çš„æ¯”è¾ƒå®Œæ•´çš„å·¥ä¸šä½“ç³»å’Œå›½æ°‘ç»æµä½“ç³»ï¼› ç¬¬äºŒæ­¥ï¼Œå…¨é¢å®ç°å†œä¸šã€å·¥ä¸šã€å›½é˜²å’Œç§‘å­¦æŠ€æœ¯çš„ç°ä»£åŒ–ï¼Œæ˜¯ä¸­å›½çš„ç»æµèµ°å‘ä¸–ç•Œå‰åˆ—ï¼› 46.æ–°ä¸­å›½å»ºç«‹åˆæœŸä¸­å›½å…±äº§å…šé¢ä¸´çš„ä¸»è¦é—®é¢˜å’Œè€ƒéªŒï¼Ÿ èƒ½ä¸èƒ½ä¿å«ä½äººæ°‘èƒœåˆ©çš„æˆæœï¼Œå·©å›ºæ–°ç”Ÿçš„äººæ°‘æ”¿æƒï¼› èƒ½ä¸èƒ½æˆ˜èƒœä¸¥é‡çš„ç»æµå›°éš¾ï¼Œè¿…é€Ÿæ¢å¤å’Œå‘å±•å›½æ°‘ç»æµï¼› èƒ½ä¸èƒ½å·©å›ºæ°‘æ—ç‹¬ç«‹ï¼Œç»´æŠ¤å›½å®¶ä¸»æƒå’Œå®‰å…¨ã€‚ èƒ½ä¸èƒ½ç»å—ä½æ‰§æ”¿çš„è€ƒéªŒï¼Œç»§ç»­ä¿æŒè°¦è™šã€è°¨æ…ã€ä¸éª„ã€ä¸èºçš„ä½œé£å’Œè‰°è‹¦å¥‹æ–—çš„ä½œé£ã€‚ 47.ä¸ƒå¤§å¬å¼€ å¤§ä¼šæå‡ºå…šçš„æ”¿æ²»è·¯çº¿æ˜¯ï¼š æ”¾æ‰‹å‘åŠ¨ç¾¤ä¼—ï¼Œå£®å¤§äººæ°‘åŠ›é‡ï¼Œåœ¨å…šçš„é¢†å¯¼ä¸‹ï¼Œæ‰“è´¥æ—¥æœ¬ä¾µç•¥è€…ï¼Œè§£æ”¾å…¨å›½äººæ°‘ï¼Œå»ºç«‹ä¸€ä¸ªæ–°æ°‘ä¸»ä¸»ä¹‰çš„ä¸­å›½ã€‚ å¤§ä¼šå¼ºè°ƒæ¯›æ³½ä¸œæ€æƒ³ä¸ºå…¨å…šçš„æŒ‡å¯¼æ€æƒ³ã€‚ å¤§ä¼šé€šè¿‡çš„æ–°å…šç« å¼ºè°ƒäº†ç¾¤ä¼—è·¯çº¿å’Œå…šçš„æ°‘ä¸»é›†ä¸­åˆ¶åŸåˆ™ã€‚ è¿™æ¬¡å¤§ä¼šæ˜¯å›¢ç»“çš„å¤§ä¼šï¼Œèƒœåˆ©çš„å¤§ä¼šï¼Œä¸ºæŠ—æ—¥æˆ˜äº‰å’Œå¤ºå–æ–°æ°‘ä¸»ä¸»ä¹‰é©å‘½åœ¨å…¨å›½çš„èƒœåˆ©å¥ å®šäº†åŸºç¡€ã€‚ 48.æ¯›æ³½ä¸œå‘è¡¨ã€Šè®ºåå¤§å…³ç³»ã€‹ä¸€æ–‡çš„æ„ä¹‰ï¼Ÿ å®ƒæ˜¯ä»¥æ¯›æ³½ä¸œä¸ºä¸»è¦ä»£è¡¨çš„ä¸­å›½å…±äº§å…šäººå¼€å§‹æ¢ç´¢ä¸­å›½è‡ªå·±çš„ç¤¾ä¼šä¸»ä¹‰å»ºè®¾é“è·¯çš„æ ‡å¿—ï¼› ä»ç»æµå’Œæ”¿æ²»æ–¹é¢æå‡ºäº†æ–°çš„æŒ‡å¯¼æ–¹é’ˆï¼Œä¸ºä¸­å…±å…«å¤§ï¼ˆ1956å¹´ï¼‰çš„å¬å¼€åšäº†ç†è®ºå‡†å¤‡ï¼› 49.å››ä¸ªç°ä»£åŒ–ï¼Ÿ å†œä¸šç°ä»£åŒ–ã€å·¥ä¸šç°ä»£åŒ–ã€å›½é˜²ç°ä»£åŒ–ã€ç§‘å­¦æŠ€æœ¯ç°ä»£åŒ– 50.ç®€è¿°1979å¹´3æœˆï¼Œé‚“å°å¹³æå‡ºçš„å››é¡¹åŸºæœ¬åŸåˆ™åŠåšæŒè¿™äº›åŸåˆ™çš„é‡è¦æ€§ï¼Ÿ åšæŒç¤¾ä¼šä¸»ä¹‰é“è·¯ï¼ŒåšæŒäººæ°‘æ°‘ä¸»ä¸“æ”¿ï¼ŒåšæŒå…±äº§å…šé¢†å¯¼ï¼ŒåšæŒé©¬å…‹æ€åˆ—å®ä¸»ä¹‰ã€æ¯›æ³½ä¸œæ€æƒ³ï¼› è¿™æ˜¯å®ç°å››ä¸ªç°ä»£åŒ–çš„æ ¹æœ¬æ°”ä½“ï¼Œå¦‚æœåŠ¨æ‘‡äº†å…¶ä¸­çš„ä»»ä½•ä¸€é¡¹ï¼Œä¹Ÿå°±åŠ¨æ‘‡äº†æ•´ä¸ªç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å»ºè®¾äº‹ä¸šï¼› 51.ç®€è¿°æ¯›æ³½ä¸œç­‰è€ä¸€ä»£é©å‘½å®¶æ¢ç´¢ä¸­å›½ç¤¾ä¼šä¸»ä¹‰æ°‘ä¸»æ”¿æ²»å»ºè®¾é“è·¯çš„ç†è®ºè´¡çŒ®ï¼Ÿ ç¬¬ä¸€ï¼Œè¦é€ æˆä¸€ä¸ªåˆæœ‰é›†ä¸­åˆæœ‰æ°‘æƒï¼Œåˆæœ‰çºªå¾‹åˆæœ‰è‡ªç”±ï¼Œåˆæœ‰ç»Ÿä¸€æ„å¿—ï¼Œåˆæœ‰ä¸ªäººå¿ƒæƒ…èˆ’ç•…ã€ç”ŸåŠ¨æ´»æ³¼çš„æ”¿æ²»å±€é¢ï¼› ç¬¬äºŒï¼ŒæŠŠæ­£ç¡®å¤„ç†äººæ°‘å†…éƒ¨çŸ›ç›¾ä½œä¸ºå›½å®¶æ”¿æ²»ç”Ÿæ´»çš„ä¸»é¢˜ï¼ŒåšæŒäººæ°‘æ°‘ä¸»ï¼Œå›¢ç»“ä¸€åˆ‡å¯ä»¥å›¢ç»“çš„åŠ›é‡ï¼› ç¬¬ä¸‰ï¼Œå¤„ç†å¥½ä¸­å›½å…±äº§å…šåŒå„æ°‘ä¸»å…šæ´¾çš„å…³ç³»ï¼ŒåšæŒé•¿æœŸå…±å­˜ã€äº’ç›¸ç›‘ç£çš„æ–¹é’ˆï¼Œå·©å›ºå’Œæ‰©å¤§çˆ±å›½ç»Ÿä¸€æˆ˜çº¿ï¼› ç¬¬å››ï¼Œåˆ‡å®ä¿éšœäººæ°‘å½“å®¶åšä¸»çš„å„é¡¹æƒåˆ©ï¼Œå°¤å…¶æ˜¯äººæ°‘å‚ä¸å›½å®¶å’Œç¤¾ä¼šäº‹åŠ¡ç®¡ç†çš„æƒåˆ©ï¼› ç¬¬äº”ï¼Œç¤¾ä¼šä¸»ä¹‰æ³•åˆ¶è¦ä¿æŠ¤åŠ³åŠ¨äººæ°‘åˆ©ç›Šï¼Œä¿æŠ¤ç¤¾ä¼šä¸»ä¹‰ç»æµåŸºç¡€ï¼Œä¿æŠ¤ç¤¾ä¼šä¸»ä¹‰ç”Ÿäº§åŠ›ï¼› 52.ä¸­å…±å…«å¤§å¦‚ä½•åˆ†ææˆ‘å›½ç¤¾ä¼šä¸»ä¹‰æ”¹é€ å®Œæˆåå›½å†…çš„çŸ›ç›¾å’Œä¸»è¦ä»»åŠ¡ï¼Ÿ ç¤¾ä¼šä¸»ä¹‰æ”¹é€ å®Œæˆåï¼Œæˆ‘ä»¬å›½å†…çš„ä¸»è¦çŸ›ç›¾ï¼Œå·²ç»æ˜¯äººæ°‘å¯¹äºå»ºç«‹å…ˆè¿›çš„å·¥ä¸šå›½çš„è¦æ±‚åŒè½åçš„å†œä¸šå›½çš„ç°å®ä¹‹é—´çš„çŸ›ç›¾ï¼Œå·²ç»æ˜¯äººæ°‘å¯¹äºç»æµæ–‡ åŒ–è¿…é€Ÿå‘å±•éœ€è¦åŒå½“å‰ç»æµæ–‡åŒ–ä¸èƒ½æ»¡è¶³äººæ°‘éœ€è¦çš„çŠ¶å†µä¹‹é—´çš„çŸ›ç›¾ï¼› å½“åˆå…¨å›½äººæ°‘çš„ä¸»è¦ä»»åŠ¡æ˜¯é›†ä¸­åŠ›é‡æ¥è§£å†³è¿™ä¸ªçŸ›ç›¾ï¼ŒæŠŠæˆ‘å›½å°½å¿«ä»è½åçš„å†œä¸šå›½å˜æˆå…ˆè¿›çš„å·¥ä¸šå›½ï¼› 53.ä¸­å…±å…«å¤§æå‡ºçš„æˆ‘å›½ç»æµå»ºè®¾å’Œæ”¿æ²»å»ºè®¾çš„æŒ‡å¯¼æ–¹é’ˆæ—¶ä»€ä¹ˆï¼Ÿ åœ¨ç»æµå»ºè®¾ä¸Šï¼Œå¤§ä¼šåšæŒæ—¢åä¿å®ˆåˆåå†’è¿›ï¼Œå³åœ¨ç»¼åˆå¹³è¡¡ä¸­ç¨³æ­¥å‰è¿›çš„æ–¹é’ˆï¼› å†æ”¿æ²»å»ºè®¾ä¸Šï¼Œå¤§ä¼šè¦æ±‚ç»§ç»­åŠ å¼ºæˆ‘å›½çš„äººæ°‘æ°‘ä¸»ä¸“æ”¿ï¼ŒåŠ å¼ºå›½å†…å„æ°‘æ—çš„å›¢ç»“ï¼Œç»§ç»­å·©å›ºäººæ°‘æ°‘ä¸»ç»Ÿä¸€æˆ˜çº¿ï¼Œé€æ­¥æŒ‡å®šå®Œå–„çš„æ³•å¾‹ï¼Œå»ºç«‹å¥å…¨çš„æ³•åˆ¶ï¼› 54.ç¤¾ä¼šä¸»ä¹‰æ”¹é€ åŸºæœ¬å®Œæˆçš„æ„ä¹‰ï¼Ÿ ç¤¾ä¼šä¸»ä¹‰æ”¹é€ çš„åŸºæœ¬å®Œæˆï¼Œä½¿ç¤¾ä¼šä¸»ä¹‰åŸºæœ¬ç»æµåˆ¶åº¦åœ¨ä¸­å›½å…¨é¢åœ°å»ºç«‹èµ·æ¥äº†ï¼Œæ˜¯ä¸­å›½è¿›å…¥ç¤¾ä¼šä¸»ä¹‰ç¤¾ä¼šçš„æœ€é‡è¦çš„æ ‡å¿—ï¼› ç¤¾ä¼šä¸»ä¹‰æ”¹é€ æ˜¯åœ¨ç”Ÿäº§å…³ç³»æ–¹é¢ç”±ç§æœ‰åˆ¶åˆ°å…¬æœ‰åˆ¶çš„ä¸€åœºä¼Ÿå¤§çš„å˜é©ï¼Œå¯¹ç”Ÿäº§åŠ›çš„å‘å±•æ”¯æŒèµ·åˆ°äº†ä¿ƒè¿›ä½œç”¨ï¼› é€šè¿‡ç¤¾ä¼šä¸»ä¹‰æ”¹é€ ï¼Œä¸­å›½å…±äº§å…šé¢†å¯¼å…¨å›½å„æ—äººæ°‘åˆ›é€ æ€§åœ°å®Œæˆäº†ç”±æ–°æ°‘ä¸»ä¸»ä¹‰åˆ°ç¤¾ä¼šä¸»ä¹‰çš„è¿‡æ¸¡ï¼Œå®ç°äº†ä¸­å›½å†å²ä¸Šæœ€æ·±åˆ»çš„ç¤¾ä¼šåˆ¶åº¦ï¼› 55.ä¸­å›½ç»å†çš„ä¸‰æ¬¡å†å²æ€§å·¨å˜ï¼Ÿ ç¬¬ä¸€æ¬¡æ˜¯è¾›äº¥é©å‘½ï¼Œæ¨ç¿»é€šçŸ¥ä¸­å›½å‡ åƒå¹´çš„å›ä¸»ä¸“åˆ¶åˆ¶åº¦ï¼› ç¬¬äºŒæ¬¡æ˜¯ä¸­åäººæ°‘å…±å’Œå›½çš„æˆç«‹å’Œç¤¾ä¼šä¸»ä¹‰åˆ¶åº¦çš„å»ºç«‹ï¼› ç¬¬ä¸‰æ¬¡æ˜¯æ”¹é©å¼€æ”¾ï¼Œä¸ºå®ç°ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–è€Œå¥‹æ–—ï¼› 56.æˆ‘å›½å†œæ‘ç¤¾ä¼šä¸»ä¹‰æ”¹é€ çš„è¿‡æ¸¡æ€§ç»æµç»„ç»‡å½¢å¼ä»¥åŠå…¶æ€§è´¨æ˜¯ä»€ä¹ˆï¼Ÿ ç¬¬ä¸€æ˜¯äº’åŠ©ç»„ï¼Œè¿™æ˜¯å…·æœ‰ç¤¾ä¼šä¸»ä¹‰èŒèŠ½æ€§è´¨çš„ç»æµç»„ç»‡ï¼› ç¬¬äºŒæ˜¯åˆçº§å†œä¸šç”Ÿäº§åˆä½œç¤¾ï¼Œè¿™æ˜¯å…·æœ‰åŠç¤¾ä¼šä¸»ä¹‰æ€§è´¨çš„ç»æµç»„ç»‡ï¼› ç¬¬ä¸‰æ˜¯é«˜çº§å†œæ‘ç”Ÿäº§åˆä½œç¤¾ï¼Œè¿™æ˜¯å…·æœ‰ç¤¾ä¼šä¸»ä¹‰æ€§è´¨çš„ç»æµç»„ç»‡ï¼› 57.â€œä¸‰ä¸ªä¸»ä½“ï¼Œä¸‰ä¸ªè¡¥å……â€çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ å›½å®¶ç»è¥å’Œé›†ä½“ç»è¥ä¸ºä¸»ä½“ï¼Œä¸€å®šæ•°é‡çš„ä¸ªä½“ç»è¥ä¸ºè¡¥å……ï¼› è®¡åˆ’ç”Ÿäº§æ˜¯ä¸»ä½“ï¼Œä¸€å®šèŒƒå›´çš„è‡ªç”±ç”Ÿäº§ä¸ºè¡¥å……ï¼› å›½å®¶å¸‚åœºæ˜¯ä¸»é¢˜ï¼Œä¸€å®šèŒƒå›´çš„è‡ªç”±å¸‚åœºä¸ºè¡¥å……ï¼› 58.ä¸­å…±åä¸‰å¤§æŒ‡å®šçš„ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å»ºè®¾â€œä¸‰æ­¥èµ°â€çš„æˆ˜ç•¥éƒ¨ç½²æ˜¯ä»€ä¹ˆï¼Ÿ ç¬¬ä¸€æ­¥ï¼Œå®ç°å›½æ°‘ç”Ÿäº§æ€»å€¼æ¯”1980å¹´ç¿»ä¸€ç•ªï¼Œè§£å†³äººæ°‘çš„æ¸©é¥±é—®é¢˜ï¼› ç¬¬äºŒæ­¥ï¼Œåˆ°20ä¸–çºªæœ«ï¼Œä½¿å›½æ°‘ç”Ÿäº§æ€»å€¼å†å¢é•¿ä¸€å€ï¼Œäººæ°‘ç”Ÿäº§è¾¾åˆ°å°åº·æ°´å¹³ï¼› ç¬¬ä¸‰æ­¥ï¼Œåˆ°21ä¸–çºªä¸­å¶ï¼Œäººå‡å›½æ°‘ç”Ÿäº§æ€»å€¼è¾¾åˆ°ä¸­ç­‰å‘è¾¾å›½å®¶æ°´å¹³ï¼Œäººæ°‘ç”Ÿæ´»æ¯”è¾ƒå¯Œè£•ï¼ŒåŸºæœ¬å®ç°ç°ä»£åŒ–ï¼› 60.ä¸€äºŒä¹è¿åŠ¨åŠå…¶å†å²æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ 1935å¹´12æœˆ9æ—¥ï¼Œåœ¨ä¸­å›½å…±äº§å…šæ•‘äº¡å›¾å­˜ã€å…¨æ°‘æŠ—æˆ˜çš„å·å¬å’Œä¸­å…±åŒ—å¹³ä¸´æ—¶å·¥ä½œå§”å‘˜ä¼šçš„é¢†å¯¼ä¸‹ï¼ŒåŒ—å¹³å­¦ç”Ÿä¸¾è¡Œå£°åŠ¿æµ©å¤§çš„æŠ—æ—¥æ¸¸æˆï¼Œé­åˆ°å›½æ°‘å…šå†›è­¦é•‡å‹ã€‚ ä¸€äºŒä¹è¿åŠ¨æ‰“å‡»äº†æ—¥æœ¬å¸å›½ä¸»ä¹‰ä¾µç•¥ä¸­å›½å¹¶åå¹¶ååŒ—çš„è®¡åˆ’ï¼Œä¿ƒè¿›äº†ä¸­åæ°‘æ—çš„è§‰é†’ï¼Œæ ‡å¿—ç€ä¸­å›½äººæ°‘æŠ—æ—¥æ•‘äº¡è¿åŠ¨æ–°é«˜æ½®çš„åˆ°æ¥ã€‚ åœ¨20ä¸–çºª30å¹´ä»£åæœŸå’Œ40å¹´ä»£å‰æœŸï¼Œæ¯›æ³½ä¸œæ’°å†™äº†ã€Šã€ˆå…±äº§å…šäººã€‰å‘åˆŠè¯ã€‹ã€ã€Šä¸­å›½é©å‘½å’Œä¸­å›½å…±äº§å…šã€‹ã€ã€Šæ–°æ°‘ä¸»ä¸»ä¹‰è®ºã€‹ç­‰ä¸€æ‰¹é‡è¦çš„ç†è®ºè‘—ä½œã€‚æ–°æ°‘ä¸»ä¸»ä¹‰ç†è®ºçš„ç³»ç»Ÿé˜æ˜ï¼Œæ ‡å¿—ç€æ¯›æ³½ä¸œæ€æƒ³å¾—åˆ°å¤šæ–¹é¢å±•å¼€è€Œè¾¾åˆ°æˆç†Ÿã€‚1937å¹´å¤ï¼Œæ¯›æ³½ä¸œåœ¨å»¶å®‰æŠ—æ—¥å†›æ”¿å¤§å­¦è®²æˆã€Šå®è·µè®ºã€‹ã€ã€ŠçŸ›ç›¾è®ºã€‹ï¼Œç§‘å­¦åœ°é˜æ˜äº†å…šçš„é©¬å…‹æ€ä¸»ä¹‰çš„æ€æƒ³è·¯çº¿ã€‚å¹³å‹å…³å¤§æ· å…«è·¯å†›å‡ºå¸ˆä»¥æ¥æ‰“çš„ç¬¬ä¸€ä¸ªå¤§èƒœä»— ä¸­å…±ä¸€å¤§ï¼Œæ ‡å¿—ä¸­å›½å…±äº§å…šæˆç«‹ï¼›çº²é¢†æ˜¯ï¼šé©å‘½å†›é˜Ÿå¿…é¡»ä¸æ— äº§é˜¶çº§ä¸€èµ·æ¨ç¿»èµ„æœ¬å®¶é˜¶çº§çš„æ”¿æƒï¼›ç¡®å®šå…šçš„æ ¹æœ¬æ”¿æ²»ç›®çš„æ˜¯å®è¡Œç¤¾ä¼šé©å‘½ã€‚ä¸­å…±äºŒå¤§ï¼Œåˆ¶å®šåå¸åå°å»ºçš„æ°‘ä¸»é©å‘½çº²é¢†ï¼›ä¸­å…±ä¸‰å¤§ï¼Œå†³å®šåŒå›½æ°‘å…šåˆä½œï¼Œå»ºç«‹é©å‘½ç»Ÿä¸€æˆ˜çº¿ï¼›å›½æ°‘å…šä¸€å¤§ï¼Œæ ‡å¿—ç€ç¬¬ä¸€æ¬¡å›½å…±åˆä½œçš„æ­£å¼å½¢æˆï¼›å½¢æˆäº†ä»¥å¹¿å·ä¸ºä¸­å¿ƒçš„åå¯¹å¸å›½ä¸»ä¹‰å’Œå°å»ºå†›é˜€çš„é©å‘½æ–°å±€é¢ï¼›ä¸­å…±å››å¤§ï¼Œé€šè¿‡äº†ã€Šå¯¹äºæ°‘æ—é©å‘½è¿åŠ¨ä¹‹è®®å†³æ¡ˆã€‹ï¼Œé™ˆç‹¬ç§€å½“é€‰ä¸ºä¸­å¤®æ€»ä¹¦è®°å…¼ä¸­å¤®ç»„ç»‡éƒ¨ä¸»ä»»ï¼Œå½­è¿°ä¹‹ä»»ä¸­å¤®å®£ä¼ éƒ¨ä¸»ä»»ï¼Œå¼ å›½ç„˜ä»»ä¸­å¤®å·¥å†œéƒ¨ä¸»ä»»ï¼Œè”¡å’Œæ£®ã€ç¿ç§‹ç™½ä»»ä¸­å¤®å®£ä¼ éƒ¨å§”å‘˜ï¼›ä¸­å…±äº”å¤§ï¼Œå¤§ä¼šé€šè¿‡äº†ã€Šæ”¿æ²»å½¢åŠ¿ä¸å…šçš„ä»»åŠ¡è®®å†³æ¡ˆã€‹ã€ŠåœŸåœ°é—®é¢˜è®®å†³æ¡ˆã€‹ç­‰ï¼›â€œå…«ä¸ƒä¼šè®®â€ï¼Œåœ¨æ±‰å£å¬å¼€ï¼Œå½»åº•æ¸…ç®—äº†å¤§é©å‘½åæœŸçš„é™ˆç‹¬ç§€å³å€¾æœºä¼šä¸»ä¹‰é”™è¯¯ï¼Œç¡®å®šäº†åœŸåœ°é©å‘½å’Œæ­¦è£…åæŠ—å›½æ°‘å…šååŠ¨ç»Ÿæ²»çš„æ€»æ–¹é’ˆï¼Œå¹¶é€‰å‡ºäº†ä»¥ç¿ç§‹ç™½ä¸ºé¦–çš„ä¸­å¤®ä¸´æ—¶æ”¿æ²»å±€ã€‚ä¸­å…±å…­å±Šå…­ä¸­å…¨ä¼šï¼Œæ¯›æå‡ºäº†â€é©¬å…‹æ€ä¸»ä¹‰çš„ä¸­å›½åŒ–â€è¿™ä¸ªå‘½é¢˜ï¼›ä¸­å…±ä¸ƒå±ŠäºŒä¸­å…¨ä¼šï¼Œè§„å®šæ”¿æ²»ã€ç»æµã€å¤–äº¤åŸºæœ¬æ”¿ç­–ï¼›å†œä¸šå›½è½¬å˜å·¥ä¸šå›½ã€æ–°æ°‘ä¸»ä¸»ä¹‰ç¤¾ä¼šè½¬å˜ç¤¾ä¼šä¸»ä¹‰ç¤¾ä¼šæ–¹å‘ï¼›æå‡ºâ€œä¸¤ä¸ªåŠ¡å¿…â€è¦æ±‚ï¼›ä¸­å…±ä¸ƒå±Šä¸‰ä¸­å…¨ä¼šï¼Œæ¯›åšã€Šä¸ºäº‰å–å›½å®¶è´¢æ”¿ç»æµçŠ¶å†µçš„åŸºæœ¬å¥½è½¬è€Œæ–—äº‰çš„ã€‹æŠ¥å‘Šï¼Œåˆ›å»ºä¸‰ä¸ªæ¡ä»¶ï¼ŒåœŸåœ°æ”¹é©çš„å®Œæˆï¼Œç°æœ‰å·¥å•†ä¸šçš„è°ƒæ•´ï¼Œå›½å®¶æœºæ„æ‰€éœ€ç»è´¹çš„å¤§é‡èŠ‚å‡ï¼›ä¸­å…±ä¸ƒå¤§ï¼Œé€šè¿‡äº†æ–°çš„å…šç« ï¼Œç¡®å®šä»¥é©¬å…‹æ€åˆ—å®ä¸»ä¹‰ä¸ä¸­å›½é©å‘½å®è·µç›¸ç»Ÿä¸€çš„æ¯›æ³½ä¸œæ€æƒ³ä½œä¸ºå…¨å…šä¸€åˆ‡å·¥ä½œçš„æŒ‡é’ˆï¼›ä¸­å…±å…«å¤§ï¼Œæ¢ç´¢å»ºè®¾ç¤¾ä¼šä¸»ä¹‰é“è·¯çš„å¼€ç«¯ã€‚é™ˆæâ€œä¸‰ä¸ªä¸»ä½“ï¼Œä¸‰ä¸ªè¡¥å……â€æ€æƒ³ã€‚å…šå’Œäººæ°‘ä¸»è¦ä»»åŠ¡æ˜¯æŠŠæˆ‘å›½ä»è½åçš„å†œä¸šå›½å˜ä¸ºå…ˆè¿›çš„çš„å·¥ä¸šå›½ï¼›ä¸­å…±åä¸€å±Šä¸‰ä¸­å…¨ä¼šï¼Œè¿™æ˜¯å»ºå›½ä»¥æ¥å…šçš„å†å²ä¸Šå…·æœ‰æ·±è¿œæ„ä¹‰çš„è½¬æŠ˜ï¼Œæ˜¯æ”¹é©å¼€æ”¾çš„å¼€ç«¯ï¼Œä»æ­¤æˆ‘å›½è¿›å…¥ç¤¾ä¼šä¸»ä¹‰ç°ä»£åŒ–å»ºè®¾çš„æ–°æ—¶æœŸã€‚ä¸­å…±åäºŒå¤§ï¼Œé‚“å°å¹³æå‡ºå»ºè®¾æœ‰ä¸­å›½ç‰¹è‰²çš„ç¤¾ä¼šä¸»ä¹‰ï¼Œå…¨å›½äººå¤§é¢å¸ƒäº†ç¬¬å››éƒ¨ã€Šä¸­åäººæ°‘å…±å’Œå›½å®ªæ³•ã€‹ã€‚ä¸­å…±åä¸‰å¤§ï¼Œé‚“é˜æ˜äº†ç¤¾ä¼šä¸»ä¹‰åˆçº§é˜¶æ®µç†è®ºï¼Œæå‡ºäº†å…šåœ¨ç¤¾ä¼šä¸»ä¹‰åˆçº§é˜¶æ®µçš„â€œä¸€ä¸ªä¸­å¿ƒã€ä¸¤ä¸ªåŸºæœ¬ç‚¹â€åŸºæœ¬è·¯çº¿ï¼Œå³ä»¥ç»æµå»ºè®¾ä¸ºä¸­å¿ƒï¼ŒåšæŒå››é¡¹åŸºæœ¬åŸåˆ™ï¼ŒåšæŒæ”¹é©å¼€æ”¾ã€‚åˆ¶å®šäº†ä¸‹ä¸€æ­¥ç»æµä½“åˆ¶æ”¹é©å’Œæ”¿æ²»ä½“åˆ¶æ”¹é©çš„åŸºæœ¬ä»»åŠ¡å’Œå¥‹æ–—ç›®æ ‡ï¼›ä¸­å…±åå››å¤§ï¼Œæå‡ºå»ºç«‹ç¤¾ä¼šä¸»ä¹‰å¸‚åœºç»æµä½“åˆ¶ï¼Œç¡®ç«‹äº†é‚“å°å¹³ç†è®ºåœ¨å…¨å…šçš„æŒ‡å¯¼åœ°ä½ï¼Œå½¢æˆäº†ä»¥æ±Ÿæ³½æ°‘ä¸ºæ ¸å¿ƒçš„ç¬¬ä¸‰ä»£é¢†å¯¼é›†ä½“ã€‚ä¸­å…±åäº”å¤§ï¼ŒæŠŠé‚“å°å¹³ç†è®ºå†™å…¥å…šç« ï¼Œç¡®ç«‹ä¸ºå…šçš„æŒ‡å¯¼æ€æƒ³ã€‚é€šè¿‡äº†å…³äºã€Šä¸­å›½å…±äº§å…šç« ç¨‹ä¿®æ­£æ¡ˆã€‹çš„å†³è®®ï¼›ä¸­å…±åå…­å±Šå››ä¸­å…¨ä¼šï¼Œæå‡ºçš„æˆ˜ç•¥ä»»åŠ¡æ˜¯æ„å»ºç¤¾ä¼šä¸»ä¹‰å’Œè°ç¤¾ä¼šï¼›ä¸­å…±åä¸ƒå¤§ï¼Œæ˜ç¡®æŒ‡å‡ºé«˜ä¸¾ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ä¼Ÿå¤§æ——å¸œæœ€æ ¹æœ¬çš„æ˜¯è¦åšæŒä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰é“è·¯ã€ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ç†è®ºä½“åˆ¶ï¼›ä¸­å…±åå…«å±Šä¸‰ä¸­å…¨ä¼šï¼Œå‘è¡¨ã€Šå…³äºå…¨é¢æ·±åŒ–æ”¹é©è‹¥å¹²é‡å¤§é—®é¢˜çš„å†³å®šã€‹ï¼Œæå‡ºäº†å…¨é¢æ·±åŒ–æ”¹é©çš„çŸ¥é“æ€æƒ³ã€é‡è¦æ–¹é’ˆã€ç›®æ ‡ä»»åŠ¡ã€æ”¿æ²»ä¸¾æªï¼Œæ˜ç¡®äº†å…¨é¢æ·±åŒ–æ”¹é©çš„æ€»ç›®æ ‡ã€æ—¶é—´è¡¨ã€è·¯çº¿å›¾ï¼Œæˆä¸ºçŸ¥é“æ–°å½¢åŠ¿ä¸‹å…¨é¢æ·±åŒ–æ”¹é©çš„çº²é¢†æ€§æ–‡ä»¶ï¼›ä¸­å…±åå…«å¤§,è¿›å…¥å…¨é¢å»ºæˆå°åº·ç¤¾ä¼šå†³å®šæ€§é˜¶æ®µå¬å¼€çš„ä¸€æ¬¡ååˆ†é‡è¦çš„å¤§ä¼šã€‚å®¡è®®å¹¶é€šè¿‡ã€Šä¸­å›½å…±äº§å…šç« ç¨‹ï¼ˆä¿®æ­£æ¡ˆï¼‰ã€‹ä¸­å…±åä¹å¤§,ä½œäº†é¢˜ä¸ºã€Šå†³èƒœå…¨é¢å»ºæˆå°åº·ç¤¾ä¼š å¤ºå–æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ä¼Ÿå¤§èƒœåˆ©ã€‹çš„æŠ¥å‘Šã€‚ä¸»é¢˜æ˜¯ï¼šä¸å¿˜åˆå¿ƒï¼Œç‰¢è®°ä½¿å‘½ï¼Œé«˜ä¸¾ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ä¼Ÿå¤§æ——å¸œï¼Œå†³èƒœå…¨é¢å»ºæˆå°åº·ç¤¾ä¼šï¼Œå¤ºå–æ–°æ—¶ä»£ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰ä¼Ÿå¤§èƒœåˆ©ï¼Œä¸ºå®ç°ä¸­åæ°‘æ—ä¼Ÿå¤§å¤å…´çš„ä¸­å›½æ¢¦ä¸æ‡ˆå¥‹æ–—ã€‚æ˜¯åœ¨å…¨é¢å»ºæˆå°åº·ç¤¾ä¼šå†³èƒœé˜¶æ®µã€ä¸­å›½ç‰¹è‰²ç¤¾ä¼šä¸»ä¹‰å‘å±•å…³é”®æ—¶æœŸå¬å¼€çš„ä¸€æ¬¡ååˆ†é‡è¦çš„å¤§ä¼šã€‚","link":"/2020/10/16/%E5%8E%86%E5%8F%B2%E7%9F%A5%E8%AF%86%E7%82%B9%EF%BC%88%E6%97%A7%EF%BC%89/"},{"title":"14 activityå¯åŠ¨æµç¨‹","text":"å¥½å§ï¼Œç»ˆäºè¦å¼€å§‹è®²è§£Activityçš„å¯åŠ¨æµç¨‹äº†ï¼ŒActivityçš„å¯åŠ¨æµç¨‹ç›¸å¯¹å¤æ‚ä¸€ä¸‹ï¼Œæ¶‰åŠåˆ°äº†Activityä¸­çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæ¶‰åŠåˆ°äº†Androidä½“ç³»çš„CSæ¨¡å¼ï¼Œæ¶‰åŠåˆ°äº†Androidä¸­è¿›ç¨‹é€šè®¯Binderæœºåˆ¶ç­‰ç­‰ï¼Œ é¦–å…ˆä»‹ç»ä¸€ä¸‹Activityï¼Œè¿™é‡Œå¼•ç”¨ä¸€ä¸‹Android guideä¸­å¯¹Activityçš„ä»‹ç»ï¼š An activity represents a single screen with a user interface. For example, an email application might have one activity that shows a list of new emails, another activity to compose an email, and another activity for reading emails. Although the activities work together to form a cohesive user experience in the email application, each one is independent of the others. As such, a different application can start any one of these activities (if the email application allows it). For example, a camera application can start the activity in the email application that composes new mail, in order for the user to share a picture. è‹±æ–‡ä¸å¤ªå¥½ï¼Œè¿™é‡Œå°±ä¸çŒ®ä¸‘äº†ï¼Œè¿™é‡Œä»‹ç»çš„Activityçš„å¤§æ¦‚æ„æ€å°±æ˜¯è¯´ï¼Œactivityåœ¨Androidç³»ç»Ÿä¸­ä»£è¡¨çš„å°±æ˜¯ä¸€ä¸ªå±å¹•ï¼Œä¸€ä¸ªAppå°±æ˜¯ç”±è®¸å¤šä¸ªä¸åŒçš„Acitivtyç»„æˆçš„ï¼Œå¹¶ä¸”ä¸åŒè¿›ç¨‹ä¹‹é—´çš„Activityæ˜¯å¯ä»¥ç›¸äº’è°ƒç”¨çš„ã€‚ åœ¨ä»‹ç»Activityçš„å¯åŠ¨æµç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»‹ç»å‡ ä¸ªæ¦‚å¿µï¼š Activityçš„ç”Ÿå‘½å‘¨æœŸ protected void onCreate(Bundle savedInstanceState);protected void onRestart();protected void onStart();protected void onResume();protected void onPause();protected void onStop();protected void onDestory();ä»¥ä¸Šä¸ºActivityç”Ÿå‘½å‘¨æœŸä¸­çš„å„ä¸ªæ—¶æœŸçš„å›è°ƒæ–¹æ³•ï¼Œåœ¨ä¸åŒçš„æ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸åŒçš„é€»è¾‘ã€‚å…³äºActivityç”Ÿå‘½å‘¨æœŸçš„è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒï¼š Android activityçš„ç”Ÿå‘½å‘¨æœŸ Activityçš„å¯åŠ¨æ¨¡å¼ activityå¯åŠ¨æ—¶å¯ä»¥è®¾ç½®ä¸åŒçš„å¯åŠ¨æ¨¡å¼ï¼Œä¸»è¦æ˜¯ï¼šstandrandï¼ŒsingleTopï¼ŒsingleTaskï¼Œinstanceç­‰å››ç§å¯åŠ¨æ¨¡å¼ï¼Œä¸åŒçš„å¯åŠ¨æ¨¡å¼åœ¨å¯åŠ¨Activityæ—¶ä¼šæ‰§è¡Œä¸åŒçš„é€»è¾‘ï¼Œç³»ç»Ÿä¼šæŒ‰ä¸åŒçš„å¯åŠ¨æ¨¡å¼å°†Activityå­˜æ”¾åˆ°ä¸åŒçš„activityæ ˆä¸­ã€‚å…³äºActivityå¯åŠ¨æ¨¡å¼çš„è¯¦ç»†ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒï¼š Androidä»»åŠ¡å’Œè¿”å›æ ˆå®Œå…¨è§£æ Activityçš„å¯åŠ¨è¿›ç¨‹ åœ¨Manifest.xmlä¸­å®šä¹‰Activityçš„æ—¶å€™ï¼ŒActivityé»˜è®¤æ˜¯å±äºè¿›ç¨‹åç§°ä¸ºåŒ…åçš„è¿›ç¨‹çš„ï¼Œå½“ç„¶è¿™æ—¶å€™æ˜¯å¯ä»¥æŒ‡å®šActivityçš„å¯åŠ¨è¿›ç¨‹ï¼Œæ‰€ä»¥åœ¨Activityå¯åŠ¨æ—¶é¦–å…ˆä¼šæ£€æµ‹å½“å‰Activityæ‰€å±çš„è¿›ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œè‹¥è¿›ç¨‹æ²¡æœ‰å¯åŠ¨ï¼Œåˆ™é¦–å…ˆä¼šå¯åŠ¨è¯¥è¿›ç¨‹ï¼Œå¹¶åœ¨è¯¥è¿›ç¨‹å¯åŠ¨ä¹‹åæ‰ä¼šæ‰§è¡ŒActivityçš„å¯åŠ¨è¿‡ç¨‹ã€‚ Intentå¯åŠ¨Activityçš„æ–¹å¼ Intentå¯åŠ¨Activityåˆ†ä¸ºä¸¤ç§ï¼Œæ˜¾ç¤ºå¯åŠ¨å’Œéšå£«å¯åŠ¨ï¼Œæ˜¾ç¤ºå¯åŠ¨å°±æ˜¯åœ¨åˆå§‹åŒ–Intentå¯¹è±¡çš„æ—¶å€™ç›´æ¥å¼•ç”¨éœ€è¦å¯åŠ¨çš„Activityçš„å­—èŠ‚ç ï¼Œæ˜¾ç¤ºå¼•ç”¨çš„å¥½å¤„å°±æ˜¯å¯ä»¥ç›´æ¥å‘Šè¯‰Intentå¯¹è±¡å¯åŠ¨çš„Activityå¯¹è±¡ä¸éœ€è¦æ‰§è¡Œintent filterç´¢å¼•éœ€è¦å¯åŠ¨å“ªä¸€ä¸ªActivityï¼Œä½†æ˜¯æ˜¾ç¤ºå¼•ç”¨ä¸èƒ½å¯åŠ¨å…¶ä»–è¿›ç¨‹çš„Activityå¯¹è±¡ï¼Œå› ä¸ºæ— æ³•è·å–å…¶ä»–è¿›ç¨‹çš„Activityå¯¹è±¡çš„å­—èŠ‚ç ï¼Œè€Œéšå¼å¯åŠ¨åˆ™å¯ä»¥é€šè¿‡é…ç½®Intent Filterå¯åŠ¨å…¶ä»–è¿›ç¨‹çš„Activityå¯¹è±¡ï¼Œå› æ­¤åœ¨åº”ç”¨å†…ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨æ˜¾ç¤ºå¯åŠ¨çš„æ–¹å¼å¯åŠ¨Activityï¼Œè€Œå¦‚æœéœ€è¦å¯åŠ¨å…¶ä»–åº”ç”¨çš„Activityæ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨éšå¼å¯åŠ¨çš„æ–¹å¼ã€‚ Android Frameworkå±‚çš„CSæ¨¡å¼é€šè¿‡å‰å‡ ç¯‡æ–‡ç« çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“androidç³»ç»Ÿåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ä¼šæ‰§è¡Œè¿™æ ·çš„é€»è¾‘ï¼š Zygoteè¿›ç¨‹ --&gt; SystemServerè¿›ç¨‹ --&gt; å„ç§ç³»ç»ŸæœåŠ¡ --&gt; åº”ç”¨è¿›ç¨‹ åœ¨Actvityå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå…¶å®æ˜¯åº”ç”¨è¿›ç¨‹ä¸SystemServerè¿›ç¨‹ç›¸äº’é…åˆå¯åŠ¨Activityçš„è¿‡ç¨‹ï¼Œå…¶ä¸­åº”ç”¨è¿›ç¨‹ä¸»è¦ç”¨äºæ‰§è¡Œå…·ä½“çš„Activityçš„å¯åŠ¨è¿‡ç¨‹ï¼Œå›è°ƒç”Ÿå‘½å‘¨æœŸæ–¹æ³•ç­‰æ“ä½œï¼Œè€ŒSystemServerè¿›ç¨‹åˆ™ä¸»è¦æ˜¯è°ƒç”¨å…¶ä¸­çš„å„ç§æœåŠ¡ï¼Œå°†Activityä¿å­˜åœ¨æ ˆä¸­ï¼Œåè°ƒå„ç§ç³»ç»Ÿèµ„æºç­‰æ“ä½œã€‚ Androidç³»ç»Ÿè¿›ç¨‹é—´é€šè®¯Binderæœºåˆ¶Androidç³»ç»Ÿå­˜äº†Zygoteè¿›ç¨‹å’ŒSystemServerè¿›ç¨‹ä»¥åŠå„ç§åº”ç”¨è¿›ç¨‹ç­‰ï¼Œä¸ºäº†èƒ½å¤Ÿå®ç°å„ç§è¿›ç¨‹ä¹‹é—´çš„é€šè®¯ï¼ŒAndroidç³»ç»Ÿé‡‡ç”¨äº†è‡ªå·±çš„è¿›ç¨‹é—´é€šè®¯æ–¹å¼Binderæœºåˆ¶ã€‚å…¶ä¸­ä¸»è¦æ¶‰åŠåˆ°äº†å››ç§è§’è‰²ï¼šBinder Clientï¼ŒBinder Serverï¼ŒBinder Managerï¼Œ Binder driverã€‚å„ç§è§’è‰²ä¹‹é—´çš„å…³ç³»å¯ä»¥å‚è€ƒä¸‹é¢è¿™å¼ å›¾çš„ä»‹ç»ï¼š å¥½å§ï¼Œå‰é¢æˆ‘ä»¬ä»‹ç»äº†ä¸€äº›Activityå¯åŠ¨è¿‡ç¨‹ä¸­éœ€è¦çš„ç›¸å…³çŸ¥è¯†ç‚¹ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹Activityå¯åŠ¨æµç¨‹çš„è®²è§£ã€‚ã€‚ã€‚ã€‚ è¿˜è®°å¾—å‰é¢æˆ‘ä»¬è®²è¿‡çš„Launcherå¯åŠ¨æµç¨‹ä¹ˆï¼Ÿå¯ä»¥å‚è€ƒï¼šandroidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹åœ¨è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è¯´Launcherå¯åŠ¨ä¹‹åä¼šå°†å„ä¸ªåº”ç”¨åŒ…åå’Œiconä¸app nameä¿å­˜èµ·æ¥ï¼Œç„¶åæ‰§è¡Œiconçš„ç‚¹å‡»äº‹ä»¶çš„æ—¶å€™è°ƒç”¨startActivityæ–¹æ³•ï¼š 123456789101112131415161718192021222324@Override protected void onListItemClick(ListView l, View v, int position, long id) { Intent intent = intentForPosition(position); startActivity(intent); }protected Intent intentForPosition(int position) { ActivityAdapter adapter = (ActivityAdapter) mAdapter; return adapter.intentForPosition(position); }public Intent intentForPosition(int position) { if (mActivitiesList == null) { return null; } Intent intent = new Intent(mIntent); ListItem item = mActivitiesList.get(position); intent.setClassName(item.packageName, item.className); if (item.extras != null) { intent.putExtras(item.extras); } return intent; } å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨Activityçš„æ—¶å€™ï¼Œæ‰§è¡Œçš„é€»è¾‘å°±æ˜¯åˆ›å»ºä¸€ä¸ªIntentå¯¹è±¡ï¼Œç„¶ååˆå§‹åŒ–Intentå¯¹è±¡ï¼Œä½¿ç”¨éšå¼å¯åŠ¨çš„æ–¹å¼å¯åŠ¨è¯¥Acvitityï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸èƒ½ä½¿ç”¨æ˜¾ç¤ºå¯åŠ¨çš„æ–¹å¼å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸ºLauncherç¨‹åºå¯åŠ¨çš„Activityä¸€èˆ¬éƒ½æ˜¯å¯åŠ¨ä¸€ä¸ªæ–°çš„åº”ç”¨è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹ä¸Launcherè¿›ç¨‹ä¸æ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­ï¼Œæ‰€ä»¥ä¹Ÿå°±æ— æ³•å¼•ç”¨åˆ°å¯åŠ¨çš„Activityå­—èŠ‚ç ï¼Œè‡ªç„¶ä¹Ÿå°±æ— æ³•å¯åŠ¨è¯¥Activityäº†ã€‚ ç»§ç»­ï¼Œæˆ‘ä»¬æŸ¥çœ‹startActivityæ–¹æ³•çš„å…·ä½“å®ç°ï¼š ä¸€:å¼€å§‹è¯·æ±‚æ‰§è¡Œå¯åŠ¨Activity MyActivity.startActivity()Activity.startActivity()Activity.startActivityForResultInstrumentation.execStartActivtyActivityManagerNative.getDefault().startActivityAsUser() åœ¨æˆ‘ä»¬çš„Activityä¸­è°ƒç”¨startActivityæ–¹æ³•ï¼Œä¼šæ‰§è¡ŒActivityä¸­çš„startActivity1234@Override public void startActivity(Intent intent) { this.startActivity(intent, null); }ç„¶ååœ¨Activityä¸­çš„startActivityæ–¹æ³•ä½“é‡Œè°ƒç”¨äº†startActivityçš„é‡è½½æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶é‡è½½æ–¹æ³•çš„å®ç°ï¼š 12345678910@Override public void startActivity(Intent intent, @Nullable Bundle options) { if (options != null) { startActivityForResult(intent, -1, options); } else { // Note we want to go through this call for compatibility with // applications that may have overridden the method. startActivityForResult(intent, -1); } } ç”±äºåœ¨ä¸Šä¸€æ­¥éª¤ä¸­æˆ‘ä»¬ä¼ é€’çš„Bundeå¯¹è±¡ä¸ºç©ºï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ‰§è¡Œçš„æ˜¯elseåˆ†æ”¯çš„é€»è¾‘ï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨äº†startActivityForResultæ–¹æ³•ï¼Œå¹¶ä¸”ä¼ é€’çš„å‚æ•°ä¸ºintentå’Œ-1. æ³¨æ„ï¼šé€šè¿‡è¿™é‡Œçš„ä»£ç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå…¶å®æˆ‘ä»¬åœ¨Activityä¸­è°ƒç”¨startActivityçš„å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨çš„startActivityForResultçš„ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè°ƒç”¨startActivityForResultå¯ä»¥åœ¨Activityä¸­å›è°ƒonActivityResultè€Œè°ƒç”¨startActivityåˆ™ä¸å¯ä»¥å‘¢ï¼Ÿå¯ä»¥å‘ç°å…¶ä¸»è¦çš„åŒºåˆ«æ˜¯è°ƒç”¨startActivityå†…éƒ¨è°ƒç”¨startActivityForResultä¼ é€’çš„ä¼ è¾“requestCodeå€¼ä¸º-1ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨Activityè°ƒç”¨startActivityForResultçš„æ—¶å€™ä¼ é€’çš„requestCodeå€¼ä¸º-1çš„è¯ï¼Œé‚£ä¹ˆonActivityResultæ˜¯ä¸èµ·ä½œç”¨çš„ã€‚å®é™…ä¸Šï¼Œç»æµ‹è¯•requestCodeçš„å€¼å°äº0çš„æ—¶å€™éƒ½æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬è°ƒç”¨startActivityForResultçš„æ—¶å€™éœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ã€‚ å¥½å§ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ï¼ŒstartActivityForResultæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334public void startActivityForResult(Intent intent, int requestCode, @Nullable Bundle options) { if (mParent == null) { Instrumentation.ActivityResult ar = mInstrumentation.execStartActivity( this, mMainThread.getApplicationThread(), mToken, this, intent, requestCode, options); if (ar != null) { mMainThread.sendActivityResult( mToken, mEmbeddedID, requestCode, ar.getResultCode(), ar.getResultData()); } if (requestCode &gt;= 0) { // If this start is requesting a result, we can avoid making // the activity visible until the result is received. Setting // this code during onCreate(Bundle savedInstanceState) or onResume() will keep the // activity hidden during this time, to avoid flickering. // This can only be done when a result is requested because // that guarantees we will get information back when the // activity is finished, no matter what happens to it. mStartedActivity = true; } cancelInputsAndStartExitTransition(options); // TODO Consider clearing/flushing other event sources and events for child windows. } else { if (options != null) { mParent.startActivityFromChild(this, intent, requestCode, options); } else { // Note we want to go through this method for compatibility with // existing applications that may have overridden it. mParent.startActivityFromChild(this, intent, requestCode); } } } å¯ä»¥å‘ç°ç”±äºæˆ‘ä»¬æ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨Activityï¼Œæ‰€ä»¥è¿™é‡Œçš„mParentä¸ºç©ºï¼Œæ‰€ä»¥ä¼šæ‰§è¡Œifåˆ†ä¹‹ï¼Œç„¶åè°ƒç”¨mInstrumentation.execStartActivityæ–¹æ³•ï¼Œå¹¶ä¸”è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªåˆ¤æ–­é€»è¾‘ï¼š 123if (requestCode &gt;= 0) { mStartedActivity = true;} é€šè¿‡æ³¨é‡Šä¹ŸéªŒè¯äº†æˆ‘ä»¬åˆšåˆšçš„è¯´æ³•å³ï¼Œè°ƒç”¨startActivityForResultçš„æ—¶å€™åªæœ‰requestCodeçš„å€¼å¤§äºç­‰äº0ï¼ŒonActivityResultæ‰ä¼šè¢«å›è°ƒã€‚ ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹mInstrumentation.execStartActivityæ–¹æ³•çš„å®ç°ã€‚åœ¨æŸ¥çœ‹execStartActivityæ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¯¹mInstrumentationå¯¹è±¡æœ‰ä¸€ä¸ªäº†è§£ï¼Ÿä»€ä¹ˆæ˜¯Instrumentationï¼ŸInstrumentationæ˜¯androidç³»ç»Ÿä¸­å¯åŠ¨Activityçš„ä¸€ä¸ªå®é™…æ“ä½œç±»ï¼Œä¹Ÿå°±æ˜¯è¯´Activityåœ¨åº”ç”¨è¿›ç¨‹ç«¯çš„å¯åŠ¨å®é™…ä¸Šå°±æ˜¯Instrumentationæ‰§è¡Œçš„ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¯´æ˜¯åœ¨åº”ç”¨è¿›ç¨‹ç«¯çš„å¯åŠ¨å‘¢ï¼Ÿå®é™…ä¸Šacitivtyçš„å¯åŠ¨åˆ†ä¸ºåº”ç”¨è¿›ç¨‹ç«¯çš„å¯åŠ¨å’ŒSystemServeræœåŠ¡è¿›ç¨‹ç«¯çš„å¯åŠ¨çš„ï¼Œå¤šä¸ªåº”ç”¨è¿›ç¨‹ç›¸äº’é…åˆæœ€ç»ˆå®Œæˆäº†Activityåœ¨ç³»ç»Ÿä¸­çš„å¯åŠ¨çš„ï¼Œè€Œåœ¨åº”ç”¨è¿›ç¨‹ç«¯çš„å¯åŠ¨å®é™…çš„æ“ä½œç±»å°±æ˜¯Intrumentationæ¥æ‰§è¡Œçš„ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ç‚¹ç»•å£ï¼Œæ²¡å…³ç³»ï¼Œéšç€æˆ‘ä»¬æ…¢æ…¢çš„è§£æå¤§å®¶å°±ä¼šå¯¹Instrumentationçš„è®¤è¯†é€æ¸åŠ æ·±çš„ã€‚ å¯ä»¥å‘ç°execStartActivityæ–¹æ³•ä¼ é€’çš„å‡ ä¸ªå‚æ•°ï¼šthisï¼Œä¸ºå¯åŠ¨Activityçš„å¯¹è±¡ï¼›contextThreadï¼Œä¸ºBinderå¯¹è±¡ï¼Œæ˜¯ä¸»è¿›ç¨‹çš„contextå¯¹è±¡ï¼›tokenï¼Œä¹Ÿæ˜¯ä¸€ä¸ªBinderå¯¹è±¡ï¼ŒæŒ‡å‘äº†æœåŠ¡ç«¯ä¸€ä¸ªActivityRecordå¯¹è±¡ï¼›targetï¼Œä¸ºå¯åŠ¨çš„Activityï¼›intentï¼Œå¯åŠ¨çš„Intentå¯¹è±¡ï¼›requestCodeï¼Œè¯·æ±‚ç ï¼›optionsï¼Œå‚æ•°ï¼› è¿™æ ·å°±è°ƒç”¨äº†Imstrument.execStartActivityæ–¹æ³•äº†ï¼š 123456789101112131415161718public ActivityResult execStartActivity( Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, int requestCode, Bundle options) { ... try { intent.migrateExtraStreamToClipData(); intent.prepareToLeaveProcess(); int result = ActivityManagerNative.getDefault() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); checkStartActivityResult(result, intent); } catch (RemoteException e) { throw new RuntimeException(&quot;Failure from system&quot;, e); } return null; } æˆ‘ä»¬å‘ç°åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ä¸»è¦è°ƒç”¨ActivityManagerNative.getDefault().startActivityæ–¹æ³•ï¼Œé‚£ä¹ˆActivityManagerNativeåˆæ˜¯ä¸ªä»€ä¹ˆé¬¼å‘¢ï¼ŸæŸ¥çœ‹ä¸€ä¸‹getDefault()å¯¹è±¡çš„å®ç°ï¼š 123static public IActivityManager getDefault() { return gDefault.get(); } å¥½å§ï¼Œç›¸å½“ä¹‹ç®€å•ç›´æ¥è¿”å›çš„æ˜¯gDefault.get()ï¼Œé‚£ä¹ˆgDefaultåˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ 12345678910111213private static final Singleton&lt;IActivityManager&gt; gDefault = new Singleton&lt;IActivityManager&gt;() { protected IActivityManager create() { IBinder b = ServiceManager.getService(&quot;activity&quot;); if (false) { Log.v(&quot;ActivityManager&quot;, &quot;default service binder = &quot; + b); } IActivityManager am = asInterface(b); if (false) { Log.v(&quot;ActivityManager&quot;, &quot;default service = &quot; + am); } return am; } }; å¯ä»¥å‘ç°å¯åŠ¨è¿‡asInterface()æ–¹æ³•åˆ›å»ºï¼Œç„¶åæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹asInterfaceæ–¹æ³•çš„å®ç°ï¼š 123456789101112static public IActivityManager asInterface(IBinder obj) { if (obj == null) { return null; } IActivityManager in = (IActivityManager)obj.queryLocalInterface(descriptor); if (in != null) { return in; } return new ActivityManagerProxy(obj); } å¥½å§ï¼Œæœ€åç›´æ¥è¿”å›ä¸€ä¸ªActivityManagerProxyå¯¹è±¡ï¼Œè€ŒActivityManagerProxyç»§æ‰¿ä¸IActivityManagerï¼Œåˆ°äº†è¿™é‡Œå°±å¼•å‡ºäº†æˆ‘ä»¬androidç³»ç»Ÿä¸­å¾ˆé‡è¦çš„ä¸€ä¸ªæ¦‚å¿µï¼šBinderæœºåˆ¶ã€‚æˆ‘ä»¬çŸ¥é“åº”ç”¨è¿›ç¨‹ä¸SystemServerè¿›ç¨‹å±äºä¸¤ä¸ªä¸åŒçš„è¿›ç¨‹ï¼Œè¿›ç¨‹ä¹‹é—´éœ€è¦é€šè®¯ï¼Œandroidç³»ç»Ÿé‡‡å–äº†è‡ªèº«è®¾è®¡çš„Binderæœºåˆ¶ï¼Œè¿™é‡Œçš„ActivityManagerProxyå’ŒActivityManagerNativeéƒ½æ˜¯ç»§æ‰¿ä¸IActivityManagerçš„è€ŒSystemServerè¿›ç¨‹ä¸­çš„ActivityManagerServiceå¯¹è±¡åˆ™ç»§æ‰¿ä¸ActivityManagerNativeã€‚ç®€å•çš„è¡¨ç¤ºï¼šBinderæ¥å£ â€“&gt; ActivityManagerNative/ActivityManagerProxy â€“&gt; ActivityManagerServiceï¼› è¿™æ ·ï¼ŒActivityManagerNativeä¸ActivityManagerProxyç›¸å½“äºä¸€ä¸ªBinderçš„å®¢æˆ·ç«¯è€ŒActivityManagerServiceç›¸å½“äºBinderçš„æœåŠ¡ç«¯ï¼Œè¿™æ ·å½“ActivityManagerNativeè°ƒç”¨æ¥å£æ–¹æ³•çš„æ—¶å€™åº•å±‚é€šè¿‡Binder driverå°±ä¼šå°†è¯·æ±‚æ•°æ®ä¸è¯·æ±‚ä¼ é€’ç»™serverç«¯ï¼Œå¹¶åœ¨serverç«¯æ‰§è¡Œå…·ä½“çš„æ¥å£é€»è¾‘ã€‚éœ€è¦æ³¨æ„çš„æ˜¯Binderæœºåˆ¶æ˜¯å•å‘çš„ï¼Œæ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½é€šè¿‡clientç«¯å‘serverç«¯ä¼ é€’æ•°æ®ä¸è¯·æ±‚è€Œä¸åŒç­‰å¾…æœåŠ¡ç«¯çš„è¿”å›ï¼Œä¹Ÿæ— æ³•è¿”å›ï¼Œé‚£å¦‚æœSystemServerè¿›ç¨‹æƒ³å‘åº”ç”¨è¿›ç¨‹ä¼ é€’æ•°æ®æ€ä¹ˆåŠï¼Ÿè¿™æ—¶å€™å°±éœ€è¦é‡æ–°å®šä¹‰ä¸€ä¸ªBinderè¯·æ±‚ä»¥SystemServerä¸ºclientç«¯ï¼Œä»¥åº”ç”¨è¿›ç¨‹ä¸ºserverç«¯ï¼Œè¿™æ ·å°±æ˜¯å®ç°äº†ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„åŒå‘é€šè®¯ã€‚ å¥½äº†ï¼Œè¯´äº†è¿™ä¹ˆå¤šæˆ‘ä»¬çŸ¥é“è¿™é‡Œçš„ActivityManagerNativeæ˜¯ActivityManagerServiceåœ¨åº”ç”¨è¿›ç¨‹çš„ä¸€ä¸ªclientå°±å¥½äº†ï¼Œé€šè¿‡å®ƒå°±å¯ä»¥æ»´å•Šç”¨ActivityManagerServiceçš„æ–¹æ³•äº†ã€‚ ç»§ç»­å¾€ä¸‹å¡ï¼Œæˆ‘ä»¬è°ƒç”¨çš„æ˜¯ï¼š 12345int result = ActivityManagerNative.getDefault() .startActivity(whoThread, who.getBasePackageName(), intent, intent.resolveTypeIfNeeded(who.getContentResolver()), token, target != null ? target.mEmbeddedID : null, requestCode, 0, null, options); è¿™é‡Œé€šè¿‡æˆ‘ä»¬åˆšåˆšçš„åˆ†æï¼ŒActivityManagerNative.getDefault()æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ªActivityManagerProxyå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityManagerProxyå¯¹è±¡çš„startActivityæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233public int startActivity(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle options) throws RemoteException { Parcel data = Parcel.obtain(); Parcel reply = Parcel.obtain(); data.writeInterfaceToken(IActivityManager.descriptor); data.writeStrongBinder(caller != null ? caller.asBinder() : null); data.writeString(callingPackage); intent.writeToParcel(data, 0); data.writeString(resolvedType); data.writeStrongBinder(resultTo); data.writeString(resultWho); data.writeInt(requestCode); data.writeInt(startFlags); if (profilerInfo != null) { data.writeInt(1); profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE); } else { data.writeInt(0); } if (options != null) { data.writeInt(1); options.writeToParcel(data, 0); } else { data.writeInt(0); } mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, 0); reply.readException(); int result = reply.readInt(); reply.recycle(); data.recycle(); return result; } è¿™é‡Œå°±æ¶‰åŠåˆ°äº†å…·ä½“çš„Binderæ•°æ®ä¼ è¾“æœºåˆ¶äº†ï¼Œæˆ‘ä»¬ä¸åšè¿‡å¤šçš„åˆ†æï¼ŒçŸ¥é“é€šè¿‡æ•°æ®ä¼ è¾“ä¹‹åå°±ä¼šè°ƒç”¨SystemServerè¿›ç¨‹çš„ActivityManagerServiceçš„startActivityå°±å¥½äº†ã€‚ ä»¥ä¸Šå…¶å®éƒ½æ˜¯å‘ç”Ÿåœ¨åº”ç”¨è¿›ç¨‹ä¸­ï¼Œä¸‹é¢å¼€å§‹è°ƒç”¨çš„ActivityManagerServiceçš„æ‰§è¡Œæ—¶å‘ç”Ÿåœ¨SystemServerè¿›ç¨‹ã€‚ äºŒï¼šActivityManagerServiceæ¥æ”¶å¯åŠ¨Activityçš„è¯·æ±‚ ActivityManagerService.startActivity()ActvityiManagerService.startActivityAsUser()ActivityStackSupervisor.startActivityMayWait()ActivityStackSupervisor.startActivityLocked()ActivityStackSupervisor.startActivityUncheckedLocked()ActivityStackSupervisor.startActivityLocked()ActivityStackSupervisor.resumeTopActivitiesLocked()ActivityStackSupervisor.resumeTopActivityInnerLocked() å¥½å§ï¼Œä»£ç é‡æ¯”è¾ƒå¤§ï¼Œæ…¢æ…¢çœ‹ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹ActivityManagerService.startActivityçš„å…·ä½“å®ç°ï¼› 12345678@Override public final int startActivity(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle options) { return startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo, resultWho, requestCode, startFlags, profilerInfo, options, UserHandle.getCallingUserId()); } å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æ–¹æ³•å¹¶æ²¡æœ‰å®ç°ä»€ä¹ˆé€»è¾‘ï¼Œç›´æ¥è°ƒç”¨äº†startActivityAsUseræ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹startActivityAsUseræ–¹æ³•çš„å®ç°ï¼š 123456789101112@Override public final int startActivityAsUser(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, Bundle options, int userId) { enforceNotIsolatedCaller(&quot;startActivity&quot;); userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId, false, ALLOW_FULL_ONLY, &quot;startActivity&quot;, null); // TODO: Switch to user app stacks here. return mStackSupervisor.startActivityMayWait(caller, -1, callingPackage, intent, resolvedType, null, null, resultTo, resultWho, requestCode, startFlags, profilerInfo, null, null, options, false, userId, null, null); } å¯ä»¥çœ‹åˆ°è¿™é‡Œåªæ˜¯è¿›è¡Œäº†ä¸€äº›å…³äºuseridçš„é€»è¾‘åˆ¤æ–­ï¼Œç„¶åå°±è°ƒç”¨mStackSupervisor.startActivityMayWaitæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 1234567891011121314151617final int startActivityMayWait(IApplicationThread caller, int callingUid, String callingPackage, Intent intent, String resolvedType, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, int requestCode, int startFlags, ProfilerInfo profilerInfo, WaitResult outResult, Configuration config, Bundle options, boolean ignoreTargetSecurity, int userId, IActivityContainer iContainer, TaskRecord inTask) { ... int res = startActivityLocked(caller, intent, resolvedType, aInfo, voiceSession, voiceInteractor, resultTo, resultWho, requestCode, callingPid, callingUid, callingPackage, realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity, componentSpecified, null, container, inTask); ... return res; } è¿™ä¸ªæ–¹æ³•ä¸­æ‰§è¡Œäº†å¯åŠ¨Activityçš„ä¸€äº›å…¶ä»–é€»è¾‘åˆ¤æ–­ï¼Œåœ¨ç»è¿‡åˆ¤æ–­é€»è¾‘ä¹‹åè°ƒç”¨startActivityLockedæ–¹æ³•ï¼š 1234567891011121314151617final int startActivityLocked(IApplicationThread caller, Intent intent, String resolvedType, ActivityInfo aInfo, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, int requestCode, int callingPid, int callingUid, String callingPackage, int realCallingPid, int realCallingUid, int startFlags, Bundle options, boolean ignoreTargetSecurity, boolean componentSpecified, ActivityRecord[] outActivity, ActivityContainer container, TaskRecord inTask) { int err = ActivityManager.START_SUCCESS; ... err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor, startFlags, true, options, inTask); ... return err; } è¿™ä¸ªæ–¹æ³•ä¸­ä¸»è¦æ„é€ äº†ActivityManagerServiceç«¯çš„Activityå¯¹è±¡â€“&gt;ActivityRecordï¼Œå¹¶æ ¹æ®Activityçš„å¯åŠ¨æ¨¡å¼æ‰§è¡Œäº†ç›¸å…³é€»è¾‘ã€‚ç„¶åè°ƒç”¨äº†startActivityUncheckedLockedæ–¹æ³•ï¼š 12345678910111213final int startActivityUncheckedLocked(final ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, int startFlags, boolean doResume, Bundle options, TaskRecord inTask) { ... ActivityStack.logStartActivity(EventLogTags.AM_CREATE_ACTIVITY, r, r.task); targetStack.mLastPausedActivity = null; targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options); if (!launchTaskBehind) { // Don't set focus on an activity that's going to the back. mService.setFocusedActivityLocked(r, &quot;startedActivity&quot;); } return ActivityManager.START_SUCCESS; } startActivityUncheckedLockedæ–¹æ³•ä¸­åªè¦æ‰§è¡Œäº†ä¸åŒå¯åŠ¨æ¨¡å¼ä¸åŒæ ˆçš„å¤„ç†ï¼Œå¹¶æœ€åè°ƒç”¨äº†startActivityLockedçš„é‡è½½æ–¹æ³•ï¼š 1234567final void startActivityLocked(ActivityRecord r, boolean newTask, boolean doResume, boolean keepCurTransition, Bundle options) { ... if (doResume) { mStackSupervisor.resumeTopActivitiesLocked(this, r, options); } } è¿™ä¸ªstartActivityLockedæ–¹æ³•ä¸»è¦æ‰§è¡Œåˆå§‹åŒ–äº†windowManageræœåŠ¡ï¼Œç„¶åè°ƒç”¨resumeTopActivitiesLockedæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526boolean resumeTopActivitiesLocked(ActivityStack targetStack, ActivityRecord target, Bundle targetOptions) { if (targetStack == null) { targetStack = mFocusedStack; } // Do targetStack first. boolean result = false; if (isFrontStack(targetStack)) { result = targetStack.resumeTopActivityLocked(target, targetOptions); } for (int displayNdx = mActivityDisplays.size() - 1; displayNdx &gt;= 0; --displayNdx) { final ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks; for (int stackNdx = stacks.size() - 1; stackNdx &gt;= 0; --stackNdx) { final ActivityStack stack = stacks.get(stackNdx); if (stack == targetStack) { // Already started above. continue; } if (isFrontStack(stack)) { stack.resumeTopActivityLocked(null); } } } return result; } å¯ä»¥å‘ç°ç»è¿‡å¾ªç¯é€»è¾‘åˆ¤æ–­ä¹‹åï¼Œæœ€ç»ˆè°ƒç”¨äº†resumeTopActivityLockedæ–¹æ³•ï¼š 123final boolean resumeTopActivityLocked(ActivityRecord prev) { return resumeTopActivityLocked(prev, null); } ç„¶åè°ƒç”¨ï¼š 1234567891011121314151617181920final boolean resumeTopActivityLocked(ActivityRecord prev, Bundle options) { if (mStackSupervisor.inResumeTopActivity) { // Don't even start recursing. return false; } boolean result = false; try { // Protect against recursion. mStackSupervisor.inResumeTopActivity = true; if (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) { mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN; mService.updateSleepIfNeededLocked(); } result = resumeTopActivityInnerLocked(prev, options); } finally { mStackSupervisor.inResumeTopActivity = false; } return result; } ç»§ç»­è°ƒç”¨resumeTopActivityInnerLockedæ–¹æ³•ï¼š 12345678910private boolean resumeTopActivityInnerLocked(ActivityRecord prev, Bundle options) { ... if (mResumedActivity != null) { if (DEBUG_STATES) Slog.d(TAG_STATES, &quot;resumeTopActivityLocked: Pausing &quot; + mResumedActivity); pausing |= startPausingLocked(userLeaving, false, true, dontWaitForPause); } ... return true; } ç»è¿‡ä¸€ç³»åˆ—å¤„ç†é€»è¾‘ä¹‹åæœ€ç»ˆè°ƒç”¨äº†startPausingLockedæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä½œç”¨å°±æ˜¯è®©ç³»ç»Ÿä¸­æ ˆä¸­çš„Activityæ‰§è¡ŒonPauseæ–¹æ³•ã€‚ ä¸‰ï¼šæ‰§è¡Œæ ˆé¡¶Activityçš„onPauseæ–¹æ³• ActivityStack.startPausingLocked()IApplicationThread.schudulePauseActivity()ActivityThread.sendMessage()ActivityThread.H.sendMessage();ActivityThread.H.handleMessage()ActivityThread.handlePauseActivity()ActivityThread.performPauseActivity()Activity.performPause()Activity.onPause()ActivityManagerNative.getDefault().activityPaused(token)ActivityManagerService.activityPaused()ActivityStack.activityPausedLocked()ActivityStack.completePauseLocked()ActivityStack.resumeTopActivitiesLocked()ActivityStack.resumeTopActivityLocked()ActivityStack.resumeTopActivityInnerLocked()ActivityStack.startSpecificActivityLocked å¥½å§ï¼Œæ–¹æ³•æ¯”è¾ƒå¤šä¹Ÿæ¯”è¾ƒä¹±ï¼Œé¦–å…ˆæ¥çœ‹startPausingLockedæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526final boolean startPausingLocked(boolean userLeaving, boolean uiSleeping, boolean resuming, boolean dontWait) { ... if (prev.app != null &amp;&amp; prev.app.thread != null) { if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, &quot;Enqueueing pending pause: &quot; + prev); try { EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY, prev.userId, System.identityHashCode(prev), prev.shortComponentName); mService.updateUsageStats(prev, false); prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing, userLeaving, prev.configChangeFlags, dontWait); } catch (Exception e) { // Ignore exception, if process died other code will cleanup. Slog.w(TAG, &quot;Exception thrown during pause&quot;, e); mPausingActivity = null; mLastPausedActivity = null; mLastNoHistoryActivity = null; } } else { mPausingActivity = null; mLastPausedActivity = null; mLastNoHistoryActivity = null; } ... } å¯ä»¥çœ‹åˆ°è¿™é‡Œæ‰§è¡Œäº†pre.app.thread.schedulePauseActivityæ–¹æ³•ï¼Œé€šè¿‡åˆ†æä¸éš¾å‘ç°è¿™é‡Œçš„threadæ˜¯ä¸€ä¸ªIApplicationThreadç±»å‹çš„å¯¹è±¡ï¼Œè€Œåœ¨ActivityThreadä¸­ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªApplicationThreadçš„ç±»ï¼Œå…¶ç»§æ‰¿äº†IApplicationThreadï¼Œå¹¶ä¸”éƒ½æ˜¯Binderå¯¹è±¡ï¼Œä¸éš¾çœ‹å‡ºè¿™é‡Œçš„IAppcationæ˜¯ä¸€ä¸ªBinderçš„clientç«¯è€ŒActivityThreadä¸­çš„ApplicationThreadæ˜¯ä¸€ä¸ªBinderå¯¹è±¡çš„serverç«¯ï¼Œæ‰€ä»¥é€šè¿‡è¿™é‡Œçš„thread.schedulePauseActivityå®é™…ä¸Šè°ƒç”¨çš„å°±æ˜¯ApplicationThreadçš„schedulePauseActivityæ–¹æ³•ã€‚ è¿™é‡Œçš„ApplicationThreadå¯ä»¥å’ŒActivityManagerNativeå¯¹äºä¸€ä¸‹ï¼šé€šè¿‡ActivityManagerNative â€“&gt; ActivityManagerServiceå®ç°äº†åº”ç”¨è¿›ç¨‹ä¸SystemServerè¿›ç¨‹çš„é€šè®¯é€šè¿‡AppicationThread &lt;â€“ IApplicationThreadå®ç°äº†SystemServerè¿›ç¨‹ä¸åº”ç”¨è¿›ç¨‹çš„é€šè®¯ ç„¶åæˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹ActivityThreadä¸­schedulePauseActivityçš„å…·ä½“å®ç°ï¼š 12345678public final void schedulePauseActivity(IBinder token, boolean finished, boolean userLeaving, int configChanges, boolean dontReport) { sendMessage( finished ? H.PAUSE_ACTIVITY_FINISHING : H.PAUSE_ACTIVITY, token, (userLeaving ? 1 : 0) | (dontReport ? 2 : 0), configChanges); } å‘é€äº†PAUSE_ACTIVITY_FINISHINGæ¶ˆæ¯ï¼Œç„¶åçœ‹ä¸€ä¸‹sendMessageçš„å®ç°æ–¹æ³•ï¼š 123private void sendMessage(int what, Object obj, int arg1, int arg2) { sendMessage(what, obj, arg1, arg2, false); } è°ƒç”¨äº†å…¶é‡è½½æ–¹æ³•ï¼š 1234567891011121314private void sendMessage(int what, Object obj, int arg1, int arg2, boolean async) { if (DEBUG_MESSAGES) Slog.v( TAG, &quot;SCHEDULE &quot; + what + &quot; &quot; + mH.codeToString(what) + &quot;: &quot; + arg1 + &quot; / &quot; + obj); Message msg = Message.obtain(); msg.what = what; msg.obj = obj; msg.arg1 = arg1; msg.arg2 = arg2; if (async) { msg.setAsynchronous(true); } mH.sendMessage(msg); } æœ€ç»ˆè°ƒç”¨äº†mHçš„sendMessageæ–¹æ³•ï¼ŒmHæ˜¯åœ¨ActivityThreadä¸­å®šä¹‰çš„ä¸€ä¸ªHandlerå¯¹è±¡ï¼Œä¸»è¦å¤„ç†SystemServerè¿›ç¨‹çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¶handleMessgeæ–¹æ³•çš„å®ç°ï¼š 123456789101112public void handleMessage(Message msg) { if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what)); switch (msg.what) { ... case PAUSE_ACTIVITY_FINISHING: Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;activityPause&quot;); handlePauseActivity((IBinder)msg.obj, true, (msg.arg1&amp;1) != 0, msg.arg2, (msg.arg1&amp;1) != 0); Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); break; ...} å¯ä»¥å‘ç°å…¶è°ƒç”¨äº†handlePauseActivityæ–¹æ³•ï¼š 123456789101112131415161718192021222324252627private void handlePauseActivity(IBinder token, boolean finished, boolean userLeaving, int configChanges, boolean dontReport) { ActivityClientRecord r = mActivities.get(token); if (r != null) { //Slog.v(TAG, &quot;userLeaving=&quot; + userLeaving + &quot; handling pause of &quot; + r); if (userLeaving) { performUserLeavingActivity(r); } r.activity.mConfigChangeFlags |= configChanges; performPauseActivity(token, finished, r.isPreHoneycomb()); // Make sure any pending writes are now committed. if (r.isPreHoneycomb()) { QueuedWork.waitToFinish(); } // Tell the activity manager we have paused. if (!dontReport) { try { ActivityManagerNative.getDefault().activityPaused(token); } catch (RemoteException ex) { } } mSomeActivitiesChanged = true; } } ç„¶ååœ¨æ–¹æ³•ä½“å†…éƒ¨é€šè¿‡è°ƒç”¨performPauseActivityæ–¹æ³•æ¥å®ç°å¯¹æ ˆé¡¶Activityçš„onPauseç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„å›è°ƒï¼Œå¯ä»¥å…·ä½“çœ‹ä¸€ä¸‹ä»–çš„å®ç°ï¼š 12345final Bundle performPauseActivity(IBinder token, boolean finished, boolean saveState) { ActivityClientRecord r = mActivities.get(token); return r != null ? performPauseActivity(r, finished, saveState) : null; } ç„¶åè°ƒç”¨å…¶é‡è½½æ–¹æ³•ï¼š 12345678final Bundle performPauseActivity(ActivityClientRecord r, boolean finished, boolean saveState) { ... mInstrumentation.callActivityOnPause(r.activity); ... return !r.activity.mFinished &amp;&amp; saveState ? r.state : null; } è¿™æ ·å›åˆ°äº†mInstrumentationçš„callActivityOnPuaseæ–¹æ³•ï¼š 123public void callActivityOnPause(Activity activity) { activity.performPause(); } å‘µå‘µï¼ŒåŸæ¥æœ€ç»ˆå›è°ƒåˆ°äº†Activityçš„performPauseæ–¹æ³•ï¼š 1234567891011121314final void performPause() { mDoReportFullyDrawn = false; mFragments.dispatchPause(); mCalled = false; onPause(); mResumed = false; if (!mCalled &amp;&amp; getApplicationInfo().targetSdkVersion &gt;= android.os.Build.VERSION_CODES.GINGERBREAD) { throw new SuperNotCalledException( &quot;Activity &quot; + mComponent.toShortString() + &quot; did not call through to super.onPause()&quot;); } mResumed = false; } ç»ˆäºï¼Œå¤ªä¸å®¹æ˜“äº†ï¼Œå›è°ƒåˆ°äº†Activityçš„onPauseæ–¹æ³•ï¼Œå“ˆå“ˆï¼ŒActivityç”Ÿå‘½å‘¨æœŸä¸­çš„ç¬¬ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ç»ˆäºè¢«æˆ‘ä»¬æ‰¾åˆ°äº†ã€‚ã€‚ã€‚ã€‚ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨å¯åŠ¨ä¸€ä¸ªActivityçš„æ—¶å€™æœ€å…ˆè¢«æ‰§è¡Œçš„æ˜¯æ ˆé¡¶çš„Activityçš„onPauseæ–¹æ³•ã€‚è®°ä½è¿™ç‚¹å§ï¼Œé¢è¯•çš„æ—¶å€™ç»å¸¸ä¼šé—®åˆ°ç±»ä¼¼çš„é—®é¢˜ã€‚ ç„¶åå›åˆ°æˆ‘ä»¬çš„handlePauseActivityæ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•çš„æœ€åé¢æ‰§è¡Œäº†ActivityManagerNative.getDefault().activityPaused(token);æ–¹æ³•ï¼Œè¿™æ˜¯åº”ç”¨è¿›ç¨‹å‘Šè¯‰æœåŠ¡è¿›ç¨‹ï¼Œæ ˆé¡¶Activityå·²ç»æ‰§è¡Œå®ŒæˆonPauseæ–¹æ³•äº†ï¼Œé€šè¿‡å‰é¢æˆ‘ä»¬çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“è¿™å¥è¯æœ€ç»ˆä¼šè¢«ActivityManagerServiceçš„activityPausedæ–¹æ³•æ‰§è¡Œã€‚ 1234567891011@Override public final void activityPaused(IBinder token) { final long origId = Binder.clearCallingIdentity(); synchronized(this) { ActivityStack stack = ActivityRecord.getStackLocked(token); if (stack != null) { stack.activityPausedLocked(token, false); } } Binder.restoreCallingIdentity(origId); } å¯ä»¥å‘ç°ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ActivityStackçš„activityPausedLockedæ–¹æ³•ï¼Œå¥½å§ï¼Œç»§ç»­çœ‹ä¸€ä¸‹activityPausedLockedæ–¹æ³•çš„å®ç°ï¼š 1234567final void activityPausedLocked(IBinder token, boolean timeout) { ... if (DEBUG_STATES) Slog.v(TAG_STATES, &quot;Moving to PAUSED: &quot; + r + (timeout ? &quot; (due to timeout)&quot; : &quot; (pause complete)&quot;)); completePauseLocked(true); ... } ç„¶åæ‰§è¡Œäº†completePauseLockedæ–¹æ³•ï¼š 12345678910111213141516171819202122private void completePauseLocked(boolean resumeNext) { ... if (resumeNext) { final ActivityStack topStack = mStackSupervisor.getFocusedStack(); if (!mService.isSleepingOrShuttingDown()) { mStackSupervisor.resumeTopActivitiesLocked(topStack, prev, null); } else { mStackSupervisor.checkReadyForSleepLocked(); ActivityRecord top = topStack.topRunningActivityLocked(null); if (top == null || (prev != null &amp;&amp; top != prev)) { // If there are no more activities available to run, // do resume anyway to start something. Also if the top // activity on the stack is not the just paused activity, // we need to go ahead and resume it to ensure we complete // an in-flight app switch. mStackSupervisor.resumeTopActivitiesLocked(topStack, null, null); } } } ... } ç»è¿‡äº†ä¸€ç³»åˆ—çš„é€»è¾‘ä¹‹åï¼Œåˆè°ƒç”¨äº†resumeTopActivitiesLockedæ–¹æ³•ï¼Œåˆå›åˆ°äº†ç¬¬äºŒæ­¥ä¸­è§£æçš„æ–¹æ³•ä¸­äº†ï¼Œè¿™æ ·ç»è¿‡resumeTopActivitiesLocked â€“&gt;ActivityStack.resumeTopActivityLocked() â€“&gt;resumeTopActivityInnerLocked â€“&gt;startSpecificActivityLockedå¥½å§ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹startSpecificActivityLockedçš„å…·ä½“å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233void startSpecificActivityLocked(ActivityRecord r, boolean andResume, boolean checkConfig) { // Is this activity's application already running? ProcessRecord app = mService.getProcessRecordLocked(r.processName, r.info.applicationInfo.uid, true); r.task.stack.setLaunchTime(r); if (app != null &amp;&amp; app.thread != null) { try { if ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == 0 || !&quot;android&quot;.equals(r.info.packageName)) { // Don't add this if it is a platform component that is marked // to run in multiple processes, because this is actually // part of the framework so doesn't make sense to track as a // separate apk in the process. app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode, mService.mProcessStats); } realStartActivityLocked(r, app, andResume, checkConfig); return; } catch (RemoteException e) { Slog.w(TAG, &quot;Exception when starting activity &quot; + r.intent.getComponent().flattenToShortString(), e); } // If a dead object exception was thrown -- fall through to // restart the application. } mService.startProcessLocked(r.processName, r.info.applicationInfo, true, 0, &quot;activity&quot;, r.intent.getComponent(), false, false, true); } å¯ä»¥å‘ç°åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œé¦–å…ˆä¼šåˆ¤æ–­ä¸€ä¸‹éœ€è¦å¯åŠ¨çš„Activityæ‰€éœ€è¦çš„åº”ç”¨è¿›ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œè‹¥å¯åŠ¨çš„è¯ï¼Œåˆ™ç›´æ¥è°ƒç”¨realStartAtivityLockedæ–¹æ³•ï¼Œå¦åˆ™è°ƒç”¨startProcessLockedæ–¹æ³•ï¼Œç”¨äºå¯åŠ¨åº”ç”¨è¿›ç¨‹ã€‚è¿™æ ·å…³äºå¯åŠ¨Activityæ—¶çš„ç¬¬ä¸‰æ­¥éª¤å°±å·²ç»æ‰§è¡Œå®Œæˆäº†ï¼Œè¿™é‡Œä¸»è¦æ˜¯å®ç°äº†å¯¹æ ˆé¡¶Activityæ‰§è¡ŒonPauseæ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•é¦–å…ˆåˆ¤æ–­éœ€è¦å¯åŠ¨çš„Activityæ‰€å±çš„è¿›ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œè‹¥å·²ç»å¯åŠ¨åˆ™ç›´æ¥è°ƒç”¨å¯åŠ¨Activityçš„æ–¹æ³•ï¼Œå¦åˆ™å°†å…ˆå¯åŠ¨Activityçš„åº”ç”¨è¿›ç¨‹ï¼Œç„¶ååœ¨å¯åŠ¨è¯¥Activityã€‚ å››ï¼šå¯åŠ¨Activityæ‰€å±çš„åº”ç”¨è¿›ç¨‹ å…³äºå¦‚ä½•å¯åŠ¨åº”ç”¨è¿›ç¨‹ï¼Œå‰é¢çš„ä¸€ç¯‡æ–‡ç« å·²ç»åšäº†ä»‹ç»ï¼Œå¯å‚è€ƒï¼š androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹ è¿™é‡Œåœ¨ç®€å•çš„ä»‹ç»ä¸€ä¸‹ ActivityManagerService.startProcessLocked()Process.start()ActivityThread.main()ActivityThread.attach()ActivityManagerNative.getDefault().attachApplication()ActivityManagerService.attachApplication() å¥½å§ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹startProcessLocked()æ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345private final void startProcessLocked(ProcessRecord app, String hostingType, String hostingNameStr) { startProcessLocked(app, hostingType, hostingNameStr, null /* abiOverride */, null /* entryPoint */, null /* entryPointArgs */); } ç„¶åå›è°ƒäº†å…¶é‡è½½çš„startProcessLockedæ–¹æ³•ï¼š 123456789101112131415private final void startProcessLocked(ProcessRecord app, String hostingType, String hostingNameStr, String abiOverride, String entryPoint, String[] entryPointArgs) { ... boolean isActivityProcess = (entryPoint == null); if (entryPoint == null) entryPoint = &quot;android.app.ActivityThread&quot;; Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;Start proc: &quot; + app.processName); checkTime(startTime, &quot;startProcess: asking zygote to start proc&quot;); Process.ProcessStartResult startResult = Process.start(entryPoint, app.processName, uid, uid, gids, debugFlags, mountExternal, app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet, app.info.dataDir, entryPointArgs); checkTime(startTime, &quot;startProcess: returned from zygote!&quot;); ... } å¯ä»¥å‘ç°å…¶ç»è¿‡ä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œä¹‹åè°ƒç”¨äº†Process.startæ–¹æ³•ï¼Œå¹¶ä¸”ä¼ å…¥äº†å¯åŠ¨çš„ç±»åâ€œandroid.app.ActivityThreadâ€: 123456789101112131415161718192021public static final ProcessStartResult start(final String processClass, final String niceName, int uid, int gid, int[] gids, int debugFlags, int mountExternal, int targetSdkVersion, String seInfo, String abi, String instructionSet, String appDataDir, String[] zygoteArgs) { try { return startViaZygote(processClass, niceName, uid, gid, gids, debugFlags, mountExternal, targetSdkVersion, seInfo, abi, instructionSet, appDataDir, zygoteArgs); } catch (ZygoteStartFailedEx ex) { Log.e(LOG_TAG, &quot;Starting VM process through Zygote failed&quot;); throw new RuntimeException( &quot;Starting VM process through Zygote failed&quot;, ex); } } ç„¶åè°ƒç”¨äº†startViaZygoteæ–¹æ³•ï¼š 123456789101112131415161718private static ProcessStartResult startViaZygote(final String processClass, final String niceName, final int uid, final int gid, final int[] gids, int debugFlags, int mountExternal, int targetSdkVersion, String seInfo, String abi, String instructionSet, String appDataDir, String[] extraArgs) throws ZygoteStartFailedEx { synchronized(Process.class) { ... return zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote); } } ç»§ç»­æŸ¥çœ‹ä¸€ä¸‹zygoteSendArgsAndGetResultæ–¹æ³•çš„å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546private static ProcessStartResult zygoteSendArgsAndGetResult( ZygoteState zygoteState, ArrayList&lt;String&gt; args) throws ZygoteStartFailedEx { try { /** * See com.android.internal.os.ZygoteInit.readArgumentList() * Presently the wire format to the zygote process is: * a) a count of arguments (argc, in essence) * b) a number of newline-separated argument strings equal to count * * After the zygote process reads these it will write the pid of * the child or -1 on failure, followed by boolean to * indicate whether a wrapper process was used. */ final BufferedWriter writer = zygoteState.writer; final DataInputStream inputStream = zygoteState.inputStream; writer.write(Integer.toString(args.size())); writer.newLine(); int sz = args.size(); for (int i = 0; i &lt; sz; i++) { String arg = args.get(i); if (arg.indexOf('\\n') &gt;= 0) { throw new ZygoteStartFailedEx( &quot;embedded newlines not allowed&quot;); } writer.write(arg); writer.newLine(); } writer.flush(); // Should there be a timeout on this? ProcessStartResult result = new ProcessStartResult(); result.pid = inputStream.readInt(); if (result.pid &lt; 0) { throw new ZygoteStartFailedEx(&quot;fork() failed&quot;); } result.usingWrapper = inputStream.readBoolean(); return result; } catch (IOException ex) { zygoteState.close(); throw new ZygoteStartFailedEx(ex); } } å¯ä»¥å‘ç°å…¶æœ€ç»ˆè°ƒç”¨äº†Zygoteå¹¶é€šè¿‡socketé€šä¿¡çš„æ–¹å¼è®©Zygoteè¿›ç¨‹forké™¤äº†ä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶æ ¹æ®æˆ‘ä»¬åˆšåˆšä¼ é€’çš„â€android.app.ActivityThreadâ€å­—ç¬¦ä¸²ï¼Œåå°„å‡ºè¯¥å¯¹è±¡å¹¶æ‰§è¡ŒActivityThreadçš„mainæ–¹æ³•ã€‚è¿™æ ·æˆ‘ä»¬æ‰€è¦å¯åŠ¨çš„åº”ç”¨è¿›ç¨‹è¿™æ—¶å€™å…¶å®å·²ç»å¯åŠ¨äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰æ‰§è¡Œç›¸åº”çš„åˆå§‹åŒ–æ“ä½œã€‚ ä¸ºä»€ä¹ˆæˆ‘ä»¬å¹³æ—¶éƒ½å°†ActivityThreadç§°ä¹‹ä¸ºuiçº¿ç¨‹æˆ–è€…æ˜¯ä¸»çº¿ç¨‹ï¼Œè¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œåº”ç”¨è¿›ç¨‹è¢«åˆ›å»ºä¹‹åé¦–å…ˆæ‰§è¡Œçš„æ˜¯ActivityThreadçš„mainæ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ActivityThreadæˆä¸ºä¸»çº¿ç¨‹ã€‚ å¥½äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityThreadçš„mainæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 123456789101112131415161718192021222324public static void main(String[] args) { ... Process.setArgV0(&quot;&lt;pre-initialized&gt;&quot;); Looper.prepareMainLooper(); ActivityThread thread = new ActivityThread(); thread.attach(false); if (sMainThreadHandler == null) { sMainThreadHandler = thread.getHandler(); } if (false) { Looper.myLooper().setMessageLogging(new LogPrinter(Log.DEBUG, &quot;ActivityThread&quot;)); } // End of event ActivityThreadMain. Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); Looper.loop(); throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;); } åœ¨mainæ–¹æ³•ä¸­ä¸»è¦æ‰§è¡Œäº†ä¸€äº›åˆå§‹åŒ–çš„é€»è¾‘ï¼Œå¹¶ä¸”åˆ›å»ºäº†ä¸€ä¸ªUIçº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­éšæ„çš„åˆ›å»ºHandlerè€Œä¸ä¼šæŠ¥é”™çš„åŸå› ï¼Œè¿™é‡Œæå‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¤§å®¶å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼šå­çº¿ç¨‹å¯ä»¥åˆ›å»ºHandlerä¹ˆï¼Ÿå¯ä»¥çš„è¯åº”è¯¥æ€ä¹ˆåšï¼Ÿç„¶åæ‰§è¡Œäº†ActivityThreadçš„attachæ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹attachæ–¹æ³•æ‰§è¡Œäº†é‚£äº›é€»è¾‘æ“ä½œã€‚ 12345678910private void attach(boolean system) { ... final IActivityManager mgr = ActivityManagerNative.getDefault(); try { mgr.attachApplication(mAppThread); } catch (RemoteException ex) { // Ignore } ...} åˆšåˆšæˆ‘ä»¬å·²ç»åˆ†æè¿‡ActivityManagerNativeæ˜¯ActivityManagerServiceçš„Binder clientï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨äº†attachApplicationå®é™…ä¸Šå°±æ˜¯é€šè¿‡Binderæœºåˆ¶è°ƒç”¨äº†ActivityManagerServiceçš„attachApplicationï¼Œå…·ä½“è°ƒç”¨çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityManagerServiceæ˜¯å¦‚ä½•å®ç°çš„ï¼š 123456789@Override public final void attachApplication(IApplicationThread thread) { synchronized (this) { int callingPid = Binder.getCallingPid(); final long origId = Binder.clearCallingIdentity(); attachApplicationLocked(thread, callingPid); Binder.restoreCallingIdentity(origId); } } å¯ä»¥å‘ç°å…¶å›è°ƒäº†attachApplicationLockedæ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘ã€‚ 12345678910111213141516171819private final boolean attachApplicationLocked(IApplicationThread thread, int pid) { ... // See if the top visible activity is waiting to run in this process... if (normalMode) { try { if (mStackSupervisor.attachApplicationLocked(app)) { didSomething = true; } } catch (Exception e) { Slog.wtf(TAG, &quot;Exception thrown launching activities in &quot; + app, e); badApp = true; } } ... return true; } è¯¥æ–¹æ³•æ‰§è¡Œäº†ä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ“ä½œï¼Œè¿™æ ·æˆ‘ä»¬æ•´ä¸ªåº”ç”¨è¿›ç¨‹å·²ç»å¯åŠ¨èµ·æ¥äº†ã€‚ç»ˆäºå¯ä»¥å¼€å§‹activityçš„å¯åŠ¨é€»è¾‘äº†ï¼ŒO(âˆ©_âˆ©)Oå“ˆå“ˆ~ äº”ï¼šæ‰§è¡Œå¯åŠ¨Acitivity ActivityStackSupervisor.attachApplicationLocked()ActivityStackSupervisor.realStartActivityLocked()IApplicationThread.scheduleLauncherActivity()ActivityThread.sendMessage()ActivityThread.H.sendMessage()ActivityThread.H.handleMessage()ActivityThread.handleLauncherActivity()ActivityThread.performLauncherActivity()Instrumentation.callActivityOnCreate()Activity.onCreate()ActivityThread.handleResumeActivity()ActivityThread.performResumeActivity()Activity.performResume()Instrumentation.callActivityOnResume()Activity.onResume()ActivityManagerNative.getDefault().activityResumed(token) é¦–å…ˆçœ‹ä¸€ä¸‹attachApplicationLockedæ–¹æ³•çš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132boolean attachApplicationLocked(ProcessRecord app) throws RemoteException { final String processName = app.processName; boolean didSomething = false; for (int displayNdx = mActivityDisplays.size() - 1; displayNdx &gt;= 0; --displayNdx) { ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks; for (int stackNdx = stacks.size() - 1; stackNdx &gt;= 0; --stackNdx) { final ActivityStack stack = stacks.get(stackNdx); if (!isFrontStack(stack)) { continue; } ActivityRecord hr = stack.topRunningActivityLocked(null); if (hr != null) { if (hr.app == null &amp;&amp; app.uid == hr.info.applicationInfo.uid &amp;&amp; processName.equals(hr.processName)) { try { if (realStartActivityLocked(hr, app, true, true)) { didSomething = true; } } catch (RemoteException e) { Slog.w(TAG, &quot;Exception in new application when starting activity &quot; + hr.intent.getComponent().flattenToShortString(), e); throw e; } } } } } if (!didSomething) { ensureActivitiesVisibleLocked(null, 0); } return didSomething; } å¯ä»¥å‘ç°å…¶å†…éƒ¨è°ƒç”¨äº†realStartActivityLockedæ–¹æ³•ï¼Œé€šè¿‡åå­—å¯ä»¥çŸ¥é“è¿™ä¸ªæ–¹æ³•åº”è¯¥å°±æ˜¯ç”¨æ¥å¯åŠ¨Activityçš„ï¼Œçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°é€»è¾‘ï¼š 1234567891011121314final boolean realStartActivityLocked(ActivityRecord r, ProcessRecord app, boolean andResume, boolean checkConfig) throws RemoteException { ... app.forceProcessStateUpTo(mService.mTopProcessState); app.thread.scheduleLaunchActivity(new Intent(r.intent), r.appToken, System.identityHashCode(r), r.info, new Configuration(mService.mConfiguration), new Configuration(stack.mOverrideConfig), r.compat, r.launchedFromPackage, task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results, newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo); ... return true; } å¯ä»¥å‘ç°ä¸ç¬¬ä¸‰æ­¥æ‰§è¡Œæ ˆé¡¶Activity onPauseæ—¶ç±»ä¼¼ï¼Œè¿™é‡Œä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨IApplicationThreadçš„æ–¹æ³•å®ç°çš„ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯scheduleLauncherActivityæ–¹æ³•ï¼Œæ‰€ä»¥çœŸæ­£æ‰§è¡Œçš„æ˜¯ActivityThreadä¸­çš„scheduleLauncherActivityï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹ä¸€ä¸‹ActivityThreadä¸­çš„scheduleLauncherActivityçš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435@Override public final void scheduleLaunchActivity(Intent intent, IBinder token, int ident, ActivityInfo info, Configuration curConfig, Configuration overrideConfig, CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor, int procState, Bundle state, PersistableBundle persistentState, List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents, boolean notResumed, boolean isForward, ProfilerInfo profilerInfo) { updateProcessState(procState, false); ActivityClientRecord r = new ActivityClientRecord(); r.token = token; r.ident = ident; r.intent = intent; r.referrer = referrer; r.voiceInteractor = voiceInteractor; r.activityInfo = info; r.compatInfo = compatInfo; r.state = state; r.persistentState = persistentState; r.pendingResults = pendingResults; r.pendingIntents = pendingNewIntents; r.startsNotResumed = notResumed; r.isForward = isForward; r.profilerInfo = profilerInfo; r.overrideConfig = overrideConfig; updatePendingConfiguration(curConfig); sendMessage(H.LAUNCH_ACTIVITY, r); } å¥½å§ï¼Œè¿˜æ˜¯é‚£å¥—é€»è¾‘ï¼ŒActivityThreadæ¥æ”¶åˆ°SystemServerè¿›ç¨‹çš„æ¶ˆæ¯ä¹‹åä¼šé€šè¿‡å…¶å†…éƒ¨çš„Handlerå¯¹è±¡åˆ†å‘æ¶ˆæ¯ï¼Œç»è¿‡ä¸€ç³»åˆ—çš„åˆ†å‘ä¹‹åè°ƒç”¨äº†ActivityThreadçš„handleLaunchActivityæ–¹æ³•ï¼š 1234567891011121314private void handleLaunchActivity(ActivityClientRecord r, Intent customIntent) { Activity a = performLaunchActivity(r, customIntent); if (a != null) { r.createdConfig = new Configuration(mConfiguration); Bundle oldState = r.state; handleResumeActivity(r.token, false, r.isForward, !r.activity.mFinished &amp;&amp; !r.startsNotResumed); } ... } å¯ä»¥å‘ç°è¿™é‡Œè°ƒç”¨äº†performLauncherActivityï¼Œçœ‹åå­—åº”è¯¥å°±æ˜¯æ‰§è¡ŒActivityçš„å¯åŠ¨æ“ä½œäº†ã€‚ã€‚ã€‚ 12345678910111213141516171819202122232425262728293031323334353637private Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) { ...Activity activity = null; try { java.lang.ClassLoader cl = r.packageInfo.getClassLoader(); activity = mInstrumentation.newActivity( cl, component.getClassName(), r.intent); StrictMode.incrementExpectedActivityCount(activity.getClass()); r.intent.setExtrasClassLoader(cl); r.intent.prepareToEnterProcess(); if (r.state != null) { r.state.setClassLoader(cl); } } catch (Exception e) { if (!mInstrumentation.onException(activity, e)) { throw new RuntimeException( &quot;Unable to instantiate activity &quot; + component + &quot;: &quot; + e.toString(), e); } } ... activity.mCalled = false; if (r.isPersistable()) { mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState); } else { mInstrumentation.callActivityOnCreate(activity, r.state); } ... if (!r.activity.mFinished) { activity.performStart(); r.stopped = false; } ... return activity; } å¯ä»¥å‘ç°è¿™é‡Œæˆ‘ä»¬éœ€è¦çš„Activityå¯¹è±¡ç»ˆäºæ˜¯åˆ›å»ºå‡ºæ¥äº†ï¼Œè€Œä¸”ä»–æ˜¯ä»¥åå°„çš„æœºåˆ¶åˆ›å»ºçš„ï¼Œç°åœ¨è¿˜ä¸å¤ªæ¸…æ¥šä¸ºå•¥googleè¦ä»¥åå°„çš„æ–¹å¼åˆ›å»ºActivityï¼Œå…ˆä¸çœ‹è¿™äº›ï¼Œç„¶ååœ¨ä»£ç ä¸­å…¶è°ƒç”¨Instrumentationçš„callActivityOnCreateæ–¹æ³•ã€‚ 123456public void callActivityOnCreate(Activity activity, Bundle icicle, PersistableBundle persistentState) { prePerformCreate(activity); activity.performCreate(icicle); postPerformCreate(activity); } ç„¶åæ‰§è¡Œactivityçš„performCreateæ–¹æ³•ã€‚ã€‚ã€‚ã€‚å¥½å§ï¼Œéƒ½è½¬æ™•äº†ã€‚ã€‚ã€‚ 12345final void performCreate(Bundle icicle) { onCreate(icicle); mActivityTransitionState.readState(icicle); performCreateCommon(); } O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œç¬¬äºŒä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å‡ºæ¥äº†ï¼ŒonCreateæ–¹æ³•ã€‚ã€‚ã€‚ã€‚ åœ¨å›åˆ°æˆ‘ä»¬çš„performLaunchActivityæ–¹æ³•ï¼Œå…¶åœ¨è°ƒç”¨äº†mInstrumentation.callActivityOnCreateæ–¹æ³•ä¹‹ååˆè°ƒç”¨äº†activity.performStart();æ–¹æ³•ï¼Œå¥½å§ï¼Œçœ‹ä¸€ä¸‹ä»–çš„å®ç°æ–¹å¼ï¼š 123456789101112131415final void performStart() { mActivityTransitionState.setEnterActivityOptions(this, getActivityOptions()); mFragments.noteStateNotSaved(); mCalled = false; mFragments.execPendingActions(); mInstrumentation.callActivityOnStart(this); if (!mCalled) { throw new SuperNotCalledException( &quot;Activity &quot; + mComponent.toShortString() + &quot; did not call through to super.onStart()&quot;); } mFragments.dispatchStart(); mFragments.reportLoaderStart(); mActivityTransitionState.enterReady(this); } å¥½å§ï¼Œè¿˜æ˜¯é€šè¿‡Instrumentationè°ƒç”¨callActivityOnStartæ–¹æ³•ï¼š 123public void callActivityOnStart(Activity activity) { activity.onStart(); } ç„¶åæ˜¯ç›´æ¥è°ƒç”¨activityçš„onStartæ–¹æ³•ï¼Œç¬¬ä¸‰ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å‡ºç°äº†ï¼ŒO(âˆ©_âˆ©)Oå“ˆå“ˆ~ è¿˜æ˜¯å›åˆ°æˆ‘ä»¬åˆšåˆšçš„handleLaunchActivityæ–¹æ³•ï¼Œåœ¨è°ƒç”¨å®ŒperformLaunchActivityæ–¹æ³•ä¹‹åï¼Œå…¶æœ‰åŠç”¨äº†handleResumeActivityæ–¹æ³•ï¼Œå¥½å§ï¼Œçœ‹åå­—åº”è¯¥æ˜¯å›è°ƒActivityçš„onResumeæ–¹æ³•çš„ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122final void handleResumeActivity(IBinder token, boolean clearHide, boolean isForward, boolean reallyResume) { // If we are getting ready to gc after going to the background, well // we are back active so skip it. unscheduleGcIdler(); mSomeActivitiesChanged = true; // TODO Push resumeArgs into the activity for consideration ActivityClientRecord r = performResumeActivity(token, clearHide); if (r != null) { final Activity a = r.activity; if (localLOGV) Slog.v( TAG, &quot;Resume &quot; + r + &quot; started activity: &quot; + a.mStartedActivity + &quot;, hideForNow: &quot; + r.hideForNow + &quot;, finished: &quot; + a.mFinished); final int forwardBit = isForward ? WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : 0; // If the window hasn't yet been added to the window manager, // and this guy didn't finish itself or start another activity, // then go ahead and add the window. boolean willBeVisible = !a.mStartedActivity; if (!willBeVisible) { try { willBeVisible = ActivityManagerNative.getDefault().willActivityBeVisible( a.getActivityToken()); } catch (RemoteException e) { } } if (r.window == null &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) { r.window = r.activity.getWindow(); View decor = r.window.getDecorView(); decor.setVisibility(View.INVISIBLE); ViewManager wm = a.getWindowManager(); WindowManager.LayoutParams l = r.window.getAttributes(); a.mDecor = decor; l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION; l.softInputMode |= forwardBit; if (a.mVisibleFromClient) { a.mWindowAdded = true; wm.addView(decor, l); } // If the window has already been added, but during resume // we started another activity, then don't yet make the // window visible. } else if (!willBeVisible) { if (localLOGV) Slog.v( TAG, &quot;Launch &quot; + r + &quot; mStartedActivity set&quot;); r.hideForNow = true; } // Get rid of anything left hanging around. cleanUpPendingRemoveWindows(r); // The window is now visible if it has been added, we are not // simply finishing, and we are not starting another activity. if (!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp; r.activity.mDecor != null &amp;&amp; !r.hideForNow) { if (r.newConfig != null) { r.tmpConfig.setTo(r.newConfig); if (r.overrideConfig != null) { r.tmpConfig.updateFrom(r.overrideConfig); } if (DEBUG_CONFIGURATION) Slog.v(TAG, &quot;Resuming activity &quot; + r.activityInfo.name + &quot; with newConfig &quot; + r.tmpConfig); performConfigurationChanged(r.activity, r.tmpConfig); freeTextLayoutCachesIfNeeded(r.activity.mCurrentConfig.diff(r.tmpConfig)); r.newConfig = null; } if (localLOGV) Slog.v(TAG, &quot;Resuming &quot; + r + &quot; with isForward=&quot; + isForward); WindowManager.LayoutParams l = r.window.getAttributes(); if ((l.softInputMode &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION) != forwardBit) { l.softInputMode = (l.softInputMode &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)) | forwardBit; if (r.activity.mVisibleFromClient) { ViewManager wm = a.getWindowManager(); View decor = r.window.getDecorView(); wm.updateViewLayout(decor, l); } } r.activity.mVisibleFromServer = true; mNumVisibleActivities++; if (r.activity.mVisibleFromClient) { r.activity.makeVisible(); } } if (!r.onlyLocalRequest) { r.nextIdle = mNewActivities; mNewActivities = r; if (localLOGV) Slog.v( TAG, &quot;Scheduling idle handler for &quot; + r); Looper.myQueue().addIdleHandler(new Idler()); } r.onlyLocalRequest = false; // Tell the activity manager we have resumed. if (reallyResume) { try { ActivityManagerNative.getDefault().activityResumed(token); } catch (RemoteException ex) { } } } else { // If an exception was thrown when trying to resume, then // just end this activity. try { ActivityManagerNative.getDefault() .finishActivity(token, Activity.RESULT_CANCELED, null, false); } catch (RemoteException ex) { } } } å¯ä»¥å‘ç°å…¶resumeActivityçš„é€»è¾‘è°ƒç”¨åˆ°äº†performResumeActivityæ–¹æ³•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹performResumeActivityæ˜¯å¦‚ä½•å®ç°çš„ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041public final ActivityClientRecord performResumeActivity(IBinder token, boolean clearHide) { ActivityClientRecord r = mActivities.get(token); if (localLOGV) Slog.v(TAG, &quot;Performing resume of &quot; + r + &quot; finished=&quot; + r.activity.mFinished); if (r != null &amp;&amp; !r.activity.mFinished) { if (clearHide) { r.hideForNow = false; r.activity.mStartedActivity = false; } try { r.activity.onStateNotSaved(); r.activity.mFragments.noteStateNotSaved(); if (r.pendingIntents != null) { deliverNewIntents(r, r.pendingIntents); r.pendingIntents = null; } if (r.pendingResults != null) { deliverResults(r, r.pendingResults); r.pendingResults = null; } r.activity.performResume(); EventLog.writeEvent(LOG_AM_ON_RESUME_CALLED, UserHandle.myUserId(), r.activity.getComponentName().getClassName()); r.paused = false; r.stopped = false; r.state = null; r.persistentState = null; } catch (Exception e) { if (!mInstrumentation.onException(r.activity, e)) { throw new RuntimeException( &quot;Unable to resume activity &quot; + r.intent.getComponent().toShortString() + &quot;: &quot; + e.toString(), e); } } } return r; } åœ¨æ–¹æ³•ä½“ä¸­ï¼Œæœ€ç»ˆè°ƒç”¨äº†r.activity.performResume();æ–¹æ³•ï¼Œå¥½å§ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯Activityä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨Activityä¸­æŸ¥çœ‹è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ï¼š 12345final void performResume() { ... mInstrumentation.callActivityOnResume(this); ... } å¥½å§ï¼Œåˆæ˜¯ç†Ÿæ‚‰çš„å‘³é“ï¼Œé€šè¿‡Instrumentationæ¥è°ƒç”¨äº†callActivityOnResumeæ–¹æ³•ã€‚ã€‚ã€‚ 1234567891011121314public void callActivityOnResume(Activity activity) { activity.mResumed = true; activity.onResume(); if (mActivityMonitors != null) { synchronized (mSync) { final int N = mActivityMonitors.size(); for (int i=0; i&lt;N; i++) { final ActivityMonitor am = mActivityMonitors.get(i); am.match(activity, activity, activity.getIntent()); } } } } O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œç¬¬å››ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•å‡ºç°äº†ï¼ŒonResumeæ–¹æ³•ã€‚ã€‚ã€‚ ç»ˆäºå›è°ƒonResumeæ–¹æ³•äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬çš„ç•Œé¢åº”è¯¥å·²ç»å±•ç¤ºå‡ºæ¥äº†ï¼Œç…§ç†æ¥è¯´æˆ‘ä»¬çš„Activityåº”è¯¥å·²ç»å¯åŠ¨å®Œæˆäº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰ï¼Œå“ˆå“ˆï¼Œåˆ«ç€æ€¥ã€‚ æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒActivity a å¯åŠ¨ Activity b ä¼šè§¦å‘é‚£äº›ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Ÿä½ å¯èƒ½ä¼šå›ç­”ï¼Ÿbçš„onCreate onStartæ–¹æ³•ï¼ŒonResumeæ–¹æ³• açš„onPauseæ–¹æ³•å’ŒonStopæ–¹æ³•ï¼Œå’¦ï¼Ÿå¯¹äº†onStopæ–¹æ³•è¿˜æ²¡å›è°ƒå‘¢ï¼ŒO(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œå¯¹äº†ç¼ºå°‘çš„å°±æ˜¯å¯¹onStopæ–¹æ³•çš„å›è°ƒå•Šã€‚ å¥½å§ï¼Œå…·ä½“çš„é€»è¾‘æˆ‘ä»¬ä¸‹ä¸€æ­¥å†è¯´ å…­ï¼šæ ˆé¡¶Activityæ‰§è¡ŒonStopæ–¹æ³• Looper.myQueue().addIdleHandler(new Idler())Idler.queueIdle()ActivityManagerNative.getDefault().activityIdle()ActivityManagerService.activityIdle()ActivityStackSupervisor.activityIdleInternalLocked()ActivityStack.stopActivityLocked()IApplicationThread.scheduleStopActivity()ActivityThread.scheduleStopActivity()ActivityThread.sendMessage()ActivityThread.H.sendMessage()ActivityThread.H.handleMessage()ActivityThread.handleStopActivity()ActivityThread.performStopActivityInner()ActivityThread.callCallActivityOnSaveInstanceState()Instrumentation.callActivityOnSaveInstanceState()Activity.performSaveInstanceState()Activity.onSaveInstanceState()Activity.performStop()Instrumentation.callActivityOnStop()Activity.onStop() å›åˆ°æˆ‘ä»¬çš„handleResumeActivityæ–¹æ³•ï¼Œåœ¨æ–¹æ³•ä½“æœ€åæœ‰è¿™æ ·çš„ä¸€ä»£ç ï¼š 1Looper.myQueue().addIdleHandler(new Idler()); è¿™æ®µä»£ç æ˜¯å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶ç›¸å…³çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹Idlerå¯¹è±¡çš„å…·ä½“å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738private class Idler implements MessageQueue.IdleHandler { @Override public final boolean queueIdle() { ActivityClientRecord a = mNewActivities; boolean stopProfiling = false; if (mBoundApplication != null &amp;&amp; mProfiler.profileFd != null &amp;&amp; mProfiler.autoStopProfiler) { stopProfiling = true; } if (a != null) { mNewActivities = null; IActivityManager am = ActivityManagerNative.getDefault(); ActivityClientRecord prev; do { if (localLOGV) Slog.v( TAG, &quot;Reporting idle of &quot; + a + &quot; finished=&quot; + (a.activity != null &amp;&amp; a.activity.mFinished)); if (a.activity != null &amp;&amp; !a.activity.mFinished) { try { am.activityIdle(a.token, a.createdConfig, stopProfiling); a.createdConfig = null; } catch (RemoteException ex) { // Ignore } } prev = a; a = a.nextIdle; prev.nextIdle = null; } while (a != null); } if (stopProfiling) { mProfiler.stopProfiling(); } ensureJitEnabled(); return false; } } è¿™æ ·å½“Messagequeueæ‰§è¡Œaddæ–¹æ³•ä¹‹åå°±ä¼šå›è°ƒå…¶queueIdle()æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨æ–¹æ³•ä½“ä¸­å…¶è°ƒç”¨äº†ActivityManagerNative.getDefault().activityIdle()ï¼Œå¥½å§ï¼Œç†Ÿæ‚‰äº†Binderæœºåˆ¶ä»¥åæˆ‘ä»¬çŸ¥é“è¿™æ®µä»£ç ä¼šæ‰§è¡Œåˆ°ActivityManagerServiceçš„activityIdleæ–¹æ³•ï¼š 123456789101112131415161718192021@Override public final void activityIdle(IBinder token, Configuration config, boolean stopProfiling) { final long origId = Binder.clearCallingIdentity(); synchronized (this) { ActivityStack stack = ActivityRecord.getStackLocked(token); if (stack != null) { ActivityRecord r = mStackSupervisor.activityIdleInternalLocked(token, false, config); if (stopProfiling) { if ((mProfileProc == r.app) &amp;&amp; (mProfileFd != null)) { try { mProfileFd.close(); } catch (IOException e) { } clearProfilerLocked(); } } } } Binder.restoreCallingIdentity(origId); } ç„¶ååœ¨activityIdleæ–¹æ³•ä¸­åˆè°ƒç”¨äº†ActivityStackSupervisor.activityIdleInternalLockedæ–¹æ³•ï¼š 12345678910111213141516171819202122final ActivityRecord activityIdleInternalLocked(final IBinder token, boolean fromTimeout, Configuration config) { ... // Stop any activities that are scheduled to do so but have been // waiting for the next one to start. for (int i = 0; i &lt; NS; i++) { r = stops.get(i); final ActivityStack stack = r.task.stack; if (stack != null) { if (r.finishing) { stack.finishCurrentActivityLocked(r, ActivityStack.FINISH_IMMEDIATELY, false); } else { stack.stopActivityLocked(r); } } } ... return r; } å¯ä»¥å‘ç°åœ¨å…¶ä¸­åˆè°ƒç”¨äº†ActivityStack.stopActivityLockedæ–¹æ³•ï¼š 123456789final void stopActivityLocked(ActivityRecord r) { if (DEBUG_SWITCH) Slog.d(TAG_SWITCH, &quot;Stopping: &quot; + r); if ((r.intent.getFlags()&amp;Intent.FLAG_ACTIVITY_NO_HISTORY) != 0 || (r.info.flags&amp;ActivityInfo.FLAG_NO_HISTORY) != 0) { ... r.app.thread.scheduleStopActivity(r.appToken, r.visible, r.configChangeFlags); ... } } å¥½å§ï¼Œåˆæ˜¯ç›¸åŒçš„é€»è¾‘é€šè¿‡IApplicationThread.scheduleStopActivity,æœ€ç»ˆè°ƒç”¨äº†ActivityThread.scheduleStopActivity()æ–¹æ³•ã€‚ã€‚ã€‚ã€‚ 123456public final void scheduleStopActivity(IBinder token, boolean showWindow, int configChanges) { sendMessage( showWindow ? H.STOP_ACTIVITY_SHOW : H.STOP_ACTIVITY_HIDE, token, 0, configChanges); } ç„¶åæ‰§è¡ŒsendMessageæ–¹æ³•ï¼Œæœ€ç»ˆæ‰§è¡ŒHï¼ˆHandlerï¼‰çš„sendMessageæ–¹æ³•ï¼Œå¹¶è¢«Hçš„handleMessgeæ–¹æ³•æ¥æ”¶æ‰§è¡ŒhandleStopActivityæ–¹æ³•ã€‚ã€‚ã€‚ 12345private void handleStopActivity(IBinder token, boolean show, int configChanges) { ... performStopActivityInner(r, info, show, true); ... } ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹performStopActivityInnerçš„å®ç°é€»è¾‘ï¼š 1234567891011121314151617181920212223242526private void performStopActivityInner(ActivityClientRecord r, StopInfo info, boolean keepShown, boolean saveState) { ... // Next have the activity save its current state and managed dialogs... if (!r.activity.mFinished &amp;&amp; saveState) { if (r.state == null) { callCallActivityOnSaveInstanceState(r); } } if (!keepShown) { try { // Now we are idle. r.activity.performStop(); } catch (Exception e) { if (!mInstrumentation.onException(r.activity, e)) { throw new RuntimeException( &quot;Unable to stop activity &quot; + r.intent.getComponent().toShortString() + &quot;: &quot; + e.toString(), e); } } r.stopped = true; } } } å¥½å§ï¼Œçœ‹æ ·å­åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ‰§è¡Œäº†ä¸¤ä¸ªé€»è¾‘ï¼Œä¸€ä¸ªæ˜¯æ‰§è¡ŒActivityçš„onSaveInstanceæ–¹æ³•ä¸€ä¸ªæ˜¯æ‰§è¡ŒActivityçš„onStopæ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹callCallActivityOnSaveInstanceStateçš„æ‰§è¡Œé€»è¾‘ï¼š 1234567891011private void callCallActivityOnSaveInstanceState(ActivityClientRecord r) { r.state = new Bundle(); r.state.setAllowFds(false); if (r.isPersistable()) { r.persistentState = new PersistableBundle(); mInstrumentation.callActivityOnSaveInstanceState(r.activity, r.state, r.persistentState); } else { mInstrumentation.callActivityOnSaveInstanceState(r.activity, r.state); } } å¥½å§ï¼Œåˆæ˜¯é€šè¿‡Instrumentationæ¥æ‰§è¡Œã€‚ã€‚ã€‚ 1234public void callActivityOnSaveInstanceState(Activity activity, Bundle outState, PersistableBundle outPersistentState) { activity.performSaveInstanceState(outState, outPersistentState); } åˆé—´æ¥è°ƒç”¨äº†Activityçš„performSaveInstanceStateæ–¹æ³•ï¼š 123456final void performSaveInstanceState(Bundle outState) { onSaveInstanceState(outState); saveManagedDialogs(outState); mActivityTransitionState.saveState(outState); if (DEBUG_LIFECYCLE) Slog.v(TAG, &quot;onSaveInstanceState &quot; + this + &quot;: &quot; + outState); } å‘µå‘µï¼Œè¿™é‡Œè°ƒç”¨åˆ°äº†ï¼Œæˆ‘ä»¬ä»¥å‰ç»å¸¸ä¼šé‡å†™çš„onSaveInstanceStateæ–¹æ³•ã€‚ ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹performStopActivityInnerä¸­è°ƒç”¨åˆ°çš„Activityæ–¹æ³•çš„performStopæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738final void performStop() { mDoReportFullyDrawn = false; mFragments.doLoaderStop(mChangingConfigurations /*retain*/); if (!mStopped) { if (mWindow != null) { mWindow.closeAllPanels(); } if (mToken != null &amp;&amp; mParent == null) { WindowManagerGlobal.getInstance().setStoppedState(mToken, true); } mFragments.dispatchStop(); mCalled = false; mInstrumentation.callActivityOnStop(this); if (!mCalled) { throw new SuperNotCalledException( &quot;Activity &quot; + mComponent.toShortString() + &quot; did not call through to super.onStop()&quot;); } synchronized (mManagedCursors) { final int N = mManagedCursors.size(); for (int i=0; i&lt;N; i++) { ManagedCursor mc = mManagedCursors.get(i); if (!mc.mReleased) { mc.mCursor.deactivate(); mc.mReleased = true; } } } mStopped = true; } mResumed = false; } è¿˜æ˜¯é€šè¿‡Instrumentationæ¥å®ç°çš„ï¼Œè°ƒç”¨äº†å®ƒçš„callActivityOnStopæ–¹æ³•ã€‚ã€‚ 123public void callActivityOnStop(Activity activity) { activity.onStop(); } O(âˆ©_âˆ©)Oå“ˆå“ˆ~ï¼Œæœ€åä¸€ä¸ªç”Ÿå‘½å‘¨æœŸæ–¹æ³•ç»ˆäºå‡ºæ¥äº†ï¼ŒonStop()â€¦.. æ€»ç»“ï¼š Activityçš„å¯åŠ¨æµç¨‹ä¸€èˆ¬æ˜¯é€šè¿‡è°ƒç”¨startActivityæˆ–è€…æ˜¯startActivityForResultæ¥å¼€å§‹çš„ startActivityå†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡è°ƒç”¨startActivityForResultæ¥å¯åŠ¨Activityï¼Œåªä¸è¿‡ä¼ é€’çš„requestCodeå°äº0 Activityçš„å¯åŠ¨æµç¨‹æ¶‰åŠåˆ°å¤šä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šè®¯è¿™é‡Œä¸»è¦æ˜¯ActivityThreadä¸ActivityManagerServiceä¹‹é—´çš„é€šè®¯ ActivityThreadå‘ActivityManagerServiceä¼ é€’è¿›ç¨‹é—´æ¶ˆæ¯é€šè¿‡ActivityManagerNativeï¼ŒActivityManagerServiceå‘ActivityThreadè¿›ç¨‹é—´ä¼ é€’æ¶ˆæ¯é€šè¿‡IApplicationThreadã€‚ ActivityManagerServiceæ¥æ”¶åˆ°åº”ç”¨è¿›ç¨‹åˆ›å»ºActivityçš„è¯·æ±‚ä¹‹åä¼šæ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œè§£æå¯åŠ¨æ¨¡å¼ï¼Œä¿å­˜è¯·æ±‚ä¿¡æ¯ç­‰ä¸€ç³»åˆ—æ“ä½œã€‚ ActivityManagerServiceä¿å­˜å®Œè¯·æ±‚ä¿¡æ¯ä¹‹åä¼šå°†å½“å‰ç³»ç»Ÿæ ˆé¡¶çš„Activityæ‰§è¡ŒonPauseæ“ä½œï¼Œå¹¶ä¸”IApplicationè¿›ç¨‹é—´é€šè®¯å‘Šè¯‰åº”ç”¨ç¨‹åºç»§æ‰¿æ‰§è¡Œå½“å‰æ ˆé¡¶çš„Activityçš„onPauseæ–¹æ³•ï¼› ActivityThreadæ¥æ”¶åˆ°SystemServerçš„æ¶ˆæ¯ä¹‹åä¼šç»Ÿä¸€äº¤ä¸ªè‡ªèº«å®šä¹‰çš„Handlerå¯¹è±¡å¤„ç†åˆ†å‘ï¼› ActivityThreadæ‰§è¡Œå®Œæ ˆé¡¶çš„Activityçš„onPauseæ–¹æ³•ä¹‹åä¼šé€šè¿‡ActivityManagerNativeæ‰§è¡Œè¿›ç¨‹é—´é€šè®¯å‘Šè¯‰ActivityManagerServiceï¼Œæ ˆé¡¶Actiityå·²ç»æ‰§è¡Œå®ŒæˆonPauseæ–¹æ³•ï¼Œç»§ç»­æ‰§è¡Œåç»­æ“ä½œï¼› ActivityManagerServiceä¼šç»§ç»­æ‰§è¡Œå¯åŠ¨Activityçš„é€»è¾‘ï¼Œè¿™æ—¶å€™ä¼šåˆ¤æ–­éœ€è¦å¯åŠ¨çš„Activityæ‰€å±çš„åº”ç”¨è¿›ç¨‹æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œè‹¥æ²¡æœ‰å¯åŠ¨åˆ™é¦–å…ˆä¼šå¯åŠ¨è¿™ä¸ªActivityçš„åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼› ActivityManagerServiceä¼šé€šè¿‡socketä¸Zygoteç»§æ‰¿é€šè®¯ï¼Œå¹¶å‘ŠçŸ¥Zygoteè¿›ç¨‹forkå‡ºä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œç„¶åæ‰§è¡ŒActivityThreadçš„maniæ–¹æ³•ï¼› åœ¨ActivityThead.mainæ–¹æ³•ä¸­æ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œåˆå§‹åŒ–ä¸»çº¿ç¨‹å¼‚æ­¥æ¶ˆæ¯ï¼Œç„¶åé€šçŸ¥ActivityManagerServiceæ‰§è¡Œè¿›ç¨‹åˆå§‹åŒ–æ“ä½œï¼› ActivityManagerServiceä¼šåœ¨æ‰§è¡Œåˆå§‹åŒ–æ“ä½œçš„åŒæ—¶æ£€æµ‹å½“å‰è¿›ç¨‹æ˜¯å¦æœ‰éœ€è¦åˆ›å»ºçš„Activityå¯¹è±¡ï¼Œè‹¥æœ‰çš„è¯ï¼Œåˆ™æ‰§è¡Œåˆ›å»ºæ“ä½œï¼› ActivityManagerServiceå°†æ‰§è¡Œåˆ›å»ºActivityçš„é€šçŸ¥å‘ŠçŸ¥ActivityThreadï¼Œç„¶åé€šè¿‡åå°„æœºåˆ¶åˆ›å»ºå‡ºActivityå¯¹è±¡ï¼Œå¹¶æ‰§è¡ŒActivityçš„onCreateæ–¹æ³•ï¼ŒonStartæ–¹æ³•ï¼ŒonResumeæ–¹æ³•ï¼› ActivityThreadæ‰§è¡Œå®ŒæˆonResumeæ–¹æ³•ä¹‹åå‘ŠçŸ¥ActivityManagerService onResumeæ‰§è¡Œå®Œæˆï¼Œå¼€å§‹æ‰§è¡Œæ ˆé¡¶Activityçš„onStopæ–¹æ³•ï¼› ActivityManagerServiceå¼€å§‹æ‰§è¡Œæ ˆé¡¶çš„onStopæ–¹æ³•å¹¶å‘ŠçŸ¥ActivityThreadï¼› ActivityThreadæ‰§è¡ŒçœŸæ­£çš„onStopæ–¹æ³•ï¼› å¦å¤–å¯¹androidæºç è§£ææ–¹æ³•æ„Ÿå…´è¶£çš„å¯å‚è€ƒæˆ‘çš„ï¼š androidæºç è§£æä¹‹ï¼ˆä¸€ï¼‰â€“&gt;androidé¡¹ç›®æ„å»ºè¿‡ç¨‹androidæºç è§£æä¹‹ï¼ˆäºŒï¼‰â€“&gt;å¼‚æ­¥æ¶ˆæ¯æœºåˆ¶androidæºç è§£æä¹‹ï¼ˆä¸‰ï¼‰â€“&gt;å¼‚æ­¥ä»»åŠ¡AsyncTaskandroidæºç è§£æä¹‹ï¼ˆå››ï¼‰â€“&gt;HandlerThreadandroidæºç è§£æä¹‹ï¼ˆäº”ï¼‰â€“&gt;IntentServiceandroidæºç è§£æä¹‹ï¼ˆå…­ï¼‰â€“&gt;Logandroidæºç è§£æä¹‹ï¼ˆä¸ƒï¼‰â€“&gt;LruCacheandroidæºç è§£æä¹‹ï¼ˆå…«ï¼‰â€“&gt;Zygoteè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆä¹ï¼‰â€“&gt;SystemServerè¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåï¼‰â€“&gt;Launcherå¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸€ï¼‰â€“&gt;åº”ç”¨è¿›ç¨‹å¯åŠ¨æµç¨‹androidæºç è§£æä¹‹ï¼ˆåäºŒï¼‰â€“&gt;ç³»ç»Ÿå¯åŠ¨å¹¶è§£æManifestçš„æµç¨‹androidæºç è§£æä¹‹ï¼ˆåä¸‰ï¼‰â€“&gt;apkå®‰è£…æµç¨‹","link":"/2020/09/11/activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"},{"title":"ADBå‘½ä»¤å¤§å…¨(è½¬)","text":"ADBï¼Œå³ Android Debug Bridgeï¼Œå®ƒæ˜¯ Android å¼€å‘/æµ‹è¯•äººå‘˜ä¸å¯æ›¿ä»£çš„å¼ºå¤§å·¥å…·ï¼Œä¹Ÿæ˜¯ Android è®¾å¤‡ç©å®¶çš„å¥½ç©å…·ã€‚ æŒç»­æ›´æ–°ä¸­ï¼Œæ¬¢è¿æ PR å’Œ Issue è¡¥å……æŒ‡æ­£ï¼Œè§‰å¾—æœ‰ç”¨çš„å¯ä»¥å°† æ­¤ GitHub ä»“åº“ Star æ”¶è—å¤‡ç”¨ã€‚ æ³¨ï¼š æœ‰éƒ¨åˆ†å‘½ä»¤çš„æ”¯æŒæƒ…å†µå¯èƒ½ä¸ Android ç³»ç»Ÿç‰ˆæœ¬åŠå®šåˆ¶ ROM çš„å®ç°æœ‰å…³ã€‚ Other languages: :gb: English åŸºæœ¬ç”¨æ³• å‘½ä»¤è¯­æ³• ä¸ºå‘½ä»¤æŒ‡å®šç›®æ ‡è®¾å¤‡ å¯åŠ¨/åœæ­¢ æŸ¥çœ‹ adb ç‰ˆæœ¬ ä»¥ root æƒé™è¿è¡Œ adbd æŒ‡å®š adb server çš„ç½‘ç»œç«¯å£ è®¾å¤‡è¿æ¥ç®¡ç† æŸ¥è¯¢å·²è¿æ¥è®¾å¤‡/æ¨¡æ‹Ÿå™¨ USB è¿æ¥ æ— çº¿è¿æ¥ï¼ˆéœ€è¦å€ŸåŠ© USB çº¿ï¼‰ æ— çº¿è¿æ¥ï¼ˆæ— éœ€å€ŸåŠ© USB çº¿ï¼‰ åº”ç”¨ç®¡ç† æŸ¥çœ‹åº”ç”¨åˆ—è¡¨ æ‰€æœ‰åº”ç”¨ ç³»ç»Ÿåº”ç”¨ ç¬¬ä¸‰æ–¹åº”ç”¨ åŒ…ååŒ…å«æŸå­—ç¬¦ä¸²çš„åº”ç”¨ å®‰è£… APK å¸è½½åº”ç”¨ æ¸…é™¤åº”ç”¨æ•°æ®ä¸ç¼“å­˜ æŸ¥çœ‹å‰å° Activity æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ Services æŸ¥çœ‹åº”ç”¨è¯¦ç»†ä¿¡æ¯ æŸ¥çœ‹åº”ç”¨å®‰è£…è·¯å¾„ ä¸åº”ç”¨äº¤äº’ å¯åŠ¨åº”ç”¨/ è°ƒèµ· Activity è°ƒèµ· Service åœæ­¢ Service å‘é€å¹¿æ’­ å¼ºåˆ¶åœæ­¢åº”ç”¨ æ”¶ç´§å†…å­˜ æ–‡ä»¶ç®¡ç† å¤åˆ¶è®¾å¤‡é‡Œçš„æ–‡ä»¶åˆ°ç”µè„‘ å¤åˆ¶ç”µè„‘é‡Œçš„æ–‡ä»¶åˆ°è®¾å¤‡ æ¨¡æ‹ŸæŒ‰é”®/è¾“å…¥ ç”µæºé”® èœå•é”® HOME é”® è¿”å›é”® éŸ³é‡æ§åˆ¶ åª’ä½“æ§åˆ¶ ç‚¹äº®/ç†„ç­å±å¹• æ»‘åŠ¨è§£é” è¾“å…¥æ–‡æœ¬ æŸ¥çœ‹æ—¥å¿— Android æ—¥å¿— æŒ‰çº§åˆ«è¿‡æ»¤æ—¥å¿— æŒ‰ tag å’Œçº§åˆ«è¿‡æ»¤æ—¥å¿— æ—¥å¿—æ ¼å¼ æ¸…ç©ºæ—¥å¿— å†…æ ¸æ—¥å¿— æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯ å‹å· ç”µæ± çŠ¶å†µ å±å¹•åˆ†è¾¨ç‡ å±å¹•å¯†åº¦ æ˜¾ç¤ºå±å‚æ•° android_id IMEI Android ç³»ç»Ÿç‰ˆæœ¬ IP åœ°å€ Mac åœ°å€ CPU ä¿¡æ¯ å†…å­˜ä¿¡æ¯ æ›´å¤šç¡¬ä»¶ä¸ç³»ç»Ÿå±æ€§ ä¿®æ”¹è®¾ç½® åˆ†è¾¨ç‡ å±å¹•å¯†åº¦ æ˜¾ç¤ºåŒºåŸŸ å…³é—­ USB è°ƒè¯•æ¨¡å¼ å…è®¸/ç¦æ­¢è®¿é—®é SDK API çŠ¶æ€æ å’Œå¯¼èˆªæ çš„æ˜¾ç¤ºéšè— å®ç”¨åŠŸèƒ½ å±å¹•æˆªå›¾ å½•åˆ¶å±å¹• é‡æ–°æŒ‚è½½ system åˆ†åŒºä¸ºå¯å†™ æŸ¥çœ‹è¿æ¥è¿‡çš„ WiFi å¯†ç  è®¾ç½®ç³»ç»Ÿæ—¥æœŸå’Œæ—¶é—´ é‡å¯æ‰‹æœº æ£€æµ‹è®¾å¤‡æ˜¯å¦å·² root ä½¿ç”¨ Monkey è¿›è¡Œå‹åŠ›æµ‹è¯• å¼€å¯/å…³é—­ WiFi åˆ·æœºç›¸å…³å‘½ä»¤ é‡å¯åˆ° Recovery æ¨¡å¼ ä» Recovery é‡å¯åˆ° Android é‡å¯åˆ° Fastboot æ¨¡å¼ é€šè¿‡ sideload æ›´æ–°ç³»ç»Ÿ å®‰å…¨ç›¸å…³å‘½ä»¤ å¯ç”¨/ç¦ç”¨ SELinux å¯ç”¨/ç¦ç”¨ dm_verity æ›´å¤š adb shell å‘½ä»¤ æŸ¥çœ‹è¿›ç¨‹ æŸ¥çœ‹å®æ—¶èµ„æºå ç”¨æƒ…å†µ æŸ¥çœ‹è¿›ç¨‹ UID å…¶å®ƒ å¸¸è§é—®é¢˜ å¯åŠ¨ adb server å¤±è´¥ com.android.ddmlib.AdbCommandRejectedException adb çš„éå®˜æ–¹å®ç° ç›¸å…³å‘½ä»¤ è‡´è°¢ å‚è€ƒé“¾æ¥ åŸºæœ¬ç”¨æ³•å‘½ä»¤è¯­æ³•adb å‘½ä»¤çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š 1adb [-d|-e|-s &lt;serialNumber&gt;] &lt;command&gt; å¦‚æœåªæœ‰ä¸€ä¸ªè®¾å¤‡/æ¨¡æ‹Ÿå™¨è¿æ¥æ—¶ï¼Œå¯ä»¥çœç•¥æ‰ [-d|-e|-s &lt;serialNumber&gt;] è¿™ä¸€éƒ¨åˆ†ï¼Œç›´æ¥ä½¿ç”¨ adb &lt;command&gt;ã€‚ ä¸ºå‘½ä»¤æŒ‡å®šç›®æ ‡è®¾å¤‡å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡/æ¨¡æ‹Ÿå™¨è¿æ¥ï¼Œåˆ™éœ€è¦ä¸ºå‘½ä»¤æŒ‡å®šç›®æ ‡è®¾å¤‡ã€‚ å‚æ•° å«ä¹‰ -d æŒ‡å®šå½“å‰å”¯ä¸€é€šè¿‡ USB è¿æ¥çš„ Android è®¾å¤‡ä¸ºå‘½ä»¤ç›®æ ‡ -e æŒ‡å®šå½“å‰å”¯ä¸€è¿è¡Œçš„æ¨¡æ‹Ÿå™¨ä¸ºå‘½ä»¤ç›®æ ‡ -s &lt;serialNumber&gt; æŒ‡å®šç›¸åº” serialNumber å·çš„è®¾å¤‡/æ¨¡æ‹Ÿå™¨ä¸ºå‘½ä»¤ç›®æ ‡ åœ¨å¤šä¸ªè®¾å¤‡/æ¨¡æ‹Ÿå™¨è¿æ¥çš„æƒ…å†µä¸‹è¾ƒå¸¸ç”¨çš„æ˜¯ -s &lt;serialNumber&gt; å‚æ•°ï¼ŒserialNumber å¯ä»¥é€šè¿‡ adb devices å‘½ä»¤è·å–ã€‚å¦‚ï¼š 123456$ adb devicesList of devices attachedcf264b8f deviceemulator-5554 device10.129.164.6:5555 device è¾“å‡ºé‡Œçš„ cf264b8fã€emulator-5554 å’Œ 10.129.164.6:5555 å³ä¸º serialNumberã€‚ æ¯”å¦‚è¿™æ—¶æƒ³æŒ‡å®š cf264b8f è¿™ä¸ªè®¾å¤‡æ¥è¿è¡Œ adb å‘½ä»¤è·å–å±å¹•åˆ†è¾¨ç‡ï¼š 1adb -s cf264b8f shell wm size åˆå¦‚æƒ³ç»™ 10.129.164.6:5555 è¿™ä¸ªè®¾å¤‡å®‰è£…åº”ç”¨ï¼ˆè¿™ç§å½¢å¼çš„ serialNumber æ ¼å¼ä¸º &lt;IP&gt;:&lt;Port&gt;ï¼Œä¸€èˆ¬ä¸ºæ— çº¿è¿æ¥çš„è®¾å¤‡æˆ– Genymotion ç­‰ç¬¬ä¸‰æ–¹ Android æ¨¡æ‹Ÿå™¨ï¼‰ï¼š 1adb -s 10.129.164.6:5555 install test.apk é‡åˆ°å¤šè®¾å¤‡/æ¨¡æ‹Ÿå™¨çš„æƒ…å†µå‡ä½¿ç”¨è¿™å‡ ä¸ªå‚æ•°ä¸ºå‘½ä»¤æŒ‡å®šç›®æ ‡è®¾å¤‡ï¼Œä¸‹æ–‡ä¸­ä¸ºç®€åŒ–æè¿°ï¼Œä¸å†é‡å¤ã€‚ å¯åŠ¨/åœæ­¢å¯åŠ¨ adb server å‘½ä»¤ï¼š 1adb start-server ï¼ˆä¸€èˆ¬æ— éœ€æ‰‹åŠ¨æ‰§è¡Œæ­¤å‘½ä»¤ï¼Œåœ¨è¿è¡Œ adb å‘½ä»¤æ—¶è‹¥å‘ç° adb server æ²¡æœ‰å¯åŠ¨ä¼šè‡ªåŠ¨è°ƒèµ·ã€‚ï¼‰ åœæ­¢ adb server å‘½ä»¤ï¼š 1adb kill-server æŸ¥çœ‹ adb ç‰ˆæœ¬å‘½ä»¤ï¼š 1adb version ç¤ºä¾‹è¾“å‡ºï¼š 12Android Debug Bridge version 1.0.36Revision 8f855a3d9b35-android ä»¥ root æƒé™è¿è¡Œ adbdadb çš„è¿è¡ŒåŸç†æ˜¯ PC ç«¯çš„ adb server ä¸æ‰‹æœºç«¯çš„å®ˆæŠ¤è¿›ç¨‹ adbd å»ºç«‹è¿æ¥ï¼Œç„¶å PC ç«¯çš„ adb client é€šè¿‡ adb server è½¬å‘å‘½ä»¤ï¼Œadbd æ¥æ”¶å‘½ä»¤åè§£æè¿è¡Œã€‚ æ‰€ä»¥å¦‚æœ adbd ä»¥æ™®é€šæƒé™æ‰§è¡Œï¼Œæœ‰äº›éœ€è¦ root æƒé™æ‰èƒ½æ‰§è¡Œçš„å‘½ä»¤æ— æ³•ç›´æ¥ç”¨ adb xxx æ‰§è¡Œã€‚è¿™æ—¶å¯ä»¥ adb shell ç„¶å su åæ‰§è¡Œå‘½ä»¤ï¼Œä¹Ÿå¯ä»¥è®© adbd ä»¥ root æƒé™æ‰§è¡Œï¼Œè¿™ä¸ªå°±èƒ½éšæ„æ‰§è¡Œé«˜æƒé™å‘½ä»¤äº†ã€‚ å‘½ä»¤ï¼š 1adb root æ­£å¸¸è¾“å‡ºï¼š 1restarting adbd as root ç°åœ¨å†è¿è¡Œ adb shellï¼Œçœ‹çœ‹å‘½ä»¤è¡Œæç¤ºç¬¦æ˜¯ä¸æ˜¯å˜æˆ # äº†ï¼Ÿ æœ‰äº›æ‰‹æœº root åä¹Ÿæ— æ³•é€šè¿‡ adb root å‘½ä»¤è®© adbd ä»¥ root æƒé™æ‰§è¡Œï¼Œæ¯”å¦‚ä¸‰æ˜Ÿçš„éƒ¨åˆ†æœºå‹ï¼Œä¼šæç¤º adbd cannot run as root in production buildsï¼Œæ­¤æ—¶å¯ä»¥å…ˆå®‰è£… adbd Insecureï¼Œç„¶å adb root è¯•è¯•ã€‚ ç›¸åº”åœ°ï¼Œå¦‚æœè¦æ¢å¤ adbd ä¸ºé root æƒé™çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨ adb unroot å‘½ä»¤ã€‚ æŒ‡å®š adb server çš„ç½‘ç»œç«¯å£å‘½ä»¤ï¼š 1adb -P &lt;port&gt; start-server é»˜è®¤ç«¯å£ä¸º 5037ã€‚ è®¾å¤‡è¿æ¥ç®¡ç†æŸ¥è¯¢å·²è¿æ¥è®¾å¤‡/æ¨¡æ‹Ÿå™¨å‘½ä»¤ï¼š 1adb devices è¾“å‡ºç¤ºä¾‹ï¼š 1234List of devices attachedcf264b8f deviceemulator-5554 device10.129.164.6:5555 device è¾“å‡ºæ ¼å¼ä¸º [serialNumber] [state]ï¼ŒserialNumber å³æˆ‘ä»¬å¸¸è¯´çš„ SNï¼Œstate æœ‰å¦‚ä¸‹å‡ ç§ï¼š offline â€”â€” è¡¨ç¤ºè®¾å¤‡æœªè¿æ¥æˆåŠŸæˆ–æ— å“åº”ã€‚ device â€”â€” è®¾å¤‡å·²è¿æ¥ã€‚æ³¨æ„è¿™ä¸ªçŠ¶æ€å¹¶ä¸èƒ½æ ‡è¯† Android ç³»ç»Ÿå·²ç»å®Œå…¨å¯åŠ¨å’Œå¯æ“ä½œï¼Œåœ¨è®¾å¤‡å¯åŠ¨è¿‡ç¨‹ä¸­è®¾å¤‡å®ä¾‹å°±å¯è¿æ¥åˆ° adbï¼Œä½†å¯åŠ¨å®Œæ¯•åç³»ç»Ÿæ‰å¤„äºå¯æ“ä½œçŠ¶æ€ã€‚ no device â€”â€” æ²¡æœ‰è®¾å¤‡/æ¨¡æ‹Ÿå™¨è¿æ¥ã€‚ ä»¥ä¸Šè¾“å‡ºæ˜¾ç¤ºå½“å‰å·²ç»è¿æ¥äº†ä¸‰å°è®¾å¤‡/æ¨¡æ‹Ÿå™¨ï¼Œcf264b8fã€emulator-5554 å’Œ 10.129.164.6:5555 åˆ†åˆ«æ˜¯å®ƒä»¬çš„ SNã€‚ä» emulator-5554 è¿™ä¸ªåå­—å¯ä»¥çœ‹å‡ºå®ƒæ˜¯ä¸€ä¸ª Android æ¨¡æ‹Ÿå™¨ï¼Œè€Œ 10.129.164.6:5555 è¿™ç§å½¢ä¸º &lt;IP&gt;:&lt;Port&gt; çš„ serialNumber ä¸€èˆ¬æ˜¯æ— çº¿è¿æ¥çš„è®¾å¤‡æˆ– Genymotion ç­‰ç¬¬ä¸‰æ–¹ Android æ¨¡æ‹Ÿå™¨ã€‚ å¸¸è§å¼‚å¸¸è¾“å‡ºï¼š æ²¡æœ‰è®¾å¤‡/æ¨¡æ‹Ÿå™¨è¿æ¥æˆåŠŸã€‚ 1List of devices attached è®¾å¤‡/æ¨¡æ‹Ÿå™¨æœªè¿æ¥åˆ° adb æˆ–æ— å“åº”ã€‚ 12List of devices attachedcf264b8f offline USB è¿æ¥é€šè¿‡ USB è¿æ¥æ¥æ­£å¸¸ä½¿ç”¨ adb éœ€è¦ä¿è¯å‡ ç‚¹ï¼š ç¡¬ä»¶çŠ¶æ€æ­£å¸¸ã€‚ åŒ…æ‹¬ Android è®¾å¤‡å¤„äºæ­£å¸¸å¼€æœºçŠ¶æ€ï¼ŒUSB è¿æ¥çº¿å’Œå„ç§æ¥å£å®Œå¥½ã€‚ Android è®¾å¤‡çš„å¼€å‘è€…é€‰é¡¹å’Œ USB è°ƒè¯•æ¨¡å¼å·²å¼€å¯ã€‚ å¯ä»¥åˆ°ã€Œè®¾ç½®ã€-ã€Œå¼€å‘è€…é€‰é¡¹ã€-ã€ŒAndroid è°ƒè¯•ã€æŸ¥çœ‹ã€‚ å¦‚æœåœ¨è®¾ç½®é‡Œæ‰¾ä¸åˆ°å¼€å‘è€…é€‰é¡¹ï¼Œé‚£éœ€è¦é€šè¿‡ä¸€ä¸ªå½©è›‹æ¥è®©å®ƒæ˜¾ç¤ºå‡ºæ¥ï¼šåœ¨ã€Œè®¾ç½®ã€-ã€Œå…³äºæ‰‹æœºã€è¿ç»­ç‚¹å‡»ã€Œç‰ˆæœ¬å·ã€7 æ¬¡ã€‚ è®¾å¤‡é©±åŠ¨çŠ¶æ€æ­£å¸¸ã€‚ è¿™ä¸€ç‚¹è²Œä¼¼åœ¨ Linux å’Œ Mac OS X ä¸‹ä¸ç”¨æ“å¿ƒï¼Œåœ¨ Windows ä¸‹æœ‰å¯èƒ½é‡åˆ°éœ€è¦å®‰è£…é©±åŠ¨çš„æƒ…å†µï¼Œç¡®è®¤è¿™ä¸€ç‚¹å¯ä»¥å³é”®ã€Œè®¡ç®—æœºã€-ã€Œå±æ€§ã€ï¼Œåˆ°ã€Œè®¾å¤‡ç®¡ç†å™¨ã€é‡ŒæŸ¥çœ‹ç›¸å…³è®¾å¤‡ä¸Šæ˜¯å¦æœ‰é»„è‰²æ„Ÿå¹å·æˆ–é—®å·ï¼Œå¦‚æœæ²¡æœ‰å°±è¯´æ˜é©±åŠ¨çŠ¶æ€å·²ç»å¥½äº†ã€‚å¦åˆ™å¯ä»¥ä¸‹è½½ä¸€ä¸ªæ‰‹æœºåŠ©æ‰‹ç±»ç¨‹åºæ¥å®‰è£…é©±åŠ¨å…ˆã€‚ é€šè¿‡ USB çº¿è¿æ¥å¥½ç”µè„‘å’Œè®¾å¤‡åç¡®è®¤çŠ¶æ€ã€‚ 1adb devices å¦‚æœèƒ½çœ‹åˆ° 1xxxxxx device è¯´æ˜è¿æ¥æˆåŠŸã€‚ æ— çº¿è¿æ¥ï¼ˆéœ€è¦å€ŸåŠ© USB çº¿ï¼‰é™¤äº†å¯ä»¥é€šè¿‡ USB è¿æ¥è®¾å¤‡ä¸ç”µè„‘æ¥ä½¿ç”¨ adbï¼Œä¹Ÿå¯ä»¥é€šè¿‡æ— çº¿è¿æ¥â€”â€”è™½ç„¶è¿æ¥è¿‡ç¨‹ä¸­ä¹Ÿæœ‰éœ€è¦ä½¿ç”¨ USB çš„æ­¥éª¤ï¼Œä½†æ˜¯è¿æ¥æˆåŠŸä¹‹åä½ çš„è®¾å¤‡å°±å¯ä»¥åœ¨ä¸€å®šèŒƒå›´å†…æ‘†è„± USB è¿æ¥çº¿çš„é™åˆ¶å•¦ï¼ æ“ä½œæ­¥éª¤ï¼š å°† Android è®¾å¤‡ä¸è¦è¿è¡Œ adb çš„ç”µè„‘è¿æ¥åˆ°åŒä¸€ä¸ªå±€åŸŸç½‘ï¼Œæ¯”å¦‚è¿åˆ°åŒä¸€ä¸ª WiFiã€‚ å°†è®¾å¤‡ä¸ç”µè„‘é€šè¿‡ USB çº¿è¿æ¥ã€‚ åº”ç¡®ä¿è¿æ¥æˆåŠŸï¼ˆå¯è¿è¡Œ adb devices çœ‹æ˜¯å¦èƒ½åˆ—å‡ºè¯¥è®¾å¤‡ï¼‰ã€‚ è®©è®¾å¤‡åœ¨ 5555 ç«¯å£ç›‘å¬ TCP/IP è¿æ¥ï¼š 1adb tcpip 5555 æ–­å¼€ USB è¿æ¥ã€‚ æ‰¾åˆ°è®¾å¤‡çš„ IP åœ°å€ã€‚ ä¸€èˆ¬èƒ½åœ¨ã€Œè®¾ç½®ã€-ã€Œå…³äºæ‰‹æœºã€-ã€ŒçŠ¶æ€ä¿¡æ¯ã€-ã€ŒIPåœ°å€ã€æ‰¾åˆ°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹æ–‡é‡Œ æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯ - IP åœ°å€ ä¸€èŠ‚é‡Œçš„æ–¹æ³•ç”¨ adb å‘½ä»¤æ¥æŸ¥çœ‹ã€‚ é€šè¿‡ IP åœ°å€è¿æ¥è®¾å¤‡ã€‚ 1adb connect &lt;device-ip-address&gt; è¿™é‡Œçš„ &lt;device-ip-address&gt; å°±æ˜¯ä¸Šä¸€æ­¥ä¸­æ‰¾åˆ°çš„è®¾å¤‡ IP åœ°å€ã€‚ ç¡®è®¤è¿æ¥çŠ¶æ€ã€‚ 1adb devices å¦‚æœèƒ½çœ‹åˆ° 1&lt;device-ip-address&gt;:5555 device è¯´æ˜è¿æ¥æˆåŠŸã€‚ å¦‚æœè¿æ¥ä¸äº†ï¼Œè¯·ç¡®è®¤ Android è®¾å¤‡ä¸ç”µè„‘æ˜¯è¿æ¥åˆ°äº†åŒä¸€ä¸ª WiFiï¼Œç„¶åå†æ¬¡æ‰§è¡Œ adb connect &lt;device-ip-address&gt; é‚£ä¸€æ­¥ï¼› å¦‚æœè¿˜æ˜¯ä¸è¡Œçš„è¯ï¼Œé€šè¿‡ adb kill-server é‡æ–°å¯åŠ¨ adb ç„¶åä»å¤´å†æ¥ä¸€æ¬¡è¯•è¯•ã€‚ æ–­å¼€æ— çº¿è¿æ¥ å‘½ä»¤ï¼š 1adb disconnect &lt;device-ip-address&gt; æ— çº¿è¿æ¥ï¼ˆæ— éœ€å€ŸåŠ© USB çº¿ï¼‰æ³¨ï¼šéœ€è¦ root æƒé™ã€‚ ä¸Šä¸€èŠ‚ã€Œæ— çº¿è¿æ¥ï¼ˆéœ€è¦å€ŸåŠ© USB çº¿ï¼‰ã€æ˜¯å®˜æ–¹æ–‡æ¡£é‡Œä»‹ç»çš„æ–¹æ³•ï¼Œéœ€è¦å€ŸåŠ©äº USB æ•°æ®çº¿æ¥å®ç°æ— çº¿è¿æ¥ã€‚ æ—¢ç„¶æˆ‘ä»¬æƒ³è¦å®ç°æ— çº¿è¿æ¥ï¼Œé‚£èƒ½ä¸èƒ½æ‰€æœ‰æ­¥éª¤ä¸‹æ¥éƒ½æ˜¯æ— çº¿çš„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯èƒ½çš„ã€‚ åœ¨ Android è®¾å¤‡ä¸Šå®‰è£…ä¸€ä¸ªç»ˆç«¯æ¨¡æ‹Ÿå™¨ã€‚ å·²ç»å®‰è£…è¿‡çš„è®¾å¤‡å¯ä»¥è·³è¿‡æ­¤æ­¥ã€‚æˆ‘ä½¿ç”¨çš„ç»ˆç«¯æ¨¡æ‹Ÿå™¨ä¸‹è½½åœ°å€æ˜¯ï¼šTerminal Emulator for Android Downloads å°† Android è®¾å¤‡ä¸è¦è¿è¡Œ adb çš„ç”µè„‘è¿æ¥åˆ°åŒä¸€ä¸ªå±€åŸŸç½‘ï¼Œæ¯”å¦‚è¿åˆ°åŒä¸€ä¸ª WiFiã€‚ æ‰“å¼€ Android è®¾å¤‡ä¸Šçš„ç»ˆç«¯æ¨¡æ‹Ÿå™¨ï¼Œåœ¨é‡Œé¢ä¾æ¬¡è¿è¡Œå‘½ä»¤ï¼š 12susetprop service.adb.tcp.port 5555 æ‰¾åˆ° Android è®¾å¤‡çš„ IP åœ°å€ã€‚ ä¸€èˆ¬èƒ½åœ¨ã€Œè®¾ç½®ã€-ã€Œå…³äºæ‰‹æœºã€-ã€ŒçŠ¶æ€ä¿¡æ¯ã€-ã€ŒIPåœ°å€ã€æ‰¾åˆ°ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹æ–‡é‡Œ æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯ - IP åœ°å€ ä¸€èŠ‚é‡Œçš„æ–¹æ³•ç”¨ adb å‘½ä»¤æ¥æŸ¥çœ‹ã€‚ åœ¨ç”µè„‘ä¸Šé€šè¿‡ adb å’Œ IP åœ°å€è¿æ¥ Android è®¾å¤‡ã€‚ 1adb connect &lt;device-ip-address&gt; è¿™é‡Œçš„ &lt;device-ip-address&gt; å°±æ˜¯ä¸Šä¸€æ­¥ä¸­æ‰¾åˆ°çš„è®¾å¤‡ IP åœ°å€ã€‚ å¦‚æœèƒ½çœ‹åˆ° connected to &lt;device-ip-address&gt;:5555 è¿™æ ·çš„è¾“å‡ºåˆ™è¡¨ç¤ºè¿æ¥æˆåŠŸã€‚ èŠ‚æ³¨ä¸€ï¼š æœ‰çš„è®¾å¤‡ï¼Œæ¯”å¦‚å°ç±³ 5S + MIUI 8.0 + Android 6.0.1 MXB48Tï¼Œå¯èƒ½åœ¨ç¬¬ 5 æ­¥ä¹‹å‰éœ€è¦é‡å¯ adbd æœåŠ¡ï¼Œåœ¨è®¾å¤‡çš„ç»ˆç«¯æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œï¼š 1restart adbd å¦‚æœ restart æ— æ•ˆï¼Œå°è¯•ä»¥ä¸‹å‘½ä»¤ï¼š 12stop adbdstart adbd åº”ç”¨ç®¡ç†æŸ¥çœ‹åº”ç”¨åˆ—è¡¨æŸ¥çœ‹åº”ç”¨åˆ—è¡¨çš„åŸºæœ¬å‘½ä»¤æ ¼å¼æ˜¯ 1adb shell pm list packages [-f] [-d] [-e] [-s] [-3] [-i] [-u] [--user USER_ID] [FILTER] å³åœ¨ adb shell pm list packages çš„åŸºç¡€ä¸Šå¯ä»¥åŠ ä¸€äº›å‚æ•°è¿›è¡Œè¿‡æ»¤æŸ¥çœ‹ä¸åŒçš„åˆ—è¡¨ï¼Œæ”¯æŒçš„è¿‡æ»¤å‚æ•°å¦‚ä¸‹ï¼š å‚æ•° æ˜¾ç¤ºåˆ—è¡¨ æ—  æ‰€æœ‰åº”ç”¨ -f æ˜¾ç¤ºåº”ç”¨å…³è”çš„ apk æ–‡ä»¶ -d åªæ˜¾ç¤º disabled çš„åº”ç”¨ -e åªæ˜¾ç¤º enabled çš„åº”ç”¨ -s åªæ˜¾ç¤ºç³»ç»Ÿåº”ç”¨ -3 åªæ˜¾ç¤ºç¬¬ä¸‰æ–¹åº”ç”¨ -i æ˜¾ç¤ºåº”ç”¨çš„ installer -u åŒ…å«å·²å¸è½½åº”ç”¨ &lt;FILTER&gt; åŒ…ååŒ…å« &lt;FILTER&gt; å­—ç¬¦ä¸² æ‰€æœ‰åº”ç”¨å‘½ä»¤ï¼š 1adb shell pm list packages è¾“å‡ºç¤ºä¾‹ï¼š 12345678910111213package:com.android.smoketestpackage:com.example.android.livecubespackage:com.android.providers.telephonypackage:com.google.android.googlequicksearchboxpackage:com.android.providers.calendarpackage:com.android.providers.mediapackage:com.android.protipspackage:com.android.documentsuipackage:com.android.gallerypackage:com.android.externalstorage...// other packages here... ç³»ç»Ÿåº”ç”¨å‘½ä»¤ï¼š 1adb shell pm list packages -s ç¬¬ä¸‰æ–¹åº”ç”¨å‘½ä»¤ï¼š 1adb shell pm list packages -3 åŒ…ååŒ…å«æŸå­—ç¬¦ä¸²çš„åº”ç”¨æ¯”å¦‚è¦æŸ¥çœ‹åŒ…ååŒ…å«å­—ç¬¦ä¸² mazhuang çš„åº”ç”¨åˆ—è¡¨ï¼Œå‘½ä»¤ï¼š 1adb shell pm list packages mazhuang å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨ grep æ¥è¿‡æ»¤ï¼š 1adb shell pm list packages | grep mazhuang å®‰è£… APKå‘½ä»¤æ ¼å¼ï¼š 1adb install [-lrtsdg] &lt;path_to_apk&gt; å‚æ•°ï¼š adb install åé¢å¯ä»¥è·Ÿä¸€äº›å¯é€‰å‚æ•°æ¥æ§åˆ¶å®‰è£… APK çš„è¡Œä¸ºï¼Œå¯ç”¨å‚æ•°åŠå«ä¹‰å¦‚ä¸‹ï¼š å‚æ•° å«ä¹‰ -l å°†åº”ç”¨å®‰è£…åˆ°ä¿æŠ¤ç›®å½• /mnt/asec -r å…è®¸è¦†ç›–å®‰è£… -t å…è®¸å®‰è£… AndroidManifest.xml é‡Œ application æŒ‡å®š android:testOnly=&quot;true&quot; çš„åº”ç”¨ -s å°†åº”ç”¨å®‰è£…åˆ° sdcard -d å…è®¸é™çº§è¦†ç›–å®‰è£… -g æˆäºˆæ‰€æœ‰è¿è¡Œæ—¶æƒé™ è¿è¡Œå‘½ä»¤åå¦‚æœè§åˆ°ç±»ä¼¼å¦‚ä¸‹è¾“å‡ºï¼ˆçŠ¶æ€ä¸º Successï¼‰ä»£è¡¨å®‰è£…æˆåŠŸï¼š 123[100%] /data/local/tmp/1.apk pkg: /data/local/tmp/1.apkSuccess ä¸Šé¢æ˜¯å½“å‰æœ€æ–°ç‰ˆ v1.0.36 çš„ adb çš„è¾“å‡ºï¼Œä¼šæ˜¾ç¤º push apk æ–‡ä»¶åˆ°æ‰‹æœºçš„è¿›åº¦ç™¾åˆ†æ¯”ã€‚ ä½¿ç”¨æ—§ç‰ˆæœ¬ adb çš„è¾“å‡ºåˆ™æ˜¯è¿™æ ·çš„ï¼š 12312040 KB/s (22205609 bytes in 1.801s) pkg: /data/local/tmp/SogouInput_android_v8.3_sweb.apkSuccess è€Œå¦‚æœçŠ¶æ€ä¸º Failure åˆ™è¡¨ç¤ºå®‰è£…å¤±è´¥ï¼Œæ¯”å¦‚ï¼š 123[100%] /data/local/tmp/map-20160831.apk pkg: /data/local/tmp/map-20160831.apkFailure [INSTALL_FAILED_ALREADY_EXISTS] å¸¸è§å®‰è£…å¤±è´¥è¾“å‡ºä»£ç ã€å«ä¹‰åŠå¯èƒ½çš„è§£å†³åŠæ³•å¦‚ä¸‹ï¼š è¾“å‡º å«ä¹‰ è§£å†³åŠæ³• INSTALL_FAILED_ALREADY_EXISTS åº”ç”¨å·²ç»å­˜åœ¨ï¼Œæˆ–å¸è½½äº†ä½†æ²¡å¸è½½å¹²å‡€ adb install æ—¶ä½¿ç”¨ -r å‚æ•°ï¼Œæˆ–è€…å…ˆ adb uninstall &lt;packagename&gt; å†å®‰è£… INSTALL_FAILED_INVALID_APK æ— æ•ˆçš„ APK æ–‡ä»¶ INSTALL_FAILED_INVALID_URI æ— æ•ˆçš„ APK æ–‡ä»¶å ç¡®ä¿ APK æ–‡ä»¶åé‡Œæ— ä¸­æ–‡ INSTALL_FAILED_INSUFFICIENT_STORAGE ç©ºé—´ä¸è¶³ æ¸…ç†ç©ºé—´ INSTALL_FAILED_DUPLICATE_PACKAGE å·²ç»å­˜åœ¨åŒåç¨‹åº INSTALL_FAILED_NO_SHARED_USER è¯·æ±‚çš„å…±äº«ç”¨æˆ·ä¸å­˜åœ¨ INSTALL_FAILED_UPDATE_INCOMPATIBLE ä»¥å‰å®‰è£…è¿‡åŒååº”ç”¨ï¼Œä½†å¸è½½æ—¶æ•°æ®æ²¡æœ‰ç§»é™¤ï¼›æˆ–è€…å·²å®‰è£…è¯¥åº”ç”¨ï¼Œä½†ç­¾åä¸ä¸€è‡´ å…ˆ adb uninstall &lt;packagename&gt; å†å®‰è£… INSTALL_FAILED_SHARED_USER_INCOMPATIBLE è¯·æ±‚çš„å…±äº«ç”¨æˆ·å­˜åœ¨ä½†ç­¾åä¸ä¸€è‡´ INSTALL_FAILED_MISSING_SHARED_LIBRARY å®‰è£…åŒ…ä½¿ç”¨äº†è®¾å¤‡ä¸Šä¸å¯ç”¨çš„å…±äº«åº“ INSTALL_FAILED_REPLACE_COULDNT_DELETE æ›¿æ¢æ—¶æ— æ³•åˆ é™¤ INSTALL_FAILED_DEXOPT dex ä¼˜åŒ–éªŒè¯å¤±è´¥æˆ–ç©ºé—´ä¸è¶³ INSTALL_FAILED_OLDER_SDK è®¾å¤‡ç³»ç»Ÿç‰ˆæœ¬ä½äºåº”ç”¨è¦æ±‚ INSTALL_FAILED_CONFLICTING_PROVIDER è®¾å¤‡é‡Œå·²ç»å­˜åœ¨ä¸åº”ç”¨é‡ŒåŒåçš„ content provider INSTALL_FAILED_NEWER_SDK è®¾å¤‡ç³»ç»Ÿç‰ˆæœ¬é«˜äºåº”ç”¨è¦æ±‚ INSTALL_FAILED_TEST_ONLY åº”ç”¨æ˜¯ test-only çš„ï¼Œä½†å®‰è£…æ—¶æ²¡æœ‰æŒ‡å®š -t å‚æ•° INSTALL_FAILED_CPU_ABI_INCOMPATIBLE åŒ…å«ä¸å…¼å®¹è®¾å¤‡ CPU åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£çš„ native code INSTALL_FAILED_MISSING_FEATURE åº”ç”¨ä½¿ç”¨äº†è®¾å¤‡ä¸å¯ç”¨çš„åŠŸèƒ½ INSTALL_FAILED_CONTAINER_ERROR 1. sdcard è®¿é—®å¤±è´¥;2. åº”ç”¨ç­¾åä¸ ROM ç­¾åä¸€è‡´ï¼Œè¢«å½“ä½œå†…ç½®åº”ç”¨ã€‚ 1. ç¡®è®¤ sdcard å¯ç”¨ï¼Œæˆ–è€…å®‰è£…åˆ°å†…ç½®å­˜å‚¨;2. æ‰“åŒ…æ—¶ä¸ä¸ ROM ä½¿ç”¨ç›¸åŒç­¾åã€‚ INSTALL_FAILED_INVALID_INSTALL_LOCATION 1. ä¸èƒ½å®‰è£…åˆ°æŒ‡å®šä½ç½®;2. åº”ç”¨ç­¾åä¸ ROM ç­¾åä¸€è‡´ï¼Œè¢«å½“ä½œå†…ç½®åº”ç”¨ã€‚ 1. åˆ‡æ¢å®‰è£…ä½ç½®ï¼Œæ·»åŠ æˆ–åˆ é™¤ -s å‚æ•°;2. æ‰“åŒ…æ—¶ä¸ä¸ ROM ä½¿ç”¨ç›¸åŒç­¾åã€‚ INSTALL_FAILED_MEDIA_UNAVAILABLE å®‰è£…ä½ç½®ä¸å¯ç”¨ ä¸€èˆ¬ä¸º sdcardï¼Œç¡®è®¤ sdcard å¯ç”¨æˆ–å®‰è£…åˆ°å†…ç½®å­˜å‚¨ INSTALL_FAILED_VERIFICATION_TIMEOUT éªŒè¯å®‰è£…åŒ…è¶…æ—¶ INSTALL_FAILED_VERIFICATION_FAILURE éªŒè¯å®‰è£…åŒ…å¤±è´¥ INSTALL_FAILED_PACKAGE_CHANGED åº”ç”¨ä¸è°ƒç”¨ç¨‹åºæœŸæœ›çš„ä¸ä¸€è‡´ INSTALL_FAILED_UID_CHANGED ä»¥å‰å®‰è£…è¿‡è¯¥åº”ç”¨ï¼Œä¸æœ¬æ¬¡åˆ†é…çš„ UID ä¸ä¸€è‡´ æ¸…é™¤ä»¥å‰å®‰è£…è¿‡çš„æ®‹ç•™æ–‡ä»¶ INSTALL_FAILED_VERSION_DOWNGRADE å·²ç»å®‰è£…äº†è¯¥åº”ç”¨æ›´é«˜ç‰ˆæœ¬ ä½¿ç”¨ -d å‚æ•° INSTALL_FAILED_PERMISSION_MODEL_DOWNGRADE å·²å®‰è£… target SDK æ”¯æŒè¿è¡Œæ—¶æƒé™çš„åŒååº”ç”¨ï¼Œè¦å®‰è£…çš„ç‰ˆæœ¬ä¸æ”¯æŒè¿è¡Œæ—¶æƒé™ INSTALL_PARSE_FAILED_NOT_APK æŒ‡å®šè·¯å¾„ä¸æ˜¯æ–‡ä»¶ï¼Œæˆ–ä¸æ˜¯ä»¥ .apk ç»“å°¾ INSTALL_PARSE_FAILED_BAD_MANIFEST æ— æ³•è§£æçš„ AndroidManifest.xml æ–‡ä»¶ INSTALL_PARSE_FAILED_UNEXPECTED_EXCEPTION è§£æå™¨é‡åˆ°å¼‚å¸¸ INSTALL_PARSE_FAILED_NO_CERTIFICATES å®‰è£…åŒ…æ²¡æœ‰ç­¾å INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATES å·²å®‰è£…è¯¥åº”ç”¨ï¼Œä¸”ç­¾åä¸ APK æ–‡ä»¶ä¸ä¸€è‡´ å…ˆå¸è½½è®¾å¤‡ä¸Šçš„è¯¥åº”ç”¨ï¼Œå†å®‰è£… INSTALL_PARSE_FAILED_CERTIFICATE_ENCODING è§£æ APK æ–‡ä»¶æ—¶é‡åˆ° CertificateEncodingException INSTALL_PARSE_FAILED_BAD_PACKAGE_NAME manifest æ–‡ä»¶é‡Œæ²¡æœ‰æˆ–è€…ä½¿ç”¨äº†æ— æ•ˆçš„åŒ…å INSTALL_PARSE_FAILED_BAD_SHARED_USER_ID manifest æ–‡ä»¶é‡ŒæŒ‡å®šäº†æ— æ•ˆçš„å…±äº«ç”¨æˆ· ID INSTALL_PARSE_FAILED_MANIFEST_MALFORMED è§£æ manifest æ–‡ä»¶æ—¶é‡åˆ°ç»“æ„æ€§é”™è¯¯ INSTALL_PARSE_FAILED_MANIFEST_EMPTY åœ¨ manifest æ–‡ä»¶é‡Œæ‰¾ä¸åˆ°æ‰¾å¯æ“ä½œæ ‡ç­¾ï¼ˆinstrumentation æˆ– applicationï¼‰ INSTALL_FAILED_INTERNAL_ERROR å› ç³»ç»Ÿé—®é¢˜å®‰è£…å¤±è´¥ INSTALL_FAILED_USER_RESTRICTED ç”¨æˆ·è¢«é™åˆ¶å®‰è£…åº”ç”¨ åœ¨å¼€å‘è€…é€‰é¡¹é‡Œå°†ã€ŒUSBå®‰è£…ã€æ‰“å¼€ï¼Œå¦‚æœå·²ç»æ‰“å¼€äº†ï¼Œé‚£å…ˆå…³é—­å†æ‰“å¼€ã€‚ INSTALL_FAILED_DUPLICATE_PERMISSION åº”ç”¨å°è¯•å®šä¹‰ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æƒé™åç§° INSTALL_FAILED_NO_MATCHING_ABIS åº”ç”¨åŒ…å«è®¾å¤‡çš„åº”ç”¨ç¨‹åºäºŒè¿›åˆ¶æ¥å£ä¸æ”¯æŒçš„ native code INSTALL_CANCELED_BY_USER åº”ç”¨å®‰è£…éœ€è¦åœ¨è®¾å¤‡ä¸Šç¡®è®¤ï¼Œä½†æœªæ“ä½œè®¾å¤‡æˆ–ç‚¹äº†å–æ¶ˆ åœ¨è®¾å¤‡ä¸ŠåŒæ„å®‰è£… INSTALL_FAILED_ACWF_INCOMPATIBLE åº”ç”¨ç¨‹åºä¸è®¾å¤‡ä¸å…¼å®¹ INSTALL_FAILED_TEST_ONLY APK æ–‡ä»¶æ˜¯ä½¿ç”¨ Android Studio ç›´æ¥ RUN ç¼–è¯‘å‡ºæ¥çš„æ–‡ä»¶ é€šè¿‡ Gradle çš„ assembleDebug æˆ– assembleRelease é‡æ–°ç¼–è¯‘ï¼Œæˆ–è€… Generate Signed APK does not contain AndroidManifest.xml æ— æ•ˆçš„ APK æ–‡ä»¶ is not a valid zip file æ— æ•ˆçš„ APK æ–‡ä»¶ Offline è®¾å¤‡æœªè¿æ¥æˆåŠŸ å…ˆå°†è®¾å¤‡ä¸ adb è¿æ¥æˆåŠŸ unauthorized è®¾å¤‡æœªæˆæƒå…è®¸è°ƒè¯• error: device not found æ²¡æœ‰è¿æ¥æˆåŠŸçš„è®¾å¤‡ å…ˆå°†è®¾å¤‡ä¸ adb è¿æ¥æˆåŠŸ protocol failure è®¾å¤‡å·²æ–­å¼€è¿æ¥ å…ˆå°†è®¾å¤‡ä¸ adb è¿æ¥æˆåŠŸ Unknown option: -s Android 2.2 ä»¥ä¸‹ä¸æ”¯æŒå®‰è£…åˆ° sdcard ä¸ä½¿ç”¨ -s å‚æ•° No space left on device ç©ºé—´ä¸è¶³ æ¸…ç†ç©ºé—´ Permission denied â€¦ sdcard â€¦ sdcard ä¸å¯ç”¨ signatures do not match the previously installed version; ignoring! å·²å®‰è£…è¯¥åº”ç”¨ä¸”ç­¾åä¸ä¸€è‡´ å…ˆå¸è½½è®¾å¤‡ä¸Šçš„è¯¥åº”ç”¨ï¼Œå†å®‰è£… å‚è€ƒï¼šPackageManager.java adb install å†…éƒ¨åŸç†ç®€ä»‹ adb install å®é™…æ˜¯åˆ†ä¸‰æ­¥å®Œæˆï¼š push apk æ–‡ä»¶åˆ° /data/local/tmpã€‚ è°ƒç”¨ pm install å®‰è£…ã€‚ åˆ é™¤ /data/local/tmp ä¸‹çš„å¯¹åº” apk æ–‡ä»¶ã€‚ æ‰€ä»¥ï¼Œå¿…è¦çš„æ—¶å€™ä¹Ÿå¯ä»¥æ ¹æ®è¿™ä¸ªæ­¥éª¤ï¼Œæ‰‹åŠ¨åˆ†æ­¥æ‰§è¡Œå®‰è£…è¿‡ç¨‹ã€‚ å¸è½½åº”ç”¨å‘½ä»¤ï¼š 1adb uninstall [-k] &lt;packagename&gt; &lt;packagename&gt; è¡¨ç¤ºåº”ç”¨çš„åŒ…åï¼Œ-k å‚æ•°å¯é€‰ï¼Œè¡¨ç¤ºå¸è½½åº”ç”¨ä½†ä¿ç•™æ•°æ®å’Œç¼“å­˜ç›®å½•ã€‚ å‘½ä»¤ç¤ºä¾‹ï¼š 1adb uninstall com.qihoo360.mobilesafe è¡¨ç¤ºå¸è½½ 360 æ‰‹æœºå«å£«ã€‚ æ¸…é™¤åº”ç”¨æ•°æ®ä¸ç¼“å­˜å‘½ä»¤ï¼š 1adb shell pm clear &lt;packagename&gt; &lt;packagename&gt; è¡¨ç¤ºåº”ç”¨ååŒ…ï¼Œè¿™æ¡å‘½ä»¤çš„æ•ˆæœç›¸å½“äºåœ¨è®¾ç½®é‡Œçš„åº”ç”¨ä¿¡æ¯ç•Œé¢ç‚¹å‡»äº†ã€Œæ¸…é™¤ç¼“å­˜ã€å’Œã€Œæ¸…é™¤æ•°æ®ã€ã€‚ å‘½ä»¤ç¤ºä¾‹ï¼š 1adb shell pm clear com.qihoo360.mobilesafe è¡¨ç¤ºæ¸…é™¤ 360 æ‰‹æœºå«å£«çš„æ•°æ®å’Œç¼“å­˜ã€‚ æŸ¥çœ‹å‰å° Activityå‘½ä»¤ï¼š 1adb shell dumpsys activity activities | grep mFocusedActivity è¾“å‡ºç¤ºä¾‹ï¼š 1mFocusedActivity: ActivityRecord{8079d7e u0 com.cyanogenmod.trebuchet/com.android.launcher3.Launcher t42} å…¶ä¸­çš„ com.cyanogenmod.trebuchet/com.android.launcher3.Launcher å°±æ˜¯å½“å‰å¤„äºå‰å°çš„ Activityã€‚ æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„ Serviceså‘½ä»¤ï¼š 1adb shell dumpsys activity services [&lt;packagename&gt;] &lt;packagename&gt; å‚æ•°ä¸æ˜¯å¿…é¡»çš„ï¼ŒæŒ‡å®š &lt;packagename&gt; è¡¨ç¤ºæŸ¥çœ‹ä¸æŸä¸ªåŒ…åç›¸å…³çš„ Servicesï¼Œä¸æŒ‡å®šè¡¨ç¤ºæŸ¥çœ‹æ‰€æœ‰ Servicesã€‚ &lt;packagename&gt; ä¸ä¸€å®šè¦ç»™å‡ºå®Œæ•´çš„åŒ…åï¼Œæ¯”å¦‚è¿è¡Œ adb shell dumpsys activity services org.mazhuangï¼Œé‚£ä¹ˆåŒ…å org.mazhuang.demo1ã€org.mazhuang.demo2 å’Œ org.mazhuang123 ç­‰ç›¸å…³çš„ Services éƒ½ä¼šåˆ—å‡ºæ¥ã€‚ æŸ¥çœ‹åº”ç”¨è¯¦ç»†ä¿¡æ¯å‘½ä»¤ï¼š 1adb shell dumpsys package &lt;packagename&gt; è¾“å‡ºä¸­åŒ…å«å¾ˆå¤šä¿¡æ¯ï¼ŒåŒ…æ‹¬ Activity Resolver Tableã€Registered ContentProvidersã€åŒ…åã€userIdã€å®‰è£…åçš„æ–‡ä»¶èµ„æºä»£ç ç­‰è·¯å¾„ã€ç‰ˆæœ¬ä¿¡æ¯ã€æƒé™ä¿¡æ¯å’ŒæˆäºˆçŠ¶æ€ã€ç­¾åç‰ˆæœ¬ä¿¡æ¯ç­‰ã€‚ &lt;packagename&gt; è¡¨ç¤ºåº”ç”¨åŒ…åã€‚ è¾“å‡ºç¤ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475Activity Resolver Table: Non-Data Actions: android.intent.action.MAIN: 5b4cba8 org.mazhuang.guanggoo/.SplashActivity filter 5ec9dcc Action: \"android.intent.action.MAIN\" Category: \"android.intent.category.LAUNCHER\" AutoVerify=falseRegistered ContentProviders: org.mazhuang.guanggoo/com.tencent.bugly.beta.utils.BuglyFileProvider: Provider{7a3c394 org.mazhuang.guanggoo/com.tencent.bugly.beta.utils.BuglyFileProvider}ContentProvider Authorities: [org.mazhuang.guanggoo.fileProvider]: Provider{7a3c394 org.mazhuang.guanggoo/com.tencent.bugly.beta.utils.BuglyFileProvider} applicationInfo=ApplicationInfo{7754242 org.mazhuang.guanggoo}Key Set Manager: [org.mazhuang.guanggoo] Signing KeySets: 501Packages: Package [org.mazhuang.guanggoo] (c1d7f): userId=10394 pkg=Package{55f714c org.mazhuang.guanggoo} codePath=/data/app/org.mazhuang.guanggoo-2 resourcePath=/data/app/org.mazhuang.guanggoo-2 legacyNativeLibraryDir=/data/app/org.mazhuang.guanggoo-2/lib primaryCpuAbi=null secondaryCpuAbi=null versionCode=74 minSdk=15 targetSdk=25 versionName=1.1.74 splits=[base] apkSigningVersion=2 applicationInfo=ApplicationInfo{7754242 org.mazhuang.guanggoo} flags=[ HAS_CODE ALLOW_CLEAR_USER_DATA ALLOW_BACKUP ] privateFlags=[ RESIZEABLE_ACTIVITIES ] dataDir=/data/user/0/org.mazhuang.guanggoo supportsScreens=[small, medium, large, xlarge, resizeable, anyDensity] timeStamp=2017-10-22 23:50:53 firstInstallTime=2017-10-22 23:50:25 lastUpdateTime=2017-10-22 23:50:55 installerPackageName=com.miui.packageinstaller signatures=PackageSignatures{af09595 [53c7caa2]} installPermissionsFixed=true installStatus=1 pkgFlags=[ HAS_CODE ALLOW_CLEAR_USER_DATA ALLOW_BACKUP ] requested permissions: android.permission.READ_PHONE_STATE android.permission.INTERNET android.permission.ACCESS_NETWORK_STATE android.permission.ACCESS_WIFI_STATE android.permission.READ_LOGS android.permission.WRITE_EXTERNAL_STORAGE android.permission.READ_EXTERNAL_STORAGE install permissions: android.permission.INTERNET: granted=true android.permission.ACCESS_NETWORK_STATE: granted=true android.permission.ACCESS_WIFI_STATE: granted=true User 0: ceDataInode=1155675 installed=true hidden=false suspended=false stopped=true notLaunched=false enabled=0 gids=[3003] runtime permissions: android.permission.READ_EXTERNAL_STORAGE: granted=true android.permission.READ_PHONE_STATE: granted=true android.permission.WRITE_EXTERNAL_STORAGE: granted=true User 999: ceDataInode=0 installed=false hidden=false suspended=false stopped=true notLaunched=true enabled=0 gids=[3003] runtime permissions:Dexopt state: [org.mazhuang.guanggoo] Instruction Set: arm64 path: /data/app/org.mazhuang.guanggoo-2/base.apk status: /data/app/org.mazhuang.guanggoo-2/oat/arm64/base.odex [compilation_filter=speed-profile, status=kOatUpToDa te] æŸ¥çœ‹åº”ç”¨å®‰è£…è·¯å¾„å‘½ä»¤: 1adb shell pm path &lt;PACKAGE&gt; è¾“å‡ºåº”ç”¨å®‰è£…è·¯å¾„ è¾“å‡ºç¤ºä¾‹: 123adb shell pm path ecarx.weatherpackage:/data/app/ecarx.weather-1.apk ä¸åº”ç”¨äº¤äº’ä¸»è¦æ˜¯ä½¿ç”¨ am &lt;command&gt; å‘½ä»¤ï¼Œå¸¸ç”¨çš„ &lt;command&gt; å¦‚ä¸‹ï¼š command ç”¨é€” start [options] &lt;INTENT&gt; å¯åŠ¨ &lt;INTENT&gt; æŒ‡å®šçš„ Activity startservice [options] &lt;INTENT&gt; å¯åŠ¨ &lt;INTENT&gt; æŒ‡å®šçš„ Service broadcast [options] &lt;INTENT&gt; å‘é€ &lt;INTENT&gt; æŒ‡å®šçš„å¹¿æ’­ force-stop &lt;packagename&gt; åœæ­¢ &lt;packagename&gt; ç›¸å…³çš„è¿›ç¨‹ &lt;INTENT&gt; å‚æ•°å¾ˆçµæ´»ï¼Œå’Œå†™ Android ç¨‹åºæ—¶ä»£ç é‡Œçš„ Intent ç›¸å¯¹åº”ã€‚ ç”¨äºå†³å®š intent å¯¹è±¡çš„é€‰é¡¹å¦‚ä¸‹ï¼š å‚æ•° å«ä¹‰ -a &lt;ACTION&gt; æŒ‡å®š actionï¼Œæ¯”å¦‚ android.intent.action.VIEW -c &lt;CATEGORY&gt; æŒ‡å®š categoryï¼Œæ¯”å¦‚ android.intent.category.APP_CONTACTS -n &lt;COMPONENT&gt; æŒ‡å®šå®Œæ•´ component åï¼Œç”¨äºæ˜ç¡®æŒ‡å®šå¯åŠ¨å“ªä¸ª Activityï¼Œå¦‚ com.example.app/.ExampleActivity &lt;INTENT&gt; é‡Œè¿˜èƒ½å¸¦æ•°æ®ï¼Œå°±åƒå†™ä»£ç æ—¶çš„ Bundle ä¸€æ ·ï¼š å‚æ•° å«ä¹‰ --esn &lt;EXTRA_KEY&gt; null å€¼ï¼ˆåªæœ‰ key åï¼‰ `-e â€“es &lt;EXTRA_KEY&gt; &lt;EXTRA_STRING_VALUE&gt;` string å€¼ --ez &lt;EXTRA_KEY&gt; &lt;EXTRA_BOOLEAN_VALUE&gt; boolean å€¼ --ei &lt;EXTRA_KEY&gt; &lt;EXTRA_INT_VALUE&gt; integer å€¼ --el &lt;EXTRA_KEY&gt; &lt;EXTRA_LONG_VALUE&gt; long å€¼ --ef &lt;EXTRA_KEY&gt; &lt;EXTRA_FLOAT_VALUE&gt; float å€¼ --eu &lt;EXTRA_KEY&gt; &lt;EXTRA_URI_VALUE&gt; URI --ecn &lt;EXTRA_KEY&gt; &lt;EXTRA_COMPONENT_NAME_VALUE&gt; component name --eia &lt;EXTRA_KEY&gt; &lt;EXTRA_INT_VALUE&gt;[,&lt;EXTRA_INT_VALUE...] integer æ•°ç»„ --ela &lt;EXTRA_KEY&gt; &lt;EXTRA_LONG_VALUE&gt;[,&lt;EXTRA_LONG_VALUE...] long æ•°ç»„ å¯åŠ¨åº”ç”¨/ è°ƒèµ· Activityå‘½ä»¤æ ¼å¼ï¼š 1adb shell am start [options] &lt;INTENT&gt; ä¾‹å¦‚ï¼š 1adb shell am start -n com.tencent.mm/.ui.LauncherUI è¡¨ç¤ºè°ƒèµ·å¾®ä¿¡ä¸»ç•Œé¢ã€‚ 1adb shell am start -n org.mazhuang.boottimemeasure/.MainActivity --es \"toast\" \"hello, world\" è¡¨ç¤ºè°ƒèµ· org.mazhuang.boottimemeasure/.MainActivity å¹¶ä¼ ç»™å®ƒ string æ•°æ®é”®å€¼å¯¹ toast - hello, worldã€‚ è°ƒèµ· Serviceå‘½ä»¤æ ¼å¼ï¼š 1adb shell am startservice [options] &lt;INTENT&gt; ä¾‹å¦‚ï¼š 1adb shell am startservice -n com.tencent.mm/.plugin.accountsync.model.AccountAuthenticatorService è¡¨ç¤ºè°ƒèµ·å¾®ä¿¡çš„æŸ Serviceã€‚ å¦å¤–ä¸€ä¸ªå…¸å‹çš„ç”¨ä¾‹æ˜¯å¦‚æœè®¾å¤‡ä¸ŠåŸæœ¬åº”è¯¥æ˜¾ç¤ºè™šæ‹ŸæŒ‰é”®ä½†æ˜¯æ²¡æœ‰æ˜¾ç¤ºï¼Œå¯ä»¥è¯•è¯•è¿™ä¸ªï¼š 1adb shell am startservice -n com.android.systemui/.SystemUIService åœæ­¢ Serviceå‘½ä»¤æ ¼å¼ï¼š 1adb shell am stopservice [options] &lt;INTENT&gt; å‘é€å¹¿æ’­å‘½ä»¤æ ¼å¼ï¼š 1adb shell am broadcast [options] &lt;INTENT&gt; å¯ä»¥å‘æ‰€æœ‰ç»„ä»¶å¹¿æ’­ï¼Œä¹Ÿå¯ä»¥åªå‘æŒ‡å®šç»„ä»¶å¹¿æ’­ã€‚ ä¾‹å¦‚ï¼Œå‘æ‰€æœ‰ç»„ä»¶å¹¿æ’­ BOOT_COMPLETEDï¼š 1adb shell am broadcast -a android.intent.action.BOOT_COMPLETED åˆä¾‹å¦‚ï¼Œåªå‘ org.mazhuang.boottimemeasure/.BootCompletedReceiver å¹¿æ’­ BOOT_COMPLETEDï¼š 1adb shell am broadcast -a android.intent.action.BOOT_COMPLETED -n org.mazhuang.boottimemeasure/.BootCompletedReceiver è¿™ç±»ç”¨æ³•åœ¨æµ‹è¯•çš„æ—¶å€™å¾ˆå®ç”¨ï¼Œæ¯”å¦‚æŸä¸ªå¹¿æ’­çš„åœºæ™¯å¾ˆéš¾åˆ¶é€ ï¼Œå¯ä»¥è€ƒè™‘é€šè¿‡è¿™ç§æ–¹å¼æ¥å‘é€å¹¿æ’­ã€‚ æ—¢èƒ½å‘é€ç³»ç»Ÿé¢„å®šä¹‰çš„å¹¿æ’­ï¼Œä¹Ÿèƒ½å‘é€è‡ªå®šä¹‰å¹¿æ’­ã€‚å¦‚ä¸‹æ˜¯éƒ¨åˆ†ç³»ç»Ÿé¢„å®šä¹‰å¹¿æ’­åŠæ­£å¸¸è§¦å‘æ—¶æœºï¼š action è§¦å‘æ—¶æœº android.net.conn.CONNECTIVITY_CHANGE ç½‘ç»œè¿æ¥å‘ç”Ÿå˜åŒ– android.intent.action.SCREEN_ON å±å¹•ç‚¹äº® android.intent.action.SCREEN_OFF å±å¹•ç†„ç­ android.intent.action.BATTERY_LOW ç”µé‡ä½ï¼Œä¼šå¼¹å‡ºç”µé‡ä½æç¤ºæ¡† android.intent.action.BATTERY_OKAY ç”µé‡æ¢å¤äº† android.intent.action.BOOT_COMPLETED è®¾å¤‡å¯åŠ¨å®Œæ¯• android.intent.action.DEVICE_STORAGE_LOW å­˜å‚¨ç©ºé—´è¿‡ä½ android.intent.action.DEVICE_STORAGE_OK å­˜å‚¨ç©ºé—´æ¢å¤ android.intent.action.PACKAGE_ADDED å®‰è£…äº†æ–°çš„åº”ç”¨ android.net.wifi.STATE_CHANGE WiFi è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ– android.net.wifi.WIFI_STATE_CHANGED WiFi çŠ¶æ€å˜ä¸ºå¯ç”¨/å…³é—­/æ­£åœ¨å¯åŠ¨/æ­£åœ¨å…³é—­/æœªçŸ¥ android.intent.action.BATTERY_CHANGED ç”µæ± ç”µé‡å‘ç”Ÿå˜åŒ– android.intent.action.INPUT_METHOD_CHANGED ç³»ç»Ÿè¾“å…¥æ³•å‘ç”Ÿå˜åŒ– android.intent.action.ACTION_POWER_CONNECTED å¤–éƒ¨ç”µæºè¿æ¥ android.intent.action.ACTION_POWER_DISCONNECTED å¤–éƒ¨ç”µæºæ–­å¼€è¿æ¥ android.intent.action.DREAMING_STARTED ç³»ç»Ÿå¼€å§‹ä¼‘çœ  android.intent.action.DREAMING_STOPPED ç³»ç»Ÿåœæ­¢ä¼‘çœ  android.intent.action.WALLPAPER_CHANGED å£çº¸å‘ç”Ÿå˜åŒ– android.intent.action.HEADSET_PLUG æ’å…¥è€³æœº android.intent.action.MEDIA_UNMOUNTED å¸è½½å¤–éƒ¨ä»‹è´¨ android.intent.action.MEDIA_MOUNTED æŒ‚è½½å¤–éƒ¨ä»‹è´¨ android.os.action.POWER_SAVE_MODE_CHANGED çœç”µæ¨¡å¼å¼€å¯ ï¼ˆä»¥ä¸Šå¹¿æ’­å‡å¯ä½¿ç”¨ adb è§¦å‘ï¼‰ å¼ºåˆ¶åœæ­¢åº”ç”¨å‘½ä»¤ï¼š 1adb shell am force-stop &lt;packagename&gt; å‘½ä»¤ç¤ºä¾‹ï¼š 1adb shell am force-stop com.qihoo360.mobilesafe è¡¨ç¤ºåœæ­¢ 360 å®‰å…¨å«å£«çš„ä¸€åˆ‡è¿›ç¨‹ä¸æœåŠ¡ã€‚ æ”¶ç´§å†…å­˜å‘½ä»¤ï¼š1adb shell am send-trim-memory &lt;pid&gt; &lt;level&gt; pid: è¿›ç¨‹ IDlevel: HIDDENã€RUNNING_MODERATEã€BACKGROUNDã€ RUNNING_LOWã€MODERATEã€RUNNING_CRITICALã€COMPLETE å‘½ä»¤ç¤ºä¾‹ï¼š 1adb shell am send-trim-memory 12345 RUNNING_LOW è¡¨ç¤ºå‘ pid=12345 çš„è¿›ç¨‹ï¼Œå‘å‡º level=RUNNING_LOW çš„æ”¶ç´§å†…å­˜å‘½ä»¤ã€‚ æ–‡ä»¶ç®¡ç†å¤åˆ¶è®¾å¤‡é‡Œçš„æ–‡ä»¶åˆ°ç”µè„‘å‘½ä»¤ï¼š 1adb pull &lt;è®¾å¤‡é‡Œçš„æ–‡ä»¶è·¯å¾„&gt; [ç”µè„‘ä¸Šçš„ç›®å½•] å…¶ä¸­ ç”µè„‘ä¸Šçš„ç›®å½• å‚æ•°å¯ä»¥çœç•¥ï¼Œé»˜è®¤å¤åˆ¶åˆ°å½“å‰ç›®å½•ã€‚ ä¾‹ï¼š 1adb pull /sdcard/sr.mp4 ~/tmp/ å°æŠ€å·§ï¼šè®¾å¤‡ä¸Šçš„æ–‡ä»¶è·¯å¾„å¯èƒ½éœ€è¦ root æƒé™æ‰èƒ½è®¿é—®ï¼Œå¦‚æœä½ çš„è®¾å¤‡å·²ç» root è¿‡ï¼Œå¯ä»¥å…ˆä½¿ç”¨ adb shell å’Œ su å‘½ä»¤åœ¨ adb shell é‡Œè·å– root æƒé™åï¼Œå…ˆ cp /path/on/device /sdcard/filename å°†æ–‡ä»¶å¤åˆ¶åˆ° sdcardï¼Œç„¶å adb pull /sdcard/filename /path/on/pcã€‚ å¤åˆ¶ç”µè„‘é‡Œçš„æ–‡ä»¶åˆ°è®¾å¤‡å‘½ä»¤ï¼š 1adb push &lt;ç”µè„‘ä¸Šçš„æ–‡ä»¶è·¯å¾„&gt; &lt;è®¾å¤‡é‡Œçš„ç›®å½•&gt; ä¾‹ï¼š 1adb push ~/sr.mp4 /sdcard/ å°æŠ€å·§ï¼šè®¾å¤‡ä¸Šçš„æ–‡ä»¶è·¯å¾„æ™®é€šæƒé™å¯èƒ½æ— æ³•ç›´æ¥å†™å…¥ï¼Œå¦‚æœä½ çš„è®¾å¤‡å·²ç» root è¿‡ï¼Œå¯ä»¥å…ˆ adb push /path/on/pc /sdcard/filenameï¼Œç„¶å adb shell å’Œ su åœ¨ adb shell é‡Œè·å– root æƒé™åï¼Œcp /sdcard/filename /path/on/deviceã€‚ æ¨¡æ‹ŸæŒ‰é”®/è¾“å…¥åœ¨ adb shell é‡Œæœ‰ä¸ªå¾ˆå®ç”¨çš„å‘½ä»¤å« inputï¼Œé€šè¿‡å®ƒå¯ä»¥åšä¸€äº›æœ‰è¶£çš„äº‹æƒ…ã€‚ input å‘½ä»¤çš„å®Œæ•´ help ä¿¡æ¯å¦‚ä¸‹ï¼š 12345678910111213141516171819202122Usage: input [&lt;source&gt;] &lt;command&gt; [&lt;arg&gt;...]The sources are: mouse keyboard joystick touchnavigation touchpad trackball stylus dpad gesture touchscreen gamepadThe commands and default sources are: text &lt;string&gt; (Default: touchscreen) keyevent [--longpress] &lt;key code number or name&gt; ... (Default: keyboard) tap &lt;x&gt; &lt;y&gt; (Default: touchscreen) swipe &lt;x1&gt; &lt;y1&gt; &lt;x2&gt; &lt;y2&gt; [duration(ms)] (Default: touchscreen) press (Default: trackball) roll &lt;dx&gt; &lt;dy&gt; (Default: trackball) æ¯”å¦‚ä½¿ç”¨ adb shell input keyevent &lt;keycode&gt; å‘½ä»¤ï¼Œä¸åŒçš„ keycode èƒ½å®ç°ä¸åŒçš„åŠŸèƒ½ï¼Œå®Œæ•´çš„ keycode åˆ—è¡¨è¯¦è§ KeyEventï¼Œæ‘˜å¼•éƒ¨åˆ†æˆ‘è§‰å¾—æœ‰æ„æ€çš„å¦‚ä¸‹ï¼š keycode å«ä¹‰ 3 HOME é”® 4 è¿”å›é”® 5 æ‰“å¼€æ‹¨å·åº”ç”¨ 6 æŒ‚æ–­ç”µè¯ 24 å¢åŠ éŸ³é‡ 25 é™ä½éŸ³é‡ 26 ç”µæºé”® 27 æ‹ç…§ï¼ˆéœ€è¦åœ¨ç›¸æœºåº”ç”¨é‡Œï¼‰ 64 æ‰“å¼€æµè§ˆå™¨ 82 èœå•é”® 85 æ’­æ”¾/æš‚åœ 86 åœæ­¢æ’­æ”¾ 87 æ’­æ”¾ä¸‹ä¸€é¦– 88 æ’­æ”¾ä¸Šä¸€é¦– 122 ç§»åŠ¨å…‰æ ‡åˆ°è¡Œé¦–æˆ–åˆ—è¡¨é¡¶éƒ¨ 123 ç§»åŠ¨å…‰æ ‡åˆ°è¡Œæœ«æˆ–åˆ—è¡¨åº•éƒ¨ 126 æ¢å¤æ’­æ”¾ 127 æš‚åœæ’­æ”¾ 164 é™éŸ³ 176 æ‰“å¼€ç³»ç»Ÿè®¾ç½® 187 åˆ‡æ¢åº”ç”¨ 207 æ‰“å¼€è”ç³»äºº 208 æ‰“å¼€æ—¥å† 209 æ‰“å¼€éŸ³ä¹ 210 æ‰“å¼€è®¡ç®—å™¨ 220 é™ä½å±å¹•äº®åº¦ 221 æé«˜å±å¹•äº®åº¦ 223 ç³»ç»Ÿä¼‘çœ  224 ç‚¹äº®å±å¹• 231 æ‰“å¼€è¯­éŸ³åŠ©æ‰‹ 276 å¦‚æœæ²¡æœ‰ wakelock åˆ™è®©ç³»ç»Ÿä¼‘çœ  ä¸‹é¢æ˜¯ input å‘½ä»¤çš„ä¸€äº›ç”¨æ³•ä¸¾ä¾‹ã€‚ ç”µæºé”®å‘½ä»¤ï¼š 1adb shell input keyevent 26 æ‰§è¡Œæ•ˆæœç›¸å½“äºæŒ‰ç”µæºé”®ã€‚ èœå•é”®å‘½ä»¤ï¼š 1adb shell input keyevent 82 HOME é”®å‘½ä»¤ï¼š 1adb shell input keyevent 3 è¿”å›é”®å‘½ä»¤ï¼š 1adb shell input keyevent 4 éŸ³é‡æ§åˆ¶å¢åŠ éŸ³é‡ï¼š 1adb shell input keyevent 24 é™ä½éŸ³é‡ï¼š 1adb shell input keyevent 25 é™éŸ³ï¼š 1adb shell input keyevent 164 åª’ä½“æ§åˆ¶æ’­æ”¾/æš‚åœï¼š 1adb shell input keyevent 85 åœæ­¢æ’­æ”¾ï¼š 1adb shell input keyevent 86 æ’­æ”¾ä¸‹ä¸€é¦–ï¼š 1adb shell input keyevent 87 æ’­æ”¾ä¸Šä¸€é¦–ï¼š 1adb shell input keyevent 88 æ¢å¤æ’­æ”¾ï¼š 1adb shell input keyevent 126 æš‚åœæ’­æ”¾ï¼š 1adb shell input keyevent 127 ç‚¹äº®/ç†„ç­å±å¹•å¯ä»¥é€šè¿‡ä¸Šæ–‡è®²è¿°è¿‡çš„æ¨¡æ‹Ÿç”µæºé”®æ¥åˆ‡æ¢ç‚¹äº®å’Œç†„ç­å±å¹•ï¼Œä½†å¦‚æœæ˜ç¡®åœ°æƒ³è¦ç‚¹äº®æˆ–è€…ç†„ç­å±å¹•ï¼Œé‚£å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹æ³•ã€‚ ç‚¹äº®å±å¹•ï¼š 1adb shell input keyevent 224 ç†„ç­å±å¹•ï¼š 1adb shell input keyevent 223 æ»‘åŠ¨è§£é”å¦‚æœé”å±æ²¡æœ‰å¯†ç ï¼Œæ˜¯é€šè¿‡æ»‘åŠ¨æ‰‹åŠ¿è§£é”ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ input swipe æ¥è§£é”ã€‚ å‘½ä»¤ï¼ˆå‚æ•°ä»¥æœºå‹ Nexus 5ï¼Œå‘ä¸Šæ»‘åŠ¨æ‰‹åŠ¿è§£é”ä¸¾ä¾‹ï¼‰ï¼š 1adb shell input swipe 300 1000 300 500 å‚æ•° 300 1000 300 500 åˆ†åˆ«è¡¨ç¤ºèµ·å§‹ç‚¹xåæ ‡ èµ·å§‹ç‚¹yåæ ‡ ç»“æŸç‚¹xåæ ‡ ç»“æŸç‚¹yåæ ‡ã€‚ è¾“å…¥æ–‡æœ¬åœ¨ç„¦ç‚¹å¤„äºæŸæ–‡æœ¬æ¡†æ—¶ï¼Œå¯ä»¥é€šè¿‡ input å‘½ä»¤æ¥è¾“å…¥æ–‡æœ¬ã€‚ å‘½ä»¤ï¼š 1adb shell input text hello ç°åœ¨ hello å‡ºç°åœ¨æ–‡æœ¬æ¡†äº†ã€‚ æŸ¥çœ‹æ—¥å¿—Android ç³»ç»Ÿçš„æ—¥å¿—åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œåº•å±‚çš„ Linux å†…æ ¸æ—¥å¿—è¾“å‡ºåˆ° /proc/kmsgï¼ŒAndroid çš„æ—¥å¿—è¾“å‡ºåˆ° /dev/logã€‚ Android æ—¥å¿—å‘½ä»¤æ ¼å¼ï¼š 1[adb] logcat [&lt;option&gt;] ... [&lt;filter-spec&gt;] ... å¸¸ç”¨ç”¨æ³•åˆ—ä¸¾å¦‚ä¸‹ï¼š æŒ‰çº§åˆ«è¿‡æ»¤æ—¥å¿—Android çš„æ—¥å¿—åˆ†ä¸ºå¦‚ä¸‹å‡ ä¸ªä¼˜å…ˆçº§ï¼ˆpriorityï¼‰ï¼š V â€”â€” Verboseï¼ˆæœ€ä½ï¼Œè¾“å‡ºå¾—æœ€å¤šï¼‰ D â€”â€” Debug I â€”â€” Info W â€”â€” Warning E â€”â€” Error F â€”â€” Fatal S â€”â€” Silentï¼ˆæœ€é«˜ï¼Œå•¥ä¹Ÿä¸è¾“å‡ºï¼‰ æŒ‰æŸçº§åˆ«è¿‡æ»¤æ—¥å¿—åˆ™ä¼šå°†è¯¥çº§åˆ«åŠä»¥ä¸Šçš„æ—¥å¿—è¾“å‡ºã€‚ æ¯”å¦‚ï¼Œå‘½ä»¤ï¼š 1adb logcat *:W ä¼šå°† Warningã€Errorã€Fatal å’Œ Silent æ—¥å¿—è¾“å‡ºã€‚ ï¼ˆæ³¨ï¼š åœ¨ macOS ä¸‹éœ€è¦ç»™ *:W è¿™æ ·ä»¥ * ä½œä¸º tag çš„å‚æ•°åŠ åŒå¼•å·ï¼Œå¦‚ adb logcat &quot;*:W&quot;ï¼Œä¸ç„¶ä¼šæŠ¥é”™ no matches found: *:Wã€‚ï¼‰ æŒ‰ tag å’Œçº§åˆ«è¿‡æ»¤æ—¥å¿—&lt;filter-spec&gt; å¯ä»¥ç”±å¤šä¸ª &lt;tag&gt;[:priority] ç»„æˆã€‚ æ¯”å¦‚ï¼Œå‘½ä»¤ï¼š 1adb logcat ActivityManager:I MyApp:D *:S è¡¨ç¤ºè¾“å‡º tag ActivityManager çš„ Info ä»¥ä¸Šçº§åˆ«æ—¥å¿—ï¼Œè¾“å‡º tag MyApp çš„ Debug ä»¥ä¸Šçº§åˆ«æ—¥å¿—ï¼ŒåŠå…¶å®ƒ tag çš„ Silent çº§åˆ«æ—¥å¿—ï¼ˆå³å±è”½å…¶å®ƒ tag æ—¥å¿—ï¼‰ã€‚ æ—¥å¿—æ ¼å¼å¯ä»¥ç”¨ adb logcat -v &lt;format&gt; é€‰é¡¹æŒ‡å®šæ—¥å¿—è¾“å‡ºæ ¼å¼ã€‚ æ—¥å¿—æ”¯æŒæŒ‰ä»¥ä¸‹å‡ ç§ &lt;format&gt;ï¼š brief é»˜è®¤æ ¼å¼ã€‚æ ¼å¼ä¸ºï¼š 1&lt;priority&gt;/&lt;tag&gt;(&lt;pid&gt;): &lt;message&gt; ç¤ºä¾‹ï¼š 1D/HeadsetStateMachine( 1785): Disconnected process message: 10, size: 0 process æ ¼å¼ä¸ºï¼š 1&lt;priority&gt;(&lt;pid&gt;) &lt;message&gt; ç¤ºä¾‹ï¼š 1D( 1785) Disconnected process message: 10, size: 0 (HeadsetStateMachine) tag æ ¼å¼ä¸ºï¼š 1&lt;priority&gt;/&lt;tag&gt;: &lt;message&gt; ç¤ºä¾‹ï¼š 1D/HeadsetStateMachine: Disconnected process message: 10, size: 0 raw æ ¼å¼ä¸ºï¼š 1&lt;message&gt; ç¤ºä¾‹ï¼š 1Disconnected process message: 10, size: 0 time æ ¼å¼ä¸ºï¼š 1&lt;datetime&gt; &lt;priority&gt;/&lt;tag&gt;(&lt;pid&gt;): &lt;message&gt; ç¤ºä¾‹ï¼š 108-28 22:39:39.974 D/HeadsetStateMachine( 1785): Disconnected process message: 10, size: 0 threadtime æ ¼å¼ä¸ºï¼š 1&lt;datetime&gt; &lt;pid&gt; &lt;tid&gt; &lt;priority&gt; &lt;tag&gt;: &lt;message&gt; ç¤ºä¾‹ï¼š 108-28 22:39:39.974 1785 1832 D HeadsetStateMachine: Disconnected process message: 10, size: 0 long æ ¼å¼ä¸ºï¼š 12[ &lt;datetime&gt; &lt;pid&gt;:&lt;tid&gt; &lt;priority&gt;/&lt;tag&gt; ]&lt;message&gt; ç¤ºä¾‹ï¼š 12[ 08-28 22:39:39.974 1785: 1832 D/HeadsetStateMachine ]Disconnected process message: 10, size: 0 æŒ‡å®šæ ¼å¼å¯ä¸ä¸Šé¢çš„è¿‡æ»¤åŒæ—¶ä½¿ç”¨ã€‚æ¯”å¦‚ï¼š 1adb logcat -v long ActivityManager:I *:S æ¸…ç©ºæ—¥å¿—1adb logcat -c å†…æ ¸æ—¥å¿—å‘½ä»¤ï¼š 1adb shell dmesg è¾“å‡ºç¤ºä¾‹ï¼š 1234567&lt;6&gt;[14201.684016] PM: noirq resume of devices complete after 0.982 msecs&lt;6&gt;[14201.685525] PM: early resume of devices complete after 0.838 msecs&lt;6&gt;[14201.753642] PM: resume of devices complete after 68.106 msecs&lt;4&gt;[14201.755954] Restarting tasks ... done.&lt;6&gt;[14201.771229] PM: suspend exit 2016-08-28 13:31:32.679217193 UTC&lt;6&gt;[14201.872373] PM: suspend entry 2016-08-28 13:31:32.780363596 UTC&lt;6&gt;[14201.872498] PM: Syncing filesystems ... done. ä¸­æ‹¬å·é‡Œçš„ [14201.684016] ä»£è¡¨å†…æ ¸å¼€å§‹å¯åŠ¨åçš„æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚ é€šè¿‡å†…æ ¸æ—¥å¿—æˆ‘ä»¬å¯ä»¥åšä¸€äº›äº‹æƒ…ï¼Œæ¯”å¦‚è¡¡é‡å†…æ ¸å¯åŠ¨æ—¶é—´ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæ¯•åçš„å†…æ ¸æ—¥å¿—é‡Œæ‰¾åˆ° Freeing init memory é‚£ä¸€è¡Œå‰é¢çš„æ—¶é—´å°±æ˜¯ã€‚ æŸ¥çœ‹è®¾å¤‡ä¿¡æ¯å‹å·å‘½ä»¤ï¼š 1adb shell getprop ro.product.model è¾“å‡ºç¤ºä¾‹ï¼š 1Nexus 5 ç”µæ± çŠ¶å†µå‘½ä»¤ï¼š 1adb shell dumpsys battery è¾“å…¥ç¤ºä¾‹ï¼š 123456789101112Current Battery Service state: AC powered: false USB powered: true Wireless powered: false status: 2 health: 2 present: true level: 44 scale: 100 voltage: 3872 temperature: 280 technology: Li-poly å…¶ä¸­ scale ä»£è¡¨æœ€å¤§ç”µé‡ï¼Œlevel ä»£è¡¨å½“å‰ç”µé‡ã€‚ä¸Šé¢çš„è¾“å‡ºè¡¨ç¤ºè¿˜å‰©ä¸‹ 44% çš„ç”µé‡ã€‚ å±å¹•åˆ†è¾¨ç‡å‘½ä»¤ï¼š 1adb shell wm size è¾“å‡ºç¤ºä¾‹ï¼š 1Physical size: 1080x1920 è¯¥è®¾å¤‡å±å¹•åˆ†è¾¨ç‡ä¸º 1080px * 1920pxã€‚ å¦‚æœä½¿ç”¨å‘½ä»¤ä¿®æ”¹è¿‡ï¼Œé‚£è¾“å‡ºå¯èƒ½æ˜¯ï¼š 12Physical size: 1080x1920Override size: 480x1024 è¡¨æ˜è®¾å¤‡çš„å±å¹•åˆ†è¾¨ç‡åŸæœ¬æ˜¯ 1080px 1920pxï¼Œå½“å‰è¢«ä¿®æ”¹ä¸º 480px 1024pxã€‚ å±å¹•å¯†åº¦å‘½ä»¤ï¼š 1adb shell wm density è¾“å‡ºç¤ºä¾‹ï¼š 1Physical density: 420 è¯¥è®¾å¤‡å±å¹•å¯†åº¦ä¸º 420dpiã€‚ å¦‚æœä½¿ç”¨å‘½ä»¤ä¿®æ”¹è¿‡ï¼Œé‚£è¾“å‡ºå¯èƒ½æ˜¯ï¼š 12Physical density: 480Override density: 160 è¡¨æ˜è®¾å¤‡çš„å±å¹•å¯†åº¦åŸæ¥æ˜¯ 480dpiï¼Œå½“å‰è¢«ä¿®æ”¹ä¸º 160dpiã€‚ æ˜¾ç¤ºå±å‚æ•°å‘½ä»¤ï¼š 1adb shell dumpsys window displays è¾“å‡ºç¤ºä¾‹ï¼š 1234WINDOW MANAGER DISPLAY CONTENTS (dumpsys window displays) Display: mDisplayId=0 init=1080x1920 420dpi cur=1080x1920 app=1080x1794 rng=1080x1017-1810x1731 deferred=false layoutNeeded=false å…¶ä¸­ mDisplayId ä¸º æ˜¾ç¤ºå±ç¼–å·ï¼Œinit æ˜¯åˆå§‹åˆ†è¾¨ç‡å’Œå±å¹•å¯†åº¦ï¼Œapp çš„é«˜åº¦æ¯” init é‡Œçš„è¦å°ï¼Œè¡¨ç¤ºå±å¹•åº•éƒ¨æœ‰è™šæ‹ŸæŒ‰é”®ï¼Œé«˜åº¦ä¸º 1920 - 1794 = 126px åˆ 42dpã€‚ android_idå‘½ä»¤ï¼š 1adb shell settings get secure android_id è¾“å‡ºç¤ºä¾‹ï¼š 151b6be48bac8c569 IMEIåœ¨ Android 4.4 åŠä»¥ä¸‹ç‰ˆæœ¬å¯é€šè¿‡å¦‚ä¸‹å‘½ä»¤è·å– IMEIï¼š 1adb shell dumpsys iphonesubinfo è¾“å‡ºç¤ºä¾‹ï¼š 123Phone Subscriber Info: Phone Type = GSM Device ID = 860955027785041 å…¶ä¸­çš„ Device ID å°±æ˜¯ IMEIã€‚ è€Œåœ¨ Android 5.0 åŠä»¥ä¸Šç‰ˆæœ¬é‡Œè¿™ä¸ªå‘½ä»¤è¾“å‡ºä¸ºç©ºï¼Œå¾—é€šè¿‡å…¶å®ƒæ–¹å¼è·å–äº†ï¼ˆéœ€è¦ root æƒé™ï¼‰ï¼š 123adb shellsuservice call iphonesubinfo 1 è¾“å‡ºç¤ºä¾‹ï¼š 1234Result: Parcel( 0x00000000: 00000000 0000000f 00360038 00390030 '........8.6.0.9.' 0x00000010: 00350035 00320030 00370037 00350038 '5.5.0.2.7.7.8.5.' 0x00000020: 00340030 00000031 '0.4.1... ') æŠŠé‡Œé¢çš„æœ‰æ•ˆå†…å®¹æå–å‡ºæ¥å°±æ˜¯ IMEI äº†ï¼Œæ¯”å¦‚è¿™é‡Œçš„æ˜¯ 860955027785041ã€‚ å‚è€ƒï¼šadb shell dumpsys iphonesubinfo not working since Android 5.0 Lollipop Android ç³»ç»Ÿç‰ˆæœ¬å‘½ä»¤ï¼š 1adb shell getprop ro.build.version.release è¾“å‡ºç¤ºä¾‹ï¼š 15.0.2 IP åœ°å€æ¯æ¬¡æƒ³çŸ¥é“è®¾å¤‡çš„ IP åœ°å€çš„æ—¶å€™éƒ½å¾—ã€Œè®¾ç½®ã€-ã€Œå…³äºæ‰‹æœºã€-ã€ŒçŠ¶æ€ä¿¡æ¯ã€-ã€ŒIPåœ°å€ã€å¾ˆçƒ¦å¯¹ä¸å¯¹ï¼Ÿé€šè¿‡ adb å¯ä»¥æ–¹ä¾¿åœ°æŸ¥çœ‹ã€‚ å‘½ä»¤ï¼š 1adb shell ifconfig | grep Mask è¾“å‡ºç¤ºä¾‹ï¼š 12inet addr:10.130.245.230 Mask:255.255.255.252inet addr:127.0.0.1 Mask:255.0.0.0 é‚£ä¹ˆ 10.130.245.230 å°±æ˜¯è®¾å¤‡ IP åœ°å€ã€‚ åœ¨æœ‰çš„è®¾å¤‡ä¸Šè¿™ä¸ªå‘½ä»¤æ²¡æœ‰è¾“å‡ºï¼Œå¦‚æœè®¾å¤‡è¿ç€ WiFiï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ¥æŸ¥çœ‹å±€åŸŸç½‘ IPï¼š 1adb shell ifconfig wlan0 è¾“å‡ºç¤ºä¾‹ï¼š 1wlan0: ip 10.129.160.99 mask 255.255.240.0 flags [up broadcast running multicast] æˆ– 12345678wlan0 Link encap:UNSPEC inet addr:10.129.168.57 Bcast:10.129.175.255 Mask:255.255.240.0 inet6 addr: fe80::66cc:2eff:fe68:b6b6/64 Scope: Link UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1 RX packets:496520 errors:0 dropped:0 overruns:0 frame:0 TX packets:68215 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:3000 RX bytes:116266821 TX bytes:8311736 å¦‚æœä»¥ä¸Šå‘½ä»¤ä»ç„¶ä¸èƒ½å¾—åˆ°æœŸæœ›çš„ä¿¡æ¯ï¼Œé‚£å¯ä»¥è¯•è¯•ä»¥ä¸‹å‘½ä»¤ï¼ˆéƒ¨åˆ†ç³»ç»Ÿç‰ˆæœ¬é‡Œå¯ç”¨ï¼‰ï¼š 1adb shell netcfg è¾“å‡ºç¤ºä¾‹ï¼š 123456789101112131415161718192021wlan0 UP 10.129.160.99/20 0x00001043 f8:a9:d0:17:42:4dlo UP 127.0.0.1/8 0x00000049 00:00:00:00:00:00p2p0 UP 0.0.0.0/0 0x00001003 fa:a9:d0:17:42:4dsit0 DOWN 0.0.0.0/0 0x00000080 00:00:00:00:00:00rmnet0 DOWN 0.0.0.0/0 0x00000000 00:00:00:00:00:00rmnet1 DOWN 0.0.0.0/0 0x00000000 00:00:00:00:00:00rmnet3 DOWN 0.0.0.0/0 0x00000000 00:00:00:00:00:00rmnet2 DOWN 0.0.0.0/0 0x00000000 00:00:00:00:00:00rmnet4 DOWN 0.0.0.0/0 0x00000000 00:00:00:00:00:00rmnet6 DOWN 0.0.0.0/0 0x00000000 00:00:00:00:00:00rmnet5 DOWN 0.0.0.0/0 0x00000000 00:00:00:00:00:00rmnet7 DOWN 0.0.0.0/0 0x00000000 00:00:00:00:00:00rev_rmnet3 DOWN 0.0.0.0/0 0x00001002 4e:b7:e4:2e:17:58rev_rmnet2 DOWN 0.0.0.0/0 0x00001002 4e:f0:c8:bf:7a:cfrev_rmnet4 DOWN 0.0.0.0/0 0x00001002 a6:c0:3b:6b:c4:1frev_rmnet6 DOWN 0.0.0.0/0 0x00001002 66:bb:5d:64:2e:e9rev_rmnet5 DOWN 0.0.0.0/0 0x00001002 0e:1b:eb:b9:23:a0rev_rmnet7 DOWN 0.0.0.0/0 0x00001002 7a:d9:f6:81:40:5arev_rmnet8 DOWN 0.0.0.0/0 0x00001002 4e:e2:a9:bb:d0:1brev_rmnet0 DOWN 0.0.0.0/0 0x00001002 fe:65:d0:ca:82:a9rev_rmnet1 DOWN 0.0.0.0/0 0x00001002 da:d8:e8:4f:2e:fe å¯ä»¥çœ‹åˆ°ç½‘ç»œè¿æ¥åç§°ã€å¯ç”¨çŠ¶æ€ã€IP åœ°å€å’Œ Mac åœ°å€ç­‰ä¿¡æ¯ã€‚ Mac åœ°å€å‘½ä»¤ï¼š 1adb shell cat /sys/class/net/wlan0/address è¾“å‡ºç¤ºä¾‹ï¼š 1f8:a9:d0:17:42:4d è¿™æŸ¥çœ‹çš„æ˜¯å±€åŸŸç½‘ Mac åœ°å€ï¼Œç§»åŠ¨ç½‘ç»œæˆ–å…¶å®ƒè¿æ¥çš„ä¿¡æ¯å¯ä»¥é€šè¿‡å‰é¢çš„å°èŠ‚ã€ŒIP åœ°å€ã€é‡Œæåˆ°çš„ adb shell netcfg å‘½ä»¤æ¥æŸ¥çœ‹ã€‚ CPU ä¿¡æ¯å‘½ä»¤ï¼š 1adb shell cat /proc/cpuinfo è¾“å‡ºç¤ºä¾‹ï¼š 1234567891011121314151617181920212223Processor : ARMv7 Processor rev 0 (v7l)processor : 0BogoMIPS : 38.40processor : 1BogoMIPS : 38.40processor : 2BogoMIPS : 38.40processor : 3BogoMIPS : 38.40Features : swp half thumb fastmult vfp edsp neon vfpv3 tls vfpv4 idiva idivtCPU implementer : 0x51CPU architecture: 7CPU variant : 0x2CPU part : 0x06fCPU revision : 0Hardware : Qualcomm MSM 8974 HAMMERHEAD (Flattened Device Tree)Revision : 000bSerial : 0000000000000000 è¿™æ˜¯ Nexus 5 çš„ CPU ä¿¡æ¯ï¼Œæˆ‘ä»¬ä»è¾“å‡ºé‡Œå¯ä»¥çœ‹åˆ°ä½¿ç”¨çš„ç¡¬ä»¶æ˜¯ Qualcomm MSM 8974ï¼Œprocessor çš„ç¼–å·æ˜¯ 0 åˆ° 3ï¼Œæ‰€ä»¥å®ƒæ˜¯å››æ ¸çš„ï¼Œé‡‡ç”¨çš„æ¶æ„æ˜¯ ARMv7 Processor rev 0 (v71)ã€‚ å†…å­˜ä¿¡æ¯å‘½ä»¤ï¼š 1adb shell cat /proc/meminfo è¾“å‡ºç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637MemTotal: 1027424 kBMemFree: 486564 kBBuffers: 15224 kBCached: 72464 kBSwapCached: 24152 kBActive: 110572 kBInactive: 259060 kBActive(anon): 79176 kBInactive(anon): 207736 kBActive(file): 31396 kBInactive(file): 51324 kBUnevictable: 3948 kBMlocked: 0 kBHighTotal: 409600 kBHighFree: 132612 kBLowTotal: 617824 kBLowFree: 353952 kBSwapTotal: 262140 kBSwapFree: 207572 kBDirty: 0 kBWriteback: 0 kBAnonPages: 265324 kBMapped: 47072 kBShmem: 1020 kBSlab: 57372 kBSReclaimable: 7692 kBSUnreclaim: 49680 kBKernelStack: 4512 kBPageTables: 5912 kBNFS_Unstable: 0 kBBounce: 0 kBWritebackTmp: 0 kBCommitLimit: 775852 kBCommitted_AS: 13520632 kBVmallocTotal: 385024 kBVmallocUsed: 61004 kBVmallocChunk: 209668 kB å…¶ä¸­ï¼ŒMemTotal å°±æ˜¯è®¾å¤‡çš„æ€»å†…å­˜ï¼ŒMemFree æ˜¯å½“å‰ç©ºé—²å†…å­˜ã€‚ æ›´å¤šç¡¬ä»¶ä¸ç³»ç»Ÿå±æ€§è®¾å¤‡çš„æ›´å¤šç¡¬ä»¶ä¸ç³»ç»Ÿå±æ€§å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š 1adb shell cat /system/build.prop è¿™ä¼šè¾“å‡ºå¾ˆå¤šä¿¡æ¯ï¼ŒåŒ…æ‹¬å‰é¢å‡ ä¸ªå°èŠ‚æåˆ°çš„ã€Œå‹å·ã€å’Œã€ŒAndroid ç³»ç»Ÿç‰ˆæœ¬ã€ç­‰ã€‚ è¾“å‡ºé‡Œè¿˜åŒ…æ‹¬ä¸€äº›å…¶å®ƒæœ‰ç”¨çš„ä¿¡æ¯ï¼Œå®ƒä»¬ä¹Ÿå¯é€šè¿‡ adb shell getprop &lt;å±æ€§å&gt; å‘½ä»¤å•ç‹¬æŸ¥çœ‹ï¼Œåˆ—ä¸¾ä¸€éƒ¨åˆ†å±æ€§å¦‚ä¸‹ï¼š å±æ€§å å«ä¹‰ ro.build.version.sdk SDK ç‰ˆæœ¬ ro.build.version.release Android ç³»ç»Ÿç‰ˆæœ¬ ro.build.version.security_patch Android å®‰å…¨è¡¥ä¸ç¨‹åºçº§åˆ« ro.product.model å‹å· ro.product.brand å“ç‰Œ ro.product.name è®¾å¤‡å ro.product.board å¤„ç†å™¨å‹å· ro.product.cpu.abilist CPU æ”¯æŒçš„ abi åˆ—è¡¨[èŠ‚æ³¨ä¸€] persist.sys.isUsbOtgEnabled æ˜¯å¦æ”¯æŒ OTG dalvik.vm.heapsize æ¯ä¸ªåº”ç”¨ç¨‹åºçš„å†…å­˜ä¸Šé™ ro.sf.lcd_density å±å¹•å¯†åº¦ èŠ‚æ³¨ä¸€ï¼š ä¸€äº›å°å‚å®šåˆ¶çš„ ROM å¯èƒ½ä¿®æ”¹è¿‡ CPU æ”¯æŒçš„ abi åˆ—è¡¨çš„å±æ€§åï¼Œå¦‚æœç”¨ ro.product.cpu.abilist å±æ€§åæŸ¥æ‰¾ä¸åˆ°ï¼Œå¯ä»¥è¿™æ ·è¯•è¯•ï¼š 1adb shell cat /system/build.prop | grep ro.product.cpu.abi ç¤ºä¾‹è¾“å‡ºï¼š 12ro.product.cpu.abi=armeabi-v7aro.product.cpu.abi2=armeabi ä¿®æ”¹è®¾ç½®æ³¨ï¼š ä¿®æ”¹è®¾ç½®ä¹‹åï¼Œè¿è¡Œæ¢å¤å‘½ä»¤æœ‰å¯èƒ½æ˜¾ç¤ºä»ç„¶ä¸å¤ªæ­£å¸¸ï¼Œå¯ä»¥è¿è¡Œ adb reboot é‡å¯è®¾å¤‡ï¼Œæˆ–æ‰‹åŠ¨é‡å¯ã€‚ ä¿®æ”¹è®¾ç½®çš„åŸç†ä¸»è¦æ˜¯é€šè¿‡ settings å‘½ä»¤ä¿®æ”¹ /data/data/com.android.providers.settings/databases/settings.db é‡Œå­˜æ”¾çš„è®¾ç½®å€¼ã€‚ åˆ†è¾¨ç‡å‘½ä»¤ï¼š 1adb shell wm size 480x1024 è¡¨ç¤ºå°†åˆ†è¾¨ç‡ä¿®æ”¹ä¸º 480px * 1024pxã€‚ æ¢å¤åŸåˆ†è¾¨ç‡å‘½ä»¤ï¼š 1adb shell wm size reset å±å¹•å¯†åº¦å‘½ä»¤ï¼š 1adb shell wm density 160 è¡¨ç¤ºå°†å±å¹•å¯†åº¦ä¿®æ”¹ä¸º 160dpiã€‚ æ¢å¤åŸå±å¹•å¯†åº¦å‘½ä»¤ï¼š 1adb shell wm density reset æ˜¾ç¤ºåŒºåŸŸå‘½ä»¤ï¼š 1adb shell wm overscan 0,0,0,200 å››ä¸ªæ•°å­—åˆ†åˆ«è¡¨ç¤ºè·ç¦»å·¦ã€ä¸Šã€å³ã€ä¸‹è¾¹ç¼˜çš„ç•™ç™½åƒç´ ï¼Œä»¥ä¸Šå‘½ä»¤è¡¨ç¤ºå°†å±å¹•åº•éƒ¨ 200px ç•™ç™½ã€‚ æ¢å¤åŸæ˜¾ç¤ºåŒºåŸŸå‘½ä»¤ï¼š 1adb shell wm overscan reset å…³é—­ USB è°ƒè¯•æ¨¡å¼å‘½ä»¤ï¼š 1adb shell settings put global adb_enabled 0 æ¢å¤ï¼š ç”¨å‘½ä»¤æ¢å¤ä¸äº†äº†ï¼Œæ¯•ç«Ÿå…³é—­äº† USB è°ƒè¯• adb å°±è¿æ¥ä¸ä¸Š Android è®¾å¤‡äº†ã€‚ å»è®¾å¤‡ä¸Šæ‰‹åŠ¨æ¢å¤å§ï¼šã€Œè®¾ç½®ã€-ã€Œå¼€å‘è€…é€‰é¡¹ã€-ã€ŒAndroid è°ƒè¯•ã€ã€‚ å…è®¸/ç¦æ­¢è®¿é—®é SDK APIå…è®¸è®¿é—®é SDK APIï¼š 12adb shell settings put global hidden_api_policy_pre_p_apps 1adb shell settings put global hidden_api_policy_p_apps 1 ç¦æ­¢è®¿é—®é SDK APIï¼š 12adb shell settings delete global hidden_api_policy_pre_p_appsadb shell settings delete global hidden_api_policy_p_apps ä¸éœ€è¦è®¾å¤‡è·å¾— Root æƒé™ã€‚ å‘½ä»¤æœ€åçš„æ•°å­—çš„å«ä¹‰ï¼š å€¼ å«ä¹‰ 0 ç¦æ­¢æ£€æµ‹é SDK æ¥å£çš„è°ƒç”¨ã€‚è¯¥æƒ…å†µä¸‹ï¼Œæ—¥å¿—è®°å½•åŠŸèƒ½è¢«ç¦ç”¨ï¼Œå¹¶ä¸”ä»¤ strict mode APIï¼Œå³ detectNonSdkApiUsage() æ— æ•ˆã€‚ä¸æ¨èã€‚ 1 ä»…è­¦å‘Šâ€”â€”å…è®¸è®¿é—®æ‰€æœ‰é SDK æ¥å£ï¼Œä½†ä¿ç•™æ—¥å¿—ä¸­çš„è­¦å‘Šä¿¡æ¯ï¼Œå¯ç»§ç»­ä½¿ç”¨ strick mode APIã€‚ 2 ç¦æ­¢è°ƒç”¨æ·±ç°åå•å’Œé»‘åå•ä¸­çš„æ¥å£ã€‚ 3 ç¦æ­¢è°ƒç”¨é»‘åå•ä¸­çš„æ¥å£ï¼Œä½†å…è®¸è°ƒç”¨æ·±ç°åå•ä¸­çš„æ¥å£ã€‚ çŠ¶æ€æ å’Œå¯¼èˆªæ çš„æ˜¾ç¤ºéšè—æœ¬èŠ‚æ‰€è¯´çš„ç›¸å…³è®¾ç½®å¯¹åº” Cyanogenmod é‡Œçš„ã€Œæ‰©å±•æ¡Œé¢ã€ã€‚ å‘½ä»¤ï¼š 1adb shell settings put global policy_control &lt;key-values&gt; &lt;key-values&gt; å¯ç”±å¦‚ä¸‹å‡ ç§é”®åŠå…¶å¯¹åº”çš„å€¼ç»„æˆï¼Œæ ¼å¼ä¸º &lt;key1&gt;=&lt;value1&gt;:&lt;key2&gt;=&lt;value2&gt;ã€‚ key å«ä¹‰ immersive.full åŒæ—¶éšè— immersive.status éšè—çŠ¶æ€æ  immersive.navigation éšè—å¯¼èˆªæ  immersive.preconfirms ? è¿™äº›é”®å¯¹åº”çš„å€¼å¯åˆ™å¦‚ä¸‹å€¼ç”¨é€—å·ç»„åˆï¼š value å«ä¹‰ apps æ‰€æœ‰åº”ç”¨ * æ‰€æœ‰ç•Œé¢ packagename æŒ‡å®šåº”ç”¨ -packagename æ’é™¤æŒ‡å®šåº”ç”¨ ä¾‹å¦‚ï¼š 1adb shell settings put global policy_control immersive.full=* è¡¨ç¤ºè®¾ç½®åœ¨æ‰€æœ‰ç•Œé¢ä¸‹éƒ½åŒæ—¶éšè—çŠ¶æ€æ å’Œå¯¼èˆªæ ã€‚ 1adb shell settings put global policy_control immersive.status=com.package1,com.package2:immersive.navigation=apps,-com.package3 è¡¨ç¤ºè®¾ç½®åœ¨åŒ…åä¸º com.package1 å’Œ com.package2 çš„åº”ç”¨é‡Œéšè—çŠ¶æ€æ ï¼Œåœ¨é™¤äº†åŒ…åä¸º com.package3 çš„æ‰€æœ‰åº”ç”¨é‡Œéšè—å¯¼èˆªæ ã€‚ å®ç”¨åŠŸèƒ½å±å¹•æˆªå›¾æˆªå›¾ä¿å­˜åˆ°ç”µè„‘ï¼š 1adb exec-out screencap -p &gt; sc.png å¦‚æœ adb ç‰ˆæœ¬è¾ƒè€ï¼Œæ— æ³•ä½¿ç”¨ exec-out å‘½ä»¤ï¼Œè¿™æ—¶å€™å»ºè®®æ›´æ–° adb ç‰ˆæœ¬ã€‚æ— æ³•æ›´æ–°çš„è¯å¯ä»¥ä½¿ç”¨ä»¥ä¸‹éº»çƒ¦ç‚¹çš„åŠæ³•ï¼š å…ˆæˆªå›¾ä¿å­˜åˆ°è®¾å¤‡é‡Œï¼š 1adb shell screencap -p /sdcard/sc.png ç„¶åå°† png æ–‡ä»¶å¯¼å‡ºåˆ°ç”µè„‘ï¼š 1adb pull /sdcard/sc.png å¯ä»¥ä½¿ç”¨ adb shell screencap -h æŸ¥çœ‹ screencap å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªæœ‰æ„ä¹‰çš„å‚æ•°åŠå«ä¹‰ï¼š å‚æ•° å«ä¹‰ -p æŒ‡å®šä¿å­˜æ–‡ä»¶ä¸º png æ ¼å¼ -d display-id æŒ‡å®šæˆªå›¾çš„æ˜¾ç¤ºå±ç¼–å·ï¼ˆæœ‰å¤šæ˜¾ç¤ºå±çš„æƒ…å†µä¸‹ï¼‰ å®æµ‹å¦‚æœæŒ‡å®šæ–‡ä»¶åä»¥ .png ç»“å°¾æ—¶å¯ä»¥çœç•¥ -p å‚æ•°ï¼›å¦åˆ™éœ€è¦ä½¿ç”¨ -p å‚æ•°ã€‚å¦‚æœä¸æŒ‡å®šæ–‡ä»¶åï¼Œæˆªå›¾æ–‡ä»¶çš„å†…å®¹å°†ç›´æ¥è¾“å‡ºåˆ° stdoutã€‚ å¦å¤–ä¸€ç§ä¸€è¡Œå‘½ä»¤æˆªå›¾å¹¶ä¿å­˜åˆ°ç”µè„‘çš„æ–¹æ³•ï¼š Linux å’Œ Windows 1adb shell screencap -p | sed \"s/\\r$//\" &gt; sc.png Mac OS X 1adb shell screencap -p | gsed \"s/\\r$//\" &gt; sc.png è¿™ä¸ªæ–¹æ³•éœ€è¦ç”¨åˆ° gnu sed å‘½ä»¤ï¼Œåœ¨ Linux ä¸‹ç›´æ¥å°±æœ‰ï¼Œåœ¨ Windows ä¸‹ Git å®‰è£…ç›®å½•çš„ bin æ–‡ä»¶å¤¹ä¸‹ä¹Ÿæœ‰ã€‚å¦‚æœç¡®å®æ‰¾ä¸åˆ°è¯¥å‘½ä»¤ï¼Œå¯ä»¥ä¸‹è½½ sed for Windows å¹¶å°† sed.exe æ‰€åœ¨æ–‡ä»¶å¤¹æ·»åŠ åˆ° PATH ç¯å¢ƒå˜é‡é‡Œã€‚ è€Œåœ¨ Mac ä¸‹ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ sed å‘½ä»¤ä¼šæŠ¥é”™ï¼š 1sed: RE error: illegal byte sequence éœ€è¦å®‰è£… gnu-sedï¼Œç„¶åä½¿ç”¨ gsed å‘½ä»¤ï¼š 1brew install gnu-sed å½•åˆ¶å±å¹•å½•åˆ¶å±å¹•ä»¥ mp4 æ ¼å¼ä¿å­˜åˆ° /sdcardï¼š 1adb shell screenrecord /sdcard/filename.mp4 éœ€è¦åœæ­¢æ—¶æŒ‰ Ctrl-Cï¼Œé»˜è®¤å½•åˆ¶æ—¶é—´å’Œæœ€é•¿å½•åˆ¶æ—¶é—´éƒ½æ˜¯ 180 ç§’ã€‚ å¦‚æœéœ€è¦å¯¼å‡ºåˆ°ç”µè„‘ï¼š 1adb pull /sdcard/filename.mp4 å¯ä»¥ä½¿ç”¨ adb shell screenrecord --help æŸ¥çœ‹ screenrecord å‘½ä»¤çš„å¸®åŠ©ä¿¡æ¯ï¼Œä¸‹é¢æ˜¯å¸¸è§å‚æ•°åŠå«ä¹‰ï¼š å‚æ•° å«ä¹‰ â€“size WIDTHxHEIGHT è§†é¢‘çš„å°ºå¯¸ï¼Œæ¯”å¦‚ 1280x720ï¼Œé»˜è®¤æ˜¯å±å¹•åˆ†è¾¨ç‡ã€‚ â€“bit-rate RATE è§†é¢‘çš„æ¯”ç‰¹ç‡ï¼Œé»˜è®¤æ˜¯ 4Mbpsã€‚ â€“time-limit TIME å½•åˆ¶æ—¶é•¿ï¼Œå•ä½ç§’ã€‚ â€“verbose è¾“å‡ºæ›´å¤šä¿¡æ¯ã€‚ é‡æ–°æŒ‚è½½ system åˆ†åŒºä¸ºå¯å†™æ³¨ï¼šéœ€è¦ root æƒé™ã€‚ /system åˆ†åŒºé»˜è®¤æŒ‚è½½ä¸ºåªè¯»ï¼Œä½†æœ‰äº›æ“ä½œæ¯”å¦‚ç»™ Android ç³»ç»Ÿæ·»åŠ å‘½ä»¤ã€åˆ é™¤è‡ªå¸¦åº”ç”¨ç­‰éœ€è¦å¯¹ /system è¿›è¡Œå†™æ“ä½œï¼Œæ‰€ä»¥éœ€è¦é‡æ–°æŒ‚è½½å®ƒä¸ºå¯è¯»å†™ã€‚ æ­¥éª¤ï¼š è¿›å…¥ shell å¹¶åˆ‡æ¢åˆ° root ç”¨æˆ·æƒé™ã€‚ å‘½ä»¤ï¼š 12adb shellsu æŸ¥çœ‹å½“å‰åˆ†åŒºæŒ‚è½½æƒ…å†µã€‚ å‘½ä»¤ï¼š 1mount è¾“å‡ºç¤ºä¾‹ï¼š 12345678910111213141516171819202122232425rootfs / rootfs ro,relatime 0 0tmpfs /dev tmpfs rw,seclabel,nosuid,relatime,mode=755 0 0devpts /dev/pts devpts rw,seclabel,relatime,mode=600 0 0proc /proc proc rw,relatime 0 0sysfs /sys sysfs rw,seclabel,relatime 0 0selinuxfs /sys/fs/selinux selinuxfs rw,relatime 0 0debugfs /sys/kernel/debug debugfs rw,relatime 0 0none /var tmpfs rw,seclabel,relatime,mode=770,gid=1000 0 0none /acct cgroup rw,relatime,cpuacct 0 0none /sys/fs/cgroup tmpfs rw,seclabel,relatime,mode=750,gid=1000 0 0none /sys/fs/cgroup/memory cgroup rw,relatime,memory 0 0tmpfs /mnt/asec tmpfs rw,seclabel,relatime,mode=755,gid=1000 0 0tmpfs /mnt/obb tmpfs rw,seclabel,relatime,mode=755,gid=1000 0 0none /dev/memcg cgroup rw,relatime,memory 0 0none /dev/cpuctl cgroup rw,relatime,cpu 0 0none /sys/fs/cgroup tmpfs rw,seclabel,relatime,mode=750,gid=1000 0 0none /sys/fs/cgroup/memory cgroup rw,relatime,memory 0 0none /sys/fs/cgroup/freezer cgroup rw,relatime,freezer 0 0/dev/block/platform/msm_sdcc.1/by-name/system /system ext4 ro,seclabel,relatime,data=ordered 0 0/dev/block/platform/msm_sdcc.1/by-name/userdata /data ext4 rw,seclabel,nosuid,nodev,relatime,noauto_da_alloc,data=ordered 0 0/dev/block/platform/msm_sdcc.1/by-name/cache /cache ext4 rw,seclabel,nosuid,nodev,relatime,data=ordered 0 0/dev/block/platform/msm_sdcc.1/by-name/persist /persist ext4 rw,seclabel,nosuid,nodev,relatime,data=ordered 0 0/dev/block/platform/msm_sdcc.1/by-name/modem /firmware vfat ro,context=u:object_r:firmware_file:s0,relatime,uid=1000,gid=1000,fmask=0337,dmask=0227,codepage=cp437,iocharset=iso8859-1,shortname=lower,errors=remount-ro 0 0/dev/fuse /mnt/shell/emulated fuse rw,nosuid,nodev,relatime,user_id=1023,group_id=1023,default_permissions,allow_other 0 0/dev/fuse /mnt/shell/emulated/0 fuse rw,nosuid,nodev,relatime,user_id=1023,group_id=1023,default_permissions,allow_other 0 0 æ‰¾åˆ°å…¶ä¸­æˆ‘ä»¬å…³æ³¨çš„å¸¦ /system çš„é‚£ä¸€è¡Œï¼š 1/dev/block/platform/msm_sdcc.1/by-name/system /system ext4 ro,seclabel,relatime,data=ordered 0 0 é‡æ–°æŒ‚è½½ã€‚ å‘½ä»¤ï¼š 1mount -o remount,rw -t yaffs2 /dev/block/platform/msm_sdcc.1/by-name/system /system è¿™é‡Œçš„ /dev/block/platform/msm_sdcc.1/by-name/system å°±æ˜¯æˆ‘ä»¬ä»ä¸Šä¸€æ­¥çš„è¾“å‡ºé‡Œå¾—åˆ°çš„æ–‡ä»¶è·¯å¾„ã€‚ å¦‚æœè¾“å‡ºæ²¡æœ‰æç¤ºé”™è¯¯çš„è¯ï¼Œæ“ä½œå°±æˆåŠŸäº†ï¼Œå¯ä»¥å¯¹ /system ä¸‹çš„æ–‡ä»¶ä¸ºæ‰€æ¬²ä¸ºäº†ã€‚ æŸ¥çœ‹è¿æ¥è¿‡çš„ WiFi å¯†ç æ³¨ï¼šéœ€è¦ root æƒé™ã€‚ å‘½ä»¤ï¼š 123adb shellsucat /data/misc/wifi/*.conf è¾“å‡ºç¤ºä¾‹ï¼š 123456789101112131415161718network={ ssid=\"TP-LINK_9DFC\" scan_ssid=1 psk=\"123456789\" key_mgmt=WPA-PSK group=CCMP TKIP auth_alg=OPEN sim_num=1 priority=13893}network={ ssid=\"TP-LINK_F11E\" psk=\"987654321\" key_mgmt=WPA-PSK sim_num=1 priority=17293} ssid å³ä¸ºæˆ‘ä»¬åœ¨ WLAN è®¾ç½®é‡Œçœ‹åˆ°çš„åç§°ï¼Œpsk ä¸ºå¯†ç ï¼Œkey_mgmt ä¸ºå®‰å…¨åŠ å¯†æ–¹å¼ã€‚ è®¾ç½®ç³»ç»Ÿæ—¥æœŸå’Œæ—¶é—´æ³¨ï¼šéœ€è¦ root æƒé™ã€‚ å‘½ä»¤ï¼š 123adb shellsudate -s 20160823.131500 è¡¨ç¤ºå°†ç³»ç»Ÿæ—¥æœŸå’Œæ—¶é—´æ›´æ”¹ä¸º 2016 å¹´ 08 æœˆ 23 æ—¥ 13 ç‚¹ 15 åˆ† 00 ç§’ã€‚ é‡å¯æ‰‹æœºå‘½ä»¤ï¼š 1adb reboot æ£€æµ‹è®¾å¤‡æ˜¯å¦å·² rootå‘½ä»¤ï¼š 12adb shellsu æ­¤æ—¶å‘½ä»¤è¡Œæç¤ºç¬¦æ˜¯ $ åˆ™è¡¨ç¤ºæ²¡æœ‰ root æƒé™ï¼Œæ˜¯ # åˆ™è¡¨ç¤ºå·² rootã€‚ ä½¿ç”¨ Monkey è¿›è¡Œå‹åŠ›æµ‹è¯•Monkey å¯ä»¥ç”Ÿæˆä¼ªéšæœºç”¨æˆ·äº‹ä»¶æ¥æ¨¡æ‹Ÿå•å‡»ã€è§¦æ‘¸ã€æ‰‹åŠ¿ç­‰æ“ä½œï¼Œå¯ä»¥å¯¹æ­£åœ¨å¼€å‘ä¸­çš„ç¨‹åºè¿›è¡Œéšæœºå‹åŠ›æµ‹è¯•ã€‚ ç®€å•ç”¨æ³•ï¼š 1adb shell monkey -p &lt;packagename&gt; -v 500 è¡¨ç¤ºå‘ &lt;packagename&gt; æŒ‡å®šçš„åº”ç”¨ç¨‹åºå‘é€ 500 ä¸ªä¼ªéšæœºäº‹ä»¶ã€‚ Monkey çš„è¯¦ç»†ç”¨æ³•å‚è€ƒ å®˜æ–¹æ–‡æ¡£ã€‚ å¼€å¯/å…³é—­ WiFiæ³¨ï¼šéœ€è¦ root æƒé™ã€‚ æœ‰æ—¶éœ€è¦æ§åˆ¶è®¾å¤‡çš„ WiFi çŠ¶æ€ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹æŒ‡ä»¤å®Œæˆã€‚ å¼€å¯ WiFiï¼š 12adb rootadb shell svc wifi enable å…³é—­ WiFiï¼š 12adb rootadb shell svc wifi disable è‹¥æ‰§è¡ŒæˆåŠŸï¼Œè¾“å‡ºä¸ºç©ºï¼›è‹¥æœªå–å¾— root æƒé™æ‰§è¡Œæ­¤å‘½ä»¤ï¼Œå°†æ‰§è¡Œå¤±è´¥ï¼Œè¾“å‡º Killedã€‚ åˆ·æœºç›¸å…³å‘½ä»¤é‡å¯åˆ° Recovery æ¨¡å¼å‘½ä»¤ï¼š 1adb reboot recovery ä» Recovery é‡å¯åˆ° Androidå‘½ä»¤ï¼š 1adb reboot é‡å¯åˆ° Fastboot æ¨¡å¼å‘½ä»¤ï¼š 1adb reboot bootloader é€šè¿‡ sideload æ›´æ–°ç³»ç»Ÿå¦‚æœæˆ‘ä»¬ä¸‹è½½äº† Android è®¾å¤‡å¯¹åº”çš„ç³»ç»Ÿæ›´æ–°åŒ…åˆ°ç”µè„‘ä¸Šï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥é€šè¿‡ adb æ¥å®Œæˆæ›´æ–°ã€‚ ä»¥ Recovery æ¨¡å¼ä¸‹æ›´æ–°ä¸ºä¾‹ï¼š é‡å¯åˆ° Recovery æ¨¡å¼ã€‚ å‘½ä»¤ï¼š 1adb reboot recovery åœ¨è®¾å¤‡çš„ Recovery ç•Œé¢ä¸Šæ“ä½œè¿›å…¥ Apply update-Apply from ADBã€‚ æ³¨ï¼šä¸åŒçš„ Recovery èœå•å¯èƒ½ä¸æ­¤æœ‰å·®å¼‚ï¼Œæœ‰çš„æ˜¯ä¸€çº§èœå•å°±æœ‰ Apply update from ADBã€‚ é€šè¿‡ adb ä¸Šä¼ å’Œæ›´æ–°ç³»ç»Ÿã€‚ å‘½ä»¤ï¼š 1adb sideload &lt;path-to-update.zip&gt; å®‰å…¨ç›¸å…³å‘½ä»¤å¯ç”¨/ç¦ç”¨ SELinuxå¯ç”¨ SELinux 12adb rootadb shell setenforce 1 ç¦ç”¨ SELinux 12adb rootadb shell setenforce 0 å¯ç”¨/ç¦ç”¨ dm_verityå¯ç”¨ dm_verity 12adb rootadb enable-verity ç¦ç”¨ dm_verity 12adb rootadb disable-verity æ›´å¤š adb shell å‘½ä»¤Android ç³»ç»Ÿæ˜¯åŸºäº Linux å†…æ ¸çš„ï¼Œæ‰€ä»¥ Linux é‡Œçš„å¾ˆå¤šå‘½ä»¤åœ¨ Android é‡Œä¹Ÿæœ‰ç›¸åŒæˆ–ç±»ä¼¼çš„å®ç°ï¼Œåœ¨ adb shell é‡Œå¯ä»¥è°ƒç”¨ã€‚æœ¬æ–‡æ¡£å‰é¢çš„éƒ¨åˆ†å†…å®¹å·²ç»ç”¨åˆ°äº† adb shell å‘½ä»¤ã€‚ æŸ¥çœ‹è¿›ç¨‹å‘½ä»¤ï¼š 1adb shell ps è¾“å‡ºç¤ºä¾‹ï¼š 12345678USER PID PPID VSIZE RSS WCHAN PC NAMEroot 1 0 8904 788 ffffffff 00000000 S /initroot 2 0 0 0 ffffffff 00000000 S kthreadd...u0_a71 7779 5926 1538748 48896 ffffffff 00000000 S com.sohu.inputmethod.sogou:classicu0_a58 7963 5926 1561916 59568 ffffffff 00000000 S org.mazhuang.boottimemeasure...shell 8750 217 10640 740 00000000 b6f28340 R ps å„åˆ—å«ä¹‰ï¼š åˆ—å å«ä¹‰ USER æ‰€å±ç”¨æˆ· PID è¿›ç¨‹ ID PPID çˆ¶è¿›ç¨‹ ID NAME è¿›ç¨‹å æŸ¥çœ‹å®æ—¶èµ„æºå ç”¨æƒ…å†µå‘½ä»¤ï¼š 1adb shell top è¾“å‡ºç¤ºä¾‹ï¼š 1234567891011121314User 0%, System 6%, IOW 0%, IRQ 0%User 3 + Nice 0 + Sys 21 + Idle 280 + IOW 0 + IRQ 0 + SIRQ 3 = 307 PID PR CPU% S #THR VSS RSS PCY UID Name 8763 0 3% R 1 10640K 1064K fg shell top 131 0 3% S 1 0K 0K fg root dhd_dpc 6144 0 0% S 115 1682004K 115916K fg system system_server 132 0 0% S 1 0K 0K fg root dhd_rxf 1731 0 0% S 6 20288K 788K fg root /system/bin/mpdecision 217 0 0% S 6 18008K 356K fg shell /sbin/adbd ... 7779 2 0% S 19 1538748K 48896K bg u0_a71 com.sohu.inputmethod.sogou:classic 7963 0 0% S 18 1561916K 59568K fg u0_a58 org.mazhuang.boottimemeasure ... å„åˆ—å«ä¹‰ï¼š åˆ—å å«ä¹‰ PID è¿›ç¨‹ ID PR ä¼˜å…ˆçº§ CPU% å½“å‰ç¬é—´å ç”¨ CPU ç™¾åˆ†æ¯” S è¿›ç¨‹çŠ¶æ€ï¼ˆR=è¿è¡Œï¼ŒS=ç¡çœ ï¼ŒT=è·Ÿè¸ª/åœæ­¢ï¼ŒZ=åƒµå°¸è¿›ç¨‹ï¼‰ #THR çº¿ç¨‹æ•° VSS Virtual Set Size è™šæ‹Ÿè€—ç”¨å†…å­˜ï¼ˆåŒ…å«å…±äº«åº“å ç”¨çš„å†…å­˜ï¼‰ RSS Resident Set Size å®é™…ä½¿ç”¨ç‰©ç†å†…å­˜ï¼ˆåŒ…å«å…±äº«åº“å ç”¨çš„å†…å­˜ï¼‰ PCY è°ƒåº¦ç­–ç•¥ä¼˜å…ˆçº§ï¼ŒSP_BACKGROUND/SPFOREGROUND UID è¿›ç¨‹æ‰€æœ‰è€…çš„ç”¨æˆ· ID NAME è¿›ç¨‹å top å‘½ä»¤è¿˜æ”¯æŒä¸€äº›å‘½ä»¤è¡Œå‚æ•°ï¼Œè¯¦ç»†ç”¨æ³•å¦‚ä¸‹ï¼š 1234567Usage: top [ -m max_procs ] [ -n iterations ] [ -d delay ] [ -s sort_column ] [ -t ] [ -h ] -m num æœ€å¤šæ˜¾ç¤ºå¤šå°‘ä¸ªè¿›ç¨‹ -n num åˆ·æ–°å¤šå°‘æ¬¡åé€€å‡º -d num åˆ·æ–°æ—¶é—´é—´éš”ï¼ˆå•ä½ç§’ï¼Œé»˜è®¤å€¼ 5ï¼‰ -s col æŒ‰æŸåˆ—æ’åºï¼ˆå¯ç”¨ col å€¼ï¼šcpu, vss, rss, thrï¼‰ -t æ˜¾ç¤ºçº¿ç¨‹ä¿¡æ¯ -h æ˜¾ç¤ºå¸®åŠ©æ–‡æ¡£ æŸ¥çœ‹è¿›ç¨‹ UIDæœ‰ä¸¤ç§æ–¹æ¡ˆï¼š adb shell dumpsys package &lt;packagename&gt; | grep userId= å¦‚ï¼š 12$ adb shell dumpsys package org.mazhuang.guanggoo | grep userId= userId=10394 é€šè¿‡ ps å‘½ä»¤æ‰¾åˆ°å¯¹åº”è¿›ç¨‹çš„ pid ä¹‹å adb shell cat /proc/&lt;pid&gt;/status | grep Uid å¦‚ï¼š 123456$ adb shellgemini:/ $ ps | grep org.mazhuang.guanggoou0_a394 28635 770 1795812 78736 SyS_epoll_ 0000000000 S org.mazhuang.guanggoogemini:/ $ cat /proc/28635/status | grep UidUid: 10394 10394 10394 10394gemini:/ $ å…¶å®ƒå¦‚ä¸‹æ˜¯å…¶å®ƒå¸¸ç”¨å‘½ä»¤çš„ç®€å•æè¿°ï¼Œå‰æ–‡å·²ç»ä¸“é—¨è®²è¿‡çš„å‘½ä»¤ä¸å†é¢å¤–è¯´æ˜ï¼š å‘½ä»¤ åŠŸèƒ½ cat æ˜¾ç¤ºæ–‡ä»¶å†…å®¹ cd åˆ‡æ¢ç›®å½• chmod æ”¹å˜æ–‡ä»¶çš„å­˜å–æ¨¡å¼/è®¿é—®æƒé™ df æŸ¥çœ‹ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ grep è¿‡æ»¤è¾“å‡º kill æ€æ­»æŒ‡å®š PID çš„è¿›ç¨‹ ls åˆ—ä¸¾ç›®å½•å†…å®¹ mount æŒ‚è½½ç›®å½•çš„æŸ¥çœ‹å’Œç®¡ç† mv ç§»åŠ¨æˆ–é‡å‘½åæ–‡ä»¶ ps æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹ rm åˆ é™¤æ–‡ä»¶ top æŸ¥çœ‹è¿›ç¨‹çš„èµ„æºå ç”¨æƒ…å†µ å¸¸è§é—®é¢˜å¯åŠ¨ adb server å¤±è´¥å‡ºé”™æç¤º 1error: protocol fault (couldn't read status): No error å¯èƒ½åŸå›  adb server è¿›ç¨‹æƒ³ä½¿ç”¨çš„ 5037 ç«¯å£è¢«å ç”¨ã€‚ è§£å†³æ–¹æ¡ˆ æ‰¾åˆ°å ç”¨ 5037 ç«¯å£çš„è¿›ç¨‹ï¼Œç„¶åç»ˆæ­¢å®ƒã€‚ä»¥ Windows ä¸‹ä¸ºä¾‹ï¼š 12345netstat -ano | findstr LISTENING...TCP 0.0.0.0:5037 0.0.0.0:0 LISTENING 1548... è¿™é‡Œ 1548 å³ä¸ºè¿›ç¨‹ IDï¼Œç”¨å‘½ä»¤ç»“æŸè¯¥è¿›ç¨‹ï¼š 1taskkill /PID 1548 ç„¶åå†å¯åŠ¨ adb å°±æ²¡é—®é¢˜äº†ã€‚ com.android.ddmlib.AdbCommandRejectedExceptionåœ¨ Android Studio é‡Œæ–°å»ºä¸€ä¸ªæ¨¡æ‹Ÿå™¨ï¼Œä½†æ˜¯ç”¨ adb ä¸€ç›´è¿æ¥ä¸ä¸Šï¼Œæç¤ºï¼š 1234com.android.ddmlib.AdbCommandRejectedException: device unauthorized.This adb server's $ADB_VENDOR_KEYS is not setTry 'adb kill-server' if that seems wrong.Otherwise check for a confirmation dialog on your device. åœ¨æ‰‹æœºä¸Šå®‰è£…ä¸€ä¸ªç»ˆç«¯ç„¶åæ‰§è¡Œ su æç¤ºæ²¡æœ‰è¯¥å‘½ä»¤ï¼Œè¿™ä¸æ­£å¸¸ã€‚ äºæ˜¯åˆ é™¤è¯¥æ¨¡æ‹Ÿå™¨åé‡æ–°ä¸‹è½½å®‰è£…ä¸€æ¬¡ï¼Œè¿™æ¬¡å°±æ­£å¸¸äº†ã€‚ adb çš„éå®˜æ–¹å®ç° fb-adb - A better shell for Android devices (for Mac). ç›¸å…³å‘½ä»¤ aapt am dumsys pm uiautomator è‡´è°¢æ„Ÿè°¢æœ‹å‹ä»¬æ— ç§çš„åˆ†äº«ä¸è¡¥å……ï¼ˆæ’åä¸åˆ†å…ˆåï¼‰ã€‚ zxningï¼Œlinhua55ï¼Œcodeskyblueï¼Œseasonyuuï¼Œfan123199ï¼ŒzhEdwardï¼Œ0x8BADFOODï¼Œkeith666666ï¼Œshawnlinboyï¼Œs-xqï¼Œlucky9322ã€‚ å‚è€ƒé“¾æ¥ Android Debug Bridge ADB Shell Commands logcat Command-line Tool Android ADBå‘½ä»¤å¤§å…¨ adb å‘½ä»¤è¡Œçš„ä½¿ç”¨è®°å½• Android ADBå‘½ä»¤å¤§å…¨(é€šè¿‡ADBå‘½ä»¤æŸ¥çœ‹wifiå¯†ç ã€MACåœ°å€ã€è®¾å¤‡ä¿¡æ¯ã€æ“ä½œæ–‡ä»¶ã€æŸ¥çœ‹æ–‡ä»¶ã€æ—¥å¿—ä¿¡æ¯ã€å¸è½½ã€å¯åŠ¨å’Œå®‰è£…APKç­‰) é‚£äº›åšAndroidå¼€å‘å¿…é¡»çŸ¥é“çš„ADBå‘½ä»¤ adb shell top åƒé«˜æ‰‹ä¸€æ ·ä½¿ç”¨ADBå‘½ä»¤è¡Œï¼ˆ2ï¼‰","link":"/2019/10/11/README/"}],"tags":[{"name":"Android","slug":"Android","link":"/tags/Android/"},{"name":"è“ç‰™å¼€å‘","slug":"è“ç‰™å¼€å‘","link":"/tags/%E8%93%9D%E7%89%99%E5%BC%80%E5%8F%91/"},{"name":"é¢è¯•é¢˜","slug":"é¢è¯•é¢˜","link":"/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/"},{"name":"å£çº¸è·¯å¾„","slug":"å£çº¸è·¯å¾„","link":"/tags/%E5%A3%81%E7%BA%B8%E8%B7%AF%E5%BE%84/"},{"name":"Macç³»ç»Ÿ","slug":"Macç³»ç»Ÿ","link":"/tags/Mac%E7%B3%BB%E7%BB%9F/"},{"name":"è°·æ­Œäº‘","slug":"è°·æ­Œäº‘","link":"/tags/%E8%B0%B7%E6%AD%8C%E4%BA%91/"},{"name":"soæ–‡ä»¶","slug":"soæ–‡ä»¶","link":"/tags/so%E6%96%87%E4%BB%B6/"},{"name":"ndk","slug":"ndk","link":"/tags/ndk/"},{"name":"ss","slug":"ss","link":"/tags/ss/"},{"name":"ç¿»å¢™","slug":"ç¿»å¢™","link":"/tags/%E7%BF%BB%E5%A2%99/"},{"name":"ssh","slug":"ssh","link":"/tags/ssh/"},{"name":"ShadowRocket","slug":"ShadowRocket","link":"/tags/ShadowRocket/"},{"name":"å°ç«ç®­","slug":"å°ç«ç®­","link":"/tags/%E5%B0%8F%E7%81%AB%E7%AE%AD/"},{"name":"Appstore","slug":"Appstore","link":"/tags/Appstore/"},{"name":"vpn","slug":"vpn","link":"/tags/vpn/"},{"name":"AAPT","slug":"AAPT","link":"/tags/AAPT/"},{"name":"AIDL","slug":"AIDL","link":"/tags/AIDL/"},{"name":"ApkBuilder","slug":"ApkBuilder","link":"/tags/ApkBuilder/"},{"name":"Dexå·¥å…·","slug":"Dexå·¥å…·","link":"/tags/Dex%E5%B7%A5%E5%85%B7/"},{"name":"zipalignå·¥å…·","slug":"zipalignå·¥å…·","link":"/tags/zipalign%E5%B7%A5%E5%85%B7/"},{"name":"keystore","slug":"keystore","link":"/tags/keystore/"},{"name":"Telegram","slug":"Telegram","link":"/tags/Telegram/"},{"name":"å¼€è½¦å¸æœº","slug":"å¼€è½¦å¸æœº","link":"/tags/%E5%BC%80%E8%BD%A6%E5%8F%B8%E6%9C%BA/"},{"name":"ç•ªå·","slug":"ç•ªå·","link":"/tags/%E7%95%AA%E5%8F%B7/"},{"name":"pornograhic","slug":"pornograhic","link":"/tags/pornograhic/"},{"name":"spread pornograhic content","slug":"spread-pornograhic-content","link":"/tags/spread-pornograhic-content/"},{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","link":"/tags/Java%E5%9F%BA%E7%A1%80/"},{"name":"åºåˆ—åŒ–","slug":"åºåˆ—åŒ–","link":"/tags/%E5%BA%8F%E5%88%97%E5%8C%96/"},{"name":"ClashX","slug":"ClashX","link":"/tags/ClashX/"},{"name":"åŠ é€Ÿå™¨","slug":"åŠ é€Ÿå™¨","link":"/tags/%E5%8A%A0%E9%80%9F%E5%99%A8/"},{"name":"Shadowsocks","slug":"Shadowsocks","link":"/tags/Shadowsocks/"},{"name":"V2Ray","slug":"V2Ray","link":"/tags/V2Ray/"},{"name":"æ¬ç“¦å·¥","slug":"æ¬ç“¦å·¥","link":"/tags/%E6%90%AC%E7%93%A6%E5%B7%A5/"},{"name":"ä¸²å£é€šè®¯","slug":"ä¸²å£é€šè®¯","link":"/tags/%E4%B8%B2%E5%8F%A3%E9%80%9A%E8%AE%AF/"},{"name":"Serialport","slug":"Serialport","link":"/tags/Serialport/"},{"name":"Java","slug":"Java","link":"/tags/Java/"},{"name":"Python3","slug":"Python3","link":"/tags/Python3/"},{"name":"TensorFlow","slug":"TensorFlow","link":"/tags/TensorFlow/"},{"name":"äººå·¥æ™ºèƒ½","slug":"äººå·¥æ™ºèƒ½","link":"/tags/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/"},{"name":"å°æ¸¸æˆå¼€å‘","slug":"å°æ¸¸æˆå¼€å‘","link":"/tags/%E5%B0%8F%E6%B8%B8%E6%88%8F%E5%BC%80%E5%8F%91/"},{"name":"ADB","slug":"ADB","link":"/tags/ADB/"},{"name":"çƒ­ä¿®å¤","slug":"çƒ­ä¿®å¤","link":"/tags/%E7%83%AD%E4%BF%AE%E5%A4%8D/"},{"name":"hook","slug":"hook","link":"/tags/hook/"},{"name":"åº•å±‚","slug":"åº•å±‚","link":"/tags/%E5%BA%95%E5%B1%82/"},{"name":"å¤šçº¿ç¨‹","slug":"å¤šçº¿ç¨‹","link":"/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"},{"name":"å¹¶å‘","slug":"å¹¶å‘","link":"/tags/%E5%B9%B6%E5%8F%91/"},{"name":"Thread","slug":"Thread","link":"/tags/Thread/"},{"name":"ThreadPool","slug":"ThreadPool","link":"/tags/ThreadPool/"},{"name":"JavaåŸºç¡€çŸ¥è¯†","slug":"JavaåŸºç¡€çŸ¥è¯†","link":"/tags/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"},{"name":"è¿‘ä»£å²","slug":"è¿‘ä»£å²","link":"/tags/%E8%BF%91%E4%BB%A3%E5%8F%B2/"},{"name":"è¿‘ä»£å†å²","slug":"è¿‘ä»£å†å²","link":"/tags/%E8%BF%91%E4%BB%A3%E5%8E%86%E5%8F%B2/"},{"name":"å†å²é¢˜","slug":"å†å²é¢˜","link":"/tags/%E5%8E%86%E5%8F%B2%E9%A2%98/"},{"name":"å‘½ä»¤è¡Œ","slug":"å‘½ä»¤è¡Œ","link":"/tags/%E5%91%BD%E4%BB%A4%E8%A1%8C/"}],"categories":[{"name":"AndroidåŸºç¡€","slug":"AndroidåŸºç¡€","link":"/categories/Android%E5%9F%BA%E7%A1%80/"},{"name":"Macåº”ç”¨","slug":"Macåº”ç”¨","link":"/categories/Mac%E5%BA%94%E7%94%A8/"},{"name":"ç§‘å­¦ä¸Šç½‘","slug":"ç§‘å­¦ä¸Šç½‘","link":"/categories/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/"},{"name":"ç²¾å“ç¾æ–‡","slug":"ç²¾å“ç¾æ–‡","link":"/categories/%E7%B2%BE%E5%93%81%E7%BE%8E%E6%96%87/"},{"name":"IOSåº”ç”¨","slug":"IOSåº”ç”¨","link":"/categories/IOS%E5%BA%94%E7%94%A8/"},{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","link":"/categories/Java%E5%9F%BA%E7%A1%80/"},{"name":"å­¦ä¹ èµ„æ–™","slug":"å­¦ä¹ èµ„æ–™","link":"/categories/%E5%AD%A6%E4%B9%A0%E8%B5%84%E6%96%99/"},{"name":"è‡ªè€ƒ","slug":"è‡ªè€ƒ","link":"/categories/%E8%87%AA%E8%80%83/"}]}